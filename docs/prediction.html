<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>QSS Tidyverse Code</title>
  <meta name="description" content="QSS Tidyverse Code">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="QSS Tidyverse Code" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="jrnold/qss-tidy" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="QSS Tidyverse Code" />
  
  
  

<meta name="author" content="Jeffrey B. Arnold">


<meta name="date" content="2017-12-25">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="measurement.html">
<link rel="next" href="probability.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#colophon"><i class="fa fa-check"></i>Colophon</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#overview-of-the-book"><i class="fa fa-check"></i><b>1.1</b> Overview of the Book</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#how-to-use-the-book"><i class="fa fa-check"></i><b>1.2</b> How to use the Book</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#introduction-to-r"><i class="fa fa-check"></i><b>1.3</b> Introduction to R</a><ul>
<li class="chapter" data-level="1.3.1" data-path="introduction.html"><a href="introduction.html#arithmetic-operations"><i class="fa fa-check"></i><b>1.3.1</b> Arithmetic Operations</a></li>
<li class="chapter" data-level="1.3.2" data-path="introduction.html"><a href="introduction.html#objects"><i class="fa fa-check"></i><b>1.3.2</b> Objects</a></li>
<li class="chapter" data-level="1.3.3" data-path="introduction.html"><a href="introduction.html#vectors"><i class="fa fa-check"></i><b>1.3.3</b> Vectors</a></li>
<li class="chapter" data-level="1.3.4" data-path="introduction.html"><a href="introduction.html#functions"><i class="fa fa-check"></i><b>1.3.4</b> Functions</a></li>
<li class="chapter" data-level="1.3.5" data-path="introduction.html"><a href="introduction.html#data-files"><i class="fa fa-check"></i><b>1.3.5</b> Data Files</a></li>
<li class="chapter" data-level="1.3.6" data-path="introduction.html"><a href="introduction.html#saving-objects"><i class="fa fa-check"></i><b>1.3.6</b> Saving Objects</a></li>
<li class="chapter" data-level="1.3.7" data-path="introduction.html"><a href="introduction.html#programming-and-learning-tips"><i class="fa fa-check"></i><b>1.3.7</b> Programming and Learning Tips</a></li>
<li class="chapter" data-level="1.3.8" data-path="introduction.html"><a href="introduction.html#style-guide"><i class="fa fa-check"></i><b>1.3.8</b> Style Guide</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>2</b> Causality</a><ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.1" data-path="causality.html"><a href="causality.html#racial-discrimination-in-the-labor-market"><i class="fa fa-check"></i><b>2.1</b> Racial Discrimination in the Labor Market</a></li>
<li class="chapter" data-level="2.2" data-path="causality.html"><a href="causality.html#subsetting-data-in-r"><i class="fa fa-check"></i><b>2.2</b> Subsetting Data in R</a><ul>
<li class="chapter" data-level="2.2.1" data-path="causality.html"><a href="causality.html#subsetting"><i class="fa fa-check"></i><b>2.2.1</b> Subsetting</a></li>
<li class="chapter" data-level="2.2.2" data-path="causality.html"><a href="causality.html#simple-conditional-statements"><i class="fa fa-check"></i><b>2.2.2</b> Simple conditional statements</a></li>
<li class="chapter" data-level="2.2.3" data-path="causality.html"><a href="causality.html#factor-variables"><i class="fa fa-check"></i><b>2.2.3</b> Factor Variables</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="causality.html"><a href="causality.html#causal-affects-and-the-counterfactual"><i class="fa fa-check"></i><b>2.3</b> Causal Affects and the Counterfactual</a></li>
<li class="chapter" data-level="2.4" data-path="causality.html"><a href="causality.html#observational-studies"><i class="fa fa-check"></i><b>2.4</b> Observational Studies</a><ul>
<li class="chapter" data-level="2.4.1" data-path="causality.html"><a href="causality.html#confounding-bias"><i class="fa fa-check"></i><b>2.4.1</b> Confounding Bias</a></li>
<li class="chapter" data-level="2.4.2" data-path="causality.html"><a href="causality.html#before-and-after-and-difference-in-difference-designs"><i class="fa fa-check"></i><b>2.4.2</b> Before and After and Difference-in-Difference Designs</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="causality.html"><a href="causality.html#descriptive-statistics-for-a-single-variable"><i class="fa fa-check"></i><b>2.5</b> Descriptive Statistics for a Single Variable</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="measurement.html"><a href="measurement.html"><i class="fa fa-check"></i><b>3</b> Measurement</a><ul>
<li class="chapter" data-level="" data-path="measurement.html"><a href="measurement.html#prerequisites-2"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="3.1" data-path="measurement.html"><a href="measurement.html#measuring-civilian-victimization-during-wartime"><i class="fa fa-check"></i><b>3.1</b> Measuring Civilian Victimization during Wartime</a></li>
<li class="chapter" data-level="3.2" data-path="measurement.html"><a href="measurement.html#handling-missing-data-in-r"><i class="fa fa-check"></i><b>3.2</b> Handling Missing Data in R</a></li>
<li class="chapter" data-level="3.3" data-path="measurement.html"><a href="measurement.html#visualizing-the-univariate-distribution"><i class="fa fa-check"></i><b>3.3</b> Visualizing the Univariate Distribution</a><ul>
<li class="chapter" data-level="3.3.1" data-path="measurement.html"><a href="measurement.html#barplot"><i class="fa fa-check"></i><b>3.3.1</b> Barplot</a></li>
<li class="chapter" data-level="3.3.2" data-path="measurement.html"><a href="measurement.html#histogram"><i class="fa fa-check"></i><b>3.3.2</b> Histogram</a></li>
<li class="chapter" data-level="3.3.3" data-path="measurement.html"><a href="measurement.html#boxplot"><i class="fa fa-check"></i><b>3.3.3</b> Boxplot</a></li>
<li class="chapter" data-level="3.3.4" data-path="measurement.html"><a href="measurement.html#printing-and-saving-graphics"><i class="fa fa-check"></i><b>3.3.4</b> Printing and saving graphics</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="measurement.html"><a href="measurement.html#survey-sampling"><i class="fa fa-check"></i><b>3.4</b> Survey Sampling</a><ul>
<li class="chapter" data-level="3.4.1" data-path="measurement.html"><a href="measurement.html#the-role-of-randomization"><i class="fa fa-check"></i><b>3.4.1</b> The Role of Randomization</a></li>
<li class="chapter" data-level="3.4.2" data-path="measurement.html"><a href="measurement.html#non-response-and-other-sources-of-bias"><i class="fa fa-check"></i><b>3.4.2</b> Non-response and other sources of bias</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="measurement.html"><a href="measurement.html#measuring-political-polarization"><i class="fa fa-check"></i><b>3.5</b> Measuring Political Polarization</a><ul>
<li class="chapter" data-level="3.5.1" data-path="measurement.html"><a href="measurement.html#correlation"><i class="fa fa-check"></i><b>3.5.1</b> Correlation</a></li>
<li class="chapter" data-level="3.5.2" data-path="measurement.html"><a href="measurement.html#quantile-quantile-plot"><i class="fa fa-check"></i><b>3.5.2</b> Quantile-Quantile Plot</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="measurement.html"><a href="measurement.html#clustering"><i class="fa fa-check"></i><b>3.6</b> Clustering</a><ul>
<li class="chapter" data-level="3.6.1" data-path="measurement.html"><a href="measurement.html#matrices"><i class="fa fa-check"></i><b>3.6.1</b> Matrices</a></li>
<li class="chapter" data-level="3.6.2" data-path="measurement.html"><a href="measurement.html#lists"><i class="fa fa-check"></i><b>3.6.2</b> Lists</a></li>
<li class="chapter" data-level="3.6.3" data-path="measurement.html"><a href="measurement.html#k-means-algorithms"><i class="fa fa-check"></i><b>3.6.3</b> k-means algorithms</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="prediction.html"><a href="prediction.html"><i class="fa fa-check"></i><b>4</b> Prediction</a><ul>
<li class="chapter" data-level="" data-path="prediction.html"><a href="prediction.html#prerequisites-3"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="4.1" data-path="prediction.html"><a href="prediction.html#loops-in-r"><i class="fa fa-check"></i><b>4.1</b> Loops in R</a></li>
<li class="chapter" data-level="4.2" data-path="prediction.html"><a href="prediction.html#general-conditional-statements-in-r"><i class="fa fa-check"></i><b>4.2</b> General Conditional Statements in R</a></li>
<li class="chapter" data-level="4.3" data-path="prediction.html"><a href="prediction.html#poll-predictions"><i class="fa fa-check"></i><b>4.3</b> Poll Predictions</a></li>
<li class="chapter" data-level="4.4" data-path="prediction.html"><a href="prediction.html#linear-regression"><i class="fa fa-check"></i><b>4.4</b> Linear Regression</a><ul>
<li class="chapter" data-level="4.4.1" data-path="prediction.html"><a href="prediction.html#facial-appearance-and-election-outcomes"><i class="fa fa-check"></i><b>4.4.1</b> Facial Appearance and Election Outcomes</a></li>
<li class="chapter" data-level="4.4.2" data-path="prediction.html"><a href="prediction.html#correlation-1"><i class="fa fa-check"></i><b>4.4.2</b> Correlation</a></li>
<li class="chapter" data-level="4.4.3" data-path="prediction.html"><a href="prediction.html#least-squares"><i class="fa fa-check"></i><b>4.4.3</b> Least Squares</a></li>
<li class="chapter" data-level="4.4.4" data-path="prediction.html"><a href="prediction.html#regression-towards-the-mean"><i class="fa fa-check"></i><b>4.4.4</b> Regression towards the mean</a></li>
<li class="chapter" data-level="4.4.5" data-path="prediction.html"><a href="prediction.html#merging-data-sets-in-r"><i class="fa fa-check"></i><b>4.4.5</b> Merging Data Sets in R</a></li>
<li class="chapter" data-level="4.4.6" data-path="prediction.html"><a href="prediction.html#model-fit"><i class="fa fa-check"></i><b>4.4.6</b> Model Fit</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="prediction.html"><a href="prediction.html#regression-and-causation"><i class="fa fa-check"></i><b>4.5</b> Regression and Causation</a><ul>
<li class="chapter" data-level="4.5.1" data-path="prediction.html"><a href="prediction.html#regression-with-multiple-predictors"><i class="fa fa-check"></i><b>4.5.1</b> Regression with multiple predictors</a></li>
<li class="chapter" data-level="4.5.2" data-path="prediction.html"><a href="prediction.html#heterogeneous-treatment-effects"><i class="fa fa-check"></i><b>4.5.2</b> Heterogeneous Treatment Effects</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="prediction.html"><a href="prediction.html#regression-discontinuity-design"><i class="fa fa-check"></i><b>4.6</b> Regression Discontinuity Design</a></li>
<li class="chapter" data-level="4.7" data-path="prediction.html"><a href="prediction.html#spatial-data"><i class="fa fa-check"></i><b>4.7</b> Spatial Data</a><ul>
<li class="chapter" data-level="" data-path="prediction.html"><a href="prediction.html#prerequisites-4"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="4.7.1" data-path="prediction.html"><a href="prediction.html#spatial-data-in-r"><i class="fa fa-check"></i><b>4.7.1</b> Spatial Data in R</a></li>
<li class="chapter" data-level="4.7.2" data-path="prediction.html"><a href="prediction.html#colors-in-r"><i class="fa fa-check"></i><b>4.7.2</b> Colors in R</a></li>
<li class="chapter" data-level="4.7.3" data-path="prediction.html"><a href="prediction.html#united-states-presidential-elections"><i class="fa fa-check"></i><b>4.7.3</b> United States Presidential Elections</a></li>
<li class="chapter" data-level="4.7.4" data-path="prediction.html"><a href="prediction.html#expansion-of-walmart"><i class="fa fa-check"></i><b>4.7.4</b> Expansion of Walmart</a></li>
<li class="chapter" data-level="4.7.5" data-path="prediction.html"><a href="prediction.html#animation-in-r"><i class="fa fa-check"></i><b>4.7.5</b> Animation in R</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="prediction.html"><a href="prediction.html#textual-data"><i class="fa fa-check"></i><b>4.8</b> Textual data</a><ul>
<li class="chapter" data-level="" data-path="prediction.html"><a href="prediction.html#prerequisites-5"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="4.8.1" data-path="prediction.html"><a href="prediction.html#document-term-matrix"><i class="fa fa-check"></i><b>4.8.1</b> Document-Term Matrix</a></li>
<li class="chapter" data-level="4.8.2" data-path="prediction.html"><a href="prediction.html#topic-discovery"><i class="fa fa-check"></i><b>4.8.2</b> Topic Discovery</a></li>
<li class="chapter" data-level="4.8.3" data-path="prediction.html"><a href="prediction.html#authorship-prediction"><i class="fa fa-check"></i><b>4.8.3</b> Authorship Prediction</a></li>
<li class="chapter" data-level="4.8.4" data-path="prediction.html"><a href="prediction.html#cross-validation"><i class="fa fa-check"></i><b>4.8.4</b> Cross-Validation</a></li>
</ul></li>
<li class="chapter" data-level="4.9" data-path="prediction.html"><a href="prediction.html#network-data"><i class="fa fa-check"></i><b>4.9</b> Network data</a><ul>
<li class="chapter" data-level="" data-path="prediction.html"><a href="prediction.html#prerequisites-6"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="4.9.1" data-path="prediction.html"><a href="prediction.html#twitter-following-network"><i class="fa fa-check"></i><b>4.9.1</b> Twitter Following Network</a></li>
</ul></li>
<li class="chapter" data-level="4.10" data-path="prediction.html"><a href="prediction.html#spatial-data-1"><i class="fa fa-check"></i><b>4.10</b> Spatial Data</a><ul>
<li class="chapter" data-level="4.10.1" data-path="prediction.html"><a href="prediction.html#prerequisites-7"><i class="fa fa-check"></i><b>4.10.1</b> Prerequisites</a></li>
<li class="chapter" data-level="4.10.2" data-path="prediction.html"><a href="prediction.html#spatial-data-in-r-1"><i class="fa fa-check"></i><b>4.10.2</b> Spatial Data in R</a></li>
<li class="chapter" data-level="4.10.3" data-path="prediction.html"><a href="prediction.html#colors-in-r-1"><i class="fa fa-check"></i><b>4.10.3</b> Colors in R</a></li>
<li class="chapter" data-level="4.10.4" data-path="prediction.html"><a href="prediction.html#united-states-presidential-elections-1"><i class="fa fa-check"></i><b>4.10.4</b> United States Presidential Elections</a></li>
<li class="chapter" data-level="4.10.5" data-path="prediction.html"><a href="prediction.html#expansion-of-walmart-1"><i class="fa fa-check"></i><b>4.10.5</b> Expansion of Walmart</a></li>
<li class="chapter" data-level="4.10.6" data-path="prediction.html"><a href="prediction.html#animation-in-r-1"><i class="fa fa-check"></i><b>4.10.6</b> Animation in R</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="probability.html"><a href="probability.html"><i class="fa fa-check"></i><b>5</b> Probability</a><ul>
<li class="chapter" data-level="" data-path="probability.html"><a href="probability.html#prerequisites-8"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="5.1" data-path="probability.html"><a href="probability.html#probability-1"><i class="fa fa-check"></i><b>5.1</b> Probability</a><ul>
<li class="chapter" data-level="5.1.1" data-path="probability.html"><a href="probability.html#sampling-without-replacement"><i class="fa fa-check"></i><b>5.1.1</b> Sampling without replacement</a></li>
<li class="chapter" data-level="5.1.2" data-path="probability.html"><a href="probability.html#combinations"><i class="fa fa-check"></i><b>5.1.2</b> Combinations</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="probability.html"><a href="probability.html#conditional-probability"><i class="fa fa-check"></i><b>5.2</b> Conditional Probability</a><ul>
<li class="chapter" data-level="5.2.1" data-path="probability.html"><a href="probability.html#conditional-marginal-and-joint-probabilities"><i class="fa fa-check"></i><b>5.2.1</b> Conditional, Marginal, and Joint Probabilities</a></li>
<li class="chapter" data-level="5.2.2" data-path="probability.html"><a href="probability.html#independence"><i class="fa fa-check"></i><b>5.2.2</b> Independence</a></li>
<li class="chapter" data-level="5.2.3" data-path="probability.html"><a href="probability.html#predicting-race-using-surname-and-residence-location"><i class="fa fa-check"></i><b>5.2.3</b> Predicting Race Using Surname and Residence Location</a></li>
<li class="chapter" data-level="5.2.4" data-path="probability.html"><a href="probability.html#predicting-election-outcomes-with-uncertainty"><i class="fa fa-check"></i><b>5.2.4</b> Predicting Election Outcomes with Uncertainty</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="probability.html"><a href="probability.html#large-sample-theorems"><i class="fa fa-check"></i><b>5.3</b> Large Sample Theorems</a><ul>
<li class="chapter" data-level="5.3.1" data-path="probability.html"><a href="probability.html#law-of-large-numbers"><i class="fa fa-check"></i><b>5.3.1</b> Law of Large Numbers</a></li>
<li class="chapter" data-level="5.3.2" data-path="probability.html"><a href="probability.html#central-limit-theorem"><i class="fa fa-check"></i><b>5.3.2</b> Central Limit Theorem</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>6</b> Uncertainty</a><ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#prerequisites-9"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="6.1" data-path="uncertainty.html"><a href="uncertainty.html#estimation"><i class="fa fa-check"></i><b>6.1</b> Estimation</a><ul>
<li class="chapter" data-level="6.1.1" data-path="uncertainty.html"><a href="uncertainty.html#standard-errors"><i class="fa fa-check"></i><b>6.1.1</b> Standard Errors</a></li>
<li class="chapter" data-level="6.1.2" data-path="uncertainty.html"><a href="uncertainty.html#confidence-intervals"><i class="fa fa-check"></i><b>6.1.2</b> Confidence Intervals</a></li>
<li class="chapter" data-level="6.1.3" data-path="uncertainty.html"><a href="uncertainty.html#margin-of-error-and-sample-size-calculation-in-polls"><i class="fa fa-check"></i><b>6.1.3</b> Margin of Error and Sample Size Calculation in Polls</a></li>
<li class="chapter" data-level="6.1.4" data-path="uncertainty.html"><a href="uncertainty.html#analysis-of-randomized-controlled-trials"><i class="fa fa-check"></i><b>6.1.4</b> Analysis of Randomized Controlled Trials</a></li>
<li class="chapter" data-level="6.1.5" data-path="uncertainty.html"><a href="uncertainty.html#analysis-based-on-students-t-distribution"><i class="fa fa-check"></i><b>6.1.5</b> Analysis Based on Student’s t-Distribution</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="uncertainty.html"><a href="uncertainty.html#hypothesis-testing"><i class="fa fa-check"></i><b>6.2</b> Hypothesis Testing</a><ul>
<li class="chapter" data-level="6.2.1" data-path="uncertainty.html"><a href="uncertainty.html#tea-testing-experiment"><i class="fa fa-check"></i><b>6.2.1</b> Tea-Testing Experiment</a></li>
<li class="chapter" data-level="6.2.2" data-path="uncertainty.html"><a href="uncertainty.html#the-general-framework"><i class="fa fa-check"></i><b>6.2.2</b> The General Framework</a></li>
<li class="chapter" data-level="6.2.3" data-path="uncertainty.html"><a href="uncertainty.html#one-sample-tests"><i class="fa fa-check"></i><b>6.2.3</b> One-Sample Tests</a></li>
<li class="chapter" data-level="6.2.4" data-path="uncertainty.html"><a href="uncertainty.html#two-sample-tests"><i class="fa fa-check"></i><b>6.2.4</b> Two-sample tests</a></li>
<li class="chapter" data-level="6.2.5" data-path="uncertainty.html"><a href="uncertainty.html#power-analysis"><i class="fa fa-check"></i><b>6.2.5</b> Power Analysis</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="uncertainty.html"><a href="uncertainty.html#linear-regression-model-with-uncertainty"><i class="fa fa-check"></i><b>6.3</b> Linear Regression Model with Uncertainty</a><ul>
<li class="chapter" data-level="6.3.1" data-path="uncertainty.html"><a href="uncertainty.html#linear-regression-as-a-generative-model"><i class="fa fa-check"></i><b>6.3.1</b> Linear Regression as a Generative Model</a></li>
<li class="chapter" data-level="6.3.2" data-path="uncertainty.html"><a href="uncertainty.html#inference-about-coefficients"><i class="fa fa-check"></i><b>6.3.2</b> Inference about coefficients</a></li>
<li class="chapter" data-level="6.3.3" data-path="uncertainty.html"><a href="uncertainty.html#inference-about-predictions"><i class="fa fa-check"></i><b>6.3.3</b> Inference about predictions</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">QSS Tidyverse Code</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="prediction" class="section level1">
<h1><span class="header-section-number">4</span> Prediction</h1>
<div id="prerequisites-3" class="section level2 unnumbered">
<h2>Prerequisites</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)</code></pre></div>
<p>The packages <a href="https://cran.r-project.org/package=modelr">modelr</a> and <a href="https://cran.r-project.org/package=broom">broom</a> are used to wrangle the results of linear regressions,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;broom&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;modelr&quot;</span>)</code></pre></div>
</div>
<div id="loops-in-r" class="section level2">
<h2><span class="header-section-number">4.1</span> Loops in R</h2>
<p>For more on looping and iteration in R see the <em>R for Data Science</em> chapter <a href="http://r4ds.had.co.nz/data-visualisation.html">Iteration</a>.</p>
<p>RStudio provides many features to help debugging, which will be useful in for loops and function: see <a href="https://support.rstudio.com/hc/en-us/articles/205612627-Debugging-with-RStudio">this</a> article for an example.</p>
</div>
<div id="general-conditional-statements-in-r" class="section level2">
<h2><span class="header-section-number">4.2</span> General Conditional Statements in R</h2>
<p>See the <em>R for Data Science</em> section <a href="http://r4ds.had.co.nz/functions.html#conditional-execution">Conditional Execution</a> for a more complete discussion of conditional execution.</p>
<p>If you are using conditional statements to assign values for data frame, see the <strong>dplyr</strong> functions <a href="https://www.rdocumentation.org/packages/dplyr/topics/if_else">if_else</a>, <a href="https://www.rdocumentation.org/packages/dplyr/topics/recode">recode</a>, and <a href="https://www.rdocumentation.org/packages/dplyr/topics/case_when">case_when</a></p>
</div>
<div id="poll-predictions" class="section level2">
<h2><span class="header-section-number">4.3</span> Poll Predictions</h2>
<p>Load the election polls and election results for 2008,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;polls08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)
<span class="kw">glimpse</span>(polls08)
<span class="co">#&gt; Observations: 1,332</span>
<span class="co">#&gt; Variables: 5</span>
<span class="co">#&gt; $ state    &lt;chr&gt; &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;,...</span>
<span class="co">#&gt; $ Pollster &lt;chr&gt; &quot;SurveyUSA-2&quot;, &quot;Capital Survey-2&quot;, &quot;SurveyUSA-2&quot;, &quot;Ca...</span>
<span class="co">#&gt; $ Obama    &lt;int&gt; 36, 34, 35, 35, 39, 34, 36, 25, 35, 34, 37, 36, 36, 3...</span>
<span class="co">#&gt; $ McCain   &lt;int&gt; 61, 54, 62, 55, 60, 64, 58, 52, 55, 47, 55, 51, 49, 5...</span>
<span class="co">#&gt; $ middate  &lt;date&gt; 2008-10-27, 2008-10-15, 2008-10-08, 2008-10-06, 2008...</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;pres08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)
<span class="kw">glimpse</span>(pres08)
<span class="co">#&gt; Observations: 51</span>
<span class="co">#&gt; Variables: 5</span>
<span class="co">#&gt; $ state.name &lt;chr&gt; &quot;Alabama&quot;, &quot;Alaska&quot;, &quot;Arizona&quot;, &quot;Arkansas&quot;, &quot;Califo...</span>
<span class="co">#&gt; $ state      &lt;chr&gt; &quot;AL&quot;, &quot;AK&quot;, &quot;AZ&quot;, &quot;AR&quot;, &quot;CA&quot;, &quot;CO&quot;, &quot;CT&quot;, &quot;DC&quot;, &quot;DE...</span>
<span class="co">#&gt; $ Obama      &lt;int&gt; 39, 38, 45, 39, 61, 54, 61, 92, 62, 51, 47, 72, 36,...</span>
<span class="co">#&gt; $ McCain     &lt;int&gt; 60, 59, 54, 59, 37, 45, 38, 7, 37, 48, 52, 27, 62, ...</span>
<span class="co">#&gt; $ EV         &lt;int&gt; 9, 3, 10, 6, 55, 9, 7, 3, 3, 27, 15, 4, 4, 21, 11, ...</span></code></pre></div>
<p>Compute Obama’s margin in polls and final election</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polls08 &lt;-
<span class="st">  </span>polls08 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">margin =</span> Obama <span class="op">-</span><span class="st"> </span>McCain)
pres08 &lt;-
<span class="st">  </span>pres08 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">margin =</span> Obama <span class="op">-</span><span class="st"> </span>McCain)</code></pre></div>
<p>To work with dates, the R package <a href="https://cran.r-project.org/package=lubridate">lubridate</a> makes wrangling them much easier. See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/dates-and-times.html">Dates and Times</a>.</p>
<p>The function <a href="https://www.rdocumentation.org/packages/lubridate/topics/ymd">ymd</a> will convert character strings like <code>year-month-day</code> and more into dates, as long as the order is (year, month, day). See <a href="https://www.rdocumentation.org/packages/lubridate/topics/dmy">dmy</a>, <a href="https://www.rdocumentation.org/packages/lubridate/topics/ymd">ymd</a>, and others for other ways to convert strings to dates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="st">&quot;2008-11-04&quot;</span>)
y &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="st">&quot;2008/9/1&quot;</span>)
x <span class="op">-</span><span class="st"> </span>y
<span class="co">#&gt; Time difference of 64 days</span></code></pre></div>
<p>However, note that in <code>polls08</code>, the date <code>middate</code> is <em>already</em> a <code>date</code> object,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(polls08<span class="op">$</span>middate)
<span class="co">#&gt; [1] &quot;Date&quot;</span></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/readr/topics/read_csv">read_csv</a> by default will check character vectors to see if they have patterns that appear to be dates, and if so, will parse those columns as dates.</p>
<p>We’ll create a variable for election day</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ELECTION_DAY &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="st">&quot;2008-11-04&quot;</span>)</code></pre></div>
<p>and add a new column to <code>poll08</code> with the days to the election</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polls08 &lt;-
<span class="st">  </span><span class="kw">mutate</span>(polls08, ELECTION_DAY <span class="op">-</span><span class="st"> </span>middate)</code></pre></div>
<p>Although the code in the chapter uses a <code>for</code> loop, there is no reason to do so. We can accomplish the same task by merging the election results data to the polling data by <code>state</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polls_w_results &lt;-
<span class="st">  </span><span class="kw">left_join</span>(polls08,
            <span class="kw">select</span>(pres08, state, <span class="dt">elec_margin =</span> margin),
            <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">error =</span> elec_margin <span class="op">-</span><span class="st"> </span>margin)
<span class="kw">glimpse</span>(polls_w_results)
<span class="co">#&gt; Observations: 1,332</span>
<span class="co">#&gt; Variables: 9</span>
<span class="co">#&gt; $ state                    &lt;chr&gt; &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;...</span>
<span class="co">#&gt; $ Pollster                 &lt;chr&gt; &quot;SurveyUSA-2&quot;, &quot;Capital Survey-2&quot;, &quot;S...</span>
<span class="co">#&gt; $ Obama                    &lt;int&gt; 36, 34, 35, 35, 39, 34, 36, 25, 35, 3...</span>
<span class="co">#&gt; $ McCain                   &lt;int&gt; 61, 54, 62, 55, 60, 64, 58, 52, 55, 4...</span>
<span class="co">#&gt; $ middate                  &lt;date&gt; 2008-10-27, 2008-10-15, 2008-10-08, ...</span>
<span class="co">#&gt; $ margin                   &lt;int&gt; -25, -20, -27, -20, -21, -30, -22, -2...</span>
<span class="co">#&gt; $ `ELECTION_DAY - middate` &lt;time&gt; 8 days, 20 days, 27 days, 29 days, 4...</span>
<span class="co">#&gt; $ elec_margin              &lt;int&gt; -21, -21, -21, -21, -21, -21, -21, -2...</span>
<span class="co">#&gt; $ error                    &lt;int&gt; 4, -1, 6, -1, 0, 9, 1, 6, -1, -8, -3,...</span></code></pre></div>
<p>To get the last poll in each state, arrange and filter on <code>middate</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls &lt;-
<span class="st">  </span>polls_w_results <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(state, <span class="kw">desc</span>(middate)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span>)
last_polls
<span class="co">#&gt; # A tibble: 51 x 9</span>
<span class="co">#&gt; # Groups:   state [51]</span>
<span class="co">#&gt;   state        Pollster Obama McCain    middate margin</span>
<span class="co">#&gt;   &lt;chr&gt;           &lt;chr&gt; &lt;int&gt;  &lt;int&gt;     &lt;date&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1    AK Research 2000-3    39     58 2008-10-29    -19</span>
<span class="co">#&gt; 2    AL     SurveyUSA-2    36     61 2008-10-27    -25</span>
<span class="co">#&gt; 3    AR           ARG-4    44     51 2008-10-29     -7</span>
<span class="co">#&gt; 4    AZ           ARG-3    46     50 2008-10-29     -4</span>
<span class="co">#&gt; 5    CA     SurveyUSA-3    60     36 2008-10-30     24</span>
<span class="co">#&gt; 6    CO           ARG-3    52     45 2008-10-29      7</span>
<span class="co">#&gt; # ... with 45 more rows, and 3 more variables: `ELECTION_DAY -</span>
<span class="co">#&gt; #   middate` &lt;time&gt;, elec_margin &lt;int&gt;, error &lt;int&gt;</span></code></pre></div>
<p><strong>Challenge:</strong> Instead of using the last poll, use the average of polls in the last week? Last month? How do the margins on the polls change over the election period?</p>
<p>To simplify things for later, let’s define a function <code>rmse</code> which calculates the root mean squared error, as defined in the book. See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/functions.html">Functions</a> for more on writing functions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rmse &lt;-<span class="st"> </span><span class="cf">function</span>(actual, pred) {
  <span class="kw">sqrt</span>(<span class="kw">mean</span>( (actual <span class="op">-</span><span class="st"> </span>pred) <span class="op">^</span><span class="st"> </span><span class="dv">2</span>))
}</code></pre></div>
<p>Now we can use <code>rmse()</code> to calculate the RMSE for all the final polls:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rmse</span>(last_polls<span class="op">$</span>margin, last_polls<span class="op">$</span>elec_margin)
<span class="co">#&gt; [1] 5.88</span></code></pre></div>
<p>Or since we already have a variable <code>error</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sqrt</span>(<span class="kw">mean</span>(last_polls<span class="op">$</span>error <span class="op">^</span><span class="st"> </span><span class="dv">2</span>))
<span class="co">#&gt; [1] 5.88</span></code></pre></div>
<p>The mean prediction error is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(last_polls<span class="op">$</span>error)
<span class="co">#&gt; [1] 1.08</span></code></pre></div>
<p>This is slightly different than what is in the book due to the difference in the poll used as the final poll; many states have many polls on the last day.</p>
<p>I’ll choose bin widths of 1%, since that is fairly interpretable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(last_polls, <span class="kw">aes</span>(<span class="dt">x =</span> error)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">boundary =</span> <span class="dv">0</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-14-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The text uses bin widths of 5%:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(last_polls, <span class="kw">aes</span>(<span class="dt">x =</span> error)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">5</span>, <span class="dt">boundary =</span> <span class="dv">0</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-15-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><strong>Challenge:</strong> What other ways could you visualize the results? How would you show all states? What about plotting the absolute or squared errors instead of the errors?</p>
<p><strong>Challenge:</strong> What happens to prediction error if you average polls? Consider averaging back over time? What happens if you take the averages of the state poll average and average of <strong>all</strong> polls - does that improve prediction?</p>
<p>To create a scatter plots using the state abbreviations instead of points use <a href="http://docs.ggplot2.org/current/geom_text.html">geom_text</a> instead of <a href="http://docs.ggplot2.org/current/geom_point.html">geom_point</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(last_polls, <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> elec_margin, <span class="dt">label =</span> state)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;gray&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;gray&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Poll Results&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Actual Election Results&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-16-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We can create a confusion matrix as follows. Create a new column <code>classification</code> which shows whether how the poll’s classification was related to the actual election outcome (“true positive”, “false positive”, “false negative”, “false positive”). If there were two outcomes, then we would use the function. But with more than two outcomes, it is easier to use the <a href="https://cran.r-project.org/package=dplyr">dplyr</a> function .</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls &lt;-
<span class="st">  </span>last_polls <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">classification =</span>
           <span class="kw">case_when</span>(
             (.<span class="op">$</span>margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>elec_margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">~</span><span class="st"> &quot;true positive&quot;</span>,
             (.<span class="op">$</span>margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>elec_margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">~</span><span class="st"> &quot;false positive&quot;</span>,
             (.<span class="op">$</span>margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>elec_margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">~</span><span class="st"> &quot;true negative&quot;</span>,
             (.<span class="op">$</span>margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>elec_margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">~</span><span class="st"> &quot;false negative&quot;</span>
           ))</code></pre></div>
<p>You need to use <code>.</code> to refer to the data frame when using <code>case_when</code> within <code>mutate()</code>. Also, we needed to first use in order to remove the grouping variable so <code>mutate</code> will work.</p>
<p>Now simply count the number of polls in each category of <code>classification</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(classification) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">count</span>()
<span class="co">#&gt; # A tibble: 4 x 2</span>
<span class="co">#&gt; # Groups:   classification [4]</span>
<span class="co">#&gt;   classification     n</span>
<span class="co">#&gt;            &lt;chr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 false negative     2</span>
<span class="co">#&gt; 2 false positive     1</span>
<span class="co">#&gt; 3  true negative    21</span>
<span class="co">#&gt; 4  true positive    27</span></code></pre></div>
<p>Which states were incorrectly predicted by the polls?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(classification <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;false positive&quot;</span>, <span class="st">&quot;false negative&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(state, margin, elec_margin, classification) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(elec_margin))
<span class="co">#&gt; # A tibble: 3 x 4</span>
<span class="co">#&gt;   state margin elec_margin classification</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt;       &lt;int&gt;          &lt;chr&gt;</span>
<span class="co">#&gt; 1    IN     -5           1 false negative</span>
<span class="co">#&gt; 2    NC     -1           1 false negative</span>
<span class="co">#&gt; 3    MO      1          -1 false positive</span></code></pre></div>
<p>What was the difference in the poll prediction of electoral votes and actual electoral votes. We hadn’t included the variable <code>EV</code> when we first merged, but that’s no problem, we’ll just merge again in order to grab that variable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw">select</span>(pres08, state, EV), <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">EV_pred =</span> <span class="kw">sum</span>( (margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>EV),
            <span class="dt">EV_actual =</span> <span class="kw">sum</span>( (elec_margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>EV))
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   EV_pred EV_actual</span>
<span class="co">#&gt;     &lt;int&gt;     &lt;int&gt;</span>
<span class="co">#&gt; 1     349       364</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;pollsUS08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pollsUS08 &lt;-<span class="st"> </span><span class="kw">mutate</span>(pollsUS08, <span class="dt">DaysToElection =</span> ELECTION_DAY <span class="op">-</span><span class="st"> </span>middate)</code></pre></div>
<p>We’ll produce the seven-day averages slightly differently than the method used in the text. For all dates in the data, we’ll calculate the moving average.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">all_dates &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(polls08<span class="op">$</span>middate), ELECTION_DAY,
                 <span class="dt">by =</span> <span class="st">&quot;days&quot;</span>)

<span class="co"># Number of poll days to use</span>
POLL_DAYS &lt;-<span class="st"> </span><span class="dv">7</span>

pop_vote_avg &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="kw">length</span>(all_dates), <span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>)
<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(all_dates)) {
  date &lt;-<span class="st"> </span>all_dates[i]
  <span class="co"># summarise the seven day</span>
  week_data &lt;-
<span class="st">     </span>pollsUS08 <span class="op">%&gt;%</span>
<span class="st">     </span><span class="kw">filter</span>(<span class="kw">as.integer</span>(middate <span class="op">-</span><span class="st"> </span>date) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>,
            <span class="kw">as.integer</span>(middate <span class="op">-</span><span class="st"> </span>date) <span class="op">&gt;</span><span class="st"> </span><span class="op">-</span>POLL_DAYS) <span class="op">%&gt;%</span>
<span class="st">     </span><span class="kw">summarise</span>(<span class="dt">Obama =</span> <span class="kw">mean</span>(Obama, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
               <span class="dt">McCain =</span> <span class="kw">mean</span>(McCain, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  <span class="co"># add date for the observation</span>
  week_data<span class="op">$</span>date &lt;-<span class="st"> </span>date
  pop_vote_avg[[i]] &lt;-<span class="st"> </span>week_data
}

pop_vote_avg &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(pop_vote_avg)</code></pre></div>
<p>It is easier to plot this if the data are tidy, with <code>Obama</code> and <code>McCain</code> as categories of a column <code>candidate</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pop_vote_avg_tidy &lt;-
<span class="st">  </span>pop_vote_avg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(candidate, share, <span class="op">-</span>date, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
pop_vote_avg_tidy
<span class="co">#&gt;           date candidate share</span>
<span class="co">#&gt; 9   2008-01-09     Obama  49.0</span>
<span class="co">#&gt; 10  2008-01-10     Obama  46.0</span>
<span class="co">#&gt; 11  2008-01-11     Obama  45.0</span>
<span class="co">#&gt; 12  2008-01-12     Obama  45.0</span>
<span class="co">#&gt; 13  2008-01-13     Obama  45.0</span>
<span class="co">#&gt; 14  2008-01-14     Obama  45.0</span>
<span class="co">#&gt; 15  2008-01-15     Obama  45.0</span>
<span class="co">#&gt; 16  2008-01-16     Obama  44.6</span>
<span class="co">#&gt; 17  2008-01-17     Obama  45.4</span>
<span class="co">#&gt; 18  2008-01-18     Obama  46.0</span>
<span class="co">#&gt; 19  2008-01-19     Obama  47.0</span>
<span class="co">#&gt; 20  2008-01-20     Obama  45.0</span>
<span class="co">#&gt; 21  2008-01-21     Obama  44.2</span>
<span class="co">#&gt; 22  2008-01-22     Obama  44.2</span>
<span class="co">#&gt; 23  2008-01-23     Obama  43.3</span>
<span class="co">#&gt; 24  2008-01-24     Obama  41.5</span>
<span class="co">#&gt; 25  2008-01-25     Obama  41.5</span>
<span class="co">#&gt; 26  2008-01-26     Obama  41.5</span>
<span class="co">#&gt; 27  2008-01-27     Obama  42.0</span>
<span class="co">#&gt; 30  2008-01-30     Obama  46.0</span>
<span class="co">#&gt; 31  2008-01-31     Obama  46.0</span>
<span class="co">#&gt; 32  2008-02-01     Obama  45.8</span>
<span class="co">#&gt; 33  2008-02-02     Obama  47.0</span>
<span class="co">#&gt; 34  2008-02-03     Obama  47.2</span>
<span class="co">#&gt; 35  2008-02-04     Obama  46.7</span>
<span class="co">#&gt; 36  2008-02-05     Obama  46.6</span>
<span class="co">#&gt; 37  2008-02-06     Obama  47.0</span>
<span class="co">#&gt; 38  2008-02-07     Obama  47.0</span>
<span class="co">#&gt; 39  2008-02-08     Obama  47.5</span>
<span class="co">#&gt; 40  2008-02-09     Obama  46.1</span>
<span class="co">#&gt; 41  2008-02-10     Obama  45.8</span>
<span class="co">#&gt; 42  2008-02-11     Obama  46.7</span>
<span class="co">#&gt; 43  2008-02-12     Obama  46.8</span>
<span class="co">#&gt; 44  2008-02-13     Obama  46.7</span>
<span class="co">#&gt; 45  2008-02-14     Obama  46.7</span>
<span class="co">#&gt; 46  2008-02-15     Obama  46.6</span>
<span class="co">#&gt; 47  2008-02-16     Obama  47.2</span>
<span class="co">#&gt; 48  2008-02-17     Obama  47.0</span>
<span class="co">#&gt; 49  2008-02-18     Obama  46.6</span>
<span class="co">#&gt; 50  2008-02-19     Obama  46.4</span>
<span class="co">#&gt; 51  2008-02-20     Obama  47.0</span>
<span class="co">#&gt; 52  2008-02-21     Obama  46.5</span>
<span class="co">#&gt; 53  2008-02-22     Obama  47.4</span>
<span class="co">#&gt; 54  2008-02-23     Obama  47.1</span>
<span class="co">#&gt; 55  2008-02-24     Obama  47.2</span>
<span class="co">#&gt; 56  2008-02-25     Obama  46.6</span>
<span class="co">#&gt; 57  2008-02-26     Obama  46.7</span>
<span class="co">#&gt; 58  2008-02-27     Obama  46.3</span>
<span class="co">#&gt; 59  2008-02-28     Obama  46.8</span>
<span class="co">#&gt; 60  2008-02-29     Obama  45.3</span>
<span class="co">#&gt; 61  2008-03-01     Obama  44.8</span>
<span class="co">#&gt; 62  2008-03-02     Obama  44.8</span>
<span class="co">#&gt; 63  2008-03-03     Obama  45.0</span>
<span class="co">#&gt; 64  2008-03-04     Obama  45.0</span>
<span class="co">#&gt; 65  2008-03-05     Obama  45.2</span>
<span class="co">#&gt; 66  2008-03-06     Obama  45.2</span>
<span class="co">#&gt; 67  2008-03-07     Obama  45.8</span>
<span class="co">#&gt; 68  2008-03-08     Obama  44.6</span>
<span class="co">#&gt; 69  2008-03-09     Obama  45.1</span>
<span class="co">#&gt; 70  2008-03-10     Obama  45.1</span>
<span class="co">#&gt; 71  2008-03-11     Obama  45.2</span>
<span class="co">#&gt; 72  2008-03-12     Obama  44.8</span>
<span class="co">#&gt; 73  2008-03-13     Obama  44.0</span>
<span class="co">#&gt; 74  2008-03-14     Obama  44.0</span>
<span class="co">#&gt; 75  2008-03-15     Obama  45.3</span>
<span class="co">#&gt; 76  2008-03-16     Obama  44.3</span>
<span class="co">#&gt; 77  2008-03-17     Obama  44.9</span>
<span class="co">#&gt; 78  2008-03-18     Obama  44.6</span>
<span class="co">#&gt; 79  2008-03-19     Obama  44.0</span>
<span class="co">#&gt; 80  2008-03-20     Obama  44.1</span>
<span class="co">#&gt; 81  2008-03-21     Obama  44.8</span>
<span class="co">#&gt; 82  2008-03-22     Obama  44.0</span>
<span class="co">#&gt; 83  2008-03-23     Obama  43.9</span>
<span class="co">#&gt; 84  2008-03-24     Obama  43.2</span>
<span class="co">#&gt; 85  2008-03-25     Obama  43.1</span>
<span class="co">#&gt; 86  2008-03-26     Obama  43.6</span>
<span class="co">#&gt; 87  2008-03-27     Obama  43.5</span>
<span class="co">#&gt; 88  2008-03-28     Obama  42.7</span>
<span class="co">#&gt; 89  2008-03-29     Obama  42.7</span>
<span class="co">#&gt; 90  2008-03-30     Obama  43.5</span>
<span class="co">#&gt; 91  2008-03-31     Obama  43.6</span>
<span class="co">#&gt; 92  2008-04-01     Obama  43.5</span>
<span class="co">#&gt; 93  2008-04-02     Obama  43.3</span>
<span class="co">#&gt; 94  2008-04-03     Obama  44.0</span>
<span class="co">#&gt; 95  2008-04-04     Obama  44.2</span>
<span class="co">#&gt; 96  2008-04-05     Obama  44.3</span>
<span class="co">#&gt; 97  2008-04-06     Obama  43.5</span>
<span class="co">#&gt; 98  2008-04-07     Obama  43.6</span>
<span class="co">#&gt; 99  2008-04-08     Obama  42.7</span>
<span class="co">#&gt; 100 2008-04-09     Obama  43.2</span>
<span class="co">#&gt; 101 2008-04-10     Obama  43.2</span>
<span class="co">#&gt; 102 2008-04-11     Obama  43.0</span>
<span class="co">#&gt; 103 2008-04-12     Obama  42.8</span>
<span class="co">#&gt; 104 2008-04-13     Obama  42.8</span>
<span class="co">#&gt; 105 2008-04-14     Obama  43.0</span>
<span class="co">#&gt; 106 2008-04-15     Obama  43.9</span>
<span class="co">#&gt; 107 2008-04-16     Obama  44.7</span>
<span class="co">#&gt; 108 2008-04-17     Obama  44.2</span>
<span class="co">#&gt; 109 2008-04-18     Obama  44.6</span>
<span class="co">#&gt; 110 2008-04-19     Obama  45.1</span>
<span class="co">#&gt; 111 2008-04-20     Obama  45.2</span>
<span class="co">#&gt; 112 2008-04-21     Obama  44.7</span>
<span class="co">#&gt; 113 2008-04-22     Obama  45.0</span>
<span class="co">#&gt; 114 2008-04-23     Obama  44.2</span>
<span class="co">#&gt; 115 2008-04-24     Obama  45.0</span>
<span class="co">#&gt; 116 2008-04-25     Obama  45.7</span>
<span class="co">#&gt; 117 2008-04-26     Obama  45.2</span>
<span class="co">#&gt; 118 2008-04-27     Obama  45.4</span>
<span class="co">#&gt; 119 2008-04-28     Obama  45.7</span>
<span class="co">#&gt; 120 2008-04-29     Obama  45.4</span>
<span class="co">#&gt; 121 2008-04-30     Obama  45.4</span>
<span class="co">#&gt; 122 2008-05-01     Obama  45.1</span>
<span class="co">#&gt; 123 2008-05-02     Obama  45.3</span>
<span class="co">#&gt; 124 2008-05-03     Obama  45.3</span>
<span class="co">#&gt; 125 2008-05-04     Obama  45.4</span>
<span class="co">#&gt; 126 2008-05-05     Obama  45.1</span>
<span class="co">#&gt; 127 2008-05-06     Obama  45.2</span>
<span class="co">#&gt; 128 2008-05-07     Obama  45.4</span>
<span class="co">#&gt; 129 2008-05-08     Obama  45.7</span>
<span class="co">#&gt; 130 2008-05-09     Obama  45.1</span>
<span class="co">#&gt; 131 2008-05-10     Obama  46.4</span>
<span class="co">#&gt; 132 2008-05-11     Obama  46.5</span>
<span class="co">#&gt; 133 2008-05-12     Obama  47.8</span>
<span class="co">#&gt; 134 2008-05-13     Obama  47.9</span>
<span class="co">#&gt; 135 2008-05-14     Obama  46.0</span>
<span class="co">#&gt; 136 2008-05-15     Obama  46.0</span>
<span class="co">#&gt; 137 2008-05-16     Obama  45.7</span>
<span class="co">#&gt; 138 2008-05-17     Obama  45.3</span>
<span class="co">#&gt; 139 2008-05-18     Obama  45.1</span>
<span class="co">#&gt; 140 2008-05-19     Obama  45.2</span>
<span class="co">#&gt; 141 2008-05-20     Obama  44.0</span>
<span class="co">#&gt; 142 2008-05-21     Obama  45.7</span>
<span class="co">#&gt; 143 2008-05-22     Obama  45.6</span>
<span class="co">#&gt; 144 2008-05-23     Obama  45.8</span>
<span class="co">#&gt; 145 2008-05-24     Obama  45.4</span>
<span class="co">#&gt; 146 2008-05-25     Obama  45.4</span>
<span class="co">#&gt; 147 2008-05-26     Obama  45.3</span>
<span class="co">#&gt; 148 2008-05-27     Obama  44.1</span>
<span class="co">#&gt; 149 2008-05-28     Obama  43.9</span>
<span class="co">#&gt; 150 2008-05-29     Obama  43.9</span>
<span class="co">#&gt; 151 2008-05-30     Obama  43.2</span>
<span class="co">#&gt; 152 2008-05-31     Obama  44.0</span>
<span class="co">#&gt; 153 2008-06-01     Obama  44.5</span>
<span class="co">#&gt; 154 2008-06-02     Obama  44.5</span>
<span class="co">#&gt; 155 2008-06-03     Obama  46.5</span>
<span class="co">#&gt; 156 2008-06-04     Obama  46.8</span>
<span class="co">#&gt; 157 2008-06-05     Obama  46.3</span>
<span class="co">#&gt; 158 2008-06-06     Obama  47.1</span>
<span class="co">#&gt; 159 2008-06-07     Obama  46.9</span>
<span class="co">#&gt; 160 2008-06-08     Obama  47.2</span>
<span class="co">#&gt; 161 2008-06-09     Obama  46.9</span>
<span class="co">#&gt; 162 2008-06-10     Obama  46.1</span>
<span class="co">#&gt; 163 2008-06-11     Obama  45.8</span>
<span class="co">#&gt; 164 2008-06-12     Obama  46.4</span>
<span class="co">#&gt; 165 2008-06-13     Obama  46.2</span>
<span class="co">#&gt; 166 2008-06-14     Obama  46.0</span>
<span class="co">#&gt; 167 2008-06-15     Obama  45.3</span>
<span class="co">#&gt; 168 2008-06-16     Obama  44.4</span>
<span class="co">#&gt; 169 2008-06-17     Obama  45.4</span>
<span class="co">#&gt; 170 2008-06-18     Obama  45.4</span>
<span class="co">#&gt; 171 2008-06-19     Obama  44.5</span>
<span class="co">#&gt; 172 2008-06-20     Obama  44.2</span>
<span class="co">#&gt; 173 2008-06-21     Obama  44.9</span>
<span class="co">#&gt; 174 2008-06-22     Obama  44.9</span>
<span class="co">#&gt; 175 2008-06-23     Obama  45.6</span>
<span class="co">#&gt; 176 2008-06-24     Obama  45.4</span>
<span class="co">#&gt; 177 2008-06-25     Obama  45.4</span>
<span class="co">#&gt; 178 2008-06-26     Obama  46.3</span>
<span class="co">#&gt; 179 2008-06-27     Obama  46.6</span>
<span class="co">#&gt; 180 2008-06-28     Obama  46.5</span>
<span class="co">#&gt; 181 2008-06-29     Obama  46.4</span>
<span class="co">#&gt; 182 2008-06-30     Obama  46.7</span>
<span class="co">#&gt; 183 2008-07-01     Obama  46.4</span>
<span class="co">#&gt; 184 2008-07-02     Obama  46.4</span>
<span class="co">#&gt; 185 2008-07-03     Obama  46.4</span>
<span class="co">#&gt; 186 2008-07-04     Obama  46.4</span>
<span class="co">#&gt; 187 2008-07-05     Obama  45.8</span>
<span class="co">#&gt; 188 2008-07-06     Obama  45.8</span>
<span class="co">#&gt; 189 2008-07-07     Obama  45.0</span>
<span class="co">#&gt; 190 2008-07-08     Obama  45.2</span>
<span class="co">#&gt; 191 2008-07-09     Obama  44.6</span>
<span class="co">#&gt; 192 2008-07-10     Obama  45.2</span>
<span class="co">#&gt; 193 2008-07-11     Obama  45.1</span>
<span class="co">#&gt; 194 2008-07-12     Obama  45.1</span>
<span class="co">#&gt; 195 2008-07-13     Obama  45.1</span>
<span class="co">#&gt; 196 2008-07-14     Obama  45.3</span>
<span class="co">#&gt; 197 2008-07-15     Obama  45.9</span>
<span class="co">#&gt; 198 2008-07-16     Obama  46.1</span>
<span class="co">#&gt; 199 2008-07-17     Obama  45.5</span>
<span class="co">#&gt; 200 2008-07-18     Obama  45.5</span>
<span class="co">#&gt; 201 2008-07-19     Obama  45.2</span>
<span class="co">#&gt; 202 2008-07-20     Obama  45.4</span>
<span class="co">#&gt; 203 2008-07-21     Obama  45.4</span>
<span class="co">#&gt; 204 2008-07-22     Obama  44.6</span>
<span class="co">#&gt; 205 2008-07-23     Obama  45.3</span>
<span class="co">#&gt; 206 2008-07-24     Obama  45.8</span>
<span class="co">#&gt; 207 2008-07-25     Obama  45.8</span>
<span class="co">#&gt; 208 2008-07-26     Obama  46.3</span>
<span class="co">#&gt; 209 2008-07-27     Obama  46.5</span>
<span class="co">#&gt; 210 2008-07-28     Obama  46.6</span>
<span class="co">#&gt; 211 2008-07-29     Obama  47.0</span>
<span class="co">#&gt; 212 2008-07-30     Obama  47.4</span>
<span class="co">#&gt; 213 2008-07-31     Obama  46.6</span>
<span class="co">#&gt; 214 2008-08-01     Obama  46.4</span>
<span class="co">#&gt; 215 2008-08-02     Obama  45.2</span>
<span class="co">#&gt; 216 2008-08-03     Obama  45.0</span>
<span class="co">#&gt; 217 2008-08-04     Obama  44.8</span>
<span class="co">#&gt; 218 2008-08-05     Obama  44.8</span>
<span class="co">#&gt; 219 2008-08-06     Obama  44.5</span>
<span class="co">#&gt; 220 2008-08-07     Obama  45.0</span>
<span class="co">#&gt; 221 2008-08-08     Obama  45.2</span>
<span class="co">#&gt; 222 2008-08-09     Obama  45.8</span>
<span class="co">#&gt; 223 2008-08-10     Obama  45.9</span>
<span class="co">#&gt; 224 2008-08-11     Obama  46.0</span>
<span class="co">#&gt; 225 2008-08-12     Obama  45.7</span>
<span class="co">#&gt; 226 2008-08-13     Obama  45.6</span>
<span class="co">#&gt; 227 2008-08-14     Obama  45.7</span>
<span class="co">#&gt; 228 2008-08-15     Obama  44.9</span>
<span class="co">#&gt; 229 2008-08-16     Obama  45.0</span>
<span class="co">#&gt; 230 2008-08-17     Obama  45.0</span>
<span class="co">#&gt; 231 2008-08-18     Obama  44.8</span>
<span class="co">#&gt; 232 2008-08-19     Obama  44.3</span>
<span class="co">#&gt; 233 2008-08-20     Obama  44.6</span>
<span class="co">#&gt; 234 2008-08-21     Obama  44.2</span>
<span class="co">#&gt; 235 2008-08-22     Obama  44.5</span>
<span class="co">#&gt; 236 2008-08-23     Obama  45.0</span>
<span class="co">#&gt; 237 2008-08-24     Obama  44.8</span>
<span class="co">#&gt; 238 2008-08-25     Obama  44.5</span>
<span class="co">#&gt; 239 2008-08-26     Obama  45.6</span>
<span class="co">#&gt; 240 2008-08-27     Obama  45.4</span>
<span class="co">#&gt; 241 2008-08-28     Obama  46.0</span>
<span class="co">#&gt; 242 2008-08-29     Obama  46.3</span>
<span class="co">#&gt; 243 2008-08-30     Obama  46.8</span>
<span class="co">#&gt; 244 2008-08-31     Obama  46.8</span>
<span class="co">#&gt; 245 2008-09-01     Obama  47.5</span>
<span class="co">#&gt; 246 2008-09-02     Obama  46.9</span>
<span class="co">#&gt; 247 2008-09-03     Obama  46.9</span>
<span class="co">#&gt; 248 2008-09-04     Obama  46.7</span>
<span class="co">#&gt; 249 2008-09-05     Obama  46.5</span>
<span class="co">#&gt; 250 2008-09-06     Obama  46.1</span>
<span class="co">#&gt; 251 2008-09-07     Obama  45.7</span>
<span class="co">#&gt; 252 2008-09-08     Obama  45.2</span>
<span class="co">#&gt; 253 2008-09-09     Obama  45.4</span>
<span class="co">#&gt; 254 2008-09-10     Obama  45.0</span>
<span class="co">#&gt; 255 2008-09-11     Obama  45.0</span>
<span class="co">#&gt; 256 2008-09-12     Obama  45.2</span>
<span class="co">#&gt; 257 2008-09-13     Obama  45.3</span>
<span class="co">#&gt; 258 2008-09-14     Obama  45.5</span>
<span class="co">#&gt; 259 2008-09-15     Obama  46.0</span>
<span class="co">#&gt; 260 2008-09-16     Obama  45.9</span>
<span class="co">#&gt; 261 2008-09-17     Obama  46.4</span>
<span class="co">#&gt; 262 2008-09-18     Obama  46.8</span>
<span class="co">#&gt; 263 2008-09-19     Obama  46.8</span>
<span class="co">#&gt; 264 2008-09-20     Obama  46.9</span>
<span class="co">#&gt; 265 2008-09-21     Obama  47.5</span>
<span class="co">#&gt; 266 2008-09-22     Obama  47.6</span>
<span class="co">#&gt; 267 2008-09-23     Obama  47.5</span>
<span class="co">#&gt; 268 2008-09-24     Obama  47.5</span>
<span class="co">#&gt; 269 2008-09-25     Obama  47.5</span>
<span class="co">#&gt; 270 2008-09-26     Obama  47.6</span>
<span class="co">#&gt; 271 2008-09-27     Obama  47.9</span>
<span class="co">#&gt; 272 2008-09-28     Obama  47.8</span>
<span class="co">#&gt; 273 2008-09-29     Obama  48.0</span>
<span class="co">#&gt; 274 2008-09-30     Obama  48.6</span>
<span class="co">#&gt; 275 2008-10-01     Obama  48.8</span>
<span class="co">#&gt; 276 2008-10-02     Obama  48.8</span>
<span class="co">#&gt; 277 2008-10-03     Obama  49.1</span>
<span class="co">#&gt; 278 2008-10-04     Obama  49.1</span>
<span class="co">#&gt; 279 2008-10-05     Obama  49.0</span>
<span class="co">#&gt; 280 2008-10-06     Obama  49.4</span>
<span class="co">#&gt; 281 2008-10-07     Obama  49.2</span>
<span class="co">#&gt; 282 2008-10-08     Obama  48.9</span>
<span class="co">#&gt; 283 2008-10-09     Obama  49.2</span>
<span class="co">#&gt; 284 2008-10-10     Obama  49.3</span>
<span class="co">#&gt; 285 2008-10-11     Obama  49.3</span>
<span class="co">#&gt; 286 2008-10-12     Obama  49.9</span>
<span class="co">#&gt; 287 2008-10-13     Obama  49.8</span>
<span class="co">#&gt; 288 2008-10-14     Obama  49.7</span>
<span class="co">#&gt; 289 2008-10-15     Obama  50.3</span>
<span class="co">#&gt; 290 2008-10-16     Obama  49.9</span>
<span class="co">#&gt; 291 2008-10-17     Obama  49.7</span>
<span class="co">#&gt; 292 2008-10-18     Obama  49.8</span>
<span class="co">#&gt; 293 2008-10-19     Obama  49.4</span>
<span class="co">#&gt; 294 2008-10-20     Obama  49.6</span>
<span class="co">#&gt; 295 2008-10-21     Obama  50.0</span>
<span class="co">#&gt; 296 2008-10-22     Obama  49.9</span>
<span class="co">#&gt; 297 2008-10-23     Obama  50.0</span>
<span class="co">#&gt; 298 2008-10-24     Obama  50.2</span>
<span class="co">#&gt; 299 2008-10-25     Obama  50.3</span>
<span class="co">#&gt; 300 2008-10-26     Obama  50.4</span>
<span class="co">#&gt; 301 2008-10-27     Obama  50.4</span>
<span class="co">#&gt; 302 2008-10-28     Obama  50.2</span>
<span class="co">#&gt; 303 2008-10-29     Obama  50.1</span>
<span class="co">#&gt; 304 2008-10-30     Obama  50.1</span>
<span class="co">#&gt; 305 2008-10-31     Obama  50.4</span>
<span class="co">#&gt; 306 2008-11-01     Obama  50.6</span>
<span class="co">#&gt; 307 2008-11-02     Obama  51.0</span>
<span class="co">#&gt; 308 2008-11-03     Obama  51.1</span>
<span class="co">#&gt; 309 2008-11-04     Obama  51.3</span>
<span class="co">#&gt; 318 2008-01-09    McCain  48.0</span>
<span class="co">#&gt; 319 2008-01-10    McCain  46.5</span>
<span class="co">#&gt; 320 2008-01-11    McCain  45.0</span>
<span class="co">#&gt; 321 2008-01-12    McCain  45.4</span>
<span class="co">#&gt; 322 2008-01-13    McCain  45.4</span>
<span class="co">#&gt; 323 2008-01-14    McCain  45.4</span>
<span class="co">#&gt; 324 2008-01-15    McCain  45.4</span>
<span class="co">#&gt; 325 2008-01-16    McCain  43.4</span>
<span class="co">#&gt; 326 2008-01-17    McCain  41.8</span>
<span class="co">#&gt; 327 2008-01-18    McCain  41.8</span>
<span class="co">#&gt; 328 2008-01-19    McCain  37.5</span>
<span class="co">#&gt; 329 2008-01-20    McCain  39.0</span>
<span class="co">#&gt; 330 2008-01-21    McCain  39.8</span>
<span class="co">#&gt; 331 2008-01-22    McCain  39.8</span>
<span class="co">#&gt; 332 2008-01-23    McCain  40.3</span>
<span class="co">#&gt; 333 2008-01-24    McCain  42.0</span>
<span class="co">#&gt; 334 2008-01-25    McCain  42.0</span>
<span class="co">#&gt; 335 2008-01-26    McCain  42.0</span>
<span class="co">#&gt; 336 2008-01-27    McCain  42.0</span>
<span class="co">#&gt; 339 2008-01-30    McCain  46.3</span>
<span class="co">#&gt; 340 2008-01-31    McCain  46.3</span>
<span class="co">#&gt; 341 2008-02-01    McCain  45.5</span>
<span class="co">#&gt; 342 2008-02-02    McCain  45.2</span>
<span class="co">#&gt; 343 2008-02-03    McCain  44.5</span>
<span class="co">#&gt; 344 2008-02-04    McCain  43.6</span>
<span class="co">#&gt; 345 2008-02-05    McCain  43.5</span>
<span class="co">#&gt; 346 2008-02-06    McCain  41.8</span>
<span class="co">#&gt; 347 2008-02-07    McCain  41.8</span>
<span class="co">#&gt; 348 2008-02-08    McCain  41.5</span>
<span class="co">#&gt; 349 2008-02-09    McCain  41.3</span>
<span class="co">#&gt; 350 2008-02-10    McCain  41.3</span>
<span class="co">#&gt; 351 2008-02-11    McCain  41.5</span>
<span class="co">#&gt; 352 2008-02-12    McCain  41.2</span>
<span class="co">#&gt; 353 2008-02-13    McCain  41.5</span>
<span class="co">#&gt; 354 2008-02-14    McCain  41.5</span>
<span class="co">#&gt; 355 2008-02-15    McCain  41.1</span>
<span class="co">#&gt; 356 2008-02-16    McCain  40.4</span>
<span class="co">#&gt; 357 2008-02-17    McCain  40.8</span>
<span class="co">#&gt; 358 2008-02-18    McCain  41.2</span>
<span class="co">#&gt; 359 2008-02-19    McCain  41.9</span>
<span class="co">#&gt; 360 2008-02-20    McCain  42.0</span>
<span class="co">#&gt; 361 2008-02-21    McCain  42.5</span>
<span class="co">#&gt; 362 2008-02-22    McCain  42.6</span>
<span class="co">#&gt; 363 2008-02-23    McCain  43.4</span>
<span class="co">#&gt; 364 2008-02-24    McCain  43.4</span>
<span class="co">#&gt; 365 2008-02-25    McCain  44.0</span>
<span class="co">#&gt; 366 2008-02-26    McCain  44.1</span>
<span class="co">#&gt; 367 2008-02-27    McCain  44.1</span>
<span class="co">#&gt; 368 2008-02-28    McCain  43.9</span>
<span class="co">#&gt; 369 2008-02-29    McCain  45.4</span>
<span class="co">#&gt; 370 2008-03-01    McCain  44.6</span>
<span class="co">#&gt; 371 2008-03-02    McCain  44.6</span>
<span class="co">#&gt; 372 2008-03-03    McCain  43.0</span>
<span class="co">#&gt; 373 2008-03-04    McCain  44.5</span>
<span class="co">#&gt; 374 2008-03-05    McCain  44.6</span>
<span class="co">#&gt; 375 2008-03-06    McCain  44.6</span>
<span class="co">#&gt; 376 2008-03-07    McCain  43.8</span>
<span class="co">#&gt; 377 2008-03-08    McCain  45.4</span>
<span class="co">#&gt; 378 2008-03-09    McCain  45.0</span>
<span class="co">#&gt; 379 2008-03-10    McCain  45.0</span>
<span class="co">#&gt; 380 2008-03-11    McCain  44.6</span>
<span class="co">#&gt; 381 2008-03-12    McCain  44.6</span>
<span class="co">#&gt; 382 2008-03-13    McCain  44.8</span>
<span class="co">#&gt; 383 2008-03-14    McCain  45.0</span>
<span class="co">#&gt; 384 2008-03-15    McCain  45.4</span>
<span class="co">#&gt; 385 2008-03-16    McCain  46.3</span>
<span class="co">#&gt; 386 2008-03-17    McCain  45.9</span>
<span class="co">#&gt; 387 2008-03-18    McCain  45.6</span>
<span class="co">#&gt; 388 2008-03-19    McCain  44.3</span>
<span class="co">#&gt; 389 2008-03-20    McCain  44.7</span>
<span class="co">#&gt; 390 2008-03-21    McCain  44.0</span>
<span class="co">#&gt; 391 2008-03-22    McCain  43.4</span>
<span class="co">#&gt; 392 2008-03-23    McCain  43.0</span>
<span class="co">#&gt; 393 2008-03-24    McCain  44.0</span>
<span class="co">#&gt; 394 2008-03-25    McCain  44.0</span>
<span class="co">#&gt; 395 2008-03-26    McCain  45.8</span>
<span class="co">#&gt; 396 2008-03-27    McCain  44.7</span>
<span class="co">#&gt; 397 2008-03-28    McCain  45.6</span>
<span class="co">#&gt; 398 2008-03-29    McCain  45.6</span>
<span class="co">#&gt; 399 2008-03-30    McCain  45.4</span>
<span class="co">#&gt; 400 2008-03-31    McCain  45.0</span>
<span class="co">#&gt; 401 2008-04-01    McCain  45.5</span>
<span class="co">#&gt; 402 2008-04-02    McCain  44.5</span>
<span class="co">#&gt; 403 2008-04-03    McCain  45.8</span>
<span class="co">#&gt; 404 2008-04-04    McCain  45.4</span>
<span class="co">#&gt; 405 2008-04-05    McCain  45.5</span>
<span class="co">#&gt; 406 2008-04-06    McCain  45.8</span>
<span class="co">#&gt; 407 2008-04-07    McCain  45.4</span>
<span class="co">#&gt; 408 2008-04-08    McCain  43.2</span>
<span class="co">#&gt; 409 2008-04-09    McCain  43.6</span>
<span class="co">#&gt; 410 2008-04-10    McCain  43.6</span>
<span class="co">#&gt; 411 2008-04-11    McCain  42.7</span>
<span class="co">#&gt; 412 2008-04-12    McCain  42.2</span>
<span class="co">#&gt; 413 2008-04-13    McCain  42.6</span>
<span class="co">#&gt; 414 2008-04-14    McCain  42.6</span>
<span class="co">#&gt; 415 2008-04-15    McCain  43.7</span>
<span class="co">#&gt; 416 2008-04-16    McCain  43.9</span>
<span class="co">#&gt; 417 2008-04-17    McCain  44.4</span>
<span class="co">#&gt; 418 2008-04-18    McCain  45.7</span>
<span class="co">#&gt; 419 2008-04-19    McCain  45.3</span>
<span class="co">#&gt; 420 2008-04-20    McCain  44.2</span>
<span class="co">#&gt; 421 2008-04-21    McCain  44.5</span>
<span class="co">#&gt; 422 2008-04-22    McCain  44.5</span>
<span class="co">#&gt; 423 2008-04-23    McCain  44.2</span>
<span class="co">#&gt; 424 2008-04-24    McCain  43.9</span>
<span class="co">#&gt; 425 2008-04-25    McCain  44.0</span>
<span class="co">#&gt; 426 2008-04-26    McCain  43.8</span>
<span class="co">#&gt; 427 2008-04-27    McCain  44.6</span>
<span class="co">#&gt; 428 2008-04-28    McCain  44.4</span>
<span class="co">#&gt; 429 2008-04-29    McCain  44.9</span>
<span class="co">#&gt; 430 2008-04-30    McCain  44.9</span>
<span class="co">#&gt; 431 2008-05-01    McCain  44.6</span>
<span class="co">#&gt; 432 2008-05-02    McCain  44.0</span>
<span class="co">#&gt; 433 2008-05-03    McCain  44.3</span>
<span class="co">#&gt; 434 2008-05-04    McCain  44.5</span>
<span class="co">#&gt; 435 2008-05-05    McCain  44.1</span>
<span class="co">#&gt; 436 2008-05-06    McCain  43.3</span>
<span class="co">#&gt; 437 2008-05-07    McCain  43.4</span>
<span class="co">#&gt; 438 2008-05-08    McCain  43.7</span>
<span class="co">#&gt; 439 2008-05-09    McCain  44.0</span>
<span class="co">#&gt; 440 2008-05-10    McCain  43.1</span>
<span class="co">#&gt; 441 2008-05-11    McCain  43.2</span>
<span class="co">#&gt; 442 2008-05-12    McCain  43.3</span>
<span class="co">#&gt; 443 2008-05-13    McCain  44.1</span>
<span class="co">#&gt; 444 2008-05-14    McCain  43.4</span>
<span class="co">#&gt; 445 2008-05-15    McCain  43.0</span>
<span class="co">#&gt; 446 2008-05-16    McCain  43.0</span>
<span class="co">#&gt; 447 2008-05-17    McCain  42.9</span>
<span class="co">#&gt; 448 2008-05-18    McCain  42.6</span>
<span class="co">#&gt; 449 2008-05-19    McCain  42.9</span>
<span class="co">#&gt; 450 2008-05-20    McCain  41.8</span>
<span class="co">#&gt; 451 2008-05-21    McCain  42.6</span>
<span class="co">#&gt; 452 2008-05-22    McCain  43.2</span>
<span class="co">#&gt; 453 2008-05-23    McCain  44.1</span>
<span class="co">#&gt; 454 2008-05-24    McCain  44.9</span>
<span class="co">#&gt; 455 2008-05-25    McCain  44.9</span>
<span class="co">#&gt; 456 2008-05-26    McCain  45.0</span>
<span class="co">#&gt; 457 2008-05-27    McCain  45.5</span>
<span class="co">#&gt; 458 2008-05-28    McCain  45.4</span>
<span class="co">#&gt; 459 2008-05-29    McCain  45.4</span>
<span class="co">#&gt; 460 2008-05-30    McCain  45.0</span>
<span class="co">#&gt; 461 2008-05-31    McCain  44.7</span>
<span class="co">#&gt; 462 2008-06-01    McCain  44.4</span>
<span class="co">#&gt; 463 2008-06-02    McCain  44.4</span>
<span class="co">#&gt; 464 2008-06-03    McCain  44.2</span>
<span class="co">#&gt; 465 2008-06-04    McCain  44.5</span>
<span class="co">#&gt; 466 2008-06-05    McCain  44.0</span>
<span class="co">#&gt; 467 2008-06-06    McCain  43.8</span>
<span class="co">#&gt; 468 2008-06-07    McCain  43.9</span>
<span class="co">#&gt; 469 2008-06-08    McCain  43.4</span>
<span class="co">#&gt; 470 2008-06-09    McCain  42.5</span>
<span class="co">#&gt; 471 2008-06-10    McCain  41.5</span>
<span class="co">#&gt; 472 2008-06-11    McCain  40.9</span>
<span class="co">#&gt; 473 2008-06-12    McCain  41.2</span>
<span class="co">#&gt; 474 2008-06-13    McCain  41.2</span>
<span class="co">#&gt; 475 2008-06-14    McCain  40.6</span>
<span class="co">#&gt; 476 2008-06-15    McCain  41.0</span>
<span class="co">#&gt; 477 2008-06-16    McCain  40.9</span>
<span class="co">#&gt; 478 2008-06-17    McCain  41.7</span>
<span class="co">#&gt; 479 2008-06-18    McCain  41.1</span>
<span class="co">#&gt; 480 2008-06-19    McCain  40.8</span>
<span class="co">#&gt; 481 2008-06-20    McCain  40.5</span>
<span class="co">#&gt; 482 2008-06-21    McCain  40.6</span>
<span class="co">#&gt; 483 2008-06-22    McCain  40.2</span>
<span class="co">#&gt; 484 2008-06-23    McCain  40.7</span>
<span class="co">#&gt; 485 2008-06-24    McCain  40.9</span>
<span class="co">#&gt; 486 2008-06-25    McCain  41.3</span>
<span class="co">#&gt; 487 2008-06-26    McCain  41.6</span>
<span class="co">#&gt; 488 2008-06-27    McCain  41.7</span>
<span class="co">#&gt; 489 2008-06-28    McCain  41.9</span>
<span class="co">#&gt; 490 2008-06-29    McCain  41.8</span>
<span class="co">#&gt; 491 2008-06-30    McCain  42.0</span>
<span class="co">#&gt; 492 2008-07-01    McCain  41.3</span>
<span class="co">#&gt; 493 2008-07-02    McCain  41.3</span>
<span class="co">#&gt; 494 2008-07-03    McCain  41.3</span>
<span class="co">#&gt; 495 2008-07-04    McCain  41.3</span>
<span class="co">#&gt; 496 2008-07-05    McCain  41.4</span>
<span class="co">#&gt; 497 2008-07-06    McCain  41.4</span>
<span class="co">#&gt; 498 2008-07-07    McCain  40.8</span>
<span class="co">#&gt; 499 2008-07-08    McCain  41.8</span>
<span class="co">#&gt; 500 2008-07-09    McCain  41.4</span>
<span class="co">#&gt; 501 2008-07-10    McCain  41.4</span>
<span class="co">#&gt; 502 2008-07-11    McCain  41.0</span>
<span class="co">#&gt; 503 2008-07-12    McCain  41.3</span>
<span class="co">#&gt; 504 2008-07-13    McCain  41.3</span>
<span class="co">#&gt; 505 2008-07-14    McCain  41.5</span>
<span class="co">#&gt; 506 2008-07-15    McCain  42.2</span>
<span class="co">#&gt; 507 2008-07-16    McCain  41.9</span>
<span class="co">#&gt; 508 2008-07-17    McCain  42.1</span>
<span class="co">#&gt; 509 2008-07-18    McCain  43.3</span>
<span class="co">#&gt; 510 2008-07-19    McCain  42.8</span>
<span class="co">#&gt; 511 2008-07-20    McCain  42.4</span>
<span class="co">#&gt; 512 2008-07-21    McCain  42.6</span>
<span class="co">#&gt; 513 2008-07-22    McCain  41.3</span>
<span class="co">#&gt; 514 2008-07-23    McCain  41.7</span>
<span class="co">#&gt; 515 2008-07-24    McCain  41.7</span>
<span class="co">#&gt; 516 2008-07-25    McCain  41.3</span>
<span class="co">#&gt; 517 2008-07-26    McCain  41.7</span>
<span class="co">#&gt; 518 2008-07-27    McCain  42.1</span>
<span class="co">#&gt; 519 2008-07-28    McCain  41.6</span>
<span class="co">#&gt; 520 2008-07-29    McCain  42.2</span>
<span class="co">#&gt; 521 2008-07-30    McCain  43.0</span>
<span class="co">#&gt; 522 2008-07-31    McCain  42.9</span>
<span class="co">#&gt; 523 2008-08-01    McCain  43.1</span>
<span class="co">#&gt; 524 2008-08-02    McCain  41.5</span>
<span class="co">#&gt; 525 2008-08-03    McCain  41.1</span>
<span class="co">#&gt; 526 2008-08-04    McCain  41.2</span>
<span class="co">#&gt; 527 2008-08-05    McCain  41.3</span>
<span class="co">#&gt; 528 2008-08-06    McCain  40.7</span>
<span class="co">#&gt; 529 2008-08-07    McCain  40.7</span>
<span class="co">#&gt; 530 2008-08-08    McCain  40.8</span>
<span class="co">#&gt; 531 2008-08-09    McCain  42.0</span>
<span class="co">#&gt; 532 2008-08-10    McCain  42.0</span>
<span class="co">#&gt; 533 2008-08-11    McCain  42.8</span>
<span class="co">#&gt; 534 2008-08-12    McCain  43.0</span>
<span class="co">#&gt; 535 2008-08-13    McCain  43.6</span>
<span class="co">#&gt; 536 2008-08-14    McCain  43.8</span>
<span class="co">#&gt; 537 2008-08-15    McCain  43.8</span>
<span class="co">#&gt; 538 2008-08-16    McCain  43.7</span>
<span class="co">#&gt; 539 2008-08-17    McCain  43.6</span>
<span class="co">#&gt; 540 2008-08-18    McCain  43.4</span>
<span class="co">#&gt; 541 2008-08-19    McCain  42.7</span>
<span class="co">#&gt; 542 2008-08-20    McCain  42.9</span>
<span class="co">#&gt; 543 2008-08-21    McCain  42.5</span>
<span class="co">#&gt; 544 2008-08-22    McCain  42.5</span>
<span class="co">#&gt; 545 2008-08-23    McCain  43.1</span>
<span class="co">#&gt; 546 2008-08-24    McCain  43.1</span>
<span class="co">#&gt; 547 2008-08-25    McCain  42.5</span>
<span class="co">#&gt; 548 2008-08-26    McCain  43.8</span>
<span class="co">#&gt; 549 2008-08-27    McCain  43.5</span>
<span class="co">#&gt; 550 2008-08-28    McCain  43.6</span>
<span class="co">#&gt; 551 2008-08-29    McCain  44.1</span>
<span class="co">#&gt; 552 2008-08-30    McCain  43.1</span>
<span class="co">#&gt; 553 2008-08-31    McCain  42.7</span>
<span class="co">#&gt; 554 2008-09-01    McCain  43.2</span>
<span class="co">#&gt; 555 2008-09-02    McCain  42.5</span>
<span class="co">#&gt; 556 2008-09-03    McCain  42.5</span>
<span class="co">#&gt; 557 2008-09-04    McCain  42.5</span>
<span class="co">#&gt; 558 2008-09-05    McCain  42.8</span>
<span class="co">#&gt; 559 2008-09-06    McCain  44.3</span>
<span class="co">#&gt; 560 2008-09-07    McCain  45.5</span>
<span class="co">#&gt; 561 2008-09-08    McCain  45.3</span>
<span class="co">#&gt; 562 2008-09-09    McCain  46.2</span>
<span class="co">#&gt; 563 2008-09-10    McCain  46.3</span>
<span class="co">#&gt; 564 2008-09-11    McCain  46.5</span>
<span class="co">#&gt; 565 2008-09-12    McCain  46.3</span>
<span class="co">#&gt; 566 2008-09-13    McCain  45.7</span>
<span class="co">#&gt; 567 2008-09-14    McCain  45.5</span>
<span class="co">#&gt; 568 2008-09-15    McCain  45.7</span>
<span class="co">#&gt; 569 2008-09-16    McCain  45.5</span>
<span class="co">#&gt; 570 2008-09-17    McCain  45.6</span>
<span class="co">#&gt; 571 2008-09-18    McCain  45.5</span>
<span class="co">#&gt; 572 2008-09-19    McCain  45.2</span>
<span class="co">#&gt; 573 2008-09-20    McCain  45.0</span>
<span class="co">#&gt; 574 2008-09-21    McCain  45.0</span>
<span class="co">#&gt; 575 2008-09-22    McCain  44.5</span>
<span class="co">#&gt; 576 2008-09-23    McCain  44.4</span>
<span class="co">#&gt; 577 2008-09-24    McCain  44.4</span>
<span class="co">#&gt; 578 2008-09-25    McCain  44.3</span>
<span class="co">#&gt; 579 2008-09-26    McCain  44.1</span>
<span class="co">#&gt; 580 2008-09-27    McCain  44.2</span>
<span class="co">#&gt; 581 2008-09-28    McCain  43.6</span>
<span class="co">#&gt; 582 2008-09-29    McCain  43.8</span>
<span class="co">#&gt; 583 2008-09-30    McCain  43.5</span>
<span class="co">#&gt; 584 2008-10-01    McCain  43.4</span>
<span class="co">#&gt; 585 2008-10-02    McCain  43.2</span>
<span class="co">#&gt; 586 2008-10-03    McCain  43.2</span>
<span class="co">#&gt; 587 2008-10-04    McCain  43.0</span>
<span class="co">#&gt; 588 2008-10-05    McCain  43.0</span>
<span class="co">#&gt; 589 2008-10-06    McCain  43.0</span>
<span class="co">#&gt; 590 2008-10-07    McCain  43.1</span>
<span class="co">#&gt; 591 2008-10-08    McCain  42.5</span>
<span class="co">#&gt; 592 2008-10-09    McCain  42.5</span>
<span class="co">#&gt; 593 2008-10-10    McCain  42.3</span>
<span class="co">#&gt; 594 2008-10-11    McCain  42.2</span>
<span class="co">#&gt; 595 2008-10-12    McCain  42.0</span>
<span class="co">#&gt; 596 2008-10-13    McCain  41.9</span>
<span class="co">#&gt; 597 2008-10-14    McCain  42.0</span>
<span class="co">#&gt; 598 2008-10-15    McCain  42.5</span>
<span class="co">#&gt; 599 2008-10-16    McCain  42.7</span>
<span class="co">#&gt; 600 2008-10-17    McCain  42.8</span>
<span class="co">#&gt; 601 2008-10-18    McCain  43.0</span>
<span class="co">#&gt; 602 2008-10-19    McCain  43.1</span>
<span class="co">#&gt; 603 2008-10-20    McCain  42.9</span>
<span class="co">#&gt; 604 2008-10-21    McCain  42.9</span>
<span class="co">#&gt; 605 2008-10-22    McCain  42.5</span>
<span class="co">#&gt; 606 2008-10-23    McCain  42.5</span>
<span class="co">#&gt; 607 2008-10-24    McCain  42.6</span>
<span class="co">#&gt; 608 2008-10-25    McCain  42.4</span>
<span class="co">#&gt; 609 2008-10-26    McCain  42.6</span>
<span class="co">#&gt; 610 2008-10-27    McCain  42.8</span>
<span class="co">#&gt; 611 2008-10-28    McCain  43.0</span>
<span class="co">#&gt; 612 2008-10-29    McCain  43.3</span>
<span class="co">#&gt; 613 2008-10-30    McCain  43.4</span>
<span class="co">#&gt; 614 2008-10-31    McCain  43.7</span>
<span class="co">#&gt; 615 2008-11-01    McCain  44.0</span>
<span class="co">#&gt; 616 2008-11-02    McCain  44.2</span>
<span class="co">#&gt; 617 2008-11-03    McCain  44.2</span>
<span class="co">#&gt; 618 2008-11-04    McCain  44.2</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(pop_vote_avg_tidy, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> share,
                              <span class="dt">colour =</span> <span class="kw">fct_reorder2</span>(candidate, date, share))) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="st">&quot;Candidate&quot;</span>,
                      <span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">Obama =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">McCain =</span> <span class="st">&quot;red&quot;</span>))</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-25-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><strong>Challenge</strong> read <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/iteration.html#the-map-functions">Iteration</a> and use the function <a href="https://www.rdocumentation.org/packages/purrr/topics/map_df">map_df</a> instead of a for loop.</p>
<p>The 7-day average is similar to the simple method used by <a href="http://www.realclearpolitics.com/epolls/2016/president/us/general_election_trump_vs_clinton-5491.html">Real Clear Politics</a>. The RCP average is simply the average of all polls in their data for the last seven days. Sites like <a href="https://fivethirtyeight.com">538</a> and the <a href="http://elections.huffingtonpost.com/pollster">Huffpost Pollster</a>, on the other hand, also use what amounts to averaging polls, but using more sophisticated statistical methods to assign different weights to different polls.</p>
<p><strong>Challenge</strong> Why do we need to use different polls for the popular vote data? Why not simply average all the state polls? What would you have to do? Would the overall popular vote be useful in predicting state-level polling, or vice-versa? How would you use them?</p>
</div>
<div id="linear-regression" class="section level2">
<h2><span class="header-section-number">4.4</span> Linear Regression</h2>
<div id="facial-appearance-and-election-outcomes" class="section level3">
<h3><span class="header-section-number">4.4.1</span> Facial Appearance and Election Outcomes</h3>
<p>Load the <code>face</code> dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;face&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</code></pre></div>
<p>Add Democrat and Republican vote shares, and the difference in shares:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">face &lt;-<span class="st"> </span><span class="kw">mutate</span>(face,
                <span class="dt">d.share =</span> d.votes <span class="op">/</span><span class="st"> </span>(d.votes <span class="op">+</span><span class="st"> </span>r.votes),
                <span class="dt">r.share =</span> r.votes <span class="op">/</span><span class="st"> </span>(d.votes <span class="op">+</span><span class="st"> </span>r.votes),
                <span class="dt">diff.share =</span> d.share <span class="op">-</span><span class="st"> </span>r.share)</code></pre></div>
<p>Plot facial competence vs. vote share:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(face, <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share, <span class="dt">colour =</span> w.party)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="st">&quot;Winning</span><span class="ch">\n</span><span class="st">Party&quot;</span>,
                      <span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">R =</span> <span class="st">&quot;red&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Competence scores for Democrats&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Democratic margin in vote share&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-26-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="correlation-1" class="section level3">
<h3><span class="header-section-number">4.4.2</span> Correlation</h3>
</div>
<div id="least-squares" class="section level3">
<h3><span class="header-section-number">4.4.3</span> Least Squares</h3>
<p>Run the linear regression</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">lm</span>(diff.share <span class="op">~</span><span class="st"> </span>d.comp, <span class="dt">data =</span> face)
fit
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = diff.share ~ d.comp, data = face)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)       d.comp  </span>
<span class="co">#&gt;      -0.312        0.660</span></code></pre></div>
<p>There are many functions to get data out of the <code>lm</code> model.</p>
<p>In addition to these, the <strong>broom</strong> package provides three functions: <code>glance</code>, <code>tidy</code>, and <code>augment</code> that always return data frames.</p>
<p>The function <a href="https://www.rdocumentation.org/packages/broom/topics/glance.lm">glance</a> returns a one-row data-frame summary of the model,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(fit)
<span class="co">#&gt;   r.squared adj.r.squared sigma statistic  p.value df logLik AIC  BIC</span>
<span class="co">#&gt; 1     0.187          0.18 0.266        27 8.85e-07  2  -10.5  27 35.3</span>
<span class="co">#&gt;   deviance df.residual</span>
<span class="co">#&gt; 1     8.31         117</span></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/broom/topics/tidy.lm">tidy</a> returns a data frame in which each row is a coefficient,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tidy</span>(fit)
<span class="co">#&gt;          term estimate std.error statistic  p.value</span>
<span class="co">#&gt; 1 (Intercept)   -0.312     0.066     -4.73 6.24e-06</span>
<span class="co">#&gt; 2      d.comp    0.660     0.127      5.19 8.85e-07</span></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/broom/topics/augment.lm">augment</a> returns the original data with fitted values, residuals, and other observation level stats from the model appended to it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">augment</span>(fit) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()
<span class="co">#&gt;   diff.share d.comp .fitted .se.fit  .resid    .hat .sigma  .cooksd</span>
<span class="co">#&gt; 1     0.2101  0.565  0.0606  0.0266  0.1495 0.00996  0.267 0.001600</span>
<span class="co">#&gt; 2     0.1194  0.342 -0.0864  0.0302  0.2059 0.01286  0.267 0.003938</span>
<span class="co">#&gt; 3     0.0499  0.612  0.0922  0.0295 -0.0423 0.01229  0.268 0.000158</span>
<span class="co">#&gt; 4     0.1965  0.542  0.0454  0.0256  0.1511 0.00922  0.267 0.001510</span>
<span class="co">#&gt; 5     0.4958  0.680  0.1370  0.0351  0.3588 0.01737  0.266 0.016307</span>
<span class="co">#&gt; 6    -0.3495  0.321 -0.1006  0.0319 -0.2490 0.01433  0.267 0.006436</span>
<span class="co">#&gt;   .std.resid</span>
<span class="co">#&gt; 1      0.564</span>
<span class="co">#&gt; 2      0.778</span>
<span class="co">#&gt; 3     -0.160</span>
<span class="co">#&gt; 4      0.570</span>
<span class="co">#&gt; 5      1.358</span>
<span class="co">#&gt; 6     -0.941</span></code></pre></div>
<p>We can plot the results of the bivariate linear regression as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> face, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">slope =</span> <span class="kw">coef</span>(fit)[<span class="st">&quot;d.comp&quot;</span>],
              <span class="dt">intercept =</span> <span class="kw">coef</span>(fit)[<span class="st">&quot;(Intercept)&quot;</span>],
              <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-31-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>A more general way to plot the predictions of the model against the data is to use the methods described in <a href="http://r4ds.had.co.nz/model-basics.html#visualising-models">Ch 23.3.3</a> of R4DS. Create an evenly spaced grid of values of <code>d.comp</code>, and add predictions of the model to it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grid &lt;-<span class="st"> </span>face <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">data_grid</span>(d.comp) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(fit)
<span class="kw">head</span>(grid)
<span class="co">#&gt; # A tibble: 6 x 2</span>
<span class="co">#&gt;   d.comp   pred</span>
<span class="co">#&gt;    &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 0.0640 -0.270</span>
<span class="co">#&gt; 2 0.0847 -0.256</span>
<span class="co">#&gt; 3 0.0893 -0.253</span>
<span class="co">#&gt; 4 0.1145 -0.237</span>
<span class="co">#&gt; 5 0.1148 -0.236</span>
<span class="co">#&gt; 6 0.1639 -0.204</span></code></pre></div>
<p>Now we can plot the regression line and the original data just like any other plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> face, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> grid, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> pred),
            <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-33-1.png" width="70%" style="display: block; margin: auto;" /> This method is more complicated than the <code>geom_abline</code> method for a bivariate regression, but will work for more complicated models, while the <code>geom_abline</code> method won’t.</p>
<p>Note that <a href="http://docs.ggplot2.org/current/geom_smooth.html">geom_smooth</a> can be used to add a regression line to a data-set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> face, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-34-1.png" width="70%" style="display: block; margin: auto;" /> The argument <code>method = &quot;lm&quot;</code> specifies that the function <code>lm</code> is to be used to generate fitted values. It is equivalent to running the regression <code>lm(y ~ x)</code> and plotting the regression line, where <code>y</code> and <code>x</code> are the aesthetics specified by the mappings. The argument <code>se = FALSE</code> tells the function not to plot the confidence interval of the regression (discussed later).</p>
</div>
<div id="regression-towards-the-mean" class="section level3">
<h3><span class="header-section-number">4.4.4</span> Regression towards the mean</h3>
</div>
<div id="merging-data-sets-in-r" class="section level3">
<h3><span class="header-section-number">4.4.5</span> Merging Data Sets in R</h3>
<p>See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/relational-data.html">Relational data</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;pres12&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">full_join</span>(pres08, pres12, <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>)
<span class="co">#&gt;        state.name state Obama.x McCain EV.x margin Obama.y Romney EV.y</span>
<span class="co">#&gt; 1         Alabama    AL      39     60    9    -21      38     61    9</span>
<span class="co">#&gt; 2          Alaska    AK      38     59    3    -21      41     55    3</span>
<span class="co">#&gt; 3         Arizona    AZ      45     54   10     -9      45     54   11</span>
<span class="co">#&gt; 4        Arkansas    AR      39     59    6    -20      37     61    6</span>
<span class="co">#&gt; 5      California    CA      61     37   55     24      60     37   55</span>
<span class="co">#&gt; 6        Colorado    CO      54     45    9      9      51     46    9</span>
<span class="co">#&gt; 7     Connecticut    CT      61     38    7     23      58     41    7</span>
<span class="co">#&gt; 8            D.C.    DC      92      7    3     85      91      7    3</span>
<span class="co">#&gt; 9        Delaware    DE      62     37    3     25      59     40    3</span>
<span class="co">#&gt; 10        Florida    FL      51     48   27      3      50     49   29</span>
<span class="co">#&gt; 11        Georgia    GA      47     52   15     -5      45     53   16</span>
<span class="co">#&gt; 12         Hawaii    HI      72     27    4     45      71     28    4</span>
<span class="co">#&gt; 13          Idaho    ID      36     62    4    -26      33     65    4</span>
<span class="co">#&gt; 14       Illinois    IL      62     37   21     25      58     41   20</span>
<span class="co">#&gt; 15        Indiana    IN      50     49   11      1      44     54   11</span>
<span class="co">#&gt; 16           Iowa    IA      54     44    7     10      52     46    6</span>
<span class="co">#&gt; 17         Kansas    KS      42     57    6    -15      38     60    6</span>
<span class="co">#&gt; 18       Kentucky    KY      41     57    8    -16      38     60    8</span>
<span class="co">#&gt; 19      Louisiana    LA      40     59    9    -19      41     58    8</span>
<span class="co">#&gt; 20          Maine    ME      58     40    4     18      56     41    4</span>
<span class="co">#&gt; 21       Maryland    MD      62     36   10     26      62     36   10</span>
<span class="co">#&gt; 22  Massachusetts    MA      62     36   12     26      61     38   11</span>
<span class="co">#&gt; 23       Michigan    MI      57     41   17     16      54     45   16</span>
<span class="co">#&gt; 24      Minnesota    MN      54     44   10     10      53     45   10</span>
<span class="co">#&gt; 25    Mississippi    MS      43     56    6    -13      44     55    6</span>
<span class="co">#&gt; 26       Missouri    MO      48     49   11     -1      44     54   10</span>
<span class="co">#&gt; 27        Montana    MT      47     50    3     -3      42     55    3</span>
<span class="co">#&gt; 28       Nebraska    NE      42     57    5    -15      38     60    5</span>
<span class="co">#&gt; 29         Nevada    NV      55     43    5     12      52     46    6</span>
<span class="co">#&gt; 30  New Hampshire    NH      54     45    4      9      52     46    4</span>
<span class="co">#&gt; 31     New Jersey    NJ      57     42   15     15      58     41   14</span>
<span class="co">#&gt; 32     New Mexico    NM      57     42    5     15      53     43    5</span>
<span class="co">#&gt; 33       New York    NY      63     36   31     27      63     35   29</span>
<span class="co">#&gt; 34 North Carolina    NC      50     49   15      1      48     50   15</span>
<span class="co">#&gt; 35   North Dakota    ND      45     53    3     -8      39     58    3</span>
<span class="co">#&gt; 36           Ohio    OH      51     47   20      4      51     48   18</span>
<span class="co">#&gt; 37       Oklahoma    OK      34     66    7    -32      33     67    7</span>
<span class="co">#&gt; 38         Oregon    OR      57     40    7     17      54     42    7</span>
<span class="co">#&gt; 39   Pennsylvania    PA      55     44   21     11      52     47   20</span>
<span class="co">#&gt; 40   Rhode Island    RI      63     35    4     28      63     35    4</span>
<span class="co">#&gt; 41 South Carolina    SC      45     54    8     -9      44     55    9</span>
<span class="co">#&gt; 42   South Dakota    SD      45     53    3     -8      40     58    3</span>
<span class="co">#&gt; 43      Tennessee    TN      42     57   11    -15      39     59   11</span>
<span class="co">#&gt; 44          Texas    TX      44     55   34    -11      41     57   38</span>
<span class="co">#&gt; 45           Utah    UT      34     63    5    -29      25     73    6</span>
<span class="co">#&gt; 46        Vermont    VT      67     30    3     37      67     31    3</span>
<span class="co">#&gt; 47       Virginia    VA      53     46   13      7      51     47   13</span>
<span class="co">#&gt; 48     Washington    WA      58     40   11     18      56     41   12</span>
<span class="co">#&gt; 49  West Virginia    WV      43     56    5    -13      36     62    5</span>
<span class="co">#&gt; 50      Wisconsin    WI      56     42   10     14      53     46   10</span>
<span class="co">#&gt; 51        Wyoming    WY      33     65    3    -32      28     69    3</span></code></pre></div>
<p><em>Note: this could be a question. How would you change the .x, .y suffixes to something more informative</em> To avoid the duplicate names, or change them, you can rename before merging, or use the <code>suffix</code> argument:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pres &lt;-<span class="st"> </span><span class="kw">full_join</span>(pres08, pres12, <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;_08&quot;</span>, <span class="st">&quot;_12&quot;</span>))
pres
<span class="co">#&gt;        state.name state Obama_08 McCain EV_08 margin Obama_12 Romney EV_12</span>
<span class="co">#&gt; 1         Alabama    AL       39     60     9    -21       38     61     9</span>
<span class="co">#&gt; 2          Alaska    AK       38     59     3    -21       41     55     3</span>
<span class="co">#&gt; 3         Arizona    AZ       45     54    10     -9       45     54    11</span>
<span class="co">#&gt; 4        Arkansas    AR       39     59     6    -20       37     61     6</span>
<span class="co">#&gt; 5      California    CA       61     37    55     24       60     37    55</span>
<span class="co">#&gt; 6        Colorado    CO       54     45     9      9       51     46     9</span>
<span class="co">#&gt; 7     Connecticut    CT       61     38     7     23       58     41     7</span>
<span class="co">#&gt; 8            D.C.    DC       92      7     3     85       91      7     3</span>
<span class="co">#&gt; 9        Delaware    DE       62     37     3     25       59     40     3</span>
<span class="co">#&gt; 10        Florida    FL       51     48    27      3       50     49    29</span>
<span class="co">#&gt; 11        Georgia    GA       47     52    15     -5       45     53    16</span>
<span class="co">#&gt; 12         Hawaii    HI       72     27     4     45       71     28     4</span>
<span class="co">#&gt; 13          Idaho    ID       36     62     4    -26       33     65     4</span>
<span class="co">#&gt; 14       Illinois    IL       62     37    21     25       58     41    20</span>
<span class="co">#&gt; 15        Indiana    IN       50     49    11      1       44     54    11</span>
<span class="co">#&gt; 16           Iowa    IA       54     44     7     10       52     46     6</span>
<span class="co">#&gt; 17         Kansas    KS       42     57     6    -15       38     60     6</span>
<span class="co">#&gt; 18       Kentucky    KY       41     57     8    -16       38     60     8</span>
<span class="co">#&gt; 19      Louisiana    LA       40     59     9    -19       41     58     8</span>
<span class="co">#&gt; 20          Maine    ME       58     40     4     18       56     41     4</span>
<span class="co">#&gt; 21       Maryland    MD       62     36    10     26       62     36    10</span>
<span class="co">#&gt; 22  Massachusetts    MA       62     36    12     26       61     38    11</span>
<span class="co">#&gt; 23       Michigan    MI       57     41    17     16       54     45    16</span>
<span class="co">#&gt; 24      Minnesota    MN       54     44    10     10       53     45    10</span>
<span class="co">#&gt; 25    Mississippi    MS       43     56     6    -13       44     55     6</span>
<span class="co">#&gt; 26       Missouri    MO       48     49    11     -1       44     54    10</span>
<span class="co">#&gt; 27        Montana    MT       47     50     3     -3       42     55     3</span>
<span class="co">#&gt; 28       Nebraska    NE       42     57     5    -15       38     60     5</span>
<span class="co">#&gt; 29         Nevada    NV       55     43     5     12       52     46     6</span>
<span class="co">#&gt; 30  New Hampshire    NH       54     45     4      9       52     46     4</span>
<span class="co">#&gt; 31     New Jersey    NJ       57     42    15     15       58     41    14</span>
<span class="co">#&gt; 32     New Mexico    NM       57     42     5     15       53     43     5</span>
<span class="co">#&gt; 33       New York    NY       63     36    31     27       63     35    29</span>
<span class="co">#&gt; 34 North Carolina    NC       50     49    15      1       48     50    15</span>
<span class="co">#&gt; 35   North Dakota    ND       45     53     3     -8       39     58     3</span>
<span class="co">#&gt; 36           Ohio    OH       51     47    20      4       51     48    18</span>
<span class="co">#&gt; 37       Oklahoma    OK       34     66     7    -32       33     67     7</span>
<span class="co">#&gt; 38         Oregon    OR       57     40     7     17       54     42     7</span>
<span class="co">#&gt; 39   Pennsylvania    PA       55     44    21     11       52     47    20</span>
<span class="co">#&gt; 40   Rhode Island    RI       63     35     4     28       63     35     4</span>
<span class="co">#&gt; 41 South Carolina    SC       45     54     8     -9       44     55     9</span>
<span class="co">#&gt; 42   South Dakota    SD       45     53     3     -8       40     58     3</span>
<span class="co">#&gt; 43      Tennessee    TN       42     57    11    -15       39     59    11</span>
<span class="co">#&gt; 44          Texas    TX       44     55    34    -11       41     57    38</span>
<span class="co">#&gt; 45           Utah    UT       34     63     5    -29       25     73     6</span>
<span class="co">#&gt; 46        Vermont    VT       67     30     3     37       67     31     3</span>
<span class="co">#&gt; 47       Virginia    VA       53     46    13      7       51     47    13</span>
<span class="co">#&gt; 48     Washington    WA       58     40    11     18       56     41    12</span>
<span class="co">#&gt; 49  West Virginia    WV       43     56     5    -13       36     62     5</span>
<span class="co">#&gt; 50      Wisconsin    WI       56     42    10     14       53     46    10</span>
<span class="co">#&gt; 51        Wyoming    WY       33     65     3    -32       28     69     3</span></code></pre></div>
<p>The <strong>dplyr</strong> equivalent functions for <a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a> is <a href="https://www.rdocumentation.org/packages/dplyr/topics/bind_cols">bind_cols</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pres &lt;-<span class="st"> </span>pres <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Obama2008.z =</span> <span class="kw">as.numeric</span>(<span class="kw">scale</span>(Obama_<span class="dv">08</span>)),
         <span class="dt">Obama2012.z =</span> <span class="kw">as.numeric</span>(<span class="kw">scale</span>(Obama_<span class="dv">12</span>)))</code></pre></div>
<p>We need to use the <code>as.numeric</code> function because <code>scale()</code> always returns a matrix. This will not produce an error in the code chunk above, since the columns of a data frame can be matrices, but will produce errors in some of the following code if it were omitted.</p>
<p>Scatter plot of states with vote shares in 2008 and 2012</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(pres, <span class="kw">aes</span>(<span class="dt">x =</span> Obama2008.z, <span class="dt">y =</span> Obama2012.z, <span class="dt">label =</span> state)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Obama&#39;s standardized vote share in 2008&quot;</span>,
                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Obama&#39;s standardized vote share in 2012&quot;</span>,
                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>))</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-38-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>To calculate the bottom and top quartiles</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pres <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(Obama2008.z <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(Obama2008.z, <span class="fl">0.25</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">improve =</span> <span class="kw">mean</span>(Obama2012.z <span class="op">&gt;</span><span class="st"> </span>Obama2008.z))
<span class="co">#&gt;   improve</span>
<span class="co">#&gt; 1   0.583</span>

pres <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(Obama2008.z <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(Obama2008.z, <span class="fl">0.75</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">improve =</span> <span class="kw">mean</span>(Obama2012.z <span class="op">&gt;</span><span class="st"> </span>Obama2008.z))
<span class="co">#&gt;   improve</span>
<span class="co">#&gt; 1     0.5</span></code></pre></div>
<p><strong>Challenge:</strong> Why is it important to standardize the vote shares?</p>
</div>
<div id="model-fit" class="section level3">
<h3><span class="header-section-number">4.4.6</span> Model Fit</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;florida&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)
fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(Buchanan00 <span class="op">~</span><span class="st"> </span>Perot96, <span class="dt">data =</span> florida)
fit2
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = Buchanan00 ~ Perot96, data = florida)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)      Perot96  </span>
<span class="co">#&gt;      1.3458       0.0359</span></code></pre></div>
<p>In addition to</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(fit2)<span class="op">$</span>r.squared
<span class="co">#&gt; [1] 0.513</span></code></pre></div>
<p>we can get the R squared value from the data frame <a href="https://www.rdocumentation.org/packages/broom/topics/glance.lm">glance</a> returns:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(fit2)
<span class="co">#&gt;   r.squared adj.r.squared sigma statistic  p.value df logLik AIC BIC</span>
<span class="co">#&gt; 1     0.513         0.506   316      68.5 9.47e-12  2   -480 966 972</span>
<span class="co">#&gt;   deviance df.residual</span>
<span class="co">#&gt; 1  6506118          65</span></code></pre></div>
<p>We can add predictions and residuals to the original data frame using the <a href="https://cran.r-project.org/package=modelr">modelr</a> functions <a href="https://www.rdocumentation.org/packages/modelr/topics/add_residuals">add_residuals</a> and <a href="https://www.rdocumentation.org/packages/modelr/topics/add_predictions">add_predictions</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">florida &lt;-
<span class="st">  </span>florida <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(fit2) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_residuals</span>(fit2)
<span class="kw">glimpse</span>(florida)
<span class="co">#&gt; Observations: 67</span>
<span class="co">#&gt; Variables: 9</span>
<span class="co">#&gt; $ county     &lt;chr&gt; &quot;Alachua&quot;, &quot;Baker&quot;, &quot;Bay&quot;, &quot;Bradford&quot;, &quot;Brevard&quot;, &quot;...</span>
<span class="co">#&gt; $ Clinton96  &lt;int&gt; 40144, 2273, 17020, 3356, 80416, 320736, 1794, 2712...</span>
<span class="co">#&gt; $ Dole96     &lt;int&gt; 25303, 3684, 28290, 4038, 87980, 142834, 1717, 2783...</span>
<span class="co">#&gt; $ Perot96    &lt;int&gt; 8072, 667, 5922, 819, 25249, 38964, 630, 7783, 7244...</span>
<span class="co">#&gt; $ Bush00     &lt;int&gt; 34124, 5610, 38637, 5414, 115185, 177323, 2873, 354...</span>
<span class="co">#&gt; $ Gore00     &lt;int&gt; 47365, 2392, 18850, 3075, 97318, 386561, 2155, 2964...</span>
<span class="co">#&gt; $ Buchanan00 &lt;int&gt; 263, 73, 248, 65, 570, 788, 90, 182, 270, 186, 122,...</span>
<span class="co">#&gt; $ pred       &lt;dbl&gt; 291.3, 25.3, 214.0, 30.8, 908.2, 1400.7, 24.0, 280....</span>
<span class="co">#&gt; $ resid      &lt;dbl&gt; -2.83e+01, 4.77e+01, 3.40e+01, 3.42e+01, -3.38e+02,...</span></code></pre></div>
<p>There are now two new columns in <code>florida</code>, <code>pred</code> with the fitted values (predictions), and <code>resid</code> with the residuals.</p>
<p>Use <code>fit2_augment</code> to create a residual plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit2_resid_plot &lt;-
<span class="st">  </span><span class="kw">ggplot</span>(florida, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> resid)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Fitted values&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;residuals&quot;</span>)
fit2_resid_plot</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-44-1.png" width="70%" style="display: block; margin: auto;" /> Note, we use the function <a href="https://www.rdocumentation.org/packages/modelr/topics/geom_refline">geom_refline</a> to add a reference line at 0.</p>
<p>Let’s add some labels to points, who is that outlier?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit2_resid_plot <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">label =</span> county))</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-45-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The outlier county is “Palm Beach”</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">arrange</span>(florida) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(<span class="kw">abs</span>(resid))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(county, resid) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">head</span>()
<span class="co">#&gt;       county resid</span>
<span class="co">#&gt; 1  PalmBeach  2302</span>
<span class="co">#&gt; 2    Broward  -613</span>
<span class="co">#&gt; 3        Lee  -357</span>
<span class="co">#&gt; 4    Brevard  -338</span>
<span class="co">#&gt; 5 Miami-Dade  -329</span>
<span class="co">#&gt; 6   Pinellas  -317</span></code></pre></div>
<p>Data without Palm Beach</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">florida_pb &lt;-<span class="st"> </span><span class="kw">filter</span>(florida, county <span class="op">!=</span><span class="st"> &quot;PalmBeach&quot;</span>)
fit3 &lt;-<span class="st"> </span><span class="kw">lm</span>(Buchanan00 <span class="op">~</span><span class="st"> </span>Perot96, <span class="dt">data =</span> florida_pb)
fit3
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = Buchanan00 ~ Perot96, data = florida_pb)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)      Perot96  </span>
<span class="co">#&gt;     45.8419       0.0244</span></code></pre></div>
<p><span class="math inline">\(R^2\)</span> or coefficient of determination</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(fit3)
<span class="co">#&gt;   r.squared adj.r.squared sigma statistic  p.value df logLik AIC BIC</span>
<span class="co">#&gt; 1     0.851         0.849  87.7       366 3.61e-28  2   -388 782 788</span>
<span class="co">#&gt;   deviance df.residual</span>
<span class="co">#&gt; 1   492803          64</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">florida_pb <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_residuals</span>(fit3) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(fit3) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> resid)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">ylim</span>(<span class="op">-</span><span class="dv">750</span>, <span class="dv">2500</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="dv">1500</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Fitted values&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;residuals&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-49-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Create predictions for both models using <a href="https://www.rdocumentation.org/packages/modelr/topics/data_grid">data_grid</a> and <a href="https://www.rdocumentation.org/packages/modelr/topics/gather_predictions">gather_predictions</a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">florida_grid &lt;-
<span class="st">  </span>florida <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">data_grid</span>(Perot96) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather_predictions</span>(fit2, fit3) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span>
           <span class="kw">fct_recode</span>(model,
                      <span class="st">&quot;Regression</span><span class="ch">\n</span><span class="st"> with Palm Beach&quot;</span> =<span class="st"> &quot;fit2&quot;</span>,
                      <span class="st">&quot;Regression</span><span class="ch">\n</span><span class="st"> without Palm Beach&quot;</span> =<span class="st"> &quot;fit3&quot;</span>))</code></pre></div>
<p>Note this is an example of using non-syntactic column names in a tibble, as discussed in Chapter 10 of <a href="http://r4ds.had.co.nz/tibbles.html">R for data science</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> florida, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Perot96, <span class="dt">y =</span> Buchanan00)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> florida_grid,
             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Perot96, <span class="dt">y =</span> pred,
                           <span class="dt">colour =</span> model)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_label</span>(<span class="dt">data =</span> <span class="kw">filter</span>(florida, county <span class="op">==</span><span class="st"> &quot;PalmBeach&quot;</span>),
             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Perot96, <span class="dt">y =</span> Buchanan00, <span class="dt">label =</span> county),
                           <span class="dt">vjust =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">hjust =</span> <span class="st">&quot;right&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> <span class="kw">tibble</span>(<span class="dt">label =</span> <span class="kw">unique</span>(florida_grid<span class="op">$</span>model),
                           <span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">20000</span>, <span class="dv">31000</span>),
                           <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">300</span>)),
             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> label, <span class="dt">colour =</span> label)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Perot&#39;s Vote in 1996&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Buchanan&#39;s Votes in 1996&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-51-1.png" width="70%" style="display: block; margin: auto;" /> See <a href="http://r4ds.had.co.nz/graphics-for-communication.html#label">Graphics for communication</a> in <em>R for Data Science</em> on labels and annotations in plots.</p>
</div>
</div>
<div id="regression-and-causation" class="section level2">
<h2><span class="header-section-number">4.5</span> Regression and Causation</h2>
<p>Load data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;women&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</code></pre></div>
<p>proportion of female politicians in reserved GP vs. unreserved GP</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">women <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(reserved) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prop_female =</span> <span class="kw">mean</span>(female))
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   reserved prop_female</span>
<span class="co">#&gt;      &lt;int&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1        0      0.0748</span>
<span class="co">#&gt; 2        1      1.0000</span></code></pre></div>
<p>The diff in diff estimator</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># drinking water facilities</span>

<span class="co"># irrigation facilities</span>
<span class="kw">mean</span>(women<span class="op">$</span>irrigation[women<span class="op">$</span>reserved <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]) <span class="op">-</span>
<span class="st">    </span><span class="kw">mean</span>(women<span class="op">$</span>irrigation[women<span class="op">$</span>reserved <span class="op">==</span><span class="st"> </span><span class="dv">0</span>])
<span class="co">#&gt; [1] -0.369</span></code></pre></div>
<p>Mean values of <code>irrigation</code> and <code>water</code> in reserved and non-reserved districts.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">women <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(reserved) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">irrigation =</span> <span class="kw">mean</span>(irrigation),
            <span class="dt">water =</span> <span class="kw">mean</span>(water))
<span class="co">#&gt; # A tibble: 2 x 3</span>
<span class="co">#&gt;   reserved irrigation water</span>
<span class="co">#&gt;      &lt;int&gt;      &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1        0       3.39  14.7</span>
<span class="co">#&gt; 2        1       3.02  24.0</span></code></pre></div>
<p>The difference between the two groups can be calculated with the function <a href="https://www.rdocumentation.org/packages/base/topics/diff">diff</a>, which calculates the difference between subsequent observations. This works as long as we are careful about which group is first or second.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">women <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(reserved) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">irrigation =</span> <span class="kw">mean</span>(irrigation),
            <span class="dt">water =</span> <span class="kw">mean</span>(water)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">diff_irrigation =</span> <span class="kw">diff</span>(irrigation),
            <span class="dt">diff_water =</span> <span class="kw">diff</span>(water))
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   diff_irrigation diff_water</span>
<span class="co">#&gt;             &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt; 1          -0.369       9.25</span></code></pre></div>
<p>The other way uses <strong>tidyr</strong> <a href="https://www.rdocumentation.org/packages/tidyr/topics/spread.lm">spread</a> and <a href="https://www.rdocumentation.org/packages/tidyr/topics/gather.lm">gather</a>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">women <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(reserved) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">irrigation =</span> <span class="kw">mean</span>(irrigation),
            <span class="dt">water =</span> <span class="kw">mean</span>(water)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>reserved) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(reserved, value) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> <span class="st">`</span><span class="dt">1</span><span class="st">`</span> <span class="op">-</span><span class="st"> `</span><span class="dt">0</span><span class="st">`</span>)
<span class="co">#&gt; # A tibble: 2 x 4</span>
<span class="co">#&gt;     variable   `0`   `1`   diff</span>
<span class="co">#&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 irrigation  3.39  3.02 -0.369</span>
<span class="co">#&gt; 2      water 14.74 23.99  9.252</span></code></pre></div>
<p>Now each row is an outcome variable of interest, and there are columns for the treatment (<code>1</code>) and control (<code>0</code>) groups, and the difference (<code>diff</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lm</span>(water <span class="op">~</span><span class="st"> </span>reserved, <span class="dt">data =</span> women)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = water ~ reserved, data = women)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)     reserved  </span>
<span class="co">#&gt;       14.74         9.25</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lm</span>(irrigation <span class="op">~</span><span class="st"> </span>reserved, <span class="dt">data =</span> women)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = irrigation ~ reserved, data = women)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)     reserved  </span>
<span class="co">#&gt;       3.388       -0.369</span></code></pre></div>
<div id="regression-with-multiple-predictors" class="section level3">
<h3><span class="header-section-number">4.5.1</span> Regression with multiple predictors</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;social&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)
<span class="kw">glimpse</span>(social)
<span class="co">#&gt; Observations: 305,866</span>
<span class="co">#&gt; Variables: 6</span>
<span class="co">#&gt; $ sex         &lt;chr&gt; &quot;male&quot;, &quot;female&quot;, &quot;male&quot;, &quot;female&quot;, &quot;female&quot;, &quot;mal...</span>
<span class="co">#&gt; $ yearofbirth &lt;int&gt; 1941, 1947, 1951, 1950, 1982, 1981, 1959, 1956, 19...</span>
<span class="co">#&gt; $ primary2004 &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0,...</span>
<span class="co">#&gt; $ messages    &lt;chr&gt; &quot;Civic Duty&quot;, &quot;Civic Duty&quot;, &quot;Hawthorne&quot;, &quot;Hawthorn...</span>
<span class="co">#&gt; $ primary2006 &lt;int&gt; 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1,...</span>
<span class="co">#&gt; $ hhsize      &lt;int&gt; 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, 1, 2, 2, 1, 2, 2, 1,...</span>
<span class="kw">levels</span>(social<span class="op">$</span>messages)
<span class="co">#&gt; NULL</span>
fit &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>messages, <span class="dt">data =</span> social)
fit
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2006 ~ messages, data = social)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;       (Intercept)    messagesControl  messagesHawthorne  </span>
<span class="co">#&gt;           0.31454           -0.01790            0.00784  </span>
<span class="co">#&gt; messagesNeighbors  </span>
<span class="co">#&gt;           0.06341</span></code></pre></div>
<p>Create indicator variables</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social &lt;-
<span class="st">  </span>social <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Control =</span> <span class="kw">as.integer</span>(messages <span class="op">==</span><span class="st"> &quot;Control&quot;</span>),
         <span class="dt">Hawthorne =</span> <span class="kw">as.integer</span>(messages <span class="op">==</span><span class="st"> &quot;Hawthorne&quot;</span>),
         <span class="dt">Neighbors =</span> <span class="kw">as.integer</span>(messages <span class="op">==</span><span class="st"> &quot;Neighbors&quot;</span>))</code></pre></div>
<p>alternatively, create these using a for loop. This is easier to understand and less prone to typo.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">unique</span>(social<span class="op">$</span>messages)) {
  social[[i]] &lt;-<span class="st"> </span><span class="kw">as.integer</span>(social[[<span class="st">&quot;messages&quot;</span>]] <span class="op">==</span><span class="st"> </span>i)
}</code></pre></div>
<p>We created a variable for each level of <code>messages</code> even though we will exclude one of them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>Control <span class="op">+</span><span class="st"> </span>Hawthorne <span class="op">+</span><span class="st"> </span>Neighbors, <span class="dt">data =</span> social)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2006 ~ Control + Hawthorne + Neighbors, data = social)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)      Control    Hawthorne    Neighbors  </span>
<span class="co">#&gt;     0.31454     -0.01790      0.00784      0.06341</span></code></pre></div>
<p>Create predictions for each unique value of <code>messages</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">unique_messages &lt;-
<span class="st">  </span><span class="kw">data_grid</span>(social, messages) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(fit)
unique_messages
<span class="co">#&gt; # A tibble: 4 x 2</span>
<span class="co">#&gt;     messages  pred</span>
<span class="co">#&gt;        &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Civic Duty 0.315</span>
<span class="co">#&gt; 2    Control 0.297</span>
<span class="co">#&gt; 3  Hawthorne 0.322</span>
<span class="co">#&gt; 4  Neighbors 0.378</span></code></pre></div>
<p>Compare to the sample averages</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(messages) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(primary2006))
<span class="co">#&gt; # A tibble: 4 x 2</span>
<span class="co">#&gt;     messages `mean(primary2006)`</span>
<span class="co">#&gt;        &lt;chr&gt;               &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Civic Duty               0.315</span>
<span class="co">#&gt; 2    Control               0.297</span>
<span class="co">#&gt; 3  Hawthorne               0.322</span>
<span class="co">#&gt; 4  Neighbors               0.378</span></code></pre></div>
<p>Linear regression without intercept.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.noint &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span><span class="op">-</span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>messages, <span class="dt">data =</span> social)
fit.noint
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2006 ~ -1 + messages, data = social)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; messagesCivic Duty     messagesControl   messagesHawthorne  </span>
<span class="co">#&gt;              0.315               0.297               0.322  </span>
<span class="co">#&gt;  messagesNeighbors  </span>
<span class="co">#&gt;              0.378</span></code></pre></div>
<p>Calculating the regression average effect is also easier if we make the control group the first level so all regression coefficients are comparisons to it. Use <a href="https://www.rdocumentation.org/packages/forcats/topics/fct_relevel">fct_relevel</a> to make “Control”</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.control &lt;-
<span class="st"> </span><span class="kw">mutate</span>(social, <span class="dt">messages =</span> <span class="kw">fct_relevel</span>(messages, <span class="st">&quot;Control&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>messages, <span class="dt">data =</span> .)
fit.control
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2006 ~ messages, data = .)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;        (Intercept)  messagesCivic Duty   messagesHawthorne  </span>
<span class="co">#&gt;             0.2966              0.0179              0.0257  </span>
<span class="co">#&gt;  messagesNeighbors  </span>
<span class="co">#&gt;             0.0813</span></code></pre></div>
<p>Difference in means</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(messages) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">primary2006 =</span> <span class="kw">mean</span>(primary2006)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Control =</span> primary2006[messages <span class="op">==</span><span class="st"> &quot;Control&quot;</span>],
         <span class="dt">diff =</span> primary2006 <span class="op">-</span><span class="st"> </span>Control)
<span class="co">#&gt; # A tibble: 4 x 4</span>
<span class="co">#&gt;     messages primary2006 Control   diff</span>
<span class="co">#&gt;        &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Civic Duty       0.315   0.297 0.0179</span>
<span class="co">#&gt; 2    Control       0.297   0.297 0.0000</span>
<span class="co">#&gt; 3  Hawthorne       0.322   0.297 0.0257</span>
<span class="co">#&gt; 4  Neighbors       0.378   0.297 0.0813</span></code></pre></div>
<p>Adjusted R-squared is included in the output of <code>broom::glance()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(fit)
<span class="co">#&gt;   r.squared adj.r.squared sigma statistic   p.value df  logLik    AIC</span>
<span class="co">#&gt; 1   0.00328       0.00327 0.463       336 1.06e-217  4 -198247 396504</span>
<span class="co">#&gt;      BIC deviance df.residual</span>
<span class="co">#&gt; 1 396557    65468      305862</span>
<span class="kw">glance</span>(fit)<span class="op">$</span>adj.r.squared
<span class="co">#&gt; [1] 0.00327</span></code></pre></div>
</div>
<div id="heterogeneous-treatment-effects" class="section level3">
<h3><span class="header-section-number">4.5.2</span> Heterogeneous Treatment Effects</h3>
<p>Average treatment effect (ate) among those who voted in 2004 primary</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ate &lt;-
<span class="st">  </span>social <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(primary2004, messages) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">primary2006 =</span> <span class="kw">mean</span>(primary2006)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(messages, primary2006) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ate_Neighbors =</span> Neighbors <span class="op">-</span><span class="st"> </span>Control) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(primary2004, Neighbors, Control, ate_Neighbors)
ate
<span class="co">#&gt; # A tibble: 2 x 4</span>
<span class="co">#&gt; # Groups:   primary2004 [2]</span>
<span class="co">#&gt;   primary2004 Neighbors Control ate_Neighbors</span>
<span class="co">#&gt;         &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt;         &lt;dbl&gt;</span>
<span class="co">#&gt; 1           0     0.306   0.237        0.0693</span>
<span class="co">#&gt; 2           1     0.482   0.386        0.0965</span></code></pre></div>
<p>Difference in ATE in 2004 voters and non-voters</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">diff</span>(ate<span class="op">$</span>ate_Neighbors)
<span class="co">#&gt; [1] 0.0272</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social.neighbor &lt;-<span class="st"> </span>social <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>( (messages <span class="op">==</span><span class="st"> &quot;Control&quot;</span>) <span class="op">|</span><span class="st"> </span>(messages <span class="op">==</span><span class="st"> &quot;Neighbors&quot;</span>))

fit.int &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>primary2004 <span class="op">+</span><span class="st"> </span>messages <span class="op">+</span><span class="st"> </span>primary2004<span class="op">:</span>messages,
              <span class="dt">data =</span> social.neighbor)
fit.int
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2006 ~ primary2004 + messages + primary2004:messages, </span>
<span class="co">#&gt;     data = social.neighbor)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                   (Intercept)                    primary2004  </span>
<span class="co">#&gt;                        0.2371                         0.1487  </span>
<span class="co">#&gt;             messagesNeighbors  primary2004:messagesNeighbors  </span>
<span class="co">#&gt;                        0.0693                         0.0272</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>primary2004 <span class="op">*</span><span class="st"> </span>messages, <span class="dt">data =</span> social.neighbor)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2006 ~ primary2004 * messages, data = social.neighbor)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                   (Intercept)                    primary2004  </span>
<span class="co">#&gt;                        0.2371                         0.1487  </span>
<span class="co">#&gt;             messagesNeighbors  primary2004:messagesNeighbors  </span>
<span class="co">#&gt;                        0.0693                         0.0272</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social.neighbor &lt;-
<span class="st">  </span>social.neighbor <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> <span class="dv">2008</span> <span class="op">-</span><span class="st"> </span>yearofbirth)

<span class="kw">summary</span>(social.neighbor<span class="op">$</span>age)
<span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">#&gt;    22.0    43.0    52.0    51.8    61.0   108.0</span>

fit.age &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>age <span class="op">*</span><span class="st"> </span>messages, <span class="dt">data =</span> social.neighbor)
fit.age
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2006 ~ age * messages, data = social.neighbor)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;           (Intercept)                    age      messagesNeighbors  </span>
<span class="co">#&gt;              0.089477               0.003998               0.048573  </span>
<span class="co">#&gt; age:messagesNeighbors  </span>
<span class="co">#&gt;              0.000628</span></code></pre></div>
<p>Calculate average treatment effects</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ate.age &lt;-
<span class="st">  </span><span class="kw">crossing</span>(<span class="dt">age =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">25</span>, <span class="dt">to =</span> <span class="dv">85</span>, <span class="dt">by =</span> <span class="dv">20</span>),
         <span class="dt">messages =</span> <span class="kw">c</span>(<span class="st">&quot;Neighbors&quot;</span>, <span class="st">&quot;Control&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(fit.age) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(messages, pred) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> Neighbors <span class="op">-</span><span class="st"> </span>Control)
ate.age
<span class="co">#&gt; # A tibble: 4 x 4</span>
<span class="co">#&gt;     age Control Neighbors   diff</span>
<span class="co">#&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1    25   0.189     0.254 0.0643</span>
<span class="co">#&gt; 2    45   0.269     0.346 0.0768</span>
<span class="co">#&gt; 3    65   0.349     0.439 0.0894</span>
<span class="co">#&gt; 4    85   0.429     0.531 0.1020</span></code></pre></div>
<p>You can use <a href="https://www.rdocumentation.org/packages/base/topics/poly">poly</a> function to calculate polynomials instead of adding each term, <code>age + I(age ^ 2)</code>. Though note that the coefficients will be be different since by default <code>poly</code> calculates orthogonal polynomials instead of the natural (raw) polynomials. However, you really shouldn’t interpret the coefficients directly anyways, so this should matter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.age2 &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span><span class="kw">poly</span>(age, <span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>messages,
               <span class="dt">data =</span> social.neighbor)
fit.age2
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2006 ~ poly(age, 2) * messages, data = social.neighbor)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                     (Intercept)                    poly(age, 2)1  </span>
<span class="co">#&gt;                          0.2966                          27.6665  </span>
<span class="co">#&gt;                   poly(age, 2)2                messagesNeighbors  </span>
<span class="co">#&gt;                        -10.2832                           0.0816  </span>
<span class="co">#&gt; poly(age, 2)1:messagesNeighbors  poly(age, 2)2:messagesNeighbors  </span>
<span class="co">#&gt;                          4.5820                          -5.5124</span></code></pre></div>
<p>Create a data frame of combinations of ages and messages using <a href="https://www.rdocumentation.org/packages/modelr/topics/data_grid">data_grid</a>, which means that we only need to specify the variables, and not the specific values,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">y.hat &lt;-
<span class="st">  </span><span class="kw">data_grid</span>(social.neighbor, age, messages) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(fit.age2)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(y.hat, <span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> pred,
                  <span class="dt">colour =</span> <span class="kw">str_c</span>(messages, <span class="st">&quot; condition&quot;</span>))) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">colour =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;predicted turnout rates&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-78-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">y.hat <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(messages, pred) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ate =</span> Neighbors <span class="op">-</span><span class="st"> </span>Control) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(age <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>, age <span class="op">&lt;</span><span class="st"> </span><span class="dv">90</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> ate)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;estimated average treatment effect&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.1</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-79-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="regression-discontinuity-design" class="section level2">
<h2><span class="header-section-number">4.6</span> Regression Discontinuity Design</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;MPs&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)

MPs_labour &lt;-<span class="st"> </span><span class="kw">filter</span>(MPs, party <span class="op">==</span><span class="st"> &quot;labour&quot;</span>)
MPs_tory &lt;-<span class="st"> </span><span class="kw">filter</span>(MPs, party <span class="op">==</span><span class="st"> &quot;tory&quot;</span>)

labour_fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin,
                 <span class="dt">data =</span> <span class="kw">filter</span>(MPs_labour, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>))
labour_fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin, MPs_labour, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)

tory_fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin,
                <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>))
tory_fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</code></pre></div>
<p>Use to generate a grid for predictions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">y1_labour &lt;-
<span class="st">  </span><span class="kw">filter</span>(MPs_labour, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">data_grid</span>(margin) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(labour_fit1)
y2_labour &lt;-
<span class="st">  </span><span class="kw">filter</span>(MPs_labour, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">data_grid</span>(margin) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(labour_fit2)

y1_tory &lt;-
<span class="st">  </span><span class="kw">filter</span>(MPs_tory, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">data_grid</span>(margin) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(tory_fit1)

y2_tory &lt;-
<span class="st">  </span><span class="kw">filter</span>(MPs_tory, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">data_grid</span>(margin) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(tory_fit2)</code></pre></div>
<p>Tory politicians</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> MPs_tory,
             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> ln.net)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> y1_tory,
            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> pred), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="fl">1.5</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> y2_tory,
            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> pred), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="fl">1.5</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;margin of victory&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;log net wealth at death&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;labour&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-82-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We can actually produce this plot easily without running the regressions, by using <code>geom_smooth</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">mutate</span>(MPs, <span class="dt">winner =</span> (margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)),
       <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> ln.net)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> lm, <span class="dt">se =</span> <span class="ot">FALSE</span>, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">group =</span> winner)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(party <span class="op">~</span><span class="st"> </span>.) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;margin of victory&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;log net wealth at death&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-83-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In the previous code, I didn’t directly compute the the average net wealth at 0, so I’ll need to do that here. I’ll use <a href="https://www.rdocumentation.org/packages/modelr/topics/gather_predictions">gather_predictions</a> to add predictions for multiple models:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">spread_predictions</span>(<span class="kw">data_frame</span>(<span class="dt">margin =</span> <span class="dv">0</span>),
                   tory_fit1, tory_fit2) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rd_est =</span> tory_fit2 <span class="op">-</span><span class="st"> </span>tory_fit1)
<span class="co">#&gt; # A tibble: 1 x 4</span>
<span class="co">#&gt;   margin tory_fit1 tory_fit2 rd_est</span>
<span class="co">#&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1      0      12.5      13.2   0.65</span></code></pre></div>
<p><strong>Tidyverse:</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tory_fit3 &lt;-<span class="st"> </span><span class="kw">lm</span>(margin.pre <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>))
tory_fit4 &lt;-<span class="st"> </span><span class="kw">lm</span>(margin.pre <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))

(<span class="kw">filter</span>(<span class="kw">tidy</span>(tory_fit3), term <span class="op">==</span><span class="st"> &quot;(Intercept)&quot;</span>)[[<span class="st">&quot;estimate&quot;</span>]] <span class="op">-</span>
<span class="st"> </span><span class="kw">filter</span>(<span class="kw">tidy</span>(tory_fit4), term <span class="op">==</span><span class="st"> &quot;(Intercept)&quot;</span>)[[<span class="st">&quot;estimate&quot;</span>]])
<span class="co">#&gt; [1] 0.0173</span></code></pre></div>

</div>
<div id="spatial-data" class="section level2">
<h2><span class="header-section-number">4.7</span> Spatial Data</h2>
<p>Some resources on plotting spatial data in R:</p>
<ul>
<li><p><a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> has several map-related functions</p></li>
<li><a href="http://docs.ggplot2.org/current/borders.html">borders</a></li>
<li><a href="http://docs.ggplot2.org/current/fortify.map.html">fortify.map</a></li>
<li><p><a href="http://docs.ggplot2.org/current/map_data.html">map_data</a></p></li>
<li><p><a href="https://cran.r-project.org/package=ggmap">ggmap</a> allows ggplot to us a map from Google Maps, OpenStreet Maps or similar as a background for the plot.</p></li>
<li>David Kahle and Hadley Wickham. 2013. <a href="https://journal.r-project.org/archive/2013-1/kahle-wickham.pdf">ggmap: Spatial Visualization with ggplot2</a>. <em>Journal of Statistical Software</em></li>
<li><p>Github <a href="https://github.com/dkahle/ggmap">dkahle/ggmamp</a></p></li>
<li><a href="https://cran.r-project.org/package=tmap">tmap</a> is not built on ggplot2 but uses a ggplot2-like API for network data.</li>
<li><p><a href="https://cran.r-project.org/package=leaflet">leaflet</a> is an R interface to a popular javascript mapping library.</p></li>
</ul>
<p>Here are few tutorials on plotting spatial data in ggplot2:</p>
<ul>
<li><a href="http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html">Making Maps with R</a></li>
<li><a href="https://www.r-bloggers.com/r-beginners-plotting-locations-on-to-a-world-map/">Plotting Data on a World Map</a></li>
<li><a href="https://rpubs.com/m_dev/Intro-to-Spatial-Data-and-ggplot2">Introduction to Spatial Data and ggplot2</a></li>
</ul>
<div id="prerequisites-4" class="section level3 unnumbered">
<h3>Prerequisites</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;modelr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggrepel&quot;</span>)</code></pre></div>
</div>
<div id="spatial-data-in-r" class="section level3">
<h3><span class="header-section-number">4.7.1</span> Spatial Data in R</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;us.cities&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;maps&quot;</span>)
<span class="kw">glimpse</span>(us.cities)
<span class="co">#&gt; Observations: 1,005</span>
<span class="co">#&gt; Variables: 6</span>
<span class="co">#&gt; $ name        &lt;chr&gt; &quot;Abilene TX&quot;, &quot;Akron OH&quot;, &quot;Alameda CA&quot;, &quot;Albany GA...</span>
<span class="co">#&gt; $ country.etc &lt;chr&gt; &quot;TX&quot;, &quot;OH&quot;, &quot;CA&quot;, &quot;GA&quot;, &quot;NY&quot;, &quot;OR&quot;, &quot;NM&quot;, &quot;LA&quot;, &quot;V...</span>
<span class="co">#&gt; $ pop         &lt;int&gt; 113888, 206634, 70069, 75510, 93576, 45535, 494962...</span>
<span class="co">#&gt; $ lat         &lt;dbl&gt; 32.5, 41.1, 37.8, 31.6, 42.7, 44.6, 35.1, 31.3, 38...</span>
<span class="co">#&gt; $ long        &lt;dbl&gt; -99.7, -81.5, -122.3, -84.2, -73.8, -123.1, -106.6...</span>
<span class="co">#&gt; $ capital     &lt;int&gt; 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">usa_map &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;usa&quot;</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: &#39;maps&#39;</span>
<span class="co">#&gt; The following object is masked from &#39;package:purrr&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     map</span>
capitals &lt;-<span class="st"> </span><span class="kw">filter</span>(us.cities,
                   capital <span class="op">==</span><span class="st"> </span><span class="dv">2</span>,
                   <span class="op">!</span>country.etc <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;HI&quot;</span>, <span class="st">&quot;AK&quot;</span>))
<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_map</span>(<span class="dt">map =</span> usa_map) <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;usa&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">size =</span> pop),
             <span class="dt">data =</span> capitals) <span class="op">+</span>
<span class="st">  </span><span class="co"># scale size area ensures: 0 = no area</span>
<span class="st">  </span><span class="kw">scale_size_area</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>, <span class="dt">title =</span> <span class="st">&quot;US State Capitals&quot;</span>,
       <span class="dt">size =</span> <span class="st">&quot;Population&quot;</span>)</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-4-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cal_cities &lt;-<span class="st"> </span><span class="kw">filter</span>(us.cities, country.etc <span class="op">==</span><span class="st"> &quot;CA&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">7</span>, pop)

<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> <span class="st">&quot;California&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat), <span class="dt">data =</span> cal_cities) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">label =</span> name), <span class="dt">data =</span> cal_cities) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-5-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="colors-in-r" class="section level3">
<h3><span class="header-section-number">4.7.2</span> Colors in R</h3>
<p>For more resources on using colors in R</p>
<ul>
<li><code>R4DS</code> chapter <a href="http://r4ds.had.co.nz/graphics-for-communication.html#replacing-a-scale">Graphics for Communication</a></li>
<li>ggplot2 book Chapter “Scales”</li>
<li>Jenny Bryan <a href="https://www.stat.ubc.ca/~jenny/STAT545A/block14_colors.html">Using colors in R</a></li>
<li>Achim Zeileis, Kurt Hornik, Paul Murrell (2009). Escaping RGBland: Selecting Colors for Statistical Graphics. Computational Statistics &amp; Data Analysis <a href="http://dx.doi.org/10.1016/j.csda.2008.11.033">DOI</a></li>
<li><a href="https://cran.r-project.org/web/packages/colorspace/vignettes/hcl-colors.pdf">colorspace vignette</a></li>
<li>Maureen Stone <a href="https://www.perceptualedge.com/articles/b-eye/choosing_colors.pdf">Choosing Colors for Data Visualization</a></li>
<li><a href="http://colorbrewer2.org">ColorBrewer</a> A website with a variety of palettes, primarily designed for maps, but also useful in data viz.</li>
<li>Stephen Few <a href="http://www.perceptualedge.com/articles/visual_business_intelligence/rules_for_using_color.pdf">Practical Rules for Using Color in Charts</a></li>
<li><a href="http://www.research.ibm.com/people/l/lloydt/color/color.HTM">Why Should Engineers and Scientists by Worried About Color?</a></li>
<li><a href="https://www.youtube.com/watch?v=xAoljeRJ3lU">A Better Default Colormap for Matplotlib</a> A SciPy 2015 talk that describes how the <a href="https://cran.r-project.org/package=viridis">viridis</a> was created.</li>
<li><a href="http://www.eecs.harvard.edu/~kgajos/papers/2011/borkin11-infoviz.pdf">Evaluation of Artery Visualizations for Heart Disease Diagnosis</a> Using the wrong color scale can be deadly … literally.</li>
<li>The python package matplotlib has a good discussion of <a href="http://matplotlib.org/users/colormaps.html">colormaps</a>.</li>
<li>Peter Kovesi <a href="https://arxiv.org/pdf/1509.03700v1.pdf">Good Color Maps: How to Design Them</a>.</li>
<li>See the <a href="https://cran.r-project.org/package=viridis">viridis</a>, <a href="https://cran.r-project.org/package=ggthemes">ggthemes</a>, <a href="https://cran.r-project.org/package=dichromat">dichromat</a>, and <a href="https://cran.r-project.org/package=pals">pals</a> packages for color palettes.</li>
</ul>
<p>Use <a href="http://docs.ggplot2.org/current/scale_identity.html">scale_identity</a> for the color and alpha scales since the values of the variables are the values of the scale itself (the color names, and the alpha values).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">each =</span> <span class="dv">2</span>),
              <span class="dt">y =</span> x <span class="op">+</span><span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">times =</span> <span class="dv">2</span>),
              <span class="dt">colour =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>), <span class="dt">each =</span> <span class="dv">4</span>),
              <span class="dt">alpha =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>)),
  <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">colour =</span> colour, <span class="dt">alpha =</span> alpha)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">15</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_alpha_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-6-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="united-states-presidential-elections" class="section level3">
<h3><span class="header-section-number">4.7.3</span> United States Presidential Elections</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;pres08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)

pres08 &lt;-<span class="st"> </span>pres08 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Dem =</span> Obama <span class="op">/</span><span class="st"> </span>(Obama <span class="op">+</span><span class="st"> </span>McCain),
         <span class="dt">Rep =</span> McCain <span class="op">/</span><span class="st"> </span>(Obama <span class="op">+</span><span class="st"> </span>McCain))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> <span class="st">&quot;California&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>()</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-8-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cal_color &lt;-<span class="st"> </span><span class="kw">filter</span>(pres08, state <span class="op">==</span><span class="st"> &quot;CA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>{
    <span class="kw">rgb</span>(<span class="dt">red =</span> .<span class="op">$</span>Rep, <span class="dt">green =</span> <span class="dv">0</span>, <span class="dt">blue =</span> .<span class="op">$</span>Dem)
  }

<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> <span class="st">&quot;California&quot;</span>, <span class="dt">fill =</span> cal_color) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>()</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-9-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># America as red and blue states</span>
<span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="co"># create a map</span>
<span class="cf">for</span> (i  <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(pres08)) {
    <span class="cf">if</span> ( (pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;HI&quot;</span>) <span class="op">&amp;</span><span class="st"> </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;AK&quot;</span>) <span class="op">&amp;</span>
<span class="st">        </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;DC&quot;</span>)) {
        <span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> pres08<span class="op">$</span>state.name[i],
            <span class="dt">col =</span> <span class="kw">ifelse</span>(pres08<span class="op">$</span>Rep[i] <span class="op">&gt;</span><span class="st"> </span>pres08<span class="op">$</span>Dem[i], <span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>),
            <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
    }
}

## America as purple states
<span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="co"># create a map</span>
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(pres08)) {
    <span class="cf">if</span> ( (pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;HI&quot;</span>) <span class="op">&amp;</span><span class="st"> </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;AK&quot;</span>) <span class="op">&amp;</span>
<span class="st">        </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;DC&quot;</span>)) {
        <span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> pres08<span class="op">$</span>state.name[i],
            <span class="dt">col =</span> <span class="kw">rgb</span>(<span class="dt">red =</span> pres08<span class="op">$</span>Rep[i], <span class="dt">blue =</span> pres08<span class="op">$</span>Dem[i],
               <span class="dt">green =</span> <span class="dv">0</span>), <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
    }
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">states &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;state&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw">mutate</span>(pres08, <span class="dt">state.name =</span> <span class="kw">str_to_lower</span>(state.name)),
            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;region&quot;</span> =<span class="st"> &quot;state.name&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># drops DC</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(EV)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">party =</span> <span class="kw">if_else</span>(Dem <span class="op">&gt;</span><span class="st"> </span>Rep, <span class="st">&quot;Dem&quot;</span>, <span class="st">&quot;Rep&quot;</span>),
         <span class="dt">color =</span> <span class="kw">map2_chr</span>(Dem, Rep, <span class="op">~</span><span class="st"> </span><span class="kw">rgb</span>(<span class="dt">blue =</span> .x, <span class="dt">red =</span> .y, <span class="dt">green =</span> <span class="dv">0</span>)))

<span class="kw">ggplot</span>(states) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> long, <span class="dt">y =</span> lat,
                   <span class="dt">fill =</span> party)) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Rep&quot;</span> =<span class="st"> &quot;red&quot;</span>, <span class="st">&quot;Dem&quot;</span> =<span class="st"> &quot;blue&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-11-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>For plotting the purple states, I use since the <code>color</code> column contains the RGB values to use in the plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(states) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> long, <span class="dt">y =</span> lat,
                   <span class="dt">fill =</span> color)) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-12-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>However, plotting purple states is not a good data visualization. Even though the colors are a proportional mixture of red and blue, human visual perception doesn’t work that way.</p>
<p>The proportion of the democratic vote is best thought of a diverging scale with 0.5 is midpoint. And since the Democratic Party is associated with the color blue and the Republican Party is associated with the color red. The Color Brewer palette <a href="http://colorbrewer2.org/#type=diverging&amp;scheme=RdBu&amp;n=11">RdBu</a> is an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(states) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">fill =</span> Dem)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_distiller</span>(<span class="st">&quot;% Obama&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">type =</span> <span class="st">&quot;div&quot;</span>,
                       <span class="dt">palette =</span> <span class="st">&quot;RdBu&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-13-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="expansion-of-walmart" class="section level3">
<h3><span class="header-section-number">4.7.4</span> Expansion of Walmart</h3>
<p>We don’t need to do the direct mapping since</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;walmart&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)

<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">colour =</span> type, <span class="dt">size =</span> size),
             <span class="dt">data =</span> <span class="kw">mutate</span>(walmart,
                           <span class="dt">size =</span> <span class="kw">if_else</span>(type <span class="op">==</span><span class="st"> &quot;DistributionCenter&quot;</span>, <span class="dv">2</span>, <span class="dv">1</span>)),
             <span class="dt">alpha =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_size_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>))) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>()</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-14-1.png" width="70%" style="display: block; margin: auto;" /> We don’t need to worry about colors since <code>ggplot</code> handles that. I use <a href="http://docs.ggplot2.org/current/guides.html">guides</a> to so that the colors or not transparent in the legend (see <em>R for Data Science</em> chapter<a href="http://r4ds.had.co.nz/graphics-for-communication.html">Graphics for communication</a>).</p>
<p>To make a plot showing all Walmart stores opened up through that year, I write a function, that takes the year and dataset as parameters.</p>
<p>Since I am calling the function for its side effect (printing the plot) rather than the value it returns, I use the <a href="https://www.rdocumentation.org/packages/purrr/topics/walk">walk</a> function rather than <a href="https://www.rdocumentation.org/packages/purrr/topics/map">map</a>. See <a href="http://r4ds.had.co.nz/">R for Data Science</a>, <a href="http://r4ds.had.co.nz/iteration.html#walk">Chapter 21.8: Walk</a> for more information.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">map_walmart &lt;-<span class="st"> </span><span class="cf">function</span>(year, .data) {
  .data &lt;-<span class="st"> </span><span class="kw">filter</span>(.data, opendate <span class="op">&lt;</span><span class="st"> </span><span class="kw">make_date</span>(year, <span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">size =</span> <span class="kw">if_else</span>(type <span class="op">==</span><span class="st"> &quot;DistributionCenter&quot;</span>, <span class="dv">2</span>, <span class="dv">1</span>))
  <span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">colour =</span> type, <span class="dt">size =</span> size),
               <span class="dt">data =</span> .data, <span class="dt">alpha =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_size_identity</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">guides</span>(<span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>))) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">ggtitle</span>(year)
}

years &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1975</span>, <span class="dv">1985</span>, <span class="dv">1995</span>, <span class="dv">2005</span>)
<span class="kw">walk</span>(years, <span class="op">~</span><span class="st"> </span><span class="kw">print</span>(<span class="kw">map_walmart</span>(.x, walmart)))</code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-15-1.png" width="70%" style="display: block; margin: auto;" /><img src="discovery_files/figure-html/unnamed-chunk-15-2.png" width="70%" style="display: block; margin: auto;" /><img src="discovery_files/figure-html/unnamed-chunk-15-3.png" width="70%" style="display: block; margin: auto;" /><img src="discovery_files/figure-html/unnamed-chunk-15-4.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="animation-in-r" class="section level3">
<h3><span class="header-section-number">4.7.5</span> Animation in R</h3>
<p>For easy animation with <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a>, use the <a href="https://github.com/dgrtwo/gganimate">gganimate</a> package. Note that the <strong>gganimate</strong> package is not on CRAN, so you have to install it with the <a href="https://cran.r-project.org/package=devtools">devtools</a> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;cowplot&quot;</span>)
devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;dgrtwo/animate&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;gganimate&quot;</span>)</code></pre></div>
<p>An animation is a series of frames. The <a href="https://cran.r-project.org/package=gganimate">gganimate</a> package works by adding a <code>frame</code> aesthetic to ggplots, and function will animate the plot.</p>
<p>I use <code>frame = year(opendate)</code> to have the animation use each year as a frame, and <code>cumulative = TRUE</code> so that the previous years are shown.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">walmart_animated &lt;-
<span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat,
                   <span class="dt">colour =</span> type,
                   <span class="dt">fill =</span> type,
                   <span class="dt">frame =</span> <span class="kw">year</span>(opendate),
                   <span class="dt">cumulative =</span> <span class="ot">TRUE</span>),
               <span class="dt">data =</span> walmart) <span class="op">+</span>
<span class="st">    </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">theme_void</span>()
<span class="kw">gganimate</span>(walmart_animated)</code></pre></div>
<div class="figure">
<img src="discovery_files/figure-html/unnamed-chunk-18-.gif" alt="unnamed-chunk-18" />
<p class="caption">unnamed-chunk-18</p>
</div>

</div>
</div>
<div id="textual-data" class="section level2">
<h2><span class="header-section-number">4.8</span> Textual data</h2>
<div id="prerequisites-5" class="section level3 unnumbered">
<h3>Prerequisites</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;modelr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;tm&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;SnowballC&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;tidytext&quot;</span>)</code></pre></div>
<p>This section will primarily use the <a href="https://cran.r-project.org/package=tidytext">tidytext</a> package. It is a relatively new package. The <a href="https://cran.r-project.org/package=tm">tm</a> and <a href="https://cran.r-project.org/package=quanteda">quanteda</a> (by Ken Benoit) packages are more established and use the document-term matrix format as described in the QSS chapter. The <strong>tidytext</strong> package stores everything in a data frame; this may be less efficient than the other packages, but has the benefit of being able to easily take advantage of the tidyverse ecosystem. If your corpus is not too large, this shouldn’t be an issue.</p>
<p>See <a href="http://tidytextmining.com/">Tidy Text Mining with R</a> for a full introduction to using <strong>tidytext</strong>.</p>
<p>In tidy data, each row is an observation and each column is a variable. In the <strong>tidytext</strong> package, documents are stored as data frames with <strong>one-term-per-row</strong>.</p>
<p>We can cast data into the <strong>tidytext</strong> format either from the <code>Corpus</code> object, or, after processing, from the document-term matrix object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DIR_SOURCE &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">&quot;qss&quot;</span>, <span class="st">&quot;DISCOVERY&quot;</span>, <span class="st">&quot;federalist&quot;</span>)
corpus_raw &lt;-<span class="st"> </span><span class="kw">VCorpus</span>(<span class="kw">DirSource</span>(<span class="dt">directory =</span> DIR_SOURCE, <span class="dt">pattern =</span> <span class="st">&quot;fp&quot;</span>))
corpus_raw
<span class="co">#&gt; &lt;&lt;VCorpus&gt;&gt;</span>
<span class="co">#&gt; Metadata:  corpus specific: 0, document level (indexed): 0</span>
<span class="co">#&gt; Content:  documents: 85</span></code></pre></div>
<p>Use the function <a href="https://www.rdocumentation.org/packages/tidyytext/topics/tidy.Corpus">tidy</a> to convert the to a data frame with one row per document.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">corpus_tidy &lt;-<span class="st"> </span><span class="kw">tidy</span>(corpus_raw, <span class="st">&quot;corpus&quot;</span>)
corpus_tidy
<span class="co">#&gt; # A tibble: 85 x 8</span>
<span class="co">#&gt;   author       datetimestamp description heading       id language origin</span>
<span class="co">#&gt;    &lt;lgl&gt;              &lt;dttm&gt;       &lt;lgl&gt;   &lt;lgl&gt;    &lt;chr&gt;    &lt;chr&gt;  &lt;lgl&gt;</span>
<span class="co">#&gt; 1     NA 2017-12-25 20:58:48          NA      NA fp01.txt       en     NA</span>
<span class="co">#&gt; 2     NA 2017-12-25 20:58:48          NA      NA fp02.txt       en     NA</span>
<span class="co">#&gt; 3     NA 2017-12-25 20:58:48          NA      NA fp03.txt       en     NA</span>
<span class="co">#&gt; 4     NA 2017-12-25 20:58:48          NA      NA fp04.txt       en     NA</span>
<span class="co">#&gt; 5     NA 2017-12-25 20:58:48          NA      NA fp05.txt       en     NA</span>
<span class="co">#&gt; 6     NA 2017-12-25 20:58:48          NA      NA fp06.txt       en     NA</span>
<span class="co">#&gt; # ... with 79 more rows, and 1 more variables: text &lt;chr&gt;</span></code></pre></div>
<p>The <code>text</code> column contains the text of the documents themselves. Since most of the metadata columns are either missings or irrelevant for our purposes, we’ll delete those columns, keeping only the document (<code>id</code>) and <code>text</code> columns.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">corpus_tidy &lt;-<span class="st"> </span><span class="kw">select</span>(corpus_tidy, id, text)</code></pre></div>
<p>Also, we want to extract the essay number and use that as the document id rather than its file name.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">corpus_tidy &lt;-
<span class="st">  </span><span class="kw">mutate</span>(corpus_tidy, <span class="dt">document =</span> <span class="kw">as.integer</span>(<span class="kw">str_extract</span>(id, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">d+&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>id)</code></pre></div>
<p>The function tokenizes the document texts:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tokens &lt;-<span class="st"> </span>corpus_tidy <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># tokenizes into words and stems them</span>
<span class="st">  </span><span class="kw">unnest_tokens</span>(word, text, <span class="dt">token =</span> <span class="st">&quot;word_stems&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># remove any numbers in the strings</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">word =</span> <span class="kw">str_replace_all</span>(word, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">d+&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># drop any empty strings</span>
<span class="st">  </span><span class="kw">filter</span>(word <span class="op">!=</span><span class="st"> &quot;&quot;</span>)
tokens
<span class="co">#&gt; # A tibble: 202,089 x 2</span>
<span class="co">#&gt;   document      word</span>
<span class="co">#&gt;      &lt;int&gt;     &lt;chr&gt;</span>
<span class="co">#&gt; 1        1     after</span>
<span class="co">#&gt; 2        1        an</span>
<span class="co">#&gt; 3        1 unequivoc</span>
<span class="co">#&gt; 4        1    experi</span>
<span class="co">#&gt; 5        1        of</span>
<span class="co">#&gt; 6        1       the</span>
<span class="co">#&gt; # ... with 2.021e+05 more rows</span></code></pre></div>
<p>The <code>unnest_tokens</code> function uses the <a href="https://cran.r-project.org/package=tokenizers">tokenizers</a> package to tokenize the text. By default, it uses the function which removes punctuation, and lowercases the words. I set the tokenizer to to stem the word, using the <a href="https://cran.r-project.org/package=SnowballC">SnowballC</a> package.</p>
<p>We can remove stop-words with an <a href="https://www.rdocumentation.org/packages/dplyr/topics/anti_join">anti_join</a> on the dataset <a href="https://www.rdocumentation.org/packages/tidytext/topics/stop_words">stop_words</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;stop_words&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;tidytext&quot;</span>)
tokens &lt;-<span class="st"> </span><span class="kw">anti_join</span>(tokens, stop_words, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>)</code></pre></div>
</div>
<div id="document-term-matrix" class="section level3">
<h3><span class="header-section-number">4.8.1</span> Document-Term Matrix</h3>
<p>In <code>tokens</code> there is one observation for each token (word) in the each document. This is almost equivalent to a document-term matrix. For a document-term matrix we need documents, and terms as the keys for the data and a column with the number of times the term appeared in the document.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dtm &lt;-<span class="st"> </span><span class="kw">count</span>(tokens, document, word)
<span class="kw">head</span>(dtm)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt;   document       word     n</span>
<span class="co">#&gt;      &lt;int&gt;      &lt;chr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1        1        abl     1</span>
<span class="co">#&gt; 2        1     absurd     1</span>
<span class="co">#&gt; 3        1      accid     1</span>
<span class="co">#&gt; 4        1     accord     1</span>
<span class="co">#&gt; 5        1 acknowledg     1</span>
<span class="co">#&gt; 6        1        act     1</span></code></pre></div>
</div>
<div id="topic-discovery" class="section level3">
<h3><span class="header-section-number">4.8.2</span> Topic Discovery</h3>
<p>Plot the word-clouds for essays 12 and 24:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;wordcloud&quot;</span>)
<span class="kw">filter</span>(dtm, document <span class="op">==</span><span class="st"> </span><span class="dv">12</span>) <span class="op">%&gt;%</span><span class="st"> </span>{
    <span class="kw">wordcloud</span>(.<span class="op">$</span>word, .<span class="op">$</span>n, <span class="dt">max.words =</span> <span class="dv">20</span>)
  }</code></pre></div>
<p><img src="discovery-textual_files/figure-html/unnamed-chunk-10-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(dtm, document <span class="op">==</span><span class="st"> </span><span class="dv">24</span>) <span class="op">%&gt;%</span><span class="st"> </span>{
    <span class="kw">wordcloud</span>(.<span class="op">$</span>word, .<span class="op">$</span>n, <span class="dt">max.words =</span> <span class="dv">20</span>)
  }</code></pre></div>
<p><img src="discovery-textual_files/figure-html/unnamed-chunk-11-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Use the function <a href="https://www.rdocumentation.org/packages/tidytext/topics/bind_tf_idf">bind_tf_idf</a> to add a column with the tf-idf to the data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dtm &lt;-<span class="st"> </span><span class="kw">bind_tf_idf</span>(dtm, word, document, n)
dtm
<span class="co">#&gt; # A tibble: 38,847 x 6</span>
<span class="co">#&gt;   document       word     n      tf   idf   tf_idf</span>
<span class="co">#&gt;      &lt;int&gt;      &lt;chr&gt; &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1        1        abl     1 0.00145 0.705 0.001022</span>
<span class="co">#&gt; 2        1     absurd     1 0.00145 1.735 0.002514</span>
<span class="co">#&gt; 3        1      accid     1 0.00145 3.750 0.005434</span>
<span class="co">#&gt; 4        1     accord     1 0.00145 0.754 0.001092</span>
<span class="co">#&gt; 5        1 acknowledg     1 0.00145 1.552 0.002250</span>
<span class="co">#&gt; 6        1        act     1 0.00145 0.400 0.000579</span>
<span class="co">#&gt; # ... with 3.884e+04 more rows</span></code></pre></div>
<p>The 10 most important words for Paper No. 12 are</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dtm <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(document <span class="op">==</span><span class="st"> </span><span class="dv">12</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, tf_idf)
<span class="co">#&gt; # A tibble: 10 x 6</span>
<span class="co">#&gt;   document       word     n      tf   idf  tf_idf</span>
<span class="co">#&gt;      &lt;int&gt;      &lt;chr&gt; &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1       12       cent     2 0.00199  4.44 0.00884</span>
<span class="co">#&gt; 2       12      coast     3 0.00299  3.75 0.01119</span>
<span class="co">#&gt; 3       12    commerc     8 0.00796  1.11 0.00884</span>
<span class="co">#&gt; 4       12 contraband     3 0.00299  4.44 0.01326</span>
<span class="co">#&gt; 5       12      excis     5 0.00498  2.65 0.01319</span>
<span class="co">#&gt; 6       12     gallon     2 0.00199  4.44 0.00884</span>
<span class="co">#&gt; # ... with 4 more rows</span></code></pre></div>
<p>and for Paper No. 24,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dtm <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(document <span class="op">==</span><span class="st"> </span><span class="dv">24</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, tf_idf)
<span class="co">#&gt; # A tibble: 10 x 6</span>
<span class="co">#&gt;   document     word     n      tf   idf  tf_idf</span>
<span class="co">#&gt;      &lt;int&gt;    &lt;chr&gt; &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1       24     armi     7 0.00858  1.26 0.01085</span>
<span class="co">#&gt; 2       24  arsenal     2 0.00245  3.75 0.00919</span>
<span class="co">#&gt; 3       24     dock     3 0.00368  4.44 0.01633</span>
<span class="co">#&gt; 4       24 frontier     3 0.00368  2.83 0.01042</span>
<span class="co">#&gt; 5       24 garrison     6 0.00735  2.83 0.02083</span>
<span class="co">#&gt; 6       24   nearer     2 0.00245  3.34 0.00820</span>
<span class="co">#&gt; # ... with 4 more rows</span></code></pre></div>
<p>The slightly different results from the book are due to tokenization differences.</p>
<p>Subset those documents known to have been written by Hamilton.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">HAMILTON_ESSAYS &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">6</span><span class="op">:</span><span class="dv">9</span>, <span class="dv">11</span><span class="op">:</span><span class="dv">13</span>, <span class="dv">15</span><span class="op">:</span><span class="dv">17</span>, <span class="dv">21</span><span class="op">:</span><span class="dv">36</span>, <span class="dv">59</span><span class="op">:</span><span class="dv">61</span>, <span class="dv">65</span><span class="op">:</span><span class="dv">85</span>)
dtm_hamilton &lt;-<span class="st"> </span><span class="kw">filter</span>(dtm, document <span class="op">%in%</span><span class="st"> </span>HAMILTON_ESSAYS)</code></pre></div>
<p>The <a href="https://www.rdocumentation.org/packages/stats/topics/kmeans">kmeans</a> function expects the input to be rows for observations and columns for each variable: in our case that would be documents as rows, and words as columns, with the tf-idf as the cell values. We could use <code>spread</code> to do this, but that would be a large matrix.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">CLUSTERS &lt;-<span class="st"> </span><span class="dv">4</span>
km_out &lt;-
<span class="st">  </span><span class="kw">kmeans</span>(<span class="kw">cast_dtm</span>(dtm_hamilton, document, word, tf_idf), <span class="dt">centers =</span> CLUSTERS,
         <span class="dt">nstart =</span> <span class="dv">10</span>)
km_out<span class="op">$</span>iter
<span class="co">#&gt; [1] 3</span></code></pre></div>
<p>Data frame with the unique terms used by Hamilton. I extract these from the column names of the DTM after <code>cast_dtm</code> to ensure that the order is the same as the k-means results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hamilton_words &lt;-
<span class="st">  </span><span class="kw">tibble</span>(<span class="dt">word =</span> <span class="kw">colnames</span>(<span class="kw">cast_dtm</span>(dtm_hamilton, document, word, tf_idf)))</code></pre></div>
<p>The centers of the clusters is a cluster x word matrix. We want to transpose it and then append columns to <code>hamilton_words</code> so the location of each word in the cluster is listed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(km_out<span class="op">$</span>centers)
<span class="co">#&gt; [1]    4 3850</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hamilton_words &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(hamilton_words, <span class="kw">as_tibble</span>(<span class="kw">t</span>(km_out<span class="op">$</span>centers)))
hamilton_words
<span class="co">#&gt; # A tibble: 3,850 x 5</span>
<span class="co">#&gt;         word      `1`      `2`     `3`      `4`</span>
<span class="co">#&gt;        &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1        abl 0.000939 0.000743 0.00000 0.000000</span>
<span class="co">#&gt; 2     absurd 0.000000 0.000517 0.00000 0.000882</span>
<span class="co">#&gt; 3      accid 0.000000 0.000202 0.00000 0.000000</span>
<span class="co">#&gt; 4     accord 0.000000 0.000399 0.00000 0.000852</span>
<span class="co">#&gt; 5 acknowledg 0.000000 0.000388 0.00000 0.000473</span>
<span class="co">#&gt; 6        act 0.000000 0.000560 0.00176 0.000631</span>
<span class="co">#&gt; # ... with 3,844 more rows</span></code></pre></div>
<p>To find the top 10 words in each centroid, we use <code>top_n</code> with <code>group_by</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">top_words_cluster &lt;-
<span class="st">  </span><span class="kw">gather</span>(hamilton_words, cluster, value, <span class="op">-</span>word) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, value)</code></pre></div>
<p>We can print them out using a for loop</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>CLUSTERS) {
  <span class="kw">cat</span>(<span class="st">&quot;CLUSTER &quot;</span>, i, <span class="st">&quot;: &quot;</span>,
      <span class="kw">str_c</span>(<span class="kw">filter</span>(top_words_cluster, cluster <span class="op">==</span><span class="st"> </span>i)<span class="op">$</span>word, <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>),
      <span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">&quot;</span>)
}
<span class="co">#&gt; CLUSTER  1 :  presid, appoint, senat, claus, expir, fill, recess, session, unfound, vacanc </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; CLUSTER  2 :  offic, presid, tax, land, revenu, armi, militia, senat, taxat, claus </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; CLUSTER  3 :  sedit, guilt, chief, clemenc, impun, plead, crime, pardon, treason, conniv </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; CLUSTER  4 :  court, jurisdict, inferior, suprem, trial, tribun, cogniz, juri, impeach, appel</span></code></pre></div>
<p>This is alternative code that prints out a table:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">gather</span>(hamilton_words, cluster, value, <span class="op">-</span>word) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, value) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">top_words =</span> <span class="kw">str_c</span>(word, <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">cluster</th>
<th align="left">top_words</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">presid, appoint, senat, claus, expir, fill, recess, session, unfound, vacanc</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">offic, presid, tax, land, revenu, armi, militia, senat, taxat, claus</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">sedit, guilt, chief, clemenc, impun, plead, crime, pardon, treason, conniv</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">court, jurisdict, inferior, suprem, trial, tribun, cogniz, juri, impeach, appel</td>
</tr>
</tbody>
</table>
<p>Or to print out the documents in each cluster,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">enframe</span>(km_out<span class="op">$</span>cluster, <span class="st">&quot;document&quot;</span>, <span class="st">&quot;cluster&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">documents =</span> <span class="kw">str_c</span>(document, <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">cluster</th>
<th align="left">documents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">67</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">1, 6, 7, 8, 9, 11, 12, 13, 15, 16, 17, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 59, 60, 61, 66, 68, 69, 70, 71, 72, 73, 75, 76, 77, 78, 79, 80, 84, 85</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="left">74</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="left">65, 81, 82, 83</td>
</tr>
</tbody>
</table>
</div>
<div id="authorship-prediction" class="section level3">
<h3><span class="header-section-number">4.8.3</span> Authorship Prediction</h3>
<p>We’ll create a data-frame with the known</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">MADISON_ESSAYS &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">14</span>, <span class="dv">37</span><span class="op">:</span><span class="dv">48</span>, <span class="dv">58</span>)
JAY_ESSAYS &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">64</span>)
known_essays &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw">tibble</span>(<span class="dt">document =</span> MADISON_ESSAYS,
                                 <span class="dt">author =</span> <span class="st">&quot;Madison&quot;</span>),
                          <span class="kw">tibble</span>(<span class="dt">document =</span> HAMILTON_ESSAYS,
                                 <span class="dt">author =</span> <span class="st">&quot;Hamilton&quot;</span>),
                          <span class="kw">tibble</span>(<span class="dt">document =</span> JAY_ESSAYS,
                                 <span class="dt">author =</span> <span class="st">&quot;Jay&quot;</span>))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">STYLE_WORDS &lt;-
<span class="st">  </span><span class="kw">tibble</span>(<span class="dt">word =</span> <span class="kw">c</span>(<span class="st">&quot;although&quot;</span>, <span class="st">&quot;always&quot;</span>, <span class="st">&quot;commonly&quot;</span>, <span class="st">&quot;consequently&quot;</span>,
                  <span class="st">&quot;considerable&quot;</span>, <span class="st">&quot;enough&quot;</span>, <span class="st">&quot;there&quot;</span>, <span class="st">&quot;upon&quot;</span>, <span class="st">&quot;while&quot;</span>, <span class="st">&quot;whilst&quot;</span>))

hm_tfm &lt;-
<span class="st">  </span><span class="kw">unnest_tokens</span>(corpus_tidy, word, text) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">count</span>(document, word) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># term freq per 1000 words</span>
<span class="st">  </span><span class="kw">group_by</span>(document) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">count =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n) <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>n) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(STYLE_WORDS, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># merge known essays</span>
<span class="st">  </span><span class="kw">left_join</span>(known_essays, <span class="dt">by =</span> <span class="st">&quot;document&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># make wide with each word a column</span>
<span class="st">  </span><span class="co"># fill empty values with 0</span>
<span class="st">  </span><span class="kw">spread</span>(word, count, <span class="dt">fill =</span> <span class="dv">0</span>)</code></pre></div>
<p>Calculate average usage by each author of each word</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hm_tfm <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># remove docs with no author</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(author)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># convert back to long (tidy) format to make it easier to summarize</span>
<span class="st">  </span><span class="kw">gather</span>(word, count, <span class="op">-</span>document, <span class="op">-</span>author) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># calculate averge document word usage by author</span>
<span class="st">  </span><span class="kw">group_by</span>(author, word) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">avg_count =</span> <span class="kw">mean</span>(count)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(author, avg_count) <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">word</th>
<th align="right">Hamilton</th>
<th align="right">Jay</th>
<th align="right">Madison</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">although</td>
<td align="right">0.012</td>
<td align="right">0.543</td>
<td align="right">0.206</td>
</tr>
<tr class="even">
<td align="left">always</td>
<td align="right">0.522</td>
<td align="right">0.929</td>
<td align="right">0.154</td>
</tr>
<tr class="odd">
<td align="left">commonly</td>
<td align="right">0.184</td>
<td align="right">0.129</td>
<td align="right">0.000</td>
</tr>
<tr class="even">
<td align="left">consequently</td>
<td align="right">0.018</td>
<td align="right">0.469</td>
<td align="right">0.344</td>
</tr>
<tr class="odd">
<td align="left">considerable</td>
<td align="right">0.377</td>
<td align="right">0.081</td>
<td align="right">0.123</td>
</tr>
<tr class="even">
<td align="left">enough</td>
<td align="right">0.274</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
<tr class="odd">
<td align="left">there</td>
<td align="right">3.065</td>
<td align="right">0.954</td>
<td align="right">0.849</td>
</tr>
<tr class="even">
<td align="left">upon</td>
<td align="right">3.054</td>
<td align="right">0.112</td>
<td align="right">0.152</td>
</tr>
<tr class="odd">
<td align="left">while</td>
<td align="right">0.255</td>
<td align="right">0.192</td>
<td align="right">0.000</td>
</tr>
<tr class="even">
<td align="left">whilst</td>
<td align="right">0.005</td>
<td align="right">0.000</td>
<td align="right">0.292</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">author_data &lt;-
<span class="st">  </span>hm_tfm <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(author) <span class="op">|</span><span class="st"> </span>author <span class="op">!=</span><span class="st"> &quot;Jay&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">author2 =</span> <span class="kw">case_when</span>(.<span class="op">$</span>author <span class="op">==</span><span class="st"> &quot;Hamilton&quot;</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,
                             .<span class="op">$</span>author <span class="op">==</span><span class="st"> &quot;Madison&quot;</span> <span class="op">~</span><span class="st"> </span><span class="op">-</span><span class="dv">1</span>,
                             <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span><span class="ot">NA_real_</span>))

hm_fit &lt;-<span class="st"> </span><span class="kw">lm</span>(author2 <span class="op">~</span><span class="st"> </span>upon <span class="op">+</span><span class="st"> </span>there <span class="op">+</span><span class="st"> </span>consequently <span class="op">+</span><span class="st"> </span>whilst,
             <span class="dt">data =</span> author_data)
hm_fit
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = author2 ~ upon + there + consequently + whilst, </span>
<span class="co">#&gt;     data = author_data)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;  (Intercept)          upon         there  consequently        whilst  </span>
<span class="co">#&gt;       -0.195         0.229         0.127        -0.644        -0.984</span>

author_data &lt;-<span class="st"> </span>author_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_predictions</span>(hm_fit) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pred_author =</span> <span class="kw">if_else</span>(pred <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;Hamilton&quot;</span>, <span class="st">&quot;Madison&quot;</span>))

<span class="kw">sd</span>(author_data<span class="op">$</span>pred)
<span class="co">#&gt; [1] 0.79</span></code></pre></div>
<p>These coefficients are a little different, probably due to differences in the tokenization procedure, and in particular, the document size normalization.</p>
</div>
<div id="cross-validation" class="section level3">
<h3><span class="header-section-number">4.8.4</span> Cross-Validation</h3>
<p><strong>tidyverse:</strong> For cross-validation, I rely on the <a href="https://cran.r-project.org/package=modelr">modelr</a> package function <code>RDoc(&quot;modelr::crossv_kfold&quot;)</code>. See the tutorial <a href="https://rpubs.com/dgrtwo/cv-modelr">Cross validation of linear regression with modelr</a> for more on using <strong>modelr</strong> for cross validation or <a href="https://drsimonj.svbtle.com/k-fold-cross-validation-with-modelr-and-broom">k-fold cross-validation with modelr and broom</a>.</p>
<p>In sample, this regression perfectly predicts the authorship of the documents with known authors.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">author_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(author)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(author) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="st">`</span><span class="dt">Proportion Correct</span><span class="st">`</span> =<span class="st"> </span><span class="kw">mean</span>(author <span class="op">==</span><span class="st"> </span>pred_author))
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;     author `Proportion Correct`</span>
<span class="co">#&gt;      &lt;chr&gt;                &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Hamilton                    1</span>
<span class="co">#&gt; 2  Madison                    1</span></code></pre></div>
<p>Create the cross-validation data-sets using . As in the chapter, I will use a leave-one-out cross-validation, which is a k-fold cross-validation where k is the number of observations. To simplify this, I define the <code>crossv_loo</code> function that runs <code>crossv_kfold</code> with <code>k = nrow(data)</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">crossv_loo &lt;-<span class="st"> </span><span class="cf">function</span>(data, <span class="dt">id =</span> <span class="st">&quot;.id&quot;</span>) {
  modelr<span class="op">::</span><span class="kw">crossv_kfold</span>(data, <span class="dt">k =</span> <span class="kw">nrow</span>(data), <span class="dt">id =</span> id)
}

<span class="co"># leave one out cross-validation object</span>
cv &lt;-<span class="st"> </span>author_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(author)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">crossv_loo</span>()</code></pre></div>
<p>Now estimate the model for each training dataset</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">models &lt;-<span class="st"> </span><span class="kw">map</span>(cv<span class="op">$</span>train, <span class="op">~</span><span class="st"> </span><span class="kw">lm</span>(author2 <span class="op">~</span><span class="st"> </span>upon <span class="op">+</span><span class="st"> </span>there <span class="op">+</span><span class="st"> </span>consequently <span class="op">+</span><span class="st"> </span>whilst,
                             <span class="dt">data =</span> ., <span class="dt">model =</span> <span class="ot">FALSE</span>))</code></pre></div>
<p>Note that I use <code>purrr::map</code> to ensure that the correct <code>map()</code> function is used since the <strong>maps</strong> package also defines a <code>map</code>.</p>
<p>Now calculate the test performance on the held out observation,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test &lt;-<span class="st"> </span><span class="kw">map2_df</span>(models, cv<span class="op">$</span>test,
                <span class="cf">function</span>(mod, test) {
                  <span class="kw">add_predictions</span>(<span class="kw">as.data.frame</span>(test), mod) <span class="op">%&gt;%</span>
<span class="st">                    </span><span class="kw">mutate</span>(<span class="dt">pred_author =</span>
                             <span class="kw">if_else</span>(pred <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;Hamilton&quot;</span>, <span class="st">&quot;Madison&quot;</span>),
                           <span class="dt">correct =</span> (pred_author <span class="op">==</span><span class="st"> </span>author))
                })
test <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(author) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(correct))
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;     author `mean(correct)`</span>
<span class="co">#&gt;      &lt;chr&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Hamilton           1.000</span>
<span class="co">#&gt; 2  Madison           0.786</span></code></pre></div>
<p>When adding prediction with <code>add_predictions</code> it added predictions for missing values as well.</p>
<p>Table of authorship of disputed papers</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">author_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(author)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(document, pred, pred_author) <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">document</th>
<th align="right">pred</th>
<th align="left">pred_author</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">18</td>
<td align="right">-0.360</td>
<td align="left">Madison</td>
</tr>
<tr class="even">
<td align="right">19</td>
<td align="right">-0.587</td>
<td align="left">Madison</td>
</tr>
<tr class="odd">
<td align="right">20</td>
<td align="right">-0.055</td>
<td align="left">Madison</td>
</tr>
<tr class="even">
<td align="right">49</td>
<td align="right">-0.966</td>
<td align="left">Madison</td>
</tr>
<tr class="odd">
<td align="right">50</td>
<td align="right">-0.003</td>
<td align="left">Madison</td>
</tr>
<tr class="even">
<td align="right">51</td>
<td align="right">-1.520</td>
<td align="left">Madison</td>
</tr>
<tr class="odd">
<td align="right">52</td>
<td align="right">-0.195</td>
<td align="left">Madison</td>
</tr>
<tr class="even">
<td align="right">53</td>
<td align="right">-0.506</td>
<td align="left">Madison</td>
</tr>
<tr class="odd">
<td align="right">54</td>
<td align="right">-0.521</td>
<td align="left">Madison</td>
</tr>
<tr class="even">
<td align="right">55</td>
<td align="right">0.094</td>
<td align="left">Hamilton</td>
</tr>
<tr class="odd">
<td align="right">56</td>
<td align="right">-0.550</td>
<td align="left">Madison</td>
</tr>
<tr class="even">
<td align="right">57</td>
<td align="right">-1.221</td>
<td align="left">Madison</td>
</tr>
<tr class="odd">
<td align="right">62</td>
<td align="right">-0.946</td>
<td align="left">Madison</td>
</tr>
<tr class="even">
<td align="right">63</td>
<td align="right">-0.184</td>
<td align="left">Madison</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">disputed_essays &lt;-<span class="st"> </span><span class="kw">filter</span>(author_data, <span class="kw">is.na</span>(author))<span class="op">$</span>document

<span class="kw">ggplot</span>(<span class="kw">mutate</span>(author_data,
              <span class="dt">author =</span> <span class="kw">fct_explicit_na</span>(<span class="kw">factor</span>(author), <span class="st">&quot;Disputed&quot;</span>)),
       <span class="kw">aes</span>(<span class="dt">y =</span> document, <span class="dt">x =</span> pred, <span class="dt">colour =</span> author, <span class="dt">shape =</span> author)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">10</span>, <span class="dv">80</span>, <span class="dt">by =</span> <span class="dv">10</span>),
                     <span class="dt">minor_breaks =</span> <span class="kw">seq</span>(<span class="dv">5</span>, <span class="dv">80</span>, <span class="dt">by =</span> <span class="dv">5</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Madison&quot;</span> =<span class="st"> &quot;blue&quot;</span>,
                                <span class="st">&quot;Hamilton&quot;</span> =<span class="st"> &quot;red&quot;</span>,
                                <span class="st">&quot;Disputed&quot;</span> =<span class="st"> &quot;black&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_shape_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Madison&quot;</span> =<span class="st"> </span><span class="dv">16</span>, <span class="st">&quot;Hamilton&quot;</span> =<span class="st"> </span><span class="dv">15</span>,
                                 <span class="st">&quot;Disputed&quot;</span> =<span class="st"> </span><span class="dv">17</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">colour =</span> <span class="st">&quot;Author&quot;</span>, <span class="dt">shape =</span> <span class="st">&quot;Author&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Federalist Papers&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Predicted values&quot;</span>)</code></pre></div>
<p><img src="discovery-textual_files/figure-html/unnamed-chunk-33-1.png" width="70%" style="display: block; margin: auto;" /></p>

</div>
</div>
<div id="network-data" class="section level2">
<h2><span class="header-section-number">4.9</span> Network data</h2>
<p>The <a href="https://cran.r-project.org/package=igraph">igraph</a>, <a href="https://cran.r-project.org/package=sna">sna</a>, and <a href="https://cran.r-project.org/package=network">network</a> packages are the best in class. See the Social Network Analysis section of the <a href="https://cran.r-project.org/web/views/SocialSciences.html">Social Sciences Task View</a>. See this tutorial by Katherin Ognyanova, <a href="https://rpubs.com/kateto/netviz">Static and dynamic network visualization with R</a>, for a good overview of network visualization with those packages in R.</p>
<p>There are several packages that plot networks in ggplot2.</p>
<ul>
<li><a href="https://cran.r-project.org/package=ggnetwork">ggnetwork</a></li>
<li><a href="https://cran.r-project.org/package=ggraph">ggraph</a></li>
<li><a href="https://cran.r-project.org/package=geomnet">geomnet</a></li>
<li><a href="https://cran.r-project.org/package=GGally">GGally</a> functions <a href="https://ggobi.github.io/ggally/rd.html#ggnet">ggnet</a>, <code>ggnet2</code>, and <code>ggnetworkmap</code>.</li>
<li><a href="https://cran.r-project.org/package=ggCompNet">ggCompNet</a> compares the speed of various network plotting packages in R.</li>
</ul>
<p>See this <a href="http://curleylab.psych.columbia.edu/netviz/netviz1.html#/12">presentation</a> for an overview of some of those packages for data visualization.</p>
<p>Examples: <a href="https://cran.r-project.org/web/packages/ggCompNet/vignettes/examples-from-paper.html">Network Visualization Examples with the ggplot2 Package</a></p>
<div id="prerequisites-6" class="section level3 unnumbered">
<h3>Prerequisites</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;igraph&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;intergraph&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;GGally&quot;</span>)</code></pre></div>
</div>
<div id="twitter-following-network" class="section level3">
<h3><span class="header-section-number">4.9.1</span> Twitter Following Network</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;twitter.following&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;twitter.senator&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</code></pre></div>
<p>Since the names <code>twitter.following</code> and <code>twitter.senator</code> are verbose, we’ll simplify future code by copying their values to variables named <code>twitter</code> and <code>senator</code>, respectively.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">twitter &lt;-<span class="st"> </span>twitter.following
senator &lt;-<span class="st"> </span>twitter.senator</code></pre></div>
<p>Simply use the function since <code>twitter</code> consists of edges (a link from a senator to another). Since <code>graph_from_edgelist</code> expects a matrix, convert the data frame to a matrix using .</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">twitter_adj &lt;-<span class="st"> </span><span class="kw">graph_from_edgelist</span>(<span class="kw">as.matrix</span>(twitter))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">environment</span>(degree)
<span class="co">#&gt; &lt;environment: namespace:igraph&gt;</span></code></pre></div>
<p>Add in- and out-degree variables to the <code>senator</code> data frame:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">senator &lt;-
<span class="st">  </span><span class="kw">mutate</span>(senator,
         <span class="dt">indegree =</span> igraph<span class="op">::</span><span class="kw">degree</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;in&quot;</span>),
         <span class="dt">outdegree =</span> igraph<span class="op">::</span><span class="kw">degree</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;out&quot;</span>))</code></pre></div>
<p>Now find the senators with the 3 greatest in-degrees</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">arrange</span>(senator, <span class="kw">desc</span>(indegree)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(name, party, state, indegree, outdegree)
<span class="co">#&gt; # A tibble: 3 x 5</span>
<span class="co">#&gt;                name party state indegree outdegree</span>
<span class="co">#&gt;               &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1        Tom Cotton     R    AR       64        15</span>
<span class="co">#&gt; 2 Richard J. Durbin     D    IL       60        87</span>
<span class="co">#&gt; 3     John Barrasso     R    WY       58        79</span></code></pre></div>
<p>or using the function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">top_n</span>(senator, <span class="dv">3</span>, indegree) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(indegree)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(name, party, state, indegree, outdegree)
<span class="co">#&gt;                name party state indegree outdegree</span>
<span class="co">#&gt; 1        Tom Cotton     R    AR       64        15</span>
<span class="co">#&gt; 2 Richard J. Durbin     D    IL       60        87</span>
<span class="co">#&gt; 3     John Barrasso     R    WY       58        79</span>
<span class="co">#&gt; 4      Joe Donnelly     D    IN       58         9</span>
<span class="co">#&gt; 5    Orrin G. Hatch     R    UT       58        50</span></code></pre></div>
<p>The <code>top_n</code> function catches that three senators are tied for 3rd highest outdegree, whereas the simply sorting and slicing cannot.</p>
<p>And we can find the senators with the three highest out-degrees similarly,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">top_n</span>(senator, <span class="dv">3</span>, outdegree) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(outdegree)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(name, party, state, indegree, outdegree)
<span class="co">#&gt;               name party state indegree outdegree</span>
<span class="co">#&gt; 1     Thad Cochran     R    MS       55        89</span>
<span class="co">#&gt; 2     Steve Daines     R    MT       30        88</span>
<span class="co">#&gt; 3      John McCain     R    AZ       41        88</span>
<span class="co">#&gt; 4 Joe Manchin, III     D    WV       43        88</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define scales to reuse for the plots</span>
scale_colour_parties &lt;-<span class="st"> </span><span class="kw">scale_colour_manual</span>(<span class="st">&quot;Party&quot;</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">R =</span> <span class="st">&quot;red&quot;</span>,
                                                       <span class="dt">D =</span> <span class="st">&quot;blue&quot;</span>,
                                                       <span class="dt">I =</span> <span class="st">&quot;green&quot;</span>))
scale_shape_parties &lt;-<span class="st"> </span><span class="kw">scale_shape_manual</span>(<span class="st">&quot;Party&quot;</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">R =</span> <span class="dv">16</span>,
                                                              <span class="dt">D =</span> <span class="dv">17</span>,
                                                              <span class="dt">I =</span> <span class="dv">4</span>))


senator <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">closeness_in =</span> igraph<span class="op">::</span><span class="kw">closeness</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;in&quot;</span>),
         <span class="dt">closeness_out =</span> igraph<span class="op">::</span><span class="kw">closeness</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;out&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> closeness_in, <span class="dt">y =</span> closeness_out,
             <span class="dt">colour =</span> party, <span class="dt">shape =</span> party)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span>scale_colour_parties <span class="op">+</span>
<span class="st">  </span>scale_shape_parties <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">main =</span> <span class="st">&quot;Closeness&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Incoming path&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Outgoing path&quot;</span>)</code></pre></div>
<p><img src="discovery-network_files/figure-html/unnamed-chunk-10-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>What does the reference line indicate? What does that say about senators twitter networks?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">senator <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">betweenness_dir =</span> igraph<span class="op">::</span><span class="kw">betweenness</span>(twitter_adj, <span class="dt">directed =</span> <span class="ot">TRUE</span>),
         <span class="dt">betweenness_undir =</span> igraph<span class="op">::</span><span class="kw">betweenness</span>(twitter_adj,
                                                 <span class="dt">directed =</span> <span class="ot">FALSE</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> betweenness_dir, <span class="dt">y =</span> betweenness_undir, <span class="dt">colour =</span> party,
             <span class="dt">shape =</span> party)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span>scale_colour_parties <span class="op">+</span>
<span class="st">  </span>scale_shape_parties <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">main =</span> <span class="st">&quot;Betweenness&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Directed&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Undirected&quot;</span>)</code></pre></div>
<p><img src="discovery-network_files/figure-html/unnamed-chunk-11-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We’ve covered three different methods of calculating the importance of a node in a network: degree, closeness, and centrality. But what do they mean? What’s the “best” measure of importance? The answer to the the former is “it depends on the question”. There are probably other papers out there on this, but Borgatti (2005) is a good discussion:</p>
<blockquote>
<p>Borgatti, Stephen. 2005. “Centrality and Network Flow”. <em>Social Networks</em>. <a href="https://dx.doi.org/doi:10.1016/j.socnet.2004.11.008">DOI</a></p>
</blockquote>
<p>Add and plot page-rank:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">senator &lt;-<span class="st"> </span><span class="kw">mutate</span>(senator, <span class="dt">page_rank =</span> <span class="kw">page_rank</span>(twitter_adj)[[<span class="st">&quot;vector&quot;</span>]])
<span class="kw">ggnet</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;target&quot;</span>)</code></pre></div>
<p><img src="discovery-network_files/figure-html/unnamed-chunk-12-1.png" width="70%" style="display: block; margin: auto;" /></p>

</div>
</div>
<div id="spatial-data-1" class="section level2">
<h2><span class="header-section-number">4.10</span> Spatial Data</h2>
<p>Some resources on plotting spatial data in R:</p>
<ul>
<li><p><a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> has several map-related functions</p></li>
<li><a href="http://docs.ggplot2.org/current/borders.html">borders</a></li>
<li><a href="http://docs.ggplot2.org/current/fortify.map.html">fortify.map</a></li>
<li><p><a href="http://docs.ggplot2.org/current/map_data.html">map_data</a></p></li>
<li><p><a href="https://cran.r-project.org/package=ggmap">ggmap</a> allows ggplot to us a map from Google Maps, OpenStreet Maps or similar as a background for the plot.</p></li>
<li>David Kahle and Hadley Wickham. 2013. <a href="https://journal.r-project.org/archive/2013-1/kahle-wickham.pdf">ggmap: Spatial Visualization with ggplot2</a>. <em>Journal of Statistical Software</em></li>
<li><p>Github <a href="https://github.com/dkahle/ggmap">dkahle/ggmamp</a></p></li>
<li><a href="https://cran.r-project.org/package=tmap">tmap</a> is not built on ggplot2 but uses a ggplot2-like API for network data.</li>
<li><p><a href="https://cran.r-project.org/package=leaflet">leaflet</a> is an R interface to a popular javascript mapping library.</p></li>
</ul>
<p>Here are few tutorials on plotting spatial data in ggplot2:</p>
<ul>
<li><a href="http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html">Making Maps with R</a></li>
<li><a href="https://www.r-bloggers.com/r-beginners-plotting-locations-on-to-a-world-map/">Plotting Data on a World Map</a></li>
<li><a href="https://rpubs.com/m_dev/Intro-to-Spatial-Data-and-ggplot2">Introduction to Spatial Data and ggplot2</a></li>
</ul>
<div id="prerequisites-7" class="section level3">
<h3><span class="header-section-number">4.10.1</span> Prerequisites</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;modelr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggrepel&quot;</span>)</code></pre></div>
</div>
<div id="spatial-data-in-r-1" class="section level3">
<h3><span class="header-section-number">4.10.2</span> Spatial Data in R</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;us.cities&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;maps&quot;</span>)
<span class="kw">glimpse</span>(us.cities)
<span class="co">#&gt; Observations: 1,005</span>
<span class="co">#&gt; Variables: 6</span>
<span class="co">#&gt; $ name        &lt;chr&gt; &quot;Abilene TX&quot;, &quot;Akron OH&quot;, &quot;Alameda CA&quot;, &quot;Albany GA...</span>
<span class="co">#&gt; $ country.etc &lt;chr&gt; &quot;TX&quot;, &quot;OH&quot;, &quot;CA&quot;, &quot;GA&quot;, &quot;NY&quot;, &quot;OR&quot;, &quot;NM&quot;, &quot;LA&quot;, &quot;V...</span>
<span class="co">#&gt; $ pop         &lt;int&gt; 113888, 206634, 70069, 75510, 93576, 45535, 494962...</span>
<span class="co">#&gt; $ lat         &lt;dbl&gt; 32.5, 41.1, 37.8, 31.6, 42.7, 44.6, 35.1, 31.3, 38...</span>
<span class="co">#&gt; $ long        &lt;dbl&gt; -99.7, -81.5, -122.3, -84.2, -73.8, -123.1, -106.6...</span>
<span class="co">#&gt; $ capital     &lt;int&gt; 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">usa_map &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;usa&quot;</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: &#39;maps&#39;</span>
<span class="co">#&gt; The following object is masked from &#39;package:purrr&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     map</span>
capitals &lt;-<span class="st"> </span><span class="kw">filter</span>(us.cities,
                   capital <span class="op">==</span><span class="st"> </span><span class="dv">2</span>,
                   <span class="op">!</span>country.etc <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;HI&quot;</span>, <span class="st">&quot;AK&quot;</span>))
<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_map</span>(<span class="dt">map =</span> usa_map) <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;usa&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">size =</span> pop),
             <span class="dt">data =</span> capitals) <span class="op">+</span>
<span class="st">  </span><span class="co"># scale size area ensures: 0 = no area</span>
<span class="st">  </span><span class="kw">scale_size_area</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>, <span class="dt">title =</span> <span class="st">&quot;US State Capitals&quot;</span>,
       <span class="dt">size =</span> <span class="st">&quot;Population&quot;</span>)</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-4-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cal_cities &lt;-<span class="st"> </span><span class="kw">filter</span>(us.cities, country.etc <span class="op">==</span><span class="st"> &quot;CA&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">7</span>, pop)

<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> <span class="st">&quot;California&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat), <span class="dt">data =</span> cal_cities) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">label =</span> name), <span class="dt">data =</span> cal_cities) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-5-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="colors-in-r-1" class="section level3">
<h3><span class="header-section-number">4.10.3</span> Colors in R</h3>
<p>For more resources on using colors in R</p>
<ul>
<li><code>R4DS</code> chapter <a href="http://r4ds.had.co.nz/graphics-for-communication.html#replacing-a-scale">Graphics for Communication</a></li>
<li>ggplot2 book Chapter “Scales”</li>
<li>Jenny Bryan <a href="https://www.stat.ubc.ca/~jenny/STAT545A/block14_colors.html">Using colors in R</a></li>
<li>Achim Zeileis, Kurt Hornik, Paul Murrell (2009). Escaping RGBland: Selecting Colors for Statistical Graphics. Computational Statistics &amp; Data Analysis <a href="http://dx.doi.org/10.1016/j.csda.2008.11.033">DOI</a></li>
<li><a href="https://cran.r-project.org/web/packages/colorspace/vignettes/hcl-colors.pdf">colorspace vignette</a></li>
<li>Maureen Stone <a href="https://www.perceptualedge.com/articles/b-eye/choosing_colors.pdf">Choosing Colors for Data Visualization</a></li>
<li><a href="http://colorbrewer2.org">ColorBrewer</a> A website with a variety of palettes, primarily designed for maps, but also useful in data viz.</li>
<li>Stephen Few <a href="http://www.perceptualedge.com/articles/visual_business_intelligence/rules_for_using_color.pdf">Practical Rules for Using Color in Charts</a></li>
<li><a href="http://www.research.ibm.com/people/l/lloydt/color/color.HTM">Why Should Engineers and Scientists by Worried About Color?</a></li>
<li><a href="https://www.youtube.com/watch?v=xAoljeRJ3lU">A Better Default Colormap for Matplotlib</a> A SciPy 2015 talk that describes how the <a href="https://cran.r-project.org/package=viridis">viridis</a> was created.</li>
<li><a href="http://www.eecs.harvard.edu/~kgajos/papers/2011/borkin11-infoviz.pdf">Evaluation of Artery Visualizations for Heart Disease Diagnosis</a> Using the wrong color scale can be deadly … literally.</li>
<li>The python package matplotlib has a good discussion of <a href="http://matplotlib.org/users/colormaps.html">colormaps</a>.</li>
<li>Peter Kovesi <a href="https://arxiv.org/pdf/1509.03700v1.pdf">Good Color Maps: How to Design Them</a>.</li>
<li>See the <a href="https://cran.r-project.org/package=viridis">viridis</a>, <a href="https://cran.r-project.org/package=ggthemes">ggthemes</a>, <a href="https://cran.r-project.org/package=dichromat">dichromat</a>, and <a href="https://cran.r-project.org/package=pals">pals</a> packages for color palettes.</li>
</ul>
<p>Use <a href="http://docs.ggplot2.org/current/scale_identity.html">scale_identity</a> for the color and alpha scales since the values of the variables are the values of the scale itself (the color names, and the alpha values).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">each =</span> <span class="dv">2</span>),
              <span class="dt">y =</span> x <span class="op">+</span><span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">times =</span> <span class="dv">2</span>),
              <span class="dt">colour =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>), <span class="dt">each =</span> <span class="dv">4</span>),
              <span class="dt">alpha =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>)),
  <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">colour =</span> colour, <span class="dt">alpha =</span> alpha)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">15</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_alpha_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-6-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="united-states-presidential-elections-1" class="section level3">
<h3><span class="header-section-number">4.10.4</span> United States Presidential Elections</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;pres08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)

pres08 &lt;-<span class="st"> </span>pres08 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Dem =</span> Obama <span class="op">/</span><span class="st"> </span>(Obama <span class="op">+</span><span class="st"> </span>McCain),
         <span class="dt">Rep =</span> McCain <span class="op">/</span><span class="st"> </span>(Obama <span class="op">+</span><span class="st"> </span>McCain))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> <span class="st">&quot;California&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>()</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-8-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cal_color &lt;-<span class="st"> </span><span class="kw">filter</span>(pres08, state <span class="op">==</span><span class="st"> &quot;CA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>{
    <span class="kw">rgb</span>(<span class="dt">red =</span> .<span class="op">$</span>Rep, <span class="dt">green =</span> <span class="dv">0</span>, <span class="dt">blue =</span> .<span class="op">$</span>Dem)
  }

<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> <span class="st">&quot;California&quot;</span>, <span class="dt">fill =</span> cal_color) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>()</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-9-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># America as red and blue states</span>
<span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="co"># create a map</span>
<span class="cf">for</span> (i  <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(pres08)) {
    <span class="cf">if</span> ( (pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;HI&quot;</span>) <span class="op">&amp;</span><span class="st"> </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;AK&quot;</span>) <span class="op">&amp;</span>
<span class="st">        </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;DC&quot;</span>)) {
        <span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> pres08<span class="op">$</span>state.name[i],
            <span class="dt">col =</span> <span class="kw">ifelse</span>(pres08<span class="op">$</span>Rep[i] <span class="op">&gt;</span><span class="st"> </span>pres08<span class="op">$</span>Dem[i], <span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>),
            <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
    }
}

## America as purple states
<span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="co"># create a map</span>
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(pres08)) {
    <span class="cf">if</span> ( (pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;HI&quot;</span>) <span class="op">&amp;</span><span class="st"> </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;AK&quot;</span>) <span class="op">&amp;</span>
<span class="st">        </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;DC&quot;</span>)) {
        <span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> pres08<span class="op">$</span>state.name[i],
            <span class="dt">col =</span> <span class="kw">rgb</span>(<span class="dt">red =</span> pres08<span class="op">$</span>Rep[i], <span class="dt">blue =</span> pres08<span class="op">$</span>Dem[i],
               <span class="dt">green =</span> <span class="dv">0</span>), <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
    }
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">states &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;state&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw">mutate</span>(pres08, <span class="dt">state.name =</span> <span class="kw">str_to_lower</span>(state.name)),
            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;region&quot;</span> =<span class="st"> &quot;state.name&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># drops DC</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(EV)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">party =</span> <span class="kw">if_else</span>(Dem <span class="op">&gt;</span><span class="st"> </span>Rep, <span class="st">&quot;Dem&quot;</span>, <span class="st">&quot;Rep&quot;</span>),
         <span class="dt">color =</span> <span class="kw">map2_chr</span>(Dem, Rep, <span class="op">~</span><span class="st"> </span><span class="kw">rgb</span>(<span class="dt">blue =</span> .x, <span class="dt">red =</span> .y, <span class="dt">green =</span> <span class="dv">0</span>)))

<span class="kw">ggplot</span>(states) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> long, <span class="dt">y =</span> lat,
                   <span class="dt">fill =</span> party)) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Rep&quot;</span> =<span class="st"> &quot;red&quot;</span>, <span class="st">&quot;Dem&quot;</span> =<span class="st"> &quot;blue&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-11-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>For plotting the purple states, I use since the <code>color</code> column contains the RGB values to use in the plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(states) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> long, <span class="dt">y =</span> lat,
                   <span class="dt">fill =</span> color)) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-12-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>However, plotting purple states is not a good data visualization. Even though the colors are a proportional mixture of red and blue, human visual perception doesn’t work that way.</p>
<p>The proportion of the democratic vote is best thought of a diverging scale with 0.5 is midpoint. And since the Democratic Party is associated with the color blue and the Republican Party is associated with the color red. The Color Brewer palette <a href="http://colorbrewer2.org/#type=diverging&amp;scheme=RdBu&amp;n=11">RdBu</a> is an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(states) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">fill =</span> Dem)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_distiller</span>(<span class="st">&quot;% Obama&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">type =</span> <span class="st">&quot;div&quot;</span>,
                       <span class="dt">palette =</span> <span class="st">&quot;RdBu&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-13-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="expansion-of-walmart-1" class="section level3">
<h3><span class="header-section-number">4.10.5</span> Expansion of Walmart</h3>
<p>We don’t need to do the direct mapping since</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;walmart&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)

<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">colour =</span> type, <span class="dt">size =</span> size),
             <span class="dt">data =</span> <span class="kw">mutate</span>(walmart,
                           <span class="dt">size =</span> <span class="kw">if_else</span>(type <span class="op">==</span><span class="st"> &quot;DistributionCenter&quot;</span>, <span class="dv">2</span>, <span class="dv">1</span>)),
             <span class="dt">alpha =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_size_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>))) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>()</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-14-1.png" width="70%" style="display: block; margin: auto;" /> We don’t need to worry about colors since <code>ggplot</code> handles that. I use <a href="http://docs.ggplot2.org/current/guides.html">guides</a> to so that the colors or not transparent in the legend (see <em>R for Data Science</em> chapter<a href="http://r4ds.had.co.nz/graphics-for-communication.html">Graphics for communication</a>).</p>
<p>To make a plot showing all Walmart stores opened up through that year, I write a function, that takes the year and dataset as parameters.</p>
<p>Since I am calling the function for its side effect (printing the plot) rather than the value it returns, I use the <a href="https://www.rdocumentation.org/packages/purrr/topics/walk">walk</a> function rather than <a href="https://www.rdocumentation.org/packages/purrr/topics/map">map</a>. See <a href="http://r4ds.had.co.nz/">R for Data Science</a>, <a href="http://r4ds.had.co.nz/iteration.html#walk">Chapter 21.8: Walk</a> for more information.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">map_walmart &lt;-<span class="st"> </span><span class="cf">function</span>(year, .data) {
  .data &lt;-<span class="st"> </span><span class="kw">filter</span>(.data, opendate <span class="op">&lt;</span><span class="st"> </span><span class="kw">make_date</span>(year, <span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">size =</span> <span class="kw">if_else</span>(type <span class="op">==</span><span class="st"> &quot;DistributionCenter&quot;</span>, <span class="dv">2</span>, <span class="dv">1</span>))
  <span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">colour =</span> type, <span class="dt">size =</span> size),
               <span class="dt">data =</span> .data, <span class="dt">alpha =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_size_identity</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">guides</span>(<span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>))) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">ggtitle</span>(year)
}

years &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1975</span>, <span class="dv">1985</span>, <span class="dv">1995</span>, <span class="dv">2005</span>)
<span class="kw">walk</span>(years, <span class="op">~</span><span class="st"> </span><span class="kw">print</span>(<span class="kw">map_walmart</span>(.x, walmart)))</code></pre></div>
<p><img src="discovery-spatial_files/figure-html/unnamed-chunk-15-1.png" width="70%" style="display: block; margin: auto;" /><img src="discovery-spatial_files/figure-html/unnamed-chunk-15-2.png" width="70%" style="display: block; margin: auto;" /><img src="discovery-spatial_files/figure-html/unnamed-chunk-15-3.png" width="70%" style="display: block; margin: auto;" /><img src="discovery-spatial_files/figure-html/unnamed-chunk-15-4.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="animation-in-r-1" class="section level3">
<h3><span class="header-section-number">4.10.6</span> Animation in R</h3>
<p>For easy animation with <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a>, use the <a href="https://github.com/dgrtwo/gganimate">gganimate</a> package. Note that the <strong>gganimate</strong> package is not on CRAN, so you have to install it with the <a href="https://cran.r-project.org/package=devtools">devtools</a> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;cowplot&quot;</span>)
devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;dgrtwo/animate&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;gganimate&quot;</span>)</code></pre></div>
<p>An animation is a series of frames. The <a href="https://cran.r-project.org/package=gganimate">gganimate</a> package works by adding a <code>frame</code> aesthetic to ggplots, and function will animate the plot.</p>
<p>I use <code>frame = year(opendate)</code> to have the animation use each year as a frame, and <code>cumulative = TRUE</code> so that the previous years are shown.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">walmart_animated &lt;-
<span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat,
                   <span class="dt">colour =</span> type,
                   <span class="dt">fill =</span> type,
                   <span class="dt">frame =</span> <span class="kw">year</span>(opendate),
                   <span class="dt">cumulative =</span> <span class="ot">TRUE</span>),
               <span class="dt">data =</span> walmart) <span class="op">+</span>
<span class="st">    </span><span class="kw">coord_quickmap</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">theme_void</span>()
<span class="kw">gganimate</span>(walmart_animated)</code></pre></div>
<div class="figure">
<img src="discovery-spatial_files/figure-html/unnamed-chunk-18-.gif" alt="unnamed-chunk-18" />
<p class="caption">unnamed-chunk-18</p>
</div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="measurement.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="probability.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jrnold/qss-tidy/edit/master/prediction.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
