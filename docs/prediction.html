<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>QSS Tidyverse Code</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="QSS Tidyverse Code">
  <meta name="generator" content="bookdown 0.3 and GitBook 2.6.7">

  <meta property="og:title" content="QSS Tidyverse Code" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="jrnold/qss-tidy" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="QSS Tidyverse Code" />
  
  
  

<meta name="author" content="Jeffrey B. Arnold">


<meta name="date" content="2017-01-14">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="measurement.html">
<link rel="next" href="discovery.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preface</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i><b>2.1</b> Prerequisites</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#introduction-to-r"><i class="fa fa-check"></i><b>2.2</b> Introduction to R</a><ul>
<li class="chapter" data-level="2.2.1" data-path="introduction.html"><a href="introduction.html#data-files"><i class="fa fa-check"></i><b>2.2.1</b> Data Files</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction.html"><a href="introduction.html#saving-objects"><i class="fa fa-check"></i><b>2.2.2</b> Saving Objects</a></li>
<li class="chapter" data-level="2.2.3" data-path="introduction.html"><a href="introduction.html#packages"><i class="fa fa-check"></i><b>2.2.3</b> Packages</a></li>
<li class="chapter" data-level="2.2.4" data-path="introduction.html"><a href="introduction.html#style-guide"><i class="fa fa-check"></i><b>2.2.4</b> Style Guide</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>3</b> Causality</a><ul>
<li class="chapter" data-level="3.1" data-path="causality.html"><a href="causality.html#prerequistes"><i class="fa fa-check"></i><b>3.1</b> Prerequistes</a></li>
<li class="chapter" data-level="3.2" data-path="causality.html"><a href="causality.html#racial-discrimination-in-the-labor-market"><i class="fa fa-check"></i><b>3.2</b> Racial Discrimination in the Labor Market</a></li>
<li class="chapter" data-level="3.3" data-path="causality.html"><a href="causality.html#subsetting-data-in-r"><i class="fa fa-check"></i><b>3.3</b> Subsetting Data in R</a><ul>
<li class="chapter" data-level="3.3.1" data-path="causality.html"><a href="causality.html#subsetting"><i class="fa fa-check"></i><b>3.3.1</b> Subsetting</a></li>
<li class="chapter" data-level="3.3.2" data-path="causality.html"><a href="causality.html#simple-conditional-statements"><i class="fa fa-check"></i><b>3.3.2</b> Simple conditional statements</a></li>
<li class="chapter" data-level="3.3.3" data-path="causality.html"><a href="causality.html#factor-variables"><i class="fa fa-check"></i><b>3.3.3</b> Factor Variables</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="causality.html"><a href="causality.html#causal-affects-and-the-counterfactual"><i class="fa fa-check"></i><b>3.4</b> Causal Affects and the Counterfactual</a></li>
<li class="chapter" data-level="3.5" data-path="causality.html"><a href="causality.html#observational-studies"><i class="fa fa-check"></i><b>3.5</b> Observational Studies</a><ul>
<li class="chapter" data-level="3.5.1" data-path="causality.html"><a href="causality.html#confounding-bias"><i class="fa fa-check"></i><b>3.5.1</b> Confounding Bias</a></li>
<li class="chapter" data-level="3.5.2" data-path="causality.html"><a href="causality.html#before-and-after-and-difference-in-difference-designs"><i class="fa fa-check"></i><b>3.5.2</b> Before and After and Difference-in-Difference Designs</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="causality.html"><a href="causality.html#descriptive-statistics-for-a-single-variable"><i class="fa fa-check"></i><b>3.6</b> Descriptive Statistics for a Single Variable</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="measurement.html"><a href="measurement.html"><i class="fa fa-check"></i><b>4</b> Measurement</a><ul>
<li class="chapter" data-level="4.1" data-path="measurement.html"><a href="measurement.html#prerequisites-1"><i class="fa fa-check"></i><b>4.1</b> Prerequisites</a></li>
<li class="chapter" data-level="4.2" data-path="measurement.html"><a href="measurement.html#measuring-civilian-victimization-during-wartime"><i class="fa fa-check"></i><b>4.2</b> Measuring Civilian Victimization during Wartime</a><ul>
<li class="chapter" data-level="4.2.1" data-path="measurement.html"><a href="measurement.html#handling-missing-data-in-r"><i class="fa fa-check"></i><b>4.2.1</b> Handling Missing Data in R</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="measurement.html"><a href="measurement.html#visualizing-the-univariate-distribution"><i class="fa fa-check"></i><b>4.3</b> Visualizing the Univariate Distribution</a><ul>
<li class="chapter" data-level="4.3.1" data-path="measurement.html"><a href="measurement.html#barplot"><i class="fa fa-check"></i><b>4.3.1</b> Barplot</a></li>
<li class="chapter" data-level="4.3.2" data-path="measurement.html"><a href="measurement.html#boxplot"><i class="fa fa-check"></i><b>4.3.2</b> Boxplot</a></li>
<li class="chapter" data-level="4.3.3" data-path="measurement.html"><a href="measurement.html#printing-and-saving-graphics"><i class="fa fa-check"></i><b>4.3.3</b> Printing and saving graphics</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="measurement.html"><a href="measurement.html#survey-sampling"><i class="fa fa-check"></i><b>4.4</b> Survey Sampling</a><ul>
<li class="chapter" data-level="4.4.1" data-path="measurement.html"><a href="measurement.html#the-role-of-randomization"><i class="fa fa-check"></i><b>4.4.1</b> The Role of Randomization</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="measurement.html"><a href="measurement.html#load-village-data"><i class="fa fa-check"></i><b>4.5</b> load village data</a><ul>
<li class="chapter" data-level="4.5.1" data-path="measurement.html"><a href="measurement.html#non-response-and-other-sources-of-bias"><i class="fa fa-check"></i><b>4.5.1</b> Non-response and other sources of bias</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="measurement.html"><a href="measurement.html#measuring-political-polarization"><i class="fa fa-check"></i><b>4.6</b> Measuring Political Polarization</a><ul>
<li class="chapter" data-level="4.6.1" data-path="measurement.html"><a href="measurement.html#correlation"><i class="fa fa-check"></i><b>4.6.1</b> Correlation</a></li>
<li class="chapter" data-level="4.6.2" data-path="measurement.html"><a href="measurement.html#quantile-quantile-plot"><i class="fa fa-check"></i><b>4.6.2</b> Quantile-Quantile Plot</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="measurement.html"><a href="measurement.html#clustering"><i class="fa fa-check"></i><b>4.7</b> Clustering</a><ul>
<li class="chapter" data-level="4.7.1" data-path="measurement.html"><a href="measurement.html#matrices"><i class="fa fa-check"></i><b>4.7.1</b> Matrices</a></li>
<li class="chapter" data-level="4.7.2" data-path="measurement.html"><a href="measurement.html#lists"><i class="fa fa-check"></i><b>4.7.2</b> Lists</a></li>
<li class="chapter" data-level="4.7.3" data-path="measurement.html"><a href="measurement.html#k-means-algorithms"><i class="fa fa-check"></i><b>4.7.3</b> k-means algorithms</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="prediction.html"><a href="prediction.html"><i class="fa fa-check"></i><b>5</b> Prediction</a><ul>
<li class="chapter" data-level="5.1" data-path="prediction.html"><a href="prediction.html#prerequisites-2"><i class="fa fa-check"></i><b>5.1</b> Prerequisites</a></li>
<li class="chapter" data-level="5.2" data-path="prediction.html"><a href="prediction.html#loops-in-r"><i class="fa fa-check"></i><b>5.2</b> Loops in R</a></li>
<li class="chapter" data-level="5.3" data-path="prediction.html"><a href="prediction.html#general-conditional-statements-in-r"><i class="fa fa-check"></i><b>5.3</b> General Conditional Statements in R</a></li>
<li class="chapter" data-level="5.4" data-path="prediction.html"><a href="prediction.html#poll-predictions"><i class="fa fa-check"></i><b>5.4</b> Poll Predictions</a></li>
<li class="chapter" data-level="5.5" data-path="prediction.html"><a href="prediction.html#linear-regression"><i class="fa fa-check"></i><b>5.5</b> Linear Regression</a><ul>
<li class="chapter" data-level="5.5.1" data-path="prediction.html"><a href="prediction.html#facial-appearance-and-election-outcomes"><i class="fa fa-check"></i><b>5.5.1</b> Facial Appearance and Election Outcomes</a></li>
<li class="chapter" data-level="5.5.2" data-path="prediction.html"><a href="prediction.html#correlation-1"><i class="fa fa-check"></i><b>5.5.2</b> Correlation</a></li>
<li class="chapter" data-level="5.5.3" data-path="prediction.html"><a href="prediction.html#least-squares"><i class="fa fa-check"></i><b>5.5.3</b> Least Squares</a></li>
<li class="chapter" data-level="5.5.4" data-path="prediction.html"><a href="prediction.html#regresion-towards-the-mean"><i class="fa fa-check"></i><b>5.5.4</b> Regresion towards the mean</a></li>
<li class="chapter" data-level="5.5.5" data-path="prediction.html"><a href="prediction.html#merging-data-sets-in-r"><i class="fa fa-check"></i><b>5.5.5</b> Merging Data Sets in R</a></li>
<li class="chapter" data-level="5.5.6" data-path="prediction.html"><a href="prediction.html#model-fit"><i class="fa fa-check"></i><b>5.5.6</b> Model Fit</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="prediction.html"><a href="prediction.html#regression-and-causation"><i class="fa fa-check"></i><b>5.6</b> Regression and Causation</a><ul>
<li class="chapter" data-level="5.6.1" data-path="prediction.html"><a href="prediction.html#regression-with-multiple-predictors"><i class="fa fa-check"></i><b>5.6.1</b> Regression with multiple predictors</a></li>
<li class="chapter" data-level="5.6.2" data-path="prediction.html"><a href="prediction.html#heterogenous-treatment-effects"><i class="fa fa-check"></i><b>5.6.2</b> Heterogenous Treatment Effects</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="prediction.html"><a href="prediction.html#regression-discontinuity-design"><i class="fa fa-check"></i><b>5.7</b> Regression Discontinuity Design</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="discovery.html"><a href="discovery.html"><i class="fa fa-check"></i><b>6</b> Discovery</a><ul>
<li class="chapter" data-level="6.1" data-path="discovery.html"><a href="discovery.html#prerequisites-3"><i class="fa fa-check"></i><b>6.1</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="probability.html"><a href="probability.html"><i class="fa fa-check"></i><b>7</b> Probability</a><ul>
<li class="chapter" data-level="7.1" data-path="probability.html"><a href="probability.html#prerequisites-4"><i class="fa fa-check"></i><b>7.1</b> Prerequisites</a></li>
<li class="chapter" data-level="7.2" data-path="probability.html"><a href="probability.html#probability-1"><i class="fa fa-check"></i><b>7.2</b> Probability</a><ul>
<li class="chapter" data-level="7.2.1" data-path="probability.html"><a href="probability.html#sampling-without-replacement"><i class="fa fa-check"></i><b>7.2.1</b> Sampling without replacement</a></li>
<li class="chapter" data-level="7.2.2" data-path="probability.html"><a href="probability.html#combinations"><i class="fa fa-check"></i><b>7.2.2</b> Combinations</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="probability.html"><a href="probability.html#conditional-probability"><i class="fa fa-check"></i><b>7.3</b> Conditional Probability</a><ul>
<li class="chapter" data-level="7.3.1" data-path="probability.html"><a href="probability.html#conditional-marginal-and-joint-probabilities"><i class="fa fa-check"></i><b>7.3.1</b> Conditional, Marginal, and Joint Probabilities</a></li>
<li class="chapter" data-level="7.3.2" data-path="probability.html"><a href="probability.html#independence"><i class="fa fa-check"></i><b>7.3.2</b> Independence</a></li>
<li class="chapter" data-level="7.3.3" data-path="probability.html"><a href="probability.html#predicting-race-using-surname-and-residence-location"><i class="fa fa-check"></i><b>7.3.3</b> Predicting Race Using Surname and Residence Location</a></li>
<li class="chapter" data-level="7.3.4" data-path="probability.html"><a href="probability.html#predicting-election-outcomes-with-uncertainty"><i class="fa fa-check"></i><b>7.3.4</b> Predicting Election Outcomes with Uncertainty</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="probability.html"><a href="probability.html#large-sample-theorems"><i class="fa fa-check"></i><b>7.4</b> Large Sample Theorems</a><ul>
<li class="chapter" data-level="7.4.1" data-path="probability.html"><a href="probability.html#law-of-large-numbers"><i class="fa fa-check"></i><b>7.4.1</b> Law of Large Numbers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>8</b> Uncertainty</a><ul>
<li class="chapter" data-level="8.1" data-path="uncertainty.html"><a href="uncertainty.html#prerequisites-5"><i class="fa fa-check"></i><b>8.1</b> Prerequisites</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">QSS Tidyverse Code</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="prediction" class="section level1">
<h1><span class="header-section-number">5</span> Prediction</h1>
<div id="prerequisites-2" class="section level2">
<h2><span class="header-section-number">5.1</span> Prerequisites</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)</code></pre></div>
<p>The packages <a href="https://cran.r-project.org/package=modelr">modelr</a> and <a href="https://cran.r-project.org/package=broom">broom</a> are used to wrangle the results of linear regressions,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;broom&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;modelr&quot;</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: &#39;modelr&#39;</span>
<span class="co">#&gt; The following object is masked from &#39;package:broom&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     bootstrap</span></code></pre></div>
</div>
<div id="loops-in-r" class="section level2">
<h2><span class="header-section-number">5.2</span> Loops in R</h2>
<p>For more on looping and iteration in R see the <em>R for Data Science</em> chapter <a href="http://r4ds.had.co.nz/data-visualisation.html">Iteration</a>.</p>
<p>RStudio provides many features to help debugging, which will be useful in for loops and function: see <a href="https://support.rstudio.com/hc/en-us/articles/205612627-Debugging-with-RStudio">this</a> article for an example.</p>
</div>
<div id="general-conditional-statements-in-r" class="section level2">
<h2><span class="header-section-number">5.3</span> General Conditional Statements in R</h2>
<p><strong>TODO</strong> Is this in R4DS, find good cites.</p>
<p>If you are using conditional statements to assign values for data frame, see the <strong>dplyr</strong> functions <a href="https://www.rdocumentation.org/packages/dplyr/topics/if_else">if_else</a>, <a href="https://www.rdocumentation.org/packages/dplyr/topics/recode">recode</a>, and <a href="https://www.rdocumentation.org/packages/dplyr/topics/case_when">case_when</a></p>
</div>
<div id="poll-predictions" class="section level2">
<h2><span class="header-section-number">5.4</span> Poll Predictions</h2>
<p>Load the election polls and election results for 2008,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polls08 &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">qss_data_url</span>(<span class="st">&quot;UNCERTAINTY&quot;</span>, <span class="st">&quot;polls08.csv&quot;</span>))
<span class="kw">glimpse</span>(polls08)
<span class="co">#&gt; Observations: 1,332</span>
<span class="co">#&gt; Variables: 5</span>
<span class="co">#&gt; $ state    &lt;chr&gt; &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;,...</span>
<span class="co">#&gt; $ Pollster &lt;chr&gt; &quot;SurveyUSA-2&quot;, &quot;Capital Survey-2&quot;, &quot;SurveyUSA-2&quot;, &quot;Ca...</span>
<span class="co">#&gt; $ Obama    &lt;int&gt; 36, 34, 35, 35, 39, 34, 36, 25, 35, 34, 37, 36, 36, 3...</span>
<span class="co">#&gt; $ McCain   &lt;int&gt; 61, 54, 62, 55, 60, 64, 58, 52, 55, 47, 55, 51, 49, 5...</span>
<span class="co">#&gt; $ middate  &lt;date&gt; 2008-10-27, 2008-10-15, 2008-10-08, 2008-10-06, 2008...</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pres08 &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">qss_data_url</span>(<span class="st">&quot;UNCERTAINTY&quot;</span>, <span class="st">&quot;pres08.csv&quot;</span>))
<span class="kw">glimpse</span>(pres08)
<span class="co">#&gt; Observations: 51</span>
<span class="co">#&gt; Variables: 5</span>
<span class="co">#&gt; $ state.name &lt;chr&gt; &quot;Alabama&quot;, &quot;Alaska&quot;, &quot;Arizona&quot;, &quot;Arkansas&quot;, &quot;Califo...</span>
<span class="co">#&gt; $ state      &lt;chr&gt; &quot;AL&quot;, &quot;AK&quot;, &quot;AZ&quot;, &quot;AR&quot;, &quot;CA&quot;, &quot;CO&quot;, &quot;CT&quot;, &quot;DC&quot;, &quot;DE...</span>
<span class="co">#&gt; $ Obama      &lt;int&gt; 39, 38, 45, 39, 61, 54, 61, 92, 62, 51, 47, 72, 36,...</span>
<span class="co">#&gt; $ McCain     &lt;int&gt; 60, 59, 54, 59, 37, 45, 38, 7, 37, 48, 52, 27, 62, ...</span>
<span class="co">#&gt; $ EV         &lt;int&gt; 9, 3, 10, 6, 55, 9, 7, 3, 3, 27, 15, 4, 4, 21, 11, ...</span></code></pre></div>
<p>Compute Obama’s margin in polls and final election</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polls08 &lt;-
<span class="st">  </span>polls08 %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">margin =</span> Obama -<span class="st"> </span>McCain)
pres08 &lt;-<span class="st"> </span>
<span class="st">  </span>pres08 %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">margin =</span> Obama -<span class="st"> </span>McCain)</code></pre></div>
<p>To work with dates, the R package <a href="https://cran.r-project.org/package=lubridate">lubridate</a> makes wrangling them much easier. See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/dates-and-times.html">Dates and Times</a>.</p>
<p>The function <a href="https://www.rdocumentation.org/packages/lubridate/topics/ymd">ymd</a> will convert character strings like <code>year-month-day</code> and more into dates, as long as the order is (year, month, day). See <a href="https://www.rdocumentation.org/packages/lubridate/topics/dmy">dmy</a>, <a href="https://www.rdocumentation.org/packages/lubridate/topics/ymd">ymd</a>, and others for other ways to convert strings to dates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="st">&quot;2008-11-04&quot;</span>)
y &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="st">&quot;2008/9/1&quot;</span>)
x -<span class="st"> </span>y
<span class="co">#&gt; Time difference of 64 days</span></code></pre></div>
<p>However, note that in <code>polls08</code>, the date <code>middate</code> is <em>already</em> a <code>date</code> object,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(polls08$middate)
<span class="co">#&gt; [1] &quot;Date&quot;</span></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/readr/topics/read_csv">read_csv</a> by default will check character vectors to see if they have patterns that appear to be dates, and if so, will parse those columns as dates.</p>
<p>We’ll create a variable for election day</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ELECTION_DAY &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="st">&quot;2008-11-04&quot;</span>)</code></pre></div>
<p>and add a new column to <code>poll08</code> with the days to the election</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polls08 &lt;-
<span class="st">  </span><span class="kw">mutate</span>(polls08, ELECTION_DAY -<span class="st"> </span>middate)</code></pre></div>
<p>Although the code in the chapter uses a <code>for</code> loop, there is no reason to do so. We can accomplish the same task by merging the election results data to the polling data by <code>state</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polls_w_results &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(polls08,
            <span class="kw">select</span>(pres08, state, <span class="dt">elec_margin =</span> margin),
            <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">error =</span> elec_margin -<span class="st"> </span>margin)
<span class="kw">glimpse</span>(polls_w_results)
<span class="co">#&gt; Observations: 1,332</span>
<span class="co">#&gt; Variables: 9</span>
<span class="co">#&gt; $ state                  &lt;chr&gt; &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL...</span>
<span class="co">#&gt; $ Pollster               &lt;chr&gt; &quot;SurveyUSA-2&quot;, &quot;Capital Survey-2&quot;, &quot;Sur...</span>
<span class="co">#&gt; $ Obama                  &lt;int&gt; 36, 34, 35, 35, 39, 34, 36, 25, 35, 34,...</span>
<span class="co">#&gt; $ McCain                 &lt;int&gt; 61, 54, 62, 55, 60, 64, 58, 52, 55, 47,...</span>
<span class="co">#&gt; $ middate                &lt;date&gt; 2008-10-27, 2008-10-15, 2008-10-08, 20...</span>
<span class="co">#&gt; $ margin                 &lt;int&gt; -25, -20, -27, -20, -21, -30, -22, -27,...</span>
<span class="co">#&gt; $ ELECTION_DAY - middate &lt;time&gt; 8 days, 20 days, 27 days, 29 days, 43 ...</span>
<span class="co">#&gt; $ elec_margin            &lt;int&gt; -21, -21, -21, -21, -21, -21, -21, -21,...</span>
<span class="co">#&gt; $ error                  &lt;int&gt; 4, -1, 6, -1, 0, 9, 1, 6, -1, -8, -3, -...</span></code></pre></div>
<p>To get the last poll in each state, arrange and filter on middate</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls &lt;-<span class="st"> </span>
<span class="st">  </span>polls_w_results %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(state, <span class="kw">desc</span>(middate)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(state) %&gt;%
<span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span>)
last_polls
<span class="co">#&gt; Source: local data frame [51 x 9]</span>
<span class="co">#&gt; Groups: state [51]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   state        Pollster Obama McCain    middate margin</span>
<span class="co">#&gt;   &lt;chr&gt;           &lt;chr&gt; &lt;int&gt;  &lt;int&gt;     &lt;date&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1    AK Research 2000-3    39     58 2008-10-29    -19</span>
<span class="co">#&gt; 2    AL     SurveyUSA-2    36     61 2008-10-27    -25</span>
<span class="co">#&gt; 3    AR           ARG-4    44     51 2008-10-29     -7</span>
<span class="co">#&gt; 4    AZ           ARG-3    46     50 2008-10-29     -4</span>
<span class="co">#&gt; 5    CA     SurveyUSA-3    60     36 2008-10-30     24</span>
<span class="co">#&gt; 6    CO           ARG-3    52     45 2008-10-29      7</span>
<span class="co">#&gt; # ... with 45 more rows, and 3 more variables: `ELECTION_DAY -</span>
<span class="co">#&gt; #   middate` &lt;time&gt;, elec_margin &lt;int&gt;, error &lt;int&gt;</span></code></pre></div>
<p><strong>Challenge:</strong> Instead of using the last poll, use the average of polls in the last week? Last month? How do the margins on the polls change over the election period?</p>
<p>To simplify things for later, let’s define a function <code>rmse</code> which calculates the root mean squared error, as defined in the book. See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/functions.html">Functions</a> for more on writing functions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rmse &lt;-<span class="st"> </span>function(actual, pred) {
  <span class="kw">sqrt</span>(<span class="kw">mean</span>((actual -<span class="st"> </span>pred) ^<span class="st"> </span><span class="dv">2</span>))
}</code></pre></div>
<p>Now we can use <code>rmse()</code> to calculate the RMSE for all the final polls:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rmse</span>(last_polls$margin, last_polls$elec_margin)
<span class="co">#&gt; [1] 5.88</span></code></pre></div>
<p>Or since we already have a variable <code>error</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sqrt</span>(<span class="kw">mean</span>(last_polls$error ^<span class="st"> </span><span class="dv">2</span>))
<span class="co">#&gt; [1] 5.88</span></code></pre></div>
<p>The mean prediction error is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(last_polls$error)
<span class="co">#&gt; [1] 1.08</span></code></pre></div>
<p>This is slightly different than what is in the book due to the difference in the poll used as the final poll; many states have many polls on the last day.</p>
<p>I’ll choose binwidths of 1%, since that is fairly interpretable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(last_polls, <span class="kw">aes</span>(<span class="dt">x =</span> error)) +
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">boundary =</span> <span class="dv">0</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-14-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The text uses bindwidths of 5%:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(last_polls, <span class="kw">aes</span>(<span class="dt">x =</span> error)) +
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">5</span>, <span class="dt">boundary =</span> <span class="dv">0</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-15-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><strong>Challenge:</strong> What other ways could you visualize the results? How would you show all states? What about plotting the absolute or squared errors instead of the errors?</p>
<p><strong>Challenge:</strong> What happens to prediction error if you average polls? Consider averaging back over time? What happens if you take the averages of the state poll average and average of <strong>all</strong> polls - does that improve prediction?</p>
<p>To create a scatterplot using the state abbreviations instead of points use <a href="http://docs.ggplot2.org/current/geom_text.html">geom_text</a> instead of <a href="http://docs.ggplot2.org/current/geom_point.html">geom_point</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(last_polls, <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> elec_margin, <span class="dt">label =</span> state)) +
<span class="st">  </span><span class="kw">geom_text</span>() +
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">col =</span> <span class="st">&quot;red&quot;</span>) +
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) +
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>) +
<span class="st">  </span><span class="kw">coord_fixed</span>() +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Poll Results&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Actual Election Results&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-16-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We can create a confusion matrix as follow.</p>
<p>Create a new columns <code>classification</code> which shows whether how the poll’s classification was related to the actual election outcome (“true positive”, “false positive”, “false negative”, “false positive”). This can be accomplished easily with the <a href="https://cran.r-project.org/package=dplyr">dplyr</a> funtion <a href="https://www.rdocumentation.org/packages/dplyr/topics/case_when">case_when</a>. <em>Note:</em> You need to use <code>.</code> to refer to the data frame when using <code>case_when</code> with a <code>mutate</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls &lt;-
<span class="st">  </span>last_polls %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">classification =</span> 
           <span class="kw">case_when</span>(
             (.$margin &gt;<span class="st"> </span><span class="dv">0</span> &amp;<span class="st"> </span>.$elec_margin &gt;<span class="st"> </span><span class="dv">0</span>) ~<span class="st"> &quot;true positive&quot;</span>,
             (.$margin &gt;<span class="st"> </span><span class="dv">0</span> &amp;<span class="st"> </span>.$elec_margin &lt;<span class="st"> </span><span class="dv">0</span>) ~<span class="st"> &quot;false positive&quot;</span>,
             (.$margin &lt;<span class="st"> </span><span class="dv">0</span> &amp;<span class="st"> </span>.$elec_margin &lt;<span class="st"> </span><span class="dv">0</span>) ~<span class="st"> &quot;true negative&quot;</span>,
             (.$margin &lt;<span class="st"> </span><span class="dv">0</span> &amp;<span class="st"> </span>.$elec_margin &gt;<span class="st"> </span><span class="dv">0</span>) ~<span class="st"> &quot;false negative&quot;</span>
           ))</code></pre></div>
<p>No simply count the</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(classification) %&gt;%
<span class="st">  </span><span class="kw">count</span>()
<span class="co">#&gt; # A tibble: 4 × 2</span>
<span class="co">#&gt;   classification     n</span>
<span class="co">#&gt;            &lt;chr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 false negative     2</span>
<span class="co">#&gt; 2 false positive     1</span>
<span class="co">#&gt; 3  true negative    21</span>
<span class="co">#&gt; 4  true positive    27</span></code></pre></div>
<p>Which states were incorrectly predicted?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls %&gt;%
<span class="st">  </span><span class="kw">filter</span>(classification %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;false positive&quot;</span>, <span class="st">&quot;false negative&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(state, margin, elec_margin, classification) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(elec_margin))
<span class="co">#&gt; # A tibble: 3 × 4</span>
<span class="co">#&gt;   state margin elec_margin classification</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt;       &lt;int&gt;          &lt;chr&gt;</span>
<span class="co">#&gt; 1    IN     -5           1 false negative</span>
<span class="co">#&gt; 2    NC     -1           1 false negative</span>
<span class="co">#&gt; 3    MO      1          -1 false positive</span></code></pre></div>
<p>What was the difference in the poll prediction of electoral votes and actual electoral votes. We hadn’t included the variable <code>EV</code> when we first merged, but that’s no problem, we’ll just merge again in order to grab that variable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">last_polls %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw">select</span>(pres08, state, EV), <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">EV_pred =</span> <span class="kw">sum</span>((margin &gt;<span class="st"> </span><span class="dv">0</span>) *<span class="st"> </span>EV),
            <span class="dt">EV_actual =</span> <span class="kw">sum</span>((elec_margin &gt;<span class="st"> </span><span class="dv">0</span>) *<span class="st"> </span>EV))
<span class="co">#&gt; # A tibble: 1 × 2</span>
<span class="co">#&gt;   EV_pred EV_actual</span>
<span class="co">#&gt;     &lt;int&gt;     &lt;int&gt;</span>
<span class="co">#&gt; 1     349       364</span></code></pre></div>
<p>To look at predictions of the</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load the data</span>
pollsUS08 &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">qss_data_url</span>(<span class="st">&quot;prediction&quot;</span>, <span class="st">&quot;pollsUS08.csv&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">DaysToElection =</span> ELECTION_DAY -<span class="st"> </span>middate)</code></pre></div>
<p>We’ll produce the seven-day averages slightly differently than the method used in the text. For all dates in the data, we’ll calculate the moving average.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">all_dates &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(polls08$middate), ELECTION_DAY,
                 <span class="dt">by =</span> <span class="st">&quot;days&quot;</span>)

<span class="co"># Number of poll days to use</span>
POLL_DAYS &lt;-<span class="st"> </span><span class="dv">7</span>

pop_vote_avg &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="kw">length</span>(all_dates), <span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>)
for (i in <span class="kw">seq_along</span>(all_dates)) {
  date &lt;-<span class="st"> </span>all_dates[i]
  <span class="co"># summarise the seven day</span>
  week_data &lt;-
<span class="st">     </span>pollsUS08 %&gt;%
<span class="st">     </span><span class="kw">filter</span>(<span class="kw">as.integer</span>(middate -<span class="st"> </span>date) &lt;=<span class="st"> </span><span class="dv">0</span>,
            <span class="kw">as.integer</span>(middate -<span class="st"> </span>date) &gt;<span class="st"> </span>-POLL_DAYS) %&gt;%
<span class="st">     </span><span class="kw">summarise</span>(<span class="dt">Obama =</span> <span class="kw">mean</span>(Obama, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
               <span class="dt">McCain =</span> <span class="kw">mean</span>(McCain, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  <span class="co"># add date for the observation</span>
  week_data$date &lt;-<span class="st"> </span>date
  pop_vote_avg[[i]] &lt;-<span class="st"> </span>week_data
}

pop_vote_avg &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(pop_vote_avg)</code></pre></div>
<p>It is easier to plot this if the data are tidy, with <code>Obama</code> and <code>McCain</code> as categories of a column <code>candidate</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pop_vote_avg_tidy &lt;-
<span class="st">  </span>pop_vote_avg %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(candidate, share, -date, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
pop_vote_avg_tidy
<span class="co">#&gt; # A tibble: 598 × 3</span>
<span class="co">#&gt;         date candidate share</span>
<span class="co">#&gt; *     &lt;date&gt;     &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 2008-01-09     Obama    49</span>
<span class="co">#&gt; 2 2008-01-10     Obama    46</span>
<span class="co">#&gt; 3 2008-01-11     Obama    45</span>
<span class="co">#&gt; 4 2008-01-12     Obama    45</span>
<span class="co">#&gt; 5 2008-01-13     Obama    45</span>
<span class="co">#&gt; 6 2008-01-14     Obama    45</span>
<span class="co">#&gt; # ... with 592 more rows</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(pop_vote_avg_tidy, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> share,
                              <span class="dt">colour =</span> forcats::<span class="kw">fct_reorder2</span>(candidate,
                                                             date, share))) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-24-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><strong>Challenge</strong> read <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/iteration.html#the-map-functions">Iteration</a> and use the function <a href="https://www.rdocumentation.org/packages/purrr/topics/map_df">map_df</a> instead of a for loop.</p>
<p>The 7-day average is similar to the simple method used by <a href="http://www.realclearpolitics.com/epolls/2016/president/us/general_election_trump_vs_clinton-5491.html">Real Clear Politics</a>. The RCP average is simply the average of all polls in their data for the last seven days. Sites like 538 and the Huffington Post on the other hand, also use what amounts to averaging polls, but using more sophisticated statistical methods to assign different weights to different polls.</p>
<p><strong>Challenge</strong> Why do we need to use different polls for the popular vote data? Why not simply average all the state polls? What would you have to do? Would the overall popular vote be useful in predicting state-level polling, or vice-versa? How would you use them?</p>
</div>
<div id="linear-regression" class="section level2">
<h2><span class="header-section-number">5.5</span> Linear Regression</h2>
<div id="facial-appearance-and-election-outcomes" class="section level3">
<h3><span class="header-section-number">5.5.1</span> Facial Appearance and Election Outcomes</h3>
<p>Load the <code>face</code> dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">face &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">qss_data_url</span>(<span class="st">&quot;prediction&quot;</span>, <span class="st">&quot;face.csv&quot;</span>))</code></pre></div>
<p>Add Democrat and Republican vote shares, and the difference in shares:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">face &lt;-
<span class="st">  </span>face %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">d.share =</span> d.votes /<span class="st"> </span>(d.votes +<span class="st"> </span>r.votes),
         <span class="dt">r.share =</span> r.votes /<span class="st"> </span>(d.votes +<span class="st"> </span>r.votes),
         <span class="dt">diff.share =</span> d.share -<span class="st"> </span>r.share)</code></pre></div>
<p>Plot facial competence vs. vote share:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(face, <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share, <span class="dt">colour =</span> w.party)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Competence scores for Democrats&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Democratic margin in vote share&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-25-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="correlation-1" class="section level3">
<h3><span class="header-section-number">5.5.2</span> Correlation</h3>
</div>
<div id="least-squares" class="section level3">
<h3><span class="header-section-number">5.5.3</span> Least Squares</h3>
<p>Run the linear regression</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">lm</span>(diff.share ~<span class="st"> </span>d.comp, <span class="dt">data =</span> face)
<span class="kw">summary</span>(fit)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = diff.share ~ d.comp, data = face)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;    Min     1Q Median     3Q    Max </span>
<span class="co">#&gt; -0.675 -0.166  0.014  0.177  0.743 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)   -0.312      0.066   -4.73  6.2e-06 ***</span>
<span class="co">#&gt; d.comp         0.660      0.127    5.19  8.9e-07 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 0.266 on 117 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.187,  Adjusted R-squared:  0.18 </span>
<span class="co">#&gt; F-statistic:   27 on 1 and 117 DF,  p-value: 8.85e-07</span></code></pre></div>
<p>There are many functions to get data out of the <code>lm</code> model.</p>
<p>In addition to these, the <strong>broom</strong> package provides three functions: <code>glance</code>, <code>tidy</code>, and <code>augment</code> that always return data frames.</p>
<p>The function <a href="https://www.rdocumentation.org/packages/broom/topics/glance.lm">glance</a> returns a one-row data-frame summary of the model,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(fit)
<span class="co">#&gt;   r.squared adj.r.squared sigma statistic  p.value df logLik AIC  BIC</span>
<span class="co">#&gt; 1     0.187          0.18 0.266        27 8.85e-07  2  -10.5  27 35.3</span>
<span class="co">#&gt;   deviance df.residual</span>
<span class="co">#&gt; 1     8.31         117</span></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/broom/topics/tidy.lm">tidy</a> returns a data frame in which each row is a coefficient,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tidy</span>(fit)
<span class="co">#&gt;          term estimate std.error statistic  p.value</span>
<span class="co">#&gt; 1 (Intercept)   -0.312     0.066     -4.73 6.24e-06</span>
<span class="co">#&gt; 2      d.comp    0.660     0.127      5.19 8.85e-07</span></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/broom/topics/augment.lm">augment</a> returns the original data with fitted values, residuals, and other observation level stats from the model appended to it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">augment</span>(fit) %&gt;%<span class="st"> </span><span class="kw">head</span>()
<span class="co">#&gt;   diff.share d.comp .fitted .se.fit  .resid    .hat .sigma  .cooksd</span>
<span class="co">#&gt; 1     0.2101  0.565  0.0606  0.0266  0.1495 0.00996  0.267 0.001600</span>
<span class="co">#&gt; 2     0.1194  0.342 -0.0864  0.0302  0.2059 0.01286  0.267 0.003938</span>
<span class="co">#&gt; 3     0.0499  0.612  0.0922  0.0295 -0.0423 0.01229  0.268 0.000158</span>
<span class="co">#&gt; 4     0.1965  0.542  0.0454  0.0256  0.1511 0.00922  0.267 0.001510</span>
<span class="co">#&gt; 5     0.4958  0.680  0.1370  0.0351  0.3588 0.01737  0.266 0.016307</span>
<span class="co">#&gt; 6    -0.3495  0.321 -0.1006  0.0319 -0.2490 0.01433  0.267 0.006436</span>
<span class="co">#&gt;   .std.resid</span>
<span class="co">#&gt; 1      0.564</span>
<span class="co">#&gt; 2      0.778</span>
<span class="co">#&gt; 3     -0.160</span>
<span class="co">#&gt; 4      0.570</span>
<span class="co">#&gt; 5      1.358</span>
<span class="co">#&gt; 6     -0.941</span></code></pre></div>
<p>We can plot the results of the bivariate linear regression as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> face, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share)) +
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">slope =</span> <span class="kw">coef</span>(fit)[<span class="st">&quot;d.comp&quot;</span>],
              <span class="dt">intercept =</span> <span class="kw">coef</span>(fit)[<span class="st">&quot;(Intercept)&quot;</span>])</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-30-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>A more general way to plot the predictions of the model against the data is to use the methods described in <a href="http://r4ds.had.co.nz/model-basics.html#visualising-models">Ch 23.3.3</a> of R4DS. Create an evenly spaced grid of values of <code>d.comp</code>, and add predictions of the model to it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grid &lt;-<span class="st"> </span>face %&gt;%
<span class="st">  </span><span class="kw">data_grid</span>(d.comp) %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(fit)
<span class="kw">head</span>(grid)
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   d.comp   pred</span>
<span class="co">#&gt;    &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 0.0640 -0.270</span>
<span class="co">#&gt; 2 0.0847 -0.256</span>
<span class="co">#&gt; 3 0.0893 -0.253</span>
<span class="co">#&gt; 4 0.1145 -0.237</span>
<span class="co">#&gt; 5 0.1148 -0.236</span>
<span class="co">#&gt; 6 0.1639 -0.204</span></code></pre></div>
<p>Now we can plot the regression line and the original data just like any other plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> face, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share)) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> grid, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> pred))</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-32-1.png" width="70%" style="display: block; margin: auto;" /> This method is more complicated than the <code>geom_abline</code> method for a bivariate regerssion, but will work for more complicated models, while the <code>geom_abline</code> method won’t.</p>
<p>Note that <a href="http://docs.ggplot2.org/current/geom_smooth.html">geom_smooth</a> can be used to add a regression line to a data-set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> face, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-33-1.png" width="70%" style="display: block; margin: auto;" /> The argument <code>method = &quot;lm&quot;</code> specifies that the function <code>lm</code> is to be used to generate fitted values. It is equivalent to running the regression <code>lm(y ~ x)</code> and plotting the regression line, where <code>y</code> and <code>x</code> are the aesthetics specified by the mappings. The argument <code>se = FALSE</code> tells the function not to plot the confidence interval of the regresion (discussed later).</p>
</div>
<div id="regresion-towards-the-mean" class="section level3">
<h3><span class="header-section-number">5.5.4</span> Regresion towards the mean</h3>
</div>
<div id="merging-data-sets-in-r" class="section level3">
<h3><span class="header-section-number">5.5.5</span> Merging Data Sets in R</h3>
<p>See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/relational-data.html">Relational data</a>.</p>
<p>Merge - or intter join the data frames by state:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pres12 &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">qss_data_url</span>(<span class="st">&quot;prediction&quot;</span>, <span class="st">&quot;pres12.csv&quot;</span>))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">full_join</span>(pres08, pres12, <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>)
<span class="co">#&gt; # A tibble: 51 × 9</span>
<span class="co">#&gt;   state.name state Obama.x McCain  EV.x margin Obama.y Romney  EV.y</span>
<span class="co">#&gt;        &lt;chr&gt; &lt;chr&gt;   &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt;  &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1    Alabama    AL      39     60     9    -21      38     61     9</span>
<span class="co">#&gt; 2     Alaska    AK      38     59     3    -21      41     55     3</span>
<span class="co">#&gt; 3    Arizona    AZ      45     54    10     -9      45     54    11</span>
<span class="co">#&gt; 4   Arkansas    AR      39     59     6    -20      37     61     6</span>
<span class="co">#&gt; 5 California    CA      61     37    55     24      60     37    55</span>
<span class="co">#&gt; 6   Colorado    CO      54     45     9      9      51     46     9</span>
<span class="co">#&gt; # ... with 45 more rows</span></code></pre></div>
<p><em>Note: this could be a question. How would you change the .x, .y suffixes to something more informative</em> To avoid the duplicate names, or change them, you can rename before merging, or use the <code>suffix</code> argument:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pres &lt;-<span class="st"> </span><span class="kw">full_join</span>(pres08, pres12, <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;_08&quot;</span>, <span class="st">&quot;_12&quot;</span>))
pres
<span class="co">#&gt; # A tibble: 51 × 9</span>
<span class="co">#&gt;   state.name state Obama_08 McCain EV_08 margin Obama_12 Romney EV_12</span>
<span class="co">#&gt;        &lt;chr&gt; &lt;chr&gt;    &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt;    &lt;int&gt;  &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1    Alabama    AL       39     60     9    -21       38     61     9</span>
<span class="co">#&gt; 2     Alaska    AK       38     59     3    -21       41     55     3</span>
<span class="co">#&gt; 3    Arizona    AZ       45     54    10     -9       45     54    11</span>
<span class="co">#&gt; 4   Arkansas    AR       39     59     6    -20       37     61     6</span>
<span class="co">#&gt; 5 California    CA       61     37    55     24       60     37    55</span>
<span class="co">#&gt; 6   Colorado    CO       54     45     9      9       51     46     9</span>
<span class="co">#&gt; # ... with 45 more rows</span></code></pre></div>
<p>The <strong>dplyr</strong> equivalent functions for <a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a> is <a href="https://www.rdocumentation.org/packages/dplyr/topics/bind_cols">bind_cols</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pres &lt;-<span class="st"> </span>pres %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Obama2008.z =</span> <span class="kw">scale</span>(Obama_08),
         <span class="dt">Obama2012.z =</span> <span class="kw">scale</span>(Obama_12))</code></pre></div>
<p>Scatterplot of states with vote shares in 2008 and 2012</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(pres, <span class="kw">aes</span>(<span class="dt">x =</span> Obama2008.z, <span class="dt">y =</span> Obama2012.z, <span class="dt">label =</span> state)) +
<span class="st">  </span><span class="kw">geom_text</span>() +
<span class="st">  </span><span class="kw">geom_abline</span>() +
<span class="st">  </span><span class="kw">coord_fixed</span>() +
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Obama&#39;s standardized vote share in 2008&quot;</span>,
                     <span class="dt">limits =</span> <span class="kw">c</span>(-<span class="dv">4</span>, <span class="dv">4</span>)) +<span class="st">  </span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Obama&#39;s standardized vote share in 2012&quot;</span>,
                     <span class="dt">limits =</span> <span class="kw">c</span>(-<span class="dv">4</span>, <span class="dv">4</span>))</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-37-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>To calcualte the bottom and top quartiles</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pres %&gt;%
<span class="st">  </span><span class="kw">filter</span>(Obama2008.z &lt;<span class="st"> </span><span class="kw">quantile</span>(Obama2008.z, <span class="fl">0.25</span>)) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">improve =</span> <span class="kw">mean</span>(Obama2012.z &gt;<span class="st"> </span>Obama2008.z))
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;   improve</span>
<span class="co">#&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1   0.583</span>

pres %&gt;%
<span class="st">  </span><span class="kw">filter</span>(Obama2008.z &lt;<span class="st"> </span><span class="kw">quantile</span>(Obama2008.z, <span class="fl">0.75</span>)) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">improve =</span> <span class="kw">mean</span>(Obama2012.z &gt;<span class="st"> </span>Obama2008.z))
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;   improve</span>
<span class="co">#&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1     0.5</span></code></pre></div>
<p><strong>Challenge:</strong> Why is it important to standardize the vote shares?</p>
</div>
<div id="model-fit" class="section level3">
<h3><span class="header-section-number">5.5.6</span> Model Fit</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">florida &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">qss_data_url</span>(<span class="st">&quot;prediction&quot;</span>, <span class="st">&quot;florida.csv&quot;</span>))
<span class="co">#&gt; Parsed with column specification:</span>
<span class="co">#&gt; cols(</span>
<span class="co">#&gt;   county = col_character(),</span>
<span class="co">#&gt;   Clinton96 = col_integer(),</span>
<span class="co">#&gt;   Dole96 = col_integer(),</span>
<span class="co">#&gt;   Perot96 = col_integer(),</span>
<span class="co">#&gt;   Bush00 = col_integer(),</span>
<span class="co">#&gt;   Gore00 = col_integer(),</span>
<span class="co">#&gt;   Buchanan00 = col_integer()</span>
<span class="co">#&gt; )</span>
fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(Buchanan00 ~<span class="st"> </span>Perot96, <span class="dt">data =</span> florida)
<span class="kw">summary</span>(fit2)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = Buchanan00 ~ Perot96, data = florida)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;    Min     1Q Median     3Q    Max </span>
<span class="co">#&gt; -612.7  -66.0    1.9   32.9 2301.7 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)  1.34575   49.75931    0.03     0.98    </span>
<span class="co">#&gt; Perot96      0.03592    0.00434    8.28  9.5e-12 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 316 on 65 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.513,  Adjusted R-squared:  0.506 </span>
<span class="co">#&gt; F-statistic: 68.5 on 1 and 65 DF,  p-value: 9.47e-12</span></code></pre></div>
<p>In addition to,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(fit2)$r.squared
<span class="co">#&gt; [1] 0.513</span></code></pre></div>
<p>we can get the R2 squared value from the data frame <a href="https://www.rdocumentation.org/packages/broom/topics/glance.lm">glance</a> returns:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(fit2)
<span class="co">#&gt;   r.squared adj.r.squared sigma statistic  p.value df logLik AIC BIC</span>
<span class="co">#&gt; 1     0.513         0.506   316      68.5 9.47e-12  2   -480 966 972</span>
<span class="co">#&gt;   deviance df.residual</span>
<span class="co">#&gt; 1  6506118          65</span></code></pre></div>
<p>We can get predictions and residuals on the original data frame using the <a href="https://cran.r-project.org/package=modelr">modelr</a> functions <a href="https://www.rdocumentation.org/packages/modelr/topics/add_residuals">add_residuals</a> and <a href="https://www.rdocumentation.org/packages/modelr/topics/add_predictions">add_predictions</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">florida &lt;-
<span class="st">  </span>florida %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(fit2) %&gt;%
<span class="st">  </span><span class="kw">add_residuals</span>(fit2)
<span class="kw">glimpse</span>(florida)
<span class="co">#&gt; Observations: 67</span>
<span class="co">#&gt; Variables: 9</span>
<span class="co">#&gt; $ county     &lt;chr&gt; &quot;Alachua&quot;, &quot;Baker&quot;, &quot;Bay&quot;, &quot;Bradford&quot;, &quot;Brevard&quot;, &quot;...</span>
<span class="co">#&gt; $ Clinton96  &lt;int&gt; 40144, 2273, 17020, 3356, 80416, 320736, 1794, 2712...</span>
<span class="co">#&gt; $ Dole96     &lt;int&gt; 25303, 3684, 28290, 4038, 87980, 142834, 1717, 2783...</span>
<span class="co">#&gt; $ Perot96    &lt;int&gt; 8072, 667, 5922, 819, 25249, 38964, 630, 7783, 7244...</span>
<span class="co">#&gt; $ Bush00     &lt;int&gt; 34124, 5610, 38637, 5414, 115185, 177323, 2873, 354...</span>
<span class="co">#&gt; $ Gore00     &lt;int&gt; 47365, 2392, 18850, 3075, 97318, 386561, 2155, 2964...</span>
<span class="co">#&gt; $ Buchanan00 &lt;int&gt; 263, 73, 248, 65, 570, 788, 90, 182, 270, 186, 122,...</span>
<span class="co">#&gt; $ pred       &lt;dbl&gt; 291.3, 25.3, 214.0, 30.8, 908.2, 1400.7, 24.0, 280....</span>
<span class="co">#&gt; $ resid      &lt;dbl&gt; -2.83e+01, 4.77e+01, 3.40e+01, 3.42e+01, -3.38e+02,...</span></code></pre></div>
<p>There are now two new columns in <code>florida</code>, <code>pred</code> with the fitted values (predictions), and <code>resid</code> with the residuals.</p>
<p>Use <code>fit2_augment</code> to create a residual plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit2_resid_plot &lt;-
<span class="st">  </span><span class="kw">ggplot</span>(florida, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> resid)) +
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="dv">0</span>) +
<span class="st">  </span><span class="kw">geom_point</span>() +<span class="st">  </span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Fitted values&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;residuals&quot;</span>)
fit2_resid_plot</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-43-1.png" width="70%" style="display: block; margin: auto;" /> Note, we use the function <a href="https://www.rdocumentation.org/packages/modelr/topics/geom_refline">geom_refline</a> to add a reference line at 0.</p>
<p>Let’s add some labels to points, who is that outlier?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit2_resid_plot +
<span class="st">  </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">label =</span> county))</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-44-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The outlier county is “Palm Beach”</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">arrange</span>(florida) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(<span class="kw">abs</span>(resid))) %&gt;%
<span class="st">  </span><span class="kw">select</span>(county, resid) %&gt;%
<span class="st">  </span><span class="kw">head</span>()
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;       county resid</span>
<span class="co">#&gt;        &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1  PalmBeach  2302</span>
<span class="co">#&gt; 2    Broward  -613</span>
<span class="co">#&gt; 3        Lee  -357</span>
<span class="co">#&gt; 4    Brevard  -338</span>
<span class="co">#&gt; 5 Miami-Dade  -329</span>
<span class="co">#&gt; 6   Pinellas  -317</span></code></pre></div>
<div class="figure">
<img src="images/hanging-chad.png" alt="Ted Mosby dressed as a Hanging Chad in How I Met Your Mother" />
<p class="caption">Ted Mosby dressed as a Hanging Chad in “How I Met Your Mother”</p>
</div>
<p>Data without Palm Beach</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">florida_pb &lt;-<span class="st"> </span><span class="kw">filter</span>(florida, county !=<span class="st"> &quot;PalmBeach&quot;</span>)
fit3 &lt;-<span class="st"> </span><span class="kw">lm</span>(Buchanan00 ~<span class="st"> </span>Perot96, <span class="dt">data =</span> florida_pb)
<span class="kw">summary</span>(fit3)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = Buchanan00 ~ Perot96, data = florida_pb)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;    Min     1Q Median     3Q    Max </span>
<span class="co">#&gt; -206.7  -43.5  -16.0   26.9  269.0 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept) 45.84193   13.89275     3.3   0.0016 ** </span>
<span class="co">#&gt; Perot96      0.02435    0.00127    19.1   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 87.7 on 64 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.851,  Adjusted R-squared:  0.849 </span>
<span class="co">#&gt; F-statistic:  366 on 1 and 64 DF,  p-value: &lt;2e-16</span></code></pre></div>
<p><span class="math inline">\(R^2\)</span> or coefficient of determination</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(fit3)
<span class="co">#&gt;   r.squared adj.r.squared sigma statistic  p.value df logLik AIC BIC</span>
<span class="co">#&gt; 1     0.851         0.849  87.7       366 3.61e-28  2   -388 782 788</span>
<span class="co">#&gt;   deviance df.residual</span>
<span class="co">#&gt; 1   492803          64</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">florida_pb %&gt;%
<span class="st">  </span><span class="kw">add_residuals</span>(fit3) %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(fit3) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> resid)) +
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="dv">0</span>) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">ylim</span>(-<span class="dv">750</span>, <span class="dv">2500</span>) +
<span class="st">  </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="dv">1500</span>) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Fitted values&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;residuals&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-48-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Create predictions for both models using <a href="https://www.rdocumentation.org/packages/modelr/topics/data_grid">data_grid</a> and <a href="https://www.rdocumentation.org/packages/modelr/topics/gather_predictions">gather_predictions</a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">florida_grid &lt;-
<span class="st">  </span>florida %&gt;%
<span class="st">  </span><span class="kw">data_grid</span>(Perot96) %&gt;%
<span class="st">  </span><span class="kw">gather_predictions</span>(fit2, fit3) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span>
           <span class="kw">fct_recode</span>(model,
                      <span class="st">&quot;Regression</span><span class="ch">\n</span><span class="st"> with Palm Beach&quot;</span> =<span class="st"> &quot;fit2&quot;</span>,
                      <span class="st">&quot;Regression</span><span class="ch">\n</span><span class="st"> without Palm Beach&quot;</span> =<span class="st"> &quot;fit3&quot;</span>))</code></pre></div>
<p>Note this is an example of using non-syntactic column names in a tibble, as discussed in Chapter 10 of <a href="http://r4ds.had.co.nz/tibbles.html">R for data science</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> florida, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Perot96, <span class="dt">y =</span> Buchanan00)) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> florida_grid, 
             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Perot96, <span class="dt">y =</span> pred, 
                           <span class="dt">colour =</span> model)) +
<span class="st">  </span><span class="kw">geom_label</span>(<span class="dt">data =</span> <span class="kw">filter</span>(florida, county ==<span class="st"> &quot;PalmBeach&quot;</span>),
             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Perot96, <span class="dt">y =</span> Buchanan00, <span class="dt">label =</span> county),
                           <span class="dt">vjust =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">hjust =</span> <span class="st">&quot;right&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> <span class="kw">tibble</span>(<span class="dt">label =</span> <span class="kw">unique</span>(florida_grid$model),
                           <span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">20000</span>, <span class="dv">31000</span>),
                           <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">300</span>)),
             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> label, <span class="dt">colour =</span> label)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Perot&#39;s Vote in 1996&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Buchanan&#39;s Votes in 1996&quot;</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-50-1.png" width="70%" style="display: block; margin: auto;" /> See <a href="http://r4ds.had.co.nz/graphics-for-communication.html#label">Graphics for communication</a> in <em>R for Data Science</em> on labels and annotations in plots.</p>
</div>
</div>
<div id="regression-and-causation" class="section level2">
<h2><span class="header-section-number">5.6</span> Regression and Causation</h2>
<p>Load data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">women &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">qss_data_url</span>(<span class="st">&quot;prediction&quot;</span>, <span class="st">&quot;women.csv&quot;</span>))
<span class="co">#&gt; Parsed with column specification:</span>
<span class="co">#&gt; cols(</span>
<span class="co">#&gt;   GP = col_integer(),</span>
<span class="co">#&gt;   village = col_integer(),</span>
<span class="co">#&gt;   reserved = col_integer(),</span>
<span class="co">#&gt;   female = col_integer(),</span>
<span class="co">#&gt;   irrigation = col_integer(),</span>
<span class="co">#&gt;   water = col_integer()</span>
<span class="co">#&gt; )</span></code></pre></div>
<p>proportion of female politicians in reserved GP vs. unreserved GP</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">women %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(reserved) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prop_female =</span> <span class="kw">mean</span>(female))
<span class="co">#&gt; # A tibble: 2 × 2</span>
<span class="co">#&gt;   reserved prop_female</span>
<span class="co">#&gt;      &lt;int&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1        0      0.0748</span>
<span class="co">#&gt; 2        1      1.0000</span></code></pre></div>
<p>The diff in diff estimator</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## drinking-water facilities
 
## irrigation facilities
<span class="kw">mean</span>(women$irrigation[women$reserved ==<span class="st"> </span><span class="dv">1</span>]) -
<span class="st">    </span><span class="kw">mean</span>(women$irrigation[women$reserved ==<span class="st"> </span><span class="dv">0</span>])
<span class="co">#&gt; [1] -0.369</span></code></pre></div>
<p>Mean values of <code>irrigation</code> and <code>water</code> in reserved and non-reserved districts.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">women %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(reserved) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">irrigation =</span> <span class="kw">mean</span>(irrigation), 
            <span class="dt">water =</span> <span class="kw">mean</span>(water))
<span class="co">#&gt; # A tibble: 2 × 3</span>
<span class="co">#&gt;   reserved irrigation water</span>
<span class="co">#&gt;      &lt;int&gt;      &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1        0       3.39  14.7</span>
<span class="co">#&gt; 2        1       3.02  24.0</span></code></pre></div>
<p>The difference between the two groups can be calculated with the function <a href="https://www.rdocumentation.org/packages/base/topics/diff">diff</a>, which calculates the difference between subsequent observations. This works as long as we are careful about which group is first or second.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">women %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(reserved) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">irrigation =</span> <span class="kw">mean</span>(irrigation), 
            <span class="dt">water =</span> <span class="kw">mean</span>(water)) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">diff_irrigation =</span> <span class="kw">diff</span>(irrigation),
            <span class="dt">diff_water =</span> <span class="kw">diff</span>(water))
<span class="co">#&gt; # A tibble: 1 × 2</span>
<span class="co">#&gt;   diff_irrigation diff_water</span>
<span class="co">#&gt;             &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt; 1          -0.369       9.25</span></code></pre></div>
<p>The other way uses tidyr <a href="https://www.rdocumentation.org/packages/tidyr/topics/spread.lm">spread</a> and <a href="https://www.rdocumentation.org/packages/tidyr/topics/gather.lm">gather</a>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">women %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(reserved) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">irrigation =</span> <span class="kw">mean</span>(irrigation), 
            <span class="dt">water =</span> <span class="kw">mean</span>(water)) %&gt;%
<span class="st">  </span><span class="kw">gather</span>(variable, value, -reserved) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(reserved, value) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> <span class="st">`</span><span class="dt">1</span><span class="st">`</span> -<span class="st"> `</span><span class="dt">0</span><span class="st">`</span>)
<span class="co">#&gt; # A tibble: 2 × 4</span>
<span class="co">#&gt;     variable   `0`   `1`   diff</span>
<span class="co">#&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 irrigation  3.39  3.02 -0.369</span>
<span class="co">#&gt; 2      water 14.74 23.99  9.252</span></code></pre></div>
<p>Now each row is an outcome variable of interest, and there are columns for the treatment (<code>1</code>) and control (<code>0</code>) groups, and the difference (<code>diff</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lm</span>(water ~<span class="st"> </span>reserved, <span class="dt">data =</span> women) %&gt;%<span class="st"> </span><span class="kw">summary</span>()
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = water ~ reserved, data = women)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;    Min     1Q Median     3Q    Max </span>
<span class="co">#&gt; -23.99 -14.74  -7.86   2.26 316.01 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)    14.74       2.29    6.45  4.2e-10 ***</span>
<span class="co">#&gt; reserved        9.25       3.95    2.34     0.02 *  </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 33.4 on 320 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.0169, Adjusted R-squared:  0.0138 </span>
<span class="co">#&gt; F-statistic: 5.49 on 1 and 320 DF,  p-value: 0.0197</span>
<span class="kw">lm</span>(irrigation ~<span class="st"> </span>reserved, <span class="dt">data =</span> women) %&gt;%<span class="st"> </span><span class="kw">summary</span>()
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = irrigation ~ reserved, data = women)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;    Min     1Q Median     3Q    Max </span>
<span class="co">#&gt;  -3.39  -3.39  -3.02  -1.02  86.61 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)    3.388      0.650    5.21  3.3e-07 ***</span>
<span class="co">#&gt; reserved      -0.369      1.122   -0.33     0.74    </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 9.51 on 320 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.000338,   Adjusted R-squared:  -0.00279 </span>
<span class="co">#&gt; F-statistic: 0.108 on 1 and 320 DF,  p-value: 0.742</span></code></pre></div>
<div id="regression-with-multiple-predictors" class="section level3">
<h3><span class="header-section-number">5.6.1</span> Regression with multiple predictors</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">qss_data_url</span>(<span class="st">&quot;prediction&quot;</span>, <span class="st">&quot;social.csv&quot;</span>))
<span class="co">#&gt; Parsed with column specification:</span>
<span class="co">#&gt; cols(</span>
<span class="co">#&gt;   sex = col_character(),</span>
<span class="co">#&gt;   yearofbirth = col_integer(),</span>
<span class="co">#&gt;   primary2004 = col_integer(),</span>
<span class="co">#&gt;   messages = col_character(),</span>
<span class="co">#&gt;   primary2008 = col_integer(),</span>
<span class="co">#&gt;   hhsize = col_integer()</span>
<span class="co">#&gt; )</span>
<span class="kw">glimpse</span>(social)
<span class="co">#&gt; Observations: 305,866</span>
<span class="co">#&gt; Variables: 6</span>
<span class="co">#&gt; $ sex         &lt;chr&gt; &quot;male&quot;, &quot;female&quot;, &quot;male&quot;, &quot;female&quot;, &quot;female&quot;, &quot;mal...</span>
<span class="co">#&gt; $ yearofbirth &lt;int&gt; 1941, 1947, 1951, 1950, 1982, 1981, 1959, 1956, 19...</span>
<span class="co">#&gt; $ primary2004 &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0,...</span>
<span class="co">#&gt; $ messages    &lt;chr&gt; &quot;Civic Duty&quot;, &quot;Civic Duty&quot;, &quot;Hawthorne&quot;, &quot;Hawthorn...</span>
<span class="co">#&gt; $ primary2008 &lt;int&gt; 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1,...</span>
<span class="co">#&gt; $ hhsize      &lt;int&gt; 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, 1, 2, 2, 1, 2, 2, 1,...</span>
<span class="kw">levels</span>(social$messages)
<span class="co">#&gt; NULL</span>
fit &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2008 ~<span class="st"> </span>messages, <span class="dt">data =</span> social)
fit
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2008 ~ messages, data = social)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;       (Intercept)    messagesControl  messagesHawthorne  </span>
<span class="co">#&gt;           0.31454           -0.01790            0.00784  </span>
<span class="co">#&gt; messagesNeighbors  </span>
<span class="co">#&gt;           0.06341</span></code></pre></div>
<p>Create indicator variables</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social &lt;-
<span class="st">  </span>social %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Control =</span> <span class="kw">as.integer</span>(messages ==<span class="st"> &quot;Control&quot;</span>),
         <span class="dt">Hawthorne =</span> <span class="kw">as.integer</span>(messages ==<span class="st"> &quot;Hawthorne&quot;</span>),
         <span class="dt">Neighbors =</span> <span class="kw">as.integer</span>(messages ==<span class="st"> &quot;Neighbors&quot;</span>))</code></pre></div>
<p>alternatively, create these using a for loop. This is easier to understand and less prone to typo.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">for (i in <span class="kw">unique</span>(social$messages)) {
  social[[i]] &lt;-<span class="st"> </span><span class="kw">as.integer</span>(social[[<span class="st">&quot;messages&quot;</span>]] ==<span class="st"> </span>i)
}</code></pre></div>
<p>We created a variable for each level of <code>messages</code> even though we will exclude one of them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lm</span>(primary2008 ~<span class="st"> </span>Control +<span class="st"> </span>Hawthorne +<span class="st"> </span>Neighbors, <span class="dt">data =</span> social)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2008 ~ Control + Hawthorne + Neighbors, data = social)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)      Control    Hawthorne    Neighbors  </span>
<span class="co">#&gt;     0.31454     -0.01790      0.00784      0.06341</span></code></pre></div>
<p>Create predictions for each unique value of <code>messages</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">unique_messages &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">data_grid</span>(social, messages) %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(fit)
unique_messages
<span class="co">#&gt; # A tibble: 4 × 2</span>
<span class="co">#&gt;     messages  pred</span>
<span class="co">#&gt;        &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Civic Duty 0.315</span>
<span class="co">#&gt; 2    Control 0.297</span>
<span class="co">#&gt; 3  Hawthorne 0.322</span>
<span class="co">#&gt; 4  Neighbors 0.378</span></code></pre></div>
<p>Compare to the sample averages</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(messages) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(primary2008))
<span class="co">#&gt; # A tibble: 4 × 2</span>
<span class="co">#&gt;     messages `mean(primary2008)`</span>
<span class="co">#&gt;        &lt;chr&gt;               &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Civic Duty               0.315</span>
<span class="co">#&gt; 2    Control               0.297</span>
<span class="co">#&gt; 3  Hawthorne               0.322</span>
<span class="co">#&gt; 4  Neighbors               0.378</span></code></pre></div>
<p>Linear regression without intercept.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.noint &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2008 ~<span class="st"> </span>-<span class="dv">1</span> +<span class="st"> </span>messages, <span class="dt">data =</span> social)
fit.noint
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2008 ~ -1 + messages, data = social)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; messagesCivic Duty     messagesControl   messagesHawthorne  </span>
<span class="co">#&gt;              0.315               0.297               0.322  </span>
<span class="co">#&gt;  messagesNeighbors  </span>
<span class="co">#&gt;              0.378</span></code></pre></div>
<p>Calculating the regression average effect is also easier if we make the control group the first level so all regression coefficients are comparisons to it. Use <a href="https://www.rdocumentation.org/packages/forcats/topics/fct_relevel">fct_relevel</a> to make “Control”</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.control &lt;-<span class="st"> </span>
<span class="st"> </span><span class="kw">mutate</span>(social, <span class="dt">messages =</span> <span class="kw">fct_relevel</span>(messages, <span class="st">&quot;Control&quot;</span>)) %&gt;%
<span class="st"> </span><span class="kw">lm</span>(primary2008 ~<span class="st"> </span>messages, <span class="dt">data =</span> .)
fit.control
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2008 ~ messages, data = .)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;        (Intercept)  messagesCivic Duty   messagesHawthorne  </span>
<span class="co">#&gt;             0.2966              0.0179              0.0257  </span>
<span class="co">#&gt;  messagesNeighbors  </span>
<span class="co">#&gt;             0.0813</span></code></pre></div>
<p>Difference in means</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(messages) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">primary2008 =</span> <span class="kw">mean</span>(primary2008)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Control =</span> primary2008[messages ==<span class="st"> &quot;Control&quot;</span>],
         <span class="dt">diff =</span> primary2008 -<span class="st"> </span>Control)
<span class="co">#&gt; # A tibble: 4 × 4</span>
<span class="co">#&gt;     messages primary2008 Control   diff</span>
<span class="co">#&gt;        &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Civic Duty       0.315   0.297 0.0179</span>
<span class="co">#&gt; 2    Control       0.297   0.297 0.0000</span>
<span class="co">#&gt; 3  Hawthorne       0.322   0.297 0.0257</span>
<span class="co">#&gt; 4  Neighbors       0.378   0.297 0.0813</span></code></pre></div>
<p>Adjusted R-squared is included in the output of <code>broom::glance()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(fit)
<span class="co">#&gt;   r.squared adj.r.squared sigma statistic   p.value df  logLik    AIC</span>
<span class="co">#&gt; 1   0.00328       0.00327 0.463       336 1.06e-217  4 -198247 396504</span>
<span class="co">#&gt;      BIC deviance df.residual</span>
<span class="co">#&gt; 1 396557    65468      305862</span>
<span class="kw">glance</span>(fit)$adj.r.squared
<span class="co">#&gt; [1] 0.00327</span></code></pre></div>
</div>
<div id="heterogenous-treatment-effects" class="section level3">
<h3><span class="header-section-number">5.6.2</span> Heterogenous Treatment Effects</h3>
<p>Average treatment effect (ate) among those who voted in 2004 primary</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ate &lt;-
<span class="st">  </span>social %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(primary2004, messages) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">primary2008 =</span> <span class="kw">mean</span>(primary2008)) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(messages, primary2008) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ate_Neighbors =</span> Neighbors -<span class="st"> </span>Control) %&gt;%
<span class="st">  </span><span class="kw">select</span>(primary2004, Neighbors, Control, ate_Neighbors)
ate
<span class="co">#&gt; Source: local data frame [2 x 4]</span>
<span class="co">#&gt; Groups: primary2004 [2]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   primary2004 Neighbors Control ate_Neighbors</span>
<span class="co">#&gt;         &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt;         &lt;dbl&gt;</span>
<span class="co">#&gt; 1           0     0.306   0.237        0.0693</span>
<span class="co">#&gt; 2           1     0.482   0.386        0.0965</span></code></pre></div>
<p>Difference in ATE in 2004 voters and non-voters</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">diff</span>(ate$ate_Neighbors)
<span class="co">#&gt; [1] 0.0272</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social.neighbor &lt;-<span class="st"> </span>social %&gt;%
<span class="st">  </span><span class="kw">filter</span>((messages ==<span class="st"> &quot;Control&quot;</span>) |<span class="st"> </span>(messages ==<span class="st"> &quot;Neighbors&quot;</span>))

fit.int &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2008 ~<span class="st"> </span>primary2004 +<span class="st"> </span>messages +<span class="st"> </span>primary2004:messages,
              <span class="dt">data =</span> social.neighbor)
fit.int
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2008 ~ primary2004 + messages + primary2004:messages, </span>
<span class="co">#&gt;     data = social.neighbor)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                   (Intercept)                    primary2004  </span>
<span class="co">#&gt;                        0.2371                         0.1487  </span>
<span class="co">#&gt;             messagesNeighbors  primary2004:messagesNeighbors  </span>
<span class="co">#&gt;                        0.0693                         0.0272</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lm</span>(primary2008 ~<span class="st"> </span>primary2004 *<span class="st"> </span>messages, <span class="dt">data =</span> social.neighbor)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2008 ~ primary2004 * messages, data = social.neighbor)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                   (Intercept)                    primary2004  </span>
<span class="co">#&gt;                        0.2371                         0.1487  </span>
<span class="co">#&gt;             messagesNeighbors  primary2004:messagesNeighbors  </span>
<span class="co">#&gt;                        0.0693                         0.0272</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">social.neighbor &lt;-<span class="st"> </span>
<span class="st">  </span>social.neighbor %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> <span class="dv">2008</span> -<span class="st"> </span>yearofbirth)

<span class="kw">summary</span>(social.neighbor$age)
<span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">#&gt;    22.0    43.0    52.0    51.8    61.0   108.0</span>

fit.age &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2008 ~<span class="st"> </span>age *<span class="st"> </span>messages, <span class="dt">data =</span> social.neighbor)
fit.age
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2008 ~ age * messages, data = social.neighbor)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;           (Intercept)                    age      messagesNeighbors  </span>
<span class="co">#&gt;              0.089477               0.003998               0.048573  </span>
<span class="co">#&gt; age:messagesNeighbors  </span>
<span class="co">#&gt;              0.000628</span></code></pre></div>
<p>Calculate average treatment effects</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ate.age &lt;-
<span class="st">  </span><span class="kw">crossing</span>(<span class="dt">age =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">25</span>, <span class="dt">to =</span> <span class="dv">85</span>, <span class="dt">by =</span> <span class="dv">20</span>),
         <span class="dt">messages =</span> <span class="kw">c</span>(<span class="st">&quot;Neighbors&quot;</span>, <span class="st">&quot;Control&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(fit.age) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(messages, pred) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> Neighbors -<span class="st"> </span>Control)
ate.age
<span class="co">#&gt; # A tibble: 4 × 4</span>
<span class="co">#&gt;     age Control Neighbors   diff</span>
<span class="co">#&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1    25   0.189     0.254 0.0643</span>
<span class="co">#&gt; 2    45   0.269     0.346 0.0768</span>
<span class="co">#&gt; 3    65   0.349     0.439 0.0894</span>
<span class="co">#&gt; 4    85   0.429     0.531 0.1020</span></code></pre></div>
<p>You can use <a href="https://www.rdocumentation.org/packages/base/topics/poly">poly</a> for polynomials instead of <code>age + I(age ^ 2)</code>. Though note that the coefficients will be be different since by default <code>poly</code> calculates orthogonal polynomials instead of the natural (raw) polynomials. However, you really shouldn’t interpet the coefficients directly anyways, so this should matter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.age2 &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2008 ~<span class="st"> </span><span class="kw">poly</span>(age, <span class="dv">2</span>) *<span class="st"> </span>messages,
               <span class="dt">data =</span> social.neighbor)
fit.age2
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = primary2008 ~ poly(age, 2) * messages, data = social.neighbor)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                     (Intercept)                    poly(age, 2)1  </span>
<span class="co">#&gt;                          0.2966                          27.6665  </span>
<span class="co">#&gt;                   poly(age, 2)2                messagesNeighbors  </span>
<span class="co">#&gt;                        -10.2832                           0.0816  </span>
<span class="co">#&gt; poly(age, 2)1:messagesNeighbors  poly(age, 2)2:messagesNeighbors  </span>
<span class="co">#&gt;                          4.5820                          -5.5124</span></code></pre></div>
<p>Create a data frame of combinations of ages and messages using <a href="https://www.rdocumentation.org/packages/modelr/topics/data_grid">data_grid</a>, which means that we only need to specify the variables, and not the specific values,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">y.hat &lt;-
<span class="st">  </span><span class="kw">data_grid</span>(social.neighbor, age, messages) %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(fit.age2)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(y.hat, <span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> pred, 
                  <span class="dt">colour =</span> <span class="kw">str_c</span>(messages, <span class="st">&quot; condition&quot;</span>))) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">colour =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;predicted turnout rates&quot;</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-76-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">y.hat %&gt;%
<span class="st">  </span><span class="kw">spread</span>(messages, pred) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ate =</span> Neighbors -<span class="st"> </span>Control) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(age &gt;<span class="st"> </span><span class="dv">20</span>, age &lt;<span class="st"> </span><span class="dv">90</span>) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> ate)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;estimated average treatment effect&quot;</span>) +
<span class="st">  </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.1</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-77-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="regression-discontinuity-design" class="section level2">
<h2><span class="header-section-number">5.7</span> Regression Discontinuity Design</h2>
<p><strong>Original code</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">MPs &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;MPs.csv&quot;</span>)
MPs.labour &lt;-<span class="st"> </span><span class="kw">subset</span>(MPs, <span class="dt">subset =</span> (party ==<span class="st"> &quot;labour&quot;</span>))
MPs.tory &lt;-<span class="st"> </span><span class="kw">subset</span>(MPs, <span class="dt">subset =</span> (party ==<span class="st"> &quot;tory&quot;</span>))
## two regressions for Labour: negative and positive margin
labour.fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net ~<span class="st"> </span>margin, 
                  <span class="dt">data =</span> MPs.labour[MPs.labour$margin &lt;<span class="st"> </span><span class="dv">0</span>, ])
labour.fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net ~<span class="st"> </span>margin,
<span class="dt">data =</span> MPs.labour[MPs.labour$margin &gt;<span class="st"> </span><span class="dv">0</span>, ]) ## two regressions for Tory: negative and positive margin
tory.fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net ~<span class="st"> </span>margin, <span class="dt">data =</span> MPs.tory[MPs.tory$margin &lt;<span class="st"> </span><span class="dv">0</span>, ])
tory.fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net ~<span class="st"> </span>margin, <span class="dt">data =</span> MPs.tory[MPs.tory$margin &gt;<span class="st"> </span><span class="dv">0</span>, ])</code></pre></div>
<p><strong>Tidyverse</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">MPs &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">qss_data_url</span>(<span class="st">&quot;prediction&quot;</span>, <span class="st">&quot;MPs.csv&quot;</span>))
<span class="co">#&gt; Parsed with column specification:</span>
<span class="co">#&gt; cols(</span>
<span class="co">#&gt;   surname = col_character(),</span>
<span class="co">#&gt;   firstname = col_character(),</span>
<span class="co">#&gt;   party = col_character(),</span>
<span class="co">#&gt;   ln.gross = col_double(),</span>
<span class="co">#&gt;   ln.net = col_double(),</span>
<span class="co">#&gt;   yob = col_integer(),</span>
<span class="co">#&gt;   yod = col_integer(),</span>
<span class="co">#&gt;   margin.pre = col_double(),</span>
<span class="co">#&gt;   region = col_character(),</span>
<span class="co">#&gt;   margin = col_double()</span>
<span class="co">#&gt; )</span>

MPs_labour &lt;-<span class="st"> </span><span class="kw">filter</span>(MPs, party ==<span class="st"> &quot;labour&quot;</span>)
MPs_tory &lt;-<span class="st"> </span><span class="kw">filter</span>(MPs, party ==<span class="st"> &quot;tory&quot;</span>)

labour_fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net ~<span class="st"> </span>margin,
                 <span class="dt">data =</span> <span class="kw">filter</span>(MPs_labour, margin &lt;<span class="st"> </span><span class="dv">0</span>))
labour_fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net ~<span class="st"> </span>margin, MPs_labour, margin &gt;<span class="st"> </span><span class="dv">0</span>)

tory_fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net ~<span class="st"> </span>margin,
                <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin &lt;<span class="st"> </span><span class="dv">0</span>))
tory_fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net ~<span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin &gt;<span class="st"> </span><span class="dv">0</span>))</code></pre></div>
<p><strong>Original code</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Labour: range of predictions
y1l.range &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">min</span>(MPs.labour$margin), <span class="dv">0</span>) <span class="co"># min to 0</span>
y2l.range &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(MPs.labour$margin)) <span class="co"># 0 to max</span>
## prediction
y1.labour &lt;-<span class="st"> </span><span class="kw">predict</span>(labour.fit1, <span class="dt">newdata =</span> <span class="kw">data.frame</span>(<span class="dt">margin =</span> y1l.range))
y2.labour &lt;-<span class="st"> </span><span class="kw">predict</span>(labour.fit2, <span class="dt">newdata =</span> <span class="kw">data.frame</span>(<span class="dt">margin =</span> y2l.range)) ## Tory: range of predictions
y1t.range &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">min</span>(MPs.tory$margin), <span class="dv">0</span>) <span class="co"># min to 0</span>
y2t.range &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(MPs.tory$margin)) <span class="co"># 0 to max</span>
## predict outcome
y1.tory &lt;-<span class="st"> </span><span class="kw">predict</span>(tory.fit1, <span class="dt">newdata =</span> <span class="kw">data.frame</span>(<span class="dt">margin =</span> y1t.range))
y2.tory &lt;-<span class="st"> </span><span class="kw">predict</span>(tory.fit2, <span class="dt">newdata =</span> <span class="kw">data.frame</span>(<span class="dt">margin =</span> y2t.range))</code></pre></div>
<p><strong>Tidyverse code</strong></p>
<p>Use <a href="https://www.rdocumentation.org/packages/modelr/topics/data_grid">data_grid</a> to generate a grid for predictions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">y1_labour &lt;-
<span class="st">  </span><span class="kw">filter</span>(MPs_labour, margin &lt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="kw">data_grid</span>(margin) %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(labour_fit1)
y2_labour &lt;-
<span class="st">  </span><span class="kw">filter</span>(MPs_labour, margin &gt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="kw">data_grid</span>(margin) %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(labour_fit2)

y1_tory &lt;-
<span class="st">  </span><span class="kw">filter</span>(MPs_tory, margin &lt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="kw">data_grid</span>(margin) %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(tory_fit1)

y2_tory &lt;-
<span class="st">  </span><span class="kw">filter</span>(MPs_tory, margin &gt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="kw">data_grid</span>(margin) %&gt;%
<span class="st">  </span><span class="kw">add_predictions</span>(tory_fit2)</code></pre></div>
<p><strong>Original code</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## scatterplot with regression lines for labour
<span class="kw">plot</span>(MPs.labour$margin, MPs.labour$ln.net, <span class="dt">main =</span> <span class="st">&quot;Labour&quot;</span>,
     <span class="dt">xlim =</span> <span class="kw">c</span>(-<span class="fl">0.5</span>, <span class="fl">0.5</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">6</span>, <span class="dv">18</span>), <span class="dt">xlab =</span> <span class="st">&quot;margin of victory&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;log net wealth at death&quot;</span>)
<span class="kw">abline</span>(<span class="dt">v =</span> <span class="dv">0</span>, <span class="dt">lty =</span> <span class="st">&quot;dashed&quot;</span>)
## add regression lines
<span class="kw">lines</span>(y1l.range, y1.labour, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)
<span class="kw">lines</span>(y2l.range, y2.labour, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)
## scatterplot with regression lines for tory
<span class="kw">plot</span>(MPs.tory$margin, MPs.tory$ln.net, <span class="dt">main =</span> <span class="st">&quot;Tory&quot;</span>, <span class="dt">xlim =</span> <span class="kw">c</span>(-<span class="fl">0.5</span>, <span class="fl">0.5</span>),
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">6</span>, <span class="dv">18</span>), <span class="dt">xlab =</span> <span class="st">&quot;margin of victory&quot;</span>,
<span class="dt">ylab =</span> <span class="st">&quot;log net wealth at death&quot;</span>) <span class="kw">abline</span>(<span class="dt">v =</span> <span class="dv">0</span>, <span class="dt">lty =</span> <span class="st">&quot;dashed&quot;</span>)
## add regression lines
<span class="kw">lines</span>(y1t.range, y1.tory, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)
<span class="kw">lines</span>(y2t.range, y2.tory, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</code></pre></div>
<p><strong>Tidyverse code</strong></p>
<p>Labour politicians</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() +
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> MPs_labour,
            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> ln.net)) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> y1_labour,
            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> pred), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> y2_labour,
            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> pred), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;margin of victory&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;log net wealth at death&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Labour&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-83-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Tory politicians</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() +
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> MPs_tory,
             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> ln.net)) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> y1_tory,
            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> pred), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> y2_tory,
            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> pred), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;margin of victory&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;log net wealth at death&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;labour&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-84-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We can actually produce this plot easily without running the regressions, by using <code>geom_smooth</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">mutate</span>(MPs, <span class="dt">winner =</span> (margin &gt;<span class="st"> </span><span class="dv">0</span>)),
       <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> ln.net)) +
<span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> lm, <span class="dt">se =</span> <span class="ot">FALSE</span>, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">group =</span> winner)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_grid</span>(party ~<span class="st"> </span>.) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;margin of victory&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;log net wealth at death&quot;</span>)</code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-85-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><strong>Original code</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## average net wealth for Tory MP
tory.MP &lt;-<span class="st"> </span><span class="kw">exp</span>(y2.tory[<span class="dv">1</span>])
tory.MP
##        1
## 533813.5
## average net wealth for Tory non-MP
tory.nonMP &lt;-<span class="st"> </span><span class="kw">exp</span>(y1.tory[<span class="dv">2</span>])
tory.nonMP
##        2
## 278762.5
## causal effect in pounds
tory.MP -<span class="st"> </span>tory.nonMP
##        1
## 255050.9</code></pre></div>
<p><strong>Tidyverse code</strong></p>
<p>In the previous code, I didn’t directly compute the the average net wealth at 0, so I’ll need to do that here. I’ll use <a href="https://www.rdocumentation.org/packages/modelr/topics/gather_predictions">gather_predictions</a> to add predictions for multiple models:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">spread_predictions</span>(<span class="kw">data_frame</span>(<span class="dt">margin =</span> <span class="dv">0</span>),
                   tory_fit1, tory_fit2) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rd_est =</span> tory_fit2 -<span class="st"> </span>tory_fit1)
<span class="co">#&gt; # A tibble: 1 × 4</span>
<span class="co">#&gt;   margin tory_fit1 tory_fit2 rd_est</span>
<span class="co">#&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1      0      12.5      13.2   0.65</span></code></pre></div>
<p><strong>Original code</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## two regressions for Tory: negative and positive margin
tory.fit3 &lt;-<span class="st"> </span><span class="kw">lm</span>(margin.pre ~<span class="st"> </span>margin, <span class="dt">data =</span> MPs.tory[MPs.tory$margin &lt;<span class="st"> </span><span class="dv">0</span>, ])
tory.fit4 &lt;-<span class="st"> </span><span class="kw">lm</span>(margin.pre ~<span class="st"> </span>margin, <span class="dt">data =</span> MPs.tory[MPs.tory$margin &gt;<span class="st"> </span><span class="dv">0</span>, ]) ## the difference between two intercepts is the estimated effect
<span class="kw">coef</span>(tory.fit4)[<span class="dv">1</span>] -<span class="st"> </span><span class="kw">coef</span>(tory.fit3)[<span class="dv">1</span>]
## (Intercept)
## -0.01725578</code></pre></div>
<p><strong>Tidyverse code</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tory_fit3 &lt;-<span class="st"> </span><span class="kw">lm</span>(margin.pre ~<span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin &lt;<span class="st"> </span><span class="dv">0</span>))
tory_fit4 &lt;-<span class="st"> </span><span class="kw">lm</span>(margin.pre ~<span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin &gt;<span class="st"> </span><span class="dv">0</span>))

(<span class="kw">filter</span>(<span class="kw">tidy</span>(tory_fit3), term ==<span class="st"> &quot;(Intercept)&quot;</span>)[[<span class="st">&quot;estimate&quot;</span>]] -
<span class="st"> </span><span class="kw">filter</span>(<span class="kw">tidy</span>(tory_fit4), term ==<span class="st"> &quot;(Intercept)&quot;</span>)[[<span class="st">&quot;estimate&quot;</span>]])
<span class="co">#&gt; [1] 0.0173</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="measurement.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="discovery.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jrnold/qss-tidy/edit/master/prediction.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
