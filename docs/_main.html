<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>QSS Tidyverse Code</title>
  <meta name="description" content="QSS Tidyverse Code">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="QSS Tidyverse Code" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="jrnold/qss-tidy" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="QSS Tidyverse Code" />
  
  
  

<meta name="author" content="Jeffrey B. Arnold">


<meta name="date" content="2018-02-07">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  


<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path=""><a href="#preface"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#colophon"><i class="fa fa-check"></i>Colophon</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path=""><a href="#introduction"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="1.1" data-path=""><a href="#overview-of-the-book"><i class="fa fa-check"></i><b>1.1</b> Overview of the Book</a></li>
<li class="chapter" data-level="1.2" data-path=""><a href="#how-to-use-the-book"><i class="fa fa-check"></i><b>1.2</b> How to use the Book</a></li>
<li class="chapter" data-level="1.3" data-path=""><a href="#introduction-to-r"><i class="fa fa-check"></i><b>1.3</b> Introduction to R</a><ul>
<li class="chapter" data-level="1.3.1" data-path=""><a href="#arithmetic-operations"><i class="fa fa-check"></i><b>1.3.1</b> Arithmetic Operations</a></li>
<li class="chapter" data-level="1.3.2" data-path=""><a href="#objects"><i class="fa fa-check"></i><b>1.3.2</b> Objects</a></li>
<li class="chapter" data-level="1.3.3" data-path=""><a href="#vectors"><i class="fa fa-check"></i><b>1.3.3</b> Vectors</a></li>
<li class="chapter" data-level="1.3.4" data-path=""><a href="#functions"><i class="fa fa-check"></i><b>1.3.4</b> Functions</a></li>
<li class="chapter" data-level="1.3.5" data-path=""><a href="#data-files"><i class="fa fa-check"></i><b>1.3.5</b> Data Files</a></li>
<li class="chapter" data-level="1.3.6" data-path=""><a href="#saving-objects"><i class="fa fa-check"></i><b>1.3.6</b> Saving Objects</a></li>
<li class="chapter" data-level="1.3.7" data-path=""><a href="#programming-and-learning-tips"><i class="fa fa-check"></i><b>1.3.7</b> Programming and Learning Tips</a></li>
<li class="chapter" data-level="1.3.8" data-path=""><a href="#style-guide"><i class="fa fa-check"></i><b>1.3.8</b> Style Guide</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path=""><a href="#causality"><i class="fa fa-check"></i><b>2</b> Causality</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.1" data-path=""><a href="#racial-discrimination-in-the-labor-market"><i class="fa fa-check"></i><b>2.1</b> Racial Discrimination in the Labor Market</a></li>
<li class="chapter" data-level="2.2" data-path=""><a href="#subsetting-data-in-r"><i class="fa fa-check"></i><b>2.2</b> Subsetting Data in R</a><ul>
<li class="chapter" data-level="2.2.1" data-path=""><a href="#subsetting"><i class="fa fa-check"></i><b>2.2.1</b> Subsetting</a></li>
<li class="chapter" data-level="2.2.2" data-path=""><a href="#simple-conditional-statements"><i class="fa fa-check"></i><b>2.2.2</b> Simple conditional statements</a></li>
<li class="chapter" data-level="2.2.3" data-path=""><a href="#factor-variables"><i class="fa fa-check"></i><b>2.2.3</b> Factor Variables</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path=""><a href="#causal-affects-and-the-counterfactual"><i class="fa fa-check"></i><b>2.3</b> Causal Affects and the Counterfactual</a></li>
<li class="chapter" data-level="2.4" data-path=""><a href="#observational-studies"><i class="fa fa-check"></i><b>2.4</b> Observational Studies</a><ul>
<li class="chapter" data-level="2.4.1" data-path=""><a href="#confounding-bias"><i class="fa fa-check"></i><b>2.4.1</b> Confounding Bias</a></li>
<li class="chapter" data-level="2.4.2" data-path=""><a href="#before-and-after-and-difference-in-difference-designs"><i class="fa fa-check"></i><b>2.4.2</b> Before and After and Difference-in-Difference Designs</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path=""><a href="#descriptive-statistics-for-a-single-variable"><i class="fa fa-check"></i><b>2.5</b> Descriptive Statistics for a Single Variable</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path=""><a href="#measurement"><i class="fa fa-check"></i><b>3</b> Measurement</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#prerequisites-2"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="3.1" data-path=""><a href="#measuring-civilian-victimization-during-wartime"><i class="fa fa-check"></i><b>3.1</b> Measuring Civilian Victimization during Wartime</a></li>
<li class="chapter" data-level="3.2" data-path=""><a href="#handling-missing-data-in-r"><i class="fa fa-check"></i><b>3.2</b> Handling Missing Data in R</a></li>
<li class="chapter" data-level="3.3" data-path=""><a href="#visualizing-the-univariate-distribution"><i class="fa fa-check"></i><b>3.3</b> Visualizing the Univariate Distribution</a><ul>
<li class="chapter" data-level="3.3.1" data-path=""><a href="#barplot"><i class="fa fa-check"></i><b>3.3.1</b> Barplot</a></li>
<li class="chapter" data-level="3.3.2" data-path=""><a href="#histogram"><i class="fa fa-check"></i><b>3.3.2</b> Histogram</a></li>
<li class="chapter" data-level="3.3.3" data-path=""><a href="#boxplot"><i class="fa fa-check"></i><b>3.3.3</b> Boxplot</a></li>
<li class="chapter" data-level="3.3.4" data-path=""><a href="#printing-and-saving-graphics"><i class="fa fa-check"></i><b>3.3.4</b> Printing and saving graphics</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path=""><a href="#survey-sampling"><i class="fa fa-check"></i><b>3.4</b> Survey Sampling</a><ul>
<li class="chapter" data-level="3.4.1" data-path=""><a href="#the-role-of-randomization"><i class="fa fa-check"></i><b>3.4.1</b> The Role of Randomization</a></li>
<li class="chapter" data-level="3.4.2" data-path=""><a href="#non-response-and-other-sources-of-bias"><i class="fa fa-check"></i><b>3.4.2</b> Non-response and other sources of bias</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path=""><a href="#measuring-political-polarization"><i class="fa fa-check"></i><b>3.5</b> Measuring Political Polarization</a><ul>
<li class="chapter" data-level="3.5.1" data-path=""><a href="#correlation"><i class="fa fa-check"></i><b>3.5.1</b> Correlation</a></li>
<li class="chapter" data-level="3.5.2" data-path=""><a href="#quantile-quantile-plot"><i class="fa fa-check"></i><b>3.5.2</b> Quantile-Quantile Plot</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path=""><a href="#clustering"><i class="fa fa-check"></i><b>3.6</b> Clustering</a><ul>
<li class="chapter" data-level="3.6.1" data-path=""><a href="#matrices"><i class="fa fa-check"></i><b>3.6.1</b> Matrices</a></li>
<li class="chapter" data-level="3.6.2" data-path=""><a href="#lists"><i class="fa fa-check"></i><b>3.6.2</b> Lists</a></li>
<li class="chapter" data-level="3.6.3" data-path=""><a href="#k-means-algorithms"><i class="fa fa-check"></i><b>3.6.3</b> k-means algorithms</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path=""><a href="#prediction"><i class="fa fa-check"></i><b>4</b> Prediction</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#prerequisites-3"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="4.1" data-path=""><a href="#predicting-election-outcomes"><i class="fa fa-check"></i><b>4.1</b> Predicting Election Outcomes</a><ul>
<li class="chapter" data-level="4.1.1" data-path=""><a href="#loops-in-r"><i class="fa fa-check"></i><b>4.1.1</b> Loops in R</a></li>
<li class="chapter" data-level="4.1.2" data-path=""><a href="#general-conditional-statements-in-r"><i class="fa fa-check"></i><b>4.1.2</b> General Conditional Statements in R</a></li>
<li class="chapter" data-level="4.1.3" data-path=""><a href="#poll-predictions"><i class="fa fa-check"></i><b>4.1.3</b> Poll Predictions</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path=""><a href="#linear-regression"><i class="fa fa-check"></i><b>4.2</b> Linear Regression</a><ul>
<li class="chapter" data-level="4.2.1" data-path=""><a href="#facial-appearance-and-election-outcomes"><i class="fa fa-check"></i><b>4.2.1</b> Facial Appearance and Election Outcomes</a></li>
<li class="chapter" data-level="4.2.2" data-path=""><a href="#correlation-and-scatter-plots"><i class="fa fa-check"></i><b>4.2.2</b> Correlation and Scatter Plots</a></li>
<li class="chapter" data-level="4.2.3" data-path=""><a href="#least-squares"><i class="fa fa-check"></i><b>4.2.3</b> Least Squares</a></li>
<li class="chapter" data-level="4.2.4" data-path=""><a href="#regression-towards-the-mean"><i class="fa fa-check"></i><b>4.2.4</b> Regression towards the mean</a></li>
<li class="chapter" data-level="4.2.5" data-path=""><a href="#merging-data-sets-in-r"><i class="fa fa-check"></i><b>4.2.5</b> Merging Data Sets in R</a></li>
<li class="chapter" data-level="4.2.6" data-path=""><a href="#model-fit"><i class="fa fa-check"></i><b>4.2.6</b> Model Fit</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path=""><a href="#regression-and-causation"><i class="fa fa-check"></i><b>4.3</b> Regression and Causation</a><ul>
<li class="chapter" data-level="4.3.1" data-path=""><a href="#randomized-experiments"><i class="fa fa-check"></i><b>4.3.1</b> Randomized Experiments</a></li>
<li class="chapter" data-level="4.3.2" data-path=""><a href="#regression-with-multiple-predictors"><i class="fa fa-check"></i><b>4.3.2</b> Regression with multiple predictors</a></li>
<li class="chapter" data-level="4.3.3" data-path=""><a href="#heterogeneous-treatment-effects"><i class="fa fa-check"></i><b>4.3.3</b> Heterogeneous Treatment Effects</a></li>
<li class="chapter" data-level="4.3.4" data-path=""><a href="#regression-discontinuity-design"><i class="fa fa-check"></i><b>4.3.4</b> Regression Discontinuity Design</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path=""><a href="#discovery"><i class="fa fa-check"></i><b>5</b> Discovery</a><ul>
<li class="chapter" data-level="5.1" data-path=""><a href="#textual-data"><i class="fa fa-check"></i><b>5.1</b> Textual data</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#prerequisites-4"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="5.1.1" data-path=""><a href="#document-term-matrix"><i class="fa fa-check"></i><b>5.1.1</b> Document-Term Matrix</a></li>
<li class="chapter" data-level="5.1.2" data-path=""><a href="#topic-discovery"><i class="fa fa-check"></i><b>5.1.2</b> Topic Discovery</a></li>
<li class="chapter" data-level="5.1.3" data-path=""><a href="#authorship-prediction"><i class="fa fa-check"></i><b>5.1.3</b> Authorship Prediction</a></li>
<li class="chapter" data-level="5.1.4" data-path=""><a href="#cross-validation"><i class="fa fa-check"></i><b>5.1.4</b> Cross-Validation</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path=""><a href="#network-data"><i class="fa fa-check"></i><b>5.2</b> Network data</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#prerequisites-5"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="5.2.1" data-path=""><a href="#twitter-following-network"><i class="fa fa-check"></i><b>5.2.1</b> Twitter Following Network</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path=""><a href="#spatial-data"><i class="fa fa-check"></i><b>5.3</b> Spatial Data</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#prerequisites-6"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="5.3.1" data-path=""><a href="#spatial-data-in-r"><i class="fa fa-check"></i><b>5.3.1</b> Spatial Data in R</a></li>
<li class="chapter" data-level="5.3.2" data-path=""><a href="#colors-in-r"><i class="fa fa-check"></i><b>5.3.2</b> Colors in R</a></li>
<li class="chapter" data-level="5.3.3" data-path=""><a href="#united-states-presidential-elections"><i class="fa fa-check"></i><b>5.3.3</b> United States Presidential Elections</a></li>
<li class="chapter" data-level="5.3.4" data-path=""><a href="#expansion-of-walmart"><i class="fa fa-check"></i><b>5.3.4</b> Expansion of Walmart</a></li>
<li class="chapter" data-level="5.3.5" data-path=""><a href="#animation-in-r"><i class="fa fa-check"></i><b>5.3.5</b> Animation in R</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path=""><a href="#probability"><i class="fa fa-check"></i><b>6</b> Probability</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#prerequisites-7"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="6.1" data-path=""><a href="#probability-1"><i class="fa fa-check"></i><b>6.1</b> Probability</a><ul>
<li class="chapter" data-level="6.1.1" data-path=""><a href="#frequentist-vs.bayesian"><i class="fa fa-check"></i><b>6.1.1</b> Frequentist vs. Bayesian</a></li>
<li class="chapter" data-level="6.1.2" data-path=""><a href="#definition-and-axioms"><i class="fa fa-check"></i><b>6.1.2</b> Definition and Axioms</a></li>
<li class="chapter" data-level="6.1.3" data-path=""><a href="#permutations"><i class="fa fa-check"></i><b>6.1.3</b> Permutations</a></li>
<li class="chapter" data-level="6.1.4" data-path=""><a href="#sampling-without-replacement"><i class="fa fa-check"></i><b>6.1.4</b> Sampling without replacement</a></li>
<li class="chapter" data-level="6.1.5" data-path=""><a href="#combinations"><i class="fa fa-check"></i><b>6.1.5</b> Combinations</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path=""><a href="#conditional-probability"><i class="fa fa-check"></i><b>6.2</b> Conditional Probability</a><ul>
<li class="chapter" data-level="6.2.1" data-path=""><a href="#conditional-marginal-and-joint-probabilities"><i class="fa fa-check"></i><b>6.2.1</b> Conditional, Marginal, and Joint Probabilities</a></li>
<li class="chapter" data-level="6.2.2" data-path=""><a href="#independence"><i class="fa fa-check"></i><b>6.2.2</b> Independence</a></li>
<li class="chapter" data-level="6.2.3" data-path=""><a href="#bayes-rule"><i class="fa fa-check"></i><b>6.2.3</b> Bayes’ Rule</a></li>
<li class="chapter" data-level="6.2.4" data-path=""><a href="#predicting-race-using-surname-and-residence-location"><i class="fa fa-check"></i><b>6.2.4</b> Predicting Race Using Surname and Residence Location</a></li>
<li class="chapter" data-level="6.2.5" data-path=""><a href="#predicting-election-outcomes-with-uncertainty"><i class="fa fa-check"></i><b>6.2.5</b> Predicting Election Outcomes with Uncertainty</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path=""><a href="#random-variables-and-probability-distributions"><i class="fa fa-check"></i><b>6.3</b> Random Variables and Probability Distributions</a><ul>
<li class="chapter" data-level="6.3.1" data-path=""><a href="#bernoulli-and-uniform-distributions"><i class="fa fa-check"></i><b>6.3.1</b> Bernoulli and Uniform Distributions</a></li>
<li class="chapter" data-level="6.3.2" data-path=""><a href="#binomial-distribution"><i class="fa fa-check"></i><b>6.3.2</b> Binomial distribution</a></li>
<li class="chapter" data-level="6.3.3" data-path=""><a href="#normal-distribution"><i class="fa fa-check"></i><b>6.3.3</b> Normal distribution</a></li>
<li class="chapter" data-level="6.3.4" data-path=""><a href="#expectation-and-variance"><i class="fa fa-check"></i><b>6.3.4</b> Expectation and Variance</a></li>
<li class="chapter" data-level="6.3.5" data-path=""><a href="#predicting-election-outcomes-with-uncertainty-1"><i class="fa fa-check"></i><b>6.3.5</b> Predicting Election Outcomes with Uncertainty</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path=""><a href="#large-sample-theorems"><i class="fa fa-check"></i><b>6.4</b> Large Sample Theorems</a><ul>
<li class="chapter" data-level="6.4.1" data-path=""><a href="#law-of-large-numbers"><i class="fa fa-check"></i><b>6.4.1</b> Law of Large Numbers</a></li>
<li class="chapter" data-level="6.4.2" data-path=""><a href="#central-limit-theorem"><i class="fa fa-check"></i><b>6.4.2</b> Central Limit Theorem</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path=""><a href="#uncertainty"><i class="fa fa-check"></i><b>7</b> Uncertainty</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#prerequisites-8"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="7.1" data-path=""><a href="#estimation"><i class="fa fa-check"></i><b>7.1</b> Estimation</a><ul>
<li class="chapter" data-level="7.1.1" data-path=""><a href="#unbiasedness-and-consistency"><i class="fa fa-check"></i><b>7.1.1</b> Unbiasedness and Consistency</a></li>
<li class="chapter" data-level="7.1.2" data-path=""><a href="#standard-error"><i class="fa fa-check"></i><b>7.1.2</b> Standard Error</a></li>
<li class="chapter" data-level="7.1.3" data-path=""><a href="#confidence-intervals"><i class="fa fa-check"></i><b>7.1.3</b> Confidence Intervals</a></li>
<li class="chapter" data-level="7.1.4" data-path=""><a href="#margin-of-error-and-sample-size-calculation-in-polls"><i class="fa fa-check"></i><b>7.1.4</b> Margin of Error and Sample Size Calculation in Polls</a></li>
<li class="chapter" data-level="7.1.5" data-path=""><a href="#analysis-of-randomized-controlled-trials"><i class="fa fa-check"></i><b>7.1.5</b> Analysis of Randomized Controlled Trials</a></li>
<li class="chapter" data-level="7.1.6" data-path=""><a href="#analysis-based-on-students-t-distribution"><i class="fa fa-check"></i><b>7.1.6</b> Analysis Based on Student’s t-Distribution</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path=""><a href="#hypothesis-testing"><i class="fa fa-check"></i><b>7.2</b> Hypothesis Testing</a><ul>
<li class="chapter" data-level="7.2.1" data-path=""><a href="#tea-testing-experiment"><i class="fa fa-check"></i><b>7.2.1</b> Tea-Testing Experiment</a></li>
<li class="chapter" data-level="7.2.2" data-path=""><a href="#the-general-framework"><i class="fa fa-check"></i><b>7.2.2</b> The General Framework</a></li>
<li class="chapter" data-level="7.2.3" data-path=""><a href="#one-sample-tests"><i class="fa fa-check"></i><b>7.2.3</b> One-Sample Tests</a></li>
<li class="chapter" data-level="7.2.4" data-path=""><a href="#two-sample-tests"><i class="fa fa-check"></i><b>7.2.4</b> Two-sample tests</a></li>
<li class="chapter" data-level="7.2.5" data-path=""><a href="#power-analysis"><i class="fa fa-check"></i><b>7.2.5</b> Power Analysis</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path=""><a href="#linear-regression-model-with-uncertainty"><i class="fa fa-check"></i><b>7.3</b> Linear Regression Model with Uncertainty</a><ul>
<li class="chapter" data-level="7.3.1" data-path=""><a href="#linear-regression-as-a-generative-model"><i class="fa fa-check"></i><b>7.3.1</b> Linear Regression as a Generative Model</a></li>
<li class="chapter" data-level="7.3.2" data-path=""><a href="#inference-about-coefficients"><i class="fa fa-check"></i><b>7.3.2</b> Inference about coefficients</a></li>
<li class="chapter" data-level="7.3.3" data-path=""><a href="#inference-about-predictions"><i class="fa fa-check"></i><b>7.3.3</b> Inference about predictions</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">QSS Tidyverse Code</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">QSS Tidyverse Code</h1>
<h4 class="author"><em>Jeffrey B. Arnold</em></h4>
<h4 class="date"><em>2018-02-07</em></h4>
</div>
<section id="preface" class="level1 unnumbered">
<h1>Preface</h1>
<p>This is tidyverse R code to supplement the book, <a href="http://press.princeton.edu/titles/11025.html">Quantitative Social Science: An Introduction</a>, by Kosuke Imai, to be published by Princeton University Press in March 2017.</p>
<p>The R code included with the text of <em>QSS</em> and the supplementary materials relies mostly on base R functions. This translates the code examples provided with <em>QSS</em> to tidyverse R code. <a href="https://github.com/tidyverse/tidyverse">Tidyverse</a> refers to a set of packages (<strong>ggplot2</strong>, <strong>dplyr</strong>, <strong>tidyr</strong>, <strong>readr</strong>, <strong>purrr</strong>, <strong>tibble</strong>, and a few others) that share common data representations, especially the use of data frames for return values.</p>
<p>These notes do not aim to teach tidyverse, The book <a href="http://r4ds.had.co.nz/">R for Data Science</a> by Hadley Wickham and Garrett Grolemond is an introduction.</p>
<p>I wrote this code while teaching course that employed both texts in order to make the excellent examples and statistical material in <em>QSS</em> more compatible with the modern data science using R approach in <em>R4DS</em>.</p>
<section id="colophon" class="level2 unnumbered">
<h2>Colophon</h2>
<p>To install the R packages used in this work run the following code, installs the <strong>qsstidy</strong> package which contains no code or data, but will install the needed dependencies.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">install_github</span>(<span class="st">&quot;jrnold/qss-tidy&quot;</span>)</a></code></pre></div>
<p>Additionally, the <a href="https://cran.r-project.org/package=gganimate">gganimate</a> package requires installing <a href="https://ffmpeg.org/">ffmpeg</a> with libvpx support.</p>
<p>The source of the book is available <a href="https://github.com/jrnold/qsstidy">here</a> and was built with versions of packages below:</p>
<pre><code>#&gt; Session info -------------------------------------------------------------
#&gt;  setting  value                       
#&gt;  version  R version 3.4.3 (2017-11-30)
#&gt;  system   x86_64, darwin15.6.0        
#&gt;  ui       X11                         
#&gt;  language (EN)                        
#&gt;  collate  en_US.UTF-8                 
#&gt;  tz       America/Los_Angeles         
#&gt;  date     2018-01-10
#&gt; Packages -----------------------------------------------------------------
#&gt;  package    * version date       source        
#&gt;  animation  * 2.5     2017-03-30 cran (@2.5)   
#&gt;  assertthat   0.2.0   2017-04-11 CRAN (R 3.4.0)
#&gt;  backports    1.1.2   2017-12-13 CRAN (R 3.4.3)
#&gt;  base       * 3.4.3   2017-12-07 local         
#&gt;  bindr        0.1     2016-11-13 CRAN (R 3.4.0)
#&gt;  bindrcpp     0.2     2017-06-17 CRAN (R 3.4.0)
#&gt;  bookdown     0.5     2017-08-20 CRAN (R 3.4.1)
#&gt;  broom        0.4.3   2017-11-20 CRAN (R 3.4.3)
#&gt;  cellranger   1.1.0   2016-07-27 CRAN (R 3.4.0)
#&gt;  cli          1.0.0   2017-11-05 CRAN (R 3.4.2)
#&gt;  colorspace   1.3-2   2016-12-14 CRAN (R 3.4.0)
#&gt;  compiler     3.4.3   2017-12-07 local         
#&gt;  crayon       1.3.4   2017-09-16 CRAN (R 3.4.1)
#&gt;  datasets   * 3.4.3   2017-12-07 local         
#&gt;  devtools     1.13.4  2017-11-09 CRAN (R 3.4.2)
#&gt;  digest       0.6.13  2017-12-14 CRAN (R 3.4.3)
#&gt;  dplyr      * 0.7.4   2017-09-28 CRAN (R 3.4.2)
#&gt;  evaluate     0.10.1  2017-06-24 CRAN (R 3.4.1)
#&gt;  forcats    * 0.2.0   2017-01-23 CRAN (R 3.4.0)
#&gt;  foreign      0.8-69  2017-06-22 CRAN (R 3.4.3)
#&gt;  ggplot2    * 2.2.1   2016-12-30 CRAN (R 3.4.0)
#&gt;  glue         1.2.0   2017-10-29 CRAN (R 3.4.2)
#&gt;  graphics   * 3.4.3   2017-12-07 local         
#&gt;  grDevices  * 3.4.3   2017-12-07 local         
#&gt;  grid         3.4.3   2017-12-07 local         
#&gt;  gtable       0.2.0   2016-02-26 CRAN (R 3.4.0)
#&gt;  haven        1.1.0   2017-07-09 CRAN (R 3.4.1)
#&gt;  hms          0.4.0   2017-11-23 CRAN (R 3.4.3)
#&gt;  htmltools    0.3.6   2017-04-28 CRAN (R 3.4.0)
#&gt;  httr         1.3.1   2017-08-20 CRAN (R 3.4.1)
#&gt;  jsonlite     1.5     2017-06-01 CRAN (R 3.4.0)
#&gt;  knitr        1.18    2017-12-27 CRAN (R 3.4.3)
#&gt;  lattice      0.20-35 2017-03-25 CRAN (R 3.4.3)
#&gt;  lazyeval     0.2.1   2017-10-29 CRAN (R 3.4.2)
#&gt;  lubridate    1.7.1   2017-11-03 CRAN (R 3.4.2)
#&gt;  magrittr     1.5     2014-11-22 CRAN (R 3.4.0)
#&gt;  memoise      1.1.0   2017-04-21 CRAN (R 3.4.0)
#&gt;  methods      3.4.3   2017-12-07 local         
#&gt;  mnormt       1.5-5   2016-10-15 CRAN (R 3.4.0)
#&gt;  modelr       0.1.1   2017-07-24 CRAN (R 3.4.1)
#&gt;  munsell      0.4.3   2016-02-13 CRAN (R 3.4.0)
#&gt;  nlme         3.1-131 2017-02-06 CRAN (R 3.4.3)
#&gt;  parallel     3.4.3   2017-12-07 local         
#&gt;  pillar       1.0.1   2017-11-27 CRAN (R 3.4.3)
#&gt;  pkgconfig    2.0.1   2017-03-21 CRAN (R 3.4.0)
#&gt;  plyr         1.8.4   2016-06-08 CRAN (R 3.4.0)
#&gt;  psych        1.7.8   2017-09-09 CRAN (R 3.4.3)
#&gt;  purrr      * 0.2.4   2017-10-18 CRAN (R 3.4.2)
#&gt;  R6           2.2.2   2017-06-17 CRAN (R 3.4.0)
#&gt;  Rcpp         0.12.14 2017-11-23 CRAN (R 3.4.3)
#&gt;  readr      * 1.1.1   2017-05-16 CRAN (R 3.4.0)
#&gt;  readxl       1.0.0   2017-04-18 CRAN (R 3.4.0)
#&gt;  reshape2     1.4.3   2017-12-11 CRAN (R 3.4.3)
#&gt;  rlang        0.1.6   2017-12-21 CRAN (R 3.4.3)
#&gt;  rmarkdown    1.8     2017-11-17 CRAN (R 3.4.2)
#&gt;  rprojroot    1.3-2   2018-01-03 CRAN (R 3.4.3)
#&gt;  rstudioapi   0.7     2017-09-07 CRAN (R 3.4.1)
#&gt;  rvest        0.3.2   2016-06-17 CRAN (R 3.4.0)
#&gt;  scales       0.5.0   2017-08-24 CRAN (R 3.4.1)
#&gt;  stats      * 3.4.3   2017-12-07 local         
#&gt;  stringi      1.1.6   2017-11-17 CRAN (R 3.4.2)
#&gt;  stringr    * 1.2.0   2017-02-18 CRAN (R 3.4.0)
#&gt;  tibble     * 1.4.1   2017-12-25 CRAN (R 3.4.3)
#&gt;  tidyr      * 0.7.2   2017-10-16 CRAN (R 3.4.2)
#&gt;  tidyverse  * 1.2.1   2017-11-14 CRAN (R 3.4.2)
#&gt;  tools        3.4.3   2017-12-07 local         
#&gt;  utils      * 3.4.3   2017-12-07 local         
#&gt;  withr        2.1.1   2017-12-19 CRAN (R 3.4.3)
#&gt;  xml2         1.1.1   2017-01-24 CRAN (R 3.4.0)
#&gt;  yaml         2.1.16  2017-12-12 CRAN (R 3.4.3)</code></pre>

</section>
</section>
<section id="introduction" class="level1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<section id="prerequisites" class="level2 unnumbered">
<h2>Prerequisites</h2>
<p>In this and other chapters we will make use of data from the <code>qss</code> package, which is available on github. Install it using the <code>install_github()</code> function from the library <code>devtools</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;kosukeimai/qss-package&quot;</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; Skipping install of &#39;qss&#39; from a github remote, the SHA1 (1dc4b858) has not changed since last install.</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt;   Use `force = TRUE` to force installation</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">library</span>(<span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>In the prerequisites section of each chapter, we’ll load any packages needed for the chapter, and possibly define some functions or load data.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a></code></pre></div>
<p>We also load the <strong>readr</strong> package to load <code>csv</code> files,</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;readr&quot;</span>)</a></code></pre></div>
<p>the <strong>haven</strong> package to load Stata <code>dta</code> files,</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;haven&quot;</span>)</a></code></pre></div>
<p>and the <strong>rio</strong> package to load multiple types of files.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;rio&quot;</span>)</a></code></pre></div>
</section>
<section id="overview-of-the-book" class="level2">
<h2><span class="header-section-number">1.1</span> Overview of the Book</h2>
<!-- define all sections so that numbering matches that of the book -->
<p><em>This sections contains no code to translate – see</em>QSS* text.*</p>
</section>
<section id="how-to-use-the-book" class="level2">
<h2><span class="header-section-number">1.2</span> How to use the Book</h2>
<p><em>This sections contains no code to translate – see</em>QSS* text.*</p>
</section>
<section id="introduction-to-r" class="level2">
<h2><span class="header-section-number">1.3</span> Introduction to R</h2>
<p>These notes do not aim to completely teach R and the tidyverse. However, there are many other resources for that.</p>
<p><a href="http://r4ds.had.co.nz/">R for Data Science</a> is a comprehensive introduction to R using the tidyverse.</p>
<p><a href="https://www.datacamp.com/home">Data Camp</a> has interactive courses. In particular, I recommend starting with the following two courses.</p>
<ul>
<li><a href="https://www.datacamp.com/courses/free-introduction-to-r">Introduction to R</a></li>
<li><a href="https://www.datacamp.com/courses/introduction-to-the-tidyverse">Introduction to the Tidyverse</a></li>
</ul>
<section id="arithmetic-operations" class="level3">
<h3><span class="header-section-number">1.3.1</span> Arithmetic Operations</h3>
<p><em>This sections contains no code to translate – see</em>QSS* text.*</p>
</section>
<section id="objects" class="level3">
<h3><span class="header-section-number">1.3.2</span> Objects</h3>
<p><em>This sections contains no code to translate – see</em>QSS* text.*</p>
<p>Also see <a href="http://r4ds.had.co.nz/workflow-basics.html">R4DS: Workflow basics</a>.</p>
</section>
<section id="vectors" class="level3">
<h3><span class="header-section-number">1.3.3</span> Vectors</h3>
<p><em>This sections contains no code to translate – see</em>QSS* text.*</p>
<p>Also see <a href="http://r4ds.had.co.nz/vectors.html">R4DS: Vectors</a>. In <em>R for Data Science</em> vectors are introduced much later, after data frames.</p>
</section>
<section id="functions" class="level3">
<h3><span class="header-section-number">1.3.4</span> Functions</h3>
<p><em>This sections contains no code to translate – see</em>QSS* text.*</p>
<p>Also see <a href="http://r4ds.had.co.nz/functions.html">R4DS: Functions</a>.</p>
</section>
<section id="data-files" class="level3">
<h3><span class="header-section-number">1.3.5</span> Data Files</h3>
<p>Rather than using <code>setwd()</code> in scripts, data analysis should be organized in projects. Read the introduction on RStudio projects in <a href="http://r4ds.had.co.nz/workflow-projects.html">R4DS</a>.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<p>Datasets used in R are accessed in two ways.</p>
<ul>
<li>Datasets can be distributed with R packages. These are often smaller datasets used in examples and tutorials in packages. These are loaded with the <code>data()</code> function. For example you can load UN data on demographic statistics from the <strong>qss</strong> library, which distributes the data sets used in the <em>QSS</em> textbook. (The function <code>data()</code> called without any arguments will list all the datasets distributed with installed packages.)</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;UNpop&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<ul>
<li>Datasets can be loaded from external files including both stored R objects (<code>.RData</code>, <code>.rda</code>) and other formats (<code>.csv</code>, <code>.dta</code>, <code>.sav</code>). To read a <a href="https://en.wikipedia.org/wiki/Comma-separated_values">csv</a> file into R use the <code>read_csv</code> function from the <strong>readr</strong> library, part of the tidyverse.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">UNpop_URL &lt;-<span class="st"> &quot;https://raw.githubusercontent.com/kosukeimai/qss/master/INTRO/UNpop.csv&quot;</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">UNpop &lt;-<span class="st"> </span><span class="kw">read_csv</span>(UNpop_URL)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt; Parsed with column specification:</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#&gt; cols(</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt;   year = col_integer(),</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt;   world.pop = col_integer()</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#&gt; )</span></a></code></pre></div>
<p>We use the readr function<code>read_csv()</code> instead of the base R function <code>read.csv()</code> used in the <em>QSS</em> text. It is slightly faster, and returns a <code>tibble</code> instead of a data frame. Check this by calling <code>class()</code> on the new object.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">class</span>(UNpop)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">#&gt; [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">UNpop</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt; # A tibble: 7 x 2</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#&gt;    year world.pop</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#&gt;   &lt;int&gt;     &lt;int&gt;</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co">#&gt; 1  1950   2525779</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co">#&gt; 2  1960   3026003</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co">#&gt; 3  1970   3691173</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co">#&gt; 4  1980   4449049</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">#&gt; 5  1990   5320817</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co">#&gt; 6  2000   6127700</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">#&gt; # ... with 1 more row</span></a></code></pre></div>
<p>See <a href="http://r4ds.had.co.nz/">R for Data Science</a> <a href="http://r4ds.had.co.nz/tibbles.html#introduction-4">Ch 11: Data Import</a> for more discussion.</p>
<p>Note that in the previous code we loaded the file directly from a URL, but we could also work with local files on your computer, e.g.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">UNpop &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;INTRO/UNpop.csv&quot;</span>)</a></code></pre></div>
<p>See <a href="http://r4ds.had.co.nz/">R for Data Science</a> <a href="http://r4ds.had.co.nz/tibbles.html">Ch 10: Tibbles</a> for a deeper discussion of data frames.</p>
<p>The single bracket, <code>[</code>, is useful to select rows and columns in simple cases.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">UNpop[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), ]</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co">#&gt;    year world.pop</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co">#&gt;   &lt;int&gt;     &lt;int&gt;</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt; 1  1950   2525779</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#&gt; 2  1960   3026003</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt; 3  1970   3691173</span></a></code></pre></div>
<p>There are <strong>dplyr</strong> functions to select rows by number, to select rows by certain criteria, or to select columns.</p>
<p>To select rows 1–3, use <code>slice()</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">slice</span>(UNpop, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#&gt;    year world.pop</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt;   &lt;int&gt;     &lt;int&gt;</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; 1  1950   2525779</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt; 2  1960   3026003</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">#&gt; 3  1970   3691173</span></a></code></pre></div>
<p>Base R allows you to choose the column <code>world.pop</code> column from the <code>UNpop</code> data frame:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">UNpop[, <span class="st">&quot;world.pop&quot;</span>]</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="co">#&gt; # A tibble: 7 x 1</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="co">#&gt;   world.pop</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co">#&gt;       &lt;int&gt;</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="co">#&gt; 1   2525779</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co">#&gt; 2   3026003</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co">#&gt; 3   3691173</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="co">#&gt; 4   4449049</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="co">#&gt; 5   5320817</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="co">#&gt; 6   6127700</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="co">#&gt; # ... with 1 more row</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12">UNpop<span class="op">$</span>world.pop</a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="co">#&gt; [1] 2525779 3026003 3691173 4449049 5320817 6127700 6916183</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14">UNpop[[<span class="st">&quot;world.pop&quot;</span>]]</a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="co">#&gt; [1] 2525779 3026003 3691173 4449049 5320817 6127700 6916183</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="kw">select</span>(UNpop, world.pop)</a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="co">#&gt; # A tibble: 7 x 1</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="co">#&gt;   world.pop</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="co">#&gt;       &lt;int&gt;</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="co">#&gt; 1   2525779</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="co">#&gt; 2   3026003</span></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="co">#&gt; 3   3691173</span></a>
<a class="sourceLine" id="cb14-23" data-line-number="23"><span class="co">#&gt; 4   4449049</span></a>
<a class="sourceLine" id="cb14-24" data-line-number="24"><span class="co">#&gt; 5   5320817</span></a>
<a class="sourceLine" id="cb14-25" data-line-number="25"><span class="co">#&gt; 6   6127700</span></a>
<a class="sourceLine" id="cb14-26" data-line-number="26"><span class="co">#&gt; # ... with 1 more row</span></a></code></pre></div>
<p>Unlike <code>[</code>, the <code>[[</code> and <code>$</code> operators can only select a single column and return a vector.<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> The <code>dplyr</code> function <code>select()</code> <strong>always</strong> returns a tibble (data frame), and never a vector, even if only one column is selected.</p>
<p>Select rows 1–3 of the <code>year</code> column:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">UNpop[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="st">&quot;year&quot;</span>]</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="co">#&gt; # A tibble: 3 x 1</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co">#&gt;    year</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co">#&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#&gt; 1  1950</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">#&gt; 2  1960</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt; 3  1970</span></a></code></pre></div>
<p>or,</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">select</span>(<span class="kw">slice</span>(UNpop, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), year)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="co">#&gt; # A tibble: 3 x 1</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">#&gt;    year</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co">#&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="co">#&gt; 1  1950</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co">#&gt; 2  1960</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">#&gt; 3  1970</span></a></code></pre></div>
<p>The same series of functions can be performed using the pipe operator, <code>%&gt;%</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">UNpop <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(year)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="co">#&gt; # A tibble: 3 x 1</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="co">#&gt;    year</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="co">#&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co">#&gt; 1  1950</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="co">#&gt; 2  1960</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="co">#&gt; 3  1970</span></a></code></pre></div>
<p>This example may seem verbose, but later we can produce more complicated transformations of the data by chaining together simple functions.</p>
<p>Select every other row from <code>UNpop</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">UNpop<span class="op">$</span>world.pop[<span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">1</span>, <span class="dt">to =</span> <span class="kw">nrow</span>(UNpop), <span class="dt">by =</span> <span class="dv">2</span>)]</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="co">#&gt; [1] 2525779 3691173 5320817 6916183</span></a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">UNpop <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="st">  </span><span class="kw">slice</span>(<span class="kw">seq</span>(<span class="dv">1</span>, <span class="kw">n</span>(), <span class="dt">by =</span> <span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(world.pop)</a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="co">#&gt; # A tibble: 4 x 1</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="co">#&gt;   world.pop</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="co">#&gt;       &lt;int&gt;</span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="co">#&gt; 1   2525779</span></a>
<a class="sourceLine" id="cb19-8" data-line-number="8"><span class="co">#&gt; 2   3691173</span></a>
<a class="sourceLine" id="cb19-9" data-line-number="9"><span class="co">#&gt; 3   5320817</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10"><span class="co">#&gt; 4   6916183</span></a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">UNpop <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">row_number</span>() <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="co">#&gt;    year world.pop</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="co">#&gt;   &lt;int&gt;     &lt;int&gt;</span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="co">#&gt; 1  1950   2525779</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="co">#&gt; 2  1970   3691173</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="co">#&gt; 3  1990   5320817</span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="co">#&gt; 4  2010   6916183</span></a></code></pre></div>
<p>The function <code>n()</code> when used in a <strong>dplyr</strong> function returns the number of rows in the data frame (or the number of rows in the group if used with <code>group_by()</code>). The function <code>row_number()</code> returns the row number of an observation. The <code>%%</code> operator returns the modulus, i.e. division remainder.</p>
</section>
<section id="saving-objects" class="level3">
<h3><span class="header-section-number">1.3.6</span> Saving Objects</h3>
<p>It is not recommended that you save the entire R workspace using <code>save.image</code> due to the negative and unexpected impacts it can have on reproducibility.See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/workflow-projects.html">Workflow Projects</a>.</p>
<p>You should uncheck the options in RStudio to avoid saving and restoring from <code>.RData</code> files (go to <code>Tools &gt; Global Options &gt; General</code>). This will help ensure that your R code runs the way you think it does, instead of depending on some long forgotten code that is only saved in the workspace image. Everything important should be in a script. Anything saved or loaded from file should be done explicitly.</p>
<p>Your motto should be that the <strong>source is real</strong>, not the objects created by it.</p>
<blockquote>
<p>The source code is real. The objects are realizations of the source code. Source for EVERY user modified object is placed in a particular directory or directories, for later editing and retrieval. – from the <a href="https://ess.r-project.org/Manual/ess.html#Philosophies-for-using-ESS_0028S_0029">ESS manual</a></p>
</blockquote>
<p>This means that while you should not save the entire workplace it is perfectly fine practice to run a script and save or load R objects to files, using or .</p>
<p>As with reading CSV files, use the <a href="http://readr.tidyverse.org/">readr</a> package functions. In this case, <code>write_csv()</code> writes a csv file and takes at least two objects: the data that you want to write to a csv and the name that you want to give the file.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw">write_csv</span>(UNpop, <span class="st">&quot;UNpop.csv&quot;</span>)</a></code></pre></div>
</section>
<section id="programming-and-learning-tips" class="level3">
<h3><span class="header-section-number">1.3.7</span> Programming and Learning Tips</h3>
<p>Use the <a href="http://haven.tidyverse.org/">haven</a> package to read and write Stata (<code>.dta</code>) and SPSS (<code>.sav</code>) files. Stata and SPSS are two other statistical programs commonly used in social science. Even if you don’t ever use them, you’ll almost certainly encounter data stored in their native formats.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">UNpop_dta_url &lt;-<span class="st"> &quot;https://github.com/kosukeimai/qss/raw/master/INTRO/UNpop.dta&quot;</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2">UNpop &lt;-<span class="st"> </span><span class="kw">read_dta</span>(UNpop_dta_url)</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">UNpop</a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co">#&gt; # A tibble: 7 x 2</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="co">#&gt;    year world_pop</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="co">#&gt;   &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="co">#&gt; 1  1950      2526</span></a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="co">#&gt; 2  1960      3026</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="co">#&gt; 3  1970      3691</span></a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="co">#&gt; 4  1980      4449</span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="co">#&gt; 5  1990      5321</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="co">#&gt; 6  2000      6128</span></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="co">#&gt; # ... with 1 more row</span></a></code></pre></div>
<p>There is also the equivalent <code>write_dta()</code> function to create Stata datasets.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">write_dta</span>(UNpop, <span class="st">&quot;UNpop.dta&quot;</span>)</a></code></pre></div>
<p>While Stata and SPSS data sets are quite similar to data frames, they differ slightly in definitions of acceptable data types of columns and what metadata they store with the data. +Be careful when reading and writing from these formats to ensure that information is not lost.</p>
<p>Also see the <a href="https://cran.r-project.org/package=rio">rio</a> package which makes loading data even easier with smart defaults.</p>
<p>You can use the <code>import()</code> function to load many types of files:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw">import</span>(<span class="st">&quot;https://github.com/kosukeimai/qss/raw/master/INTRO/UNpop.csv&quot;</span>)</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="co">#&gt;   year world.pop</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="co">#&gt; 1 1950   2525779</span></a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="co">#&gt; 2 1960   3026003</span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="co">#&gt; 3 1970   3691173</span></a>
<a class="sourceLine" id="cb24-6" data-line-number="6"><span class="co">#&gt; 4 1980   4449049</span></a>
<a class="sourceLine" id="cb24-7" data-line-number="7"><span class="co">#&gt; 5 1990   5320817</span></a>
<a class="sourceLine" id="cb24-8" data-line-number="8"><span class="co">#&gt; 6 2000   6127700</span></a>
<a class="sourceLine" id="cb24-9" data-line-number="9"><span class="co">#&gt; 7 2010   6916183</span></a>
<a class="sourceLine" id="cb24-10" data-line-number="10"></a>
<a class="sourceLine" id="cb24-11" data-line-number="11"><span class="kw">import</span>(<span class="st">&quot;https://github.com/kosukeimai/qss/raw/master/INTRO/UNpop.RData&quot;</span>)</a>
<a class="sourceLine" id="cb24-12" data-line-number="12"><span class="co">#&gt;   year world.pop</span></a>
<a class="sourceLine" id="cb24-13" data-line-number="13"><span class="co">#&gt; 1 1950   2525779</span></a>
<a class="sourceLine" id="cb24-14" data-line-number="14"><span class="co">#&gt; 2 1960   3026003</span></a>
<a class="sourceLine" id="cb24-15" data-line-number="15"><span class="co">#&gt; 3 1970   3691173</span></a>
<a class="sourceLine" id="cb24-16" data-line-number="16"><span class="co">#&gt; 4 1980   4449049</span></a>
<a class="sourceLine" id="cb24-17" data-line-number="17"><span class="co">#&gt; 5 1990   5320817</span></a>
<a class="sourceLine" id="cb24-18" data-line-number="18"><span class="co">#&gt; 6 2000   6127700</span></a>
<a class="sourceLine" id="cb24-19" data-line-number="19"><span class="co">#&gt; 7 2010   6916183</span></a>
<a class="sourceLine" id="cb24-20" data-line-number="20"></a>
<a class="sourceLine" id="cb24-21" data-line-number="21"><span class="kw">import</span>(<span class="st">&quot;https://github.com/kosukeimai/qss/raw/master/INTRO/UNpop.dta&quot;</span>)</a>
<a class="sourceLine" id="cb24-22" data-line-number="22"><span class="co">#&gt;   year world_pop</span></a>
<a class="sourceLine" id="cb24-23" data-line-number="23"><span class="co">#&gt; 1 1950      2526</span></a>
<a class="sourceLine" id="cb24-24" data-line-number="24"><span class="co">#&gt; 2 1960      3026</span></a>
<a class="sourceLine" id="cb24-25" data-line-number="25"><span class="co">#&gt; 3 1970      3691</span></a>
<a class="sourceLine" id="cb24-26" data-line-number="26"><span class="co">#&gt; 4 1980      4449</span></a>
<a class="sourceLine" id="cb24-27" data-line-number="27"><span class="co">#&gt; 5 1990      5321</span></a>
<a class="sourceLine" id="cb24-28" data-line-number="28"><span class="co">#&gt; 6 2000      6128</span></a>
<a class="sourceLine" id="cb24-29" data-line-number="29"><span class="co">#&gt; 7 2010      6916</span></a></code></pre></div>
<p>R also includes the <strong>foreign</strong> package, which contains functions for reading and writing files using <strong>haven</strong>. One reason to use these packages is that they are better maintained. For example, the R function <code>read.dta()</code> does not read files created by the most recent versions of Stata (13+), whereas <strong>haven</strong> does.</p>
</section>
<section id="style-guide" class="level3">
<h3><span class="header-section-number">1.3.8</span> Style Guide</h3>
<p>Following a consistent coding style is important for your code to be readable by you and others. The preferred style is the <a href="http://style.tidyverse.org/">tidyverse style guide</a>, which differs slightly from <a href="http://style.tidyverse.org/">Google’s R style guide</a>.</p>
<ul>
<li>The <a href="https://cran.r-project.org/package=lintr">lintr</a> package will check files for style errors.</li>
<li>The <a href="https://cran.r-project.org/package=styler">styler</a> package provides functions for automatically formatting R code according to style guides.</li>
<li>In RStudio, go to the <code>Tools &gt; Global Options &gt; Code &gt; Diagnostics</code> pane and check the box to activate style warnings. On this pane, there are other options that can be set in order to increase or decrease the amount of warnings while writing R code in RStudio.</li>
</ul>

</section>
</section>
</section>
<section id="causality" class="level1">
<h1><span class="header-section-number">2</span> Causality</h1>
<section id="prerequisites-1" class="level2 unnumbered">
<h2>Prerequisites</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)</a></code></pre></div>
</section>
<section id="racial-discrimination-in-the-labor-market" class="level2">
<h2><span class="header-section-number">2.1</span> Racial Discrimination in the Labor Market</h2>
<p>Load the data from the <strong>qss</strong> package.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;resume&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>In addition to the <code>dim()</code>, <code>summary()</code>, and <code>head()</code> functions shown in the text,</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">dim</span>(resume)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="co">#&gt; [1] 4870    4</span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="kw">summary</span>(resume)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="co">#&gt;   firstname             sex                race                call     </span></a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="co">#&gt;  Length:4870        Length:4870        Length:4870        Min.   :0.00  </span></a>
<a class="sourceLine" id="cb27-6" data-line-number="6"><span class="co">#&gt;  Class :character   Class :character   Class :character   1st Qu.:0.00  </span></a>
<a class="sourceLine" id="cb27-7" data-line-number="7"><span class="co">#&gt;  Mode  :character   Mode  :character   Mode  :character   Median :0.00  </span></a>
<a class="sourceLine" id="cb27-8" data-line-number="8"><span class="co">#&gt;                                                           Mean   :0.08  </span></a>
<a class="sourceLine" id="cb27-9" data-line-number="9"><span class="co">#&gt;                                                           3rd Qu.:0.00  </span></a>
<a class="sourceLine" id="cb27-10" data-line-number="10"><span class="co">#&gt;                                                           Max.   :1.00</span></a>
<a class="sourceLine" id="cb27-11" data-line-number="11"><span class="kw">head</span>(resume)</a>
<a class="sourceLine" id="cb27-12" data-line-number="12"><span class="co">#&gt;   firstname    sex  race call</span></a>
<a class="sourceLine" id="cb27-13" data-line-number="13"><span class="co">#&gt; 1   Allison female white    0</span></a>
<a class="sourceLine" id="cb27-14" data-line-number="14"><span class="co">#&gt; 2   Kristen female white    0</span></a>
<a class="sourceLine" id="cb27-15" data-line-number="15"><span class="co">#&gt; 3   Lakisha female black    0</span></a>
<a class="sourceLine" id="cb27-16" data-line-number="16"><span class="co">#&gt; 4   Latonya female black    0</span></a>
<a class="sourceLine" id="cb27-17" data-line-number="17"><span class="co">#&gt; 5    Carrie female white    0</span></a>
<a class="sourceLine" id="cb27-18" data-line-number="18"><span class="co">#&gt; 6       Jay   male white    0</span></a></code></pre></div>
<p>we can also use <code>glimpse()</code> to get a quick understanding of the variables in the data frame:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw">glimpse</span>(resume)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="co">#&gt; Observations: 4,870</span></a>
<a class="sourceLine" id="cb28-3" data-line-number="3"><span class="co">#&gt; Variables: 4</span></a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="co">#&gt; $ firstname &lt;chr&gt; &quot;Allison&quot;, &quot;Kristen&quot;, &quot;Lakisha&quot;, &quot;Latonya&quot;, &quot;Carrie&quot;...</span></a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="co">#&gt; $ sex       &lt;chr&gt; &quot;female&quot;, &quot;female&quot;, &quot;female&quot;, &quot;female&quot;, &quot;female&quot;, &quot;m...</span></a>
<a class="sourceLine" id="cb28-6" data-line-number="6"><span class="co">#&gt; $ race      &lt;chr&gt; &quot;white&quot;, &quot;white&quot;, &quot;black&quot;, &quot;black&quot;, &quot;white&quot;, &quot;white&quot;...</span></a>
<a class="sourceLine" id="cb28-7" data-line-number="7"><span class="co">#&gt; $ call      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0...</span></a></code></pre></div>
<p>The code in <em>QSS</em> uses <code>table()</code> and <code>addmargins()</code> to construct the table. However, this can be done easily with the <strong>dplyr</strong> package using grouping and summarizing.</p>
<p>Use <code>group_by()</code> to identify each combination of <code>race</code> and <code>call</code>, and then <code>count()</code> the observations:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">race_call_tab &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="st">  </span>resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(race, call) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="st">  </span><span class="kw">count</span>()</a>
<a class="sourceLine" id="cb29-5" data-line-number="5">race_call_tab</a>
<a class="sourceLine" id="cb29-6" data-line-number="6"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb29-7" data-line-number="7"><span class="co">#&gt; # Groups: race, call [4]</span></a>
<a class="sourceLine" id="cb29-8" data-line-number="8"><span class="co">#&gt;   race   call     n</span></a>
<a class="sourceLine" id="cb29-9" data-line-number="9"><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb29-10" data-line-number="10"><span class="co">#&gt; 1 black     0  2278</span></a>
<a class="sourceLine" id="cb29-11" data-line-number="11"><span class="co">#&gt; 2 black     1   157</span></a>
<a class="sourceLine" id="cb29-12" data-line-number="12"><span class="co">#&gt; 3 white     0  2200</span></a>
<a class="sourceLine" id="cb29-13" data-line-number="13"><span class="co">#&gt; 4 white     1   235</span></a></code></pre></div>
<p>If we want to calculate callback rates by race, we can use the <code>mutate()</code> function from <strong>dplyr</strong>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">race_call_rate &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="st">  </span>race_call_tab <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(race) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">call_rate =</span>  n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(call <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(race, call_rate)</a>
<a class="sourceLine" id="cb30-7" data-line-number="7">race_call_rate</a>
<a class="sourceLine" id="cb30-8" data-line-number="8"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb30-9" data-line-number="9"><span class="co">#&gt; # Groups: race [2]</span></a>
<a class="sourceLine" id="cb30-10" data-line-number="10"><span class="co">#&gt;   race  call_rate</span></a>
<a class="sourceLine" id="cb30-11" data-line-number="11"><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb30-12" data-line-number="12"><span class="co">#&gt; 1 black    0.0645</span></a>
<a class="sourceLine" id="cb30-13" data-line-number="13"><span class="co">#&gt; 2 white    0.0965</span></a></code></pre></div>
<p>If we want the overall callback rate, we can calculate it from the original data. Use the <code>summarise()</code> function from <strong>dplyr</strong>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">call_back =</span> <span class="kw">mean</span>(call))</a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="co">#&gt;   call_back</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="co">#&gt; 1    0.0805</span></a></code></pre></div>
</section>
<section id="subsetting-data-in-r" class="level2">
<h2><span class="header-section-number">2.2</span> Subsetting Data in R</h2>
<section id="subsetting" class="level3">
<h3><span class="header-section-number">2.2.1</span> Subsetting</h3>
<p>Create a new object of all individuals whose <code>race</code> variable equals <code>black</code> in the <code>resume</code> data:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">resumeB &lt;-</a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="st">  </span>resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(race <span class="op">==</span><span class="st"> &quot;black&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw">glimpse</span>(resumeB)</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="co">#&gt; Observations: 2,435</span></a>
<a class="sourceLine" id="cb33-3" data-line-number="3"><span class="co">#&gt; Variables: 4</span></a>
<a class="sourceLine" id="cb33-4" data-line-number="4"><span class="co">#&gt; $ firstname &lt;chr&gt; &quot;Lakisha&quot;, &quot;Latonya&quot;, &quot;Kenya&quot;, &quot;Latonya&quot;, &quot;Tyrone&quot;, ...</span></a>
<a class="sourceLine" id="cb33-5" data-line-number="5"><span class="co">#&gt; $ sex       &lt;chr&gt; &quot;female&quot;, &quot;female&quot;, &quot;female&quot;, &quot;female&quot;, &quot;male&quot;, &quot;fem...</span></a>
<a class="sourceLine" id="cb33-6" data-line-number="6"><span class="co">#&gt; $ race      &lt;chr&gt; &quot;black&quot;, &quot;black&quot;, &quot;black&quot;, &quot;black&quot;, &quot;black&quot;, &quot;black&quot;...</span></a>
<a class="sourceLine" id="cb33-7" data-line-number="7"><span class="co">#&gt; $ call      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0...</span></a></code></pre></div>
<p>Calculate the callback rate for black individuals:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">resumeB <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">call_rate =</span> <span class="kw">mean</span>(call))</a>
<a class="sourceLine" id="cb34-3" data-line-number="3"><span class="co">#&gt;   call_rate</span></a>
<a class="sourceLine" id="cb34-4" data-line-number="4"><span class="co">#&gt; 1    0.0645</span></a></code></pre></div>
<p>You can combine the <code>filter()</code> and <code>select()</code> functions with multiple conditions. For example, to keep the call and first name variables for female individuals with stereotypically black names:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">resumeBf &lt;-</a>
<a class="sourceLine" id="cb35-2" data-line-number="2"><span class="st">  </span>resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(race <span class="op">==</span><span class="st"> &quot;black&quot;</span>, sex <span class="op">==</span><span class="st"> &quot;female&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(call, firstname)</a>
<a class="sourceLine" id="cb35-5" data-line-number="5"><span class="kw">head</span>(resumeBf)</a>
<a class="sourceLine" id="cb35-6" data-line-number="6"><span class="co">#&gt;   call firstname</span></a>
<a class="sourceLine" id="cb35-7" data-line-number="7"><span class="co">#&gt; 1    0   Lakisha</span></a>
<a class="sourceLine" id="cb35-8" data-line-number="8"><span class="co">#&gt; 2    0   Latonya</span></a>
<a class="sourceLine" id="cb35-9" data-line-number="9"><span class="co">#&gt; 3    0     Kenya</span></a>
<a class="sourceLine" id="cb35-10" data-line-number="10"><span class="co">#&gt; 4    0   Latonya</span></a>
<a class="sourceLine" id="cb35-11" data-line-number="11"><span class="co">#&gt; 5    0     Aisha</span></a>
<a class="sourceLine" id="cb35-12" data-line-number="12"><span class="co">#&gt; 6    0     Aisha</span></a></code></pre></div>
<p>Now we can calculate the gender gap by group.</p>
<p>Now we can calculate the gender gap by group. Doing so may seem to require a little more code, but we will not duplicate as much as in <em>QSS</em>, and this would easily scale to more than two categories.</p>
<p>First, group by race and sex and calculate the callback rate for each group:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">resume_race_sex &lt;-</a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="st">  </span>resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(race, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">call =</span> <span class="kw">mean</span>(call))</a>
<a class="sourceLine" id="cb36-5" data-line-number="5"><span class="kw">head</span>(resume_race_sex)</a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb36-7" data-line-number="7"><span class="co">#&gt; # Groups: race [2]</span></a>
<a class="sourceLine" id="cb36-8" data-line-number="8"><span class="co">#&gt;   race  sex      call</span></a>
<a class="sourceLine" id="cb36-9" data-line-number="9"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb36-10" data-line-number="10"><span class="co">#&gt; 1 black female 0.0663</span></a>
<a class="sourceLine" id="cb36-11" data-line-number="11"><span class="co">#&gt; 2 black male   0.0583</span></a>
<a class="sourceLine" id="cb36-12" data-line-number="12"><span class="co">#&gt; 3 white female 0.0989</span></a>
<a class="sourceLine" id="cb36-13" data-line-number="13"><span class="co">#&gt; 4 white male   0.0887</span></a></code></pre></div>
<p>Use <code>spread()</code> from the <strong>tidyr</strong> package to make each value of <code>race</code> a new column:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"></a>
<a class="sourceLine" id="cb37-2" data-line-number="2">resume_sex &lt;-</a>
<a class="sourceLine" id="cb37-3" data-line-number="3"><span class="st">  </span>resume_race_sex <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-4" data-line-number="4"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-5" data-line-number="5"><span class="st">  </span><span class="kw">spread</span>(race, call)</a>
<a class="sourceLine" id="cb37-6" data-line-number="6">resume_sex</a>
<a class="sourceLine" id="cb37-7" data-line-number="7"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb37-8" data-line-number="8"><span class="co">#&gt;   sex     black  white</span></a>
<a class="sourceLine" id="cb37-9" data-line-number="9"><span class="co">#&gt; * &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb37-10" data-line-number="10"><span class="co">#&gt; 1 female 0.0663 0.0989</span></a>
<a class="sourceLine" id="cb37-11" data-line-number="11"><span class="co">#&gt; 2 male   0.0583 0.0887</span></a></code></pre></div>
<p>Now we can calculate the race wage differences by sex as before,</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">resume_sex <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">call_diff =</span> white <span class="op">-</span><span class="st"> </span>black)</a>
<a class="sourceLine" id="cb38-3" data-line-number="3"><span class="co">#&gt; # A tibble: 2 x 4</span></a>
<a class="sourceLine" id="cb38-4" data-line-number="4"><span class="co">#&gt;   sex     black  white call_diff</span></a>
<a class="sourceLine" id="cb38-5" data-line-number="5"><span class="co">#&gt;   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb38-6" data-line-number="6"><span class="co">#&gt; 1 female 0.0663 0.0989    0.0326</span></a>
<a class="sourceLine" id="cb38-7" data-line-number="7"><span class="co">#&gt; 2 male   0.0583 0.0887    0.0304</span></a></code></pre></div>
<p>This could be combined into a single chain with only six lines of code:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(race, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">call =</span> <span class="kw">mean</span>(call)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-4" data-line-number="4"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-5" data-line-number="5"><span class="st">  </span><span class="kw">spread</span>(race, call) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">call_diff =</span> white <span class="op">-</span><span class="st"> </span>black)</a>
<a class="sourceLine" id="cb39-7" data-line-number="7"><span class="co">#&gt; # A tibble: 2 x 4</span></a>
<a class="sourceLine" id="cb39-8" data-line-number="8"><span class="co">#&gt;   sex     black  white call_diff</span></a>
<a class="sourceLine" id="cb39-9" data-line-number="9"><span class="co">#&gt;   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb39-10" data-line-number="10"><span class="co">#&gt; 1 female 0.0663 0.0989    0.0326</span></a>
<a class="sourceLine" id="cb39-11" data-line-number="11"><span class="co">#&gt; 2 male   0.0583 0.0887    0.0304</span></a></code></pre></div>
<p>For more information on a way to do this using the <a href="https://www.rdocumentation.org/packages/tidyr/topics/spread">spread</a> and <a href="https://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a> functions from <a href="https://cran.r-project.org/package=tidyr">tidyr</a> package, see the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/tidy-data.html">“Tidy Data”</a>.</p>
<p><strong>WARNING</strong> The function <a href="https://www.rdocumentation.org/packages/dplyr/topics/ungroup">ungroup</a> removes the groupings in <a href="https://www.rdocumentation.org/packages/dplyr/topics/group_by">group_by</a>. The function <code>spread</code> will not allow a grouping variable to be reshaped. Since many <strong>dplyr</strong> functions work differently depending on whether the data frame is grouped or not, I find that I can encounter many errors due to forgetting that a data frame is grouped. As such, I tend to <code>ungroup</code> data frames as soon as I am no longer are using the groupings.</p>
<p>Alternatively, we could have used <code>summarise</code> and the <code>diff</code> function:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(race, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">call =</span> <span class="kw">mean</span>(call)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-5" data-line-number="5"><span class="st">  </span><span class="kw">arrange</span>(race) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">call_diff =</span> <span class="kw">diff</span>(call))</a>
<a class="sourceLine" id="cb40-7" data-line-number="7"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb40-8" data-line-number="8"><span class="co">#&gt;   sex    call_diff</span></a>
<a class="sourceLine" id="cb40-9" data-line-number="9"><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb40-10" data-line-number="10"><span class="co">#&gt; 1 female    0.0326</span></a>
<a class="sourceLine" id="cb40-11" data-line-number="11"><span class="co">#&gt; 2 male      0.0304</span></a></code></pre></div>
<p>I find the <code>spread</code> code preferable since the individual race callback rates are retained in the data, and since there is no natural ordering of the <code>race</code> variable (unlike if it were a time-series), it is not obvious from reading the code whether <code>call_diff</code> is <code>black - white</code> or <code>white - black</code>.</p>
</section>
<section id="simple-conditional-statements" class="level3">
<h3><span class="header-section-number">2.2.2</span> Simple conditional statements</h3>
<p><strong>dlpyr</strong> has three conditional statement functions <code>if_else</code>, <code>recode</code> and <code>case_when</code>.</p>
<p>The function <code>if_else</code> is like <code>ifelse</code> but corrects inconsistent behavior that <code>ifelse</code> exhibits in certain cases.</p>
<p>Create a variable <code>BlackFemale</code> using <code>if_else()</code> and confirm it is only equal to <code>1</code> for black and female observations:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">BlackFemale =</span> <span class="kw">if_else</span>(race <span class="op">==</span><span class="st"> &quot;black&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sex <span class="op">==</span><span class="st"> &quot;female&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(BlackFemale, race, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-4" data-line-number="4"><span class="st">  </span><span class="kw">count</span>()</a>
<a class="sourceLine" id="cb41-5" data-line-number="5"><span class="co">#&gt; # A tibble: 4 x 4</span></a>
<a class="sourceLine" id="cb41-6" data-line-number="6"><span class="co">#&gt; # Groups: BlackFemale, race, sex [4]</span></a>
<a class="sourceLine" id="cb41-7" data-line-number="7"><span class="co">#&gt;   BlackFemale race  sex        n</span></a>
<a class="sourceLine" id="cb41-8" data-line-number="8"><span class="co">#&gt;         &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb41-9" data-line-number="9"><span class="co">#&gt; 1        0    black male     549</span></a>
<a class="sourceLine" id="cb41-10" data-line-number="10"><span class="co">#&gt; 2        0    white female  1860</span></a>
<a class="sourceLine" id="cb41-11" data-line-number="11"><span class="co">#&gt; 3        0    white male     575</span></a>
<a class="sourceLine" id="cb41-12" data-line-number="12"><span class="co">#&gt; 4        1.00 black female  1886</span></a></code></pre></div>
<p><strong>Warning</strong> The function <code>if_else</code> is more strict about the variable types than <code>ifelse</code>. While most R functions are forgiving about variables types, and will automatically convert integers to numeric or vice-versa, they are distinct. For example, these examples will produce errors:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">BlackFemale =</span> <span class="kw">if_else</span>(race <span class="op">==</span><span class="st"> &quot;black&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sex <span class="op">==</span><span class="st"> &quot;female&quot;</span>, <span class="ot">TRUE</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb42-3" data-line-number="3"><span class="co">#&gt; Error in mutate_impl(.data, dots): Evaluation error: `false` must be type logical, not double.</span></a></code></pre></div>
<p>because <code>TRUE</code> is logical and <code>0</code> is numeric.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">BlackFemale =</span> <span class="kw">if_else</span>(race <span class="op">==</span><span class="st"> &quot;black&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sex <span class="op">==</span><span class="st"> &quot;female&quot;</span>, 1L, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb43-3" data-line-number="3"><span class="co">#&gt; Error in mutate_impl(.data, dots): Evaluation error: `false` must be type integer, not double.</span></a></code></pre></div>
<p>because <code>1L</code> is an integer and <code>0</code> is numeric vector (floating-point number). The distinction between integers and numeric variables is often invisible because most functions coerce variables between integer and numeric vectors.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="kw">class</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb44-2" data-line-number="2"><span class="co">#&gt; [1] &quot;numeric&quot;</span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="kw">class</span>(1L)</a>
<a class="sourceLine" id="cb44-4" data-line-number="4"><span class="co">#&gt; [1] &quot;integer&quot;</span></a></code></pre></div>
<p>The <code>:</code> operator returns integers and <code>as.integer</code> coerces numeric vectors to integer vectors:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="kw">class</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb45-2" data-line-number="2"><span class="co">#&gt; [1] &quot;integer&quot;</span></a>
<a class="sourceLine" id="cb45-3" data-line-number="3"><span class="kw">class</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb45-4" data-line-number="4"><span class="co">#&gt; [1] &quot;numeric&quot;</span></a>
<a class="sourceLine" id="cb45-5" data-line-number="5"><span class="kw">class</span>(<span class="kw">as.integer</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb45-6" data-line-number="6"><span class="co">#&gt; [1] &quot;integer&quot;</span></a></code></pre></div>
</section>
<section id="factor-variables" class="level3">
<h3><span class="header-section-number">2.2.3</span> Factor Variables</h3>
<p>For more on factors see the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/factors.html">“Factors”</a> and the package <a href="https://cran.r-project.org/package=forcats">forcats</a>. Also see the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/strings.html">“Strings”</a> for working with strings.</p>
<p>The function <code>case_when</code> is a generalization of the <code>if_else</code> function to multiple conditions. For example, to create categories for all combinations of race and sex,</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb46-3" data-line-number="3">    <span class="dt">race_sex =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb46-4" data-line-number="4">      race <span class="op">==</span><span class="st"> &quot;black&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sex <span class="op">==</span><span class="st"> &quot;female&quot;</span> <span class="op">~</span><span class="st"> &quot;black, female&quot;</span>,</a>
<a class="sourceLine" id="cb46-5" data-line-number="5">      race <span class="op">==</span><span class="st"> &quot;white&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sex <span class="op">==</span><span class="st"> &quot;female&quot;</span> <span class="op">~</span><span class="st"> &quot;white female&quot;</span>,</a>
<a class="sourceLine" id="cb46-6" data-line-number="6">      race <span class="op">==</span><span class="st"> &quot;black&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sex <span class="op">==</span><span class="st"> &quot;male&quot;</span> <span class="op">~</span><span class="st"> &quot;black male&quot;</span>,</a>
<a class="sourceLine" id="cb46-7" data-line-number="7">      race <span class="op">==</span><span class="st"> &quot;white&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sex <span class="op">==</span><span class="st"> &quot;male&quot;</span> <span class="op">~</span><span class="st"> &quot;white male&quot;</span></a>
<a class="sourceLine" id="cb46-8" data-line-number="8">    )</a>
<a class="sourceLine" id="cb46-9" data-line-number="9">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-10" data-line-number="10"><span class="st">  </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb46-11" data-line-number="11"><span class="co">#&gt;   firstname    sex  race call      race_sex</span></a>
<a class="sourceLine" id="cb46-12" data-line-number="12"><span class="co">#&gt; 1   Allison female white    0  white female</span></a>
<a class="sourceLine" id="cb46-13" data-line-number="13"><span class="co">#&gt; 2   Kristen female white    0  white female</span></a>
<a class="sourceLine" id="cb46-14" data-line-number="14"><span class="co">#&gt; 3   Lakisha female black    0 black, female</span></a>
<a class="sourceLine" id="cb46-15" data-line-number="15"><span class="co">#&gt; 4   Latonya female black    0 black, female</span></a>
<a class="sourceLine" id="cb46-16" data-line-number="16"><span class="co">#&gt; 5    Carrie female white    0  white female</span></a>
<a class="sourceLine" id="cb46-17" data-line-number="17"><span class="co">#&gt; 6       Jay   male white    0    white male</span></a></code></pre></div>
<p>Each condition is a formula (an R object created with the “tilde” <code>~</code>). You will see formulas used extensively in the modeling section. The condition is on the left-hand side of the formula. The value to assign to observations meeting that condition is on the right-hand side. Observations are given the value of the first matching condition, so the order of these can matter.</p>
<p>The <code>case_when</code> function also supports a default value by using a condition <code>TRUE</code> as the last condition. This will match anything not already matched. For example, if you wanted three categories (“black male”, “black female”, “white”):</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb47-3" data-line-number="3">    <span class="dt">race_sex =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb47-4" data-line-number="4">      race <span class="op">==</span><span class="st"> &quot;black&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sex <span class="op">==</span><span class="st"> &quot;female&quot;</span> <span class="op">~</span><span class="st"> &quot;black female&quot;</span>,</a>
<a class="sourceLine" id="cb47-5" data-line-number="5">      race <span class="op">==</span><span class="st"> &quot;black&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sex <span class="op">==</span><span class="st"> &quot;male&quot;</span> <span class="op">~</span><span class="st"> &quot;black male&quot;</span>,</a>
<a class="sourceLine" id="cb47-6" data-line-number="6">      <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> &quot;white&quot;</span></a>
<a class="sourceLine" id="cb47-7" data-line-number="7">    )</a>
<a class="sourceLine" id="cb47-8" data-line-number="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-9" data-line-number="9"><span class="st">  </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb47-10" data-line-number="10"><span class="co">#&gt;   firstname    sex  race call     race_sex</span></a>
<a class="sourceLine" id="cb47-11" data-line-number="11"><span class="co">#&gt; 1   Allison female white    0        white</span></a>
<a class="sourceLine" id="cb47-12" data-line-number="12"><span class="co">#&gt; 2   Kristen female white    0        white</span></a>
<a class="sourceLine" id="cb47-13" data-line-number="13"><span class="co">#&gt; 3   Lakisha female black    0 black female</span></a>
<a class="sourceLine" id="cb47-14" data-line-number="14"><span class="co">#&gt; 4   Latonya female black    0 black female</span></a>
<a class="sourceLine" id="cb47-15" data-line-number="15"><span class="co">#&gt; 5    Carrie female white    0        white</span></a>
<a class="sourceLine" id="cb47-16" data-line-number="16"><span class="co">#&gt; 6       Jay   male white    0        white</span></a></code></pre></div>
<p>Alternatively, we could have created this variable using string manipulation functions. Use <code>mutate()</code> to create a new variable, <code>type</code>, <a href="https://www.rdocumentation.org/packages/stringr/topics/str_to_title">str_to_title</a> to capitalize <code>sex</code> and <code>race</code>, and <a href="https://www.rdocumentation.org/packages/stringr/topics/str_c">str_c</a> to concatenate these vectors.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1">resume &lt;-</a>
<a class="sourceLine" id="cb48-2" data-line-number="2"><span class="st">  </span>resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="kw">str_c</span>(<span class="kw">str_to_title</span>(race), <span class="kw">str_to_title</span>(sex)))</a></code></pre></div>
<p>Some of the reasons given in <em>QSS</em> for using factors in this chapter are less important due to the functionality of modern <strong>tidyverse</strong> packages. For example, there is no reason to use <code>tapply</code>, as you can use <code>group_by</code> and <code>summarise</code>,</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb49-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(type) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb49-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">call =</span> <span class="kw">mean</span>(call))</a>
<a class="sourceLine" id="cb49-4" data-line-number="4"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb49-5" data-line-number="5"><span class="co">#&gt;   type          call</span></a>
<a class="sourceLine" id="cb49-6" data-line-number="6"><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb49-7" data-line-number="7"><span class="co">#&gt; 1 BlackFemale 0.0663</span></a>
<a class="sourceLine" id="cb49-8" data-line-number="8"><span class="co">#&gt; 2 BlackMale   0.0583</span></a>
<a class="sourceLine" id="cb49-9" data-line-number="9"><span class="co">#&gt; 3 WhiteFemale 0.0989</span></a>
<a class="sourceLine" id="cb49-10" data-line-number="10"><span class="co">#&gt; 4 WhiteMale   0.0887</span></a></code></pre></div>
<p>or,</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(race, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">call =</span> <span class="kw">mean</span>(call))</a>
<a class="sourceLine" id="cb50-4" data-line-number="4"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb50-5" data-line-number="5"><span class="co">#&gt; # Groups: race [?]</span></a>
<a class="sourceLine" id="cb50-6" data-line-number="6"><span class="co">#&gt;   race  sex      call</span></a>
<a class="sourceLine" id="cb50-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb50-8" data-line-number="8"><span class="co">#&gt; 1 black female 0.0663</span></a>
<a class="sourceLine" id="cb50-9" data-line-number="9"><span class="co">#&gt; 2 black male   0.0583</span></a>
<a class="sourceLine" id="cb50-10" data-line-number="10"><span class="co">#&gt; 3 white female 0.0989</span></a>
<a class="sourceLine" id="cb50-11" data-line-number="11"><span class="co">#&gt; 4 white male   0.0887</span></a></code></pre></div>
<p>What’s nice about this approach is that we wouldn’t have needed to create the factor variable first as in <em>QSS</em>.</p>
<p>We can use that same approach to calculate the mean of first names, and use <code>arrange()</code> to sort in ascending order.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" data-line-number="1">resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb51-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(firstname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb51-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">call =</span> <span class="kw">mean</span>(call)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb51-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(call)</a>
<a class="sourceLine" id="cb51-5" data-line-number="5"><span class="co">#&gt; # A tibble: 36 x 2</span></a>
<a class="sourceLine" id="cb51-6" data-line-number="6"><span class="co">#&gt;   firstname   call</span></a>
<a class="sourceLine" id="cb51-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb51-8" data-line-number="8"><span class="co">#&gt; 1 Aisha     0.0222</span></a>
<a class="sourceLine" id="cb51-9" data-line-number="9"><span class="co">#&gt; 2 Rasheed   0.0299</span></a>
<a class="sourceLine" id="cb51-10" data-line-number="10"><span class="co">#&gt; 3 Keisha    0.0383</span></a>
<a class="sourceLine" id="cb51-11" data-line-number="11"><span class="co">#&gt; 4 Tremayne  0.0435</span></a>
<a class="sourceLine" id="cb51-12" data-line-number="12"><span class="co">#&gt; 5 Kareem    0.0469</span></a>
<a class="sourceLine" id="cb51-13" data-line-number="13"><span class="co">#&gt; 6 Darnell   0.0476</span></a>
<a class="sourceLine" id="cb51-14" data-line-number="14"><span class="co">#&gt; # ... with 30 more rows</span></a></code></pre></div>
<p><strong>Tip:</strong> General advice for working (or not) with factors:</p>
<ul>
<li>Use character vectors instead of factors. They are easier to manipulate with string functions.</li>
<li>Use factor vectors only when you need a specific ordering of string values in a variable, e.g. in a model or a plot.</li>
</ul>
</section>
</section>
<section id="causal-affects-and-the-counterfactual" class="level2">
<h2><span class="header-section-number">2.3</span> Causal Affects and the Counterfactual</h2>
<p>Load the <code>social</code> dataset included in the <strong>qss</strong> package.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;social&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb52-2" data-line-number="2"><span class="kw">summary</span>(social)</a>
<a class="sourceLine" id="cb52-3" data-line-number="3"><span class="co">#&gt;      sex             yearofbirth    primary2004      messages        </span></a>
<a class="sourceLine" id="cb52-4" data-line-number="4"><span class="co">#&gt;  Length:305866      Min.   :1900   Min.   :0.000   Length:305866     </span></a>
<a class="sourceLine" id="cb52-5" data-line-number="5"><span class="co">#&gt;  Class :character   1st Qu.:1947   1st Qu.:0.000   Class :character  </span></a>
<a class="sourceLine" id="cb52-6" data-line-number="6"><span class="co">#&gt;  Mode  :character   Median :1956   Median :0.000   Mode  :character  </span></a>
<a class="sourceLine" id="cb52-7" data-line-number="7"><span class="co">#&gt;                     Mean   :1956   Mean   :0.401                     </span></a>
<a class="sourceLine" id="cb52-8" data-line-number="8"><span class="co">#&gt;                     3rd Qu.:1965   3rd Qu.:1.000                     </span></a>
<a class="sourceLine" id="cb52-9" data-line-number="9"><span class="co">#&gt;                     Max.   :1986   Max.   :1.000                     </span></a>
<a class="sourceLine" id="cb52-10" data-line-number="10"><span class="co">#&gt;   primary2006        hhsize    </span></a>
<a class="sourceLine" id="cb52-11" data-line-number="11"><span class="co">#&gt;  Min.   :0.000   Min.   :1.00  </span></a>
<a class="sourceLine" id="cb52-12" data-line-number="12"><span class="co">#&gt;  1st Qu.:0.000   1st Qu.:2.00  </span></a>
<a class="sourceLine" id="cb52-13" data-line-number="13"><span class="co">#&gt;  Median :0.000   Median :2.00  </span></a>
<a class="sourceLine" id="cb52-14" data-line-number="14"><span class="co">#&gt;  Mean   :0.312   Mean   :2.18  </span></a>
<a class="sourceLine" id="cb52-15" data-line-number="15"><span class="co">#&gt;  3rd Qu.:1.000   3rd Qu.:2.00  </span></a>
<a class="sourceLine" id="cb52-16" data-line-number="16"><span class="co">#&gt;  Max.   :1.000   Max.   :8.00</span></a></code></pre></div>
<p>Calculate the mean turnout by <code>message</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1">turnout_by_message &lt;-</a>
<a class="sourceLine" id="cb53-2" data-line-number="2"><span class="st">  </span>social <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(messages) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-4" data-line-number="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">turnout =</span> <span class="kw">mean</span>(primary2006))</a>
<a class="sourceLine" id="cb53-5" data-line-number="5">turnout_by_message</a>
<a class="sourceLine" id="cb53-6" data-line-number="6"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb53-7" data-line-number="7"><span class="co">#&gt;   messages   turnout</span></a>
<a class="sourceLine" id="cb53-8" data-line-number="8"><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb53-9" data-line-number="9"><span class="co">#&gt; 1 Civic Duty   0.315</span></a>
<a class="sourceLine" id="cb53-10" data-line-number="10"><span class="co">#&gt; 2 Control      0.297</span></a>
<a class="sourceLine" id="cb53-11" data-line-number="11"><span class="co">#&gt; 3 Hawthorne    0.322</span></a>
<a class="sourceLine" id="cb53-12" data-line-number="12"><span class="co">#&gt; 4 Neighbors    0.378</span></a></code></pre></div>
<p>Since we want to calculate the difference by group, <code>spread()</code> the data set so each group is a column, then use <code>mutate()</code> to calculate the difference of each from the control group. Finally, use <code>select()</code> and <code>matches()</code> to return a dataframe with only those new variables that you have created:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1">turnout_by_message <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-2" data-line-number="2"><span class="st">  </span><span class="kw">spread</span>(messages, turnout) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff_civic_duty =</span> <span class="st">`</span><span class="dt">Civic Duty</span><span class="st">`</span> <span class="op">-</span><span class="st"> </span>Control,</a>
<a class="sourceLine" id="cb54-4" data-line-number="4">         <span class="dt">diff_Hawthorne =</span> Hawthorne <span class="op">-</span><span class="st"> </span>Control,</a>
<a class="sourceLine" id="cb54-5" data-line-number="5">         <span class="dt">diff_Neighbors =</span> Neighbors <span class="op">-</span><span class="st"> </span>Control) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="kw">matches</span>(<span class="st">&quot;diff_&quot;</span>))</a>
<a class="sourceLine" id="cb54-7" data-line-number="7"><span class="co">#&gt; # A tibble: 1 x 3</span></a>
<a class="sourceLine" id="cb54-8" data-line-number="8"><span class="co">#&gt;   diff_civic_duty diff_Hawthorne diff_Neighbors</span></a>
<a class="sourceLine" id="cb54-9" data-line-number="9"><span class="co">#&gt;             &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb54-10" data-line-number="10"><span class="co">#&gt; 1          0.0179         0.0257         0.0813</span></a></code></pre></div>
<p>Find the mean values of age, 2004 turnout, and household size for each group:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1">social <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> <span class="dv">2006</span> <span class="op">-</span><span class="st"> </span>yearofbirth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(messages) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">primary2004 =</span> <span class="kw">mean</span>(primary2004),</a>
<a class="sourceLine" id="cb55-5" data-line-number="5">            <span class="dt">age =</span> <span class="kw">mean</span>(age),</a>
<a class="sourceLine" id="cb55-6" data-line-number="6">            <span class="dt">hhsize =</span> <span class="kw">mean</span>(hhsize))</a>
<a class="sourceLine" id="cb55-7" data-line-number="7"><span class="co">#&gt; # A tibble: 4 x 4</span></a>
<a class="sourceLine" id="cb55-8" data-line-number="8"><span class="co">#&gt;   messages   primary2004   age hhsize</span></a>
<a class="sourceLine" id="cb55-9" data-line-number="9"><span class="co">#&gt;   &lt;chr&gt;            &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb55-10" data-line-number="10"><span class="co">#&gt; 1 Civic Duty       0.399  49.7   2.19</span></a>
<a class="sourceLine" id="cb55-11" data-line-number="11"><span class="co">#&gt; 2 Control          0.400  49.8   2.18</span></a>
<a class="sourceLine" id="cb55-12" data-line-number="12"><span class="co">#&gt; 3 Hawthorne        0.403  49.7   2.18</span></a>
<a class="sourceLine" id="cb55-13" data-line-number="13"><span class="co">#&gt; 4 Neighbors        0.407  49.9   2.19</span></a></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/dplyr/topics/summarise_at">summarise_at</a> allows you to summarize multiple variables, using multiple functions, or both.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1">social <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb56-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> <span class="dv">2006</span> <span class="op">-</span><span class="st"> </span>yearofbirth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb56-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(messages) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb56-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(primary2004, age, hhsize), <span class="kw">funs</span>(mean))</a>
<a class="sourceLine" id="cb56-5" data-line-number="5"><span class="co">#&gt; # A tibble: 4 x 4</span></a>
<a class="sourceLine" id="cb56-6" data-line-number="6"><span class="co">#&gt;   messages   primary2004   age hhsize</span></a>
<a class="sourceLine" id="cb56-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;            &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb56-8" data-line-number="8"><span class="co">#&gt; 1 Civic Duty       0.399  49.7   2.19</span></a>
<a class="sourceLine" id="cb56-9" data-line-number="9"><span class="co">#&gt; 2 Control          0.400  49.8   2.18</span></a>
<a class="sourceLine" id="cb56-10" data-line-number="10"><span class="co">#&gt; 3 Hawthorne        0.403  49.7   2.18</span></a>
<a class="sourceLine" id="cb56-11" data-line-number="11"><span class="co">#&gt; 4 Neighbors        0.407  49.9   2.19</span></a></code></pre></div>
</section>
<section id="observational-studies" class="level2">
<h2><span class="header-section-number">2.4</span> Observational Studies</h2>
<p>Load and inspect the minimum wage data from the <strong>qss</strong> package:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;minwage&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb57-2" data-line-number="2"><span class="kw">glimpse</span>(minwage)</a>
<a class="sourceLine" id="cb57-3" data-line-number="3"><span class="co">#&gt; Observations: 358</span></a>
<a class="sourceLine" id="cb57-4" data-line-number="4"><span class="co">#&gt; Variables: 8</span></a>
<a class="sourceLine" id="cb57-5" data-line-number="5"><span class="co">#&gt; $ chain      &lt;chr&gt; &quot;wendys&quot;, &quot;wendys&quot;, &quot;burgerking&quot;, &quot;burgerking&quot;, &quot;kf...</span></a>
<a class="sourceLine" id="cb57-6" data-line-number="6"><span class="co">#&gt; $ location   &lt;chr&gt; &quot;PA&quot;, &quot;PA&quot;, &quot;PA&quot;, &quot;PA&quot;, &quot;PA&quot;, &quot;PA&quot;, &quot;PA&quot;, &quot;PA&quot;, &quot;PA...</span></a>
<a class="sourceLine" id="cb57-7" data-line-number="7"><span class="co">#&gt; $ wageBefore &lt;dbl&gt; 5.00, 5.50, 5.00, 5.00, 5.25, 5.00, 5.00, 5.00, 5.0...</span></a>
<a class="sourceLine" id="cb57-8" data-line-number="8"><span class="co">#&gt; $ wageAfter  &lt;dbl&gt; 5.25, 4.75, 4.75, 5.00, 5.00, 5.00, 4.75, 5.00, 4.5...</span></a>
<a class="sourceLine" id="cb57-9" data-line-number="9"><span class="co">#&gt; $ fullBefore &lt;dbl&gt; 20.0, 6.0, 50.0, 10.0, 2.0, 2.0, 2.5, 40.0, 8.0, 10...</span></a>
<a class="sourceLine" id="cb57-10" data-line-number="10"><span class="co">#&gt; $ fullAfter  &lt;dbl&gt; 0.0, 28.0, 15.0, 26.0, 3.0, 2.0, 1.0, 9.0, 7.0, 18....</span></a>
<a class="sourceLine" id="cb57-11" data-line-number="11"><span class="co">#&gt; $ partBefore &lt;dbl&gt; 20.0, 26.0, 35.0, 17.0, 8.0, 10.0, 20.0, 30.0, 27.0...</span></a>
<a class="sourceLine" id="cb57-12" data-line-number="12"><span class="co">#&gt; $ partAfter  &lt;dbl&gt; 36, 3, 18, 9, 12, 9, 25, 32, 39, 10, 20, 4, 13, 20,...</span></a>
<a class="sourceLine" id="cb57-13" data-line-number="13"><span class="kw">summary</span>(minwage)</a>
<a class="sourceLine" id="cb57-14" data-line-number="14"><span class="co">#&gt;     chain             location           wageBefore     wageAfter   </span></a>
<a class="sourceLine" id="cb57-15" data-line-number="15"><span class="co">#&gt;  Length:358         Length:358         Min.   :4.25   Min.   :4.25  </span></a>
<a class="sourceLine" id="cb57-16" data-line-number="16"><span class="co">#&gt;  Class :character   Class :character   1st Qu.:4.25   1st Qu.:5.05  </span></a>
<a class="sourceLine" id="cb57-17" data-line-number="17"><span class="co">#&gt;  Mode  :character   Mode  :character   Median :4.50   Median :5.05  </span></a>
<a class="sourceLine" id="cb57-18" data-line-number="18"><span class="co">#&gt;                                        Mean   :4.62   Mean   :4.99  </span></a>
<a class="sourceLine" id="cb57-19" data-line-number="19"><span class="co">#&gt;                                        3rd Qu.:4.99   3rd Qu.:5.05  </span></a>
<a class="sourceLine" id="cb57-20" data-line-number="20"><span class="co">#&gt;                                        Max.   :5.75   Max.   :6.25  </span></a>
<a class="sourceLine" id="cb57-21" data-line-number="21"><span class="co">#&gt;    fullBefore     fullAfter      partBefore     partAfter   </span></a>
<a class="sourceLine" id="cb57-22" data-line-number="22"><span class="co">#&gt;  Min.   : 0.0   Min.   : 0.0   Min.   : 0.0   Min.   : 0.0  </span></a>
<a class="sourceLine" id="cb57-23" data-line-number="23"><span class="co">#&gt;  1st Qu.: 2.1   1st Qu.: 2.0   1st Qu.:11.0   1st Qu.:11.0  </span></a>
<a class="sourceLine" id="cb57-24" data-line-number="24"><span class="co">#&gt;  Median : 6.0   Median : 6.0   Median :16.2   Median :17.0  </span></a>
<a class="sourceLine" id="cb57-25" data-line-number="25"><span class="co">#&gt;  Mean   : 8.5   Mean   : 8.4   Mean   :18.8   Mean   :18.7  </span></a>
<a class="sourceLine" id="cb57-26" data-line-number="26"><span class="co">#&gt;  3rd Qu.:12.0   3rd Qu.:12.0   3rd Qu.:25.0   3rd Qu.:25.0  </span></a>
<a class="sourceLine" id="cb57-27" data-line-number="27"><span class="co">#&gt;  Max.   :60.0   Max.   :40.0   Max.   :60.0   Max.   :60.0</span></a></code></pre></div>
<p>First, calculate the proportion of restaurants by state whose hourly wages were less than the minimum wage in NJ, $5.05, for <code>wageBefore</code> and <code>wageAfter</code>:</p>
<p>Since the NJ minimum wage was $5.05, we’ll define a variable with that value. Even if you use them only once or twice, it is a good idea to put values like this in variables. It makes your code closer to self-documenting, i.e. easier for others (including you, in the future) to understand what the code does.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1">NJ_MINWAGE &lt;-<span class="st"> </span><span class="fl">5.05</span></a></code></pre></div>
<p>Later, it will be easier to understand <code>wageAfter &lt; NJ_MINWAGE</code> without any comments than it would be to understand <code>wageAfter &lt; 5.05</code>. In the latter case you’d have to remember that the new NJ minimum wage was 5.05 and that’s why you were using that value. Using <code>5.05</code> in your code, instead of assigning it to an object called <code>NJ_MINWAGE</code>, is an example of a <a href="https://en.wikipedia.org/wiki/Magic_number_(programming)#Unnamed_numerical_constants">magic number</a>; try to avoid them.</p>
<p>Note that the variable <code>location</code> has multiple values: PA and four regions of NJ. So we’ll add a state variable to the data.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1">minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(location)</a>
<a class="sourceLine" id="cb59-3" data-line-number="3"><span class="co">#&gt; # A tibble: 5 x 2</span></a>
<a class="sourceLine" id="cb59-4" data-line-number="4"><span class="co">#&gt;   location      n</span></a>
<a class="sourceLine" id="cb59-5" data-line-number="5"><span class="co">#&gt;   &lt;chr&gt;     &lt;int&gt;</span></a>
<a class="sourceLine" id="cb59-6" data-line-number="6"><span class="co">#&gt; 1 centralNJ    45</span></a>
<a class="sourceLine" id="cb59-7" data-line-number="7"><span class="co">#&gt; 2 northNJ     146</span></a>
<a class="sourceLine" id="cb59-8" data-line-number="8"><span class="co">#&gt; 3 PA           67</span></a>
<a class="sourceLine" id="cb59-9" data-line-number="9"><span class="co">#&gt; 4 shoreNJ      33</span></a>
<a class="sourceLine" id="cb59-10" data-line-number="10"><span class="co">#&gt; 5 southNJ      67</span></a></code></pre></div>
<p>We can extract the state from the final two characters of the location variable using the<a href="https://cran.r-project.org/package=stringr">stringr</a> function <a href="https://www.rdocumentation.org/packages/stringr/topics/str_sub">str_sub</a>:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1">minwage &lt;-</a>
<a class="sourceLine" id="cb60-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(minwage, <span class="dt">state =</span> <span class="kw">str_sub</span>(location, <span class="op">-</span>2L))</a></code></pre></div>
<p>Alternatively, since <code>&quot;PA&quot;</code> is the only value that an observation in Pennsylvania takes in <code>location</code>, and since all other observations are in New Jersey:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1">minwage &lt;-</a>
<a class="sourceLine" id="cb61-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(minwage, <span class="dt">state =</span> <span class="kw">if_else</span>(location <span class="op">==</span><span class="st"> &quot;PA&quot;</span>, <span class="st">&quot;PA&quot;</span>, <span class="st">&quot;NJ&quot;</span>))</a></code></pre></div>
<p>Let’s confirm that the restaurants followed the law:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1">minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb62-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb62-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prop_after =</span> <span class="kw">mean</span>(wageAfter <span class="op">&lt;</span><span class="st"> </span>NJ_MINWAGE),</a>
<a class="sourceLine" id="cb62-4" data-line-number="4">            <span class="dt">prop_Before =</span> <span class="kw">mean</span>(wageBefore <span class="op">&lt;</span><span class="st"> </span>NJ_MINWAGE))</a>
<a class="sourceLine" id="cb62-5" data-line-number="5"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb62-6" data-line-number="6"><span class="co">#&gt;   state prop_after prop_Before</span></a>
<a class="sourceLine" id="cb62-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb62-8" data-line-number="8"><span class="co">#&gt; 1 NJ       0.00344       0.911</span></a>
<a class="sourceLine" id="cb62-9" data-line-number="9"><span class="co">#&gt; 2 PA       0.955         0.940</span></a></code></pre></div>
<p>Create a variable for the proportion of full-time employees in NJ and PA after the increase:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1">minwage &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb63-2" data-line-number="2"><span class="st">  </span>minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">totalAfter =</span> fullAfter <span class="op">+</span><span class="st"> </span>partAfter,</a>
<a class="sourceLine" id="cb63-4" data-line-number="4">        <span class="dt">fullPropAfter =</span> fullAfter <span class="op">/</span><span class="st"> </span>totalAfter)</a></code></pre></div>
<p>Now calculate the average proportion of full-time employees for each state:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1">full_prop_by_state &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb64-2" data-line-number="2"><span class="st">  </span>minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">fullPropAfter =</span> <span class="kw">mean</span>(fullPropAfter))</a>
<a class="sourceLine" id="cb64-5" data-line-number="5">full_prop_by_state</a>
<a class="sourceLine" id="cb64-6" data-line-number="6"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb64-7" data-line-number="7"><span class="co">#&gt;   state fullPropAfter</span></a>
<a class="sourceLine" id="cb64-8" data-line-number="8"><span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb64-9" data-line-number="9"><span class="co">#&gt; 1 NJ            0.320</span></a>
<a class="sourceLine" id="cb64-10" data-line-number="10"><span class="co">#&gt; 2 PA            0.272</span></a></code></pre></div>
<p>We could compute the difference in means between NJ and PA by</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" data-line-number="1">(<span class="kw">filter</span>(full_prop_by_state, state <span class="op">==</span><span class="st"> &quot;NJ&quot;</span>)[[<span class="st">&quot;fullPropAfter&quot;</span>]] <span class="op">-</span></a>
<a class="sourceLine" id="cb65-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(full_prop_by_state, state <span class="op">==</span><span class="st"> &quot;PA&quot;</span>)[[<span class="st">&quot;fullPropAfter&quot;</span>]])</a>
<a class="sourceLine" id="cb65-3" data-line-number="3"><span class="co">#&gt; [1] 0.0481</span></a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1"><span class="kw">spread</span>(full_prop_by_state, state, fullPropAfter) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> NJ <span class="op">-</span><span class="st"> </span>PA)</a>
<a class="sourceLine" id="cb66-3" data-line-number="3"><span class="co">#&gt; # A tibble: 1 x 3</span></a>
<a class="sourceLine" id="cb66-4" data-line-number="4"><span class="co">#&gt;      NJ    PA   diff</span></a>
<a class="sourceLine" id="cb66-5" data-line-number="5"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb66-6" data-line-number="6"><span class="co">#&gt; 1 0.320 0.272 0.0481</span></a></code></pre></div>
<section id="confounding-bias" class="level3">
<h3><span class="header-section-number">2.4.1</span> Confounding Bias</h3>
<p>We can calculate the proportion of each chain out of all fast-food restaurants in each state:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1">chains_by_state &lt;-</a>
<a class="sourceLine" id="cb67-2" data-line-number="2"><span class="st">  </span>minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-4" data-line-number="4"><span class="st">  </span><span class="kw">count</span>(chain) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a></code></pre></div>
<p>We can easily compare these using a dot-plot:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1"><span class="kw">ggplot</span>(chains_by_state, <span class="kw">aes</span>(<span class="dt">x =</span> chain, <span class="dt">y =</span> prop, <span class="dt">colour =</span> state)) <span class="op">+</span></a>
<a class="sourceLine" id="cb68-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb68-3" data-line-number="3"><span class="st">  </span><span class="kw">coord_flip</span>()</a></code></pre></div>
<p><img src="causality_files/figure-html/unnamed-chunk-42-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In the <em>QSS</em> text, only Burger King restaurants are compared. However, <strong>dplyr</strong> makes comparing all restaurants not much more complicated than comparing two. All we have to do is change the <code>group_by</code> statement we used previously so that we group by chain restaurants and states:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1">full_prop_by_state_chain &lt;-</a>
<a class="sourceLine" id="cb69-2" data-line-number="2"><span class="st">  </span>minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(state, chain) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">fullPropAfter =</span> <span class="kw">mean</span>(fullPropAfter))</a>
<a class="sourceLine" id="cb69-5" data-line-number="5">full_prop_by_state_chain</a>
<a class="sourceLine" id="cb69-6" data-line-number="6"><span class="co">#&gt; # A tibble: 8 x 3</span></a>
<a class="sourceLine" id="cb69-7" data-line-number="7"><span class="co">#&gt; # Groups: state [?]</span></a>
<a class="sourceLine" id="cb69-8" data-line-number="8"><span class="co">#&gt;   state chain      fullPropAfter</span></a>
<a class="sourceLine" id="cb69-9" data-line-number="9"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;              &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb69-10" data-line-number="10"><span class="co">#&gt; 1 NJ    burgerking         0.358</span></a>
<a class="sourceLine" id="cb69-11" data-line-number="11"><span class="co">#&gt; 2 NJ    kfc                0.328</span></a>
<a class="sourceLine" id="cb69-12" data-line-number="12"><span class="co">#&gt; 3 NJ    roys               0.283</span></a>
<a class="sourceLine" id="cb69-13" data-line-number="13"><span class="co">#&gt; 4 NJ    wendys             0.260</span></a>
<a class="sourceLine" id="cb69-14" data-line-number="14"><span class="co">#&gt; 5 PA    burgerking         0.321</span></a>
<a class="sourceLine" id="cb69-15" data-line-number="15"><span class="co">#&gt; 6 PA    kfc                0.236</span></a>
<a class="sourceLine" id="cb69-16" data-line-number="16"><span class="co">#&gt; # ... with 2 more rows</span></a></code></pre></div>
<p>We can plot and compare the proportions easily in this format. In general, ordering categorical variables alphabetically is useless, so we’ll order the chains by the average of the NJ and PA <code>fullPropAfter</code>, using <a href="https://www.rdocumentation.org/packages/forcats/topics/fct_reorder">fct_reorder</a> function:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1"><span class="kw">ggplot</span>(full_prop_by_state_chain,</a>
<a class="sourceLine" id="cb70-2" data-line-number="2">       <span class="kw">aes</span>(<span class="dt">x =</span> forcats<span class="op">::</span><span class="kw">fct_reorder</span>(chain, fullPropAfter),</a>
<a class="sourceLine" id="cb70-3" data-line-number="3">           <span class="dt">y =</span> fullPropAfter,</a>
<a class="sourceLine" id="cb70-4" data-line-number="4">           <span class="dt">colour =</span> state)) <span class="op">+</span></a>
<a class="sourceLine" id="cb70-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb70-6" data-line-number="6"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb70-7" data-line-number="7"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;chains&quot;</span>)</a></code></pre></div>
<p><img src="causality_files/figure-html/unnamed-chunk-44-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>To calculate the difference between states in the proportion of full-time employees after the change:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1">full_prop_by_state_chain <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-2" data-line-number="2"><span class="st">  </span><span class="kw">spread</span>(state, fullPropAfter) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> NJ <span class="op">-</span><span class="st"> </span>PA)</a>
<a class="sourceLine" id="cb71-4" data-line-number="4"><span class="co">#&gt; # A tibble: 4 x 4</span></a>
<a class="sourceLine" id="cb71-5" data-line-number="5"><span class="co">#&gt;   chain         NJ    PA   diff</span></a>
<a class="sourceLine" id="cb71-6" data-line-number="6"><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb71-7" data-line-number="7"><span class="co">#&gt; 1 burgerking 0.358 0.321 0.0364</span></a>
<a class="sourceLine" id="cb71-8" data-line-number="8"><span class="co">#&gt; 2 kfc        0.328 0.236 0.0918</span></a>
<a class="sourceLine" id="cb71-9" data-line-number="9"><span class="co">#&gt; 3 roys       0.283 0.213 0.0697</span></a>
<a class="sourceLine" id="cb71-10" data-line-number="10"><span class="co">#&gt; 4 wendys     0.260 0.248 0.0117</span></a></code></pre></div>
</section>
<section id="before-and-after-and-difference-in-difference-designs" class="level3">
<h3><span class="header-section-number">2.4.2</span> Before and After and Difference-in-Difference Designs</h3>
<p>To compute the estimates in the before and after design first create an additional variable for the proportion of full-time employees before the minimum wage increase.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1">minwage &lt;-</a>
<a class="sourceLine" id="cb72-2" data-line-number="2"><span class="st">  </span>minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">totalBefore =</span> fullBefore <span class="op">+</span><span class="st"> </span>partBefore,</a>
<a class="sourceLine" id="cb72-4" data-line-number="4">         <span class="dt">fullPropBefore =</span> fullBefore <span class="op">/</span><span class="st"> </span>totalBefore)</a></code></pre></div>
<p>The before-and-after analysis is the difference between the full-time employment before and after the minimum wage law passed looking only at NJ:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1">minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(state <span class="op">==</span><span class="st"> &quot;NJ&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">diff =</span> <span class="kw">mean</span>(fullPropAfter) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(fullPropBefore))</a>
<a class="sourceLine" id="cb73-4" data-line-number="4"><span class="co">#&gt;     diff</span></a>
<a class="sourceLine" id="cb73-5" data-line-number="5"><span class="co">#&gt; 1 0.0239</span></a></code></pre></div>
<p>The difference-in-differences design uses the difference in the before-and-after differences for each state.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1">minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">diff =</span> <span class="kw">mean</span>(fullPropAfter) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(fullPropBefore)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-4" data-line-number="4"><span class="st">  </span><span class="kw">spread</span>(state, diff) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff_in_diff =</span> NJ <span class="op">-</span><span class="st"> </span>PA)</a>
<a class="sourceLine" id="cb74-6" data-line-number="6"><span class="co">#&gt; # A tibble: 1 x 3</span></a>
<a class="sourceLine" id="cb74-7" data-line-number="7"><span class="co">#&gt;       NJ      PA diff_in_diff</span></a>
<a class="sourceLine" id="cb74-8" data-line-number="8"><span class="co">#&gt;    &lt;dbl&gt;   &lt;dbl&gt;        &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb74-9" data-line-number="9"><span class="co">#&gt; 1 0.0239 -0.0377       0.0616</span></a></code></pre></div>
<p>Let’s create a single dataset with the mean values of each state before and after to visually look at each of these designs:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1">full_prop_by_state &lt;-</a>
<a class="sourceLine" id="cb75-2" data-line-number="2"><span class="st">  </span>minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(fullPropAfter, fullPropBefore), mean) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-5" data-line-number="5"><span class="st">  </span><span class="kw">gather</span>(period, fullProp, <span class="op">-</span>state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">period =</span> <span class="kw">recode</span>(period, <span class="dt">fullPropAfter =</span> <span class="dv">1</span>, <span class="dt">fullPropBefore =</span> <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb75-7" data-line-number="7">full_prop_by_state</a>
<a class="sourceLine" id="cb75-8" data-line-number="8"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb75-9" data-line-number="9"><span class="co">#&gt;   state period fullProp</span></a>
<a class="sourceLine" id="cb75-10" data-line-number="10"><span class="co">#&gt;   &lt;chr&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb75-11" data-line-number="11"><span class="co">#&gt; 1 NJ      1.00    0.320</span></a>
<a class="sourceLine" id="cb75-12" data-line-number="12"><span class="co">#&gt; 2 PA      1.00    0.272</span></a>
<a class="sourceLine" id="cb75-13" data-line-number="13"><span class="co">#&gt; 3 NJ      0       0.297</span></a>
<a class="sourceLine" id="cb75-14" data-line-number="14"><span class="co">#&gt; 4 PA      0       0.310</span></a></code></pre></div>
<p>Now plot this new dataset:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1"><span class="kw">ggplot</span>(full_prop_by_state, <span class="kw">aes</span>(<span class="dt">x =</span> period, <span class="dt">y =</span> fullProp, <span class="dt">colour =</span> state)) <span class="op">+</span></a>
<a class="sourceLine" id="cb76-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb76-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb76-4" data-line-number="4"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Before&quot;</span>, <span class="st">&quot;After&quot;</span>))</a></code></pre></div>
<p><img src="causality_files/figure-html/unnamed-chunk-50-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
</section>
<section id="descriptive-statistics-for-a-single-variable" class="level2">
<h2><span class="header-section-number">2.5</span> Descriptive Statistics for a Single Variable</h2>
<p>To calculate the summary for the variables <code>wageBefore</code> and <code>wageAfter</code> for New Jersey only:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1">minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(state <span class="op">==</span><span class="st"> &quot;NJ&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(wageBefore, wageAfter) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-4" data-line-number="4"><span class="st">  </span><span class="kw">summary</span>()</a>
<a class="sourceLine" id="cb77-5" data-line-number="5"><span class="co">#&gt;    wageBefore     wageAfter   </span></a>
<a class="sourceLine" id="cb77-6" data-line-number="6"><span class="co">#&gt;  Min.   :4.25   Min.   :5.00  </span></a>
<a class="sourceLine" id="cb77-7" data-line-number="7"><span class="co">#&gt;  1st Qu.:4.25   1st Qu.:5.05  </span></a>
<a class="sourceLine" id="cb77-8" data-line-number="8"><span class="co">#&gt;  Median :4.50   Median :5.05  </span></a>
<a class="sourceLine" id="cb77-9" data-line-number="9"><span class="co">#&gt;  Mean   :4.61   Mean   :5.08  </span></a>
<a class="sourceLine" id="cb77-10" data-line-number="10"><span class="co">#&gt;  3rd Qu.:4.87   3rd Qu.:5.05  </span></a>
<a class="sourceLine" id="cb77-11" data-line-number="11"><span class="co">#&gt;  Max.   :5.75   Max.   :5.75</span></a></code></pre></div>
<p>We calculate the interquartile range for each state’s wages after the passage of the law using the same grouped summarize as we used before:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1">minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">wageAfter =</span> <span class="kw">IQR</span>(wageAfter),</a>
<a class="sourceLine" id="cb78-4" data-line-number="4">            <span class="dt">wageBefore =</span> <span class="kw">IQR</span>(wageBefore))</a>
<a class="sourceLine" id="cb78-5" data-line-number="5"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb78-6" data-line-number="6"><span class="co">#&gt;   state wageAfter wageBefore</span></a>
<a class="sourceLine" id="cb78-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb78-8" data-line-number="8"><span class="co">#&gt; 1 NJ        0          0.620</span></a>
<a class="sourceLine" id="cb78-9" data-line-number="9"><span class="co">#&gt; 2 PA        0.575      0.750</span></a></code></pre></div>
<p>Calculate the variance and standard deviation of <code>wageAfter</code> and <code>wageBefore</code> for each state:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">wageAfter_sd =</span> <span class="kw">sd</span>(wageAfter),</a>
<a class="sourceLine" id="cb79-4" data-line-number="4">               <span class="dt">wageAfter_var =</span> <span class="kw">var</span>(wageAfter),</a>
<a class="sourceLine" id="cb79-5" data-line-number="5">               <span class="dt">wageBefore_sd =</span> <span class="kw">sd</span>(wageBefore),</a>
<a class="sourceLine" id="cb79-6" data-line-number="6">               <span class="dt">wageBefore_var =</span> <span class="kw">var</span>(wageBefore))</a>
<a class="sourceLine" id="cb79-7" data-line-number="7"><span class="co">#&gt; # A tibble: 2 x 5</span></a>
<a class="sourceLine" id="cb79-8" data-line-number="8"><span class="co">#&gt;   state wageAfter_sd wageAfter_var wageBefore_sd wageBefore_var</span></a>
<a class="sourceLine" id="cb79-9" data-line-number="9"><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;          &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb79-10" data-line-number="10"><span class="co">#&gt; 1 NJ           0.106        0.0112         0.343          0.118</span></a>
<a class="sourceLine" id="cb79-11" data-line-number="11"><span class="co">#&gt; 2 PA           0.359        0.129          0.358          0.128</span></a></code></pre></div>
<p>Here we can see again how using <a href="https://www.rdocumentation.org/packages/dplyr/topics/summarise_at">summarise_at</a> allows for more compact code to specify variables and summary statistics that would be the case using just <code>summarise</code>:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1">minwage <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(wageAfter, wageBefore), <span class="kw">funs</span>(sd, var))</a>
<a class="sourceLine" id="cb80-4" data-line-number="4"><span class="co">#&gt; # A tibble: 2 x 5</span></a>
<a class="sourceLine" id="cb80-5" data-line-number="5"><span class="co">#&gt;   state wageAfter_sd wageBefore_sd wageAfter_var wageBefore_var</span></a>
<a class="sourceLine" id="cb80-6" data-line-number="6"><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;          &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb80-7" data-line-number="7"><span class="co">#&gt; 1 NJ           0.106         0.343        0.0112          0.118</span></a>
<a class="sourceLine" id="cb80-8" data-line-number="8"><span class="co">#&gt; 2 PA           0.359         0.358        0.129           0.128</span></a></code></pre></div>

</section>
</section>
<section id="measurement" class="level1">
<h1><span class="header-section-number">3</span> Measurement</h1>
<section id="prerequisites-2" class="level2 unnumbered">
<h2>Prerequisites</h2>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a>
<a class="sourceLine" id="cb81-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)</a>
<a class="sourceLine" id="cb81-3" data-line-number="3"><span class="kw">library</span>(<span class="st">&quot;broom&quot;</span>)</a>
<a class="sourceLine" id="cb81-4" data-line-number="4"><span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)</a></code></pre></div>
</section>
<section id="measuring-civilian-victimization-during-wartime" class="level2">
<h2><span class="header-section-number">3.1</span> Measuring Civilian Victimization during Wartime</h2>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;afghan&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>Summarize the variables of interest</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1">afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb83-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(age, educ.years, employed, income) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb83-3" data-line-number="3"><span class="st">  </span><span class="kw">summary</span>()</a>
<a class="sourceLine" id="cb83-4" data-line-number="4"><span class="co">#&gt;       age         educ.years    employed        income         </span></a>
<a class="sourceLine" id="cb83-5" data-line-number="5"><span class="co">#&gt;  Min.   :15.0   Min.   : 0   Min.   :0.000   Length:2754       </span></a>
<a class="sourceLine" id="cb83-6" data-line-number="6"><span class="co">#&gt;  1st Qu.:22.0   1st Qu.: 0   1st Qu.:0.000   Class :character  </span></a>
<a class="sourceLine" id="cb83-7" data-line-number="7"><span class="co">#&gt;  Median :30.0   Median : 1   Median :1.000   Mode  :character  </span></a>
<a class="sourceLine" id="cb83-8" data-line-number="8"><span class="co">#&gt;  Mean   :32.4   Mean   : 4   Mean   :0.583                     </span></a>
<a class="sourceLine" id="cb83-9" data-line-number="9"><span class="co">#&gt;  3rd Qu.:40.0   3rd Qu.: 8   3rd Qu.:1.000                     </span></a>
<a class="sourceLine" id="cb83-10" data-line-number="10"><span class="co">#&gt;  Max.   :80.0   Max.   :18   Max.   :1.000</span></a></code></pre></div>
<p>Loading data with either <code>data()</code> or<code>read_csv()</code> does not convert strings to factors by default; see below with <code>income</code>. To get a summary of the different levels, either convert it to a factor (see <a href="http://r4ds.had.co.nz/factors.html">R4DS Ch 15</a>), or use <code>count()</code>:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1"><span class="kw">count</span>(afghan, income)</a>
<a class="sourceLine" id="cb84-2" data-line-number="2"><span class="co">#&gt; # A tibble: 6 x 2</span></a>
<a class="sourceLine" id="cb84-3" data-line-number="3"><span class="co">#&gt;   income              n</span></a>
<a class="sourceLine" id="cb84-4" data-line-number="4"><span class="co">#&gt;   &lt;chr&gt;           &lt;int&gt;</span></a>
<a class="sourceLine" id="cb84-5" data-line-number="5"><span class="co">#&gt; 1 10,001-20,000     616</span></a>
<a class="sourceLine" id="cb84-6" data-line-number="6"><span class="co">#&gt; 2 2,001-10,000     1420</span></a>
<a class="sourceLine" id="cb84-7" data-line-number="7"><span class="co">#&gt; 3 20,001-30,000      93</span></a>
<a class="sourceLine" id="cb84-8" data-line-number="8"><span class="co">#&gt; 4 less than 2,000   457</span></a>
<a class="sourceLine" id="cb84-9" data-line-number="9"><span class="co">#&gt; 5 over 30,000        14</span></a>
<a class="sourceLine" id="cb84-10" data-line-number="10"><span class="co">#&gt; 6 &lt;NA&gt;              154</span></a></code></pre></div>
<p>Use count to calculate the proportion of respondents who answer that they were harmed by the ISAF or the Taliban (<code>violent.exp.ISAF</code> and <code>violent.exp.taliban</code>, respectively):</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1">afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(violent.exp.ISAF, violent.exp.taliban) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-4" data-line-number="4"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb85-6" data-line-number="6"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb85-7" data-line-number="7"><span class="co">#&gt;   violent.exp.ISAF violent.exp.taliban     n    prop</span></a>
<a class="sourceLine" id="cb85-8" data-line-number="8"><span class="co">#&gt;              &lt;int&gt;               &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb85-9" data-line-number="9"><span class="co">#&gt; 1                0                   0  1330 0.483  </span></a>
<a class="sourceLine" id="cb85-10" data-line-number="10"><span class="co">#&gt; 2                0                   1   354 0.129  </span></a>
<a class="sourceLine" id="cb85-11" data-line-number="11"><span class="co">#&gt; 3                0                  NA    22 0.00799</span></a>
<a class="sourceLine" id="cb85-12" data-line-number="12"><span class="co">#&gt; 4                1                   0   475 0.172  </span></a>
<a class="sourceLine" id="cb85-13" data-line-number="13"><span class="co">#&gt; 5                1                   1   526 0.191  </span></a>
<a class="sourceLine" id="cb85-14" data-line-number="14"><span class="co">#&gt; 6                1                  NA    22 0.00799</span></a>
<a class="sourceLine" id="cb85-15" data-line-number="15"><span class="co">#&gt; # ... with 3 more rows</span></a></code></pre></div>
<p>We need to use <code>ungroup()</code> in order to ensure that <code>sum(n)</code> sums over the entire dataset as opposed to only within categories of <code>violent.exp.ISAF</code>. Unlike <code>prop.table()</code>, the code above does not drop missing values. We can drop those values by adding <code>filter()</code> and <code>!is.na()</code> to test for missing values in those variables:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(violent.exp.ISAF), <span class="op">!</span><span class="kw">is.na</span>(violent.exp.taliban)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(violent.exp.ISAF, violent.exp.taliban) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-4" data-line-number="4"><span class="st">  </span><span class="kw">count</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb86-7" data-line-number="7"><span class="co">#&gt; # A tibble: 4 x 4</span></a>
<a class="sourceLine" id="cb86-8" data-line-number="8"><span class="co">#&gt;   violent.exp.ISAF violent.exp.taliban     n  prop</span></a>
<a class="sourceLine" id="cb86-9" data-line-number="9"><span class="co">#&gt;              &lt;int&gt;               &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb86-10" data-line-number="10"><span class="co">#&gt; 1                0                   0  1330 0.495</span></a>
<a class="sourceLine" id="cb86-11" data-line-number="11"><span class="co">#&gt; 2                0                   1   354 0.132</span></a>
<a class="sourceLine" id="cb86-12" data-line-number="12"><span class="co">#&gt; 3                1                   0   475 0.177</span></a>
<a class="sourceLine" id="cb86-13" data-line-number="13"><span class="co">#&gt; 4                1                   1   526 0.196</span></a></code></pre></div>
</section>
<section id="handling-missing-data-in-r" class="level2">
<h2><span class="header-section-number">3.2</span> Handling Missing Data in R</h2>
<p>We already observed the issues with <code>NA</code> values in calculating the proportion answering the “experienced violence” questions. You can filter rows with specific variables having missing values using <code>filter()</code> as shown above.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1"><span class="kw">head</span>(afghan<span class="op">$</span>income, <span class="dt">n =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb87-2" data-line-number="2"><span class="co">#&gt;  [1] &quot;2,001-10,000&quot;  &quot;2,001-10,000&quot;  &quot;2,001-10,000&quot;  &quot;2,001-10,000&quot; </span></a>
<a class="sourceLine" id="cb87-3" data-line-number="3"><span class="co">#&gt;  [5] &quot;2,001-10,000&quot;  NA              &quot;10,001-20,000&quot; &quot;2,001-10,000&quot; </span></a>
<a class="sourceLine" id="cb87-4" data-line-number="4"><span class="co">#&gt;  [9] &quot;2,001-10,000&quot;  NA</span></a>
<a class="sourceLine" id="cb87-5" data-line-number="5"><span class="kw">head</span>(<span class="kw">is.na</span>(afghan<span class="op">$</span>income), <span class="dt">n =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb87-6" data-line-number="6"><span class="co">#&gt;  [1] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE</span></a></code></pre></div>
<p>Counts and proportion of missing values of <code>income</code>:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1"><span class="kw">summarise</span>(afghan,</a>
<a class="sourceLine" id="cb88-2" data-line-number="2">          <span class="dt">n_missing =</span> <span class="kw">sum</span>(<span class="kw">is.na</span>(income)),</a>
<a class="sourceLine" id="cb88-3" data-line-number="3">          <span class="dt">p_missing =</span> <span class="kw">mean</span>(<span class="kw">is.na</span>(income)))</a>
<a class="sourceLine" id="cb88-4" data-line-number="4"><span class="co">#&gt;   n_missing p_missing</span></a>
<a class="sourceLine" id="cb88-5" data-line-number="5"><span class="co">#&gt; 1       154    0.0559</span></a></code></pre></div>
<p>Mean, and other functions, do not by default exclude missing values. Use <code>na.rm = TRUE</code> in these cases.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb89-2" data-line-number="2"><span class="kw">mean</span>(x)</a>
<a class="sourceLine" id="cb89-3" data-line-number="3"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb89-4" data-line-number="4"><span class="kw">mean</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb89-5" data-line-number="5"><span class="co">#&gt; [1] 2</span></a></code></pre></div>
<p>Table of proportions of individuals harmed by the ISAF and Taliban that includes missing (<code>NA</code>) values:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" data-line-number="1">violent_exp_prop &lt;-</a>
<a class="sourceLine" id="cb90-2" data-line-number="2"><span class="st">  </span>afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(violent.exp.ISAF, violent.exp.taliban) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-4" data-line-number="4"><span class="st">  </span><span class="kw">count</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>n)</a>
<a class="sourceLine" id="cb90-8" data-line-number="8">violent_exp_prop</a>
<a class="sourceLine" id="cb90-9" data-line-number="9"><span class="co">#&gt; # A tibble: 9 x 3</span></a>
<a class="sourceLine" id="cb90-10" data-line-number="10"><span class="co">#&gt;   violent.exp.ISAF violent.exp.taliban    prop</span></a>
<a class="sourceLine" id="cb90-11" data-line-number="11"><span class="co">#&gt;              &lt;int&gt;               &lt;int&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb90-12" data-line-number="12"><span class="co">#&gt; 1                0                   0 0.483  </span></a>
<a class="sourceLine" id="cb90-13" data-line-number="13"><span class="co">#&gt; 2                0                   1 0.129  </span></a>
<a class="sourceLine" id="cb90-14" data-line-number="14"><span class="co">#&gt; 3                0                  NA 0.00799</span></a>
<a class="sourceLine" id="cb90-15" data-line-number="15"><span class="co">#&gt; 4                1                   0 0.172  </span></a>
<a class="sourceLine" id="cb90-16" data-line-number="16"><span class="co">#&gt; 5                1                   1 0.191  </span></a>
<a class="sourceLine" id="cb90-17" data-line-number="17"><span class="co">#&gt; 6                1                  NA 0.00799</span></a>
<a class="sourceLine" id="cb90-18" data-line-number="18"><span class="co">#&gt; # ... with 3 more rows</span></a></code></pre></div>
<p>The data frame above can be reorganized so that rows are ISAF and the columns are Taliban as follows:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1">violent_exp_prop <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-2" data-line-number="2"><span class="st">  </span><span class="kw">spread</span>(violent.exp.taliban, prop)</a>
<a class="sourceLine" id="cb91-3" data-line-number="3"><span class="co">#&gt; # A tibble: 3 x 4</span></a>
<a class="sourceLine" id="cb91-4" data-line-number="4"><span class="co">#&gt;   violent.exp.ISAF     `0`     `1`  `&lt;NA&gt;`</span></a>
<a class="sourceLine" id="cb91-5" data-line-number="5"><span class="co">#&gt; *            &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb91-6" data-line-number="6"><span class="co">#&gt; 1                0 0.483   0.129   0.00799</span></a>
<a class="sourceLine" id="cb91-7" data-line-number="7"><span class="co">#&gt; 2                1 0.172   0.191   0.00799</span></a>
<a class="sourceLine" id="cb91-8" data-line-number="8"><span class="co">#&gt; 3               NA 0.00254 0.00290 0.00363</span></a></code></pre></div>
<p><code>drop_na</code> is an alternative to <code>na.omit</code> that allows for removing missing values,</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="kw">drop_na</span>(afghan)</a></code></pre></div>
<p><strong>Tip</strong> There are multiple types of <a href="http://r4ds.had.co.nz/vectors.html#important-types-of-atomic-vector">missing values</a>.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1"><span class="ot">NA</span>  <span class="co"># logical</span></a>
<a class="sourceLine" id="cb93-2" data-line-number="2"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb93-3" data-line-number="3"><span class="ot">NA_integer_</span> <span class="co"># integer</span></a>
<a class="sourceLine" id="cb93-4" data-line-number="4"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb93-5" data-line-number="5"><span class="ot">NA_real_</span> <span class="co"># double</span></a>
<a class="sourceLine" id="cb93-6" data-line-number="6"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb93-7" data-line-number="7"><span class="ot">NA_character_</span> <span class="co"># character</span></a>
<a class="sourceLine" id="cb93-8" data-line-number="8"><span class="co">#&gt; [1] NA</span></a></code></pre></div>
<p>In many cases, this distinction does not matter since many functions will coerce these missing values to the correct vector type. However, you will need to use these in some tidyverse functions that require the outputs to be the same type, e.g. <code>map()</code> and most of the other <a href="https://cran.r-project.org/package=purrr">purrr</a> functions, and <code>if_else()</code>. The code below produces an error, since the <code>TRUE</code> case returns an integer value (<code>x</code> is an integer), but the <code>FALSE</code> case does not specify the type of <code>NA</code>.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">5</span></a>
<a class="sourceLine" id="cb94-2" data-line-number="2"><span class="kw">class</span>(x)</a>
<a class="sourceLine" id="cb94-3" data-line-number="3"><span class="co">#&gt; [1] &quot;integer&quot;</span></a>
<a class="sourceLine" id="cb94-4" data-line-number="4"><span class="kw">if_else</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="dv">3</span>, x, <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb94-5" data-line-number="5"><span class="co">#&gt; Error: `false` must be type integer, not logical</span></a></code></pre></div>
<p>So instead of <code>NA</code>, use <code>NA_integer_</code>:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1"><span class="kw">if_else</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="dv">3</span>, x, <span class="ot">NA_integer_</span>)</a>
<a class="sourceLine" id="cb95-2" data-line-number="2"><span class="co">#&gt; [1]  1  2 NA NA NA</span></a></code></pre></div>
</section>
<section id="visualizing-the-univariate-distribution" class="level2">
<h2><span class="header-section-number">3.3</span> Visualizing the Univariate Distribution</h2>
<section id="barplot" class="level3">
<h3><span class="header-section-number">3.3.1</span> Barplot</h3>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" data-line-number="1">afghan &lt;-</a>
<a class="sourceLine" id="cb96-2" data-line-number="2"><span class="st">  </span>afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb96-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">violent.exp.ISAF.fct =</span></a>
<a class="sourceLine" id="cb96-4" data-line-number="4">           <span class="kw">fct_explicit_na</span>(<span class="kw">fct_recode</span>(<span class="kw">factor</span>(violent.exp.ISAF),</a>
<a class="sourceLine" id="cb96-5" data-line-number="5">                                      <span class="dt">Harm =</span> <span class="st">&quot;1&quot;</span>, <span class="st">&quot;No Harm&quot;</span> =<span class="st"> &quot;0&quot;</span>),</a>
<a class="sourceLine" id="cb96-6" data-line-number="6">                           <span class="st">&quot;No response&quot;</span>))</a>
<a class="sourceLine" id="cb96-7" data-line-number="7"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">x =</span> violent.exp.ISAF.fct, <span class="dt">y =</span> ..prop.., <span class="dt">group =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb96-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_bar</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb96-9" data-line-number="9"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Response category&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb96-10" data-line-number="10"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Proportion of respondents&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb96-11" data-line-number="11"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Civilian Victimization by the ISAF&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-17-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" data-line-number="1">afghan &lt;-</a>
<a class="sourceLine" id="cb97-2" data-line-number="2"><span class="st">  </span>afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb97-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">violent.exp.taliban.fct =</span></a>
<a class="sourceLine" id="cb97-4" data-line-number="4">           <span class="kw">fct_explicit_na</span>(<span class="kw">fct_recode</span>(<span class="kw">factor</span>(violent.exp.taliban),</a>
<a class="sourceLine" id="cb97-5" data-line-number="5">                                      <span class="dt">Harm =</span> <span class="st">&quot;1&quot;</span>, <span class="st">&quot;No Harm&quot;</span> =<span class="st"> &quot;0&quot;</span>),</a>
<a class="sourceLine" id="cb97-6" data-line-number="6">                           <span class="st">&quot;No response&quot;</span>))</a>
<a class="sourceLine" id="cb97-7" data-line-number="7"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">x =</span> violent.exp.ISAF.fct, <span class="dt">y =</span> ..prop.., <span class="dt">group =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb97-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_bar</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb97-9" data-line-number="9"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Response category&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb97-10" data-line-number="10"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Proportion of respondents&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb97-11" data-line-number="11"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Civilian Victimization by the Taliban&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-18-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Instead of creating two separate box-plots, create a single plot facetted by ISAF and Taliban:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" data-line-number="1"><span class="kw">select</span>(afghan, violent.exp.ISAF, violent.exp.taliban) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-2" data-line-number="2"><span class="st">  </span><span class="kw">gather</span>(variable, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">fct_explicit_na</span>(<span class="kw">fct_recode</span>(<span class="kw">factor</span>(value),</a>
<a class="sourceLine" id="cb98-4" data-line-number="4">                                <span class="dt">Harm =</span> <span class="st">&quot;1&quot;</span>, <span class="st">&quot;No Harm&quot;</span> =<span class="st"> &quot;0&quot;</span>),</a>
<a class="sourceLine" id="cb98-5" data-line-number="5">                                <span class="st">&quot;No response&quot;</span>),</a>
<a class="sourceLine" id="cb98-6" data-line-number="6">         <span class="dt">variable =</span> <span class="kw">recode</span>(variable,</a>
<a class="sourceLine" id="cb98-7" data-line-number="7">                           <span class="dt">violent.exp.ISAF =</span> <span class="st">&quot;ISAF&quot;</span>,</a>
<a class="sourceLine" id="cb98-8" data-line-number="8">                           <span class="dt">violent.exp.taliban =</span> <span class="st">&quot;Taliban&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> ..prop.., <span class="dt">group =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb98-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_bar</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb98-11" data-line-number="11"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>variable, <span class="dt">ncol =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb98-12" data-line-number="12"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Response category&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb98-13" data-line-number="13"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Proportion of respondents&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb98-14" data-line-number="14"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Civilian Victimization&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-19-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This plot could improved by plotting the two values simultaneously to be able to better compare them. This will require creating a data frame that has the following columns: perpetrator (<code>ISAF</code>, <code>Taliban</code>) and response (<code>No Harm</code>, <code>Harm</code>, <code>No response</code>).</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" data-line-number="1">violent_exp &lt;-</a>
<a class="sourceLine" id="cb99-2" data-line-number="2"><span class="st">  </span>afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(violent.exp.ISAF, violent.exp.taliban) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-4" data-line-number="4"><span class="st">  </span><span class="kw">gather</span>(perpetrator, response) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">perpetrator =</span> <span class="kw">str_replace</span>(perpetrator, <span class="st">&quot;violent</span><span class="ch">\\</span><span class="st">.exp</span><span class="ch">\\</span><span class="st">.&quot;</span>, <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb99-6" data-line-number="6">         <span class="dt">perpetrator =</span> <span class="kw">str_replace</span>(perpetrator, <span class="st">&quot;taliban&quot;</span>, <span class="st">&quot;Taliban&quot;</span>),</a>
<a class="sourceLine" id="cb99-7" data-line-number="7">         <span class="dt">response =</span> <span class="kw">fct_recode</span>(<span class="kw">factor</span>(response), <span class="st">&quot;Harm&quot;</span> =<span class="st"> &quot;1&quot;</span>, <span class="st">&quot;No Harm&quot;</span> =<span class="st"> &quot;0&quot;</span>),</a>
<a class="sourceLine" id="cb99-8" data-line-number="8">         <span class="dt">response =</span> <span class="kw">fct_explicit_na</span>(response, <span class="st">&quot;No response&quot;</span>),</a>
<a class="sourceLine" id="cb99-9" data-line-number="9">         <span class="dt">response =</span> <span class="kw">fct_relevel</span>(response, <span class="kw">c</span>(<span class="st">&quot;No response&quot;</span>, <span class="st">&quot;No Harm&quot;</span>))</a>
<a class="sourceLine" id="cb99-10" data-line-number="10">         ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-11" data-line-number="11"><span class="st">  </span><span class="kw">count</span>(perpetrator, response) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb99-13" data-line-number="13"><span class="kw">ggplot</span>(violent_exp, <span class="kw">aes</span>(<span class="dt">x =</span> prop, <span class="dt">y =</span> response, <span class="dt">color =</span> perpetrator)) <span class="op">+</span></a>
<a class="sourceLine" id="cb99-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb99-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">ISAF =</span> <span class="st">&quot;green&quot;</span>, <span class="dt">Taliban =</span> <span class="st">&quot;black&quot;</span>))</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-20-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Black was chosen for the Taliban, and Green for ISAF because they are the colors of their respective <a href="https://en.wikipedia.org/wiki/International_Security_Assistance_Force">flags</a>.</p>
</section>
<section id="histogram" class="level3">
<h3><span class="header-section-number">3.3.2</span> Histogram</h3>
<p>See the documentation for <a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_histogram">geom_histogram</a>.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" data-line-number="1"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> ..density..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb100-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">5</span>, <span class="dt">boundary =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb100-3" data-line-number="3"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">20</span>, <span class="dv">80</span>, <span class="dt">by =</span> <span class="dv">10</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb100-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Distribution of respondent&#39;s age&quot;</span>,</a>
<a class="sourceLine" id="cb100-5" data-line-number="5">       <span class="dt">y =</span> <span class="st">&quot;Age&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Density&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/hist_age-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb101-1" data-line-number="1"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">x =</span> educ.years, <span class="dt">y =</span> ..density..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb101-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">center =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb101-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="kw">median</span>(afghan<span class="op">$</span>educ.years),</a>
<a class="sourceLine" id="cb101-4" data-line-number="4">             <span class="dt">color =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb101-5" data-line-number="5"><span class="st">  </span><span class="kw">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="kw">median</span>(afghan<span class="op">$</span>educ.years),</a>
<a class="sourceLine" id="cb101-6" data-line-number="6">           <span class="dt">y =</span> <span class="fl">0.2</span>, <span class="dt">label =</span> <span class="st">&quot;median&quot;</span>, <span class="dt">hjust =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb101-7" data-line-number="7"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Distribution of respondent&#39;s education&quot;</span>,</a>
<a class="sourceLine" id="cb101-8" data-line-number="8">       <span class="dt">x =</span> <span class="st">&quot;Years of education&quot;</span>,</a>
<a class="sourceLine" id="cb101-9" data-line-number="9">       <span class="dt">y =</span> <span class="st">&quot;Density&quot;</span>)</a>
<a class="sourceLine" id="cb101-10" data-line-number="10">  </a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-21-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>There are several alternatives to the histogram.</p>
<p>Density plots (<a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_density">geom_density</a>):</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" data-line-number="1">dens_plot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">x =</span> age)) <span class="op">+</span></a>
<a class="sourceLine" id="cb102-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb102-3" data-line-number="3"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">20</span>, <span class="dv">80</span>, <span class="dt">by =</span> <span class="dv">10</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb102-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Distribution of respondent&#39;s age&quot;</span>,</a>
<a class="sourceLine" id="cb102-5" data-line-number="5">       <span class="dt">y =</span> <span class="st">&quot;Age&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Density&quot;</span>)</a>
<a class="sourceLine" id="cb102-6" data-line-number="6">dens_plot</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-22-1.png" width="70%" style="display: block; margin: auto;" /> which can be combined with a <a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_rug">geom_rug</a> to create a rug plot, which puts small lines on the axis to represent the value of each observation. It can be combined with a scatter or density plot to add extra detail. Adjust the <code>alpha</code> to modify the color transparency of the rug and address overplotting.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" data-line-number="1">dens_plot <span class="op">+</span><span class="st"> </span><span class="kw">geom_rug</span>(<span class="dt">alpha =</span> <span class="fl">.2</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-23-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Frequency polygons (<a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_freqpoly">geom_freqpoly</a>): See <a href="http://r4ds.had.co.nz/">R for Data Science</a> <a href="http://r4ds.had.co.nz/exploratory-data-analysis.html">EDA</a>.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" data-line-number="1"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">x =</span> age)) <span class="op">+</span></a>
<a class="sourceLine" id="cb104-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_freqpoly</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb104-3" data-line-number="3"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">20</span>, <span class="dv">80</span>, <span class="dt">by =</span> <span class="dv">10</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb104-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Distribution of respondent&#39;s age&quot;</span>,</a>
<a class="sourceLine" id="cb104-5" data-line-number="5">       <span class="dt">y =</span> <span class="st">&quot;Age&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Density&quot;</span>)</a>
<a class="sourceLine" id="cb104-6" data-line-number="6"><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-24-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="boxplot" class="level3">
<h3><span class="header-section-number">3.3.3</span> Boxplot</h3>
<p>See the documentation for <a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_boxplot">geom_boxplot</a>.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb105-1" data-line-number="1"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> age)) <span class="op">+</span></a>
<a class="sourceLine" id="cb105-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_boxplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb105-3" data-line-number="3"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb105-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Age&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">title =</span> <span class="st">&quot;Distribution of Age&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-25-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb106-1" data-line-number="1"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">y =</span> educ.years, <span class="dt">x =</span> province)) <span class="op">+</span></a>
<a class="sourceLine" id="cb106-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_boxplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb106-3" data-line-number="3"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb106-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Province&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Years of education&quot;</span>,</a>
<a class="sourceLine" id="cb106-5" data-line-number="5">       <span class="dt">title =</span> <span class="st">&quot;Education by Province&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-26-1.png" width="70%" style="display: block; margin: auto;" /> Helmand and Uruzgan have much lower levels of education than the other provinces, and also report higher levels of violence.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb107-1" data-line-number="1">afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb107-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(province) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb107-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">educ.years =</span> <span class="kw">mean</span>(educ.years, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb107-4" data-line-number="4">            <span class="dt">violent.exp.taliban =</span></a>
<a class="sourceLine" id="cb107-5" data-line-number="5">              <span class="kw">mean</span>(violent.exp.taliban, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb107-6" data-line-number="6">            <span class="dt">violent.exp.ISAF =</span></a>
<a class="sourceLine" id="cb107-7" data-line-number="7">              <span class="kw">mean</span>(violent.exp.ISAF, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb107-8" data-line-number="8"><span class="st">  </span><span class="kw">arrange</span>(educ.years)</a>
<a class="sourceLine" id="cb107-9" data-line-number="9"><span class="co">#&gt; # A tibble: 5 x 4</span></a>
<a class="sourceLine" id="cb107-10" data-line-number="10"><span class="co">#&gt;   province educ.years violent.exp.taliban violent.exp.ISAF</span></a>
<a class="sourceLine" id="cb107-11" data-line-number="11"><span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;               &lt;dbl&gt;            &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb107-12" data-line-number="12"><span class="co">#&gt; 1 Uruzgan        1.04              0.455             0.496</span></a>
<a class="sourceLine" id="cb107-13" data-line-number="13"><span class="co">#&gt; 2 Helmand        1.60              0.504             0.541</span></a>
<a class="sourceLine" id="cb107-14" data-line-number="14"><span class="co">#&gt; 3 Khost          5.79              0.233             0.242</span></a>
<a class="sourceLine" id="cb107-15" data-line-number="15"><span class="co">#&gt; 4 Kunar          5.93              0.303             0.399</span></a>
<a class="sourceLine" id="cb107-16" data-line-number="16"><span class="co">#&gt; 5 Logar          6.70              0.0802            0.144</span></a></code></pre></div>
<p>An alternatives to the traditional boxplot:</p>
<p>The Tufte boxplot:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb108-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;ggthemes&quot;</span>)</a>
<a class="sourceLine" id="cb108-2" data-line-number="2"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">y =</span> educ.years, <span class="dt">x =</span> province)) <span class="op">+</span></a>
<a class="sourceLine" id="cb108-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_tufteboxplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb108-4" data-line-number="4"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb108-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Province&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Years of education&quot;</span>,</a>
<a class="sourceLine" id="cb108-6" data-line-number="6">       <span class="dt">title =</span> <span class="st">&quot;Education by Province&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-28-1.png" width="70%" style="display: block; margin: auto;" /> Dot plot with jitter and adjusted alpha to avoid overplotting:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb109-1" data-line-number="1"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">y =</span> educ.years, <span class="dt">x =</span> province)) <span class="op">+</span></a>
<a class="sourceLine" id="cb109-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">position =</span> <span class="kw">position_jitter</span>(<span class="dt">width =</span> <span class="fl">0.25</span>, <span class="dt">height =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb109-3" data-line-number="3">             <span class="dt">alpha =</span> <span class="fl">.2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb109-4" data-line-number="4"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb109-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Province&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Years of education&quot;</span>,</a>
<a class="sourceLine" id="cb109-6" data-line-number="6">       <span class="dt">title =</span> <span class="st">&quot;Education by Province&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-29-1.png" width="70%" style="display: block; margin: auto;" /> A violin plot:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb110-1" data-line-number="1"><span class="kw">ggplot</span>(afghan, <span class="kw">aes</span>(<span class="dt">y =</span> educ.years, <span class="dt">x =</span> province)) <span class="op">+</span></a>
<a class="sourceLine" id="cb110-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_violin</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb110-3" data-line-number="3"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb110-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Province&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Years of education&quot;</span>,</a>
<a class="sourceLine" id="cb110-5" data-line-number="5">       <span class="dt">title =</span> <span class="st">&quot;Education by Province&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-30-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="printing-and-saving-graphics" class="level3">
<h3><span class="header-section-number">3.3.4</span> Printing and saving graphics</h3>
<p>Use the function <code>rdoc (&quot;ggplot2&quot;, &quot;ggsave&quot;)</code> to save <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> graphics. Also, R Markdown files have their own means of creating and saving plots created by code-chunks.</p>
</section>
</section>
<section id="survey-sampling" class="level2">
<h2><span class="header-section-number">3.4</span> Survey Sampling</h2>
<section id="the-role-of-randomization" class="level3">
<h3><span class="header-section-number">3.4.1</span> The Role of Randomization</h3>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb111-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;afghan.village&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>Box-plots of altitude</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb112-1" data-line-number="1"><span class="kw">ggplot</span>(afghan.village, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">factor</span>(village.surveyed,</a>
<a class="sourceLine" id="cb112-2" data-line-number="2">                                      <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;sampled&quot;</span>, <span class="st">&quot;non-sampled&quot;</span>)),</a>
<a class="sourceLine" id="cb112-3" data-line-number="3">                           <span class="dt">y =</span> altitude)) <span class="op">+</span></a>
<a class="sourceLine" id="cb112-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_boxplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb112-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Altitude (meter)&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb112-6" data-line-number="6"><span class="st">  </span><span class="kw">coord_flip</span>()</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-32-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Box plots log-population values of sampled and non-sampled</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb113-1" data-line-number="1"><span class="kw">ggplot</span>(afghan.village, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">factor</span>(village.surveyed,</a>
<a class="sourceLine" id="cb113-2" data-line-number="2">                                      <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;sampled&quot;</span>, <span class="st">&quot;non-sampled&quot;</span>)),</a>
<a class="sourceLine" id="cb113-3" data-line-number="3">                           <span class="dt">y =</span> <span class="kw">log</span>(population))) <span class="op">+</span></a>
<a class="sourceLine" id="cb113-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_boxplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb113-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;log(population)&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb113-6" data-line-number="6"><span class="st">  </span><span class="kw">coord_flip</span>()</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-33-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>You can also compare these distributions by plotting their densities:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb114-1" data-line-number="1"><span class="kw">ggplot</span>(afghan.village, <span class="kw">aes</span>(<span class="dt">colour =</span> <span class="kw">factor</span>(village.surveyed,</a>
<a class="sourceLine" id="cb114-2" data-line-number="2">                                      <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;sampled&quot;</span>, <span class="st">&quot;non-sampled&quot;</span>)),</a>
<a class="sourceLine" id="cb114-3" data-line-number="3">                           <span class="dt">x =</span> <span class="kw">log</span>(population))) <span class="op">+</span></a>
<a class="sourceLine" id="cb114-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb114-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_rug</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb114-6" data-line-number="6"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;log(population)&quot;</span>, <span class="dt">colour =</span> <span class="st">&quot;&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-34-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="non-response-and-other-sources-of-bias" class="level3">
<h3><span class="header-section-number">3.4.2</span> Non-response and other sources of bias</h3>
<p>Calculate the rates of item non-response by province to the question about civilian victimization by ISAF and Taliban forces (<code>violent.exp.ISAF</code> and <code>violent.exp.taliban</code>):</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb115-1" data-line-number="1">afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb115-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(province) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb115-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">ISAF =</span> <span class="kw">mean</span>(<span class="kw">is.na</span>(violent.exp.ISAF)),</a>
<a class="sourceLine" id="cb115-4" data-line-number="4">            <span class="dt">taliban =</span> <span class="kw">mean</span>(<span class="kw">is.na</span>(violent.exp.taliban))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb115-5" data-line-number="5"><span class="st">  </span><span class="kw">arrange</span>(<span class="op">-</span>ISAF)</a>
<a class="sourceLine" id="cb115-6" data-line-number="6"><span class="co">#&gt; # A tibble: 5 x 3</span></a>
<a class="sourceLine" id="cb115-7" data-line-number="7"><span class="co">#&gt;   province    ISAF taliban</span></a>
<a class="sourceLine" id="cb115-8" data-line-number="8"><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb115-9" data-line-number="9"><span class="co">#&gt; 1 Uruzgan  0.0207  0.0620 </span></a>
<a class="sourceLine" id="cb115-10" data-line-number="10"><span class="co">#&gt; 2 Helmand  0.0164  0.0304 </span></a>
<a class="sourceLine" id="cb115-11" data-line-number="11"><span class="co">#&gt; 3 Khost    0.00476 0.00635</span></a>
<a class="sourceLine" id="cb115-12" data-line-number="12"><span class="co">#&gt; 4 Kunar    0       0      </span></a>
<a class="sourceLine" id="cb115-13" data-line-number="13"><span class="co">#&gt; 5 Logar    0       0</span></a></code></pre></div>
<p>Calculate the proportion who support the ISAF using the difference in means between the ISAF and control groups:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" data-line-number="1">(<span class="kw">mean</span>(<span class="kw">filter</span>(afghan, list.group <span class="op">==</span><span class="st"> &quot;ISAF&quot;</span>)<span class="op">$</span>list.response) <span class="op">-</span></a>
<a class="sourceLine" id="cb116-2" data-line-number="2"><span class="st">  </span><span class="kw">mean</span>(<span class="kw">filter</span>(afghan, list.group <span class="op">==</span><span class="st"> &quot;control&quot;</span>)<span class="op">$</span>list.response))</a>
<a class="sourceLine" id="cb116-3" data-line-number="3"><span class="co">#&gt; [1] 0.049</span></a></code></pre></div>
<p>To calculate the table responses to the list experiment in the control, ISAF, and Taliban groups:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb117-1" data-line-number="1">afghan <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb117-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(list.response, list.group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb117-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb117-4" data-line-number="4"><span class="st">  </span><span class="kw">glimpse</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb117-5" data-line-number="5"><span class="st">  </span><span class="kw">spread</span>(list.group, n, <span class="dt">fill =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb117-6" data-line-number="6"><span class="co">#&gt; Observations: 12</span></a>
<a class="sourceLine" id="cb117-7" data-line-number="7"><span class="co">#&gt; Variables: 3</span></a>
<a class="sourceLine" id="cb117-8" data-line-number="8"><span class="co">#&gt; $ list.response &lt;int&gt; 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4</span></a>
<a class="sourceLine" id="cb117-9" data-line-number="9"><span class="co">#&gt; $ list.group    &lt;chr&gt; &quot;control&quot;, &quot;ISAF&quot;, &quot;control&quot;, &quot;ISAF&quot;, &quot;taliban&quot;,...</span></a>
<a class="sourceLine" id="cb117-10" data-line-number="10"><span class="co">#&gt; $ n             &lt;int&gt; 188, 174, 265, 278, 433, 265, 260, 287, 200, 182...</span></a>
<a class="sourceLine" id="cb117-11" data-line-number="11"><span class="co">#&gt; # A tibble: 5 x 4</span></a>
<a class="sourceLine" id="cb117-12" data-line-number="12"><span class="co">#&gt; # Groups: list.response [5]</span></a>
<a class="sourceLine" id="cb117-13" data-line-number="13"><span class="co">#&gt;   list.response control  ISAF taliban</span></a>
<a class="sourceLine" id="cb117-14" data-line-number="14"><span class="co">#&gt; *         &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb117-15" data-line-number="15"><span class="co">#&gt; 1             0     188 174         0</span></a>
<a class="sourceLine" id="cb117-16" data-line-number="16"><span class="co">#&gt; 2             1     265 278       433</span></a>
<a class="sourceLine" id="cb117-17" data-line-number="17"><span class="co">#&gt; 3             2     265 260       287</span></a>
<a class="sourceLine" id="cb117-18" data-line-number="18"><span class="co">#&gt; 4             3     200 182       198</span></a>
<a class="sourceLine" id="cb117-19" data-line-number="19"><span class="co">#&gt; 5             4       0  24.0       0</span></a></code></pre></div>
</section>
</section>
<section id="measuring-political-polarization" class="level2">
<h2><span class="header-section-number">3.5</span> Measuring Political Polarization</h2>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;congress&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb119-1" data-line-number="1"><span class="kw">glimpse</span>(congress)</a>
<a class="sourceLine" id="cb119-2" data-line-number="2"><span class="co">#&gt; Observations: 14,552</span></a>
<a class="sourceLine" id="cb119-3" data-line-number="3"><span class="co">#&gt; Variables: 7</span></a>
<a class="sourceLine" id="cb119-4" data-line-number="4"><span class="co">#&gt; $ congress &lt;int&gt; 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 8...</span></a>
<a class="sourceLine" id="cb119-5" data-line-number="5"><span class="co">#&gt; $ district &lt;int&gt; 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 98, 98, 1, 2, 3, 4, 5, ...</span></a>
<a class="sourceLine" id="cb119-6" data-line-number="6"><span class="co">#&gt; $ state    &lt;chr&gt; &quot;USA&quot;, &quot;ALABAMA&quot;, &quot;ALABAMA&quot;, &quot;ALABAMA&quot;, &quot;ALABAMA&quot;, &quot;A...</span></a>
<a class="sourceLine" id="cb119-7" data-line-number="7"><span class="co">#&gt; $ party    &lt;chr&gt; &quot;Democrat&quot;, &quot;Democrat&quot;, &quot;Democrat&quot;, &quot;Democrat&quot;, &quot;Demo...</span></a>
<a class="sourceLine" id="cb119-8" data-line-number="8"><span class="co">#&gt; $ name     &lt;chr&gt; &quot;TRUMAN&quot;, &quot;BOYKIN  F.&quot;, &quot;GRANT  G.&quot;, &quot;ANDREWS  G.&quot;, &quot;...</span></a>
<a class="sourceLine" id="cb119-9" data-line-number="9"><span class="co">#&gt; $ dwnom1   &lt;dbl&gt; -0.276, -0.026, -0.042, -0.008, -0.082, -0.170, -0.12...</span></a>
<a class="sourceLine" id="cb119-10" data-line-number="10"><span class="co">#&gt; $ dwnom2   &lt;dbl&gt; 0.016, 0.796, 0.999, 1.005, 1.066, 0.870, 0.990, 0.89...</span></a></code></pre></div>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb120-1" data-line-number="1">q &lt;-</a>
<a class="sourceLine" id="cb120-2" data-line-number="2"><span class="st">  </span>congress <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(congress <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">80</span>, <span class="dv">112</span>),</a>
<a class="sourceLine" id="cb120-4" data-line-number="4">         party <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Democrat&quot;</span>, <span class="st">&quot;Republican&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> dwnom1, <span class="dt">y =</span> dwnom2, <span class="dt">colour =</span> party)) <span class="op">+</span></a>
<a class="sourceLine" id="cb120-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb120-7" data-line-number="7"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>congress) <span class="op">+</span></a>
<a class="sourceLine" id="cb120-8" data-line-number="8"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb120-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;racial liberalism/conservatism&quot;</span>,</a>
<a class="sourceLine" id="cb120-10" data-line-number="10">                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb120-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;economic liberalism/conservatism&quot;</span>,</a>
<a class="sourceLine" id="cb120-12" data-line-number="12">                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>))</a>
<a class="sourceLine" id="cb120-13" data-line-number="13">q</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-40-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>However, since there are colors associated with Democrats (blue) and Republicans (blue), we should use them rather than the defaults. There’s some evidence that using semantically-resonant colors can help decoding data visualizations (See <a href="http://vis.stanford.edu/files/2013-SemanticColor-EuroVis.pdf">Lin, et al. 2013</a>). Since I’ll reuse the scale several times, I’ll save it in a variable.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb121-1" data-line-number="1">scale_colour_parties &lt;-</a>
<a class="sourceLine" id="cb121-2" data-line-number="2"><span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">Democrat =</span> <span class="st">&quot;blue&quot;</span>,</a>
<a class="sourceLine" id="cb121-3" data-line-number="3">                                 <span class="dt">Republican =</span> <span class="st">&quot;red&quot;</span>,</a>
<a class="sourceLine" id="cb121-4" data-line-number="4">                                 <span class="dt">Other =</span> <span class="st">&quot;green&quot;</span>))</a>
<a class="sourceLine" id="cb121-5" data-line-number="5">q <span class="op">+</span><span class="st"> </span>scale_colour_parties</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-41-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" data-line-number="1">congress <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> dwnom1, <span class="dt">y =</span> dwnom2, <span class="dt">colour =</span> party)) <span class="op">+</span></a>
<a class="sourceLine" id="cb122-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb122-4" data-line-number="4"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>congress) <span class="op">+</span></a>
<a class="sourceLine" id="cb122-5" data-line-number="5"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb122-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;racial liberalism/conservatism&quot;</span>,</a>
<a class="sourceLine" id="cb122-7" data-line-number="7">                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb122-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;economic liberalism/conservatism&quot;</span>,</a>
<a class="sourceLine" id="cb122-9" data-line-number="9">                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)) </a>
<a class="sourceLine" id="cb122-10" data-line-number="10">  <span class="co">#scale_colour_parties</span></a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-42-1.png" width="100%" height="100%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb123-1" data-line-number="1">congress <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb123-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(congress, party) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb123-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">dwnom1 =</span> <span class="kw">mean</span>(dwnom1)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb123-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(party <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Democrat&quot;</span>, <span class="st">&quot;Republican&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb123-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> congress, <span class="dt">y =</span> dwnom1,</a>
<a class="sourceLine" id="cb123-6" data-line-number="6">             <span class="dt">colour =</span> <span class="kw">fct_reorder2</span>(party, congress, dwnom1))) <span class="op">+</span></a>
<a class="sourceLine" id="cb123-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb123-8" data-line-number="8"><span class="st">  </span>scale_colour_parties <span class="op">+</span></a>
<a class="sourceLine" id="cb123-9" data-line-number="9"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;DW-NOMINATE score (1st Dimension)&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Congress&quot;</span>,</a>
<a class="sourceLine" id="cb123-10" data-line-number="10">       <span class="dt">colour =</span> <span class="st">&quot;Party&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-43-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Alternatively, you can plot the mean DW-Nominate scores for each party and congress over time. This plot uses color for parties and lets the points and labels for the first and last congresses (80 and 112) to convey progress through time.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" data-line-number="1">party_means &lt;-</a>
<a class="sourceLine" id="cb124-2" data-line-number="2"><span class="st">  </span>congress <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(party <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Democrat&quot;</span>, <span class="st">&quot;Republican&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(party, congress) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">dwnom1 =</span> <span class="kw">mean</span>(dwnom1),</a>
<a class="sourceLine" id="cb124-6" data-line-number="6">            <span class="dt">dwnom2 =</span> <span class="kw">mean</span>(dwnom2))</a>
<a class="sourceLine" id="cb124-7" data-line-number="7"></a>
<a class="sourceLine" id="cb124-8" data-line-number="8">party_endpoints &lt;-</a>
<a class="sourceLine" id="cb124-9" data-line-number="9"><span class="st">  </span>party_means <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(congress <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="kw">min</span>(congress), <span class="kw">max</span>(congress))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">label =</span> <span class="kw">str_c</span>(party, congress, <span class="dt">sep =</span> <span class="st">&quot; - &quot;</span>))</a>
<a class="sourceLine" id="cb124-12" data-line-number="12"></a>
<a class="sourceLine" id="cb124-13" data-line-number="13"><span class="kw">ggplot</span>(party_means, </a>
<a class="sourceLine" id="cb124-14" data-line-number="14">         <span class="kw">aes</span>(<span class="dt">x =</span> dwnom1, <span class="dt">y =</span> dwnom2, <span class="dt">color =</span> party,</a>
<a class="sourceLine" id="cb124-15" data-line-number="15">             <span class="dt">group =</span> party)) <span class="op">+</span></a>
<a class="sourceLine" id="cb124-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb124-17" data-line-number="17"><span class="st">  </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb124-18" data-line-number="18"><span class="st">  </span>ggrepel<span class="op">::</span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> party_endpoints,</a>
<a class="sourceLine" id="cb124-19" data-line-number="19">                           <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">label =</span> congress),</a>
<a class="sourceLine" id="cb124-20" data-line-number="20">                           <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb124-21" data-line-number="21"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;racial liberalism/conservatism&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb124-22" data-line-number="22"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;economic liberalism/conservatism&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb124-23" data-line-number="23"><span class="st">  </span>scale_colour_parties</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-44-1.png" width="70%" style="display: block; margin: auto;" /></p>
<section id="correlation" class="level3">
<h3><span class="header-section-number">3.5.1</span> Correlation</h3>
<p>Let’s plot the Gini coefficient</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;USGini&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb126-1" data-line-number="1"><span class="kw">ggplot</span>(USGini, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> gini)) <span class="op">+</span></a>
<a class="sourceLine" id="cb126-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb126-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb126-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Year&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Gini coefficient&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb126-5" data-line-number="5"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Income Inequality&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-46-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>To calculate a measure of party polarization take the code used in the plot of Republican and Democratic party median ideal points and adapt it to calculate the difference in the party medians:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" data-line-number="1">party_polarization &lt;-</a>
<a class="sourceLine" id="cb127-2" data-line-number="2"><span class="st">  </span>congress <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb127-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(congress, party) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb127-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">dwnom1 =</span> <span class="kw">mean</span>(dwnom1)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb127-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(party <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Democrat&quot;</span>, <span class="st">&quot;Republican&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb127-6" data-line-number="6"><span class="st">  </span><span class="kw">spread</span>(party, dwnom1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb127-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">polarization =</span> Republican <span class="op">-</span><span class="st"> </span>Democrat)</a>
<a class="sourceLine" id="cb127-8" data-line-number="8">party_polarization</a>
<a class="sourceLine" id="cb127-9" data-line-number="9"><span class="co">#&gt; # A tibble: 33 x 4</span></a>
<a class="sourceLine" id="cb127-10" data-line-number="10"><span class="co">#&gt; # Groups: congress [33]</span></a>
<a class="sourceLine" id="cb127-11" data-line-number="11"><span class="co">#&gt;   congress Democrat Republican polarization</span></a>
<a class="sourceLine" id="cb127-12" data-line-number="12"><span class="co">#&gt;      &lt;int&gt;    &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb127-13" data-line-number="13"><span class="co">#&gt; 1       80   -0.146      0.276        0.421</span></a>
<a class="sourceLine" id="cb127-14" data-line-number="14"><span class="co">#&gt; 2       81   -0.195      0.264        0.459</span></a>
<a class="sourceLine" id="cb127-15" data-line-number="15"><span class="co">#&gt; 3       82   -0.180      0.265        0.445</span></a>
<a class="sourceLine" id="cb127-16" data-line-number="16"><span class="co">#&gt; 4       83   -0.181      0.261        0.442</span></a>
<a class="sourceLine" id="cb127-17" data-line-number="17"><span class="co">#&gt; 5       84   -0.209      0.261        0.471</span></a>
<a class="sourceLine" id="cb127-18" data-line-number="18"><span class="co">#&gt; 6       85   -0.214      0.250        0.464</span></a>
<a class="sourceLine" id="cb127-19" data-line-number="19"><span class="co">#&gt; # ... with 27 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" data-line-number="1"><span class="kw">ggplot</span>(party_polarization, <span class="kw">aes</span>(<span class="dt">x =</span> congress, <span class="dt">y =</span> polarization)) <span class="op">+</span></a>
<a class="sourceLine" id="cb128-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb128-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb128-4" data-line-number="4"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Political Polarization&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb128-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Year&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Republican median − Democratic median&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-48-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="quantile-quantile-plot" class="level3">
<h3><span class="header-section-number">3.5.2</span> Quantile-Quantile Plot</h3>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" data-line-number="1">congress <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(congress <span class="op">==</span><span class="st"> </span><span class="dv">112</span>, party <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Republican&quot;</span>, <span class="st">&quot;Democrat&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> dwnom2, <span class="dt">y =</span> ..density..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb129-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">.2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb129-5" data-line-number="5"><span class="st">  </span><span class="kw">facet_grid</span>(party <span class="op">~</span><span class="st"> </span>.) <span class="op">+</span></a>
<a class="sourceLine" id="cb129-6" data-line-number="6"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;racial liberalism/conservatism dimension&quot;</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-49-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The package <em>ggplot2</em> includes a function <code>stat_qq</code> which can be used to create qq-plots but it is more suited to comparing a sample distribution with a theoretical distribution, usually the normal one. However, we can calculate one by hand, which may give more insight into exactly what the qq-plot is doing.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb130-1" data-line-number="1">party_qtiles &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb130-2" data-line-number="2">  <span class="dt">probs =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">0.01</span>),</a>
<a class="sourceLine" id="cb130-3" data-line-number="3">  <span class="dt">Democrat =</span> <span class="kw">quantile</span>(<span class="kw">filter</span>(congress, congress <span class="op">==</span><span class="st"> </span><span class="dv">112</span>,</a>
<a class="sourceLine" id="cb130-4" data-line-number="4">                             party <span class="op">==</span><span class="st"> &quot;Democrat&quot;</span>)<span class="op">$</span>dwnom2,</a>
<a class="sourceLine" id="cb130-5" data-line-number="5">         <span class="dt">probs =</span> probs),</a>
<a class="sourceLine" id="cb130-6" data-line-number="6">  <span class="dt">Republican =</span> <span class="kw">quantile</span>(<span class="kw">filter</span>(congress, congress <span class="op">==</span><span class="st"> </span><span class="dv">112</span>,</a>
<a class="sourceLine" id="cb130-7" data-line-number="7">                               party <span class="op">==</span><span class="st"> &quot;Republican&quot;</span>)<span class="op">$</span>dwnom2,</a>
<a class="sourceLine" id="cb130-8" data-line-number="8">         <span class="dt">probs =</span> probs)</a>
<a class="sourceLine" id="cb130-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb130-10" data-line-number="10">party_qtiles</a>
<a class="sourceLine" id="cb130-11" data-line-number="11"><span class="co">#&gt; # A tibble: 101 x 3</span></a>
<a class="sourceLine" id="cb130-12" data-line-number="12"><span class="co">#&gt;    probs Democrat Republican</span></a>
<a class="sourceLine" id="cb130-13" data-line-number="13"><span class="co">#&gt;    &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb130-14" data-line-number="14"><span class="co">#&gt; 1 0        -0.925     -1.38 </span></a>
<a class="sourceLine" id="cb130-15" data-line-number="15"><span class="co">#&gt; 2 0.0100   -0.672     -0.720</span></a>
<a class="sourceLine" id="cb130-16" data-line-number="16"><span class="co">#&gt; 3 0.0200   -0.619     -0.566</span></a>
<a class="sourceLine" id="cb130-17" data-line-number="17"><span class="co">#&gt; 4 0.0300   -0.593     -0.526</span></a>
<a class="sourceLine" id="cb130-18" data-line-number="18"><span class="co">#&gt; 5 0.0400   -0.567     -0.468</span></a>
<a class="sourceLine" id="cb130-19" data-line-number="19"><span class="co">#&gt; 6 0.0500   -0.560     -0.436</span></a>
<a class="sourceLine" id="cb130-20" data-line-number="20"><span class="co">#&gt; # ... with 95 more rows</span></a></code></pre></div>
<p>The plot looks different than the one in the text since the x- and y-scales are in the original values instead of z-scores (see the next section).</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" data-line-number="1">party_qtiles <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Democrat, <span class="dt">y =</span> Republican)) <span class="op">+</span></a>
<a class="sourceLine" id="cb131-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb131-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_abline</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb131-5" data-line-number="5"><span class="st">  </span><span class="kw">coord_fixed</span>()</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-51-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
</section>
<section id="clustering" class="level2">
<h2><span class="header-section-number">3.6</span> Clustering</h2>
<section id="matrices" class="level3">
<h3><span class="header-section-number">3.6.1</span> Matrices</h3>
<p>While matrices are great for numerical computations, such as when you are implementing algorithms, generally keeping data in data frames is more convenient for data wrangling.</p>
<p>See <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/vectors.html">Vectors</a>.</p>
</section>
<section id="lists" class="level3">
<h3><span class="header-section-number">3.6.2</span> Lists</h3>
<p>See <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapters <a href="http://r4ds.had.co.nz/vectors.html">Vectors</a> and <a href="http://r4ds.had.co.nz/iteration.html">Iteration</a>, as well as the <a href="https://cran.r-project.org/package=purrr">purrr</a> package for more powerful methods of computing on lists.</p>
</section>
<section id="k-means-algorithms" class="level3">
<h3><span class="header-section-number">3.6.3</span> k-means algorithms</h3>
<p>Calculate the clusters by the 80th and 112th congresses:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb132-1" data-line-number="1">k80two.out &lt;-</a>
<a class="sourceLine" id="cb132-2" data-line-number="2"><span class="st">  </span><span class="kw">kmeans</span>(<span class="kw">select</span>(<span class="kw">filter</span>(congress, congress <span class="op">==</span><span class="st"> </span><span class="dv">80</span>),</a>
<a class="sourceLine" id="cb132-3" data-line-number="3">                       dwnom1, dwnom2),</a>
<a class="sourceLine" id="cb132-4" data-line-number="4">              <span class="dt">centers =</span> <span class="dv">2</span>, <span class="dt">nstart =</span> <span class="dv">5</span>)</a></code></pre></div>
<p>Add the cluster ids to data sets:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb133-1" data-line-number="1">congress80 &lt;-</a>
<a class="sourceLine" id="cb133-2" data-line-number="2"><span class="st">  </span>congress <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(congress <span class="op">==</span><span class="st"> </span><span class="dv">80</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cluster2 =</span> <span class="kw">factor</span>(k80two.out<span class="op">$</span>cluster))</a></code></pre></div>
<p>We will also create a data sets with the cluster centroids. These are in the <code>centers</code> element of the cluster object.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" data-line-number="1">k80two.out<span class="op">$</span>centers</a>
<a class="sourceLine" id="cb134-2" data-line-number="2"><span class="co">#&gt;    dwnom1 dwnom2</span></a>
<a class="sourceLine" id="cb134-3" data-line-number="3"><span class="co">#&gt; 1 -0.0484  0.783</span></a>
<a class="sourceLine" id="cb134-4" data-line-number="4"><span class="co">#&gt; 2  0.1468 -0.339</span></a></code></pre></div>
<p>To make it easier to use with <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a>, we need to convert this to a data frame. The <a href="https://www.rdocumentation.org/packages/broom/topics/tidy">tidy</a> function from the <a href="https://cran.r-project.org/package=broom">broom</a> package:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb135-1" data-line-number="1">k80two.clusters &lt;-<span class="st"> </span><span class="kw">tidy</span>(k80two.out)</a>
<a class="sourceLine" id="cb135-2" data-line-number="2">k80two.clusters</a>
<a class="sourceLine" id="cb135-3" data-line-number="3"><span class="co">#&gt;        x1     x2 size withinss cluster</span></a>
<a class="sourceLine" id="cb135-4" data-line-number="4"><span class="co">#&gt; 1 -0.0484  0.783  135     10.9       1</span></a>
<a class="sourceLine" id="cb135-5" data-line-number="5"><span class="co">#&gt; 2  0.1468 -0.339  311     54.9       2</span></a></code></pre></div>
<p>Plot the ideal points and clusters:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" data-line-number="1"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb136-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> congress80,</a>
<a class="sourceLine" id="cb136-3" data-line-number="3">             <span class="kw">aes</span>(<span class="dt">x =</span> dwnom1, <span class="dt">y =</span> dwnom2, <span class="dt">colour =</span> cluster2)) <span class="op">+</span></a>
<a class="sourceLine" id="cb136-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> k80two.clusters, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> x1, <span class="dt">y =</span> x2))</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-56-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb137-1" data-line-number="1">congress80 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(party, cluster2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>()</a>
<a class="sourceLine" id="cb137-4" data-line-number="4"><span class="co">#&gt; # A tibble: 5 x 3</span></a>
<a class="sourceLine" id="cb137-5" data-line-number="5"><span class="co">#&gt; # Groups: party, cluster2 [5]</span></a>
<a class="sourceLine" id="cb137-6" data-line-number="6"><span class="co">#&gt;   party      cluster2     n</span></a>
<a class="sourceLine" id="cb137-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;      &lt;fctr&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb137-8" data-line-number="8"><span class="co">#&gt; 1 Democrat   1          132</span></a>
<a class="sourceLine" id="cb137-9" data-line-number="9"><span class="co">#&gt; 2 Democrat   2           62</span></a>
<a class="sourceLine" id="cb137-10" data-line-number="10"><span class="co">#&gt; 3 Other      2            2</span></a>
<a class="sourceLine" id="cb137-11" data-line-number="11"><span class="co">#&gt; 4 Republican 1            3</span></a>
<a class="sourceLine" id="cb137-12" data-line-number="12"><span class="co">#&gt; 5 Republican 2          247</span></a></code></pre></div>
<p>And now we can repeat these steps for the 112th congress:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" data-line-number="1">k112two.out &lt;-</a>
<a class="sourceLine" id="cb138-2" data-line-number="2"><span class="st">  </span><span class="kw">kmeans</span>(<span class="kw">select</span>(<span class="kw">filter</span>(congress, congress <span class="op">==</span><span class="st"> </span><span class="dv">112</span>),</a>
<a class="sourceLine" id="cb138-3" data-line-number="3">                dwnom1, dwnom2),</a>
<a class="sourceLine" id="cb138-4" data-line-number="4">         <span class="dt">centers =</span> <span class="dv">2</span>, <span class="dt">nstart =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb138-5" data-line-number="5">congress112 &lt;-</a>
<a class="sourceLine" id="cb138-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(congress, congress <span class="op">==</span><span class="st"> </span><span class="dv">112</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb138-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cluster2 =</span> <span class="kw">factor</span>(k112two.out<span class="op">$</span>cluster))</a>
<a class="sourceLine" id="cb138-8" data-line-number="8">k112two.clusters &lt;-<span class="st"> </span><span class="kw">tidy</span>(k112two.out)</a>
<a class="sourceLine" id="cb138-9" data-line-number="9"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb138-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> congress112,</a>
<a class="sourceLine" id="cb138-11" data-line-number="11">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> dwnom1, <span class="dt">y =</span> dwnom2, <span class="dt">colour =</span> cluster2)) <span class="op">+</span></a>
<a class="sourceLine" id="cb138-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> k112two.clusters,</a>
<a class="sourceLine" id="cb138-13" data-line-number="13">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> x1, <span class="dt">y =</span> x2))</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-58-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Number of observations from each party in each cluster:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb139-1" data-line-number="1">congress112 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb139-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(party, cluster2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb139-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>()</a>
<a class="sourceLine" id="cb139-4" data-line-number="4"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb139-5" data-line-number="5"><span class="co">#&gt; # Groups: party, cluster2 [3]</span></a>
<a class="sourceLine" id="cb139-6" data-line-number="6"><span class="co">#&gt;   party      cluster2     n</span></a>
<a class="sourceLine" id="cb139-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;      &lt;fctr&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb139-8" data-line-number="8"><span class="co">#&gt; 1 Democrat   1          200</span></a>
<a class="sourceLine" id="cb139-9" data-line-number="9"><span class="co">#&gt; 2 Republican 1            1</span></a>
<a class="sourceLine" id="cb139-10" data-line-number="10"><span class="co">#&gt; 3 Republican 2          242</span></a></code></pre></div>
<p>Now repeat the same with four clusters on the 80th congress:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" data-line-number="1">k80four.out &lt;-</a>
<a class="sourceLine" id="cb140-2" data-line-number="2"><span class="st">  </span><span class="kw">kmeans</span>(<span class="kw">select</span>(<span class="kw">filter</span>(congress, congress <span class="op">==</span><span class="st"> </span><span class="dv">80</span>),</a>
<a class="sourceLine" id="cb140-3" data-line-number="3">                dwnom1, dwnom2),</a>
<a class="sourceLine" id="cb140-4" data-line-number="4">         <span class="dt">centers =</span> <span class="dv">4</span>, <span class="dt">nstart =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb140-5" data-line-number="5">congress80 &lt;-</a>
<a class="sourceLine" id="cb140-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(congress, congress <span class="op">==</span><span class="st"> </span><span class="dv">80</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb140-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cluster2 =</span> <span class="kw">factor</span>(k80four.out<span class="op">$</span>cluster))</a>
<a class="sourceLine" id="cb140-8" data-line-number="8">k80four.clusters &lt;-<span class="st"> </span><span class="kw">tidy</span>(k80four.out)</a>
<a class="sourceLine" id="cb140-9" data-line-number="9"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb140-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> congress80,</a>
<a class="sourceLine" id="cb140-11" data-line-number="11">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> dwnom1, <span class="dt">y =</span> dwnom2, <span class="dt">colour =</span> cluster2)) <span class="op">+</span></a>
<a class="sourceLine" id="cb140-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> k80four.clusters,</a>
<a class="sourceLine" id="cb140-13" data-line-number="13">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> x1, <span class="dt">y =</span> x2), <span class="dt">size =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-60-1.png" width="70%" style="display: block; margin: auto;" /> and on the 112th congress:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb141-1" data-line-number="1">k112four.out &lt;-</a>
<a class="sourceLine" id="cb141-2" data-line-number="2"><span class="st">  </span><span class="kw">kmeans</span>(<span class="kw">select</span>(<span class="kw">filter</span>(congress, congress <span class="op">==</span><span class="st"> </span><span class="dv">112</span>),</a>
<a class="sourceLine" id="cb141-3" data-line-number="3">                dwnom1, dwnom2),</a>
<a class="sourceLine" id="cb141-4" data-line-number="4">         <span class="dt">centers =</span> <span class="dv">4</span>, <span class="dt">nstart =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb141-5" data-line-number="5">congress112 &lt;-</a>
<a class="sourceLine" id="cb141-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(congress, congress <span class="op">==</span><span class="st"> </span><span class="dv">112</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb141-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cluster2 =</span> <span class="kw">factor</span>(k112four.out<span class="op">$</span>cluster))</a>
<a class="sourceLine" id="cb141-8" data-line-number="8">k112four.clusters &lt;-<span class="st"> </span><span class="kw">tidy</span>(k112four.out)</a>
<a class="sourceLine" id="cb141-9" data-line-number="9"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb141-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> congress112,</a>
<a class="sourceLine" id="cb141-11" data-line-number="11">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> dwnom1, <span class="dt">y =</span> dwnom2, <span class="dt">colour =</span> cluster2)) <span class="op">+</span></a>
<a class="sourceLine" id="cb141-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> k112four.clusters,</a>
<a class="sourceLine" id="cb141-13" data-line-number="13">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> x1, <span class="dt">y =</span> x2), <span class="dt">size =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><img src="measurement_files/figure-html/unnamed-chunk-61-1.png" width="70%" style="display: block; margin: auto;" /></p>

</section>
</section>
</section>
<section id="prediction" class="level1">
<h1><span class="header-section-number">4</span> Prediction</h1>
<section id="prerequisites-3" class="level2 unnumbered">
<h2>Prerequisites</h2>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb142-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a>
<a class="sourceLine" id="cb142-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)</a>
<a class="sourceLine" id="cb142-3" data-line-number="3"><span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)</a>
<a class="sourceLine" id="cb142-4" data-line-number="4"><span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)</a></code></pre></div>
<p>The packages <a href="https://cran.r-project.org/package=modelr">modelr</a> and <a href="https://cran.r-project.org/package=broom">broom</a> are used to wrangle the results of linear regressions,</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb143-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;broom&quot;</span>)</a>
<a class="sourceLine" id="cb143-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;modelr&quot;</span>)</a></code></pre></div>
</section>
<section id="predicting-election-outcomes" class="level2">
<h2><span class="header-section-number">4.1</span> Predicting Election Outcomes</h2>
<section id="loops-in-r" class="level3">
<h3><span class="header-section-number">4.1.1</span> Loops in R</h3>
<p>RStudio provides many features to help debugging, which will be useful in for loops and function: see <a href="https://support.rstudio.com/hc/en-us/articles/205612627-Debugging-with-RStudio">this</a> article for an example.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb144-1" data-line-number="1">values &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb144-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="kw">length</span>(values)</a>
<a class="sourceLine" id="cb144-3" data-line-number="3">results &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, n)</a>
<a class="sourceLine" id="cb144-4" data-line-number="4"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n) {</a>
<a class="sourceLine" id="cb144-5" data-line-number="5">  results[i] &lt;-<span class="st"> </span>values[i] <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb144-6" data-line-number="6">  <span class="kw">cat</span>(values[i], <span class="st">&quot;times 2 is equal to&quot;</span>, results[i], <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb144-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb144-8" data-line-number="8"><span class="co">#&gt; 2 times 2 is equal to 4 </span></a>
<a class="sourceLine" id="cb144-9" data-line-number="9"><span class="co">#&gt; 3 times 2 is equal to 6 </span></a>
<a class="sourceLine" id="cb144-10" data-line-number="10"><span class="co">#&gt; 6 times 2 is equal to 12</span></a></code></pre></div>
<p>Note that the above code uses the for loop for pedagogical purposes only, this could have simply been written</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb145-1" data-line-number="1">results &lt;-<span class="st"> </span>values <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb145-2" data-line-number="2">results</a>
<a class="sourceLine" id="cb145-3" data-line-number="3"><span class="co">#&gt; [1]  4  6 12</span></a></code></pre></div>
<p>In general, avoid using for loops when there is a <em>vectorized</em> function.</p>
<p>But sticking with the for loop, there are several things that could be improved.</p>
<p>Avoid using the idiom <code>1:n</code> in for loops. To see why, look what happens when values are empty:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb146-1" data-line-number="1">values &lt;-<span class="st"> </span><span class="kw">c</span>()</a>
<a class="sourceLine" id="cb146-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="kw">length</span>(values)</a>
<a class="sourceLine" id="cb146-3" data-line-number="3">results &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, n)</a>
<a class="sourceLine" id="cb146-4" data-line-number="4"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n) {</a>
<a class="sourceLine" id="cb146-5" data-line-number="5">  <span class="kw">cat</span>(<span class="st">&quot;i = &quot;</span>, i, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb146-6" data-line-number="6">  results[i] &lt;-<span class="st"> </span>values[i] <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb146-7" data-line-number="7">  <span class="kw">cat</span>(values[i], <span class="st">&quot;times 2 is equal to&quot;</span>, results[i], <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb146-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb146-9" data-line-number="9"><span class="co">#&gt; i =  1 </span></a>
<a class="sourceLine" id="cb146-10" data-line-number="10"><span class="co">#&gt;  times 2 is equal to NA </span></a>
<a class="sourceLine" id="cb146-11" data-line-number="11"><span class="co">#&gt; i =  0 </span></a>
<a class="sourceLine" id="cb146-12" data-line-number="12"><span class="co">#&gt;  times 2 is equal to</span></a></code></pre></div>
<p>Instead of not running a loop, as you would expect, it runs two loops, where <code>i = 1</code>, then <code>i = 0</code>. This edge case occurs more than you may think, especially if you are writing functions where you don’t know the length of the vector is <em>ex ante</em>.</p>
<p>The way to avoid this is to use either <code>rdoc(&quot;base&quot;, &quot;seq_len&quot;)</code> or <code>rdoc(&quot;base&quot;, &quot;seq_along&quot;)</code>, which will handle 0-length vectors correctly.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb147-1" data-line-number="1">values &lt;-<span class="st"> </span><span class="kw">c</span>()</a>
<a class="sourceLine" id="cb147-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="kw">length</span>(values)</a>
<a class="sourceLine" id="cb147-3" data-line-number="3">results &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, n)</a>
<a class="sourceLine" id="cb147-4" data-line-number="4"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(values)) {</a>
<a class="sourceLine" id="cb147-5" data-line-number="5">  results[i] &lt;-<span class="st"> </span>values[i] <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb147-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb147-7" data-line-number="7"><span class="kw">print</span>(results)</a>
<a class="sourceLine" id="cb147-8" data-line-number="8"><span class="co">#&gt; logical(0)</span></a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb148-1" data-line-number="1">values &lt;-<span class="st"> </span><span class="kw">c</span>()</a>
<a class="sourceLine" id="cb148-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="kw">length</span>(values)</a>
<a class="sourceLine" id="cb148-3" data-line-number="3">results &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, n)</a>
<a class="sourceLine" id="cb148-4" data-line-number="4"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(n)) {</a>
<a class="sourceLine" id="cb148-5" data-line-number="5">  results[i] &lt;-<span class="st"> </span>values[i] <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb148-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb148-7" data-line-number="7"><span class="kw">print</span>(results)</a>
<a class="sourceLine" id="cb148-8" data-line-number="8"><span class="co">#&gt; logical(0)</span></a></code></pre></div>
<p>Also, note that the the result is <code>logical(0)</code>. That’s because the <code>NA</code> missing value has class <a href="http://r4ds.had.co.nz/vectors.html#missing-values-4">logical</a>, and thus <code>rep(NA, ...)</code> returns a logical vector. It is better style to initialize the vector with the same data type that you will be using,</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb149-1" data-line-number="1">results &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA_real_</span>, <span class="kw">length</span>(values))</a>
<a class="sourceLine" id="cb149-2" data-line-number="2">results</a>
<a class="sourceLine" id="cb149-3" data-line-number="3"><span class="co">#&gt; numeric(0)</span></a>
<a class="sourceLine" id="cb149-4" data-line-number="4"><span class="kw">class</span>(results)</a>
<a class="sourceLine" id="cb149-5" data-line-number="5"><span class="co">#&gt; [1] &quot;numeric&quot;</span></a></code></pre></div>
<p>Often loops can be rewritten to use a map function. Read the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/data-visualisation.html">Iteration</a> before proceeding.</p>
<p>To do so, we first write a function that will be applied to each element of the vector. When converting from a <code>for</code> loop to a function, this is usually simply the body of the <code>for</code> loop, though you may need to add arguments for any variables defined outside the body of the for loop. In this case,</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb150-1" data-line-number="1">mult_by_two &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb150-2" data-line-number="2">  x <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb150-3" data-line-number="3">}</a></code></pre></div>
<p>We can now test that this function works on different values:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb151-1" data-line-number="1"><span class="kw">mult_by_two</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb151-2" data-line-number="2"><span class="co">#&gt; [1] 0</span></a>
<a class="sourceLine" id="cb151-3" data-line-number="3"><span class="kw">mult_by_two</span>(<span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb151-4" data-line-number="4"><span class="co">#&gt; [1] 5</span></a>
<a class="sourceLine" id="cb151-5" data-line-number="5"><span class="kw">mult_by_two</span>(<span class="op">-</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb151-6" data-line-number="6"><span class="co">#&gt; [1] -6</span></a></code></pre></div>
<p>At this point, we could replace the body of the <code>for</code> loop with this function:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb152-1" data-line-number="1">values &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb152-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="kw">length</span>(values)</a>
<a class="sourceLine" id="cb152-3" data-line-number="3">results &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, n)</a>
<a class="sourceLine" id="cb152-4" data-line-number="4"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(n)) {</a>
<a class="sourceLine" id="cb152-5" data-line-number="5">  results[i] &lt;-<span class="st"> </span><span class="kw">mult_by_two</span>(values[i])</a>
<a class="sourceLine" id="cb152-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb152-7" data-line-number="7"><span class="kw">print</span>(results)</a>
<a class="sourceLine" id="cb152-8" data-line-number="8"><span class="co">#&gt; [1]  4  8 12</span></a></code></pre></div>
<p>This can be useful if the body of a for loop is many lines long.</p>
<p>However, this loop is still unwieldy code. We have to remember to define an empty vector <code>results</code> that is the same size as <code>values</code> to hold the results, and then correctly loop over all the values. We already saw how these steps have possibilities for errors. Functionals like <code>map</code>, apply a function to each element of a vector.</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb153-1" data-line-number="1">results &lt;-<span class="st"> </span><span class="kw">map</span>(values, mult_by_two)</a>
<a class="sourceLine" id="cb153-2" data-line-number="2">results</a>
<a class="sourceLine" id="cb153-3" data-line-number="3"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb153-4" data-line-number="4"><span class="co">#&gt; [1] 4</span></a>
<a class="sourceLine" id="cb153-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb153-6" data-line-number="6"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb153-7" data-line-number="7"><span class="co">#&gt; [1] 8</span></a>
<a class="sourceLine" id="cb153-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb153-9" data-line-number="9"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb153-10" data-line-number="10"><span class="co">#&gt; [1] 12</span></a></code></pre></div>
<p>The values of each element are correct, but <code>map</code> returns a list vector, not a numeric vector like we may have been expecting. If we want a numeric vector, use <code>map_dbl</code>,</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb154-1" data-line-number="1">results &lt;-<span class="st"> </span><span class="kw">map_dbl</span>(values, mult_by_two)</a>
<a class="sourceLine" id="cb154-2" data-line-number="2">results</a>
<a class="sourceLine" id="cb154-3" data-line-number="3"><span class="co">#&gt; [1]  4  8 12</span></a></code></pre></div>
<p>Also, instead of explicitly defining a function, like <code>mult_by_two</code>, we could have instead used an <em>anonymous function</em> with the functional. An anonymous function is a function that is not assigned to a name.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb155-1" data-line-number="1">results &lt;-<span class="st"> </span><span class="kw">map_dbl</span>(values, <span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb155-2" data-line-number="2">results</a>
<a class="sourceLine" id="cb155-3" data-line-number="3"><span class="co">#&gt; [1]  4  8 12</span></a></code></pre></div>
<p>The various <a href="https://cran.r-project.org/package=purrr">purrr</a> functions also will interpret formulas as functions where <code>.x</code> and <code>.y</code> are interpreted as (up to) two arguments.</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb156-1" data-line-number="1">results &lt;-<span class="st"> </span><span class="kw">map_dbl</span>(values, <span class="op">~</span><span class="st"> </span>.x <span class="op">*</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb156-2" data-line-number="2">results</a>
<a class="sourceLine" id="cb156-3" data-line-number="3"><span class="co">#&gt; [1]  4  8 12</span></a></code></pre></div>
<p>This is for parsimony and convenience; in the background, these functions are creating anonymous functions from the given formula.</p>
<p><em>QSS</em> discusses several debugging strategies. The functional approach lends itself to easier debugging because the function can be tested with input values independently of the loop.</p>
</section>
<section id="general-conditional-statements-in-r" class="level3">
<h3><span class="header-section-number">4.1.2</span> General Conditional Statements in R</h3>
<p>See the <em>R for Data Science</em> section <a href="http://r4ds.had.co.nz/functions.html#conditional-execution">Conditional Execution</a> for a more complete discussion of conditional execution.</p>
<p>If you are using conditional statements to assign values for data frame, see the <strong>dplyr</strong> functions <a href="https://www.rdocumentation.org/packages/dplyr/topics/if_else">if_else</a>, <a href="https://www.rdocumentation.org/packages/dplyr/topics/recode">recode</a>, and <a href="https://www.rdocumentation.org/packages/dplyr/topics/case_when">case_when</a></p>
<p>The following code which uses a for loop,</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb157-1" data-line-number="1">values &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">5</span></a>
<a class="sourceLine" id="cb157-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="kw">length</span>(values)</a>
<a class="sourceLine" id="cb157-3" data-line-number="3">results &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA_real_</span>, n)</a>
<a class="sourceLine" id="cb157-4" data-line-number="4"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(n)) {</a>
<a class="sourceLine" id="cb157-5" data-line-number="5">  x &lt;-<span class="st"> </span>values[i]</a>
<a class="sourceLine" id="cb157-6" data-line-number="6">  r &lt;-<span class="st"> </span>x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb157-7" data-line-number="7">  <span class="cf">if</span> (r <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb157-8" data-line-number="8">    <span class="kw">cat</span>(x, <span class="st">&quot;is even and I will perform addition&quot;</span>, x, <span class="st">&quot; + &quot;</span>, x, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb157-9" data-line-number="9">    results[i] &lt;-<span class="st"> </span>x <span class="op">+</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb157-10" data-line-number="10">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb157-11" data-line-number="11">    <span class="kw">cat</span>(x, <span class="st">&quot;is even and I will perform multiplication&quot;</span>, x, <span class="st">&quot; * &quot;</span>, x, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb157-12" data-line-number="12">    results[i] &lt;-<span class="st"> </span>x <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb157-13" data-line-number="13">  }</a>
<a class="sourceLine" id="cb157-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb157-15" data-line-number="15"><span class="co">#&gt; 1 is even and I will perform multiplication 1  *  1 </span></a>
<a class="sourceLine" id="cb157-16" data-line-number="16"><span class="co">#&gt; 2 is even and I will perform addition 2  +  2 </span></a>
<a class="sourceLine" id="cb157-17" data-line-number="17"><span class="co">#&gt; 3 is even and I will perform multiplication 3  *  3 </span></a>
<a class="sourceLine" id="cb157-18" data-line-number="18"><span class="co">#&gt; 4 is even and I will perform addition 4  +  4 </span></a>
<a class="sourceLine" id="cb157-19" data-line-number="19"><span class="co">#&gt; 5 is even and I will perform multiplication 5  *  5</span></a>
<a class="sourceLine" id="cb157-20" data-line-number="20">results</a>
<a class="sourceLine" id="cb157-21" data-line-number="21"><span class="co">#&gt; [1]  1  4  9  8 25</span></a></code></pre></div>
<p>could be rewritten to use <code>if_else</code>,</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb158-1" data-line-number="1"><span class="kw">if_else</span>(values <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, values <span class="op">+</span><span class="st"> </span>values, values <span class="op">*</span><span class="st"> </span>values)</a>
<a class="sourceLine" id="cb158-2" data-line-number="2"><span class="co">#&gt; [1]  1  4  9  8 25</span></a></code></pre></div>
<p>or using the <code>map_dbl</code> functional with a named function,</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb159-1" data-line-number="1">myfunc &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb159-2" data-line-number="2">  <span class="cf">if</span> (x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb159-3" data-line-number="3">    x <span class="op">+</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb159-4" data-line-number="4">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb159-5" data-line-number="5">    x <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb159-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb159-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb159-8" data-line-number="8"><span class="kw">map_dbl</span>(values, myfunc)</a>
<a class="sourceLine" id="cb159-9" data-line-number="9"><span class="co">#&gt; [1]  1  4  9  8 25</span></a></code></pre></div>
<p>or <code>map_dbl</code> with an anonymous function,</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb160-1" data-line-number="1"><span class="kw">map_dbl</span>(values, <span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb160-2" data-line-number="2">  <span class="cf">if</span> (x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb160-3" data-line-number="3">    x <span class="op">+</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb160-4" data-line-number="4">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb160-5" data-line-number="5">    x <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb160-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb160-7" data-line-number="7">})</a>
<a class="sourceLine" id="cb160-8" data-line-number="8"><span class="co">#&gt; [1]  1  4  9  8 25</span></a></code></pre></div>
</section>
<section id="poll-predictions" class="level3">
<h3><span class="header-section-number">4.1.3</span> Poll Predictions</h3>
<p>Load the election polls by state for the 2008 US Presidential election,</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb161-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;polls08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb161-2" data-line-number="2"><span class="kw">glimpse</span>(polls08)</a>
<a class="sourceLine" id="cb161-3" data-line-number="3"><span class="co">#&gt; Observations: 1,332</span></a>
<a class="sourceLine" id="cb161-4" data-line-number="4"><span class="co">#&gt; Variables: 5</span></a>
<a class="sourceLine" id="cb161-5" data-line-number="5"><span class="co">#&gt; $ state    &lt;chr&gt; &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;,...</span></a>
<a class="sourceLine" id="cb161-6" data-line-number="6"><span class="co">#&gt; $ Pollster &lt;chr&gt; &quot;SurveyUSA-2&quot;, &quot;Capital Survey-2&quot;, &quot;SurveyUSA-2&quot;, &quot;Ca...</span></a>
<a class="sourceLine" id="cb161-7" data-line-number="7"><span class="co">#&gt; $ Obama    &lt;int&gt; 36, 34, 35, 35, 39, 34, 36, 25, 35, 34, 37, 36, 36, 3...</span></a>
<a class="sourceLine" id="cb161-8" data-line-number="8"><span class="co">#&gt; $ McCain   &lt;int&gt; 61, 54, 62, 55, 60, 64, 58, 52, 55, 47, 55, 51, 49, 5...</span></a>
<a class="sourceLine" id="cb161-9" data-line-number="9"><span class="co">#&gt; $ middate  &lt;date&gt; 2008-10-27, 2008-10-15, 2008-10-08, 2008-10-06, 2008...</span></a></code></pre></div>
<p>and the election results,</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb162-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;pres08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb162-2" data-line-number="2"><span class="kw">glimpse</span>(pres08)</a>
<a class="sourceLine" id="cb162-3" data-line-number="3"><span class="co">#&gt; Observations: 51</span></a>
<a class="sourceLine" id="cb162-4" data-line-number="4"><span class="co">#&gt; Variables: 5</span></a>
<a class="sourceLine" id="cb162-5" data-line-number="5"><span class="co">#&gt; $ state.name &lt;chr&gt; &quot;Alabama&quot;, &quot;Alaska&quot;, &quot;Arizona&quot;, &quot;Arkansas&quot;, &quot;Califo...</span></a>
<a class="sourceLine" id="cb162-6" data-line-number="6"><span class="co">#&gt; $ state      &lt;chr&gt; &quot;AL&quot;, &quot;AK&quot;, &quot;AZ&quot;, &quot;AR&quot;, &quot;CA&quot;, &quot;CO&quot;, &quot;CT&quot;, &quot;DC&quot;, &quot;DE...</span></a>
<a class="sourceLine" id="cb162-7" data-line-number="7"><span class="co">#&gt; $ Obama      &lt;int&gt; 39, 38, 45, 39, 61, 54, 61, 92, 62, 51, 47, 72, 36,...</span></a>
<a class="sourceLine" id="cb162-8" data-line-number="8"><span class="co">#&gt; $ McCain     &lt;int&gt; 60, 59, 54, 59, 37, 45, 38, 7, 37, 48, 52, 27, 62, ...</span></a>
<a class="sourceLine" id="cb162-9" data-line-number="9"><span class="co">#&gt; $ EV         &lt;int&gt; 9, 3, 10, 6, 55, 9, 7, 3, 3, 27, 15, 4, 4, 21, 11, ...</span></a></code></pre></div>
<p>Compute Obama’s margin in polls and final election</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb163-1" data-line-number="1">polls08 &lt;-</a>
<a class="sourceLine" id="cb163-2" data-line-number="2"><span class="st">  </span>polls08 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">margin =</span> Obama <span class="op">-</span><span class="st"> </span>McCain)</a>
<a class="sourceLine" id="cb163-3" data-line-number="3">pres08 &lt;-</a>
<a class="sourceLine" id="cb163-4" data-line-number="4"><span class="st">  </span>pres08 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">margin =</span> Obama <span class="op">-</span><span class="st"> </span>McCain)</a></code></pre></div>
<p>To work with dates, the R package <a href="https://cran.r-project.org/package=lubridate">lubridate</a> makes wrangling them much easier. See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/dates-and-times.html">Dates and Times</a>.</p>
<p>The function <a href="https://www.rdocumentation.org/packages/lubridate/topics/ymd">ymd</a> will convert character strings like <code>year-month-day</code> and more into dates, as long as the order is (year, month, day). See <a href="https://www.rdocumentation.org/packages/lubridate/topics/dmy">dmy</a>, <a href="https://www.rdocumentation.org/packages/lubridate/topics/mdy">mdy</a>, and others for other ways to convert strings to dates.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb164-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="st">&quot;2008-11-04&quot;</span>)</a>
<a class="sourceLine" id="cb164-2" data-line-number="2">y &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="st">&quot;2008/9/1&quot;</span>)</a>
<a class="sourceLine" id="cb164-3" data-line-number="3">x <span class="op">-</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb164-4" data-line-number="4"><span class="co">#&gt; Time difference of 64 days</span></a></code></pre></div>
<p>However, note that in <code>polls08</code>, the date <code>middate</code> is <em>already</em> a <code>date</code> object,</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb165-1" data-line-number="1"><span class="kw">class</span>(polls08<span class="op">$</span>middate)</a>
<a class="sourceLine" id="cb165-2" data-line-number="2"><span class="co">#&gt; [1] &quot;Date&quot;</span></a></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/readr/topics/read_csv">read_csv</a> by default will check character vectors to see if they have patterns that appear to be dates, and if so, will parse those columns as dates.</p>
<p>We’ll create a variable for election day</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb166-1" data-line-number="1">ELECTION_DAY &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="st">&quot;2008-11-04&quot;</span>)</a></code></pre></div>
<p>and add a new column to <code>poll08</code> with the days to the election</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb167-1" data-line-number="1">polls08 &lt;-<span class="st"> </span><span class="kw">mutate</span>(polls08, ELECTION_DAY <span class="op">-</span><span class="st"> </span>middate)</a></code></pre></div>
<p>Although the code in the chapter uses a <code>for</code> loop, there is no reason to do so. We can accomplish the same task by merging the election results data to the polling data by <code>state</code>.</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb168-1" data-line-number="1">polls_w_results &lt;-<span class="st"> </span><span class="kw">left_join</span>(polls08,</a>
<a class="sourceLine" id="cb168-2" data-line-number="2">                            <span class="kw">select</span>(pres08, state, <span class="dt">elec_margin =</span> margin),</a>
<a class="sourceLine" id="cb168-3" data-line-number="3">                            <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">error =</span> elec_margin <span class="op">-</span><span class="st"> </span>margin)</a>
<a class="sourceLine" id="cb168-5" data-line-number="5"><span class="kw">glimpse</span>(polls_w_results)</a>
<a class="sourceLine" id="cb168-6" data-line-number="6"><span class="co">#&gt; Observations: 1,332</span></a>
<a class="sourceLine" id="cb168-7" data-line-number="7"><span class="co">#&gt; Variables: 9</span></a>
<a class="sourceLine" id="cb168-8" data-line-number="8"><span class="co">#&gt; $ state                    &lt;chr&gt; &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;AL&quot;, &quot;...</span></a>
<a class="sourceLine" id="cb168-9" data-line-number="9"><span class="co">#&gt; $ Pollster                 &lt;chr&gt; &quot;SurveyUSA-2&quot;, &quot;Capital Survey-2&quot;, &quot;S...</span></a>
<a class="sourceLine" id="cb168-10" data-line-number="10"><span class="co">#&gt; $ Obama                    &lt;int&gt; 36, 34, 35, 35, 39, 34, 36, 25, 35, 3...</span></a>
<a class="sourceLine" id="cb168-11" data-line-number="11"><span class="co">#&gt; $ McCain                   &lt;int&gt; 61, 54, 62, 55, 60, 64, 58, 52, 55, 4...</span></a>
<a class="sourceLine" id="cb168-12" data-line-number="12"><span class="co">#&gt; $ middate                  &lt;date&gt; 2008-10-27, 2008-10-15, 2008-10-08, ...</span></a>
<a class="sourceLine" id="cb168-13" data-line-number="13"><span class="co">#&gt; $ margin                   &lt;int&gt; -25, -20, -27, -20, -21, -30, -22, -2...</span></a>
<a class="sourceLine" id="cb168-14" data-line-number="14"><span class="co">#&gt; $ `ELECTION_DAY - middate` &lt;time&gt; 8 days, 20 days, 27 days, 29 days, 4...</span></a>
<a class="sourceLine" id="cb168-15" data-line-number="15"><span class="co">#&gt; $ elec_margin              &lt;int&gt; -21, -21, -21, -21, -21, -21, -21, -2...</span></a>
<a class="sourceLine" id="cb168-16" data-line-number="16"><span class="co">#&gt; $ error                    &lt;int&gt; 4, -1, 6, -1, 0, 9, 1, 6, -1, -8, -3,...</span></a></code></pre></div>
<p>To get the last poll in each state, arrange and filter on <code>middate</code></p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb169-1" data-line-number="1">last_polls &lt;-</a>
<a class="sourceLine" id="cb169-2" data-line-number="2"><span class="st">  </span>polls_w_results <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb169-3" data-line-number="3"><span class="st">  </span><span class="kw">arrange</span>(state, <span class="kw">desc</span>(middate)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb169-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb169-5" data-line-number="5"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb169-6" data-line-number="6">last_polls</a>
<a class="sourceLine" id="cb169-7" data-line-number="7"><span class="co">#&gt; # A tibble: 51 x 9</span></a>
<a class="sourceLine" id="cb169-8" data-line-number="8"><span class="co">#&gt; # Groups: state [51]</span></a>
<a class="sourceLine" id="cb169-9" data-line-number="9"><span class="co">#&gt;   state Pollster        Obama McCain middate    margin `ELECT… elec… error</span></a>
<a class="sourceLine" id="cb169-10" data-line-number="10"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;           &lt;int&gt;  &lt;int&gt; &lt;date&gt;      &lt;int&gt; &lt;time&gt;  &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb169-11" data-line-number="11"><span class="co">#&gt; 1 AK    Research 2000-3    39     58 2008-10-29    -19 6         -21   - 2</span></a>
<a class="sourceLine" id="cb169-12" data-line-number="12"><span class="co">#&gt; 2 AL    SurveyUSA-2        36     61 2008-10-27    -25 8         -21     4</span></a>
<a class="sourceLine" id="cb169-13" data-line-number="13"><span class="co">#&gt; 3 AR    ARG-4              44     51 2008-10-29    - 7 6         -20   -13</span></a>
<a class="sourceLine" id="cb169-14" data-line-number="14"><span class="co">#&gt; 4 AZ    ARG-3              46     50 2008-10-29    - 4 6         - 9   - 5</span></a>
<a class="sourceLine" id="cb169-15" data-line-number="15"><span class="co">#&gt; 5 CA    SurveyUSA-3        60     36 2008-10-30     24 5          24     0</span></a>
<a class="sourceLine" id="cb169-16" data-line-number="16"><span class="co">#&gt; 6 CO    ARG-3              52     45 2008-10-29      7 6           9     2</span></a>
<a class="sourceLine" id="cb169-17" data-line-number="17"><span class="co">#&gt; # ... with 45 more rows</span></a></code></pre></div>
<p><strong>Challenge:</strong> Instead of using the last poll, use the average of polls in the last week? Last month? How do the margins on the polls change over the election period?</p>
<p>To simplify things for later, let’s define a function <code>rmse</code> which calculates the root mean squared error, as defined in the book. See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/functions.html">Functions</a> for more on writing functions.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb170-1" data-line-number="1">rmse &lt;-<span class="st"> </span><span class="cf">function</span>(actual, pred) {</a>
<a class="sourceLine" id="cb170-2" data-line-number="2">  <span class="kw">sqrt</span>(<span class="kw">mean</span>( (actual <span class="op">-</span><span class="st"> </span>pred) <span class="op">^</span><span class="st"> </span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb170-3" data-line-number="3">}</a></code></pre></div>
<p>Now we can use <code>rmse()</code> to calculate the RMSE for all the final polls:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb171-1" data-line-number="1"><span class="kw">rmse</span>(last_polls<span class="op">$</span>margin, last_polls<span class="op">$</span>elec_margin)</a>
<a class="sourceLine" id="cb171-2" data-line-number="2"><span class="co">#&gt; [1] 5.88</span></a></code></pre></div>
<p>Or since we already have a variable <code>error</code>,</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb172-1" data-line-number="1"><span class="kw">sqrt</span>(<span class="kw">mean</span>(last_polls<span class="op">$</span>error <span class="op">^</span><span class="st"> </span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb172-2" data-line-number="2"><span class="co">#&gt; [1] 5.88</span></a></code></pre></div>
<p>The mean prediction error is</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb173-1" data-line-number="1"><span class="kw">mean</span>(last_polls<span class="op">$</span>error)</a>
<a class="sourceLine" id="cb173-2" data-line-number="2"><span class="co">#&gt; [1] 1.08</span></a></code></pre></div>
<p>This is slightly different than what is in the book due to the difference in the poll used as the final poll; many states have many polls on the last day.</p>
<p>I’ll choose bin widths of 1%, since that is fairly interpretable:</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb174-1" data-line-number="1"><span class="kw">ggplot</span>(last_polls, <span class="kw">aes</span>(<span class="dt">x =</span> error)) <span class="op">+</span></a>
<a class="sourceLine" id="cb174-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">boundary =</span> <span class="dv">0</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-31-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The text uses bin widths of 5%:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb175-1" data-line-number="1"><span class="kw">ggplot</span>(last_polls, <span class="kw">aes</span>(<span class="dt">x =</span> error)) <span class="op">+</span></a>
<a class="sourceLine" id="cb175-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">5</span>, <span class="dt">boundary =</span> <span class="dv">0</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-32-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><strong>Challenge:</strong> What other ways could you visualize the results? How would you show all states? What about plotting the absolute or squared errors instead of the errors?</p>
<p><strong>Challenge:</strong> What happens to prediction error if you average polls? Consider averaging back over time? What happens if you take the averages of the state poll average and average of <strong>all</strong> polls - does that improve prediction?</p>
<p>To create a scatter plots using the state abbreviations instead of points use <a href="http://docs.ggplot2.org/current/geom_text.html">geom_text</a> instead of <a href="http://docs.ggplot2.org/current/geom_point.html">geom_point</a>.</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb176-1" data-line-number="1"><span class="kw">ggplot</span>(last_polls, <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> elec_margin, <span class="dt">label =</span> state)) <span class="op">+</span></a>
<a class="sourceLine" id="cb176-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb176-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;gray&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb176-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;gray&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb176-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_text</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb176-6" data-line-number="6"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb176-7" data-line-number="7"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Poll Results&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Actual Election Results&quot;</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-33-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We can create a confusion matrix as follows. Create a new column <code>classification</code> which shows how the poll’s classification was related to the actual election outcome (“true positive”, “false positive”, “true negative”, “false negative”). If there were two outcomes, then we would use the function. But with more than two outcomes, it is easier to use the <a href="https://cran.r-project.org/package=dplyr">dplyr</a> function .</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb177-1" data-line-number="1">last_polls &lt;-</a>
<a class="sourceLine" id="cb177-2" data-line-number="2"><span class="st">  </span>last_polls <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb177-3" data-line-number="3"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb177-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">classification =</span></a>
<a class="sourceLine" id="cb177-5" data-line-number="5">           <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb177-6" data-line-number="6">             (.<span class="op">$</span>margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>elec_margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">~</span><span class="st"> &quot;true positive&quot;</span>,</a>
<a class="sourceLine" id="cb177-7" data-line-number="7">             (.<span class="op">$</span>margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>elec_margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">~</span><span class="st"> &quot;false positive&quot;</span>,</a>
<a class="sourceLine" id="cb177-8" data-line-number="8">             (.<span class="op">$</span>margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>elec_margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">~</span><span class="st"> &quot;true negative&quot;</span>,</a>
<a class="sourceLine" id="cb177-9" data-line-number="9">             (.<span class="op">$</span>margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>elec_margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">~</span><span class="st"> &quot;false negative&quot;</span></a>
<a class="sourceLine" id="cb177-10" data-line-number="10">           ))</a></code></pre></div>
<p>You need to use <code>.</code> to refer to the data frame when using <code>case_when()</code> within <code>mutate()</code>. Also, we needed to first use in order to remove the grouping variable so <code>mutate()</code> will work.</p>
<p>Now simply count the number of polls in each category of <code>classification</code>:</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb178-1" data-line-number="1">last_polls <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb178-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(classification) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb178-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>()</a>
<a class="sourceLine" id="cb178-4" data-line-number="4"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb178-5" data-line-number="5"><span class="co">#&gt; # Groups: classification [4]</span></a>
<a class="sourceLine" id="cb178-6" data-line-number="6"><span class="co">#&gt;   classification     n</span></a>
<a class="sourceLine" id="cb178-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb178-8" data-line-number="8"><span class="co">#&gt; 1 false negative     2</span></a>
<a class="sourceLine" id="cb178-9" data-line-number="9"><span class="co">#&gt; 2 false positive     1</span></a>
<a class="sourceLine" id="cb178-10" data-line-number="10"><span class="co">#&gt; 3 true negative     21</span></a>
<a class="sourceLine" id="cb178-11" data-line-number="11"><span class="co">#&gt; 4 true positive     27</span></a></code></pre></div>
<p>Which states were incorrectly predicted by the polls, and what was their margins?</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb179-1" data-line-number="1">last_polls <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb179-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(classification <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;false positive&quot;</span>, <span class="st">&quot;false negative&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb179-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(state, margin, elec_margin, classification) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb179-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(elec_margin))</a>
<a class="sourceLine" id="cb179-5" data-line-number="5"><span class="co">#&gt; # A tibble: 3 x 4</span></a>
<a class="sourceLine" id="cb179-6" data-line-number="6"><span class="co">#&gt;   state margin elec_margin classification</span></a>
<a class="sourceLine" id="cb179-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt;       &lt;int&gt; &lt;chr&gt;         </span></a>
<a class="sourceLine" id="cb179-8" data-line-number="8"><span class="co">#&gt; 1 IN        -5           1 false negative</span></a>
<a class="sourceLine" id="cb179-9" data-line-number="9"><span class="co">#&gt; 2 NC        -1           1 false negative</span></a>
<a class="sourceLine" id="cb179-10" data-line-number="10"><span class="co">#&gt; 3 MO         1          -1 false positive</span></a></code></pre></div>
<p>What was the difference in the poll prediction of electoral votes and actual electoral votes? We hadn’t included the variable <code>EV</code> when we first merged, but that’s no problem, we’ll just merge again in order to grab that variable:</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb180-1" data-line-number="1">last_polls <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb180-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">select</span>(pres08, state, EV), <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb180-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">EV_pred =</span> <span class="kw">sum</span>( (margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>EV),</a>
<a class="sourceLine" id="cb180-4" data-line-number="4">            <span class="dt">EV_actual =</span> <span class="kw">sum</span>( (elec_margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>EV))</a>
<a class="sourceLine" id="cb180-5" data-line-number="5"><span class="co">#&gt; # A tibble: 1 x 2</span></a>
<a class="sourceLine" id="cb180-6" data-line-number="6"><span class="co">#&gt;   EV_pred EV_actual</span></a>
<a class="sourceLine" id="cb180-7" data-line-number="7"><span class="co">#&gt;     &lt;int&gt;     &lt;int&gt;</span></a>
<a class="sourceLine" id="cb180-8" data-line-number="8"><span class="co">#&gt; 1     349       364</span></a></code></pre></div>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb181-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;pollsUS08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb182-1" data-line-number="1">pollsUS08 &lt;-<span class="st"> </span><span class="kw">mutate</span>(pollsUS08, <span class="dt">DaysToElection =</span> ELECTION_DAY <span class="op">-</span><span class="st"> </span>middate)</a></code></pre></div>
<p>We’ll produce the seven-day averages slightly differently than the method used in the text. For all dates in the data, we’ll calculate the moving average. The code presented in <em>QSS</em> uses a for loop similar to the following:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb183-1" data-line-number="1">all_dates &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(polls08<span class="op">$</span>middate), ELECTION_DAY, <span class="dt">by =</span> <span class="st">&quot;days&quot;</span>)</a>
<a class="sourceLine" id="cb183-2" data-line-number="2"></a>
<a class="sourceLine" id="cb183-3" data-line-number="3"><span class="co"># Number of poll days to use</span></a>
<a class="sourceLine" id="cb183-4" data-line-number="4">POLL_DAYS &lt;-<span class="st"> </span><span class="dv">7</span></a>
<a class="sourceLine" id="cb183-5" data-line-number="5"></a>
<a class="sourceLine" id="cb183-6" data-line-number="6">pop_vote_avg &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="kw">length</span>(all_dates), <span class="dt">mode =</span> <span class="st">&quot;list&quot;</span>)</a>
<a class="sourceLine" id="cb183-7" data-line-number="7"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(all_dates)) {</a>
<a class="sourceLine" id="cb183-8" data-line-number="8">  date &lt;-<span class="st"> </span>all_dates[i]</a>
<a class="sourceLine" id="cb183-9" data-line-number="9">  <span class="co"># summarise the seven day</span></a>
<a class="sourceLine" id="cb183-10" data-line-number="10">  week_data &lt;-</a>
<a class="sourceLine" id="cb183-11" data-line-number="11"><span class="st">     </span><span class="kw">filter</span>(polls08,</a>
<a class="sourceLine" id="cb183-12" data-line-number="12">            <span class="kw">as.integer</span>(middate <span class="op">-</span><span class="st"> </span>date) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>,</a>
<a class="sourceLine" id="cb183-13" data-line-number="13">            <span class="kw">as.integer</span>(middate <span class="op">-</span><span class="st"> </span>date) <span class="op">&gt;</span><span class="st"> </span><span class="op">-</span><span class="st"> </span>POLL_DAYS) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb183-14" data-line-number="14"><span class="st">     </span><span class="kw">summarise</span>(<span class="dt">Obama =</span> <span class="kw">mean</span>(Obama, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb183-15" data-line-number="15">               <span class="dt">McCain =</span> <span class="kw">mean</span>(McCain, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb183-16" data-line-number="16">  <span class="co"># add date for the observation</span></a>
<a class="sourceLine" id="cb183-17" data-line-number="17">  week_data<span class="op">$</span>date &lt;-<span class="st"> </span>date</a>
<a class="sourceLine" id="cb183-18" data-line-number="18">  pop_vote_avg[[i]] &lt;-<span class="st"> </span>week_data</a>
<a class="sourceLine" id="cb183-19" data-line-number="19">}</a>
<a class="sourceLine" id="cb183-20" data-line-number="20"></a>
<a class="sourceLine" id="cb183-21" data-line-number="21">pop_vote_avg &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(pop_vote_avg)</a></code></pre></div>
<p>Write a function which takes a <code>date</code>, and calculates the <code>days</code> (set the default to 7 days) moving average using the dataset <code>.data</code>:</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb184-1" data-line-number="1">poll_ma &lt;-<span class="st"> </span><span class="cf">function</span>(date, .data, <span class="dt">days =</span> <span class="dv">7</span>) {</a>
<a class="sourceLine" id="cb184-2" data-line-number="2">  <span class="kw">filter</span>(.data,</a>
<a class="sourceLine" id="cb184-3" data-line-number="3">        <span class="kw">as.integer</span>(middate <span class="op">-</span><span class="st"> </span>date) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>,</a>
<a class="sourceLine" id="cb184-4" data-line-number="4">        <span class="kw">as.integer</span>(middate <span class="op">-</span><span class="st"> </span>date) <span class="op">&gt;</span><span class="st"> </span><span class="op">-</span><span class="st"> </span><span class="op">!!</span>days) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb184-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">Obama =</span> <span class="kw">mean</span>(Obama, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb184-6" data-line-number="6">           <span class="dt">McCain =</span> <span class="kw">mean</span>(McCain, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb184-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="op">!!</span>date)</a>
<a class="sourceLine" id="cb184-8" data-line-number="8">}</a></code></pre></div>
<p>The code above uses <code>!!</code>. This tells <code>filter</code> that <code>days</code> refers to a variable <code>days</code> in the calling environment, and not a column named <code>days</code> in the data frame. In this case, there wouldn’t be any ambiguities since there is not a column named <code>days</code>, but in general there can be ambiguities in the dplyr functions as to whether the names refer to columns in the data frame or variables in the environment calling the function. Read <a href="http://dplyr.tidyverse.org/articles/programming.html">Programming with dplyr</a> for an in-depth discussion of this.</p>
<p>This returns a one row data frame with the moving average for McCain and Obama on Nov 1, 2008.</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb185-1" data-line-number="1"><span class="kw">poll_ma</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2008-11-01&quot;</span>), polls08)</a>
<a class="sourceLine" id="cb185-2" data-line-number="2"><span class="co">#&gt;   Obama McCain       date</span></a>
<a class="sourceLine" id="cb185-3" data-line-number="3"><span class="co">#&gt; 1  49.1   45.4 2008-11-01</span></a></code></pre></div>
<p>Since we made <code>days</code> an argument to the function we could easily change the code to calculate other moving averages,</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb186-1" data-line-number="1"><span class="kw">poll_ma</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2008-11-01&quot;</span>), polls08, <span class="dt">days =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb186-2" data-line-number="2"><span class="co">#&gt;   Obama McCain       date</span></a>
<a class="sourceLine" id="cb186-3" data-line-number="3"><span class="co">#&gt; 1  50.6   45.4 2008-11-01</span></a></code></pre></div>
<p>Now use a functional to execute that function with all dates for which we want moving averages. The function <code>poll_ma</code> returns a data frame, and our ideal output is a data frame that stacks those data frames row-wise. So we will use the <code>map_df</code> function,</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb187-1" data-line-number="1"><span class="kw">map_df</span>(all_dates, poll_ma, polls08)</a></code></pre></div>
<p>Note that the other arguments for <code>poll_ma</code> are placed after the name of the function as additional arguments to <code>map_df</code>.</p>
<p>It is easier to plot this if the data are tidy, with <code>Obama</code> and <code>McCain</code> as categories of a column <code>candidate</code>.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb188-1" data-line-number="1">pop_vote_avg_tidy &lt;-</a>
<a class="sourceLine" id="cb188-2" data-line-number="2"><span class="st">  </span>pop_vote_avg <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb188-3" data-line-number="3"><span class="st">  </span><span class="kw">gather</span>(candidate, share, <span class="op">-</span>date, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb188-4" data-line-number="4"><span class="kw">head</span>(pop_vote_avg_tidy)</a>
<a class="sourceLine" id="cb188-5" data-line-number="5"><span class="co">#&gt;         date candidate share</span></a>
<a class="sourceLine" id="cb188-6" data-line-number="6"><span class="co">#&gt; 1 2008-01-01     Obama  46.5</span></a>
<a class="sourceLine" id="cb188-7" data-line-number="7"><span class="co">#&gt; 2 2008-01-02     Obama  46.5</span></a>
<a class="sourceLine" id="cb188-8" data-line-number="8"><span class="co">#&gt; 3 2008-01-03     Obama  46.5</span></a>
<a class="sourceLine" id="cb188-9" data-line-number="9"><span class="co">#&gt; 4 2008-01-04     Obama  46.5</span></a>
<a class="sourceLine" id="cb188-10" data-line-number="10"><span class="co">#&gt; 5 2008-01-05     Obama  46.5</span></a>
<a class="sourceLine" id="cb188-11" data-line-number="11"><span class="co">#&gt; 6 2008-01-06     Obama  46.5</span></a></code></pre></div>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb189-1" data-line-number="1"><span class="kw">ggplot</span>(pop_vote_avg_tidy, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> share,</a>
<a class="sourceLine" id="cb189-2" data-line-number="2">                              <span class="dt">colour =</span> <span class="kw">fct_reorder2</span>(candidate, date, share))) <span class="op">+</span></a>
<a class="sourceLine" id="cb189-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb189-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb189-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="st">&quot;Candidate&quot;</span>,</a>
<a class="sourceLine" id="cb189-6" data-line-number="6">                      <span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">Obama =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">McCain =</span> <span class="st">&quot;red&quot;</span>))</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-46-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><strong>Challenge</strong> read <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/iteration.html#the-map-functions">Iteration</a> and use the function <a href="https://www.rdocumentation.org/packages/purrr/topics/map_df">map_df</a> to create the object <code>poll_vote_avg</code> as above instead of a for loop.</p>
<p>The 7-day average is similar to the simple method used by <a href="http://www.realclearpolitics.com/epolls/2016/president/us/general_election_trump_vs_clinton-5491.html">Real Clear Politics</a>. The RCP average is simply the average of all polls in their data for the last seven days. Sites like <a href="https://fivethirtyeight.com">538</a> and the <a href="http://elections.huffingtonpost.com/pollster">Huffpost Pollster</a>, on the other hand, also use what amounts to averaging polls, but using more sophisticated statistical methods to assign different weights to different polls.</p>
<p><strong>Challenge</strong> Why do we need to use different polls for the popular vote data? Why not simply average all the state polls? What would you have to do? Would the overall popular vote be useful in predicting state-level polling, or vice-versa? How would you use them?</p>
</section>
</section>
<section id="linear-regression" class="level2">
<h2><span class="header-section-number">4.2</span> Linear Regression</h2>
<section id="facial-appearance-and-election-outcomes" class="level3">
<h3><span class="header-section-number">4.2.1</span> Facial Appearance and Election Outcomes</h3>
<p>Load the <code>face</code> dataset:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb190-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;face&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>Add Democrat and Republican vote shares, and the difference in shares:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb191-1" data-line-number="1">face &lt;-<span class="st"> </span><span class="kw">mutate</span>(face,</a>
<a class="sourceLine" id="cb191-2" data-line-number="2">                <span class="dt">d.share =</span> d.votes <span class="op">/</span><span class="st"> </span>(d.votes <span class="op">+</span><span class="st"> </span>r.votes),</a>
<a class="sourceLine" id="cb191-3" data-line-number="3">                <span class="dt">r.share =</span> r.votes <span class="op">/</span><span class="st"> </span>(d.votes <span class="op">+</span><span class="st"> </span>r.votes),</a>
<a class="sourceLine" id="cb191-4" data-line-number="4">                <span class="dt">diff.share =</span> d.share <span class="op">-</span><span class="st"> </span>r.share)</a></code></pre></div>
<p>Plot facial competence vs. vote share:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb192-1" data-line-number="1"><span class="kw">ggplot</span>(face, <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share, <span class="dt">colour =</span> w.party)) <span class="op">+</span></a>
<a class="sourceLine" id="cb192-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb192-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb192-4" data-line-number="4"><span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="st">&quot;Winning</span><span class="ch">\n</span><span class="st">Party&quot;</span>,</a>
<a class="sourceLine" id="cb192-5" data-line-number="5">                      <span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">R =</span> <span class="st">&quot;red&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb192-6" data-line-number="6"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Competence scores for Democrats&quot;</span>,</a>
<a class="sourceLine" id="cb192-7" data-line-number="7">       <span class="dt">y =</span> <span class="st">&quot;Democratic margin in vote share&quot;</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-47-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="correlation-and-scatter-plots" class="level3">
<h3><span class="header-section-number">4.2.2</span> Correlation and Scatter Plots</h3>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb193-1" data-line-number="1"><span class="kw">cor</span>(face<span class="op">$</span>d.comp, face<span class="op">$</span>diff.share)</a>
<a class="sourceLine" id="cb193-2" data-line-number="2"><span class="co">#&gt; [1] 0.433</span></a></code></pre></div>
</section>
<section id="least-squares" class="level3">
<h3><span class="header-section-number">4.2.3</span> Least Squares</h3>
<p>Run the linear regression</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb194-1" data-line-number="1">fit &lt;-<span class="st"> </span><span class="kw">lm</span>(diff.share <span class="op">~</span><span class="st"> </span>d.comp, <span class="dt">data =</span> face)</a>
<a class="sourceLine" id="cb194-2" data-line-number="2">fit</a>
<a class="sourceLine" id="cb194-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb194-4" data-line-number="4"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb194-5" data-line-number="5"><span class="co">#&gt; lm(formula = diff.share ~ d.comp, data = face)</span></a>
<a class="sourceLine" id="cb194-6" data-line-number="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb194-7" data-line-number="7"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb194-8" data-line-number="8"><span class="co">#&gt; (Intercept)       d.comp  </span></a>
<a class="sourceLine" id="cb194-9" data-line-number="9"><span class="co">#&gt;      -0.312        0.660</span></a></code></pre></div>
<p>There are many functions to get data out of the <code>lm</code> model.</p>
<p>In addition to these, the <a href="https://cran.r-project.org/package=broom">broom</a> package provides three functions: <code>glance</code>, <code>tidy</code>, and <code>augment</code> that always return data frames.</p>
<p>The function <a href="https://www.rdocumentation.org/packages/broom/topics/glance.lm">glance</a> returns a one-row data-frame summary of the model,</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb195-1" data-line-number="1"><span class="kw">glance</span>(fit)</a>
<a class="sourceLine" id="cb195-2" data-line-number="2"><span class="co">#&gt;   r.squared adj.r.squared sigma statistic  p.value df logLik AIC  BIC</span></a>
<a class="sourceLine" id="cb195-3" data-line-number="3"><span class="co">#&gt; 1     0.187          0.18 0.266        27 8.85e-07  2  -10.5  27 35.3</span></a>
<a class="sourceLine" id="cb195-4" data-line-number="4"><span class="co">#&gt;   deviance df.residual</span></a>
<a class="sourceLine" id="cb195-5" data-line-number="5"><span class="co">#&gt; 1     8.31         117</span></a></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/broom/topics/tidy.lm">tidy</a> returns a data frame in which each row is a coefficient,</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb196-1" data-line-number="1"><span class="kw">tidy</span>(fit)</a>
<a class="sourceLine" id="cb196-2" data-line-number="2"><span class="co">#&gt;          term estimate std.error statistic  p.value</span></a>
<a class="sourceLine" id="cb196-3" data-line-number="3"><span class="co">#&gt; 1 (Intercept)   -0.312     0.066     -4.73 6.24e-06</span></a>
<a class="sourceLine" id="cb196-4" data-line-number="4"><span class="co">#&gt; 2      d.comp    0.660     0.127      5.19 8.85e-07</span></a></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/broom/topics/augment.lm">augment</a> returns the original data with fitted values, residuals, and other observation level stats from the model appended to it.</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb197-1" data-line-number="1"><span class="kw">augment</span>(fit) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb197-2" data-line-number="2"><span class="co">#&gt;   diff.share d.comp .fitted .se.fit  .resid    .hat .sigma  .cooksd</span></a>
<a class="sourceLine" id="cb197-3" data-line-number="3"><span class="co">#&gt; 1     0.2101  0.565  0.0606  0.0266  0.1495 0.00996  0.267 0.001600</span></a>
<a class="sourceLine" id="cb197-4" data-line-number="4"><span class="co">#&gt; 2     0.1194  0.342 -0.0864  0.0302  0.2059 0.01286  0.267 0.003938</span></a>
<a class="sourceLine" id="cb197-5" data-line-number="5"><span class="co">#&gt; 3     0.0499  0.612  0.0922  0.0295 -0.0423 0.01229  0.268 0.000158</span></a>
<a class="sourceLine" id="cb197-6" data-line-number="6"><span class="co">#&gt; 4     0.1965  0.542  0.0454  0.0256  0.1511 0.00922  0.267 0.001510</span></a>
<a class="sourceLine" id="cb197-7" data-line-number="7"><span class="co">#&gt; 5     0.4958  0.680  0.1370  0.0351  0.3588 0.01737  0.266 0.016307</span></a>
<a class="sourceLine" id="cb197-8" data-line-number="8"><span class="co">#&gt; 6    -0.3495  0.321 -0.1006  0.0319 -0.2490 0.01433  0.267 0.006436</span></a>
<a class="sourceLine" id="cb197-9" data-line-number="9"><span class="co">#&gt;   .std.resid</span></a>
<a class="sourceLine" id="cb197-10" data-line-number="10"><span class="co">#&gt; 1      0.564</span></a>
<a class="sourceLine" id="cb197-11" data-line-number="11"><span class="co">#&gt; 2      0.778</span></a>
<a class="sourceLine" id="cb197-12" data-line-number="12"><span class="co">#&gt; 3     -0.160</span></a>
<a class="sourceLine" id="cb197-13" data-line-number="13"><span class="co">#&gt; 4      0.570</span></a>
<a class="sourceLine" id="cb197-14" data-line-number="14"><span class="co">#&gt; 5      1.358</span></a>
<a class="sourceLine" id="cb197-15" data-line-number="15"><span class="co">#&gt; 6     -0.941</span></a></code></pre></div>
<p>We can plot the results of the bivariate linear regression as follows:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb198-1" data-line-number="1"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb198-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> face, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share)) <span class="op">+</span></a>
<a class="sourceLine" id="cb198-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="kw">mean</span>(face<span class="op">$</span>d.comp)) <span class="op">+</span></a>
<a class="sourceLine" id="cb198-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="kw">mean</span>(face<span class="op">$</span>diff.share)) <span class="op">+</span></a>
<a class="sourceLine" id="cb198-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">slope =</span> <span class="kw">coef</span>(fit)[<span class="st">&quot;d.comp&quot;</span>],</a>
<a class="sourceLine" id="cb198-6" data-line-number="6">              <span class="dt">intercept =</span> <span class="kw">coef</span>(fit)[<span class="st">&quot;(Intercept)&quot;</span>],</a>
<a class="sourceLine" id="cb198-7" data-line-number="7">              <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb198-8" data-line-number="8"><span class="st">  </span><span class="kw">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="fl">0.9</span>, <span class="dt">y =</span> <span class="kw">mean</span>(face<span class="op">$</span>diff.share) <span class="op">+</span><span class="st"> </span><span class="fl">0.05</span>,</a>
<a class="sourceLine" id="cb198-9" data-line-number="9">           <span class="dt">label =</span> <span class="st">&quot;Mean of Y&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">vjust =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb198-10" data-line-number="10"><span class="st">  </span><span class="kw">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="dt">y =</span> <span class="fl">-0.9</span>, <span class="dt">x =</span> <span class="kw">mean</span>(face<span class="op">$</span>d.comp), <span class="dt">label =</span> <span class="st">&quot;Mean of X&quot;</span>,</a>
<a class="sourceLine" id="cb198-11" data-line-number="11">           <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">hjust =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb198-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Democratic margin in vote shares&quot;</span>,</a>
<a class="sourceLine" id="cb198-13" data-line-number="13">                     <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">0.5</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb198-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Democratic margin in vote shares&quot;</span>,</a>
<a class="sourceLine" id="cb198-15" data-line-number="15">                     <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">0.2</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb198-16" data-line-number="16"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Facial compotence and vote share&quot;</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-53-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>A more general way to plot the predictions of the model against the data is to use the methods described in <a href="http://r4ds.had.co.nz/model-basics.html#visualising-models">Ch 23.3.3</a> of R4DS. Create an evenly spaced grid of values of <code>d.comp</code>, and add predictions of the model to it.</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb199-1" data-line-number="1">grid &lt;-<span class="st"> </span>face <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb199-2" data-line-number="2"><span class="st">  </span><span class="kw">data_grid</span>(d.comp) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb199-3" data-line-number="3"><span class="st">  </span><span class="kw">add_predictions</span>(fit)</a>
<a class="sourceLine" id="cb199-4" data-line-number="4"><span class="kw">head</span>(grid)</a>
<a class="sourceLine" id="cb199-5" data-line-number="5"><span class="co">#&gt; # A tibble: 6 x 2</span></a>
<a class="sourceLine" id="cb199-6" data-line-number="6"><span class="co">#&gt;   d.comp   pred</span></a>
<a class="sourceLine" id="cb199-7" data-line-number="7"><span class="co">#&gt;    &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb199-8" data-line-number="8"><span class="co">#&gt; 1 0.0640 -0.270</span></a>
<a class="sourceLine" id="cb199-9" data-line-number="9"><span class="co">#&gt; 2 0.0847 -0.256</span></a>
<a class="sourceLine" id="cb199-10" data-line-number="10"><span class="co">#&gt; 3 0.0893 -0.253</span></a>
<a class="sourceLine" id="cb199-11" data-line-number="11"><span class="co">#&gt; 4 0.115  -0.237</span></a>
<a class="sourceLine" id="cb199-12" data-line-number="12"><span class="co">#&gt; 5 0.115  -0.236</span></a>
<a class="sourceLine" id="cb199-13" data-line-number="13"><span class="co">#&gt; 6 0.164  -0.204</span></a></code></pre></div>
<p>Now we can plot the regression line and the original data just like any other plot.</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb200-1" data-line-number="1"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb200-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> face, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share)) <span class="op">+</span></a>
<a class="sourceLine" id="cb200-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> grid, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> pred),</a>
<a class="sourceLine" id="cb200-4" data-line-number="4">            <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-55-1.png" width="70%" style="display: block; margin: auto;" /> This method is more complicated than the <code>geom_abline</code> method for a bivariate regression, but will work for more complicated models, while the <code>geom_abline</code> method won’t.</p>
<p>Note that <a href="http://docs.ggplot2.org/current/geom_smooth.html">geom_smooth</a> can be used to add a regression line to a data-set.</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb201-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> face, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> d.comp, <span class="dt">y =</span> diff.share)) <span class="op">+</span></a>
<a class="sourceLine" id="cb201-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb201-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-56-1.png" width="70%" style="display: block; margin: auto;" /> The argument <code>method = &quot;lm&quot;</code> specifies that the function <code>lm</code> is to be used to generate fitted values. It is equivalent to running the regression <code>lm(y ~ x)</code> and plotting the regression line, where <code>y</code> and <code>x</code> are the aesthetics specified by the mappings. The argument <code>se = FALSE</code> tells the function not to plot the confidence interval of the regression (discussed later).</p>
</section>
<section id="regression-towards-the-mean" class="level3">
<h3><span class="header-section-number">4.2.4</span> Regression towards the mean</h3>
</section>
<section id="merging-data-sets-in-r" class="level3">
<h3><span class="header-section-number">4.2.5</span> Merging Data Sets in R</h3>
<p>See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter <a href="http://r4ds.had.co.nz/relational-data.html">Relational data</a>.</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb202-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;pres12&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>To join both data frames</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb203-1" data-line-number="1"><span class="kw">full_join</span>(pres08, pres12, <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>)</a></code></pre></div>
<p>However, since there are duplicate names, <code>.x</code> and <code>.y</code> are appended.</p>
<p><strong>Challenge</strong> What would happen if <code>by = &quot;state&quot;</code> was dropped?</p>
<p>To avoid the duplicate names, or change them, you can rename before merging,</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb204-1" data-line-number="1"><span class="kw">full_join</span>(<span class="kw">select</span>(pres08, state, <span class="dt">Obama_08 =</span> Obama, <span class="dt">McCain_08 =</span> McCain,</a>
<a class="sourceLine" id="cb204-2" data-line-number="2">                 <span class="dt">EV_08 =</span> EV),</a>
<a class="sourceLine" id="cb204-3" data-line-number="3">          <span class="kw">select</span>(pres12, state, <span class="dt">Obama_12 =</span> Obama, <span class="dt">Romney_12 =</span> Romney,</a>
<a class="sourceLine" id="cb204-4" data-line-number="4">                 <span class="dt">EV_12 =</span> EV),</a>
<a class="sourceLine" id="cb204-5" data-line-number="5">          <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>)</a></code></pre></div>
<p>or use the <code>suffix</code> argument to <code>full_join</code></p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb205-1" data-line-number="1">pres &lt;-<span class="st"> </span><span class="kw">full_join</span>(pres08, pres12, <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;_08&quot;</span>, <span class="st">&quot;_12&quot;</span>))</a>
<a class="sourceLine" id="cb205-2" data-line-number="2"><span class="kw">head</span>(pres)</a>
<a class="sourceLine" id="cb205-3" data-line-number="3"><span class="co">#&gt;   state.name state Obama_08 McCain EV_08 margin Obama_12 Romney EV_12</span></a>
<a class="sourceLine" id="cb205-4" data-line-number="4"><span class="co">#&gt; 1    Alabama    AL       39     60     9    -21       38     61     9</span></a>
<a class="sourceLine" id="cb205-5" data-line-number="5"><span class="co">#&gt; 2     Alaska    AK       38     59     3    -21       41     55     3</span></a>
<a class="sourceLine" id="cb205-6" data-line-number="6"><span class="co">#&gt; 3    Arizona    AZ       45     54    10     -9       45     54    11</span></a>
<a class="sourceLine" id="cb205-7" data-line-number="7"><span class="co">#&gt; 4   Arkansas    AR       39     59     6    -20       37     61     6</span></a>
<a class="sourceLine" id="cb205-8" data-line-number="8"><span class="co">#&gt; 5 California    CA       61     37    55     24       60     37    55</span></a>
<a class="sourceLine" id="cb205-9" data-line-number="9"><span class="co">#&gt; 6   Colorado    CO       54     45     9      9       51     46     9</span></a></code></pre></div>
<p><strong>Challenge</strong> Would you consider this data tidy? How would you make it tidy?</p>
<p>The <strong>dplyr</strong> equivalent functions for <a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a> is <a href="https://www.rdocumentation.org/packages/dplyr/topics/bind_cols">bind_cols</a>.</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb206-1" data-line-number="1">pres &lt;-<span class="st"> </span>pres <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb206-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Obama2008_z =</span> <span class="kw">as.numeric</span>(<span class="kw">scale</span>(Obama_<span class="dv">08</span>)),</a>
<a class="sourceLine" id="cb206-3" data-line-number="3">         <span class="dt">Obama2012_z =</span> <span class="kw">as.numeric</span>(<span class="kw">scale</span>(Obama_<span class="dv">12</span>)))</a></code></pre></div>
<p>Likewise, <a href="https://www.rdocumentation.org/packages/dplyr/topics/bind_cols">bind_cols</a> concatenates data frames by row.</p>
<p>We need to use the <code>as.numeric</code> function because <code>scale()</code> always returns a matrix. Omitting <code>as.numeric()</code> would not produce an error in the code chunk above, since the columns of a data frame can be matrices, but it would produce errors in some of the following code if it were omitted.</p>
<p>Scatter plot of states with vote shares in 2008 and 2012</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb207-1" data-line-number="1"><span class="kw">ggplot</span>(pres, <span class="kw">aes</span>(<span class="dt">x =</span> Obama2008_z, <span class="dt">y =</span> Obama2012_z, <span class="dt">label =</span> state)) <span class="op">+</span></a>
<a class="sourceLine" id="cb207-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb207-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_text</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb207-4" data-line-number="4"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb207-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Obama&#39;s standardized vote share in 2008&quot;</span>,</a>
<a class="sourceLine" id="cb207-6" data-line-number="6">                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb207-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Obama&#39;s standardized vote share in 2012&quot;</span>,</a>
<a class="sourceLine" id="cb207-8" data-line-number="8">                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>))</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-61-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>To calculate the bottom and top quartiles</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb208-1" data-line-number="1">pres <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb208-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(Obama2008_z <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(Obama2008_z, <span class="fl">0.25</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb208-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">improve =</span> <span class="kw">mean</span>(Obama2012_z <span class="op">&gt;</span><span class="st"> </span>Obama2008_z))</a>
<a class="sourceLine" id="cb208-4" data-line-number="4"><span class="co">#&gt;   improve</span></a>
<a class="sourceLine" id="cb208-5" data-line-number="5"><span class="co">#&gt; 1   0.583</span></a>
<a class="sourceLine" id="cb208-6" data-line-number="6"></a>
<a class="sourceLine" id="cb208-7" data-line-number="7">pres <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb208-8" data-line-number="8"><span class="st">  </span><span class="kw">filter</span>(Obama2008_z <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(Obama2008_z, <span class="fl">0.75</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb208-9" data-line-number="9"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">improve =</span> <span class="kw">mean</span>(Obama2012_z <span class="op">&gt;</span><span class="st"> </span>Obama2008_z))</a>
<a class="sourceLine" id="cb208-10" data-line-number="10"><span class="co">#&gt;   improve</span></a>
<a class="sourceLine" id="cb208-11" data-line-number="11"><span class="co">#&gt; 1     0.5</span></a></code></pre></div>
<p><strong>Challenge:</strong> Why is it important to standardize the vote shares?</p>
</section>
<section id="model-fit" class="level3">
<h3><span class="header-section-number">4.2.6</span> Model Fit</h3>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb209-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;florida&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb209-2" data-line-number="2">fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(Buchanan00 <span class="op">~</span><span class="st"> </span>Perot96, <span class="dt">data =</span> florida)</a>
<a class="sourceLine" id="cb209-3" data-line-number="3">fit2</a>
<a class="sourceLine" id="cb209-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb209-5" data-line-number="5"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb209-6" data-line-number="6"><span class="co">#&gt; lm(formula = Buchanan00 ~ Perot96, data = florida)</span></a>
<a class="sourceLine" id="cb209-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb209-8" data-line-number="8"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb209-9" data-line-number="9"><span class="co">#&gt; (Intercept)      Perot96  </span></a>
<a class="sourceLine" id="cb209-10" data-line-number="10"><span class="co">#&gt;      1.3458       0.0359</span></a></code></pre></div>
<p>Extract <span class="math inline">\(R ^ 2\)</span> from the results of <code>summary</code>,</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb210-1" data-line-number="1"><span class="kw">summary</span>(fit2)<span class="op">$</span>r.squared</a>
<a class="sourceLine" id="cb210-2" data-line-number="2"><span class="co">#&gt; [1] 0.513</span></a></code></pre></div>
<p>Alternatively, can get the R squared value from the data frame <a href="https://www.rdocumentation.org/packages/broom/topics/glance.lm">glance</a> returns:</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb211-1" data-line-number="1"><span class="kw">glance</span>(fit2)</a>
<a class="sourceLine" id="cb211-2" data-line-number="2"><span class="co">#&gt;   r.squared adj.r.squared sigma statistic  p.value df logLik AIC BIC</span></a>
<a class="sourceLine" id="cb211-3" data-line-number="3"><span class="co">#&gt; 1     0.513         0.506   316      68.5 9.47e-12  2   -480 966 972</span></a>
<a class="sourceLine" id="cb211-4" data-line-number="4"><span class="co">#&gt;   deviance df.residual</span></a>
<a class="sourceLine" id="cb211-5" data-line-number="5"><span class="co">#&gt; 1  6506118          65</span></a></code></pre></div>
<p>We can add predictions and residuals to the original data frame using the <a href="https://cran.r-project.org/package=modelr">modelr</a> functions <a href="https://www.rdocumentation.org/packages/modelr/topics/add_residuals">add_residuals</a> and <a href="https://www.rdocumentation.org/packages/modelr/topics/add_predictions">add_predictions</a></p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb212-1" data-line-number="1">florida &lt;-</a>
<a class="sourceLine" id="cb212-2" data-line-number="2"><span class="st">  </span>florida <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb212-3" data-line-number="3"><span class="st">  </span><span class="kw">add_predictions</span>(fit2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb212-4" data-line-number="4"><span class="st">  </span><span class="kw">add_residuals</span>(fit2)</a>
<a class="sourceLine" id="cb212-5" data-line-number="5"><span class="kw">glimpse</span>(florida)</a>
<a class="sourceLine" id="cb212-6" data-line-number="6"><span class="co">#&gt; Observations: 67</span></a>
<a class="sourceLine" id="cb212-7" data-line-number="7"><span class="co">#&gt; Variables: 9</span></a>
<a class="sourceLine" id="cb212-8" data-line-number="8"><span class="co">#&gt; $ county     &lt;chr&gt; &quot;Alachua&quot;, &quot;Baker&quot;, &quot;Bay&quot;, &quot;Bradford&quot;, &quot;Brevard&quot;, &quot;...</span></a>
<a class="sourceLine" id="cb212-9" data-line-number="9"><span class="co">#&gt; $ Clinton96  &lt;int&gt; 40144, 2273, 17020, 3356, 80416, 320736, 1794, 2712...</span></a>
<a class="sourceLine" id="cb212-10" data-line-number="10"><span class="co">#&gt; $ Dole96     &lt;int&gt; 25303, 3684, 28290, 4038, 87980, 142834, 1717, 2783...</span></a>
<a class="sourceLine" id="cb212-11" data-line-number="11"><span class="co">#&gt; $ Perot96    &lt;int&gt; 8072, 667, 5922, 819, 25249, 38964, 630, 7783, 7244...</span></a>
<a class="sourceLine" id="cb212-12" data-line-number="12"><span class="co">#&gt; $ Bush00     &lt;int&gt; 34124, 5610, 38637, 5414, 115185, 177323, 2873, 354...</span></a>
<a class="sourceLine" id="cb212-13" data-line-number="13"><span class="co">#&gt; $ Gore00     &lt;int&gt; 47365, 2392, 18850, 3075, 97318, 386561, 2155, 2964...</span></a>
<a class="sourceLine" id="cb212-14" data-line-number="14"><span class="co">#&gt; $ Buchanan00 &lt;int&gt; 263, 73, 248, 65, 570, 788, 90, 182, 270, 186, 122,...</span></a>
<a class="sourceLine" id="cb212-15" data-line-number="15"><span class="co">#&gt; $ pred       &lt;dbl&gt; 291.3, 25.3, 214.0, 30.8, 908.2, 1400.7, 24.0, 280....</span></a>
<a class="sourceLine" id="cb212-16" data-line-number="16"><span class="co">#&gt; $ resid      &lt;dbl&gt; -2.83e+01, 4.77e+01, 3.40e+01, 3.42e+01, -3.38e+02,...</span></a></code></pre></div>
<p>There are now two new columns in <code>florida</code>, <code>pred</code> with the fitted values (predictions), and <code>resid</code> with the residuals.</p>
<p>Use <code>fit2_augment</code> to create a residual plot:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb213-1" data-line-number="1">fit2_resid_plot &lt;-</a>
<a class="sourceLine" id="cb213-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(florida, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> resid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb213-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb213-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb213-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Fitted values&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;residuals&quot;</span>)</a>
<a class="sourceLine" id="cb213-6" data-line-number="6">fit2_resid_plot</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-67-1.png" width="70%" style="display: block; margin: auto;" /> Note, we use the function <a href="https://www.rdocumentation.org/packages/modelr/topics/geom_refline">geom_refline</a> to add a reference line at 0.</p>
<p>Let’s add some labels to points, who is that outlier?</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb214-1" data-line-number="1">fit2_resid_plot <span class="op">+</span></a>
<a class="sourceLine" id="cb214-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">label =</span> county))</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-68-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The outlier county is “Palm Beach”</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb215-1" data-line-number="1"><span class="kw">arrange</span>(florida) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb215-2" data-line-number="2"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(<span class="kw">abs</span>(resid))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb215-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(county, resid) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb215-4" data-line-number="4"><span class="st">  </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb215-5" data-line-number="5"><span class="co">#&gt;       county resid</span></a>
<a class="sourceLine" id="cb215-6" data-line-number="6"><span class="co">#&gt; 1  PalmBeach  2302</span></a>
<a class="sourceLine" id="cb215-7" data-line-number="7"><span class="co">#&gt; 2    Broward  -613</span></a>
<a class="sourceLine" id="cb215-8" data-line-number="8"><span class="co">#&gt; 3        Lee  -357</span></a>
<a class="sourceLine" id="cb215-9" data-line-number="9"><span class="co">#&gt; 4    Brevard  -338</span></a>
<a class="sourceLine" id="cb215-10" data-line-number="10"><span class="co">#&gt; 5 Miami-Dade  -329</span></a>
<a class="sourceLine" id="cb215-11" data-line-number="11"><span class="co">#&gt; 6   Pinellas  -317</span></a></code></pre></div>
<p>Data without Palm Beach</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb216-1" data-line-number="1">florida_pb &lt;-<span class="st"> </span><span class="kw">filter</span>(florida, county <span class="op">!=</span><span class="st"> &quot;PalmBeach&quot;</span>)</a>
<a class="sourceLine" id="cb216-2" data-line-number="2">fit3 &lt;-<span class="st"> </span><span class="kw">lm</span>(Buchanan00 <span class="op">~</span><span class="st"> </span>Perot96, <span class="dt">data =</span> florida_pb)</a>
<a class="sourceLine" id="cb216-3" data-line-number="3">fit3</a>
<a class="sourceLine" id="cb216-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb216-5" data-line-number="5"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb216-6" data-line-number="6"><span class="co">#&gt; lm(formula = Buchanan00 ~ Perot96, data = florida_pb)</span></a>
<a class="sourceLine" id="cb216-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb216-8" data-line-number="8"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb216-9" data-line-number="9"><span class="co">#&gt; (Intercept)      Perot96  </span></a>
<a class="sourceLine" id="cb216-10" data-line-number="10"><span class="co">#&gt;     45.8419       0.0244</span></a></code></pre></div>
<p><span class="math inline">\(R^2\)</span> or coefficient of determination</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb217-1" data-line-number="1"><span class="kw">glance</span>(fit3)</a>
<a class="sourceLine" id="cb217-2" data-line-number="2"><span class="co">#&gt;   r.squared adj.r.squared sigma statistic  p.value df logLik AIC BIC</span></a>
<a class="sourceLine" id="cb217-3" data-line-number="3"><span class="co">#&gt; 1     0.851         0.849  87.7       366 3.61e-28  2   -388 782 788</span></a>
<a class="sourceLine" id="cb217-4" data-line-number="4"><span class="co">#&gt;   deviance df.residual</span></a>
<a class="sourceLine" id="cb217-5" data-line-number="5"><span class="co">#&gt; 1   492803          64</span></a></code></pre></div>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb218-1" data-line-number="1">florida_pb <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb218-2" data-line-number="2"><span class="st">  </span><span class="kw">add_residuals</span>(fit3) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb218-3" data-line-number="3"><span class="st">  </span><span class="kw">add_predictions</span>(fit3) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb218-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> resid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb218-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb218-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb218-7" data-line-number="7"><span class="st">  </span><span class="kw">ylim</span>(<span class="op">-</span><span class="dv">750</span>, <span class="dv">2500</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb218-8" data-line-number="8"><span class="st">  </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="dv">1500</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb218-9" data-line-number="9"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Fitted values&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;residuals&quot;</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-72-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Create predictions for both models using <a href="https://www.rdocumentation.org/packages/modelr/topics/data_grid">data_grid</a> and <a href="https://www.rdocumentation.org/packages/modelr/topics/gather_predictions">gather_predictions</a>:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb219-1" data-line-number="1">florida_grid &lt;-</a>
<a class="sourceLine" id="cb219-2" data-line-number="2"><span class="st">  </span>florida <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb219-3" data-line-number="3"><span class="st">  </span><span class="kw">data_grid</span>(Perot96) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb219-4" data-line-number="4"><span class="st">  </span><span class="kw">gather_predictions</span>(fit2, fit3) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb219-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span></a>
<a class="sourceLine" id="cb219-6" data-line-number="6">           <span class="kw">fct_recode</span>(model,</a>
<a class="sourceLine" id="cb219-7" data-line-number="7">                      <span class="st">&quot;Regression</span><span class="ch">\n</span><span class="st"> with Palm Beach&quot;</span> =<span class="st"> &quot;fit2&quot;</span>,</a>
<a class="sourceLine" id="cb219-8" data-line-number="8">                      <span class="st">&quot;Regression</span><span class="ch">\n</span><span class="st"> without Palm Beach&quot;</span> =<span class="st"> &quot;fit3&quot;</span>))</a></code></pre></div>
<p>Note this is an example of using non-syntactic column names in a tibble, as discussed in Chapter 10 of <a href="http://r4ds.had.co.nz/tibbles.html">R for data science</a>.</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb220-1" data-line-number="1"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb220-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> florida, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Perot96, <span class="dt">y =</span> Buchanan00)) <span class="op">+</span></a>
<a class="sourceLine" id="cb220-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> florida_grid,</a>
<a class="sourceLine" id="cb220-4" data-line-number="4">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Perot96, <span class="dt">y =</span> pred,</a>
<a class="sourceLine" id="cb220-5" data-line-number="5">                           <span class="dt">colour =</span> model)) <span class="op">+</span></a>
<a class="sourceLine" id="cb220-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_label</span>(<span class="dt">data =</span> <span class="kw">filter</span>(florida, county <span class="op">==</span><span class="st"> &quot;PalmBeach&quot;</span>),</a>
<a class="sourceLine" id="cb220-7" data-line-number="7">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Perot96, <span class="dt">y =</span> Buchanan00, <span class="dt">label =</span> county),</a>
<a class="sourceLine" id="cb220-8" data-line-number="8">                           <span class="dt">vjust =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">hjust =</span> <span class="st">&quot;right&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb220-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> <span class="kw">tibble</span>(<span class="dt">label =</span> <span class="kw">unique</span>(florida_grid<span class="op">$</span>model),</a>
<a class="sourceLine" id="cb220-10" data-line-number="10">                           <span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">20000</span>, <span class="dv">31000</span>),</a>
<a class="sourceLine" id="cb220-11" data-line-number="11">                           <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">300</span>)),</a>
<a class="sourceLine" id="cb220-12" data-line-number="12">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> label, <span class="dt">colour =</span> label)) <span class="op">+</span></a>
<a class="sourceLine" id="cb220-13" data-line-number="13"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Perot&#39;s Vote in 1996&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Buchanan&#39;s Votes in 1996&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb220-14" data-line-number="14"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-74-1.png" width="70%" style="display: block; margin: auto;" /> See <a href="http://r4ds.had.co.nz/graphics-for-communication.html#label">Graphics for communication</a> in <em>R for Data Science</em> on labels and annotations in plots.</p>
</section>
</section>
<section id="regression-and-causation" class="level2">
<h2><span class="header-section-number">4.3</span> Regression and Causation</h2>
<section id="randomized-experiments" class="level3">
<h3><span class="header-section-number">4.3.1</span> Randomized Experiments</h3>
<p>Load data</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb221-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;women&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>Proportion of female politicians in reserved GP vs. unreserved GP</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb222-1" data-line-number="1">women <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb222-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(reserved) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb222-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prop_female =</span> <span class="kw">mean</span>(female))</a>
<a class="sourceLine" id="cb222-4" data-line-number="4"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb222-5" data-line-number="5"><span class="co">#&gt;   reserved prop_female</span></a>
<a class="sourceLine" id="cb222-6" data-line-number="6"><span class="co">#&gt;      &lt;int&gt;       &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb222-7" data-line-number="7"><span class="co">#&gt; 1        0      0.0748</span></a>
<a class="sourceLine" id="cb222-8" data-line-number="8"><span class="co">#&gt; 2        1      1.00</span></a></code></pre></div>
<p>The diff in means estimator:</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb223-1" data-line-number="1"><span class="co"># drinking water facilities</span></a>
<a class="sourceLine" id="cb223-2" data-line-number="2"></a>
<a class="sourceLine" id="cb223-3" data-line-number="3"><span class="co"># irrigation facilities</span></a>
<a class="sourceLine" id="cb223-4" data-line-number="4"><span class="kw">mean</span>(women<span class="op">$</span>irrigation[women<span class="op">$</span>reserved <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]) <span class="op">-</span></a>
<a class="sourceLine" id="cb223-5" data-line-number="5"><span class="st">    </span><span class="kw">mean</span>(women<span class="op">$</span>irrigation[women<span class="op">$</span>reserved <span class="op">==</span><span class="st"> </span><span class="dv">0</span>])</a>
<a class="sourceLine" id="cb223-6" data-line-number="6"><span class="co">#&gt; [1] -0.369</span></a></code></pre></div>
<p>Mean values of <code>irrigation</code> and <code>water</code> in reserved and non-reserved districts.</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb224-1" data-line-number="1">women <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb224-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(reserved) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb224-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">irrigation =</span> <span class="kw">mean</span>(irrigation),</a>
<a class="sourceLine" id="cb224-4" data-line-number="4">            <span class="dt">water =</span> <span class="kw">mean</span>(water))</a>
<a class="sourceLine" id="cb224-5" data-line-number="5"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb224-6" data-line-number="6"><span class="co">#&gt;   reserved irrigation water</span></a>
<a class="sourceLine" id="cb224-7" data-line-number="7"><span class="co">#&gt;      &lt;int&gt;      &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb224-8" data-line-number="8"><span class="co">#&gt; 1        0       3.39  14.7</span></a>
<a class="sourceLine" id="cb224-9" data-line-number="9"><span class="co">#&gt; 2        1       3.02  24.0</span></a></code></pre></div>
<p>The difference between the two groups can be calculated with the function <a href="https://www.rdocumentation.org/packages/base/topics/diff">diff</a>, which calculates the difference between subsequent observations. This works as long as we are careful about which group is first or second.</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb225-1" data-line-number="1">women <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(reserved) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">irrigation =</span> <span class="kw">mean</span>(irrigation),</a>
<a class="sourceLine" id="cb225-4" data-line-number="4">            <span class="dt">water =</span> <span class="kw">mean</span>(water)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">diff_irrigation =</span> <span class="kw">diff</span>(irrigation),</a>
<a class="sourceLine" id="cb225-6" data-line-number="6">            <span class="dt">diff_water =</span> <span class="kw">diff</span>(water))</a>
<a class="sourceLine" id="cb225-7" data-line-number="7"><span class="co">#&gt; # A tibble: 1 x 2</span></a>
<a class="sourceLine" id="cb225-8" data-line-number="8"><span class="co">#&gt;   diff_irrigation diff_water</span></a>
<a class="sourceLine" id="cb225-9" data-line-number="9"><span class="co">#&gt;             &lt;dbl&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb225-10" data-line-number="10"><span class="co">#&gt; 1          -0.369       9.25</span></a></code></pre></div>
<p>The other way uses <strong>tidyr</strong> <a href="https://www.rdocumentation.org/packages/tidyr/topics/spread.lm">spread</a> and <a href="https://www.rdocumentation.org/packages/tidyr/topics/gather.lm">gather</a>,</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb226-1" data-line-number="1">women <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb226-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(reserved) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb226-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">irrigation =</span> <span class="kw">mean</span>(irrigation),</a>
<a class="sourceLine" id="cb226-4" data-line-number="4">            <span class="dt">water =</span> <span class="kw">mean</span>(water)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb226-5" data-line-number="5"><span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>reserved) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb226-6" data-line-number="6"><span class="st">  </span><span class="kw">spread</span>(reserved, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb226-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> <span class="st">`</span><span class="dt">1</span><span class="st">`</span> <span class="op">-</span><span class="st"> `</span><span class="dt">0</span><span class="st">`</span>)</a>
<a class="sourceLine" id="cb226-8" data-line-number="8"><span class="co">#&gt; # A tibble: 2 x 4</span></a>
<a class="sourceLine" id="cb226-9" data-line-number="9"><span class="co">#&gt;   variable     `0`   `1`   diff</span></a>
<a class="sourceLine" id="cb226-10" data-line-number="10"><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb226-11" data-line-number="11"><span class="co">#&gt; 1 irrigation  3.39  3.02 -0.369</span></a>
<a class="sourceLine" id="cb226-12" data-line-number="12"><span class="co">#&gt; 2 water      14.7  24.0   9.25</span></a></code></pre></div>
<p>Now each row is an outcome variable of interest, and there are columns for the treatment (<code>1</code>) and control (<code>0</code>) groups, and the difference (<code>diff</code>).</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb227-1" data-line-number="1"><span class="kw">lm</span>(water <span class="op">~</span><span class="st"> </span>reserved, <span class="dt">data =</span> women)</a>
<a class="sourceLine" id="cb227-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb227-3" data-line-number="3"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb227-4" data-line-number="4"><span class="co">#&gt; lm(formula = water ~ reserved, data = women)</span></a>
<a class="sourceLine" id="cb227-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb227-6" data-line-number="6"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb227-7" data-line-number="7"><span class="co">#&gt; (Intercept)     reserved  </span></a>
<a class="sourceLine" id="cb227-8" data-line-number="8"><span class="co">#&gt;       14.74         9.25</span></a></code></pre></div>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb228-1" data-line-number="1"><span class="kw">lm</span>(irrigation <span class="op">~</span><span class="st"> </span>reserved, <span class="dt">data =</span> women)</a>
<a class="sourceLine" id="cb228-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb228-3" data-line-number="3"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb228-4" data-line-number="4"><span class="co">#&gt; lm(formula = irrigation ~ reserved, data = women)</span></a>
<a class="sourceLine" id="cb228-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb228-6" data-line-number="6"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb228-7" data-line-number="7"><span class="co">#&gt; (Intercept)     reserved  </span></a>
<a class="sourceLine" id="cb228-8" data-line-number="8"><span class="co">#&gt;       3.388       -0.369</span></a></code></pre></div>
</section>
<section id="regression-with-multiple-predictors" class="level3">
<h3><span class="header-section-number">4.3.2</span> Regression with multiple predictors</h3>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb229-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;social&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb229-2" data-line-number="2"><span class="kw">glimpse</span>(social)</a>
<a class="sourceLine" id="cb229-3" data-line-number="3"><span class="co">#&gt; Observations: 305,866</span></a>
<a class="sourceLine" id="cb229-4" data-line-number="4"><span class="co">#&gt; Variables: 6</span></a>
<a class="sourceLine" id="cb229-5" data-line-number="5"><span class="co">#&gt; $ sex         &lt;chr&gt; &quot;male&quot;, &quot;female&quot;, &quot;male&quot;, &quot;female&quot;, &quot;female&quot;, &quot;mal...</span></a>
<a class="sourceLine" id="cb229-6" data-line-number="6"><span class="co">#&gt; $ yearofbirth &lt;int&gt; 1941, 1947, 1951, 1950, 1982, 1981, 1959, 1956, 19...</span></a>
<a class="sourceLine" id="cb229-7" data-line-number="7"><span class="co">#&gt; $ primary2004 &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0,...</span></a>
<a class="sourceLine" id="cb229-8" data-line-number="8"><span class="co">#&gt; $ messages    &lt;chr&gt; &quot;Civic Duty&quot;, &quot;Civic Duty&quot;, &quot;Hawthorne&quot;, &quot;Hawthorn...</span></a>
<a class="sourceLine" id="cb229-9" data-line-number="9"><span class="co">#&gt; $ primary2006 &lt;int&gt; 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1,...</span></a>
<a class="sourceLine" id="cb229-10" data-line-number="10"><span class="co">#&gt; $ hhsize      &lt;int&gt; 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, 1, 2, 2, 1, 2, 2, 1,...</span></a>
<a class="sourceLine" id="cb229-11" data-line-number="11"><span class="kw">levels</span>(social<span class="op">$</span>messages)</a>
<a class="sourceLine" id="cb229-12" data-line-number="12"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb229-13" data-line-number="13">fit &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>messages, <span class="dt">data =</span> social)</a>
<a class="sourceLine" id="cb229-14" data-line-number="14">fit</a>
<a class="sourceLine" id="cb229-15" data-line-number="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb229-16" data-line-number="16"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb229-17" data-line-number="17"><span class="co">#&gt; lm(formula = primary2006 ~ messages, data = social)</span></a>
<a class="sourceLine" id="cb229-18" data-line-number="18"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb229-19" data-line-number="19"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb229-20" data-line-number="20"><span class="co">#&gt;       (Intercept)    messagesControl  messagesHawthorne  </span></a>
<a class="sourceLine" id="cb229-21" data-line-number="21"><span class="co">#&gt;           0.31454           -0.01790            0.00784  </span></a>
<a class="sourceLine" id="cb229-22" data-line-number="22"><span class="co">#&gt; messagesNeighbors  </span></a>
<a class="sourceLine" id="cb229-23" data-line-number="23"><span class="co">#&gt;           0.06341</span></a></code></pre></div>
<p>Create indicator variables for each message:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb230-1" data-line-number="1">social &lt;-</a>
<a class="sourceLine" id="cb230-2" data-line-number="2"><span class="st">  </span>social <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb230-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Control =</span> <span class="kw">as.integer</span>(messages <span class="op">==</span><span class="st"> &quot;Control&quot;</span>),</a>
<a class="sourceLine" id="cb230-4" data-line-number="4">         <span class="dt">Hawthorne =</span> <span class="kw">as.integer</span>(messages <span class="op">==</span><span class="st"> &quot;Hawthorne&quot;</span>),</a>
<a class="sourceLine" id="cb230-5" data-line-number="5">         <span class="dt">Neighbors =</span> <span class="kw">as.integer</span>(messages <span class="op">==</span><span class="st"> &quot;Neighbors&quot;</span>))</a></code></pre></div>
<p>alternatively, create these using a for loop. This is easier to understand and less prone to typos:</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb231-1" data-line-number="1"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">unique</span>(social<span class="op">$</span>messages)) {</a>
<a class="sourceLine" id="cb231-2" data-line-number="2">  social[[i]] &lt;-<span class="st"> </span><span class="kw">as.integer</span>(social[[<span class="st">&quot;messages&quot;</span>]] <span class="op">==</span><span class="st"> </span>i)</a>
<a class="sourceLine" id="cb231-3" data-line-number="3">}</a></code></pre></div>
<p>We created a variable for each level of <code>messages</code> even though we will exclude one of them.</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb232-1" data-line-number="1"><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>Control <span class="op">+</span><span class="st"> </span>Hawthorne <span class="op">+</span><span class="st"> </span>Neighbors, <span class="dt">data =</span> social)</a>
<a class="sourceLine" id="cb232-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb232-3" data-line-number="3"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb232-4" data-line-number="4"><span class="co">#&gt; lm(formula = primary2006 ~ Control + Hawthorne + Neighbors, data = social)</span></a>
<a class="sourceLine" id="cb232-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb232-6" data-line-number="6"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb232-7" data-line-number="7"><span class="co">#&gt; (Intercept)      Control    Hawthorne    Neighbors  </span></a>
<a class="sourceLine" id="cb232-8" data-line-number="8"><span class="co">#&gt;     0.31454     -0.01790      0.00784      0.06341</span></a></code></pre></div>
<p>Create predictions for each unique value of <code>messages</code></p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb233-1" data-line-number="1">unique_messages &lt;-</a>
<a class="sourceLine" id="cb233-2" data-line-number="2"><span class="st">  </span><span class="kw">data_grid</span>(social, messages) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb233-3" data-line-number="3"><span class="st">  </span><span class="kw">add_predictions</span>(fit)</a>
<a class="sourceLine" id="cb233-4" data-line-number="4">unique_messages</a>
<a class="sourceLine" id="cb233-5" data-line-number="5"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb233-6" data-line-number="6"><span class="co">#&gt;   messages    pred</span></a>
<a class="sourceLine" id="cb233-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb233-8" data-line-number="8"><span class="co">#&gt; 1 Civic Duty 0.315</span></a>
<a class="sourceLine" id="cb233-9" data-line-number="9"><span class="co">#&gt; 2 Control    0.297</span></a>
<a class="sourceLine" id="cb233-10" data-line-number="10"><span class="co">#&gt; 3 Hawthorne  0.322</span></a>
<a class="sourceLine" id="cb233-11" data-line-number="11"><span class="co">#&gt; 4 Neighbors  0.378</span></a></code></pre></div>
<p>Compare to the sample averages</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb234-1" data-line-number="1">social <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb234-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(messages) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb234-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(primary2006))</a>
<a class="sourceLine" id="cb234-4" data-line-number="4"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb234-5" data-line-number="5"><span class="co">#&gt;   messages   `mean(primary2006)`</span></a>
<a class="sourceLine" id="cb234-6" data-line-number="6"><span class="co">#&gt;   &lt;chr&gt;                    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb234-7" data-line-number="7"><span class="co">#&gt; 1 Civic Duty               0.315</span></a>
<a class="sourceLine" id="cb234-8" data-line-number="8"><span class="co">#&gt; 2 Control                  0.297</span></a>
<a class="sourceLine" id="cb234-9" data-line-number="9"><span class="co">#&gt; 3 Hawthorne                0.322</span></a>
<a class="sourceLine" id="cb234-10" data-line-number="10"><span class="co">#&gt; 4 Neighbors                0.378</span></a></code></pre></div>
<p>Linear regression without intercept.</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb235-1" data-line-number="1">fit.noint &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span>messages, <span class="dt">data =</span> social)</a>
<a class="sourceLine" id="cb235-2" data-line-number="2">fit.noint</a>
<a class="sourceLine" id="cb235-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb235-4" data-line-number="4"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb235-5" data-line-number="5"><span class="co">#&gt; lm(formula = primary2006 ~ -1 + messages, data = social)</span></a>
<a class="sourceLine" id="cb235-6" data-line-number="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb235-7" data-line-number="7"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb235-8" data-line-number="8"><span class="co">#&gt; messagesCivic Duty     messagesControl   messagesHawthorne  </span></a>
<a class="sourceLine" id="cb235-9" data-line-number="9"><span class="co">#&gt;              0.315               0.297               0.322  </span></a>
<a class="sourceLine" id="cb235-10" data-line-number="10"><span class="co">#&gt;  messagesNeighbors  </span></a>
<a class="sourceLine" id="cb235-11" data-line-number="11"><span class="co">#&gt;              0.378</span></a></code></pre></div>
<p>Calculating the regression average effect is also easier if we make the control group the first level so all regression coefficients are comparisons to it. Use <a href="https://www.rdocumentation.org/packages/forcats/topics/fct_relevel">fct_relevel</a> to make “Control”</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb236-1" data-line-number="1">fit.control &lt;-</a>
<a class="sourceLine" id="cb236-2" data-line-number="2"><span class="st"> </span><span class="kw">mutate</span>(social, <span class="dt">messages =</span> <span class="kw">fct_relevel</span>(messages, <span class="st">&quot;Control&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb236-3" data-line-number="3"><span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>messages, <span class="dt">data =</span> .)</a>
<a class="sourceLine" id="cb236-4" data-line-number="4">fit.control</a>
<a class="sourceLine" id="cb236-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb236-6" data-line-number="6"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb236-7" data-line-number="7"><span class="co">#&gt; lm(formula = primary2006 ~ messages, data = .)</span></a>
<a class="sourceLine" id="cb236-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb236-9" data-line-number="9"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb236-10" data-line-number="10"><span class="co">#&gt;        (Intercept)  messagesCivic Duty   messagesHawthorne  </span></a>
<a class="sourceLine" id="cb236-11" data-line-number="11"><span class="co">#&gt;             0.2966              0.0179              0.0257  </span></a>
<a class="sourceLine" id="cb236-12" data-line-number="12"><span class="co">#&gt;  messagesNeighbors  </span></a>
<a class="sourceLine" id="cb236-13" data-line-number="13"><span class="co">#&gt;             0.0813</span></a></code></pre></div>
<p>Difference in means</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb237-1" data-line-number="1">social <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb237-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(messages) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb237-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">primary2006 =</span> <span class="kw">mean</span>(primary2006)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb237-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Control =</span> primary2006[messages <span class="op">==</span><span class="st"> &quot;Control&quot;</span>],</a>
<a class="sourceLine" id="cb237-5" data-line-number="5">         <span class="dt">diff =</span> primary2006 <span class="op">-</span><span class="st"> </span>Control)</a>
<a class="sourceLine" id="cb237-6" data-line-number="6"><span class="co">#&gt; # A tibble: 4 x 4</span></a>
<a class="sourceLine" id="cb237-7" data-line-number="7"><span class="co">#&gt;   messages   primary2006 Control   diff</span></a>
<a class="sourceLine" id="cb237-8" data-line-number="8"><span class="co">#&gt;   &lt;chr&gt;            &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb237-9" data-line-number="9"><span class="co">#&gt; 1 Civic Duty       0.315   0.297 0.0179</span></a>
<a class="sourceLine" id="cb237-10" data-line-number="10"><span class="co">#&gt; 2 Control          0.297   0.297 0     </span></a>
<a class="sourceLine" id="cb237-11" data-line-number="11"><span class="co">#&gt; 3 Hawthorne        0.322   0.297 0.0257</span></a>
<a class="sourceLine" id="cb237-12" data-line-number="12"><span class="co">#&gt; 4 Neighbors        0.378   0.297 0.0813</span></a></code></pre></div>
<p>Adjusted R-squared is included in the output of <code>broom::glance()</code></p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb238-1" data-line-number="1"><span class="kw">glance</span>(fit)</a>
<a class="sourceLine" id="cb238-2" data-line-number="2"><span class="co">#&gt;   r.squared adj.r.squared sigma statistic   p.value df  logLik    AIC</span></a>
<a class="sourceLine" id="cb238-3" data-line-number="3"><span class="co">#&gt; 1   0.00328       0.00327 0.463       336 1.06e-217  4 -198247 396504</span></a>
<a class="sourceLine" id="cb238-4" data-line-number="4"><span class="co">#&gt;      BIC deviance df.residual</span></a>
<a class="sourceLine" id="cb238-5" data-line-number="5"><span class="co">#&gt; 1 396557    65468      305862</span></a>
<a class="sourceLine" id="cb238-6" data-line-number="6"><span class="kw">glance</span>(fit)[[<span class="st">&quot;adj.r.squared&quot;</span>]]</a>
<a class="sourceLine" id="cb238-7" data-line-number="7"><span class="co">#&gt; [1] 0.00327</span></a></code></pre></div>
</section>
<section id="heterogeneous-treatment-effects" class="level3">
<h3><span class="header-section-number">4.3.3</span> Heterogeneous Treatment Effects</h3>
<p>Average treatment effect (ate) among those who voted in 2004 primary</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb239-1" data-line-number="1">ate &lt;-</a>
<a class="sourceLine" id="cb239-2" data-line-number="2"><span class="st">  </span>social <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb239-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(primary2004, messages) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb239-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">primary2006 =</span> <span class="kw">mean</span>(primary2006)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb239-5" data-line-number="5"><span class="st">  </span><span class="kw">spread</span>(messages, primary2006) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb239-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ate_Neighbors =</span> Neighbors <span class="op">-</span><span class="st"> </span>Control) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb239-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(primary2004, Neighbors, Control, ate_Neighbors)</a>
<a class="sourceLine" id="cb239-8" data-line-number="8">ate</a>
<a class="sourceLine" id="cb239-9" data-line-number="9"><span class="co">#&gt; # A tibble: 2 x 4</span></a>
<a class="sourceLine" id="cb239-10" data-line-number="10"><span class="co">#&gt; # Groups: primary2004 [2]</span></a>
<a class="sourceLine" id="cb239-11" data-line-number="11"><span class="co">#&gt;   primary2004 Neighbors Control ate_Neighbors</span></a>
<a class="sourceLine" id="cb239-12" data-line-number="12"><span class="co">#&gt;         &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt;         &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb239-13" data-line-number="13"><span class="co">#&gt; 1           0     0.306   0.237        0.0693</span></a>
<a class="sourceLine" id="cb239-14" data-line-number="14"><span class="co">#&gt; 2           1     0.482   0.386        0.0965</span></a></code></pre></div>
<p>Difference in ATE in 2004 voters and non-voters</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb240-1" data-line-number="1"><span class="kw">diff</span>(ate<span class="op">$</span>ate_Neighbors)</a>
<a class="sourceLine" id="cb240-2" data-line-number="2"><span class="co">#&gt; [1] 0.0272</span></a></code></pre></div>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb241-1" data-line-number="1">social.neighbor &lt;-<span class="st"> </span>social <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb241-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>( (messages <span class="op">==</span><span class="st"> &quot;Control&quot;</span>) <span class="op">|</span><span class="st"> </span>(messages <span class="op">==</span><span class="st"> &quot;Neighbors&quot;</span>))</a>
<a class="sourceLine" id="cb241-3" data-line-number="3"></a>
<a class="sourceLine" id="cb241-4" data-line-number="4">fit.int &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>primary2004 <span class="op">+</span><span class="st"> </span>messages <span class="op">+</span><span class="st"> </span>primary2004<span class="op">:</span>messages,</a>
<a class="sourceLine" id="cb241-5" data-line-number="5">              <span class="dt">data =</span> social.neighbor)</a>
<a class="sourceLine" id="cb241-6" data-line-number="6">fit.int</a>
<a class="sourceLine" id="cb241-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb241-8" data-line-number="8"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb241-9" data-line-number="9"><span class="co">#&gt; lm(formula = primary2006 ~ primary2004 + messages + primary2004:messages, </span></a>
<a class="sourceLine" id="cb241-10" data-line-number="10"><span class="co">#&gt;     data = social.neighbor)</span></a>
<a class="sourceLine" id="cb241-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb241-12" data-line-number="12"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb241-13" data-line-number="13"><span class="co">#&gt;                   (Intercept)                    primary2004  </span></a>
<a class="sourceLine" id="cb241-14" data-line-number="14"><span class="co">#&gt;                        0.2371                         0.1487  </span></a>
<a class="sourceLine" id="cb241-15" data-line-number="15"><span class="co">#&gt;             messagesNeighbors  primary2004:messagesNeighbors  </span></a>
<a class="sourceLine" id="cb241-16" data-line-number="16"><span class="co">#&gt;                        0.0693                         0.0272</span></a></code></pre></div>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb242-1" data-line-number="1"><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>primary2004 <span class="op">*</span><span class="st"> </span>messages, <span class="dt">data =</span> social.neighbor)</a>
<a class="sourceLine" id="cb242-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb242-3" data-line-number="3"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb242-4" data-line-number="4"><span class="co">#&gt; lm(formula = primary2006 ~ primary2004 * messages, data = social.neighbor)</span></a>
<a class="sourceLine" id="cb242-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb242-6" data-line-number="6"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb242-7" data-line-number="7"><span class="co">#&gt;                   (Intercept)                    primary2004  </span></a>
<a class="sourceLine" id="cb242-8" data-line-number="8"><span class="co">#&gt;                        0.2371                         0.1487  </span></a>
<a class="sourceLine" id="cb242-9" data-line-number="9"><span class="co">#&gt;             messagesNeighbors  primary2004:messagesNeighbors  </span></a>
<a class="sourceLine" id="cb242-10" data-line-number="10"><span class="co">#&gt;                        0.0693                         0.0272</span></a></code></pre></div>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb243-1" data-line-number="1">social.neighbor &lt;-</a>
<a class="sourceLine" id="cb243-2" data-line-number="2"><span class="st">  </span>social.neighbor <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb243-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> <span class="dv">2008</span> <span class="op">-</span><span class="st"> </span>yearofbirth)</a>
<a class="sourceLine" id="cb243-4" data-line-number="4"></a>
<a class="sourceLine" id="cb243-5" data-line-number="5"><span class="kw">summary</span>(social.neighbor<span class="op">$</span>age)</a>
<a class="sourceLine" id="cb243-6" data-line-number="6"><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></a>
<a class="sourceLine" id="cb243-7" data-line-number="7"><span class="co">#&gt;    22.0    43.0    52.0    51.8    61.0   108.0</span></a>
<a class="sourceLine" id="cb243-8" data-line-number="8"></a>
<a class="sourceLine" id="cb243-9" data-line-number="9">fit.age &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span>age <span class="op">*</span><span class="st"> </span>messages, <span class="dt">data =</span> social.neighbor)</a>
<a class="sourceLine" id="cb243-10" data-line-number="10">fit.age</a>
<a class="sourceLine" id="cb243-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb243-12" data-line-number="12"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb243-13" data-line-number="13"><span class="co">#&gt; lm(formula = primary2006 ~ age * messages, data = social.neighbor)</span></a>
<a class="sourceLine" id="cb243-14" data-line-number="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb243-15" data-line-number="15"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb243-16" data-line-number="16"><span class="co">#&gt;           (Intercept)                    age      messagesNeighbors  </span></a>
<a class="sourceLine" id="cb243-17" data-line-number="17"><span class="co">#&gt;              0.089477               0.003998               0.048573  </span></a>
<a class="sourceLine" id="cb243-18" data-line-number="18"><span class="co">#&gt; age:messagesNeighbors  </span></a>
<a class="sourceLine" id="cb243-19" data-line-number="19"><span class="co">#&gt;              0.000628</span></a></code></pre></div>
<p>Calculate average treatment effects</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb244-1" data-line-number="1">ate.age &lt;-</a>
<a class="sourceLine" id="cb244-2" data-line-number="2"><span class="st">  </span><span class="kw">crossing</span>(<span class="dt">age =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">25</span>, <span class="dt">to =</span> <span class="dv">85</span>, <span class="dt">by =</span> <span class="dv">20</span>),</a>
<a class="sourceLine" id="cb244-3" data-line-number="3">         <span class="dt">messages =</span> <span class="kw">c</span>(<span class="st">&quot;Neighbors&quot;</span>, <span class="st">&quot;Control&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb244-4" data-line-number="4"><span class="st">  </span><span class="kw">add_predictions</span>(fit.age) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb244-5" data-line-number="5"><span class="st">  </span><span class="kw">spread</span>(messages, pred) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb244-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> Neighbors <span class="op">-</span><span class="st"> </span>Control)</a>
<a class="sourceLine" id="cb244-7" data-line-number="7">ate.age</a>
<a class="sourceLine" id="cb244-8" data-line-number="8"><span class="co">#&gt; # A tibble: 4 x 4</span></a>
<a class="sourceLine" id="cb244-9" data-line-number="9"><span class="co">#&gt;     age Control Neighbors   diff</span></a>
<a class="sourceLine" id="cb244-10" data-line-number="10"><span class="co">#&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb244-11" data-line-number="11"><span class="co">#&gt; 1  25.0   0.189     0.254 0.0643</span></a>
<a class="sourceLine" id="cb244-12" data-line-number="12"><span class="co">#&gt; 2  45.0   0.269     0.346 0.0768</span></a>
<a class="sourceLine" id="cb244-13" data-line-number="13"><span class="co">#&gt; 3  65.0   0.349     0.439 0.0894</span></a>
<a class="sourceLine" id="cb244-14" data-line-number="14"><span class="co">#&gt; 4  85.0   0.429     0.531 0.102</span></a></code></pre></div>
<p>You can use <a href="https://www.rdocumentation.org/packages/base/topics/poly">poly</a> function to calculate polynomials instead of adding each term, <code>age + I(age ^ 2)</code>. Though note that the coefficients will be be different since by default <code>poly</code> calculates orthogonal polynomials instead of the natural (raw) polynomials. However, you really shouldn’t interpret the coefficients directly anyways, so this should matter.</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb245-1" data-line-number="1">fit.age2 &lt;-<span class="st"> </span><span class="kw">lm</span>(primary2006 <span class="op">~</span><span class="st"> </span><span class="kw">poly</span>(age, <span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>messages,</a>
<a class="sourceLine" id="cb245-2" data-line-number="2">               <span class="dt">data =</span> social.neighbor)</a>
<a class="sourceLine" id="cb245-3" data-line-number="3">fit.age2</a>
<a class="sourceLine" id="cb245-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb245-5" data-line-number="5"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb245-6" data-line-number="6"><span class="co">#&gt; lm(formula = primary2006 ~ poly(age, 2) * messages, data = social.neighbor)</span></a>
<a class="sourceLine" id="cb245-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb245-8" data-line-number="8"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb245-9" data-line-number="9"><span class="co">#&gt;                     (Intercept)                    poly(age, 2)1  </span></a>
<a class="sourceLine" id="cb245-10" data-line-number="10"><span class="co">#&gt;                          0.2966                          27.6665  </span></a>
<a class="sourceLine" id="cb245-11" data-line-number="11"><span class="co">#&gt;                   poly(age, 2)2                messagesNeighbors  </span></a>
<a class="sourceLine" id="cb245-12" data-line-number="12"><span class="co">#&gt;                        -10.2832                           0.0816  </span></a>
<a class="sourceLine" id="cb245-13" data-line-number="13"><span class="co">#&gt; poly(age, 2)1:messagesNeighbors  poly(age, 2)2:messagesNeighbors  </span></a>
<a class="sourceLine" id="cb245-14" data-line-number="14"><span class="co">#&gt;                          4.5820                          -5.5124</span></a></code></pre></div>
<p>Create a data frame of combinations of ages and messages using <a href="https://www.rdocumentation.org/packages/modelr/topics/data_grid">data_grid</a>, which means that we only need to specify the variables, and not the specific values,</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb246-1" data-line-number="1">y.hat &lt;-</a>
<a class="sourceLine" id="cb246-2" data-line-number="2"><span class="st">  </span><span class="kw">data_grid</span>(social.neighbor, age, messages) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb246-3" data-line-number="3"><span class="st">  </span><span class="kw">add_predictions</span>(fit.age2)</a></code></pre></div>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb247-1" data-line-number="1"><span class="kw">ggplot</span>(y.hat, <span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> pred,</a>
<a class="sourceLine" id="cb247-2" data-line-number="2">                  <span class="dt">colour =</span> <span class="kw">str_c</span>(messages, <span class="st">&quot; condition&quot;</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb247-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb247-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">colour =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Predicted turnout rates&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb247-5" data-line-number="5"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-101-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb248-1" data-line-number="1">y.hat <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb248-2" data-line-number="2"><span class="st">  </span><span class="kw">spread</span>(messages, pred) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb248-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ate =</span> Neighbors <span class="op">-</span><span class="st"> </span>Control) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb248-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(age <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>, age <span class="op">&lt;</span><span class="st"> </span><span class="dv">90</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb248-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> ate)) <span class="op">+</span></a>
<a class="sourceLine" id="cb248-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb248-7" data-line-number="7"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Estimated average treatment effect&quot;</span>,</a>
<a class="sourceLine" id="cb248-8" data-line-number="8">       <span class="dt">x =</span> <span class="st">&quot;Age&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb248-9" data-line-number="9"><span class="st">  </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.1</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-102-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="regression-discontinuity-design" class="level3">
<h3><span class="header-section-number">4.3.4</span> Regression Discontinuity Design</h3>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb249-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;MPs&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb249-2" data-line-number="2"></a>
<a class="sourceLine" id="cb249-3" data-line-number="3">MPs_labour &lt;-<span class="st"> </span><span class="kw">filter</span>(MPs, party <span class="op">==</span><span class="st"> &quot;labour&quot;</span>)</a>
<a class="sourceLine" id="cb249-4" data-line-number="4">MPs_tory &lt;-<span class="st"> </span><span class="kw">filter</span>(MPs, party <span class="op">==</span><span class="st"> &quot;tory&quot;</span>)</a>
<a class="sourceLine" id="cb249-5" data-line-number="5"></a>
<a class="sourceLine" id="cb249-6" data-line-number="6">labour_fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin,</a>
<a class="sourceLine" id="cb249-7" data-line-number="7">                 <span class="dt">data =</span> <span class="kw">filter</span>(MPs_labour, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb249-8" data-line-number="8">labour_fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin, MPs_labour, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb249-9" data-line-number="9"></a>
<a class="sourceLine" id="cb249-10" data-line-number="10">tory_fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin,</a>
<a class="sourceLine" id="cb249-11" data-line-number="11">                <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb249-12" data-line-number="12">tory_fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</a></code></pre></div>
<p>Use to generate a grid for predictions.</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb250-1" data-line-number="1">y1_labour &lt;-</a>
<a class="sourceLine" id="cb250-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(MPs_labour, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb250-3" data-line-number="3"><span class="st">  </span><span class="kw">data_grid</span>(margin) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb250-4" data-line-number="4"><span class="st">  </span><span class="kw">add_predictions</span>(labour_fit1)</a>
<a class="sourceLine" id="cb250-5" data-line-number="5">y2_labour &lt;-</a>
<a class="sourceLine" id="cb250-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(MPs_labour, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb250-7" data-line-number="7"><span class="st">  </span><span class="kw">data_grid</span>(margin) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb250-8" data-line-number="8"><span class="st">  </span><span class="kw">add_predictions</span>(labour_fit2)</a>
<a class="sourceLine" id="cb250-9" data-line-number="9"></a>
<a class="sourceLine" id="cb250-10" data-line-number="10">y1_tory &lt;-</a>
<a class="sourceLine" id="cb250-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(MPs_tory, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb250-12" data-line-number="12"><span class="st">  </span><span class="kw">data_grid</span>(margin) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb250-13" data-line-number="13"><span class="st">  </span><span class="kw">add_predictions</span>(tory_fit1)</a>
<a class="sourceLine" id="cb250-14" data-line-number="14"></a>
<a class="sourceLine" id="cb250-15" data-line-number="15">y2_tory &lt;-</a>
<a class="sourceLine" id="cb250-16" data-line-number="16"><span class="st">  </span><span class="kw">filter</span>(MPs_tory, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb250-17" data-line-number="17"><span class="st">  </span><span class="kw">data_grid</span>(margin) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb250-18" data-line-number="18"><span class="st">  </span><span class="kw">add_predictions</span>(tory_fit2)</a></code></pre></div>
<p>Tory politicians</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb251-1" data-line-number="1"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb251-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb251-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> MPs_tory,</a>
<a class="sourceLine" id="cb251-4" data-line-number="4">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> ln.net)) <span class="op">+</span></a>
<a class="sourceLine" id="cb251-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> y1_tory,</a>
<a class="sourceLine" id="cb251-6" data-line-number="6">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> pred), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="fl">1.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb251-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> y2_tory,</a>
<a class="sourceLine" id="cb251-8" data-line-number="8">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> pred), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="fl">1.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb251-9" data-line-number="9"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;margin of victory&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;log net wealth at death&quot;</span>,</a>
<a class="sourceLine" id="cb251-10" data-line-number="10">       <span class="dt">title =</span> <span class="st">&quot;labour&quot;</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-105-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We can actually produce this plot easily without running the regressions, by using <code>geom_smooth</code>:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb252-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="kw">mutate</span>(MPs, <span class="dt">winner =</span> (margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)),</a>
<a class="sourceLine" id="cb252-2" data-line-number="2">       <span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> ln.net)) <span class="op">+</span></a>
<a class="sourceLine" id="cb252-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb252-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb252-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> lm, <span class="dt">se =</span> <span class="ot">FALSE</span>, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">group =</span> winner)) <span class="op">+</span></a>
<a class="sourceLine" id="cb252-6" data-line-number="6"><span class="st">  </span><span class="kw">facet_grid</span>(party <span class="op">~</span><span class="st"> </span>.) <span class="op">+</span></a>
<a class="sourceLine" id="cb252-7" data-line-number="7"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;margin of victory&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;log net wealth at death&quot;</span>)</a></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-106-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In the previous code, I didn’t directly compute the the average net wealth at 0, so I’ll need to do that here. I’ll use <a href="https://www.rdocumentation.org/packages/modelr/topics/gather_predictions">gather_predictions</a> to add predictions for multiple models:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb253-1" data-line-number="1"><span class="kw">spread_predictions</span>(<span class="kw">data_frame</span>(<span class="dt">margin =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb253-2" data-line-number="2">                   tory_fit1, tory_fit2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb253-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rd_est =</span> tory_fit2 <span class="op">-</span><span class="st"> </span>tory_fit1)</a>
<a class="sourceLine" id="cb253-4" data-line-number="4"><span class="co">#&gt; # A tibble: 1 x 4</span></a>
<a class="sourceLine" id="cb253-5" data-line-number="5"><span class="co">#&gt;   margin tory_fit1 tory_fit2 rd_est</span></a>
<a class="sourceLine" id="cb253-6" data-line-number="6"><span class="co">#&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb253-7" data-line-number="7"><span class="co">#&gt; 1      0      12.5      13.2  0.650</span></a></code></pre></div>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb254-1" data-line-number="1">tory_fit3 &lt;-<span class="st"> </span><span class="kw">lm</span>(margin.pre <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb254-2" data-line-number="2">tory_fit4 &lt;-<span class="st"> </span><span class="kw">lm</span>(margin.pre <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb254-3" data-line-number="3"></a>
<a class="sourceLine" id="cb254-4" data-line-number="4">(<span class="kw">filter</span>(<span class="kw">tidy</span>(tory_fit4), term <span class="op">==</span><span class="st"> &quot;(Intercept)&quot;</span>)[[<span class="st">&quot;estimate&quot;</span>]] <span class="op">-</span></a>
<a class="sourceLine" id="cb254-5" data-line-number="5"><span class="st"> </span><span class="kw">filter</span>(<span class="kw">tidy</span>(tory_fit3), term <span class="op">==</span><span class="st"> &quot;(Intercept)&quot;</span>)[[<span class="st">&quot;estimate&quot;</span>]])</a>
<a class="sourceLine" id="cb254-6" data-line-number="6"><span class="co">#&gt; [1] -0.0173</span></a></code></pre></div>

</section>
</section>
</section>
<section id="discovery" class="level1">
<h1><span class="header-section-number">5</span> Discovery</h1>
<p>The idea of tidy data and the common feature of tidyverse packages is that data should be stored in data frames with certain conventions. This works well with naturally tabular data, the type which has been common in social science applications. But there are other domains in which other data structures are more appropriate because they more naturally model the data or processes, or for computational reasons. The three applications in this chapter: text, networks, and spatial data are examples where the tidy data structure is less of an advantage. I will still rely on <strong>ggplot2</strong> for plotting, and use tidy verse compatible packages where appropriate.</p>
<ul>
<li>Textual data: <a href="https://cran.r-project.org/package=tidytext">tidytext</a></li>
<li>Network data: <a href="https://cran.r-project.org/package=igraph">igraph</a> for network computation, as in the chapter. But several <strong>ggplot2</strong>2 extension packages for plotting the networks.</li>
<li>Spatial data: <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> has some built-in support for maps. The <a href="https://cran.r-project.org/package=map">map</a> package provides map data.</li>
</ul>
<p>See the <a href="http://r4ds.had.co.nz/">R for Data Science</a> section <a href="http://r4ds.had.co.nz/tidy-data.html#non-tidy-data">12.7 Non-tidy data</a> and this post on <a href="http://simplystatistics.org/2016/02/17/non-tidy-data/">Non-tidy data</a> by Jeff Leek for more on non-tidy data.</p>
<section id="textual-data" class="level2">
<h2><span class="header-section-number">5.1</span> Textual data</h2>
<section id="prerequisites-4" class="level3 unnumbered">
<h3>Prerequisites</h3>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb255-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a>
<a class="sourceLine" id="cb255-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)</a>
<a class="sourceLine" id="cb255-3" data-line-number="3"><span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)</a>
<a class="sourceLine" id="cb255-4" data-line-number="4"><span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)</a>
<a class="sourceLine" id="cb255-5" data-line-number="5"><span class="kw">library</span>(<span class="st">&quot;modelr&quot;</span>)</a>
<a class="sourceLine" id="cb255-6" data-line-number="6"><span class="kw">library</span>(<span class="st">&quot;tm&quot;</span>)</a>
<a class="sourceLine" id="cb255-7" data-line-number="7"><span class="kw">library</span>(<span class="st">&quot;SnowballC&quot;</span>)</a>
<a class="sourceLine" id="cb255-8" data-line-number="8"><span class="kw">library</span>(<span class="st">&quot;tidytext&quot;</span>)</a>
<a class="sourceLine" id="cb255-9" data-line-number="9"><span class="kw">library</span>(<span class="st">&quot;wordcloud&quot;</span>)</a></code></pre></div>
<p>This section will primarily use the <a href="https://cran.r-project.org/package=tidytext">tidytext</a> package. It is a relatively new package. The <a href="https://cran.r-project.org/package=tm">tm</a> and <a href="https://cran.r-project.org/package=quanteda">quanteda</a> (by Ken Benoit) packages are more established and use the document-term matrix format as described in the QSS chapter. The <strong>tidytext</strong> package stores everything in a data frame; this may be less efficient than the other packages, but has the benefit of being able to easily take advantage of the tidyverse ecosystem. If your corpus is not too large, this shouldn’t be an issue.</p>
<p>See <a href="http://tidytextmining.com/">Tidy Text Mining with R</a> for a full introduction to using <strong>tidytext</strong>.</p>
<p>In tidy data, each row is an observation and each column is a variable. In the <strong>tidytext</strong> package, documents are stored as data frames with <strong>one-term-per-row</strong>.</p>
<p>We can cast data into the <strong>tidytext</strong> format either from the <code>Corpus</code> object, or, after processing, from the document-term matrix object.</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb256-1" data-line-number="1">DIR_SOURCE &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/federalist&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb256-2" data-line-number="2">corpus_raw &lt;-<span class="st"> </span><span class="kw">VCorpus</span>(<span class="kw">DirSource</span>(<span class="dt">directory =</span> DIR_SOURCE, <span class="dt">pattern =</span> <span class="st">&quot;fp&quot;</span>))</a>
<a class="sourceLine" id="cb256-3" data-line-number="3">corpus_raw</a>
<a class="sourceLine" id="cb256-4" data-line-number="4"><span class="co">#&gt; &lt;&lt;VCorpus&gt;&gt;</span></a>
<a class="sourceLine" id="cb256-5" data-line-number="5"><span class="co">#&gt; Metadata:  corpus specific: 0, document level (indexed): 0</span></a>
<a class="sourceLine" id="cb256-6" data-line-number="6"><span class="co">#&gt; Content:  documents: 85</span></a></code></pre></div>
<p>Use the function <a href="https://www.rdocumentation.org/packages/tidyytext/topics/tidy.Corpus">tidy</a> to convert the to a data frame with one row per document.</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb257-1" data-line-number="1">corpus_tidy &lt;-<span class="st"> </span><span class="kw">tidy</span>(corpus_raw, <span class="st">&quot;corpus&quot;</span>)</a>
<a class="sourceLine" id="cb257-2" data-line-number="2">corpus_tidy</a>
<a class="sourceLine" id="cb257-3" data-line-number="3"><span class="co">#&gt; # A tibble: 85 x 8</span></a>
<a class="sourceLine" id="cb257-4" data-line-number="4"><span class="co">#&gt;   author datetimestamp       description heading id     lang… orig… text  </span></a>
<a class="sourceLine" id="cb257-5" data-line-number="5"><span class="co">#&gt;   &lt;lgl&gt;  &lt;dttm&gt;              &lt;lgl&gt;       &lt;lgl&gt;   &lt;chr&gt;  &lt;chr&gt; &lt;lgl&gt; &lt;chr&gt; </span></a>
<a class="sourceLine" id="cb257-6" data-line-number="6"><span class="co">#&gt; 1 NA     2018-01-13 13:32:27 NA          NA      fp01.… en    NA    AFTER…</span></a>
<a class="sourceLine" id="cb257-7" data-line-number="7"><span class="co">#&gt; 2 NA     2018-01-13 13:32:27 NA          NA      fp02.… en    NA    &quot;WHEN…</span></a>
<a class="sourceLine" id="cb257-8" data-line-number="8"><span class="co">#&gt; 3 NA     2018-01-13 13:32:27 NA          NA      fp03.… en    NA    IT IS…</span></a>
<a class="sourceLine" id="cb257-9" data-line-number="9"><span class="co">#&gt; 4 NA     2018-01-13 13:32:27 NA          NA      fp04.… en    NA    &quot;MY L…</span></a>
<a class="sourceLine" id="cb257-10" data-line-number="10"><span class="co">#&gt; 5 NA     2018-01-13 13:32:27 NA          NA      fp05.… en    NA    &quot;QUEE…</span></a>
<a class="sourceLine" id="cb257-11" data-line-number="11"><span class="co">#&gt; 6 NA     2018-01-13 13:32:27 NA          NA      fp06.… en    NA    &quot;THE …</span></a>
<a class="sourceLine" id="cb257-12" data-line-number="12"><span class="co">#&gt; # ... with 79 more rows</span></a></code></pre></div>
<p>The <code>text</code> column contains the text of the documents themselves. Since most of the metadata columns are either missings or irrelevant for our purposes, we’ll delete those columns, keeping only the document (<code>id</code>) and <code>text</code> columns.</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb258-1" data-line-number="1">corpus_tidy &lt;-<span class="st"> </span><span class="kw">select</span>(corpus_tidy, id, text)</a></code></pre></div>
<p>Also, we want to extract the essay number and use that as the document id rather than its file name.</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb259-1" data-line-number="1">corpus_tidy &lt;-</a>
<a class="sourceLine" id="cb259-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(corpus_tidy, <span class="dt">document =</span> <span class="kw">as.integer</span>(<span class="kw">str_extract</span>(id, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">d+&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb259-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>id)</a></code></pre></div>
<p>The function tokenizes the document texts:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb260-1" data-line-number="1">tokens &lt;-<span class="st"> </span>corpus_tidy <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb260-2" data-line-number="2"><span class="st">  </span><span class="co"># tokenizes into words and stems them</span></a>
<a class="sourceLine" id="cb260-3" data-line-number="3"><span class="st">  </span><span class="kw">unnest_tokens</span>(word, text, <span class="dt">token =</span> <span class="st">&quot;word_stems&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb260-4" data-line-number="4"><span class="st">  </span><span class="co"># remove any numbers in the strings</span></a>
<a class="sourceLine" id="cb260-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">word =</span> <span class="kw">str_replace_all</span>(word, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">d+&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb260-6" data-line-number="6"><span class="st">  </span><span class="co"># drop any empty strings</span></a>
<a class="sourceLine" id="cb260-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(word <span class="op">!=</span><span class="st"> &quot;&quot;</span>)</a>
<a class="sourceLine" id="cb260-8" data-line-number="8">tokens</a>
<a class="sourceLine" id="cb260-9" data-line-number="9"><span class="co">#&gt; # A tibble: 202,089 x 2</span></a>
<a class="sourceLine" id="cb260-10" data-line-number="10"><span class="co">#&gt;   document word     </span></a>
<a class="sourceLine" id="cb260-11" data-line-number="11"><span class="co">#&gt;      &lt;int&gt; &lt;chr&gt;    </span></a>
<a class="sourceLine" id="cb260-12" data-line-number="12"><span class="co">#&gt; 1        1 after    </span></a>
<a class="sourceLine" id="cb260-13" data-line-number="13"><span class="co">#&gt; 2        1 an       </span></a>
<a class="sourceLine" id="cb260-14" data-line-number="14"><span class="co">#&gt; 3        1 unequivoc</span></a>
<a class="sourceLine" id="cb260-15" data-line-number="15"><span class="co">#&gt; 4        1 experi   </span></a>
<a class="sourceLine" id="cb260-16" data-line-number="16"><span class="co">#&gt; 5        1 of       </span></a>
<a class="sourceLine" id="cb260-17" data-line-number="17"><span class="co">#&gt; 6        1 the      </span></a>
<a class="sourceLine" id="cb260-18" data-line-number="18"><span class="co">#&gt; # ... with 2.021e+05 more rows</span></a></code></pre></div>
<p>The <code>unnest_tokens</code> function uses the <a href="https://cran.r-project.org/package=tokenizers">tokenizers</a> package to tokenize the text. By default, it uses the function which removes punctuation, and lowercases the words. I set the tokenizer to to stem the word, using the <a href="https://cran.r-project.org/package=SnowballC">SnowballC</a> package.</p>
<p>We can remove stop-words with an <a href="https://www.rdocumentation.org/packages/dplyr/topics/anti_join">anti_join</a> on the dataset <a href="https://www.rdocumentation.org/packages/tidytext/topics/stop_words">stop_words</a></p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb261-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;stop_words&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;tidytext&quot;</span>)</a>
<a class="sourceLine" id="cb261-2" data-line-number="2">tokens &lt;-<span class="st"> </span><span class="kw">anti_join</span>(tokens, stop_words, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>)</a></code></pre></div>
</section>
<section id="document-term-matrix" class="level3">
<h3><span class="header-section-number">5.1.1</span> Document-Term Matrix</h3>
<p>In <code>tokens</code> there is one observation for each token (word) in the each document. This is almost equivalent to a document-term matrix. For a document-term matrix we need documents, and terms as the keys for the data and a column with the number of times the term appeared in the document.</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb262-1" data-line-number="1">dtm &lt;-<span class="st"> </span><span class="kw">count</span>(tokens, document, word)</a>
<a class="sourceLine" id="cb262-2" data-line-number="2"><span class="kw">head</span>(dtm)</a>
<a class="sourceLine" id="cb262-3" data-line-number="3"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb262-4" data-line-number="4"><span class="co">#&gt;   document word           n</span></a>
<a class="sourceLine" id="cb262-5" data-line-number="5"><span class="co">#&gt;      &lt;int&gt; &lt;chr&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb262-6" data-line-number="6"><span class="co">#&gt; 1        1 abl            1</span></a>
<a class="sourceLine" id="cb262-7" data-line-number="7"><span class="co">#&gt; 2        1 absurd         1</span></a>
<a class="sourceLine" id="cb262-8" data-line-number="8"><span class="co">#&gt; 3        1 accid          1</span></a>
<a class="sourceLine" id="cb262-9" data-line-number="9"><span class="co">#&gt; 4        1 accord         1</span></a>
<a class="sourceLine" id="cb262-10" data-line-number="10"><span class="co">#&gt; 5        1 acknowledg     1</span></a>
<a class="sourceLine" id="cb262-11" data-line-number="11"><span class="co">#&gt; 6        1 act            1</span></a></code></pre></div>
</section>
<section id="topic-discovery" class="level3">
<h3><span class="header-section-number">5.1.2</span> Topic Discovery</h3>
<p>Plot the word-clouds for essays 12 and 24:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb263-1" data-line-number="1"><span class="kw">filter</span>(dtm, document <span class="op">==</span><span class="st"> </span><span class="dv">12</span>) <span class="op">%&gt;%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb263-2" data-line-number="2">    <span class="kw">wordcloud</span>(.<span class="op">$</span>word, .<span class="op">$</span>n, <span class="dt">max.words =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb263-3" data-line-number="3">  }</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-11-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb264-1" data-line-number="1"><span class="kw">filter</span>(dtm, document <span class="op">==</span><span class="st"> </span><span class="dv">24</span>) <span class="op">%&gt;%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb264-2" data-line-number="2">    <span class="kw">wordcloud</span>(.<span class="op">$</span>word, .<span class="op">$</span>n, <span class="dt">max.words =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb264-3" data-line-number="3">  }</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-12-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Use the function <a href="https://www.rdocumentation.org/packages/tidytext/topics/bind_tf_idf">bind_tf_idf</a> to add a column with the tf-idf to the data frame.</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb265-1" data-line-number="1">dtm &lt;-<span class="st"> </span><span class="kw">bind_tf_idf</span>(dtm, word, document, n)</a>
<a class="sourceLine" id="cb265-2" data-line-number="2">dtm</a>
<a class="sourceLine" id="cb265-3" data-line-number="3"><span class="co">#&gt; # A tibble: 38,847 x 6</span></a>
<a class="sourceLine" id="cb265-4" data-line-number="4"><span class="co">#&gt;   document word           n      tf   idf   tf_idf</span></a>
<a class="sourceLine" id="cb265-5" data-line-number="5"><span class="co">#&gt;      &lt;int&gt; &lt;chr&gt;      &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb265-6" data-line-number="6"><span class="co">#&gt; 1        1 abl            1 0.00145 0.705 0.00102 </span></a>
<a class="sourceLine" id="cb265-7" data-line-number="7"><span class="co">#&gt; 2        1 absurd         1 0.00145 1.73  0.00251 </span></a>
<a class="sourceLine" id="cb265-8" data-line-number="8"><span class="co">#&gt; 3        1 accid          1 0.00145 3.75  0.00543 </span></a>
<a class="sourceLine" id="cb265-9" data-line-number="9"><span class="co">#&gt; 4        1 accord         1 0.00145 0.754 0.00109 </span></a>
<a class="sourceLine" id="cb265-10" data-line-number="10"><span class="co">#&gt; 5        1 acknowledg     1 0.00145 1.55  0.00225 </span></a>
<a class="sourceLine" id="cb265-11" data-line-number="11"><span class="co">#&gt; 6        1 act            1 0.00145 0.400 0.000579</span></a>
<a class="sourceLine" id="cb265-12" data-line-number="12"><span class="co">#&gt; # ... with 3.884e+04 more rows</span></a></code></pre></div>
<p>The 10 most important words for Paper No. 12 are</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb266-1" data-line-number="1">dtm <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb266-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(document <span class="op">==</span><span class="st"> </span><span class="dv">12</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb266-3" data-line-number="3"><span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, tf_idf)</a>
<a class="sourceLine" id="cb266-4" data-line-number="4"><span class="co">#&gt; # A tibble: 10 x 6</span></a>
<a class="sourceLine" id="cb266-5" data-line-number="5"><span class="co">#&gt;   document word           n      tf   idf  tf_idf</span></a>
<a class="sourceLine" id="cb266-6" data-line-number="6"><span class="co">#&gt;      &lt;int&gt; &lt;chr&gt;      &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb266-7" data-line-number="7"><span class="co">#&gt; 1       12 cent           2 0.00199  4.44 0.00884</span></a>
<a class="sourceLine" id="cb266-8" data-line-number="8"><span class="co">#&gt; 2       12 coast          3 0.00299  3.75 0.0112 </span></a>
<a class="sourceLine" id="cb266-9" data-line-number="9"><span class="co">#&gt; 3       12 commerc        8 0.00796  1.11 0.00884</span></a>
<a class="sourceLine" id="cb266-10" data-line-number="10"><span class="co">#&gt; 4       12 contraband     3 0.00299  4.44 0.0133 </span></a>
<a class="sourceLine" id="cb266-11" data-line-number="11"><span class="co">#&gt; 5       12 excis          5 0.00498  2.65 0.0132 </span></a>
<a class="sourceLine" id="cb266-12" data-line-number="12"><span class="co">#&gt; 6       12 gallon         2 0.00199  4.44 0.00884</span></a>
<a class="sourceLine" id="cb266-13" data-line-number="13"><span class="co">#&gt; # ... with 4 more rows</span></a></code></pre></div>
<p>and for Paper No. 24,</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb267-1" data-line-number="1">dtm <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb267-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(document <span class="op">==</span><span class="st"> </span><span class="dv">24</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb267-3" data-line-number="3"><span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, tf_idf)</a>
<a class="sourceLine" id="cb267-4" data-line-number="4"><span class="co">#&gt; # A tibble: 10 x 6</span></a>
<a class="sourceLine" id="cb267-5" data-line-number="5"><span class="co">#&gt;   document word         n      tf   idf  tf_idf</span></a>
<a class="sourceLine" id="cb267-6" data-line-number="6"><span class="co">#&gt;      &lt;int&gt; &lt;chr&gt;    &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb267-7" data-line-number="7"><span class="co">#&gt; 1       24 armi         7 0.00858  1.26 0.0108 </span></a>
<a class="sourceLine" id="cb267-8" data-line-number="8"><span class="co">#&gt; 2       24 arsenal      2 0.00245  3.75 0.00919</span></a>
<a class="sourceLine" id="cb267-9" data-line-number="9"><span class="co">#&gt; 3       24 dock         3 0.00368  4.44 0.0163 </span></a>
<a class="sourceLine" id="cb267-10" data-line-number="10"><span class="co">#&gt; 4       24 frontier     3 0.00368  2.83 0.0104 </span></a>
<a class="sourceLine" id="cb267-11" data-line-number="11"><span class="co">#&gt; 5       24 garrison     6 0.00735  2.83 0.0208 </span></a>
<a class="sourceLine" id="cb267-12" data-line-number="12"><span class="co">#&gt; 6       24 nearer       2 0.00245  3.34 0.00820</span></a>
<a class="sourceLine" id="cb267-13" data-line-number="13"><span class="co">#&gt; # ... with 4 more rows</span></a></code></pre></div>
<p>The slightly different results from the book are due to tokenization differences.</p>
<p>Subset those documents known to have been written by Hamilton.</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb268-1" data-line-number="1">HAMILTON_ESSAYS &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">6</span><span class="op">:</span><span class="dv">9</span>, <span class="dv">11</span><span class="op">:</span><span class="dv">13</span>, <span class="dv">15</span><span class="op">:</span><span class="dv">17</span>, <span class="dv">21</span><span class="op">:</span><span class="dv">36</span>, <span class="dv">59</span><span class="op">:</span><span class="dv">61</span>, <span class="dv">65</span><span class="op">:</span><span class="dv">85</span>)</a>
<a class="sourceLine" id="cb268-2" data-line-number="2">dtm_hamilton &lt;-<span class="st"> </span><span class="kw">filter</span>(dtm, document <span class="op">%in%</span><span class="st"> </span>HAMILTON_ESSAYS)</a></code></pre></div>
<p>The <a href="https://www.rdocumentation.org/packages/stats/topics/kmeans">kmeans</a> function expects the input to be rows for observations and columns for each variable: in our case that would be documents as rows, and words as columns, with the tf-idf as the cell values. We could use <code>spread</code> to do this, but that would be a large matrix.</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb269-1" data-line-number="1">CLUSTERS &lt;-<span class="st"> </span><span class="dv">4</span></a>
<a class="sourceLine" id="cb269-2" data-line-number="2">km_out &lt;-</a>
<a class="sourceLine" id="cb269-3" data-line-number="3"><span class="st">  </span><span class="kw">kmeans</span>(<span class="kw">cast_dtm</span>(dtm_hamilton, document, word, tf_idf), <span class="dt">centers =</span> CLUSTERS,</a>
<a class="sourceLine" id="cb269-4" data-line-number="4">         <span class="dt">nstart =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb269-5" data-line-number="5">km_out<span class="op">$</span>iter</a>
<a class="sourceLine" id="cb269-6" data-line-number="6"><span class="co">#&gt; [1] 3</span></a></code></pre></div>
<p>Data frame with the unique terms used by Hamilton. I extract these from the column names of the DTM after <code>cast_dtm</code> to ensure that the order is the same as the k-means results.</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb270-1" data-line-number="1">hamilton_words &lt;-</a>
<a class="sourceLine" id="cb270-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">word =</span> <span class="kw">colnames</span>(<span class="kw">cast_dtm</span>(dtm_hamilton, document, word, tf_idf)))</a></code></pre></div>
<p>The centers of the clusters is a cluster x word matrix. We want to transpose it and then append columns to <code>hamilton_words</code> so the location of each word in the cluster is listed.</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb271-1" data-line-number="1"><span class="kw">dim</span>(km_out<span class="op">$</span>centers)</a>
<a class="sourceLine" id="cb271-2" data-line-number="2"><span class="co">#&gt; [1]    4 3850</span></a></code></pre></div>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb272-1" data-line-number="1">hamilton_words &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(hamilton_words, <span class="kw">as_tibble</span>(<span class="kw">t</span>(km_out<span class="op">$</span>centers)))</a>
<a class="sourceLine" id="cb272-2" data-line-number="2">hamilton_words</a>
<a class="sourceLine" id="cb272-3" data-line-number="3"><span class="co">#&gt; # A tibble: 3,850 x 5</span></a>
<a class="sourceLine" id="cb272-4" data-line-number="4"><span class="co">#&gt;   word            `1`      `2`     `3`      `4`</span></a>
<a class="sourceLine" id="cb272-5" data-line-number="5"><span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb272-6" data-line-number="6"><span class="co">#&gt; 1 abl        0.000939 0.000743 0       0       </span></a>
<a class="sourceLine" id="cb272-7" data-line-number="7"><span class="co">#&gt; 2 absurd     0        0.000517 0       0.000882</span></a>
<a class="sourceLine" id="cb272-8" data-line-number="8"><span class="co">#&gt; 3 accid      0        0.000202 0       0       </span></a>
<a class="sourceLine" id="cb272-9" data-line-number="9"><span class="co">#&gt; 4 accord     0        0.000399 0       0.000852</span></a>
<a class="sourceLine" id="cb272-10" data-line-number="10"><span class="co">#&gt; 5 acknowledg 0        0.000388 0       0.000473</span></a>
<a class="sourceLine" id="cb272-11" data-line-number="11"><span class="co">#&gt; 6 act        0        0.000560 0.00176 0.000631</span></a>
<a class="sourceLine" id="cb272-12" data-line-number="12"><span class="co">#&gt; # ... with 3,844 more rows</span></a></code></pre></div>
<p>To find the top 10 words in each centroid, we use <code>top_n</code> with <code>group_by</code>:</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb273-1" data-line-number="1">top_words_cluster &lt;-</a>
<a class="sourceLine" id="cb273-2" data-line-number="2"><span class="st">  </span><span class="kw">gather</span>(hamilton_words, cluster, value, <span class="op">-</span>word) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb273-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb273-4" data-line-number="4"><span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, value)</a></code></pre></div>
<p>We can print them out using a for loop</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb274-1" data-line-number="1"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>CLUSTERS) {</a>
<a class="sourceLine" id="cb274-2" data-line-number="2">  <span class="kw">cat</span>(<span class="st">&quot;CLUSTER &quot;</span>, i, <span class="st">&quot;: &quot;</span>,</a>
<a class="sourceLine" id="cb274-3" data-line-number="3">      <span class="kw">str_c</span>(<span class="kw">filter</span>(top_words_cluster, cluster <span class="op">==</span><span class="st"> </span>i)<span class="op">$</span>word, <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>),</a>
<a class="sourceLine" id="cb274-4" data-line-number="4">      <span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb274-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb274-6" data-line-number="6"><span class="co">#&gt; CLUSTER  1 :  presid, appoint, senat, claus, expir, fill, recess, session, unfound, vacanc </span></a>
<a class="sourceLine" id="cb274-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb274-8" data-line-number="8"><span class="co">#&gt; CLUSTER  2 :  offic, presid, tax, land, revenu, armi, militia, senat, taxat, claus </span></a>
<a class="sourceLine" id="cb274-9" data-line-number="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb274-10" data-line-number="10"><span class="co">#&gt; CLUSTER  3 :  sedit, guilt, chief, clemenc, impun, plead, crime, pardon, treason, conniv </span></a>
<a class="sourceLine" id="cb274-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb274-12" data-line-number="12"><span class="co">#&gt; CLUSTER  4 :  court, jurisdict, inferior, suprem, trial, tribun, cogniz, juri, impeach, appel</span></a></code></pre></div>
<p>This is alternative code that prints out a table:</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb275-1" data-line-number="1"><span class="kw">gather</span>(hamilton_words, cluster, value, <span class="op">-</span>word) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb275-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb275-3" data-line-number="3"><span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb275-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">top_words =</span> <span class="kw">str_c</span>(word, <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb275-5" data-line-number="5"><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">cluster</th>
<th style="text-align: left;">top_words</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">presid, appoint, senat, claus, expir, fill, recess, session, unfound, vacanc</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: left;">offic, presid, tax, land, revenu, armi, militia, senat, taxat, claus</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">sedit, guilt, chief, clemenc, impun, plead, crime, pardon, treason, conniv</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: left;">court, jurisdict, inferior, suprem, trial, tribun, cogniz, juri, impeach, appel</td>
</tr>
</tbody>
</table>
<p>Or to print out the documents in each cluster,</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb276-1" data-line-number="1"><span class="kw">enframe</span>(km_out<span class="op">$</span>cluster, <span class="st">&quot;document&quot;</span>, <span class="st">&quot;cluster&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb276-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb276-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">documents =</span> <span class="kw">str_c</span>(document, <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb276-4" data-line-number="4"><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">cluster</th>
<th style="text-align: left;">documents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">67</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">1, 6, 7, 8, 9, 11, 12, 13, 15, 16, 17, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 59, 60, 61, 66, 68, 69, 70, 71, 72, 73, 75, 76, 77, 78, 79, 80, 84, 85</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">74</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">65, 81, 82, 83</td>
</tr>
</tbody>
</table>
</section>
<section id="authorship-prediction" class="level3">
<h3><span class="header-section-number">5.1.3</span> Authorship Prediction</h3>
<p>We’ll create a data-frame with the known</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb277-1" data-line-number="1">MADISON_ESSAYS &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">14</span>, <span class="dv">37</span><span class="op">:</span><span class="dv">48</span>, <span class="dv">58</span>)</a>
<a class="sourceLine" id="cb277-2" data-line-number="2">JAY_ESSAYS &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">64</span>)</a>
<a class="sourceLine" id="cb277-3" data-line-number="3">known_essays &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw">tibble</span>(<span class="dt">document =</span> MADISON_ESSAYS,</a>
<a class="sourceLine" id="cb277-4" data-line-number="4">                                 <span class="dt">author =</span> <span class="st">&quot;Madison&quot;</span>),</a>
<a class="sourceLine" id="cb277-5" data-line-number="5">                          <span class="kw">tibble</span>(<span class="dt">document =</span> HAMILTON_ESSAYS,</a>
<a class="sourceLine" id="cb277-6" data-line-number="6">                                 <span class="dt">author =</span> <span class="st">&quot;Hamilton&quot;</span>),</a>
<a class="sourceLine" id="cb277-7" data-line-number="7">                          <span class="kw">tibble</span>(<span class="dt">document =</span> JAY_ESSAYS,</a>
<a class="sourceLine" id="cb277-8" data-line-number="8">                                 <span class="dt">author =</span> <span class="st">&quot;Jay&quot;</span>))</a></code></pre></div>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb278-1" data-line-number="1">STYLE_WORDS &lt;-</a>
<a class="sourceLine" id="cb278-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">word =</span> <span class="kw">c</span>(<span class="st">&quot;although&quot;</span>, <span class="st">&quot;always&quot;</span>, <span class="st">&quot;commonly&quot;</span>, <span class="st">&quot;consequently&quot;</span>,</a>
<a class="sourceLine" id="cb278-3" data-line-number="3">                  <span class="st">&quot;considerable&quot;</span>, <span class="st">&quot;enough&quot;</span>, <span class="st">&quot;there&quot;</span>, <span class="st">&quot;upon&quot;</span>, <span class="st">&quot;while&quot;</span>, <span class="st">&quot;whilst&quot;</span>))</a>
<a class="sourceLine" id="cb278-4" data-line-number="4"></a>
<a class="sourceLine" id="cb278-5" data-line-number="5">hm_tfm &lt;-</a>
<a class="sourceLine" id="cb278-6" data-line-number="6"><span class="st">  </span><span class="kw">unnest_tokens</span>(corpus_tidy, word, text) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb278-7" data-line-number="7"><span class="st">  </span><span class="kw">count</span>(document, word) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb278-8" data-line-number="8"><span class="st">  </span><span class="co"># term freq per 1000 words</span></a>
<a class="sourceLine" id="cb278-9" data-line-number="9"><span class="st">  </span><span class="kw">group_by</span>(document) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb278-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">count =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n) <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb278-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>n) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb278-12" data-line-number="12"><span class="st">  </span><span class="kw">inner_join</span>(STYLE_WORDS, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb278-13" data-line-number="13"><span class="st">  </span><span class="co"># merge known essays</span></a>
<a class="sourceLine" id="cb278-14" data-line-number="14"><span class="st">  </span><span class="kw">left_join</span>(known_essays, <span class="dt">by =</span> <span class="st">&quot;document&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb278-15" data-line-number="15"><span class="st">  </span><span class="co"># make wide with each word a column</span></a>
<a class="sourceLine" id="cb278-16" data-line-number="16"><span class="st">  </span><span class="co"># fill empty values with 0</span></a>
<a class="sourceLine" id="cb278-17" data-line-number="17"><span class="st">  </span><span class="kw">spread</span>(word, count, <span class="dt">fill =</span> <span class="dv">0</span>)</a></code></pre></div>
<p>Calculate average usage by each author of each word</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb279-1" data-line-number="1">hm_tfm <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb279-2" data-line-number="2"><span class="st">  </span><span class="co"># remove docs with no author</span></a>
<a class="sourceLine" id="cb279-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(author)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb279-4" data-line-number="4"><span class="st">  </span><span class="co"># convert back to long (tidy) format to make it easier to summarize</span></a>
<a class="sourceLine" id="cb279-5" data-line-number="5"><span class="st">  </span><span class="kw">gather</span>(word, count, <span class="op">-</span>document, <span class="op">-</span>author) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb279-6" data-line-number="6"><span class="st">  </span><span class="co"># calculate averge document word usage by author</span></a>
<a class="sourceLine" id="cb279-7" data-line-number="7"><span class="st">  </span><span class="kw">group_by</span>(author, word) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb279-8" data-line-number="8"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">avg_count =</span> <span class="kw">mean</span>(count)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb279-9" data-line-number="9"><span class="st">  </span><span class="kw">spread</span>(author, avg_count) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb279-10" data-line-number="10"><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">word</th>
<th style="text-align: right;">Hamilton</th>
<th style="text-align: right;">Jay</th>
<th style="text-align: right;">Madison</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">although</td>
<td style="text-align: right;">0.012</td>
<td style="text-align: right;">0.543</td>
<td style="text-align: right;">0.206</td>
</tr>
<tr class="even">
<td style="text-align: left;">always</td>
<td style="text-align: right;">0.522</td>
<td style="text-align: right;">0.929</td>
<td style="text-align: right;">0.154</td>
</tr>
<tr class="odd">
<td style="text-align: left;">commonly</td>
<td style="text-align: right;">0.184</td>
<td style="text-align: right;">0.129</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">consequently</td>
<td style="text-align: right;">0.018</td>
<td style="text-align: right;">0.469</td>
<td style="text-align: right;">0.344</td>
</tr>
<tr class="odd">
<td style="text-align: left;">considerable</td>
<td style="text-align: right;">0.377</td>
<td style="text-align: right;">0.081</td>
<td style="text-align: right;">0.123</td>
</tr>
<tr class="even">
<td style="text-align: left;">enough</td>
<td style="text-align: right;">0.274</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">there</td>
<td style="text-align: right;">3.065</td>
<td style="text-align: right;">0.954</td>
<td style="text-align: right;">0.849</td>
</tr>
<tr class="even">
<td style="text-align: left;">upon</td>
<td style="text-align: right;">3.054</td>
<td style="text-align: right;">0.112</td>
<td style="text-align: right;">0.152</td>
</tr>
<tr class="odd">
<td style="text-align: left;">while</td>
<td style="text-align: right;">0.255</td>
<td style="text-align: right;">0.192</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">whilst</td>
<td style="text-align: right;">0.005</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.292</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb280-1" data-line-number="1">author_data &lt;-</a>
<a class="sourceLine" id="cb280-2" data-line-number="2"><span class="st">  </span>hm_tfm <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb280-3" data-line-number="3"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb280-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(author) <span class="op">|</span><span class="st"> </span>author <span class="op">!=</span><span class="st"> &quot;Jay&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb280-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">author2 =</span> <span class="kw">case_when</span>(.<span class="op">$</span>author <span class="op">==</span><span class="st"> &quot;Hamilton&quot;</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb280-6" data-line-number="6">                             .<span class="op">$</span>author <span class="op">==</span><span class="st"> &quot;Madison&quot;</span> <span class="op">~</span><span class="st"> </span><span class="dv">-1</span>,</a>
<a class="sourceLine" id="cb280-7" data-line-number="7">                             <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span><span class="ot">NA_real_</span>))</a>
<a class="sourceLine" id="cb280-8" data-line-number="8"></a>
<a class="sourceLine" id="cb280-9" data-line-number="9">hm_fit &lt;-<span class="st"> </span><span class="kw">lm</span>(author2 <span class="op">~</span><span class="st"> </span>upon <span class="op">+</span><span class="st"> </span>there <span class="op">+</span><span class="st"> </span>consequently <span class="op">+</span><span class="st"> </span>whilst,</a>
<a class="sourceLine" id="cb280-10" data-line-number="10">             <span class="dt">data =</span> author_data)</a>
<a class="sourceLine" id="cb280-11" data-line-number="11">hm_fit</a>
<a class="sourceLine" id="cb280-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb280-13" data-line-number="13"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb280-14" data-line-number="14"><span class="co">#&gt; lm(formula = author2 ~ upon + there + consequently + whilst, </span></a>
<a class="sourceLine" id="cb280-15" data-line-number="15"><span class="co">#&gt;     data = author_data)</span></a>
<a class="sourceLine" id="cb280-16" data-line-number="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb280-17" data-line-number="17"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb280-18" data-line-number="18"><span class="co">#&gt;  (Intercept)          upon         there  consequently        whilst  </span></a>
<a class="sourceLine" id="cb280-19" data-line-number="19"><span class="co">#&gt;       -0.195         0.229         0.127        -0.644        -0.984</span></a>
<a class="sourceLine" id="cb280-20" data-line-number="20"></a>
<a class="sourceLine" id="cb280-21" data-line-number="21">author_data &lt;-<span class="st"> </span>author_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb280-22" data-line-number="22"><span class="st">  </span><span class="kw">add_predictions</span>(hm_fit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb280-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pred_author =</span> <span class="kw">if_else</span>(pred <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;Hamilton&quot;</span>, <span class="st">&quot;Madison&quot;</span>))</a>
<a class="sourceLine" id="cb280-24" data-line-number="24"></a>
<a class="sourceLine" id="cb280-25" data-line-number="25"><span class="kw">sd</span>(author_data<span class="op">$</span>pred)</a>
<a class="sourceLine" id="cb280-26" data-line-number="26"><span class="co">#&gt; [1] 0.79</span></a></code></pre></div>
<p>These coefficients are a little different, probably due to differences in the tokenization procedure, and in particular, the document size normalization.</p>
</section>
<section id="cross-validation" class="level3">
<h3><span class="header-section-number">5.1.4</span> Cross-Validation</h3>
<p><strong>tidyverse:</strong> For cross-validation, I rely on the <a href="https://cran.r-project.org/package=modelr">modelr</a> package function <code>RDoc(&quot;modelr::crossv_kfold&quot;)</code>. See the tutorial <a href="https://rpubs.com/dgrtwo/cv-modelr">Cross validation of linear regression with modelr</a> for more on using <strong>modelr</strong> for cross validation or <a href="https://drsimonj.svbtle.com/k-fold-cross-validation-with-modelr-and-broom">k-fold cross-validation with modelr and broom</a>.</p>
<p>In sample, this regression perfectly predicts the authorship of the documents with known authors.</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb281-1" data-line-number="1">author_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb281-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(author)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb281-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(author) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb281-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="st">`</span><span class="dt">Proportion Correct</span><span class="st">`</span> =<span class="st"> </span><span class="kw">mean</span>(author <span class="op">==</span><span class="st"> </span>pred_author))</a>
<a class="sourceLine" id="cb281-5" data-line-number="5"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb281-6" data-line-number="6"><span class="co">#&gt;   author   `Proportion Correct`</span></a>
<a class="sourceLine" id="cb281-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;                   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb281-8" data-line-number="8"><span class="co">#&gt; 1 Hamilton                 1.00</span></a>
<a class="sourceLine" id="cb281-9" data-line-number="9"><span class="co">#&gt; 2 Madison                  1.00</span></a></code></pre></div>
<p>Create the cross-validation data-sets using . As in the chapter, I will use a leave-one-out cross-validation, which is a k-fold cross-validation where k is the number of observations. To simplify this, I define the <code>crossv_loo</code> function that runs <code>crossv_kfold</code> with <code>k = nrow(data)</code>.</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb282-1" data-line-number="1">crossv_loo &lt;-<span class="st"> </span><span class="cf">function</span>(data, <span class="dt">id =</span> <span class="st">&quot;.id&quot;</span>) {</a>
<a class="sourceLine" id="cb282-2" data-line-number="2">  modelr<span class="op">::</span><span class="kw">crossv_kfold</span>(data, <span class="dt">k =</span> <span class="kw">nrow</span>(data), <span class="dt">id =</span> id)</a>
<a class="sourceLine" id="cb282-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb282-4" data-line-number="4"></a>
<a class="sourceLine" id="cb282-5" data-line-number="5"><span class="co"># leave one out cross-validation object</span></a>
<a class="sourceLine" id="cb282-6" data-line-number="6">cv &lt;-<span class="st"> </span>author_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb282-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(author)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb282-8" data-line-number="8"><span class="st">  </span><span class="kw">crossv_loo</span>()</a></code></pre></div>
<p>Now estimate the model for each training dataset</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb283-1" data-line-number="1">models &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(cv<span class="op">$</span>train, <span class="op">~</span><span class="st"> </span><span class="kw">lm</span>(author2 <span class="op">~</span><span class="st"> </span>upon <span class="op">+</span><span class="st"> </span>there <span class="op">+</span><span class="st"> </span>consequently <span class="op">+</span><span class="st"> </span>whilst,</a>
<a class="sourceLine" id="cb283-2" data-line-number="2">                             <span class="dt">data =</span> ., <span class="dt">model =</span> <span class="ot">FALSE</span>))</a></code></pre></div>
<p>Note that I use <code>purrr::map</code> to ensure that the correct <code>map()</code> function is used since the <strong>maps</strong> package also defines a <code>map</code>.</p>
<p>Now calculate the test performance on the held out observation,</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb284-1" data-line-number="1">test &lt;-<span class="st"> </span><span class="kw">map2_df</span>(models, cv<span class="op">$</span>test,</a>
<a class="sourceLine" id="cb284-2" data-line-number="2">                <span class="cf">function</span>(mod, test) {</a>
<a class="sourceLine" id="cb284-3" data-line-number="3">                  <span class="kw">add_predictions</span>(<span class="kw">as.data.frame</span>(test), mod) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb284-4" data-line-number="4"><span class="st">                    </span><span class="kw">mutate</span>(<span class="dt">pred_author =</span></a>
<a class="sourceLine" id="cb284-5" data-line-number="5">                             <span class="kw">if_else</span>(pred <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;Hamilton&quot;</span>, <span class="st">&quot;Madison&quot;</span>),</a>
<a class="sourceLine" id="cb284-6" data-line-number="6">                           <span class="dt">correct =</span> (pred_author <span class="op">==</span><span class="st"> </span>author))</a>
<a class="sourceLine" id="cb284-7" data-line-number="7">                })</a>
<a class="sourceLine" id="cb284-8" data-line-number="8">test <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb284-9" data-line-number="9"><span class="st">  </span><span class="kw">group_by</span>(author) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb284-10" data-line-number="10"><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(correct))</a>
<a class="sourceLine" id="cb284-11" data-line-number="11"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb284-12" data-line-number="12"><span class="co">#&gt;   author   `mean(correct)`</span></a>
<a class="sourceLine" id="cb284-13" data-line-number="13"><span class="co">#&gt;   &lt;chr&gt;              &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb284-14" data-line-number="14"><span class="co">#&gt; 1 Hamilton           1.00 </span></a>
<a class="sourceLine" id="cb284-15" data-line-number="15"><span class="co">#&gt; 2 Madison            0.786</span></a></code></pre></div>
<p>When adding prediction with <code>add_predictions</code> it added predictions for missing values as well.</p>
<p>Table of authorship of disputed papers</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb285-1" data-line-number="1">author_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb285-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(author)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb285-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(document, pred, pred_author) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb285-4" data-line-number="4"><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">document</th>
<th style="text-align: right;">pred</th>
<th style="text-align: left;">pred_author</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">18</td>
<td style="text-align: right;">-0.360</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="even">
<td style="text-align: right;">19</td>
<td style="text-align: right;">-0.587</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20</td>
<td style="text-align: right;">-0.055</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="even">
<td style="text-align: right;">49</td>
<td style="text-align: right;">-0.966</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="odd">
<td style="text-align: right;">50</td>
<td style="text-align: right;">-0.003</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="even">
<td style="text-align: right;">51</td>
<td style="text-align: right;">-1.520</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="odd">
<td style="text-align: right;">52</td>
<td style="text-align: right;">-0.195</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="even">
<td style="text-align: right;">53</td>
<td style="text-align: right;">-0.506</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="odd">
<td style="text-align: right;">54</td>
<td style="text-align: right;">-0.521</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="even">
<td style="text-align: right;">55</td>
<td style="text-align: right;">0.094</td>
<td style="text-align: left;">Hamilton</td>
</tr>
<tr class="odd">
<td style="text-align: right;">56</td>
<td style="text-align: right;">-0.550</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="even">
<td style="text-align: right;">57</td>
<td style="text-align: right;">-1.221</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="odd">
<td style="text-align: right;">62</td>
<td style="text-align: right;">-0.946</td>
<td style="text-align: left;">Madison</td>
</tr>
<tr class="even">
<td style="text-align: right;">63</td>
<td style="text-align: right;">-0.184</td>
<td style="text-align: left;">Madison</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb286-1" data-line-number="1">disputed_essays &lt;-<span class="st"> </span><span class="kw">filter</span>(author_data, <span class="kw">is.na</span>(author))<span class="op">$</span>document</a>
<a class="sourceLine" id="cb286-2" data-line-number="2"></a>
<a class="sourceLine" id="cb286-3" data-line-number="3"><span class="kw">ggplot</span>(<span class="kw">mutate</span>(author_data,</a>
<a class="sourceLine" id="cb286-4" data-line-number="4">              <span class="dt">author =</span> <span class="kw">fct_explicit_na</span>(<span class="kw">factor</span>(author), <span class="st">&quot;Disputed&quot;</span>)),</a>
<a class="sourceLine" id="cb286-5" data-line-number="5">       <span class="kw">aes</span>(<span class="dt">y =</span> document, <span class="dt">x =</span> pred, <span class="dt">colour =</span> author, <span class="dt">shape =</span> author)) <span class="op">+</span></a>
<a class="sourceLine" id="cb286-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb286-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb286-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">10</span>, <span class="dv">80</span>, <span class="dt">by =</span> <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb286-9" data-line-number="9">                     <span class="dt">minor_breaks =</span> <span class="kw">seq</span>(<span class="dv">5</span>, <span class="dv">80</span>, <span class="dt">by =</span> <span class="dv">5</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb286-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Madison&quot;</span> =<span class="st"> &quot;blue&quot;</span>,</a>
<a class="sourceLine" id="cb286-11" data-line-number="11">                                <span class="st">&quot;Hamilton&quot;</span> =<span class="st"> &quot;red&quot;</span>,</a>
<a class="sourceLine" id="cb286-12" data-line-number="12">                                <span class="st">&quot;Disputed&quot;</span> =<span class="st"> &quot;black&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb286-13" data-line-number="13"><span class="st">  </span><span class="kw">scale_shape_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Madison&quot;</span> =<span class="st"> </span><span class="dv">16</span>, <span class="st">&quot;Hamilton&quot;</span> =<span class="st"> </span><span class="dv">15</span>,</a>
<a class="sourceLine" id="cb286-14" data-line-number="14">                                 <span class="st">&quot;Disputed&quot;</span> =<span class="st"> </span><span class="dv">17</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb286-15" data-line-number="15"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">colour =</span> <span class="st">&quot;Author&quot;</span>, <span class="dt">shape =</span> <span class="st">&quot;Author&quot;</span>,</a>
<a class="sourceLine" id="cb286-16" data-line-number="16">       <span class="dt">y =</span> <span class="st">&quot;Federalist Papers&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Predicted values&quot;</span>)</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-30-1.png" width="70%" style="display: block; margin: auto;" /></p>
<!-- detach extraneous packages -->
</section>
</section>
<section id="network-data" class="level2">
<h2><span class="header-section-number">5.2</span> Network data</h2>
<p>The <a href="https://cran.r-project.org/package=igraph">igraph</a>, <a href="https://cran.r-project.org/package=sna">sna</a>, and <a href="https://cran.r-project.org/package=network">network</a> packages are the best in class. See the Social Network Analysis section of the <a href="https://cran.r-project.org/web/views/SocialSciences.html">Social Sciences Task View</a>. See this tutorial by Katherin Ognyanova, <a href="https://rpubs.com/kateto/netviz">Static and dynamic network visualization with R</a>, for a good overview of network visualization with those packages in R.</p>
<p>There are several packages that plot networks in ggplot2.</p>
<ul>
<li><a href="https://cran.r-project.org/package=ggnetwork">ggnetwork</a></li>
<li><a href="https://cran.r-project.org/package=ggraph">ggraph</a></li>
<li><a href="https://cran.r-project.org/package=geomnet">geomnet</a></li>
<li><a href="https://cran.r-project.org/package=GGally">GGally</a> functions <a href="https://ggobi.github.io/ggally/rd.html#ggnet">ggnet</a>, <code>ggnet2</code>, and <code>ggnetworkmap</code>.</li>
<li><a href="https://cran.r-project.org/package=ggCompNet">ggCompNet</a> compares the speed of various network plotting packages in R.</li>
</ul>
<p>See this <a href="http://curleylab.psych.columbia.edu/netviz/netviz1.html#/12">presentation</a> for an overview of some of those packages for data visualization.</p>
<p>Examples: <a href="https://cran.r-project.org/web/packages/ggCompNet/vignettes/examples-from-paper.html">Network Visualization Examples with the ggplot2 Package</a></p>
<section id="prerequisites-5" class="level3 unnumbered">
<h3>Prerequisites</h3>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb287-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a>
<a class="sourceLine" id="cb287-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)</a>
<a class="sourceLine" id="cb287-3" data-line-number="3"><span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)</a>
<a class="sourceLine" id="cb287-4" data-line-number="4"><span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)</a>
<a class="sourceLine" id="cb287-5" data-line-number="5"><span class="kw">library</span>(<span class="st">&quot;igraph&quot;</span>)</a>
<a class="sourceLine" id="cb287-6" data-line-number="6"><span class="kw">library</span>(<span class="st">&quot;intergraph&quot;</span>)</a>
<a class="sourceLine" id="cb287-7" data-line-number="7"><span class="kw">library</span>(<span class="st">&quot;GGally&quot;</span>)</a></code></pre></div>
</section>
<section id="twitter-following-network" class="level3">
<h3><span class="header-section-number">5.2.1</span> Twitter Following Network</h3>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb288-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;twitter.following&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb289-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;twitter.senator&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>Since the names <code>twitter.following</code> and <code>twitter.senator</code> are verbose, we’ll simplify future code by copying their values to variables named <code>twitter</code> and <code>senator</code>, respectively.</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb290-1" data-line-number="1">twitter &lt;-<span class="st"> </span>twitter.following</a>
<a class="sourceLine" id="cb290-2" data-line-number="2">senator &lt;-<span class="st"> </span>twitter.senator</a></code></pre></div>
<p>Simply use the function since <code>twitter</code> consists of edges (a link from a senator to another). Since <code>graph_from_edgelist</code> expects a matrix, convert the data frame to a matrix using .</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb291-1" data-line-number="1">twitter_adj &lt;-<span class="st"> </span><span class="kw">graph_from_edgelist</span>(<span class="kw">as.matrix</span>(twitter))</a></code></pre></div>
<p>Add in- and out-degree variables to the <code>senator</code> data frame:</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb292-1" data-line-number="1">senator &lt;-</a>
<a class="sourceLine" id="cb292-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(senator,</a>
<a class="sourceLine" id="cb292-3" data-line-number="3">         <span class="dt">indegree =</span> igraph<span class="op">::</span><span class="kw">degree</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;in&quot;</span>),</a>
<a class="sourceLine" id="cb292-4" data-line-number="4">         <span class="dt">outdegree =</span> igraph<span class="op">::</span><span class="kw">degree</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;out&quot;</span>))</a></code></pre></div>
<p>Now find the senators with the 3 greatest in-degrees</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb293-1" data-line-number="1"><span class="kw">arrange</span>(senator, <span class="kw">desc</span>(indegree)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb293-2" data-line-number="2"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb293-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(name, party, state, indegree, outdegree)</a>
<a class="sourceLine" id="cb293-4" data-line-number="4"><span class="co">#&gt; # A tibble: 3 x 5</span></a>
<a class="sourceLine" id="cb293-5" data-line-number="5"><span class="co">#&gt;   name              party state indegree outdegree</span></a>
<a class="sourceLine" id="cb293-6" data-line-number="6"><span class="co">#&gt;   &lt;chr&gt;             &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb293-7" data-line-number="7"><span class="co">#&gt; 1 Tom Cotton        R     AR        64.0      15.0</span></a>
<a class="sourceLine" id="cb293-8" data-line-number="8"><span class="co">#&gt; 2 Richard J. Durbin D     IL        60.0      87.0</span></a>
<a class="sourceLine" id="cb293-9" data-line-number="9"><span class="co">#&gt; 3 John Barrasso     R     WY        58.0      79.0</span></a></code></pre></div>
<p>or using the function:</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb294-1" data-line-number="1"><span class="kw">top_n</span>(senator, <span class="dv">3</span>, indegree) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-2" data-line-number="2"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(indegree)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(name, party, state, indegree, outdegree)</a>
<a class="sourceLine" id="cb294-4" data-line-number="4"><span class="co">#&gt;                name party state indegree outdegree</span></a>
<a class="sourceLine" id="cb294-5" data-line-number="5"><span class="co">#&gt; 1        Tom Cotton     R    AR       64        15</span></a>
<a class="sourceLine" id="cb294-6" data-line-number="6"><span class="co">#&gt; 2 Richard J. Durbin     D    IL       60        87</span></a>
<a class="sourceLine" id="cb294-7" data-line-number="7"><span class="co">#&gt; 3     John Barrasso     R    WY       58        79</span></a>
<a class="sourceLine" id="cb294-8" data-line-number="8"><span class="co">#&gt; 4      Joe Donnelly     D    IN       58         9</span></a>
<a class="sourceLine" id="cb294-9" data-line-number="9"><span class="co">#&gt; 5    Orrin G. Hatch     R    UT       58        50</span></a></code></pre></div>
<p>The <code>top_n</code> function catches that three senators are tied for 3rd highest outdegree, whereas the simply sorting and slicing cannot.</p>
<p>And we can find the senators with the three highest out-degrees similarly,</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb295-1" data-line-number="1"><span class="kw">top_n</span>(senator, <span class="dv">3</span>, outdegree) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb295-2" data-line-number="2"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(outdegree)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb295-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(name, party, state, indegree, outdegree)</a>
<a class="sourceLine" id="cb295-4" data-line-number="4"><span class="co">#&gt;               name party state indegree outdegree</span></a>
<a class="sourceLine" id="cb295-5" data-line-number="5"><span class="co">#&gt; 1     Thad Cochran     R    MS       55        89</span></a>
<a class="sourceLine" id="cb295-6" data-line-number="6"><span class="co">#&gt; 2     Steve Daines     R    MT       30        88</span></a>
<a class="sourceLine" id="cb295-7" data-line-number="7"><span class="co">#&gt; 3      John McCain     R    AZ       41        88</span></a>
<a class="sourceLine" id="cb295-8" data-line-number="8"><span class="co">#&gt; 4 Joe Manchin, III     D    WV       43        88</span></a></code></pre></div>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb296-1" data-line-number="1"><span class="co"># Define scales to reuse for the plots</span></a>
<a class="sourceLine" id="cb296-2" data-line-number="2">scale_colour_parties &lt;-<span class="st"> </span><span class="kw">scale_colour_manual</span>(<span class="st">&quot;Party&quot;</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">R =</span> <span class="st">&quot;red&quot;</span>,</a>
<a class="sourceLine" id="cb296-3" data-line-number="3">                                                       <span class="dt">D =</span> <span class="st">&quot;blue&quot;</span>,</a>
<a class="sourceLine" id="cb296-4" data-line-number="4">                                                       <span class="dt">I =</span> <span class="st">&quot;green&quot;</span>))</a>
<a class="sourceLine" id="cb296-5" data-line-number="5">scale_shape_parties &lt;-<span class="st"> </span><span class="kw">scale_shape_manual</span>(<span class="st">&quot;Party&quot;</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="dt">R =</span> <span class="dv">16</span>,</a>
<a class="sourceLine" id="cb296-6" data-line-number="6">                                                              <span class="dt">D =</span> <span class="dv">17</span>,</a>
<a class="sourceLine" id="cb296-7" data-line-number="7">                                                              <span class="dt">I =</span> <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb296-8" data-line-number="8"></a>
<a class="sourceLine" id="cb296-9" data-line-number="9"></a>
<a class="sourceLine" id="cb296-10" data-line-number="10">senator <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb296-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">closeness_in =</span> igraph<span class="op">::</span><span class="kw">closeness</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;in&quot;</span>),</a>
<a class="sourceLine" id="cb296-12" data-line-number="12">         <span class="dt">closeness_out =</span> igraph<span class="op">::</span><span class="kw">closeness</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;out&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb296-13" data-line-number="13"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> closeness_in, <span class="dt">y =</span> closeness_out,</a>
<a class="sourceLine" id="cb296-14" data-line-number="14">             <span class="dt">colour =</span> party, <span class="dt">shape =</span> party)) <span class="op">+</span></a>
<a class="sourceLine" id="cb296-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb296-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb296-17" data-line-number="17"><span class="st">  </span>scale_colour_parties <span class="op">+</span></a>
<a class="sourceLine" id="cb296-18" data-line-number="18"><span class="st">  </span>scale_shape_parties <span class="op">+</span></a>
<a class="sourceLine" id="cb296-19" data-line-number="19"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">main =</span> <span class="st">&quot;Closeness&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Incoming path&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Outgoing path&quot;</span>)</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-40-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>What does the reference line indicate? What does that say about senators twitter networks?</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb297-1" data-line-number="1">senator <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb297-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">betweenness_dir =</span> igraph<span class="op">::</span><span class="kw">betweenness</span>(twitter_adj, <span class="dt">directed =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb297-3" data-line-number="3">         <span class="dt">betweenness_undir =</span> igraph<span class="op">::</span><span class="kw">betweenness</span>(twitter_adj,</a>
<a class="sourceLine" id="cb297-4" data-line-number="4">                                                 <span class="dt">directed =</span> <span class="ot">FALSE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb297-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> betweenness_dir, <span class="dt">y =</span> betweenness_undir, <span class="dt">colour =</span> party,</a>
<a class="sourceLine" id="cb297-6" data-line-number="6">             <span class="dt">shape =</span> party)) <span class="op">+</span></a>
<a class="sourceLine" id="cb297-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb297-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb297-9" data-line-number="9"><span class="st">  </span>scale_colour_parties <span class="op">+</span></a>
<a class="sourceLine" id="cb297-10" data-line-number="10"><span class="st">  </span>scale_shape_parties <span class="op">+</span></a>
<a class="sourceLine" id="cb297-11" data-line-number="11"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">main =</span> <span class="st">&quot;Betweenness&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Directed&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Undirected&quot;</span>)</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-41-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We’ve covered three different methods of calculating the importance of a node in a network: degree, closeness, and centrality. But what do they mean? What’s the “best” measure of importance? The answer to the the former is “it depends on the question”. There are probably other papers out there on this, but Borgatti (2005) is a good discussion:</p>
<blockquote>
<p>Borgatti, Stephen. 2005. “Centrality and Network Flow”. <em>Social Networks</em>. <a href="https://dx.doi.org/doi:10.1016/j.socnet.2004.11.008">DOI</a></p>
</blockquote>
<p>Add and plot page-rank:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb298-1" data-line-number="1">senator &lt;-<span class="st"> </span><span class="kw">mutate</span>(senator, <span class="dt">page_rank =</span> <span class="kw">page_rank</span>(twitter_adj)[[<span class="st">&quot;vector&quot;</span>]])</a>
<a class="sourceLine" id="cb298-2" data-line-number="2"><span class="kw">ggnet</span>(twitter_adj, <span class="dt">mode =</span> <span class="st">&quot;target&quot;</span>)</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-42-1.png" width="70%" style="display: block; margin: auto;" /></p>
<!-- 
remove network packages
-->
</section>
</section>
<section id="spatial-data" class="level2">
<h2><span class="header-section-number">5.3</span> Spatial Data</h2>
<p>Some resources on plotting spatial data in R:</p>
<ul>
<li><p><a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> has several map-related functions</p>
<ul>
<li><a href="http://docs.ggplot2.org/current/borders.html">borders</a></li>
<li><a href="http://docs.ggplot2.org/current/fortify.map.html">fortify.map</a></li>
<li><a href="http://docs.ggplot2.org/current/map_data.html">map_data</a></li>
</ul></li>
<li><p><a href="https://cran.r-project.org/package=ggmap">ggmap</a> allows ggplot to us a map from Google Maps, OpenStreet Maps or similar as a background for the plot.</p>
<ul>
<li>David Kahle and Hadley Wickham. 2013. <a href="https://journal.r-project.org/archive/2013-1/kahle-wickham.pdf">ggmap: Spatial Visualization with ggplot2</a>. <em>Journal of Statistical Software</em></li>
<li>Github <a href="https://github.com/dkahle/ggmap">dkahle/ggmamp</a></li>
</ul></li>
<li><a href="https://cran.r-project.org/package=tmap">tmap</a> is not built on ggplot2 but uses a ggplot2-like API for network data.</li>
<li><p><a href="https://cran.r-project.org/package=leaflet">leaflet</a> is an R interface to a popular javascript mapping library.</p></li>
</ul>
<p>Here are few tutorials on plotting spatial data in ggplot2:</p>
<ul>
<li><a href="http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html">Making Maps with R</a></li>
<li><a href="https://www.r-bloggers.com/r-beginners-plotting-locations-on-to-a-world-map/">Plotting Data on a World Map</a></li>
<li><a href="https://rpubs.com/m_dev/Intro-to-Spatial-Data-and-ggplot2">Introduction to Spatial Data and ggplot2</a></li>
</ul>
<section id="prerequisites-6" class="level3 unnumbered">
<h3>Prerequisites</h3>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb299-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a>
<a class="sourceLine" id="cb299-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)</a>
<a class="sourceLine" id="cb299-3" data-line-number="3"><span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)</a>
<a class="sourceLine" id="cb299-4" data-line-number="4"><span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)</a>
<a class="sourceLine" id="cb299-5" data-line-number="5"><span class="kw">library</span>(<span class="st">&quot;modelr&quot;</span>)</a>
<a class="sourceLine" id="cb299-6" data-line-number="6"><span class="kw">library</span>(<span class="st">&quot;ggrepel&quot;</span>)</a></code></pre></div>
</section>
<section id="spatial-data-in-r" class="level3">
<h3><span class="header-section-number">5.3.1</span> Spatial Data in R</h3>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb300-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;us.cities&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;maps&quot;</span>)</a>
<a class="sourceLine" id="cb300-2" data-line-number="2"><span class="kw">glimpse</span>(us.cities)</a>
<a class="sourceLine" id="cb300-3" data-line-number="3"><span class="co">#&gt; Observations: 1,005</span></a>
<a class="sourceLine" id="cb300-4" data-line-number="4"><span class="co">#&gt; Variables: 6</span></a>
<a class="sourceLine" id="cb300-5" data-line-number="5"><span class="co">#&gt; $ name        &lt;chr&gt; &quot;Abilene TX&quot;, &quot;Akron OH&quot;, &quot;Alameda CA&quot;, &quot;Albany GA...</span></a>
<a class="sourceLine" id="cb300-6" data-line-number="6"><span class="co">#&gt; $ country.etc &lt;chr&gt; &quot;TX&quot;, &quot;OH&quot;, &quot;CA&quot;, &quot;GA&quot;, &quot;NY&quot;, &quot;OR&quot;, &quot;NM&quot;, &quot;LA&quot;, &quot;V...</span></a>
<a class="sourceLine" id="cb300-7" data-line-number="7"><span class="co">#&gt; $ pop         &lt;int&gt; 113888, 206634, 70069, 75510, 93576, 45535, 494962...</span></a>
<a class="sourceLine" id="cb300-8" data-line-number="8"><span class="co">#&gt; $ lat         &lt;dbl&gt; 32.5, 41.1, 37.8, 31.6, 42.7, 44.6, 35.1, 31.3, 38...</span></a>
<a class="sourceLine" id="cb300-9" data-line-number="9"><span class="co">#&gt; $ long        &lt;dbl&gt; -99.7, -81.5, -122.3, -84.2, -73.8, -123.1, -106.6...</span></a>
<a class="sourceLine" id="cb300-10" data-line-number="10"><span class="co">#&gt; $ capital     &lt;int&gt; 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</span></a></code></pre></div>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb301-1" data-line-number="1">usa_map &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;usa&quot;</span>)</a>
<a class="sourceLine" id="cb301-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb301-3" data-line-number="3"><span class="co">#&gt; Attaching package: &#39;maps&#39;</span></a>
<a class="sourceLine" id="cb301-4" data-line-number="4"><span class="co">#&gt; The following object is masked from &#39;package:purrr&#39;:</span></a>
<a class="sourceLine" id="cb301-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb301-6" data-line-number="6"><span class="co">#&gt;     map</span></a>
<a class="sourceLine" id="cb301-7" data-line-number="7">capitals &lt;-<span class="st"> </span><span class="kw">filter</span>(us.cities,</a>
<a class="sourceLine" id="cb301-8" data-line-number="8">                   capital <span class="op">==</span><span class="st"> </span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb301-9" data-line-number="9">                   <span class="op">!</span>country.etc <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;HI&quot;</span>, <span class="st">&quot;AK&quot;</span>))</a>
<a class="sourceLine" id="cb301-10" data-line-number="10"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb301-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_map</span>(<span class="dt">map =</span> usa_map) <span class="op">+</span></a>
<a class="sourceLine" id="cb301-12" data-line-number="12"><span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;usa&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb301-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">size =</span> pop),</a>
<a class="sourceLine" id="cb301-14" data-line-number="14">             <span class="dt">data =</span> capitals) <span class="op">+</span></a>
<a class="sourceLine" id="cb301-15" data-line-number="15"><span class="st">  </span><span class="co"># scale size area ensures: 0 = no area</span></a>
<a class="sourceLine" id="cb301-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_size_area</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb301-17" data-line-number="17"><span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb301-18" data-line-number="18"><span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb301-19" data-line-number="19"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>, <span class="dt">title =</span> <span class="st">&quot;US State Capitals&quot;</span>,</a>
<a class="sourceLine" id="cb301-20" data-line-number="20">       <span class="dt">size =</span> <span class="st">&quot;Population&quot;</span>)</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-46-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb302-1" data-line-number="1">cal_cities &lt;-<span class="st"> </span><span class="kw">filter</span>(us.cities, country.etc <span class="op">==</span><span class="st"> &quot;CA&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb302-2" data-line-number="2"><span class="st">  </span><span class="kw">top_n</span>(<span class="dv">7</span>, pop)</a>
<a class="sourceLine" id="cb302-3" data-line-number="3"></a>
<a class="sourceLine" id="cb302-4" data-line-number="4"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb302-5" data-line-number="5"><span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> <span class="st">&quot;California&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat), <span class="dt">data =</span> cal_cities) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">label =</span> name), <span class="dt">data =</span> cal_cities) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-8" data-line-number="8"><span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb302-9" data-line-number="9"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb302-10" data-line-number="10"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-47-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="colors-in-r" class="level3">
<h3><span class="header-section-number">5.3.2</span> Colors in R</h3>
<p>For more resources on using colors in R</p>
<ul>
<li><code>R4DS</code> chapter <a href="http://r4ds.had.co.nz/graphics-for-communication.html#replacing-a-scale">Graphics for Communication</a></li>
<li>ggplot2 book Chapter “Scales”</li>
<li>Jenny Bryan <a href="https://www.stat.ubc.ca/~jenny/STAT545A/block14_colors.html">Using colors in R</a></li>
<li>Achim Zeileis, Kurt Hornik, Paul Murrell (2009). Escaping RGBland: Selecting Colors for Statistical Graphics. Computational Statistics &amp; Data Analysis <a href="http://dx.doi.org/10.1016/j.csda.2008.11.033">DOI</a></li>
<li><a href="https://cran.r-project.org/web/packages/colorspace/vignettes/hcl-colors.pdf">colorspace vignette</a></li>
<li>Maureen Stone <a href="https://www.perceptualedge.com/articles/b-eye/choosing_colors.pdf">Choosing Colors for Data Visualization</a></li>
<li><a href="http://colorbrewer2.org">ColorBrewer</a> A website with a variety of palettes, primarily designed for maps, but also useful in data viz.</li>
<li>Stephen Few <a href="http://www.perceptualedge.com/articles/visual_business_intelligence/rules_for_using_color.pdf">Practical Rules for Using Color in Charts</a></li>
<li><a href="http://www.research.ibm.com/people/l/lloydt/color/color.HTM">Why Should Engineers and Scientists by Worried About Color?</a></li>
<li><a href="https://www.youtube.com/watch?v=xAoljeRJ3lU">A Better Default Colormap for Matplotlib</a> A SciPy 2015 talk that describes how the <a href="https://cran.r-project.org/package=viridis">viridis</a> was created.</li>
<li><a href="http://www.eecs.harvard.edu/~kgajos/papers/2011/borkin11-infoviz.pdf">Evaluation of Artery Visualizations for Heart Disease Diagnosis</a> Using the wrong color scale can be deadly … literally.</li>
<li>The python package matplotlib has a good discussion of <a href="http://matplotlib.org/users/colormaps.html">colormaps</a>.</li>
<li>Peter Kovesi <a href="https://arxiv.org/pdf/1509.03700v1.pdf">Good Color Maps: How to Design Them</a>.</li>
<li>See the <a href="https://cran.r-project.org/package=viridis">viridis</a>, <a href="https://cran.r-project.org/package=ggthemes">ggthemes</a>, <a href="https://cran.r-project.org/package=dichromat">dichromat</a>, and <a href="https://cran.r-project.org/package=pals">pals</a> packages for color palettes.</li>
</ul>
<p>Use <a href="http://docs.ggplot2.org/current/scale_identity.html">scale_identity</a> for the color and alpha scales since the values of the variables are the values of the scale itself (the color names, and the alpha values).</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb303-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">each =</span> <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb303-2" data-line-number="2">              <span class="dt">y =</span> x <span class="op">+</span><span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="dt">times =</span> <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb303-3" data-line-number="3">              <span class="dt">colour =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>), <span class="dt">each =</span> <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb303-4" data-line-number="4">              <span class="dt">alpha =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>)),</a>
<a class="sourceLine" id="cb303-5" data-line-number="5">  <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">colour =</span> colour, <span class="dt">alpha =</span> alpha)) <span class="op">+</span></a>
<a class="sourceLine" id="cb303-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">15</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb303-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_color_identity</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb303-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_alpha_identity</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb303-9" data-line-number="9"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb303-10" data-line-number="10"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="discovery_files/figure-html/color_red_black-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="united-states-presidential-elections" class="level3">
<h3><span class="header-section-number">5.3.3</span> United States Presidential Elections</h3>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb304-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;pres08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb304-2" data-line-number="2"></a>
<a class="sourceLine" id="cb304-3" data-line-number="3">pres08 &lt;-<span class="st"> </span>pres08 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb304-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Dem =</span> Obama <span class="op">/</span><span class="st"> </span>(Obama <span class="op">+</span><span class="st"> </span>McCain),</a>
<a class="sourceLine" id="cb304-5" data-line-number="5">         <span class="dt">Rep =</span> McCain <span class="op">/</span><span class="st"> </span>(Obama <span class="op">+</span><span class="st"> </span>McCain))</a></code></pre></div>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb305-1" data-line-number="1"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb305-2" data-line-number="2"><span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> <span class="st">&quot;California&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb305-3" data-line-number="3"><span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb305-4" data-line-number="4"><span class="st">  </span><span class="kw">theme_void</span>()</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-48-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb306-1" data-line-number="1">cal_color &lt;-<span class="st"> </span><span class="kw">filter</span>(pres08, state <span class="op">==</span><span class="st"> &quot;CA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb306-2" data-line-number="2">    <span class="kw">rgb</span>(<span class="dt">red =</span> .<span class="op">$</span>Rep, <span class="dt">green =</span> <span class="dv">0</span>, <span class="dt">blue =</span> .<span class="op">$</span>Dem)</a>
<a class="sourceLine" id="cb306-3" data-line-number="3">  }</a>
<a class="sourceLine" id="cb306-4" data-line-number="4"></a>
<a class="sourceLine" id="cb306-5" data-line-number="5"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb306-6" data-line-number="6"><span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> <span class="st">&quot;California&quot;</span>, <span class="dt">fill =</span> cal_color) <span class="op">+</span></a>
<a class="sourceLine" id="cb306-7" data-line-number="7"><span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb306-8" data-line-number="8"><span class="st">  </span><span class="kw">theme_void</span>()</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-49-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb307-1" data-line-number="1"><span class="co"># America as red and blue states</span></a>
<a class="sourceLine" id="cb307-2" data-line-number="2"><span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="co"># create a map</span></a>
<a class="sourceLine" id="cb307-3" data-line-number="3"><span class="cf">for</span> (i  <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(pres08)) {</a>
<a class="sourceLine" id="cb307-4" data-line-number="4">    <span class="cf">if</span> ( (pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;HI&quot;</span>) <span class="op">&amp;</span><span class="st"> </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;AK&quot;</span>) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb307-5" data-line-number="5"><span class="st">        </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;DC&quot;</span>)) {</a>
<a class="sourceLine" id="cb307-6" data-line-number="6">        <span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> pres08<span class="op">$</span>state.name[i],</a>
<a class="sourceLine" id="cb307-7" data-line-number="7">            <span class="dt">col =</span> <span class="kw">ifelse</span>(pres08<span class="op">$</span>Rep[i] <span class="op">&gt;</span><span class="st"> </span>pres08<span class="op">$</span>Dem[i], <span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>),</a>
<a class="sourceLine" id="cb307-8" data-line-number="8">            <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb307-9" data-line-number="9">    }</a>
<a class="sourceLine" id="cb307-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb307-11" data-line-number="11"></a>
<a class="sourceLine" id="cb307-12" data-line-number="12">## America as purple states</a>
<a class="sourceLine" id="cb307-13" data-line-number="13"><span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="co"># create a map</span></a>
<a class="sourceLine" id="cb307-14" data-line-number="14"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(pres08)) {</a>
<a class="sourceLine" id="cb307-15" data-line-number="15">    <span class="cf">if</span> ( (pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;HI&quot;</span>) <span class="op">&amp;</span><span class="st"> </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;AK&quot;</span>) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb307-16" data-line-number="16"><span class="st">        </span>(pres08<span class="op">$</span>state[i] <span class="op">!=</span><span class="st"> &quot;DC&quot;</span>)) {</a>
<a class="sourceLine" id="cb307-17" data-line-number="17">        <span class="kw">map</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>, <span class="dt">regions =</span> pres08<span class="op">$</span>state.name[i],</a>
<a class="sourceLine" id="cb307-18" data-line-number="18">            <span class="dt">col =</span> <span class="kw">rgb</span>(<span class="dt">red =</span> pres08<span class="op">$</span>Rep[i], <span class="dt">blue =</span> pres08<span class="op">$</span>Dem[i],</a>
<a class="sourceLine" id="cb307-19" data-line-number="19">               <span class="dt">green =</span> <span class="dv">0</span>), <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb307-20" data-line-number="20">    }</a>
<a class="sourceLine" id="cb307-21" data-line-number="21">}</a></code></pre></div>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb308-1" data-line-number="1">states &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;state&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb308-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">mutate</span>(pres08, <span class="dt">state.name =</span> <span class="kw">str_to_lower</span>(state.name)),</a>
<a class="sourceLine" id="cb308-3" data-line-number="3">            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;region&quot;</span> =<span class="st"> &quot;state.name&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb308-4" data-line-number="4"><span class="st">  </span><span class="co"># drops DC</span></a>
<a class="sourceLine" id="cb308-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(EV)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb308-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">party =</span> <span class="kw">if_else</span>(Dem <span class="op">&gt;</span><span class="st"> </span>Rep, <span class="st">&quot;Dem&quot;</span>, <span class="st">&quot;Rep&quot;</span>),</a>
<a class="sourceLine" id="cb308-7" data-line-number="7">         <span class="dt">color =</span> <span class="kw">map2_chr</span>(Dem, Rep, <span class="op">~</span><span class="st"> </span><span class="kw">rgb</span>(<span class="dt">blue =</span> .x, <span class="dt">red =</span> .y, <span class="dt">green =</span> <span class="dv">0</span>)))</a>
<a class="sourceLine" id="cb308-8" data-line-number="8"></a>
<a class="sourceLine" id="cb308-9" data-line-number="9"><span class="kw">ggplot</span>(states) <span class="op">+</span></a>
<a class="sourceLine" id="cb308-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> long, <span class="dt">y =</span> lat,</a>
<a class="sourceLine" id="cb308-11" data-line-number="11">                   <span class="dt">fill =</span> party)) <span class="op">+</span></a>
<a class="sourceLine" id="cb308-12" data-line-number="12"><span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb308-13" data-line-number="13"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Rep&quot;</span> =<span class="st"> &quot;red&quot;</span>, <span class="st">&quot;Dem&quot;</span> =<span class="st"> &quot;blue&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb308-14" data-line-number="14"><span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb308-15" data-line-number="15"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-51-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>For plotting the purple states, I use since the <code>color</code> column contains the RGB values to use in the plot:</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb309-1" data-line-number="1"><span class="kw">ggplot</span>(states) <span class="op">+</span></a>
<a class="sourceLine" id="cb309-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> long, <span class="dt">y =</span> lat,</a>
<a class="sourceLine" id="cb309-3" data-line-number="3">                   <span class="dt">fill =</span> color)) <span class="op">+</span></a>
<a class="sourceLine" id="cb309-4" data-line-number="4"><span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb309-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_fill_identity</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb309-6" data-line-number="6"><span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb309-7" data-line-number="7"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-52-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>However, plotting purple states is not a good data visualization. Even though the colors are a proportional mixture of red and blue, human visual perception doesn’t work that way.</p>
<p>The proportion of the democratic vote is best thought of a diverging scale with 0.5 is midpoint. And since the Democratic Party is associated with the color blue and the Republican Party is associated with the color red. The Color Brewer palette <a href="http://colorbrewer2.org/#type=diverging&amp;scheme=RdBu&amp;n=11">RdBu</a> is an example:</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb310-1" data-line-number="1"><span class="kw">ggplot</span>(states) <span class="op">+</span></a>
<a class="sourceLine" id="cb310-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">fill =</span> Dem)) <span class="op">+</span></a>
<a class="sourceLine" id="cb310-3" data-line-number="3"><span class="st">  </span><span class="kw">scale_fill_distiller</span>(<span class="st">&quot;% Obama&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">type =</span> <span class="st">&quot;div&quot;</span>,</a>
<a class="sourceLine" id="cb310-4" data-line-number="4">                       <span class="dt">palette =</span> <span class="st">&quot;RdBu&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb310-5" data-line-number="5"><span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb310-6" data-line-number="6"><span class="st">  </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb310-7" data-line-number="7"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>)</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-53-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="expansion-of-walmart" class="level3">
<h3><span class="header-section-number">5.3.4</span> Expansion of Walmart</h3>
<p>We don’t need to do the direct mapping since</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb311-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;walmart&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb311-2" data-line-number="2"></a>
<a class="sourceLine" id="cb311-3" data-line-number="3"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb311-4" data-line-number="4"><span class="st">  </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb311-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">colour =</span> type, <span class="dt">size =</span> size),</a>
<a class="sourceLine" id="cb311-6" data-line-number="6">             <span class="dt">data =</span> <span class="kw">mutate</span>(walmart,</a>
<a class="sourceLine" id="cb311-7" data-line-number="7">                           <span class="dt">size =</span> <span class="kw">if_else</span>(type <span class="op">==</span><span class="st"> &quot;DistributionCenter&quot;</span>, <span class="dv">2</span>, <span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb311-8" data-line-number="8">             <span class="dt">alpha =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb311-9" data-line-number="9"><span class="st">  </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb311-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_size_identity</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb311-11" data-line-number="11"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb311-12" data-line-number="12"><span class="st">  </span><span class="kw">theme_void</span>()</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-54-1.png" width="70%" style="display: block; margin: auto;" /> We don’t need to worry about colors since <code>ggplot</code> handles that. I use <a href="http://docs.ggplot2.org/current/guides.html">guides</a> to so that the colors or not transparent in the legend (see <em>R for Data Science</em> chapter<a href="http://r4ds.had.co.nz/graphics-for-communication.html">Graphics for communication</a>).</p>
<p>To make a plot showing all Walmart stores opened up through that year, I write a function, that takes the year and dataset as parameters.</p>
<p>Since I am calling the function for its side effect (printing the plot) rather than the value it returns, I use the <a href="https://www.rdocumentation.org/packages/purrr/topics/walk">walk</a> function rather than <a href="https://www.rdocumentation.org/packages/purrr/topics/map">map</a>. See <a href="http://r4ds.had.co.nz/">R for Data Science</a>, <a href="http://r4ds.had.co.nz/iteration.html#walk">Chapter 21.8: Walk</a> for more information.</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb312-1" data-line-number="1">map_walmart &lt;-<span class="st"> </span><span class="cf">function</span>(year, .data) {</a>
<a class="sourceLine" id="cb312-2" data-line-number="2">  .data &lt;-<span class="st"> </span><span class="kw">filter</span>(.data, opendate <span class="op">&lt;</span><span class="st"> </span><span class="kw">make_date</span>(year, <span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb312-3" data-line-number="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">size =</span> <span class="kw">if_else</span>(type <span class="op">==</span><span class="st"> &quot;DistributionCenter&quot;</span>, <span class="dv">2</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb312-4" data-line-number="4">  <span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb312-5" data-line-number="5"><span class="st">    </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb312-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">colour =</span> type, <span class="dt">size =</span> size),</a>
<a class="sourceLine" id="cb312-7" data-line-number="7">               <span class="dt">data =</span> .data, <span class="dt">alpha =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb312-8" data-line-number="8"><span class="st">    </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb312-9" data-line-number="9"><span class="st">    </span><span class="kw">scale_size_identity</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb312-10" data-line-number="10"><span class="st">    </span><span class="kw">guides</span>(<span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb312-11" data-line-number="11"><span class="st">    </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb312-12" data-line-number="12"><span class="st">    </span><span class="kw">ggtitle</span>(year)</a>
<a class="sourceLine" id="cb312-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb312-14" data-line-number="14"></a>
<a class="sourceLine" id="cb312-15" data-line-number="15">years &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1975</span>, <span class="dv">1985</span>, <span class="dv">1995</span>, <span class="dv">2005</span>)</a>
<a class="sourceLine" id="cb312-16" data-line-number="16"><span class="kw">walk</span>(years, <span class="op">~</span><span class="st"> </span><span class="kw">print</span>(<span class="kw">map_walmart</span>(.x, walmart)))</a></code></pre></div>
<p><img src="discovery_files/figure-html/unnamed-chunk-55-1.png" width="70%" style="display: block; margin: auto;" /><img src="discovery_files/figure-html/unnamed-chunk-55-2.png" width="70%" style="display: block; margin: auto;" /><img src="discovery_files/figure-html/unnamed-chunk-55-3.png" width="70%" style="display: block; margin: auto;" /><img src="discovery_files/figure-html/unnamed-chunk-55-4.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="animation-in-r" class="level3">
<h3><span class="header-section-number">5.3.5</span> Animation in R</h3>
<p>For easy animation with <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a>, use the <a href="https://github.com/dgrtwo/gganimate">gganimate</a> package. Note that the <strong>gganimate</strong> package is not on CRAN, so you have to install it with the <a href="https://cran.r-project.org/package=devtools">devtools</a> package:</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb313-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">&quot;cowplot&quot;</span>)</a>
<a class="sourceLine" id="cb313-2" data-line-number="2">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;dgrtwo/animate&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb314-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;gganimate&quot;</span>)</a></code></pre></div>
<p>An animation is a series of frames. The <a href="https://cran.r-project.org/package=gganimate">gganimate</a> package works by adding a <code>frame</code> aesthetic to ggplots, and function will animate the plot.</p>
<p>I use <code>frame = year(opendate)</code> to have the animation use each year as a frame, and <code>cumulative = TRUE</code> so that the previous years are shown.</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb315-1" data-line-number="1">walmart_animated &lt;-</a>
<a class="sourceLine" id="cb315-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb315-3" data-line-number="3"><span class="st">    </span><span class="kw">borders</span>(<span class="dt">database =</span> <span class="st">&quot;state&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb315-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat,</a>
<a class="sourceLine" id="cb315-5" data-line-number="5">                   <span class="dt">colour =</span> type,</a>
<a class="sourceLine" id="cb315-6" data-line-number="6">                   <span class="dt">fill =</span> type,</a>
<a class="sourceLine" id="cb315-7" data-line-number="7">                   <span class="dt">frame =</span> <span class="kw">year</span>(opendate),</a>
<a class="sourceLine" id="cb315-8" data-line-number="8">                   <span class="dt">cumulative =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb315-9" data-line-number="9">               <span class="dt">data =</span> walmart) <span class="op">+</span></a>
<a class="sourceLine" id="cb315-10" data-line-number="10"><span class="st">    </span><span class="kw">coord_quickmap</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb315-11" data-line-number="11"><span class="st">    </span><span class="kw">theme_void</span>()</a>
<a class="sourceLine" id="cb315-12" data-line-number="12"><span class="kw">gganimate</span>(walmart_animated)</a></code></pre></div>

</section>
</section>
</section>
<section id="probability" class="level1">
<h1><span class="header-section-number">6</span> Probability</h1>
<section id="prerequisites-7" class="level2 unnumbered">
<h2>Prerequisites</h2>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb316-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a>
<a class="sourceLine" id="cb316-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)</a>
<a class="sourceLine" id="cb316-3" data-line-number="3"><span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)</a>
<a class="sourceLine" id="cb316-4" data-line-number="4"><span class="kw">library</span>(<span class="st">&quot;broom&quot;</span>)</a></code></pre></div>
</section>
<section id="probability-1" class="level2">
<h2><span class="header-section-number">6.1</span> Probability</h2>
<section id="frequentist-vs.bayesian" class="level3">
<h3><span class="header-section-number">6.1.1</span> Frequentist vs. Bayesian</h3>
</section>
<section id="definition-and-axioms" class="level3">
<h3><span class="header-section-number">6.1.2</span> Definition and Axioms</h3>
</section>
<section id="permutations" class="level3">
<h3><span class="header-section-number">6.1.3</span> Permutations</h3>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb317-1" data-line-number="1">birthday &lt;-<span class="st"> </span><span class="cf">function</span>(k) {</a>
<a class="sourceLine" id="cb317-2" data-line-number="2">  logdenom &lt;-<span class="st"> </span>k <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">365</span>) <span class="op">+</span><span class="st"> </span><span class="kw">lfactorial</span>(<span class="dv">365</span> <span class="op">-</span><span class="st"> </span>k)</a>
<a class="sourceLine" id="cb317-3" data-line-number="3">  lognumer &lt;-<span class="st"> </span><span class="kw">lfactorial</span>(<span class="dv">365</span>)</a>
<a class="sourceLine" id="cb317-4" data-line-number="4">  pr &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st">   </span><span class="kw">exp</span>(lognumer <span class="op">-</span><span class="st"> </span>logdenom)</a>
<a class="sourceLine" id="cb317-5" data-line-number="5">  pr</a>
<a class="sourceLine" id="cb317-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb317-7" data-line-number="7"></a>
<a class="sourceLine" id="cb317-8" data-line-number="8">bday &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">k =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">50</span>, <span class="dt">pr =</span> <span class="kw">birthday</span>(k))</a>
<a class="sourceLine" id="cb317-9" data-line-number="9">               </a>
<a class="sourceLine" id="cb317-10" data-line-number="10"><span class="kw">ggplot</span>(bday, <span class="kw">aes</span>(<span class="dt">x =</span> k, <span class="dt">y =</span> pr)) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">0.5</span>, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb317-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb317-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="kw">str_c</span>(<span class="st">&quot;Probability that at least two&quot;</span>,</a>
<a class="sourceLine" id="cb317-15" data-line-number="15">                           <span class="st">&quot;people have the same birthday&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>),</a>
<a class="sourceLine" id="cb317-16" data-line-number="16">                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">0.1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-17" data-line-number="17"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Number of people&quot;</span>)</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-3-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><strong>Note:</strong> The logarithm is used for numerical stability. Basically, “floating-point” numbers are approximations of numbers. If you perform arithmetic with numbers that are very large, very small, or vary differently in magnitudes, you could have problems. Logarithms help with some of those issues. See “Falling Into the Floating Point Trap” in <a href="http://www.burns-stat.com/pages/Tutor/R_inferno.pdf">The R Inferno</a> for a summary of floating point numbers. See these John Fox posts <a href="http://www.johndcook.com/blog/2008/09/26/comparing-three-methods-of-computing-standard-deviation/">1</a> <a href="http://www.johndcook.com/blog/2008/09/28/theoretical-explanation-for-numerical-results/">2</a> for an example of numerical stability gone wrong. Also see: <a href="http://andrewgelman.com/2016/06/11/log-sum-of-exponentials/" class="uri">http://andrewgelman.com/2016/06/11/log-sum-of-exponentials/</a>.</p>
</section>
<section id="sampling-without-replacement" class="level3">
<h3><span class="header-section-number">6.1.4</span> Sampling without replacement</h3>
<p>Instead of using a <code>for</code> loop, we could do the simulations using a functional as described in <a href="http://r4ds.had.co.nz/">R for Data Science</a> chapter “Iterations”.</p>
<p>Define the function <code>sim_bdays</code> which randomly samples <code>k</code> birthdays, and returns <code>TRUE</code> if there are any duplicate birthdays, and <code>FALSE</code> if there are none.</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" data-line-number="1">sim_bdays &lt;-<span class="st"> </span><span class="cf">function</span>(k) {</a>
<a class="sourceLine" id="cb318-2" data-line-number="2">  days &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">365</span>, k, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb318-3" data-line-number="3">  <span class="kw">length</span>(<span class="kw">unique</span>(days)) <span class="op">&lt;</span><span class="st"> </span>k</a>
<a class="sourceLine" id="cb318-4" data-line-number="4">}</a></code></pre></div>
<p>We can test the code for <code>k = 10</code> birthdays.</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb319-1" data-line-number="1"><span class="kw">sim_bdays</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb319-2" data-line-number="2"><span class="co">#&gt; [1] FALSE</span></a></code></pre></div>
<p>Since the function is randomly sampling birthdays, running it multiple times will produce different answers.</p>
<p>One helpful feature of a functional style of writing code vs. a <code>for</code> loop is that the function encapsulates the code and allows you to test that it works for different inputs before repeating it for many inputs. It is more difficult to debug functions that produce random outputs, but some sanity checks are that the function:</p>
<ul>
<li>returns a logical vector of length one (<code>TRUE</code> or <code>FALSE</code>)</li>
<li>always returns <code>FALSE</code> when <code>k = 1</code> since there can never be a duplicates with one person</li>
<li>always returns <code>TRUE</code> when <code>k &gt; 365</code> by the <a href="https://en.wikipedia.org/wiki/Pigeonhole_principle">pidgeonhole principle</a>.</li>
</ul>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb320-1" data-line-number="1"><span class="kw">sim_bdays</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb320-2" data-line-number="2"><span class="co">#&gt; [1] FALSE</span></a>
<a class="sourceLine" id="cb320-3" data-line-number="3"><span class="kw">sim_bdays</span>(<span class="dv">366</span>)</a>
<a class="sourceLine" id="cb320-4" data-line-number="4"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>Set the parameters for 1,000 simulations, and 23 individuals. We use <code>map_lgl</code> since <code>sim_bdays</code> returns a logical value (<code>TRUE</code>, <code>FALSE</code>):</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb321-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb321-2" data-line-number="2">k &lt;-<span class="st"> </span><span class="dv">23</span></a>
<a class="sourceLine" id="cb321-3" data-line-number="3"><span class="kw">map_lgl</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">sim_bdays</span>(k)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb321-4" data-line-number="4"><span class="st">  </span><span class="kw">mean</span>()</a>
<a class="sourceLine" id="cb321-5" data-line-number="5"><span class="co">#&gt; [1] 0.475</span></a></code></pre></div>
<p>An alternative way of running this is using the <a href="https://www.rdocumentation.org/packages/purrr/topics/rerun">rerun</a> and using <code>flatten</code> to turn the output to a numeric vector:</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb322-1" data-line-number="1"><span class="kw">rerun</span>(sims, <span class="kw">sim_bdays</span>(k)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb322-2" data-line-number="2"><span class="st">  </span><span class="kw">flatten_dbl</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb322-3" data-line-number="3"><span class="st">  </span><span class="kw">mean</span>()</a>
<a class="sourceLine" id="cb322-4" data-line-number="4"><span class="co">#&gt; [1] 0.477</span></a></code></pre></div>
</section>
<section id="combinations" class="level3">
<h3><span class="header-section-number">6.1.5</span> Combinations</h3>
<p>The function for <span class="math inline">\(84\choose{6}\)</span> is:</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb323-1" data-line-number="1"><span class="kw">choose</span>(<span class="dv">84</span>, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb323-2" data-line-number="2"><span class="co">#&gt; [1] 4.06e+08</span></a></code></pre></div>
<p>However, due to the the larges values that the binomial coefficient, it is almost always better to use the log of the binomial coefficient, <span class="math inline">\(\log{84\choose{6}}\)</span>,</p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb324-1" data-line-number="1"><span class="kw">lchoose</span>(<span class="dv">84</span>, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb324-2" data-line-number="2"><span class="co">#&gt; [1] 19.8</span></a></code></pre></div>
</section>
</section>
<section id="conditional-probability" class="level2">
<h2><span class="header-section-number">6.2</span> Conditional Probability</h2>
<section id="conditional-marginal-and-joint-probabilities" class="level3">
<h3><span class="header-section-number">6.2.1</span> Conditional, Marginal, and Joint Probabilities</h3>
<p>Load Florida voting data from the <strong>qss</strong> package:</p>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb325-1" data-line-number="1"><span class="kw">data</span>(FLVoters, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb325-2" data-line-number="2"><span class="kw">dim</span>(FLVoters)</a>
<a class="sourceLine" id="cb325-3" data-line-number="3"><span class="co">#&gt; [1] 10000     6</span></a>
<a class="sourceLine" id="cb325-4" data-line-number="4"><span class="kw">glimpse</span>(FLVoters)</a>
<a class="sourceLine" id="cb325-5" data-line-number="5"><span class="co">#&gt; Observations: 10,000</span></a>
<a class="sourceLine" id="cb325-6" data-line-number="6"><span class="co">#&gt; Variables: 6</span></a>
<a class="sourceLine" id="cb325-7" data-line-number="7"><span class="co">#&gt; $ surname &lt;chr&gt; &quot;PIEDRA&quot;, &quot;LYNCH&quot;, &quot;CHESTER&quot;, &quot;LATHROP&quot;, &quot;HUMMEL&quot;, &quot;CH...</span></a>
<a class="sourceLine" id="cb325-8" data-line-number="8"><span class="co">#&gt; $ county  &lt;int&gt; 115, 115, 115, 115, 115, 115, 115, 115, 1, 1, 115, 115...</span></a>
<a class="sourceLine" id="cb325-9" data-line-number="9"><span class="co">#&gt; $ VTD     &lt;int&gt; 66, 13, 103, 80, 8, 55, 84, 48, 41, 39, 26, 45, 11, 48...</span></a>
<a class="sourceLine" id="cb325-10" data-line-number="10"><span class="co">#&gt; $ age     &lt;int&gt; 58, 51, 63, 54, 77, 49, 77, 34, 56, 60, 44, 45, 80, 83...</span></a>
<a class="sourceLine" id="cb325-11" data-line-number="11"><span class="co">#&gt; $ gender  &lt;chr&gt; &quot;f&quot;, &quot;m&quot;, &quot;m&quot;, &quot;m&quot;, &quot;f&quot;, &quot;m&quot;, &quot;f&quot;, &quot;f&quot;, &quot;f&quot;, &quot;m&quot;, &quot;m&quot;,...</span></a>
<a class="sourceLine" id="cb325-12" data-line-number="12"><span class="co">#&gt; $ race    &lt;chr&gt; &quot;white&quot;, &quot;white&quot;, NA, &quot;white&quot;, &quot;white&quot;, &quot;white&quot;, &quot;whit...</span></a>
<a class="sourceLine" id="cb325-13" data-line-number="13">FLVoters &lt;-<span class="st"> </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb325-14" data-line-number="14"><span class="st">  </span><span class="kw">na.omit</span>()</a>
<a class="sourceLine" id="cb325-15" data-line-number="15"><span class="kw">dim</span>(FLVoters)</a>
<a class="sourceLine" id="cb325-16" data-line-number="16"><span class="co">#&gt; [1] 9113    6</span></a></code></pre></div>
<p><em>Note the difference between <code>glimpse()</code> and <code>dim()</code> - what is different in how they handle NA observations?</em></p>
<p>Instead of using <a href="https://www.rdocumentation.org/packages/base/topics/prop.base">prop.base</a>, we calculate the probabilities with a data frame. Calculate the marginal probabilities of each race:</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb326-1" data-line-number="1">margin_race &lt;-</a>
<a class="sourceLine" id="cb326-2" data-line-number="2"><span class="st">  </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb326-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>(race) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb326-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb326-5" data-line-number="5">margin_race</a>
<a class="sourceLine" id="cb326-6" data-line-number="6"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb326-7" data-line-number="7"><span class="co">#&gt;   race         n    prop</span></a>
<a class="sourceLine" id="cb326-8" data-line-number="8"><span class="co">#&gt;   &lt;chr&gt;    &lt;int&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb326-9" data-line-number="9"><span class="co">#&gt; 1 asian      175 0.0192 </span></a>
<a class="sourceLine" id="cb326-10" data-line-number="10"><span class="co">#&gt; 2 black     1194 0.131  </span></a>
<a class="sourceLine" id="cb326-11" data-line-number="11"><span class="co">#&gt; 3 hispanic  1192 0.131  </span></a>
<a class="sourceLine" id="cb326-12" data-line-number="12"><span class="co">#&gt; 4 native      29 0.00318</span></a>
<a class="sourceLine" id="cb326-13" data-line-number="13"><span class="co">#&gt; 5 other      310 0.0340 </span></a>
<a class="sourceLine" id="cb326-14" data-line-number="14"><span class="co">#&gt; 6 white     6213 0.682</span></a></code></pre></div>
<p>Calculate the marginal probabilities of each gender:</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb327-1" data-line-number="1">margin_gender &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb327-2" data-line-number="2"><span class="st">  </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb327-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>(gender) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb327-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb327-5" data-line-number="5">margin_gender</a>
<a class="sourceLine" id="cb327-6" data-line-number="6"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb327-7" data-line-number="7"><span class="co">#&gt;   gender     n  prop</span></a>
<a class="sourceLine" id="cb327-8" data-line-number="8"><span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb327-9" data-line-number="9"><span class="co">#&gt; 1 f       4883 0.536</span></a>
<a class="sourceLine" id="cb327-10" data-line-number="10"><span class="co">#&gt; 2 m       4230 0.464</span></a></code></pre></div>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb328-1" data-line-number="1">FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(gender <span class="op">==</span><span class="st"> &quot;f&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>(race) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb328-5" data-line-number="5"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb328-6" data-line-number="6"><span class="co">#&gt;   race         n    prop</span></a>
<a class="sourceLine" id="cb328-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;    &lt;int&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb328-8" data-line-number="8"><span class="co">#&gt; 1 asian       83 0.0170 </span></a>
<a class="sourceLine" id="cb328-9" data-line-number="9"><span class="co">#&gt; 2 black      678 0.139  </span></a>
<a class="sourceLine" id="cb328-10" data-line-number="10"><span class="co">#&gt; 3 hispanic   666 0.136  </span></a>
<a class="sourceLine" id="cb328-11" data-line-number="11"><span class="co">#&gt; 4 native      17 0.00348</span></a>
<a class="sourceLine" id="cb328-12" data-line-number="12"><span class="co">#&gt; 5 other      158 0.0324 </span></a>
<a class="sourceLine" id="cb328-13" data-line-number="13"><span class="co">#&gt; 6 white     3281 0.672</span></a></code></pre></div>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb329-1" data-line-number="1">joint_p &lt;-</a>
<a class="sourceLine" id="cb329-2" data-line-number="2"><span class="st">  </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb329-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>(gender, race) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb329-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb329-5" data-line-number="5">joint_p</a>
<a class="sourceLine" id="cb329-6" data-line-number="6"><span class="co">#&gt; # A tibble: 12 x 4</span></a>
<a class="sourceLine" id="cb329-7" data-line-number="7"><span class="co">#&gt;   gender race         n    prop</span></a>
<a class="sourceLine" id="cb329-8" data-line-number="8"><span class="co">#&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;int&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb329-9" data-line-number="9"><span class="co">#&gt; 1 f      asian       83 0.00911</span></a>
<a class="sourceLine" id="cb329-10" data-line-number="10"><span class="co">#&gt; 2 f      black      678 0.0744 </span></a>
<a class="sourceLine" id="cb329-11" data-line-number="11"><span class="co">#&gt; 3 f      hispanic   666 0.0731 </span></a>
<a class="sourceLine" id="cb329-12" data-line-number="12"><span class="co">#&gt; 4 f      native      17 0.00187</span></a>
<a class="sourceLine" id="cb329-13" data-line-number="13"><span class="co">#&gt; 5 f      other      158 0.0173 </span></a>
<a class="sourceLine" id="cb329-14" data-line-number="14"><span class="co">#&gt; 6 f      white     3281 0.360  </span></a>
<a class="sourceLine" id="cb329-15" data-line-number="15"><span class="co">#&gt; # ... with 6 more rows</span></a></code></pre></div>
<p>We can convert the data frame to have gender as columns:</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb330-1" data-line-number="1">joint_p <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb330-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>n) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb330-3" data-line-number="3"><span class="st">  </span><span class="kw">spread</span>(gender, prop)</a>
<a class="sourceLine" id="cb330-4" data-line-number="4"><span class="co">#&gt; # A tibble: 6 x 3</span></a>
<a class="sourceLine" id="cb330-5" data-line-number="5"><span class="co">#&gt;   race           f       m</span></a>
<a class="sourceLine" id="cb330-6" data-line-number="6"><span class="co">#&gt; * &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb330-7" data-line-number="7"><span class="co">#&gt; 1 asian    0.00911 0.0101 </span></a>
<a class="sourceLine" id="cb330-8" data-line-number="8"><span class="co">#&gt; 2 black    0.0744  0.0566 </span></a>
<a class="sourceLine" id="cb330-9" data-line-number="9"><span class="co">#&gt; 3 hispanic 0.0731  0.0577 </span></a>
<a class="sourceLine" id="cb330-10" data-line-number="10"><span class="co">#&gt; 4 native   0.00187 0.00132</span></a>
<a class="sourceLine" id="cb330-11" data-line-number="11"><span class="co">#&gt; 5 other    0.0173  0.0167 </span></a>
<a class="sourceLine" id="cb330-12" data-line-number="12"><span class="co">#&gt; 6 white    0.360   0.322</span></a></code></pre></div>
<p>Sum over race:</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb331-1" data-line-number="1">joint_p <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb331-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(race) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb331-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prop =</span> <span class="kw">sum</span>(prop))</a>
<a class="sourceLine" id="cb331-4" data-line-number="4"><span class="co">#&gt; # A tibble: 6 x 2</span></a>
<a class="sourceLine" id="cb331-5" data-line-number="5"><span class="co">#&gt;   race        prop</span></a>
<a class="sourceLine" id="cb331-6" data-line-number="6"><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb331-7" data-line-number="7"><span class="co">#&gt; 1 asian    0.0192 </span></a>
<a class="sourceLine" id="cb331-8" data-line-number="8"><span class="co">#&gt; 2 black    0.131  </span></a>
<a class="sourceLine" id="cb331-9" data-line-number="9"><span class="co">#&gt; 3 hispanic 0.131  </span></a>
<a class="sourceLine" id="cb331-10" data-line-number="10"><span class="co">#&gt; 4 native   0.00318</span></a>
<a class="sourceLine" id="cb331-11" data-line-number="11"><span class="co">#&gt; 5 other    0.0340 </span></a>
<a class="sourceLine" id="cb331-12" data-line-number="12"><span class="co">#&gt; 6 white    0.682</span></a></code></pre></div>
<p>Sum over gender:</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb332-1" data-line-number="1">joint_p <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb332-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(gender) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb332-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prop =</span> <span class="kw">sum</span>(prop))</a>
<a class="sourceLine" id="cb332-4" data-line-number="4"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb332-5" data-line-number="5"><span class="co">#&gt;   gender  prop</span></a>
<a class="sourceLine" id="cb332-6" data-line-number="6"><span class="co">#&gt;   &lt;chr&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb332-7" data-line-number="7"><span class="co">#&gt; 1 f      0.536</span></a>
<a class="sourceLine" id="cb332-8" data-line-number="8"><span class="co">#&gt; 2 m      0.464</span></a></code></pre></div>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb333-1" data-line-number="1">FLVoters &lt;-</a>
<a class="sourceLine" id="cb333-2" data-line-number="2"><span class="st">  </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb333-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age_group =</span> <span class="kw">cut</span>(age, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">20</span>, <span class="dv">40</span>, <span class="dv">60</span>, <span class="ot">Inf</span>), <span class="dt">right =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb333-4" data-line-number="4">                         <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;&lt;= 20&quot;</span>, <span class="st">&quot;20-40&quot;</span>, <span class="st">&quot;40-60&quot;</span>, <span class="st">&quot;&gt; 60&quot;</span>)))</a></code></pre></div>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb334-1" data-line-number="1">joint3 &lt;-</a>
<a class="sourceLine" id="cb334-2" data-line-number="2"><span class="st">  </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb334-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>(race, age_group, gender) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb334-4" data-line-number="4"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb334-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb334-6" data-line-number="6">joint3</a>
<a class="sourceLine" id="cb334-7" data-line-number="7"><span class="co">#&gt; # A tibble: 47 x 5</span></a>
<a class="sourceLine" id="cb334-8" data-line-number="8"><span class="co">#&gt;   race  age_group gender     n     prop</span></a>
<a class="sourceLine" id="cb334-9" data-line-number="9"><span class="co">#&gt;   &lt;chr&gt; &lt;fctr&gt;    &lt;chr&gt;  &lt;int&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb334-10" data-line-number="10"><span class="co">#&gt; 1 asian &lt;= 20     f          1 0.000110</span></a>
<a class="sourceLine" id="cb334-11" data-line-number="11"><span class="co">#&gt; 2 asian &lt;= 20     m          2 0.000219</span></a>
<a class="sourceLine" id="cb334-12" data-line-number="12"><span class="co">#&gt; 3 asian 20-40     f         24 0.00263 </span></a>
<a class="sourceLine" id="cb334-13" data-line-number="13"><span class="co">#&gt; 4 asian 20-40     m         26 0.00285 </span></a>
<a class="sourceLine" id="cb334-14" data-line-number="14"><span class="co">#&gt; 5 asian 40-60     f         38 0.00417 </span></a>
<a class="sourceLine" id="cb334-15" data-line-number="15"><span class="co">#&gt; 6 asian 40-60     m         47 0.00516 </span></a>
<a class="sourceLine" id="cb334-16" data-line-number="16"><span class="co">#&gt; # ... with 41 more rows</span></a></code></pre></div>
<p>Marginal probabilities by age groups</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb335-1" data-line-number="1">margin_age &lt;-</a>
<a class="sourceLine" id="cb335-2" data-line-number="2"><span class="st">  </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb335-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>(age_group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb335-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb335-5" data-line-number="5">margin_age</a>
<a class="sourceLine" id="cb335-6" data-line-number="6"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb335-7" data-line-number="7"><span class="co">#&gt;   age_group     n   prop</span></a>
<a class="sourceLine" id="cb335-8" data-line-number="8"><span class="co">#&gt;   &lt;fctr&gt;    &lt;int&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb335-9" data-line-number="9"><span class="co">#&gt; 1 &lt;= 20       161 0.0177</span></a>
<a class="sourceLine" id="cb335-10" data-line-number="10"><span class="co">#&gt; 2 20-40      2469 0.271 </span></a>
<a class="sourceLine" id="cb335-11" data-line-number="11"><span class="co">#&gt; 3 40-60      3285 0.360 </span></a>
<a class="sourceLine" id="cb335-12" data-line-number="12"><span class="co">#&gt; 4 &gt; 60       3198 0.351</span></a></code></pre></div>
<p>Calculate the probabilities that each group is in a given age group, and show <span class="math inline">\(P(\text{black} \land \text{female} \land \text{age} &gt; 60)\)</span>: (<em>Note: the symbol <span class="math inline">\(\land\)</span> is the logical symbol for ‘and’, implying the joint probability.</em>)</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb336-1" data-line-number="1"><span class="kw">left_join</span>(joint3,</a>
<a class="sourceLine" id="cb336-2" data-line-number="2">          <span class="kw">select</span>(margin_age, age_group, <span class="dt">margin_age =</span> prop),</a>
<a class="sourceLine" id="cb336-3" data-line-number="3">          <span class="dt">by =</span> <span class="st">&quot;age_group&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob_age_group =</span> prop <span class="op">/</span><span class="st"> </span>margin_age) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(race <span class="op">==</span><span class="st"> &quot;black&quot;</span>, gender <span class="op">==</span><span class="st"> &quot;f&quot;</span>, age_group <span class="op">==</span><span class="st"> &quot;&gt; 60&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(race, age_group, gender, prob_age_group)</a>
<a class="sourceLine" id="cb336-7" data-line-number="7"><span class="co">#&gt; # A tibble: 1 x 4</span></a>
<a class="sourceLine" id="cb336-8" data-line-number="8"><span class="co">#&gt;   race  age_group gender prob_age_group</span></a>
<a class="sourceLine" id="cb336-9" data-line-number="9"><span class="co">#&gt;   &lt;chr&gt; &lt;fctr&gt;    &lt;chr&gt;           &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb336-10" data-line-number="10"><span class="co">#&gt; 1 black &gt; 60      f              0.0538</span></a></code></pre></div>
<p>Two-way joint probability table for age group and gender</p>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb337-1" data-line-number="1">joint2 &lt;-<span class="st"> </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb337-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(age_group, gender) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb337-3" data-line-number="3"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb337-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob_age_gender =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb337-5" data-line-number="5">joint2</a>
<a class="sourceLine" id="cb337-6" data-line-number="6"><span class="co">#&gt; # A tibble: 8 x 4</span></a>
<a class="sourceLine" id="cb337-7" data-line-number="7"><span class="co">#&gt;   age_group gender     n prob_age_gender</span></a>
<a class="sourceLine" id="cb337-8" data-line-number="8"><span class="co">#&gt;   &lt;fctr&gt;    &lt;chr&gt;  &lt;int&gt;           &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb337-9" data-line-number="9"><span class="co">#&gt; 1 &lt;= 20     f         88         0.00966</span></a>
<a class="sourceLine" id="cb337-10" data-line-number="10"><span class="co">#&gt; 2 &lt;= 20     m         73         0.00801</span></a>
<a class="sourceLine" id="cb337-11" data-line-number="11"><span class="co">#&gt; 3 20-40     f       1304         0.143  </span></a>
<a class="sourceLine" id="cb337-12" data-line-number="12"><span class="co">#&gt; 4 20-40     m       1165         0.128  </span></a>
<a class="sourceLine" id="cb337-13" data-line-number="13"><span class="co">#&gt; 5 40-60     f       1730         0.190  </span></a>
<a class="sourceLine" id="cb337-14" data-line-number="14"><span class="co">#&gt; 6 40-60     m       1555         0.171  </span></a>
<a class="sourceLine" id="cb337-15" data-line-number="15"><span class="co">#&gt; # ... with 2 more rows</span></a></code></pre></div>
<p>The joint probability <span class="math inline">\(P(\text{age} &gt; 60 \land \text{female})\)</span>,</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb338-1" data-line-number="1">joint2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb338-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(age_group <span class="op">==</span><span class="st"> &quot;&gt; 60&quot;</span>, gender <span class="op">==</span><span class="st"> &quot;f&quot;</span>)</a>
<a class="sourceLine" id="cb338-3" data-line-number="3"><span class="co">#&gt; # A tibble: 1 x 4</span></a>
<a class="sourceLine" id="cb338-4" data-line-number="4"><span class="co">#&gt;   age_group gender     n prob_age_gender</span></a>
<a class="sourceLine" id="cb338-5" data-line-number="5"><span class="co">#&gt;   &lt;fctr&gt;    &lt;chr&gt;  &lt;int&gt;           &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb338-6" data-line-number="6"><span class="co">#&gt; 1 &gt; 60      f       1761           0.193</span></a></code></pre></div>
<p>The conditional probabilities <span class="math inline">\(P(\text{race } | \text{ gender, age})\)</span>,</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb339-1" data-line-number="1">condprob_race &lt;-</a>
<a class="sourceLine" id="cb339-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(joint3, <span class="kw">select</span>(joint2, <span class="op">-</span>n), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;age_group&quot;</span>, <span class="st">&quot;gender&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb339-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob_race =</span> prop <span class="op">/</span><span class="st"> </span>prob_age_gender) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb339-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(age_group, gender) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb339-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(age_group, gender, race, prob_race)</a></code></pre></div>
<p>Each row is the <span class="math inline">\(P(\text{race } | \text{ age group} \land \text{gender})\)</span>, so <span class="math inline">\(P(\text{black } | \text{ female} \land \text{age} &gt; 60)\)</span>,</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb340-1" data-line-number="1"><span class="kw">filter</span>(condprob_race, gender <span class="op">==</span><span class="st"> &quot;f&quot;</span>, age_group <span class="op">==</span><span class="st"> &quot;&gt; 60&quot;</span>, race <span class="op">==</span><span class="st"> &quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb340-2" data-line-number="2"><span class="co">#&gt; # A tibble: 1 x 4</span></a>
<a class="sourceLine" id="cb340-3" data-line-number="3"><span class="co">#&gt;   age_group gender race  prob_race</span></a>
<a class="sourceLine" id="cb340-4" data-line-number="4"><span class="co">#&gt;   &lt;fctr&gt;    &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb340-5" data-line-number="5"><span class="co">#&gt; 1 &gt; 60      f      black    0.0977</span></a></code></pre></div>
</section>
<section id="independence" class="level3">
<h3><span class="header-section-number">6.2.2</span> Independence</h3>
<p>Create a table with the products of margins of race and age. Using the function <a href="https://www.rdocumentation.org/packages/tidyr/topics/crossing">crossing</a> to create a tibble with all combinations of race and gender and the independent prob.</p>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb341-1" data-line-number="1">race_gender_indep &lt;-</a>
<a class="sourceLine" id="cb341-2" data-line-number="2"><span class="st">  </span><span class="kw">crossing</span>(<span class="kw">select</span>(margin_race, race, <span class="dt">prob_race =</span> prop),</a>
<a class="sourceLine" id="cb341-3" data-line-number="3">           <span class="kw">select</span>(margin_gender, gender, <span class="dt">prob_gender =</span> prop)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb341-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob_indep =</span> prob_race <span class="op">*</span><span class="st"> </span>prob_gender) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb341-5" data-line-number="5"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">select</span>(joint_p, gender, race, <span class="dt">prob =</span> prop),</a>
<a class="sourceLine" id="cb341-6" data-line-number="6">            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;gender&quot;</span>, <span class="st">&quot;race&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb341-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(race, gender, <span class="kw">everything</span>())</a>
<a class="sourceLine" id="cb341-8" data-line-number="8">race_gender_indep</a>
<a class="sourceLine" id="cb341-9" data-line-number="9"><span class="co">#&gt; # A tibble: 12 x 6</span></a>
<a class="sourceLine" id="cb341-10" data-line-number="10"><span class="co">#&gt;   race     gender prob_race prob_gender prob_indep    prob</span></a>
<a class="sourceLine" id="cb341-11" data-line-number="11"><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb341-12" data-line-number="12"><span class="co">#&gt; 1 asian    f         0.0192       0.536    0.0103  0.00911</span></a>
<a class="sourceLine" id="cb341-13" data-line-number="13"><span class="co">#&gt; 2 asian    m         0.0192       0.464    0.00891 0.0101 </span></a>
<a class="sourceLine" id="cb341-14" data-line-number="14"><span class="co">#&gt; 3 black    f         0.131        0.536    0.0702  0.0744 </span></a>
<a class="sourceLine" id="cb341-15" data-line-number="15"><span class="co">#&gt; 4 black    m         0.131        0.464    0.0608  0.0566 </span></a>
<a class="sourceLine" id="cb341-16" data-line-number="16"><span class="co">#&gt; 5 hispanic f         0.131        0.536    0.0701  0.0731 </span></a>
<a class="sourceLine" id="cb341-17" data-line-number="17"><span class="co">#&gt; 6 hispanic m         0.131        0.464    0.0607  0.0577 </span></a>
<a class="sourceLine" id="cb341-18" data-line-number="18"><span class="co">#&gt; # ... with 6 more rows</span></a></code></pre></div>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb342-1" data-line-number="1"><span class="kw">ggplot</span>(race_gender_indep,</a>
<a class="sourceLine" id="cb342-2" data-line-number="2">       <span class="kw">aes</span>(<span class="dt">x =</span> prob_indep, <span class="dt">y =</span> prob, <span class="dt">colour =</span> race)) <span class="op">+</span></a>
<a class="sourceLine" id="cb342-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb342-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb342-5" data-line-number="5"><span class="st">  </span><span class="kw">facet_grid</span>(. <span class="op">~</span><span class="st"> </span>gender) <span class="op">+</span></a>
<a class="sourceLine" id="cb342-6" data-line-number="6"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb342-7" data-line-number="7"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb342-8" data-line-number="8"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="kw">expression</span>(<span class="kw">P</span>(<span class="st">&quot;race&quot;</span>) <span class="op">*</span><span class="st"> </span><span class="kw">P</span>(<span class="st">&quot;gender&quot;</span>)),</a>
<a class="sourceLine" id="cb342-9" data-line-number="9">       <span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">P</span>(<span class="st">&quot;race and gender&quot;</span>)))</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-19-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>While the original code only calculates joint-independence value for values of age &gt; 60, and female, this calculates the joint probabilities for all combinations of the three variables, and facets by age and gender.</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb343-1" data-line-number="1">joint_indep &lt;-</a>
<a class="sourceLine" id="cb343-2" data-line-number="2"><span class="st">  </span><span class="kw">crossing</span>(<span class="kw">select</span>(margin_race, race, <span class="dt">prob_race =</span> prop),</a>
<a class="sourceLine" id="cb343-3" data-line-number="3">           <span class="kw">select</span>(margin_age, age_group, <span class="dt">prob_age =</span> prop),</a>
<a class="sourceLine" id="cb343-4" data-line-number="4">           <span class="kw">select</span>(margin_gender, gender, <span class="dt">prob_gender =</span> prop)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb343-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">indep_prob =</span> prob_race <span class="op">*</span><span class="st"> </span>prob_age <span class="op">*</span><span class="st"> </span>prob_gender) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb343-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">select</span>(joint3, race, age_group, gender, <span class="dt">prob =</span> prop),</a>
<a class="sourceLine" id="cb343-7" data-line-number="7">            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;gender&quot;</span>, <span class="st">&quot;age_group&quot;</span>, <span class="st">&quot;race&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb343-8" data-line-number="8"><span class="st">  </span><span class="kw">replace_na</span>(<span class="kw">list</span>(<span class="dt">prob =</span> <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb343-9" data-line-number="9"></a>
<a class="sourceLine" id="cb343-10" data-line-number="10"><span class="kw">ggplot</span>(joint_indep, <span class="kw">aes</span>(<span class="dt">x =</span> prob, <span class="dt">y =</span> indep_prob, <span class="dt">colour =</span> race)) <span class="op">+</span></a>
<a class="sourceLine" id="cb343-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb343-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb343-13" data-line-number="13"><span class="st">  </span><span class="kw">facet_grid</span>(age_group <span class="op">~</span><span class="st"> </span>gender) <span class="op">+</span></a>
<a class="sourceLine" id="cb343-14" data-line-number="14"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb343-15" data-line-number="15"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;P(race and age and gender)&quot;</span>,</a>
<a class="sourceLine" id="cb343-16" data-line-number="16">       <span class="dt">y =</span> <span class="st">&quot;P(race) * P(age) * P(gender)&quot;</span>,</a>
<a class="sourceLine" id="cb343-17" data-line-number="17">       <span class="dt">title =</span> <span class="st">&quot;Joint Independence&quot;</span>)</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-20-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>While code in <em>QSS</em> only calculates the conditional independence given female, the following code calculates conditional independence for all values of <code>gender</code>:</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb344-1" data-line-number="1">cond_gender &lt;-</a>
<a class="sourceLine" id="cb344-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">select</span>(joint3, race, age_group, gender, <span class="dt">joint_prob =</span> prop),</a>
<a class="sourceLine" id="cb344-3" data-line-number="3">            <span class="kw">select</span>(margin_gender, gender, <span class="dt">prob_gender =</span> prop),</a>
<a class="sourceLine" id="cb344-4" data-line-number="4">            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;gender&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb344-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cond_prob =</span> joint_prob <span class="op">/</span><span class="st"> </span>prob_gender)</a></code></pre></div>
<p>Calculate the conditional distribution <span class="math inline">\(\Pr(\text{race} | \text{gender})\)</span>:</p>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb345-1" data-line-number="1">prob_race_gender &lt;-</a>
<a class="sourceLine" id="cb345-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">select</span>(joint_p, race, gender, <span class="dt">prob_race_gender =</span> prop),</a>
<a class="sourceLine" id="cb345-3" data-line-number="3">            <span class="kw">select</span>(margin_gender, gender, <span class="dt">prob_gender =</span> prop),</a>
<a class="sourceLine" id="cb345-4" data-line-number="4">            <span class="dt">by =</span> <span class="st">&quot;gender&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb345-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob_race =</span> prob_race_gender <span class="op">/</span><span class="st"> </span>prob_gender)</a></code></pre></div>
<p>Calculate the conditional distribution <span class="math inline">\(\Pr(\text{age} | \text{gender})\)</span>:</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb346-1" data-line-number="1">prob_age_gender &lt;-</a>
<a class="sourceLine" id="cb346-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">select</span>(joint2, age_group, gender, prob_age_gender),</a>
<a class="sourceLine" id="cb346-3" data-line-number="3">            <span class="kw">select</span>(margin_gender, gender, <span class="dt">prob_gender =</span> prop),</a>
<a class="sourceLine" id="cb346-4" data-line-number="4">            <span class="dt">by =</span> <span class="st">&quot;gender&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb346-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob_age =</span> prob_age_gender <span class="op">/</span><span class="st"> </span>prob_gender)</a>
<a class="sourceLine" id="cb346-6" data-line-number="6"></a>
<a class="sourceLine" id="cb346-7" data-line-number="7"><span class="co"># indep prob of race and age</span></a>
<a class="sourceLine" id="cb346-8" data-line-number="8">indep_cond_gender &lt;-</a>
<a class="sourceLine" id="cb346-9" data-line-number="9"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">select</span>(prob_race_gender, race, gender, prob_race),</a>
<a class="sourceLine" id="cb346-10" data-line-number="10">            <span class="kw">select</span>(prob_age_gender, age_group, gender, prob_age),</a>
<a class="sourceLine" id="cb346-11" data-line-number="11">            <span class="dt">by =</span> <span class="st">&quot;gender&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb346-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">indep_prob =</span> prob_race <span class="op">*</span><span class="st"> </span>prob_age)</a>
<a class="sourceLine" id="cb346-13" data-line-number="13"></a>
<a class="sourceLine" id="cb346-14" data-line-number="14"><span class="kw">inner_join</span>(<span class="kw">select</span>(indep_cond_gender, race, age_group, gender, indep_prob),</a>
<a class="sourceLine" id="cb346-15" data-line-number="15">           <span class="kw">select</span>(cond_gender, race, age_group, gender, cond_prob),</a>
<a class="sourceLine" id="cb346-16" data-line-number="16">           <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;gender&quot;</span>, <span class="st">&quot;age_group&quot;</span>, <span class="st">&quot;race&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb346-17" data-line-number="17"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> cond_prob, <span class="dt">y =</span> indep_prob, <span class="dt">colour =</span> race)) <span class="op">+</span></a>
<a class="sourceLine" id="cb346-18" data-line-number="18"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb346-19" data-line-number="19"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb346-20" data-line-number="20"><span class="st">  </span><span class="kw">facet_grid</span>(age_group <span class="op">~</span><span class="st"> </span>gender) <span class="op">+</span></a>
<a class="sourceLine" id="cb346-21" data-line-number="21"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb346-22" data-line-number="22"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;P(race and age | gender)&quot;</span>,</a>
<a class="sourceLine" id="cb346-23" data-line-number="23">       <span class="dt">y =</span> <span class="st">&quot;P(race | gender) * P(age | gender)&quot;</span>,</a>
<a class="sourceLine" id="cb346-24" data-line-number="24">       <span class="dt">title =</span> <span class="st">&quot;Marginal independence&quot;</span>)</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-23-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><strong>Monty-hall problem</strong></p>
<p>The <code>for</code> loop approach in <em>QSS</em> is valid code, but here we provide a more functional approach to solving the problem. We will define a function to choose a door, repeat the function multiple times while storing the results in a data frame, and then summarize that data frame.</p>
<p>First, create a function for a single iteration. This returns a single logical value:</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb347-1" data-line-number="1">choose_door &lt;-<span class="st"> </span><span class="cf">function</span>(.iter) {</a>
<a class="sourceLine" id="cb347-2" data-line-number="2">  <span class="co"># what&#39;s behind each door door:</span></a>
<a class="sourceLine" id="cb347-3" data-line-number="3">  <span class="co"># Why is it okay that this is fixed?</span></a>
<a class="sourceLine" id="cb347-4" data-line-number="4">  doors &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;goat&quot;</span>, <span class="st">&quot;goat&quot;</span>, <span class="st">&quot;car&quot;</span>)</a>
<a class="sourceLine" id="cb347-5" data-line-number="5"></a>
<a class="sourceLine" id="cb347-6" data-line-number="6">  <span class="co"># User randomly chooses a door</span></a>
<a class="sourceLine" id="cb347-7" data-line-number="7">  first &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb347-8" data-line-number="8"></a>
<a class="sourceLine" id="cb347-9" data-line-number="9">  <span class="co"># randomly choose the door that Monty Hall reveals</span></a>
<a class="sourceLine" id="cb347-10" data-line-number="10">  remain &lt;-<span class="st"> </span>doors[<span class="op">-</span>first]</a>
<a class="sourceLine" id="cb347-11" data-line-number="11">  monty &lt;-<span class="st"> </span><span class="kw">sample</span>( (<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)[remain <span class="op">==</span><span class="st"> &quot;goat&quot;</span>], <span class="dt">size =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb347-12" data-line-number="12">  <span class="co"># did the contestant win?</span></a>
<a class="sourceLine" id="cb347-13" data-line-number="13">  <span class="kw">tibble</span>(<span class="dt">.iter =</span> .iter,</a>
<a class="sourceLine" id="cb347-14" data-line-number="14">         <span class="dt">result =</span> remain[<span class="op">-</span>monty] <span class="op">==</span><span class="st"> &quot;car&quot;</span>)</a>
<a class="sourceLine" id="cb347-15" data-line-number="15">}</a></code></pre></div>
<p>Now use <a href="https://www.rdocumentation.org/packages/purrr/topics/map_df">map_df</a> to run <code>choose_door</code> multiple times, and then summarize the results:</p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb348-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb348-2" data-line-number="2"><span class="kw">map_df</span>(<span class="kw">seq_len</span>(sims), choose_door) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb348-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">win_pct =</span> <span class="kw">mean</span>(result))</a>
<a class="sourceLine" id="cb348-4" data-line-number="4"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb348-5" data-line-number="5"><span class="co">#&gt;   win_pct</span></a>
<a class="sourceLine" id="cb348-6" data-line-number="6"><span class="co">#&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb348-7" data-line-number="7"><span class="co">#&gt; 1   0.670</span></a></code></pre></div>
</section>
<section id="bayes-rule" class="level3">
<h3><span class="header-section-number">6.2.3</span> Bayes’ Rule</h3>
</section>
<section id="predicting-race-using-surname-and-residence-location" class="level3">
<h3><span class="header-section-number">6.2.4</span> Predicting Race Using Surname and Residence Location</h3>
<p>Start with the Census names files:</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb349-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;cnames&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb349-2" data-line-number="2"><span class="kw">glimpse</span>(cnames)</a>
<a class="sourceLine" id="cb349-3" data-line-number="3"><span class="co">#&gt; Observations: 151,671</span></a>
<a class="sourceLine" id="cb349-4" data-line-number="4"><span class="co">#&gt; Variables: 7</span></a>
<a class="sourceLine" id="cb349-5" data-line-number="5"><span class="co">#&gt; $ surname     &lt;chr&gt; &quot;SMITH&quot;, &quot;JOHNSON&quot;, &quot;WILLIAMS&quot;, &quot;BROWN&quot;, &quot;JONES&quot;, ...</span></a>
<a class="sourceLine" id="cb349-6" data-line-number="6"><span class="co">#&gt; $ count       &lt;int&gt; 2376206, 1857160, 1534042, 1380145, 1362755, 11278...</span></a>
<a class="sourceLine" id="cb349-7" data-line-number="7"><span class="co">#&gt; $ pctwhite    &lt;dbl&gt; 73.34, 61.55, 48.52, 60.72, 57.69, 85.80, 64.73, 6...</span></a>
<a class="sourceLine" id="cb349-8" data-line-number="8"><span class="co">#&gt; $ pctblack    &lt;dbl&gt; 22.22, 33.80, 46.72, 34.54, 37.73, 10.41, 30.77, 0...</span></a>
<a class="sourceLine" id="cb349-9" data-line-number="9"><span class="co">#&gt; $ pctapi      &lt;dbl&gt; 0.40, 0.42, 0.37, 0.41, 0.35, 0.42, 0.40, 1.43, 0....</span></a>
<a class="sourceLine" id="cb349-10" data-line-number="10"><span class="co">#&gt; $ pcthispanic &lt;dbl&gt; 1.56, 1.50, 1.60, 1.64, 1.44, 1.43, 1.58, 90.82, 9...</span></a>
<a class="sourceLine" id="cb349-11" data-line-number="11"><span class="co">#&gt; $ pctothers   &lt;dbl&gt; 2.48, 2.73, 2.79, 2.69, 2.79, 1.94, 2.52, 1.09, 0....</span></a></code></pre></div>
<p>For each surname, <code>cnames</code> contains variables with the probability that it belongs to an individual of a given race (<code>pctwhite</code>, <code>pctblack</code>, …). We want to find the most-likely race for a given surname, by finding the race with the maximum proportion. Instead of dealing with multiple variables, it is easier to use <code>max</code> on a single variable, so we will rearrange the data to in order to use a grouped summarize, and then merge the new variable back to the original data sets. We will also remove the ‘pct’ prefix from each of the variable names.</p>
<p>Calculate the most likely race for each name:</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb350-1" data-line-number="1">most_likely_race &lt;-</a>
<a class="sourceLine" id="cb350-2" data-line-number="2"><span class="st">  </span>cnames <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>count) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-4" data-line-number="4"><span class="st">  </span><span class="kw">gather</span>(race_pred, pct, <span class="op">-</span>surname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-5" data-line-number="5"><span class="st">  </span><span class="co"># remove pct_ prefix from variable names</span></a>
<a class="sourceLine" id="cb350-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">race_pred =</span> <span class="kw">str_replace</span>(race_pred, <span class="st">&quot;^pct&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-7" data-line-number="7"><span class="st">  </span><span class="co"># # group by surname</span></a>
<a class="sourceLine" id="cb350-8" data-line-number="8"><span class="st">  </span><span class="kw">group_by</span>(surname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-9" data-line-number="9"><span class="st">  </span><span class="co"># select obs with the largest percentage</span></a>
<a class="sourceLine" id="cb350-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">row_number</span>(<span class="kw">desc</span>(pct)) <span class="op">==</span><span class="st"> </span>1L) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-11" data-line-number="11"><span class="st">  </span><span class="co"># Ungroup to avoid errors later</span></a>
<a class="sourceLine" id="cb350-12" data-line-number="12"><span class="st">  </span>ungroup <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-13" data-line-number="13"><span class="st">  </span><span class="co"># # don&#39;t need pct anymore</span></a>
<a class="sourceLine" id="cb350-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>pct) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb350-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">race_pred =</span> <span class="kw">recode</span>(race_pred, <span class="dt">asian =</span> <span class="st">&quot;api&quot;</span>, <span class="dt">other =</span> <span class="st">&quot;others&quot;</span>))</a></code></pre></div>
<p>Merge the data frame with the most likely race for each surname to the the original <code>cnames</code> data frame:</p>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb351-1" data-line-number="1">cnames &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb351-2" data-line-number="2"><span class="st">  </span>cnames <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb351-3" data-line-number="3"><span class="st">  </span><span class="kw">left_join</span>(most_likely_race, <span class="dt">by =</span> <span class="st">&quot;surname&quot;</span>)</a></code></pre></div>
<p>Instead of using <code>match</code>, use <code>inner_join</code> to merge the surnames to <code>FLVoters</code>:</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb352-1" data-line-number="1">FLVoters &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb352-2" data-line-number="2"><span class="st">  </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb352-3" data-line-number="3"><span class="st">  </span><span class="kw">inner_join</span>(cnames, <span class="dt">by =</span> <span class="st">&quot;surname&quot;</span>)</a>
<a class="sourceLine" id="cb352-4" data-line-number="4"><span class="kw">dim</span>(FLVoters)</a>
<a class="sourceLine" id="cb352-5" data-line-number="5"><span class="co">#&gt; [1] 8022   14</span></a></code></pre></div>
<p><code>FLVoters</code> also includes a “native” category that the surname dataset does not.</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb353-1" data-line-number="1">FLVoters &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb353-2" data-line-number="2"><span class="st">  </span>FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb353-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">race2 =</span> <span class="kw">fct_recode</span>(race, <span class="dt">other =</span> <span class="st">&quot;native&quot;</span>))</a></code></pre></div>
<p>Check that the levels of <code>race</code> and <code>race_pred</code> are the same:</p>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb354-1" data-line-number="1">FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb354-2" data-line-number="2"><span class="st">  </span><span class="kw">count</span>(race2)</a>
<a class="sourceLine" id="cb354-3" data-line-number="3"><span class="co">#&gt; # A tibble: 5 x 2</span></a>
<a class="sourceLine" id="cb354-4" data-line-number="4"><span class="co">#&gt;   race2        n</span></a>
<a class="sourceLine" id="cb354-5" data-line-number="5"><span class="co">#&gt;   &lt;fctr&gt;   &lt;int&gt;</span></a>
<a class="sourceLine" id="cb354-6" data-line-number="6"><span class="co">#&gt; 1 asian      140</span></a>
<a class="sourceLine" id="cb354-7" data-line-number="7"><span class="co">#&gt; 2 black     1078</span></a>
<a class="sourceLine" id="cb354-8" data-line-number="8"><span class="co">#&gt; 3 hispanic  1023</span></a>
<a class="sourceLine" id="cb354-9" data-line-number="9"><span class="co">#&gt; 4 other      277</span></a>
<a class="sourceLine" id="cb354-10" data-line-number="10"><span class="co">#&gt; 5 white     5504</span></a>
<a class="sourceLine" id="cb354-11" data-line-number="11">FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb354-12" data-line-number="12"><span class="st">  </span><span class="kw">count</span>(race_pred)</a>
<a class="sourceLine" id="cb354-13" data-line-number="13"><span class="co">#&gt; # A tibble: 5 x 2</span></a>
<a class="sourceLine" id="cb354-14" data-line-number="14"><span class="co">#&gt;   race_pred     n</span></a>
<a class="sourceLine" id="cb354-15" data-line-number="15"><span class="co">#&gt;   &lt;chr&gt;     &lt;int&gt;</span></a>
<a class="sourceLine" id="cb354-16" data-line-number="16"><span class="co">#&gt; 1 api         120</span></a>
<a class="sourceLine" id="cb354-17" data-line-number="17"><span class="co">#&gt; 2 black       258</span></a>
<a class="sourceLine" id="cb354-18" data-line-number="18"><span class="co">#&gt; 3 hispanic   1121</span></a>
<a class="sourceLine" id="cb354-19" data-line-number="19"><span class="co">#&gt; 4 others        7</span></a>
<a class="sourceLine" id="cb354-20" data-line-number="20"><span class="co">#&gt; 5 white      6516</span></a></code></pre></div>
<p>Now we can calculate <em>True positive rate</em> for <em>all</em> races</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb355-1" data-line-number="1">FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb355-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(race2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb355-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">tp =</span> <span class="kw">mean</span>(race2 <span class="op">==</span><span class="st"> </span>race_pred)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb355-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(tp))</a>
<a class="sourceLine" id="cb355-5" data-line-number="5"><span class="co">#&gt; # A tibble: 5 x 2</span></a>
<a class="sourceLine" id="cb355-6" data-line-number="6"><span class="co">#&gt;   race2       tp</span></a>
<a class="sourceLine" id="cb355-7" data-line-number="7"><span class="co">#&gt;   &lt;fctr&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb355-8" data-line-number="8"><span class="co">#&gt; 1 white    0.950</span></a>
<a class="sourceLine" id="cb355-9" data-line-number="9"><span class="co">#&gt; 2 hispanic 0.847</span></a>
<a class="sourceLine" id="cb355-10" data-line-number="10"><span class="co">#&gt; 3 black    0.160</span></a>
<a class="sourceLine" id="cb355-11" data-line-number="11"><span class="co">#&gt; 4 asian    0    </span></a>
<a class="sourceLine" id="cb355-12" data-line-number="12"><span class="co">#&gt; 5 other    0</span></a></code></pre></div>
<p>and the <em>False discovery rate</em> for <em>all</em> races,</p>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb356-1" data-line-number="1">FLVoters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb356-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(race_pred) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb356-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">fp =</span> <span class="kw">mean</span>(race2 <span class="op">!=</span><span class="st"> </span>race_pred)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb356-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(fp))</a>
<a class="sourceLine" id="cb356-5" data-line-number="5"><span class="co">#&gt; # A tibble: 5 x 2</span></a>
<a class="sourceLine" id="cb356-6" data-line-number="6"><span class="co">#&gt;   race_pred    fp</span></a>
<a class="sourceLine" id="cb356-7" data-line-number="7"><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb356-8" data-line-number="8"><span class="co">#&gt; 1 api       1.00 </span></a>
<a class="sourceLine" id="cb356-9" data-line-number="9"><span class="co">#&gt; 2 others    1.00 </span></a>
<a class="sourceLine" id="cb356-10" data-line-number="10"><span class="co">#&gt; 3 black     0.329</span></a>
<a class="sourceLine" id="cb356-11" data-line-number="11"><span class="co">#&gt; 4 hispanic  0.227</span></a>
<a class="sourceLine" id="cb356-12" data-line-number="12"><span class="co">#&gt; 5 white     0.197</span></a></code></pre></div>
<p>Now add residence data using the <code>FLCensus</code> data included in the</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb357-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;FLCensus&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p><span class="math inline">\(P(\text{race})\)</span> in Florida:</p>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb358-1" data-line-number="1">race.prop &lt;-</a>
<a class="sourceLine" id="cb358-2" data-line-number="2"><span class="st">  </span>FLCensus <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb358-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(total.pop, white, black, api, hispanic, others) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb358-4" data-line-number="4"><span class="st">  </span><span class="kw">gather</span>(race, pct, <span class="op">-</span>total.pop) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb358-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(race) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb358-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">weighted.mean</span>(pct, <span class="dt">weights =</span> total.pop)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb358-7" data-line-number="7"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(mean))</a>
<a class="sourceLine" id="cb358-8" data-line-number="8">race.prop</a>
<a class="sourceLine" id="cb358-9" data-line-number="9"><span class="co">#&gt; # A tibble: 5 x 2</span></a>
<a class="sourceLine" id="cb358-10" data-line-number="10"><span class="co">#&gt;   race       mean</span></a>
<a class="sourceLine" id="cb358-11" data-line-number="11"><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb358-12" data-line-number="12"><span class="co">#&gt; 1 white    0.605 </span></a>
<a class="sourceLine" id="cb358-13" data-line-number="13"><span class="co">#&gt; 2 hispanic 0.213 </span></a>
<a class="sourceLine" id="cb358-14" data-line-number="14"><span class="co">#&gt; 3 black    0.139 </span></a>
<a class="sourceLine" id="cb358-15" data-line-number="15"><span class="co">#&gt; 4 api      0.0219</span></a>
<a class="sourceLine" id="cb358-16" data-line-number="16"><span class="co">#&gt; 5 others   0.0214</span></a></code></pre></div>
</section>
<section id="predicting-election-outcomes-with-uncertainty" class="level3">
<h3><span class="header-section-number">6.2.5</span> Predicting Election Outcomes with Uncertainty</h3>
<p>Load the <code>pres08</code> data from the <strong>qss</strong> package.</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb359-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;pres08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>Add a column <code>p</code> which contains Obama’s vote share of the major parties:</p>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb360-1" data-line-number="1">pres08 &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb360-2" data-line-number="2"><span class="st">  </span>pres08 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb360-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> Obama <span class="op">/</span><span class="st"> </span>(Obama <span class="op">+</span><span class="st"> </span>McCain))</a></code></pre></div>
<p>Write a function to simulate the elections. <code>df</code> is the data frame (<code>pres08</code>) with the state, EV, and <code>p</code> columns. <code>n_draws</code> is the size of the binomial distribution to draw from. <code>.id</code> is the simulation number.</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb361-1" data-line-number="1">sim_election &lt;-<span class="st"> </span><span class="cf">function</span>(.id, df, <span class="dt">n_draws =</span> <span class="dv">1000</span>) {</a>
<a class="sourceLine" id="cb361-2" data-line-number="2">  <span class="co"># For each state randomly sample</span></a>
<a class="sourceLine" id="cb361-3" data-line-number="3">  <span class="kw">mutate</span>(df,</a>
<a class="sourceLine" id="cb361-4" data-line-number="4">         <span class="dt">draws =</span> <span class="kw">rbinom</span>(<span class="kw">n</span>(), n_draws, p)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb361-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(draws <span class="op">&gt;</span><span class="st"> </span>(n_draws <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb361-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">EV =</span> <span class="kw">sum</span>(EV),</a>
<a class="sourceLine" id="cb361-7" data-line-number="7">            <span class="dt">.id =</span> .id)</a>
<a class="sourceLine" id="cb361-8" data-line-number="8">}</a></code></pre></div>
<p>Now simulate the election 10,000 times:</p>
<div class="sourceCode" id="cb362"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb362-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">10000</span></a>
<a class="sourceLine" id="cb362-2" data-line-number="2">sim_results &lt;-<span class="st"> </span><span class="kw">map_df</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">sim_election</span>(.x, pres08, <span class="dt">n_draws =</span> <span class="dv">1000</span>))</a></code></pre></div>
<p>In the 2008 election, Obama received 364 electoral votes</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb363-1" data-line-number="1">ELECTION_EV &lt;-<span class="st"> </span><span class="dv">364</span></a></code></pre></div>
<p>And plot them,</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb364-1" data-line-number="1"><span class="kw">ggplot</span>(sim_results, <span class="kw">aes</span>(<span class="dt">x =</span> EV, <span class="dt">y =</span> ..density..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb364-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">10</span>, <span class="dt">fill =</span> <span class="st">&quot;gray30&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb364-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> ELECTION_EV, <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb364-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Electoral Votes&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;density&quot;</span>)</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-36-1.png" width="70%" style="display: block; margin: auto;" /> Simulation mean, variance, and standard deviations:</p>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb365-1" data-line-number="1">sim_results <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb365-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(EV) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb365-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise_all</span>(<span class="kw">funs</span>(mean, var, sd))</a>
<a class="sourceLine" id="cb365-4" data-line-number="4"><span class="co">#&gt;   mean var   sd</span></a>
<a class="sourceLine" id="cb365-5" data-line-number="5"><span class="co">#&gt; 1  352 271 16.5</span></a></code></pre></div>
<p>Theoretical probabilities from a binomial distribution:</p>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb366-1" data-line-number="1"><span class="co"># we cannot use n, because mutate will look for n() first.</span></a>
<a class="sourceLine" id="cb366-2" data-line-number="2">n_draws &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb366-3" data-line-number="3">pres08 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb366-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pb =</span> <span class="kw">pbinom</span>(n_draws <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">size =</span> n_draws, <span class="dt">prob =</span> p,</a>
<a class="sourceLine" id="cb366-5" data-line-number="5">                     <span class="dt">lower.tail  =</span> <span class="ot">FALSE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb366-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">sum</span>(pb <span class="op">*</span><span class="st"> </span>EV),</a>
<a class="sourceLine" id="cb366-7" data-line-number="7">            <span class="dt">V =</span> <span class="kw">sum</span>(pb <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>pb) <span class="op">*</span><span class="st"> </span>EV <span class="op">^</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb366-8" data-line-number="8">            <span class="dt">sd =</span> <span class="kw">sqrt</span>(V))</a>
<a class="sourceLine" id="cb366-9" data-line-number="9"><span class="co">#&gt;   mean   V   sd</span></a>
<a class="sourceLine" id="cb366-10" data-line-number="10"><span class="co">#&gt; 1  352 269 16.4</span></a></code></pre></div>
</section>
</section>
<section id="random-variables-and-probability-distributions" class="level2">
<h2><span class="header-section-number">6.3</span> Random Variables and Probability Distributions</h2>
<section id="bernoulli-and-uniform-distributions" class="level3">
<h3><span class="header-section-number">6.3.1</span> Bernoulli and Uniform Distributions</h3>
<p>Uniform distribution functions:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb367-1" data-line-number="1"><span class="kw">dunif</span>(<span class="fl">0.5</span>, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb367-2" data-line-number="2"><span class="co">#&gt; [1] 1</span></a>
<a class="sourceLine" id="cb367-3" data-line-number="3"><span class="kw">punif</span>(<span class="dv">1</span>, <span class="dt">min =</span> <span class="dv">-2</span>, <span class="dt">max =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb367-4" data-line-number="4"><span class="co">#&gt; [1] 0.75</span></a></code></pre></div>
<p>Sample from a uniform distribution, and convert to a probability:</p>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb368-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb368-2" data-line-number="2">p &lt;-<span class="st"> </span><span class="fl">0.5</span></a>
<a class="sourceLine" id="cb368-3" data-line-number="3"></a>
<a class="sourceLine" id="cb368-4" data-line-number="4"><span class="co"># Sample of size sims from Bernoulli distribution with probability p</span></a>
<a class="sourceLine" id="cb368-5" data-line-number="5">y &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">runif</span>(sims, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">1</span>) <span class="op">&lt;=</span><span class="st"> </span>p)</a>
<a class="sourceLine" id="cb368-6" data-line-number="6"><span class="co"># mean probability</span></a>
<a class="sourceLine" id="cb368-7" data-line-number="7"><span class="kw">mean</span>(y)</a>
<a class="sourceLine" id="cb368-8" data-line-number="8"><span class="co">#&gt; [1] 0.501</span></a></code></pre></div>
</section>
<section id="binomial-distribution" class="level3">
<h3><span class="header-section-number">6.3.2</span> Binomial distribution</h3>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb369-1" data-line-number="1"><span class="kw">dbinom</span>(<span class="dv">2</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">prob =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb369-2" data-line-number="2"><span class="co">#&gt; [1] 0.375</span></a>
<a class="sourceLine" id="cb369-3" data-line-number="3"><span class="kw">pbinom</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb369-4" data-line-number="4"><span class="co">#&gt; [1] 0.5</span></a></code></pre></div>
<div class="sourceCode" id="cb370"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb370-1" data-line-number="1">voters &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">100000</span>)</a>
<a class="sourceLine" id="cb370-2" data-line-number="2"><span class="kw">dbinom</span>(voters <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">size =</span> voters, <span class="dt">prob =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb370-3" data-line-number="3"><span class="co">#&gt; [1] 0.02523 0.00798 0.00252</span></a></code></pre></div>
</section>
<section id="normal-distribution" class="level3">
<h3><span class="header-section-number">6.3.3</span> Normal distribution</h3>
<div class="sourceCode" id="cb371"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb371-1" data-line-number="1"><span class="kw">pnorm</span>(<span class="dv">1</span>) <span class="op">-</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="op">-</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb371-2" data-line-number="2"><span class="co">#&gt; [1] 0.683</span></a>
<a class="sourceLine" id="cb371-3" data-line-number="3"><span class="kw">pnorm</span>(<span class="dv">2</span>) <span class="op">-</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="op">-</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb371-4" data-line-number="4"><span class="co">#&gt; [1] 0.954</span></a></code></pre></div>
<p>Write a function to calculate the area of a normal distribution <span class="math inline">\(\pm \sigma\)</span></p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb372-1" data-line-number="1">normal_pm_sigma &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">mu =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb372-2" data-line-number="2">  (<span class="kw">pnorm</span>(mu <span class="op">+</span><span class="st"> </span>sd <span class="op">*</span><span class="st"> </span>x, <span class="dt">mean =</span> mu, <span class="dt">sd =</span> sd) <span class="op">-</span></a>
<a class="sourceLine" id="cb372-3" data-line-number="3"><span class="st">     </span><span class="kw">pnorm</span>(mu <span class="op">-</span><span class="st"> </span>sd <span class="op">*</span><span class="st"> </span>x, <span class="dt">mean =</span> mu, <span class="dt">sd =</span> sd))</a>
<a class="sourceLine" id="cb372-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb372-5" data-line-number="5"><span class="kw">normal_pm_sigma</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb372-6" data-line-number="6"><span class="co">#&gt; [1] 0.683</span></a>
<a class="sourceLine" id="cb372-7" data-line-number="7"><span class="kw">normal_pm_sigma</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb372-8" data-line-number="8"><span class="co">#&gt; [1] 0.954</span></a>
<a class="sourceLine" id="cb372-9" data-line-number="9"><span class="kw">normal_pm_sigma</span>(<span class="dv">1</span>, <span class="dt">mu =</span> <span class="dv">5</span>, <span class="dt">sd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb372-10" data-line-number="10"><span class="co">#&gt; [1] 0.683</span></a>
<a class="sourceLine" id="cb372-11" data-line-number="11"><span class="kw">normal_pm_sigma</span>(<span class="dv">2</span>, <span class="dt">mu =</span> <span class="dv">5</span>, <span class="dt">sd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb372-12" data-line-number="12"><span class="co">#&gt; [1] 0.954</span></a></code></pre></div>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb373-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;pres08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb373-2" data-line-number="2"><span class="kw">data</span>(<span class="st">&quot;pres12&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>To join both data frames</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb374-1" data-line-number="1">pres &lt;-</a>
<a class="sourceLine" id="cb374-2" data-line-number="2"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">select</span>(pres08, state, <span class="dt">Obama_2008 =</span> Obama, <span class="dt">McCain_2008 =</span> McCain,</a>
<a class="sourceLine" id="cb374-3" data-line-number="3">                 <span class="dt">EV_2008 =</span> EV),</a>
<a class="sourceLine" id="cb374-4" data-line-number="4">          <span class="kw">select</span>(pres12, state, <span class="dt">Obama_2012 =</span> Obama, <span class="dt">Romney_2012 =</span> Romney,</a>
<a class="sourceLine" id="cb374-5" data-line-number="5">                 <span class="dt">EV_2012 =</span> EV),</a>
<a class="sourceLine" id="cb374-6" data-line-number="6">          <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb374-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Obama_2008_z =</span> <span class="kw">as.numeric</span>(<span class="kw">scale</span>(Obama_<span class="dv">2008</span>)),</a>
<a class="sourceLine" id="cb374-8" data-line-number="8">         <span class="dt">Obama_2012_z =</span> <span class="kw">as.numeric</span>(<span class="kw">scale</span>(Obama_<span class="dv">2012</span>)))</a></code></pre></div>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb375-1" data-line-number="1">fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(Obama_<span class="dv">2012</span>_z <span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span>Obama_<span class="dv">2008</span>_z, <span class="dt">data =</span> pres)</a></code></pre></div>
<p>Plot the residuals and compare them to a normal distribution:</p>
<div class="sourceCode" id="cb376"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb376-1" data-line-number="1">err &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">err =</span> <span class="kw">resid</span>(fit1)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb376-2" data-line-number="2"><span class="st">  </span><span class="co"># z-score of residuals</span></a>
<a class="sourceLine" id="cb376-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">err_std =</span> err <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(err))</a>
<a class="sourceLine" id="cb376-4" data-line-number="4"></a>
<a class="sourceLine" id="cb376-5" data-line-number="5"><span class="kw">ggplot</span>(err, <span class="kw">aes</span>(<span class="dt">x =</span> err_std)) <span class="op">+</span></a>
<a class="sourceLine" id="cb376-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">y =</span> ..density..),</a>
<a class="sourceLine" id="cb376-7" data-line-number="7">                 <span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">boundary =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb376-8" data-line-number="8"><span class="st">  </span><span class="kw">stat_function</span>(<span class="dt">geom =</span> <span class="st">&quot;line&quot;</span>, <span class="dt">fun =</span> dnorm) <span class="op">+</span></a>
<a class="sourceLine" id="cb376-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Standardized residuals&quot;</span>,</a>
<a class="sourceLine" id="cb376-10" data-line-number="10">                     <span class="dt">breaks =</span> <span class="dv">-3</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>))</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-48-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb377-1" data-line-number="1"><span class="kw">ggplot</span>(err, <span class="kw">aes</span>(<span class="dt">sample =</span> err_std)) <span class="op">+</span></a>
<a class="sourceLine" id="cb377-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb377-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb377-4" data-line-number="4"><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">ratio =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb377-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Sample quantiles&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb377-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Theoretical quantiles&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>))</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-49-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Alternatively, you can use the <code>augment</code> function from <strong>broom</strong> which returns the residuals for each observation in the <code>.resid</code> column.</p>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb378-1" data-line-number="1"><span class="kw">augment</span>(fit1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb378-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.resid_z =</span> .resid <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(.resid)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb378-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> .resid_z)) <span class="op">+</span></a>
<a class="sourceLine" id="cb378-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">y =</span> ..density..),</a>
<a class="sourceLine" id="cb378-5" data-line-number="5">                 <span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">boundary =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb378-6" data-line-number="6"><span class="st">  </span><span class="kw">stat_function</span>(<span class="dt">geom =</span> <span class="st">&quot;line&quot;</span>, <span class="dt">fun =</span> dnorm) <span class="op">+</span></a>
<a class="sourceLine" id="cb378-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Standardized residuals&quot;</span>,</a>
<a class="sourceLine" id="cb378-8" data-line-number="8">                     <span class="dt">breaks =</span> <span class="dv">-3</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>))</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-50-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Obama’s vote shares in 2008 and 2012.</p>
<p>Standard deviation of errors:</p>
<div class="sourceCode" id="cb379"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb379-1" data-line-number="1">err_sd &lt;-<span class="st"> </span><span class="kw">sd</span>(<span class="kw">resid</span>(fit1))</a></code></pre></div>
<p>Probability of having a larger vote in California in 2012 than in 2008?</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb380-1" data-line-number="1">CA_<span class="dv">2008</span> &lt;-<span class="st"> </span><span class="kw">filter</span>(pres, state <span class="op">==</span><span class="st"> &quot;CA&quot;</span>)<span class="op">$</span>Obama_<span class="dv">2008</span>_z</a></code></pre></div>
<p>The predicted value of 2012 vote share can be calculated manually with <span class="math inline">\(\hat{beta} \times x\)</span>,</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb381-1" data-line-number="1">CA_mean_<span class="dv">2012</span> &lt;-<span class="st"> </span>CA_<span class="dv">2008</span> <span class="op">*</span><span class="st"> </span><span class="kw">coef</span>(fit1)[<span class="st">&quot;Obama_2008_z&quot;</span>]</a>
<a class="sourceLine" id="cb381-2" data-line-number="2">CA_mean_<span class="dv">2012</span></a>
<a class="sourceLine" id="cb381-3" data-line-number="3"><span class="co">#&gt; Obama_2008_z </span></a>
<a class="sourceLine" id="cb381-4" data-line-number="4"><span class="co">#&gt;        0.858</span></a></code></pre></div>
<p>or calculated using the predict function with the <code>newdata</code> argument providing any specific values to calculate?</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb382-1" data-line-number="1"><span class="kw">predict</span>(fit1, <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">Obama_2008_z =</span> CA_<span class="dv">2008</span>))</a>
<a class="sourceLine" id="cb382-2" data-line-number="2"><span class="co">#&gt;     1 </span></a>
<a class="sourceLine" id="cb382-3" data-line-number="3"><span class="co">#&gt; 0.858</span></a></code></pre></div>
<p>Now calculate</p>
<div class="sourceCode" id="cb383"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb383-1" data-line-number="1"><span class="kw">pnorm</span>(CA_<span class="dv">2008</span>, <span class="dt">mean =</span> CA_mean_<span class="dv">2012</span>, <span class="dt">sd =</span> err_sd,</a>
<a class="sourceLine" id="cb383-2" data-line-number="2">      <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb383-3" data-line-number="3"><span class="co">#&gt; [1] 0.468</span></a></code></pre></div>
<p>We can generalize the previous code to calculate the probability that Obama would exceed his 2008 vote to all states:</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb384-1" data-line-number="1">pres_gt_<span class="dv">2008</span> &lt;-<span class="st"> </span><span class="kw">augment</span>(fit1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb384-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p_greater =</span> <span class="kw">pnorm</span>(Obama_<span class="dv">2008</span>_z, <span class="dt">mean =</span> .fitted, <span class="dt">sd =</span> err_sd,</a>
<a class="sourceLine" id="cb384-3" data-line-number="3">                           <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>))</a></code></pre></div>
<p>Plotting these results, we can observe regression to the mean. States with larger (smaller) 2008 vote shares had a lower (higher) probability that the 2012 vote share will exceed them.</p>
<div class="sourceCode" id="cb385"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb385-1" data-line-number="1"><span class="kw">ggplot</span>(pres_gt_<span class="dv">2008</span>, <span class="kw">aes</span>(<span class="dt">x =</span> Obama_<span class="dv">2008</span>_z, <span class="dt">y =</span> p_greater)) <span class="op">+</span></a>
<a class="sourceLine" id="cb385-2" data-line-number="2"><span class="st">  </span>modelr<span class="op">::</span><span class="kw">geom_ref_line</span>(<span class="dt">h =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb385-3" data-line-number="3"><span class="st">  </span>modelr<span class="op">::</span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb385-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb385-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Standardized vote share of Obama (2008)&quot;</span>,</a>
<a class="sourceLine" id="cb385-6" data-line-number="6">       <span class="dt">y =</span> <span class="st">&quot;Pr. 2012 vote share greater than 2008&quot;</span>)</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-57-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="expectation-and-variance" class="level3">
<h3><span class="header-section-number">6.3.4</span> Expectation and Variance</h3>
<p>Theoretical and actual sample variable of a set of Bernoulli draws:</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb386-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="fl">0.5</span></a>
<a class="sourceLine" id="cb386-2" data-line-number="2"><span class="co"># theretical variance</span></a>
<a class="sourceLine" id="cb386-3" data-line-number="3">p <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p)</a>
<a class="sourceLine" id="cb386-4" data-line-number="4"><span class="co">#&gt; [1] 0.25</span></a>
<a class="sourceLine" id="cb386-5" data-line-number="5"><span class="co"># a sample</span></a>
<a class="sourceLine" id="cb386-6" data-line-number="6">y &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">size =</span> <span class="dv">1000</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>, <span class="dt">prob =</span> <span class="kw">c</span>(p, <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p))</a>
<a class="sourceLine" id="cb386-7" data-line-number="7"><span class="co"># the sample variance of that sample</span></a>
<a class="sourceLine" id="cb386-8" data-line-number="8"><span class="kw">var</span>(y)</a>
<a class="sourceLine" id="cb386-9" data-line-number="9"><span class="co">#&gt; [1] 0.25</span></a></code></pre></div>
</section>
<section id="predicting-election-outcomes-with-uncertainty-1" class="level3">
<h3><span class="header-section-number">6.3.5</span> Predicting Election Outcomes with Uncertainty</h3>
<p>Load 2008 Presidential Election data:</p>
<div class="sourceCode" id="cb387"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb387-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;pres08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb387-2" data-line-number="2">pres08 &lt;-<span class="st"> </span><span class="kw">mutate</span>(pres08, <span class="dt">p =</span> Obama <span class="op">/</span><span class="st"> </span>(Obama <span class="op">+</span><span class="st"> </span>McCain))</a></code></pre></div>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb388-1" data-line-number="1">sim_election &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">n =</span> <span class="dv">1000</span>) {</a>
<a class="sourceLine" id="cb388-2" data-line-number="2">  n_states &lt;-<span class="st"> </span><span class="kw">nrow</span>(x)</a>
<a class="sourceLine" id="cb388-3" data-line-number="3">  <span class="co"># samples the number of votes for Obama</span></a>
<a class="sourceLine" id="cb388-4" data-line-number="4">  <span class="kw">mutate</span>(x,</a>
<a class="sourceLine" id="cb388-5" data-line-number="5">         <span class="dt">draws =</span> <span class="kw">rbinom</span>(n_states, <span class="dt">size =</span> <span class="op">!!</span>n, <span class="dt">prob =</span> p),</a>
<a class="sourceLine" id="cb388-6" data-line-number="6">         <span class="dt">obama_EV =</span> EV <span class="op">*</span><span class="st"> </span>(draws <span class="op">&gt;</span><span class="st"> </span>(<span class="op">!!</span>n <span class="op">/</span><span class="st"> </span><span class="dv">2</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-7" data-line-number="7"><span class="st">    </span><span class="kw">pluck</span>(<span class="st">&quot;obama_EV&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-8" data-line-number="8"><span class="st">    </span><span class="kw">sum</span>()</a>
<a class="sourceLine" id="cb388-9" data-line-number="9">}</a></code></pre></div>
<p>This function returns the electoral votes for Obama for a single simulation:</p>
<div class="sourceCode" id="cb389"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb389-1" data-line-number="1"><span class="kw">sim_election</span>(pres08)</a>
<a class="sourceLine" id="cb389-2" data-line-number="2"><span class="co">#&gt; [1] 349</span></a></code></pre></div>
<p>Run this simulation <code>sims</code> times, saving the electoral votes of Obama in each simulation:</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb390-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">10000</span></a>
<a class="sourceLine" id="cb390-2" data-line-number="2">Obama_EV_sims &lt;-<span class="st"> </span><span class="kw">map_dbl</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">sim_election</span>(pres08))</a></code></pre></div>
<p>Obama’s actual electoral value</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb391-1" data-line-number="1">OBAMA_EV &lt;-<span class="st"> </span><span class="dv">364</span></a></code></pre></div>
<div class="sourceCode" id="cb392"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb392-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;glue&quot;</span>)</a>
<a class="sourceLine" id="cb392-2" data-line-number="2"><span class="kw">ggplot</span>(<span class="kw">tibble</span>(<span class="dt">Obama_EV =</span> Obama_EV_sims),</a>
<a class="sourceLine" id="cb392-3" data-line-number="3">       <span class="kw">aes</span>(<span class="dt">x =</span> Obama_EV, <span class="dt">y =</span> ..density..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb392-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">10</span>, <span class="dt">boundary =</span> <span class="dv">0</span>, <span class="dt">fill =</span> <span class="st">&quot;gray60&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb392-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> OBAMA_EV, <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb392-6" data-line-number="6"><span class="st">  </span><span class="kw">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> OBAMA_EV <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">y =</span> <span class="fl">0.02</span>,</a>
<a class="sourceLine" id="cb392-7" data-line-number="7">           <span class="dt">label =</span> <span class="kw">glue</span>(<span class="st">&quot;Obama&#39;s 2008 EV = {OBAMA_EV}&quot;</span>), <span class="dt">hjust =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb392-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Obama&#39;s Electoral College Votes&quot;</span>,</a>
<a class="sourceLine" id="cb392-9" data-line-number="9">                     <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">300</span>, <span class="dv">400</span>, <span class="dt">by =</span> <span class="dv">20</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb392-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Density&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb392-11" data-line-number="11"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Prediction of election outcomes&quot;</span>)</a></code></pre></div>
<p><img src="probability_files/figure-html/unnamed-chunk-63-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Summarize the simulations:</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb393-1" data-line-number="1"><span class="kw">summary</span>(Obama_EV_sims)</a>
<a class="sourceLine" id="cb393-2" data-line-number="2"><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></a>
<a class="sourceLine" id="cb393-3" data-line-number="3"><span class="co">#&gt;     278     340     353     352     364     401</span></a></code></pre></div>
<p>Compare theoretical and simulation means:</p>
<div class="sourceCode" id="cb394"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb394-1" data-line-number="1"><span class="co"># simulation EV</span></a>
<a class="sourceLine" id="cb394-2" data-line-number="2"><span class="kw">mean</span>(Obama_EV_sims)</a>
<a class="sourceLine" id="cb394-3" data-line-number="3"><span class="co">#&gt; [1] 352</span></a>
<a class="sourceLine" id="cb394-4" data-line-number="4"><span class="co"># theoretical</span></a>
<a class="sourceLine" id="cb394-5" data-line-number="5">n &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb394-6" data-line-number="6">pres08 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb394-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Obama_EV =</span> EV <span class="op">*</span><span class="st"> </span><span class="kw">pbinom</span>(n <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">size =</span> n, <span class="dt">prob =</span> p,</a>
<a class="sourceLine" id="cb394-8" data-line-number="8">                                <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb394-9" data-line-number="9"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">Obama_EV =</span> <span class="kw">sum</span>(Obama_EV))</a>
<a class="sourceLine" id="cb394-10" data-line-number="10"><span class="co">#&gt;   Obama_EV</span></a>
<a class="sourceLine" id="cb394-11" data-line-number="11"><span class="co">#&gt; 1      352</span></a></code></pre></div>
<p>Compare theoretical and simulation variances:</p>
<div class="sourceCode" id="cb395"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb395-1" data-line-number="1"><span class="co"># simulation variance</span></a>
<a class="sourceLine" id="cb395-2" data-line-number="2"><span class="kw">var</span>(Obama_EV_sims)</a>
<a class="sourceLine" id="cb395-3" data-line-number="3"><span class="co">#&gt; [1] 273</span></a>
<a class="sourceLine" id="cb395-4" data-line-number="4"><span class="co"># theoretical variance</span></a>
<a class="sourceLine" id="cb395-5" data-line-number="5">Obama_EV_var &lt;-<span class="st"> </span>pres08 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb395-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pb =</span> <span class="kw">pbinom</span>(n <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">size =</span> n, <span class="dt">prob =</span> p, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb395-7" data-line-number="7">         <span class="dt">EV_var =</span> pb <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>pb) <span class="op">*</span><span class="st"> </span>EV <span class="op">^</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb395-8" data-line-number="8"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">EV_var =</span> <span class="kw">sum</span>(EV_var)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb395-9" data-line-number="9"><span class="st">  </span><span class="kw">pluck</span>(<span class="st">&quot;EV_var&quot;</span>)</a>
<a class="sourceLine" id="cb395-10" data-line-number="10">Obama_EV_var</a>
<a class="sourceLine" id="cb395-11" data-line-number="11"><span class="co">#&gt; [1] 269</span></a></code></pre></div>
<p>and standard deviations</p>
<div class="sourceCode" id="cb396"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb396-1" data-line-number="1"><span class="co"># sim</span></a>
<a class="sourceLine" id="cb396-2" data-line-number="2"><span class="kw">sd</span>(Obama_EV_sims)</a>
<a class="sourceLine" id="cb396-3" data-line-number="3"><span class="co">#&gt; [1] 16.5</span></a>
<a class="sourceLine" id="cb396-4" data-line-number="4"><span class="co"># theoretical</span></a>
<a class="sourceLine" id="cb396-5" data-line-number="5"><span class="kw">sqrt</span>(Obama_EV_var)</a>
<a class="sourceLine" id="cb396-6" data-line-number="6"><span class="co">#&gt; [1] 16.4</span></a></code></pre></div>
</section>
</section>
<section id="large-sample-theorems" class="level2">
<h2><span class="header-section-number">6.4</span> Large Sample Theorems</h2>
<section id="law-of-large-numbers" class="level3">
<h3><span class="header-section-number">6.4.1</span> Law of Large Numbers</h3>
<p>Put the simulation number, <code>x</code> and <code>mean</code> in a tibble:</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb397-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb397-2" data-line-number="2">p &lt;-<span class="st"> </span><span class="fl">0.2</span></a>
<a class="sourceLine" id="cb397-3" data-line-number="3">size &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb397-4" data-line-number="4">lln_binom &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb397-5" data-line-number="5">  <span class="dt">n =</span> <span class="kw">seq_len</span>(sims),</a>
<a class="sourceLine" id="cb397-6" data-line-number="6">  <span class="dt">x =</span> <span class="kw">rbinom</span>(sims, <span class="dt">prob =</span> p, <span class="dt">size =</span> size),</a>
<a class="sourceLine" id="cb397-7" data-line-number="7">  <span class="dt">mean =</span> <span class="kw">cumsum</span>(x) <span class="op">/</span><span class="st"> </span>n,</a>
<a class="sourceLine" id="cb397-8" data-line-number="8">  <span class="dt">distrib =</span> <span class="kw">str_c</span>(<span class="st">&quot;Binomial(&quot;</span>, size, <span class="st">&quot;, &quot;</span>, p, <span class="st">&quot;)&quot;</span>))</a></code></pre></div>
<div class="sourceCode" id="cb398"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb398-1" data-line-number="1">lln_unif &lt;-</a>
<a class="sourceLine" id="cb398-2" data-line-number="2"><span class="st"> </span><span class="kw">tibble</span>(<span class="dt">n =</span> <span class="kw">seq_len</span>(sims),</a>
<a class="sourceLine" id="cb398-3" data-line-number="3">        <span class="dt">x =</span> <span class="kw">runif</span>(sims),</a>
<a class="sourceLine" id="cb398-4" data-line-number="4">        <span class="dt">mean =</span> <span class="kw">cumsum</span>(x) <span class="op">/</span><span class="st"> </span>n,</a>
<a class="sourceLine" id="cb398-5" data-line-number="5">        <span class="dt">distrib =</span> <span class="kw">str_c</span>(<span class="st">&quot;Uniform(0, 1)&quot;</span>))</a></code></pre></div>
<div class="sourceCode" id="cb399"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb399-1" data-line-number="1">true_means &lt;-</a>
<a class="sourceLine" id="cb399-2" data-line-number="2"><span class="st">  </span><span class="kw">tribble</span>(<span class="op">~</span>distrib, <span class="op">~</span>mean,</a>
<a class="sourceLine" id="cb399-3" data-line-number="3">          <span class="st">&quot;Uniform(0, 1)&quot;</span>, <span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb399-4" data-line-number="4">          <span class="kw">str_c</span>(<span class="st">&quot;Binomial(&quot;</span>, size, <span class="st">&quot;, &quot;</span>, p, <span class="st">&quot;)&quot;</span>), size <span class="op">*</span><span class="st"> </span>p)</a>
<a class="sourceLine" id="cb399-5" data-line-number="5"></a>
<a class="sourceLine" id="cb399-6" data-line-number="6"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb399-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="kw">aes</span>(<span class="dt">yintercept =</span> mean), <span class="dt">data =</span> true_means,</a>
<a class="sourceLine" id="cb399-8" data-line-number="8">             <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb399-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n, <span class="dt">y =</span> mean),</a>
<a class="sourceLine" id="cb399-10" data-line-number="10">            <span class="dt">data =</span> <span class="kw">bind_rows</span>(lln_binom, lln_unif)) <span class="op">+</span></a>
<a class="sourceLine" id="cb399-11" data-line-number="11"><span class="st">  </span><span class="kw">facet_grid</span>(distrib <span class="op">~</span><span class="st"> </span>., <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb399-12" data-line-number="12"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Sample Size&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Sample Mean&quot;</span>)</a></code></pre></div>
<p><img src="probability_files/figure-html/plot_lln_sim_unif-1.png" width="70%" style="display: block; margin: auto;" /></p>
</section>
<section id="central-limit-theorem" class="level3">
<h3><span class="header-section-number">6.4.2</span> Central Limit Theorem</h3>
<p>The population mean of the binomial distribution is <span class="math inline">\(\mu = p n\)</span> and the variance is <span class="math inline">\(\sigma^2 = p (1 - p) n\)</span>.</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb400-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb400-2" data-line-number="2">n_samp &lt;-<span class="st"> </span><span class="dv">1000</span></a></code></pre></div>
<p>Write functions to calculate the mean of a binomial distribution with size, <code>size</code>, and probability, <code>p</code>,</p>
<div class="sourceCode" id="cb401"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb401-1" data-line-number="1">binom_mean &lt;-<span class="st"> </span><span class="cf">function</span>(size, p) {</a>
<a class="sourceLine" id="cb401-2" data-line-number="2">  size <span class="op">*</span><span class="st"> </span>p</a>
<a class="sourceLine" id="cb401-3" data-line-number="3">}</a></code></pre></div>
<p>variance of a binomial distribution,</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb402-1" data-line-number="1">binom_var &lt;-<span class="st"> </span><span class="cf">function</span>(size, p) {</a>
<a class="sourceLine" id="cb402-2" data-line-number="2">  size <span class="op">*</span><span class="st"> </span>p <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p)</a>
<a class="sourceLine" id="cb402-3" data-line-number="3">}</a></code></pre></div>
<p>Write a function that takes <code>n_samp</code> samples from a binomial distribution with size, <code>size</code>, and probability of success, <code>p</code>, and returns a data frame with the z-score of the sample distribution:</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb403-1" data-line-number="1">sim_binom_clt &lt;-<span class="st"> </span><span class="cf">function</span>(n_samp, size, p) {</a>
<a class="sourceLine" id="cb403-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n_samp, <span class="dt">prob =</span> p, <span class="dt">size =</span> size)</a>
<a class="sourceLine" id="cb403-3" data-line-number="3">  z &lt;-<span class="st"> </span>(<span class="kw">mean</span>(x) <span class="op">-</span><span class="st"> </span><span class="kw">binom_mean</span>(size, p)) <span class="op">/</span></a>
<a class="sourceLine" id="cb403-4" data-line-number="4"><span class="st">    </span><span class="kw">sqrt</span>(<span class="kw">binom_var</span>(size, p) <span class="op">/</span><span class="st"> </span>n_samp)</a>
<a class="sourceLine" id="cb403-5" data-line-number="5">  <span class="kw">tibble</span>(<span class="dt">distrib =</span> <span class="kw">str_c</span>(<span class="st">&quot;Binomial(&quot;</span>, p, <span class="st">&quot;, &quot;</span>, size, <span class="st">&quot;)&quot;</span>),</a>
<a class="sourceLine" id="cb403-6" data-line-number="6">         <span class="dt">z =</span> z)</a>
<a class="sourceLine" id="cb403-7" data-line-number="7">}</a></code></pre></div>
<p>For the uniform distribution, we need a function to calculate the mean of a uniform distribution,</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb404-1" data-line-number="1">unif_mean &lt;-<span class="st"> </span><span class="cf">function</span>(min, max) {</a>
<a class="sourceLine" id="cb404-2" data-line-number="2">  <span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(min <span class="op">+</span><span class="st"> </span>max)</a>
<a class="sourceLine" id="cb404-3" data-line-number="3">}</a></code></pre></div>
<p>variance of a uniform distribution,</p>
<div class="sourceCode" id="cb405"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb405-1" data-line-number="1">unif_var &lt;-<span class="st"> </span><span class="cf">function</span>(min, max) {</a>
<a class="sourceLine" id="cb405-2" data-line-number="2">  (<span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">12</span>) <span class="op">*</span><span class="st"> </span>(max <span class="op">-</span><span class="st"> </span>min) <span class="op">^</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb405-3" data-line-number="3">}</a></code></pre></div>
<p>and a function to perform the CLT simulation,</p>
<div class="sourceCode" id="cb406"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb406-1" data-line-number="1">sim_unif_clt &lt;-<span class="st"> </span><span class="cf">function</span>(n_samp, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb406-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="kw">runif</span>(n_samp, <span class="dt">min =</span> min, <span class="dt">max =</span> max)</a>
<a class="sourceLine" id="cb406-3" data-line-number="3">  z &lt;-<span class="st"> </span>(<span class="kw">mean</span>(x) <span class="op">-</span><span class="st"> </span><span class="kw">unif_mean</span>(min, max)) <span class="op">/</span></a>
<a class="sourceLine" id="cb406-4" data-line-number="4"><span class="st">    </span><span class="kw">sqrt</span>(<span class="kw">unif_var</span>(min, max) <span class="op">/</span><span class="st"> </span>n_samp)</a>
<a class="sourceLine" id="cb406-5" data-line-number="5">  <span class="kw">tibble</span>(<span class="dt">distrib =</span> <span class="kw">str_c</span>(<span class="st">&quot;Uniform(&quot;</span>, min, <span class="st">&quot;, &quot;</span>, max, <span class="st">&quot;)&quot;</span>),</a>
<a class="sourceLine" id="cb406-6" data-line-number="6">         <span class="dt">z =</span> z)</a>
<a class="sourceLine" id="cb406-7" data-line-number="7">}</a></code></pre></div>
<p>Since we will calculate this for <code>n_samp = 1000</code> and <code>n_samp</code>, we might as well write a function for it.</p>
<div class="sourceCode" id="cb407"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb407-1" data-line-number="1">clt_plot &lt;-<span class="st"> </span><span class="cf">function</span>(n_samp) {</a>
<a class="sourceLine" id="cb407-2" data-line-number="2">  <span class="kw">bind_rows</span>(<span class="kw">map_df</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">sim_binom_clt</span>(n_samp, size, p)),</a>
<a class="sourceLine" id="cb407-3" data-line-number="3">            <span class="kw">map_df</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">sim_unif_clt</span>(n_samp))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb407-4" data-line-number="4"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> z)) <span class="op">+</span></a>
<a class="sourceLine" id="cb407-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb407-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_rug</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb407-7" data-line-number="7"><span class="st">    </span><span class="kw">stat_function</span>(<span class="dt">fun =</span> dnorm, <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb407-8" data-line-number="8"><span class="st">    </span><span class="kw">facet_grid</span>(distrib <span class="op">~</span><span class="st"> </span>.) <span class="op">+</span></a>
<a class="sourceLine" id="cb407-9" data-line-number="9"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="kw">str_c</span>(<span class="st">&quot;Sample size = &quot;</span>, n_samp))</a>
<a class="sourceLine" id="cb407-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb407-11" data-line-number="11"><span class="kw">clt_plot</span>(<span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb407-12" data-line-number="12"><span class="kw">clt_plot</span>(<span class="dv">100</span>)</a></code></pre></div>
<p><img src="probability_files/figure-html/clt_plot-1.png" width="70%" style="display: block; margin: auto;" /><img src="probability_files/figure-html/clt_plot-2.png" width="70%" style="display: block; margin: auto;" /></p>

</section>
</section>
</section>
<section id="uncertainty" class="level1">
<h1><span class="header-section-number">7</span> Uncertainty</h1>
<section id="prerequisites-8" class="level2 unnumbered">
<h2>Prerequisites</h2>
<p>We will use these package in this chapter:</p>
<div class="sourceCode" id="cb408"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb408-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a>
<a class="sourceLine" id="cb408-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;forcats&quot;</span>)</a>
<a class="sourceLine" id="cb408-3" data-line-number="3"><span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)</a>
<a class="sourceLine" id="cb408-4" data-line-number="4"><span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)</a>
<a class="sourceLine" id="cb408-5" data-line-number="5"><span class="kw">library</span>(<span class="st">&quot;modelr&quot;</span>)</a>
<a class="sourceLine" id="cb408-6" data-line-number="6"><span class="kw">library</span>(<span class="st">&quot;broom&quot;</span>)</a>
<a class="sourceLine" id="cb408-7" data-line-number="7"><span class="kw">library</span>(<span class="st">&quot;purrr&quot;</span>)</a></code></pre></div>
</section>
<section id="estimation" class="level2">
<h2><span class="header-section-number">7.1</span> Estimation</h2>
<section id="unbiasedness-and-consistency" class="level3">
<h3><span class="header-section-number">7.1.1</span> Unbiasedness and Consistency</h3>
<p>In these simulations, we draw a sample of size <code>n</code> from normal distributions with means <code>mu0</code> and <code>mu1</code> and standard deviations <code>sd0</code> and <code>sd1</code> respectively,</p>
<div class="sourceCode" id="cb409"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb409-1" data-line-number="1">n &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb409-2" data-line-number="2">mu0 &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb409-3" data-line-number="3">sd0 &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb409-4" data-line-number="4">mu1 &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb409-5" data-line-number="5">sd1 &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb409-6" data-line-number="6">smpl &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">id =</span> <span class="kw">seq_len</span>(n),</a>
<a class="sourceLine" id="cb409-7" data-line-number="7">               <span class="co"># Y if not treated</span></a>
<a class="sourceLine" id="cb409-8" data-line-number="8">               <span class="dt">Y0 =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> mu0, <span class="dt">sd =</span> sd0),</a>
<a class="sourceLine" id="cb409-9" data-line-number="9">               <span class="co"># Y if treated</span></a>
<a class="sourceLine" id="cb409-10" data-line-number="10">               <span class="dt">Y1 =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> mu1, <span class="dt">sd =</span> sd1),</a>
<a class="sourceLine" id="cb409-11" data-line-number="11">               <span class="co"># individual treatment effects</span></a>
<a class="sourceLine" id="cb409-12" data-line-number="12">               <span class="dt">tau =</span> Y1 <span class="op">-</span><span class="st"> </span>Y0)</a></code></pre></div>
<p>The SATE is:</p>
<div class="sourceCode" id="cb410"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb410-1" data-line-number="1">SATE &lt;-<span class="st"> </span><span class="kw">mean</span>(smpl[[<span class="st">&quot;tau&quot;</span>]])</a>
<a class="sourceLine" id="cb410-2" data-line-number="2">SATE</a>
<a class="sourceLine" id="cb410-3" data-line-number="3"><span class="co">#&gt; [1] 0.952</span></a></code></pre></div>
<p>Simulations of RCTs. Write a function that takes the sample as an input <code>smpl</code>, randomly assigns the treatment to each individual:</p>
<div class="sourceCode" id="cb411"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb411-1" data-line-number="1">sim_treat &lt;-<span class="st"> </span><span class="cf">function</span>(smpl) {</a>
<a class="sourceLine" id="cb411-2" data-line-number="2">  n &lt;-<span class="st"> </span><span class="kw">nrow</span>(smpl)</a>
<a class="sourceLine" id="cb411-3" data-line-number="3">  SATE &lt;-<span class="st"> </span><span class="kw">mean</span>(smpl[[<span class="st">&quot;tau&quot;</span>]])</a>
<a class="sourceLine" id="cb411-4" data-line-number="4">  <span class="co"># indexes of obs receiving treatment</span></a>
<a class="sourceLine" id="cb411-5" data-line-number="5">  idx &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">seq_len</span>(n), <span class="kw">floor</span>(<span class="kw">nrow</span>(smpl) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>), <span class="dt">replace =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb411-6" data-line-number="6">  <span class="co"># treat variable are those receiving treatment, else 0</span></a>
<a class="sourceLine" id="cb411-7" data-line-number="7">  smpl[[<span class="st">&quot;treat&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">seq_len</span>(<span class="kw">nrow</span>(smpl)) <span class="op">%in%</span><span class="st"> </span>idx)</a>
<a class="sourceLine" id="cb411-8" data-line-number="8">  smpl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb411-9" data-line-number="9"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Y_obs =</span> <span class="kw">if_else</span>(treat <span class="op">==</span><span class="st"> </span>1L, Y1, Y0)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb411-10" data-line-number="10"><span class="st">    </span><span class="kw">group_by</span>(treat) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb411-11" data-line-number="11"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">Y_obs =</span> <span class="kw">mean</span>(Y_obs)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb411-12" data-line-number="12"><span class="st">    </span><span class="kw">spread</span>(treat, Y_obs) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb411-13" data-line-number="13"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">Y1_mean =</span> <span class="st">`</span><span class="dt">1</span><span class="st">`</span>, <span class="dt">Y0_mean =</span> <span class="st">`</span><span class="dt">0</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb411-14" data-line-number="14"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">diff_mean =</span> Y1_mean <span class="op">-</span><span class="st"> </span>Y0_mean,</a>
<a class="sourceLine" id="cb411-15" data-line-number="15">           <span class="dt">est_error =</span> diff_mean <span class="op">-</span><span class="st"> </span>SATE)</a>
<a class="sourceLine" id="cb411-16" data-line-number="16">}</a></code></pre></div>
<p>This returns a data frame with columns: <code>Y0_mean</code> (mean <span class="math inline">\(Y\)</span> for observations not receiving the treatment), <code>Y1_mean</code> (mean <span class="math inline">\(Y\)</span> for observations receiving the treatment), <code>diff</code> (difference in mean values between the two groups), and <code>est_error</code> (difference between the estimated difference and the known SATE):</p>
<div class="sourceCode" id="cb412"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb412-1" data-line-number="1"><span class="kw">sim_treat</span>(smpl)</a>
<a class="sourceLine" id="cb412-2" data-line-number="2"><span class="co">#&gt; # A tibble: 1 x 4</span></a>
<a class="sourceLine" id="cb412-3" data-line-number="3"><span class="co">#&gt;   Y0_mean Y1_mean diff_mean est_error</span></a>
<a class="sourceLine" id="cb412-4" data-line-number="4"><span class="co">#&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb412-5" data-line-number="5"><span class="co">#&gt; 1 -0.0570   0.875     0.932   -0.0207</span></a></code></pre></div>
<p>Rerun this function <code>sims</code> times:</p>
<div class="sourceCode" id="cb413"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb413-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">5000</span></a>
<a class="sourceLine" id="cb413-2" data-line-number="2">sate_sims &lt;-<span class="st"> </span><span class="kw">map_df</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">sim_treat</span>(smpl))</a>
<a class="sourceLine" id="cb413-3" data-line-number="3"><span class="kw">summary</span>(sate_sims[[<span class="st">&quot;est_error&quot;</span>]])</a>
<a class="sourceLine" id="cb413-4" data-line-number="4"><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></a>
<a class="sourceLine" id="cb413-5" data-line-number="5"><span class="co">#&gt;  -0.484  -0.087  -0.002  -0.001   0.085   0.414</span></a></code></pre></div>
<p>Simulate the PATE:</p>
<div class="sourceCode" id="cb414"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb414-1" data-line-number="1">PATE &lt;-<span class="st"> </span>mu1 <span class="op">-</span><span class="st"> </span>mu0</a>
<a class="sourceLine" id="cb414-2" data-line-number="2"></a>
<a class="sourceLine" id="cb414-3" data-line-number="3">sim_pate &lt;-<span class="st"> </span><span class="cf">function</span>(n, mu0, mu1, sd0, sd1) {</a>
<a class="sourceLine" id="cb414-4" data-line-number="4">  smpl &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">Y0 =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> mu0, <span class="dt">sd =</span> sd0),</a>
<a class="sourceLine" id="cb414-5" data-line-number="5">                 <span class="dt">Y1 =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> mu1, <span class="dt">sd =</span> sd1),</a>
<a class="sourceLine" id="cb414-6" data-line-number="6">                 <span class="dt">tau =</span> Y1 <span class="op">-</span><span class="st"> </span>Y0)</a>
<a class="sourceLine" id="cb414-7" data-line-number="7">  <span class="co"># indexes of obs receiving treatment</span></a>
<a class="sourceLine" id="cb414-8" data-line-number="8">  idx &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">seq_len</span>(n), <span class="kw">floor</span>(<span class="kw">nrow</span>(smpl) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>), <span class="dt">replace =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb414-9" data-line-number="9">  <span class="co"># treat variable are those receiving treatment, else 0</span></a>
<a class="sourceLine" id="cb414-10" data-line-number="10">  smpl[[<span class="st">&quot;treat&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">seq_len</span>(<span class="kw">nrow</span>(smpl)) <span class="op">%in%</span><span class="st"> </span>idx)</a>
<a class="sourceLine" id="cb414-11" data-line-number="11">  smpl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb414-12" data-line-number="12"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Y_obs =</span> <span class="kw">if_else</span>(treat <span class="op">==</span><span class="st"> </span>1L, Y1, Y0)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb414-13" data-line-number="13"><span class="st">    </span><span class="kw">group_by</span>(treat) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb414-14" data-line-number="14"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">Y_obs =</span> <span class="kw">mean</span>(Y_obs)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb414-15" data-line-number="15"><span class="st">    </span><span class="kw">spread</span>(treat, Y_obs) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb414-16" data-line-number="16"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">Y1_mean =</span> <span class="st">`</span><span class="dt">1</span><span class="st">`</span>, <span class="dt">Y0_mean =</span> <span class="st">`</span><span class="dt">0</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb414-17" data-line-number="17"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">diff_mean =</span> Y1_mean <span class="op">-</span><span class="st"> </span>Y0_mean,</a>
<a class="sourceLine" id="cb414-18" data-line-number="18">           <span class="dt">est_error =</span> diff_mean <span class="op">-</span><span class="st"> </span>PATE)</a>
<a class="sourceLine" id="cb414-19" data-line-number="19">}</a></code></pre></div>
<p>Example of one simulation</p>
<div class="sourceCode" id="cb415"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb415-1" data-line-number="1"><span class="kw">sim_pate</span>(n, mu0, mu1, sd0, sd1)</a>
<a class="sourceLine" id="cb415-2" data-line-number="2"><span class="co">#&gt; # A tibble: 1 x 4</span></a>
<a class="sourceLine" id="cb415-3" data-line-number="3"><span class="co">#&gt;   Y0_mean Y1_mean diff_mean est_error</span></a>
<a class="sourceLine" id="cb415-4" data-line-number="4"><span class="co">#&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb415-5" data-line-number="5"><span class="co">#&gt; 1  -0.109   0.925      1.03    0.0338</span></a></code></pre></div>
<div class="sourceCode" id="cb416"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb416-1" data-line-number="1">pate_sims &lt;-</a>
<a class="sourceLine" id="cb416-2" data-line-number="2"><span class="st">  </span><span class="kw">map_df</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">sim_pate</span>(n, mu0, mu1, sd0, sd1))</a>
<a class="sourceLine" id="cb416-3" data-line-number="3"><span class="kw">summary</span>(pate_sims[[<span class="st">&quot;est_error&quot;</span>]])</a>
<a class="sourceLine" id="cb416-4" data-line-number="4"><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></a>
<a class="sourceLine" id="cb416-5" data-line-number="5"><span class="co">#&gt;  -0.677  -0.135  -0.004  -0.003   0.129   0.853</span></a></code></pre></div>
</section>
<section id="standard-error" class="level3">
<h3><span class="header-section-number">7.1.2</span> Standard Error</h3>
<p>Plot of the sampling distribution of the difference-in-means estimator:</p>
<div class="sourceCode" id="cb417"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb417-1" data-line-number="1"><span class="kw">ggplot</span>(pate_sims, <span class="kw">aes</span>(<span class="dt">x =</span> diff_mean, <span class="dt">y =</span> ..density..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb417-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">0.01</span>, <span class="dt">boundary =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb417-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> PATE, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb417-4" data-line-number="4"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Sampling distribution&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb417-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Difference-in-means estimator&quot;</span>)</a></code></pre></div>
<p><img src="uncertainty_files/figure-html/unnamed-chunk-11-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb418"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb418-1" data-line-number="1"><span class="kw">sd</span>(pate_sims[[<span class="st">&quot;diff_mean&quot;</span>]])</a>
<a class="sourceLine" id="cb418-2" data-line-number="2"><span class="co">#&gt; [1] 0.196</span></a></code></pre></div>
<p>Simulate PATE with a standard error:</p>
<div class="sourceCode" id="cb419"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb419-1" data-line-number="1">sim_pate_se &lt;-<span class="st"> </span><span class="cf">function</span>(n, mu0, mu1, sd0, sd1) {</a>
<a class="sourceLine" id="cb419-2" data-line-number="2">  <span class="co"># PATE - difference in means</span></a>
<a class="sourceLine" id="cb419-3" data-line-number="3">  PATE &lt;-<span class="st"> </span>mu1 <span class="op">-</span><span class="st"> </span>mu0</a>
<a class="sourceLine" id="cb419-4" data-line-number="4">  <span class="co"># sample</span></a>
<a class="sourceLine" id="cb419-5" data-line-number="5">  smpl &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">Y0 =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> mu0, <span class="dt">sd =</span> sd0),</a>
<a class="sourceLine" id="cb419-6" data-line-number="6">                 <span class="dt">Y1 =</span> <span class="kw">rnorm</span>(n, <span class="dt">mean =</span> mu1, <span class="dt">sd =</span> sd1),</a>
<a class="sourceLine" id="cb419-7" data-line-number="7">                 <span class="dt">tau =</span> Y1 <span class="op">-</span><span class="st"> </span>Y0)</a>
<a class="sourceLine" id="cb419-8" data-line-number="8">  <span class="co"># indexes of obs receiving treatment</span></a>
<a class="sourceLine" id="cb419-9" data-line-number="9">  idx &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">seq_len</span>(n), <span class="kw">floor</span>(<span class="kw">nrow</span>(smpl) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>), <span class="dt">replace =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb419-10" data-line-number="10">  <span class="co"># treat variable are those receiving treatment, else 0</span></a>
<a class="sourceLine" id="cb419-11" data-line-number="11">  smpl[[<span class="st">&quot;treat&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">seq_len</span>(<span class="kw">nrow</span>(smpl)) <span class="op">%in%</span><span class="st"> </span>idx)</a>
<a class="sourceLine" id="cb419-12" data-line-number="12">  <span class="co"># sample</span></a>
<a class="sourceLine" id="cb419-13" data-line-number="13">  smpl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb419-14" data-line-number="14"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Y_obs =</span> <span class="kw">if_else</span>(treat <span class="op">==</span><span class="st"> </span>1L, Y1, Y0)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb419-15" data-line-number="15"><span class="st">    </span><span class="kw">group_by</span>(treat) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb419-16" data-line-number="16"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(Y_obs),</a>
<a class="sourceLine" id="cb419-17" data-line-number="17">              <span class="dt">var =</span> <span class="kw">var</span>(Y_obs),</a>
<a class="sourceLine" id="cb419-18" data-line-number="18">              <span class="dt">nobs =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb419-19" data-line-number="19"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">diff_mean =</span> <span class="kw">diff</span>(mean),</a>
<a class="sourceLine" id="cb419-20" data-line-number="20">              <span class="dt">se =</span> <span class="kw">sqrt</span>(<span class="kw">sum</span>(var <span class="op">/</span><span class="st"> </span>nobs)),</a>
<a class="sourceLine" id="cb419-21" data-line-number="21">              <span class="dt">est_error =</span> diff_mean <span class="op">-</span><span class="st"> </span>PATE)</a>
<a class="sourceLine" id="cb419-22" data-line-number="22">}</a></code></pre></div>
<p>Run a single simulation:</p>
<div class="sourceCode" id="cb420"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb420-1" data-line-number="1"><span class="kw">sim_pate_se</span>(n, mu0, mu1, sd0, sd1)</a>
<a class="sourceLine" id="cb420-2" data-line-number="2"><span class="co">#&gt; # A tibble: 1 x 3</span></a>
<a class="sourceLine" id="cb420-3" data-line-number="3"><span class="co">#&gt;   diff_mean    se est_error</span></a>
<a class="sourceLine" id="cb420-4" data-line-number="4"><span class="co">#&gt;       &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb420-5" data-line-number="5"><span class="co">#&gt; 1      1.05 0.190    0.0539</span></a></code></pre></div>
<p>Run <code>sims</code> simulations:</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb421-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">5000</span></a>
<a class="sourceLine" id="cb421-2" data-line-number="2">pate_sims_se &lt;-</a>
<a class="sourceLine" id="cb421-3" data-line-number="3"><span class="st">  </span><span class="kw">map_df</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">sim_pate_se</span>(n, mu0, mu1, sd0, sd1))</a></code></pre></div>
<p>Standard deviation of difference-in-means</p>
<div class="sourceCode" id="cb422"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb422-1" data-line-number="1"><span class="kw">sd</span>(pate_sims_se[[<span class="st">&quot;diff_mean&quot;</span>]])</a>
<a class="sourceLine" id="cb422-2" data-line-number="2"><span class="co">#&gt; [1] 0.199</span></a></code></pre></div>
<p>Mean of standard errors,</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb423-1" data-line-number="1"><span class="kw">mean</span>(pate_sims_se[[<span class="st">&quot;se&quot;</span>]])</a>
<a class="sourceLine" id="cb423-2" data-line-number="2"><span class="co">#&gt; [1] 0.2</span></a></code></pre></div>
</section>
<section id="confidence-intervals" class="level3">
<h3><span class="header-section-number">7.1.3</span> Confidence Intervals</h3>
<p>Calculate a <span class="math inline">\(p\%\)</span> confidence interval for the binomial distribution:</p>
<div class="sourceCode" id="cb424"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb424-1" data-line-number="1"><span class="co"># Sample size</span></a>
<a class="sourceLine" id="cb424-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb424-3" data-line-number="3"><span class="co"># point estimate</span></a>
<a class="sourceLine" id="cb424-4" data-line-number="4">x_bar &lt;-<span class="st"> </span><span class="fl">0.6</span></a>
<a class="sourceLine" id="cb424-5" data-line-number="5"><span class="co"># standard error</span></a>
<a class="sourceLine" id="cb424-6" data-line-number="6">se &lt;-<span class="st"> </span><span class="kw">sqrt</span>(x_bar <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>x_bar) <span class="op">/</span><span class="st"> </span>n)</a>
<a class="sourceLine" id="cb424-7" data-line-number="7"><span class="co"># Desired Confidence levels</span></a>
<a class="sourceLine" id="cb424-8" data-line-number="8">levels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.99</span>, <span class="fl">0.95</span>, <span class="fl">0.90</span>)</a></code></pre></div>
<div class="sourceCode" id="cb425"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb425-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">level =</span> levels) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb425-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb425-3" data-line-number="3">    <span class="dt">ci_lower =</span> x_bar <span class="op">-</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>level) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se,</a>
<a class="sourceLine" id="cb425-4" data-line-number="4">    <span class="dt">ci_upper =</span> x_bar <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>level) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se</a>
<a class="sourceLine" id="cb425-5" data-line-number="5">  )</a>
<a class="sourceLine" id="cb425-6" data-line-number="6"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb425-7" data-line-number="7"><span class="co">#&gt;   level ci_lower ci_upper</span></a>
<a class="sourceLine" id="cb425-8" data-line-number="8"><span class="co">#&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb425-9" data-line-number="9"><span class="co">#&gt; 1 0.990    0.560    0.640</span></a>
<a class="sourceLine" id="cb425-10" data-line-number="10"><span class="co">#&gt; 2 0.950    0.570    0.630</span></a>
<a class="sourceLine" id="cb425-11" data-line-number="11"><span class="co">#&gt; 3 0.900    0.575    0.625</span></a></code></pre></div>
<p>Calculate the coverage ratio of the 95% confidence interval in the PATE simulations.</p>
<div class="sourceCode" id="cb426"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb426-1" data-line-number="1">level &lt;-<span class="st"> </span><span class="fl">0.95</span></a>
<a class="sourceLine" id="cb426-2" data-line-number="2">pate_sims_se <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb426-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ci_lower =</span> diff_mean <span class="op">-</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>level) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se,</a>
<a class="sourceLine" id="cb426-4" data-line-number="4">         <span class="dt">ci_upper =</span> diff_mean <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>level) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se,</a>
<a class="sourceLine" id="cb426-5" data-line-number="5">         <span class="dt">includes_pate =</span> PATE <span class="op">&gt;</span><span class="st"> </span>ci_lower <span class="op">&amp;</span><span class="st"> </span>PATE <span class="op">&lt;</span><span class="st"> </span>ci_upper) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb426-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">coverage =</span> <span class="kw">mean</span>(includes_pate))</a>
<a class="sourceLine" id="cb426-7" data-line-number="7"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb426-8" data-line-number="8"><span class="co">#&gt;   coverage</span></a>
<a class="sourceLine" id="cb426-9" data-line-number="9"><span class="co">#&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb426-10" data-line-number="10"><span class="co">#&gt; 1    0.948</span></a></code></pre></div>
<p>To do this for multiple levels encapsulate the above code in a function with arguments <code>.data</code> (the data frame) and the confidence level, <code>level</code>:</p>
<div class="sourceCode" id="cb427"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb427-1" data-line-number="1">pate_sims_coverage &lt;-<span class="st"> </span><span class="cf">function</span>(.data, <span class="dt">level =</span> <span class="fl">0.95</span>) {</a>
<a class="sourceLine" id="cb427-2" data-line-number="2">  <span class="kw">mutate</span>(.data,</a>
<a class="sourceLine" id="cb427-3" data-line-number="3">         <span class="dt">ci_lower =</span> diff_mean <span class="op">-</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>level) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se,</a>
<a class="sourceLine" id="cb427-4" data-line-number="4">         <span class="dt">ci_upper =</span> diff_mean <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>level) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se,</a>
<a class="sourceLine" id="cb427-5" data-line-number="5">         <span class="dt">includes_pate =</span> PATE <span class="op">&gt;</span><span class="st"> </span>ci_lower <span class="op">&amp;</span><span class="st"> </span>PATE <span class="op">&lt;</span><span class="st"> </span>ci_upper) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb427-6" data-line-number="6"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">coverage =</span> <span class="kw">mean</span>(includes_pate))</a>
<a class="sourceLine" id="cb427-7" data-line-number="7">}</a></code></pre></div>
<div class="sourceCode" id="cb428"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb428-1" data-line-number="1"><span class="kw">pate_sims_coverage</span>(pate_sims_se, <span class="fl">0.95</span>)</a>
<a class="sourceLine" id="cb428-2" data-line-number="2"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb428-3" data-line-number="3"><span class="co">#&gt;   coverage</span></a>
<a class="sourceLine" id="cb428-4" data-line-number="4"><span class="co">#&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb428-5" data-line-number="5"><span class="co">#&gt; 1    0.948</span></a>
<a class="sourceLine" id="cb428-6" data-line-number="6"><span class="kw">pate_sims_coverage</span>(pate_sims_se, <span class="fl">0.99</span>)</a>
<a class="sourceLine" id="cb428-7" data-line-number="7"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb428-8" data-line-number="8"><span class="co">#&gt;   coverage</span></a>
<a class="sourceLine" id="cb428-9" data-line-number="9"><span class="co">#&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb428-10" data-line-number="10"><span class="co">#&gt; 1    0.989</span></a>
<a class="sourceLine" id="cb428-11" data-line-number="11"><span class="kw">pate_sims_coverage</span>(pate_sims_se, <span class="fl">0.90</span>)</a>
<a class="sourceLine" id="cb428-12" data-line-number="12"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb428-13" data-line-number="13"><span class="co">#&gt;   coverage</span></a>
<a class="sourceLine" id="cb428-14" data-line-number="14"><span class="co">#&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb428-15" data-line-number="15"><span class="co">#&gt; 1    0.898</span></a></code></pre></div>
<div class="sourceCode" id="cb429"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb429-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="fl">0.6</span></a>
<a class="sourceLine" id="cb429-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb429-3" data-line-number="3">alpha &lt;-<span class="st"> </span><span class="fl">0.05</span></a>
<a class="sourceLine" id="cb429-4" data-line-number="4">sims &lt;-<span class="st"> </span><span class="dv">5000</span></a></code></pre></div>
<p>Define a function that samples from a Bernoulli distribution, calculates its standard error, and returns a logical value as to whether it contains the true value:</p>
<div class="sourceCode" id="cb430"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb430-1" data-line-number="1">binom_ci_contains &lt;-<span class="st"> </span><span class="cf">function</span>(n, p, <span class="dt">alpha =</span> <span class="fl">0.05</span>) {</a>
<a class="sourceLine" id="cb430-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> p)</a>
<a class="sourceLine" id="cb430-3" data-line-number="3">  x_bar &lt;-<span class="st"> </span><span class="kw">mean</span>(x)</a>
<a class="sourceLine" id="cb430-4" data-line-number="4">  se &lt;-<span class="st"> </span><span class="kw">sqrt</span>(x_bar <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>x_bar) <span class="op">/</span><span class="st"> </span>n)</a>
<a class="sourceLine" id="cb430-5" data-line-number="5">  ci_lower &lt;-<span class="st"> </span>x_bar <span class="op">-</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se</a>
<a class="sourceLine" id="cb430-6" data-line-number="6">  ci_upper &lt;-<span class="st"> </span>x_bar <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se</a>
<a class="sourceLine" id="cb430-7" data-line-number="7">  (ci_lower <span class="op">&lt;=</span><span class="st"> </span>p) <span class="op">&amp;</span><span class="st"> </span>(p <span class="op">&lt;=</span><span class="st"> </span>ci_upper)</a>
<a class="sourceLine" id="cb430-8" data-line-number="8">}</a></code></pre></div>
<p>We can run this once for given sample size:</p>
<div class="sourceCode" id="cb431"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb431-1" data-line-number="1">n &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb431-2" data-line-number="2"><span class="kw">binom_ci_contains</span>(n, p)</a>
<a class="sourceLine" id="cb431-3" data-line-number="3"><span class="co">#&gt; [1] FALSE</span></a></code></pre></div>
<p>Using <code>map_df</code> we can rerun it <code>sims</code> times and calculate the coverage proportion:</p>
<div class="sourceCode" id="cb432"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb432-1" data-line-number="1"><span class="kw">mean</span>(<span class="kw">map_lgl</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">binom_ci_contains</span>(n, p)))</a>
<a class="sourceLine" id="cb432-2" data-line-number="2"><span class="co">#&gt; [1] 0.905</span></a></code></pre></div>
<p>Encapsulate the above code in a function that calculates the coverage of a confidence interval with size, <code>n</code>, and success probability, <code>p</code>:</p>
<div class="sourceCode" id="cb433"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb433-1" data-line-number="1">binom_ci_coverage &lt;-<span class="st"> </span><span class="cf">function</span>(n, p, sims) {</a>
<a class="sourceLine" id="cb433-2" data-line-number="2">  <span class="kw">mean</span>(<span class="kw">map_lgl</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">binom_ci_contains</span>(n, p)))</a>
<a class="sourceLine" id="cb433-3" data-line-number="3">}</a></code></pre></div>
<p>Use <code>binom_ci_coverage</code> to calculate CI coverage for multiple values of the sample size:</p>
<div class="sourceCode" id="cb434"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb434-1" data-line-number="1"><span class="kw">tibble</span>(<span class="dt">n =</span> <span class="kw">c</span>(10L, 100L, 1000L)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb434-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">coverage =</span> <span class="kw">map_dbl</span>(n, binom_ci_coverage, <span class="dt">p =</span> <span class="op">!!</span>p, <span class="dt">sims =</span> <span class="op">!!</span>sims))</a>
<a class="sourceLine" id="cb434-3" data-line-number="3"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb434-4" data-line-number="4"><span class="co">#&gt;       n coverage</span></a>
<a class="sourceLine" id="cb434-5" data-line-number="5"><span class="co">#&gt;   &lt;int&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb434-6" data-line-number="6"><span class="co">#&gt; 1    10    0.900</span></a>
<a class="sourceLine" id="cb434-7" data-line-number="7"><span class="co">#&gt; 2   100    0.943</span></a>
<a class="sourceLine" id="cb434-8" data-line-number="8"><span class="co">#&gt; 3  1000    0.948</span></a></code></pre></div>
</section>
<section id="margin-of-error-and-sample-size-calculation-in-polls" class="level3">
<h3><span class="header-section-number">7.1.4</span> Margin of Error and Sample Size Calculation in Polls</h3>
<p>Write a function to calculate the sample size needed for a given proportion.</p>
<div class="sourceCode" id="cb435"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb435-1" data-line-number="1">moe_pop_prop &lt;-<span class="st"> </span><span class="cf">function</span>(MoE) {</a>
<a class="sourceLine" id="cb435-2" data-line-number="2">  <span class="kw">tibble</span>(<span class="dt">p =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="fl">0.01</span>, <span class="dt">to =</span> <span class="fl">0.99</span>, <span class="dt">by =</span> <span class="fl">0.01</span>),</a>
<a class="sourceLine" id="cb435-3" data-line-number="3">         <span class="dt">n =</span> <span class="fl">1.96</span> <span class="op">^</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>p <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p) <span class="op">/</span><span class="st"> </span>MoE <span class="op">^</span><span class="st"> </span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb435-4" data-line-number="4">         <span class="dt">MoE =</span> MoE)</a>
<a class="sourceLine" id="cb435-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb435-6" data-line-number="6"><span class="kw">moe_pop_prop</span>(<span class="fl">0.01</span>)</a>
<a class="sourceLine" id="cb435-7" data-line-number="7"><span class="co">#&gt; # A tibble: 99 x 3</span></a>
<a class="sourceLine" id="cb435-8" data-line-number="8"><span class="co">#&gt;        p     n    MoE</span></a>
<a class="sourceLine" id="cb435-9" data-line-number="9"><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb435-10" data-line-number="10"><span class="co">#&gt; 1 0.0100   380 0.0100</span></a>
<a class="sourceLine" id="cb435-11" data-line-number="11"><span class="co">#&gt; 2 0.0200   753 0.0100</span></a>
<a class="sourceLine" id="cb435-12" data-line-number="12"><span class="co">#&gt; 3 0.0300  1118 0.0100</span></a>
<a class="sourceLine" id="cb435-13" data-line-number="13"><span class="co">#&gt; 4 0.0400  1475 0.0100</span></a>
<a class="sourceLine" id="cb435-14" data-line-number="14"><span class="co">#&gt; 5 0.0500  1825 0.0100</span></a>
<a class="sourceLine" id="cb435-15" data-line-number="15"><span class="co">#&gt; 6 0.0600  2167 0.0100</span></a>
<a class="sourceLine" id="cb435-16" data-line-number="16"><span class="co">#&gt; # ... with 93 more rows</span></a></code></pre></div>
<p>Then use <a href="https://www.rdocumentation.org/packages/purrr/topics/map_df">map_df</a> to call this function for different margins of error, and return the entire thing as a data frame with columns: <code>n</code>, <code>p</code>, and <code>MoE</code>.</p>
<div class="sourceCode" id="cb436"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb436-1" data-line-number="1">MoE &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.03</span>, <span class="fl">0.05</span>)</a>
<a class="sourceLine" id="cb436-2" data-line-number="2">props &lt;-<span class="st"> </span><span class="kw">map_df</span>(MoE, moe_pop_prop)</a></code></pre></div>
<p>Since its a data frame, its easy to plot with <a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a>:</p>
<div class="sourceCode" id="cb437"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb437-1" data-line-number="1"><span class="kw">ggplot</span>(props, <span class="kw">aes</span>(<span class="dt">x =</span> p, <span class="dt">y =</span> n, <span class="dt">colour =</span> <span class="kw">factor</span>(MoE))) <span class="op">+</span></a>
<a class="sourceLine" id="cb437-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb437-3" data-line-number="3"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">colour =</span> <span class="st">&quot;margin of error&quot;</span>,</a>
<a class="sourceLine" id="cb437-4" data-line-number="4">       <span class="dt">x =</span> <span class="st">&quot;population proportion&quot;</span>,</a>
<a class="sourceLine" id="cb437-5" data-line-number="5">       <span class="dt">y =</span> <span class="st">&quot;sample size&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb437-6" data-line-number="6"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</a></code></pre></div>
<p><img src="uncertainty_files/figure-html/unnamed-chunk-31-1.png" width="70%" style="display: block; margin: auto;" /> <a href="https://www.rdocumentation.org/packages/readr/topics/read_csv">read_csv</a> already recognizes the date columns, so we don’t need to convert them. The 2008 election was on Nov 11, 2008, so we’ll store that in a variable.</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb438-1" data-line-number="1">ELECTION_DATE &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="dv">20081104</span>)</a></code></pre></div>
<p>Load the final vote shares,</p>
<div class="sourceCode" id="cb439"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb439-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;pres08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>and polling data</p>
<div class="sourceCode" id="cb440"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb440-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;polls08&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>We need to add an additional column to the <code>polls08</code> data frame which contains the number of days until the election:</p>
<div class="sourceCode" id="cb441"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb441-1" data-line-number="1">polls08 &lt;-<span class="st"> </span>polls08 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb441-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">DaysToElection =</span> <span class="kw">as.integer</span>(ELECTION_DATE <span class="op">-</span><span class="st"> </span>middate))</a></code></pre></div>
<p>For each state calculate the mean of the latest polls,</p>
<div class="sourceCode" id="cb442"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb442-1" data-line-number="1">poll_pred &lt;-</a>
<a class="sourceLine" id="cb442-2" data-line-number="2"><span class="st">  </span>polls08 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb442-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(state) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb442-4" data-line-number="4"><span class="st">  </span><span class="co"># latest polls in the state</span></a>
<a class="sourceLine" id="cb442-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(DaysToElection <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(DaysToElection)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb442-6" data-line-number="6"><span class="st">  </span><span class="co"># take mean of latest polls and convert from 0-100 to 0-1</span></a>
<a class="sourceLine" id="cb442-7" data-line-number="7"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">Obama =</span> <span class="kw">mean</span>(Obama) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb442-8" data-line-number="8"><span class="co"># Add confidence itervals</span></a>
<a class="sourceLine" id="cb442-9" data-line-number="9"><span class="co"># sample size</span></a>
<a class="sourceLine" id="cb442-10" data-line-number="10">sample_size &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb442-11" data-line-number="11"><span class="co"># confidence level</span></a>
<a class="sourceLine" id="cb442-12" data-line-number="12">alpha &lt;-<span class="st"> </span><span class="fl">0.05</span></a>
<a class="sourceLine" id="cb442-13" data-line-number="13">poll_pred &lt;-</a>
<a class="sourceLine" id="cb442-14" data-line-number="14"><span class="st">  </span>poll_pred <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb442-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">se =</span> <span class="kw">sqrt</span>(Obama <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Obama) <span class="op">/</span><span class="st"> </span>sample_size),</a>
<a class="sourceLine" id="cb442-16" data-line-number="16">         <span class="dt">ci_lwr =</span> Obama <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se,</a>
<a class="sourceLine" id="cb442-17" data-line-number="17">         <span class="dt">ci_upr =</span> Obama <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se)</a>
<a class="sourceLine" id="cb442-18" data-line-number="18"><span class="co"># Add actual outcome</span></a>
<a class="sourceLine" id="cb442-19" data-line-number="19">poll_pred &lt;-</a>
<a class="sourceLine" id="cb442-20" data-line-number="20"><span class="st">  </span><span class="kw">left_join</span>(poll_pred,</a>
<a class="sourceLine" id="cb442-21" data-line-number="21">            <span class="kw">select</span>(pres08, state, <span class="dt">actual =</span> Obama),</a>
<a class="sourceLine" id="cb442-22" data-line-number="22">            <span class="dt">by =</span> <span class="st">&quot;state&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb442-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">actual =</span> actual <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb442-24" data-line-number="24">         <span class="dt">covers =</span> (ci_lwr <span class="op">&lt;=</span><span class="st"> </span>actual) <span class="op">&amp;</span><span class="st"> </span>(actual <span class="op">&lt;=</span><span class="st"> </span>ci_upr))</a>
<a class="sourceLine" id="cb442-25" data-line-number="25">poll_pred</a>
<a class="sourceLine" id="cb442-26" data-line-number="26"><span class="co">#&gt; # A tibble: 51 x 7</span></a>
<a class="sourceLine" id="cb442-27" data-line-number="27"><span class="co">#&gt;   state Obama     se ci_lwr ci_upr actual covers</span></a>
<a class="sourceLine" id="cb442-28" data-line-number="28"><span class="co">#&gt;   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;lgl&gt; </span></a>
<a class="sourceLine" id="cb442-29" data-line-number="29"><span class="co">#&gt; 1 AK    0.390 0.0154  0.360  0.420  0.380 T     </span></a>
<a class="sourceLine" id="cb442-30" data-line-number="30"><span class="co">#&gt; 2 AL    0.360 0.0152  0.330  0.390  0.390 F     </span></a>
<a class="sourceLine" id="cb442-31" data-line-number="31"><span class="co">#&gt; 3 AR    0.440 0.0157  0.409  0.471  0.390 F     </span></a>
<a class="sourceLine" id="cb442-32" data-line-number="32"><span class="co">#&gt; 4 AZ    0.465 0.0158  0.434  0.496  0.450 T     </span></a>
<a class="sourceLine" id="cb442-33" data-line-number="33"><span class="co">#&gt; 5 CA    0.600 0.0155  0.570  0.630  0.610 T     </span></a>
<a class="sourceLine" id="cb442-34" data-line-number="34"><span class="co">#&gt; 6 CO    0.520 0.0158  0.489  0.551  0.540 T     </span></a>
<a class="sourceLine" id="cb442-35" data-line-number="35"><span class="co">#&gt; # ... with 45 more rows</span></a></code></pre></div>
<p>In the plot, color the point ranges by whether they include the election day outcome.</p>
<div class="sourceCode" id="cb443"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb443-1" data-line-number="1"><span class="kw">ggplot</span>(poll_pred, <span class="kw">aes</span>(<span class="dt">x =</span> actual, <span class="dt">y =</span> Obama,</a>
<a class="sourceLine" id="cb443-2" data-line-number="2">                      <span class="dt">ymin =</span> ci_lwr, <span class="dt">ymax =</span> ci_upr,</a>
<a class="sourceLine" id="cb443-3" data-line-number="3">                      <span class="dt">colour =</span> covers)) <span class="op">+</span></a>
<a class="sourceLine" id="cb443-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb443-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_pointrange</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb443-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Poll prediction&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb443-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Obama&#39;s vote share&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb443-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_colour_discrete</span>(<span class="st">&quot;CI includes result?&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb443-9" data-line-number="9"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb443-10" data-line-number="10"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</a></code></pre></div>
<p><img src="uncertainty_files/figure-html/unnamed-chunk-36-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Proportion of polls with confidence intervals that include the election outcome?</p>
<div class="sourceCode" id="cb444"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb444-1" data-line-number="1">poll_pred <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb444-2" data-line-number="2"><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(covers))</a>
<a class="sourceLine" id="cb444-3" data-line-number="3"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb444-4" data-line-number="4"><span class="co">#&gt;   `mean(covers)`</span></a>
<a class="sourceLine" id="cb444-5" data-line-number="5"><span class="co">#&gt;            &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb444-6" data-line-number="6"><span class="co">#&gt; 1          0.588</span></a></code></pre></div>
<div class="sourceCode" id="cb445"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb445-1" data-line-number="1">poll_pred &lt;-</a>
<a class="sourceLine" id="cb445-2" data-line-number="2"><span class="st">  </span>poll_pred <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb445-3" data-line-number="3"><span class="st">  </span><span class="co"># calc bias</span></a>
<a class="sourceLine" id="cb445-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">bias =</span> Obama <span class="op">-</span><span class="st"> </span>actual) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb445-5" data-line-number="5"><span class="st">  </span><span class="co"># bias corrected prediction, se, and CI</span></a>
<a class="sourceLine" id="cb445-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Obama_bc =</span> Obama <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(bias),</a>
<a class="sourceLine" id="cb445-7" data-line-number="7">         <span class="dt">se_bc =</span> <span class="kw">sqrt</span>(Obama_bc <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Obama_bc) <span class="op">/</span><span class="st"> </span>sample_size),</a>
<a class="sourceLine" id="cb445-8" data-line-number="8">         <span class="dt">ci_lwr_bc =</span> Obama_bc <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se_bc,</a>
<a class="sourceLine" id="cb445-9" data-line-number="9">         <span class="dt">ci_upr_bc =</span> Obama_bc <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se_bc,</a>
<a class="sourceLine" id="cb445-10" data-line-number="10">         <span class="dt">covers_bc =</span> (ci_lwr_bc <span class="op">&lt;=</span><span class="st"> </span>actual) <span class="op">&amp;</span><span class="st"> </span>(actual <span class="op">&lt;=</span><span class="st"> </span>ci_upr_bc))</a>
<a class="sourceLine" id="cb445-11" data-line-number="11">poll_pred <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb445-12" data-line-number="12"><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(covers_bc))</a>
<a class="sourceLine" id="cb445-13" data-line-number="13"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb445-14" data-line-number="14"><span class="co">#&gt;   `mean(covers_bc)`</span></a>
<a class="sourceLine" id="cb445-15" data-line-number="15"><span class="co">#&gt;               &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb445-16" data-line-number="16"><span class="co">#&gt; 1             0.765</span></a></code></pre></div>
</section>
<section id="analysis-of-randomized-controlled-trials" class="level3">
<h3><span class="header-section-number">7.1.5</span> Analysis of Randomized Controlled Trials</h3>
<p>Load the <code>STAR</code> data from the <strong>qss</strong> package,</p>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb446-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;STAR&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<p>Add meaningful labels to the <code>classtype</code> variable:</p>
<div class="sourceCode" id="cb447"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb447-1" data-line-number="1">STAR &lt;-<span class="st"> </span>STAR <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb447-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">classtype =</span> <span class="kw">factor</span>(classtype,</a>
<a class="sourceLine" id="cb447-3" data-line-number="3">                            <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;small class&quot;</span>, <span class="st">&quot;regular class&quot;</span>,</a>
<a class="sourceLine" id="cb447-4" data-line-number="4">                                       <span class="st">&quot;regular class with aid&quot;</span>)))</a></code></pre></div>
<p>Summarize scores by classroom type:</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb448-1" data-line-number="1">classtype_means &lt;-</a>
<a class="sourceLine" id="cb448-2" data-line-number="2"><span class="st">  </span>STAR <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb448-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(classtype) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb448-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">g4reading =</span> <span class="kw">mean</span>(g4reading, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<p>Plot the distribution of scores by classroom type:</p>
<div class="sourceCode" id="cb449"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb449-1" data-line-number="1">classtypes_used &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;small class&quot;</span>, <span class="st">&quot;regular class&quot;</span>)</a>
<a class="sourceLine" id="cb449-2" data-line-number="2"><span class="kw">ggplot</span>(<span class="kw">filter</span>(STAR,</a>
<a class="sourceLine" id="cb449-3" data-line-number="3">              classtype <span class="op">%in%</span><span class="st"> </span>classtypes_used,</a>
<a class="sourceLine" id="cb449-4" data-line-number="4">              <span class="op">!</span><span class="kw">is.na</span>(g4reading)),</a>
<a class="sourceLine" id="cb449-5" data-line-number="5">       <span class="kw">aes</span>(<span class="dt">x =</span> g4reading, <span class="dt">y =</span> ..density..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb449-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">20</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb449-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">data =</span> <span class="kw">filter</span>(classtype_means, classtype <span class="op">%in%</span><span class="st"> </span>classtypes_used),</a>
<a class="sourceLine" id="cb449-8" data-line-number="8">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">xintercept =</span> g4reading),</a>
<a class="sourceLine" id="cb449-9" data-line-number="9">             <span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb449-10" data-line-number="10"><span class="st">  </span><span class="kw">facet_grid</span>(classtype <span class="op">~</span><span class="st"> </span>.) <span class="op">+</span></a>
<a class="sourceLine" id="cb449-11" data-line-number="11"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Fourth grade reading score&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Density&quot;</span>)</a></code></pre></div>
<p><img src="uncertainty_files/figure-html/unnamed-chunk-42-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb450"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb450-1" data-line-number="1">alpha &lt;-<span class="st"> </span><span class="fl">0.05</span></a>
<a class="sourceLine" id="cb450-2" data-line-number="2">star_estimates &lt;-</a>
<a class="sourceLine" id="cb450-3" data-line-number="3"><span class="st">  </span>STAR <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb450-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(g4reading)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb450-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(classtype) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb450-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>(),</a>
<a class="sourceLine" id="cb450-7" data-line-number="7">            <span class="dt">est =</span> <span class="kw">mean</span>(g4reading),</a>
<a class="sourceLine" id="cb450-8" data-line-number="8">            <span class="dt">se =</span> <span class="kw">sd</span>(g4reading) <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb450-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lwr =</span> est <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se,</a>
<a class="sourceLine" id="cb450-10" data-line-number="10">         <span class="dt">upr =</span> est <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se)</a>
<a class="sourceLine" id="cb450-11" data-line-number="11">star_estimates</a>
<a class="sourceLine" id="cb450-12" data-line-number="12"><span class="co">#&gt; # A tibble: 3 x 6</span></a>
<a class="sourceLine" id="cb450-13" data-line-number="13"><span class="co">#&gt;   classtype                  n   est    se   lwr   upr</span></a>
<a class="sourceLine" id="cb450-14" data-line-number="14"><span class="co">#&gt;   &lt;fctr&gt;                 &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb450-15" data-line-number="15"><span class="co">#&gt; 1 small class              726   723  1.91   720   727</span></a>
<a class="sourceLine" id="cb450-16" data-line-number="16"><span class="co">#&gt; 2 regular class            836   720  1.84   716   723</span></a>
<a class="sourceLine" id="cb450-17" data-line-number="17"><span class="co">#&gt; 3 regular class with aid   791   721  1.86   717   724</span></a></code></pre></div>
<div class="sourceCode" id="cb451"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb451-1" data-line-number="1">star_estimates <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb451-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(classtype <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;small class&quot;</span>, <span class="st">&quot;regular class&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb451-3" data-line-number="3"><span class="st">  </span><span class="co"># ensure that it is ordered small then regular</span></a>
<a class="sourceLine" id="cb451-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(classtype)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb451-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb451-6" data-line-number="6">    <span class="dt">se =</span> <span class="kw">sqrt</span>(<span class="kw">sum</span>(se <span class="op">^</span><span class="st"> </span><span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb451-7" data-line-number="7">    <span class="dt">est =</span> <span class="kw">diff</span>(est)</a>
<a class="sourceLine" id="cb451-8" data-line-number="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb451-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ci_lwr =</span> est <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se,</a>
<a class="sourceLine" id="cb451-10" data-line-number="10">         <span class="dt">ci_up =</span> est <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>se)</a>
<a class="sourceLine" id="cb451-11" data-line-number="11"><span class="co">#&gt; # A tibble: 1 x 4</span></a>
<a class="sourceLine" id="cb451-12" data-line-number="12"><span class="co">#&gt;      se   est ci_lwr ci_up</span></a>
<a class="sourceLine" id="cb451-13" data-line-number="13"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb451-14" data-line-number="14"><span class="co">#&gt; 1  2.65  3.50  -1.70  8.70</span></a></code></pre></div>
<p>Use we could use <a href="https://www.rdocumentation.org/packages/tidyr/topics/spread">spread</a> and <a href="https://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a>:</p>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb452-1" data-line-number="1">star_ate &lt;-</a>
<a class="sourceLine" id="cb452-2" data-line-number="2"><span class="st">  </span>star_estimates <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb452-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(classtype <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;small class&quot;</span>, <span class="st">&quot;regular class&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb452-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">classtype =</span> <span class="kw">fct_recode</span>(<span class="kw">factor</span>(classtype),</a>
<a class="sourceLine" id="cb452-5" data-line-number="5">                                <span class="st">&quot;small&quot;</span> =<span class="st"> &quot;small class&quot;</span>,</a>
<a class="sourceLine" id="cb452-6" data-line-number="6">                                <span class="st">&quot;regular&quot;</span> =<span class="st"> &quot;regular class&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb452-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(classtype, est, se) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb452-8" data-line-number="8"><span class="st">  </span><span class="kw">gather</span>(stat, value, <span class="op">-</span>classtype) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb452-9" data-line-number="9"><span class="st">  </span><span class="kw">unite</span>(variable, stat, classtype)  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb452-10" data-line-number="10"><span class="st">  </span><span class="kw">spread</span>(variable, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb452-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ate_est =</span> est_small <span class="op">-</span><span class="st"> </span>est_regular,</a>
<a class="sourceLine" id="cb452-12" data-line-number="12">         <span class="dt">ate_se =</span> <span class="kw">sqrt</span>(se_small <span class="op">^</span><span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>se_regular <span class="op">^</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb452-13" data-line-number="13">         <span class="dt">ci_lwr =</span> ate_est <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>ate_se,</a>
<a class="sourceLine" id="cb452-14" data-line-number="14">         <span class="dt">ci_upr =</span> ate_est <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>ate_se)</a>
<a class="sourceLine" id="cb452-15" data-line-number="15">star_ate</a>
<a class="sourceLine" id="cb452-16" data-line-number="16"><span class="co">#&gt; # A tibble: 1 x 8</span></a>
<a class="sourceLine" id="cb452-17" data-line-number="17"><span class="co">#&gt;   est_regular est_small se_regular se_small ate_est ate_se ci_lwr ci_upr</span></a>
<a class="sourceLine" id="cb452-18" data-line-number="18"><span class="co">#&gt;         &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb452-19" data-line-number="19"><span class="co">#&gt; 1         720       723       1.84     1.91    3.50   2.65  -1.70   8.70</span></a></code></pre></div>
</section>
<section id="analysis-based-on-students-t-distribution" class="level3">
<h3><span class="header-section-number">7.1.6</span> Analysis Based on Student’s t-Distribution</h3>
<p>Use <a href="https://www.rdocumentation.org/packages/dplyr/topics/filter">filter</a> to subset.</p>
<div class="sourceCode" id="cb453"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb453-1" data-line-number="1"><span class="kw">t.test</span>(<span class="kw">filter</span>(STAR, classtype <span class="op">==</span><span class="st"> &quot;small class&quot;</span>)<span class="op">$</span>g4reading,</a>
<a class="sourceLine" id="cb453-2" data-line-number="2">       <span class="kw">filter</span>(STAR, classtype <span class="op">==</span><span class="st"> &quot;regular class&quot;</span>)<span class="op">$</span>g4reading)</a>
<a class="sourceLine" id="cb453-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb453-4" data-line-number="4"><span class="co">#&gt;  Welch Two Sample t-test</span></a>
<a class="sourceLine" id="cb453-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb453-6" data-line-number="6"><span class="co">#&gt; data:  filter(STAR, classtype == &quot;small class&quot;)$g4reading and filter(STAR, classtype == &quot;regular class&quot;)$g4reading</span></a>
<a class="sourceLine" id="cb453-7" data-line-number="7"><span class="co">#&gt; t = 1, df = 2000, p-value = 0.2</span></a>
<a class="sourceLine" id="cb453-8" data-line-number="8"><span class="co">#&gt; alternative hypothesis: true difference in means is not equal to 0</span></a>
<a class="sourceLine" id="cb453-9" data-line-number="9"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb453-10" data-line-number="10"><span class="co">#&gt;  -1.70  8.71</span></a>
<a class="sourceLine" id="cb453-11" data-line-number="11"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb453-12" data-line-number="12"><span class="co">#&gt; mean of x mean of y </span></a>
<a class="sourceLine" id="cb453-13" data-line-number="13"><span class="co">#&gt;       723       720</span></a></code></pre></div>
<p>The function <a href="https://www.rdocumentation.org/packages/stat/topics/t.test">t.test</a> can also take a formula as its first parameter.</p>
<div class="sourceCode" id="cb454"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb454-1" data-line-number="1"><span class="kw">t.test</span>(g4reading <span class="op">~</span><span class="st"> </span>classtype,</a>
<a class="sourceLine" id="cb454-2" data-line-number="2">       <span class="dt">data =</span> <span class="kw">filter</span>(STAR, classtype <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;small class&quot;</span>, <span class="st">&quot;regular class&quot;</span>)))</a>
<a class="sourceLine" id="cb454-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb454-4" data-line-number="4"><span class="co">#&gt;  Welch Two Sample t-test</span></a>
<a class="sourceLine" id="cb454-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb454-6" data-line-number="6"><span class="co">#&gt; data:  g4reading by classtype</span></a>
<a class="sourceLine" id="cb454-7" data-line-number="7"><span class="co">#&gt; t = 1, df = 2000, p-value = 0.2</span></a>
<a class="sourceLine" id="cb454-8" data-line-number="8"><span class="co">#&gt; alternative hypothesis: true difference in means is not equal to 0</span></a>
<a class="sourceLine" id="cb454-9" data-line-number="9"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb454-10" data-line-number="10"><span class="co">#&gt;  -1.70  8.71</span></a>
<a class="sourceLine" id="cb454-11" data-line-number="11"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb454-12" data-line-number="12"><span class="co">#&gt;   mean in group small class mean in group regular class </span></a>
<a class="sourceLine" id="cb454-13" data-line-number="13"><span class="co">#&gt;                         723                         720</span></a></code></pre></div>
</section>
</section>
<section id="hypothesis-testing" class="level2">
<h2><span class="header-section-number">7.2</span> Hypothesis Testing</h2>
<section id="tea-testing-experiment" class="level3">
<h3><span class="header-section-number">7.2.1</span> Tea-Testing Experiment</h3>
<div class="sourceCode" id="cb455"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb455-1" data-line-number="1"><span class="co"># Number of cups of tea</span></a>
<a class="sourceLine" id="cb455-2" data-line-number="2">cups &lt;-<span class="st"> </span><span class="dv">4</span></a>
<a class="sourceLine" id="cb455-3" data-line-number="3"><span class="co"># Number guessed correctly</span></a>
<a class="sourceLine" id="cb455-4" data-line-number="4">k &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">seq_len</span>(cups))</a>
<a class="sourceLine" id="cb455-5" data-line-number="5">true &lt;-<span class="st">  </span><span class="kw">tibble</span>(<span class="dt">correct =</span> k <span class="op">*</span><span class="st"> </span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb455-6" data-line-number="6">                <span class="dt">n =</span> <span class="kw">choose</span>(cups, k) <span class="op">*</span><span class="st"> </span><span class="kw">choose</span>(cups, cups <span class="op">-</span><span class="st"> </span>k)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb455-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb455-8" data-line-number="8">true</a>
<a class="sourceLine" id="cb455-9" data-line-number="9"><span class="co">#&gt; # A tibble: 5 x 3</span></a>
<a class="sourceLine" id="cb455-10" data-line-number="10"><span class="co">#&gt;   correct     n   prob</span></a>
<a class="sourceLine" id="cb455-11" data-line-number="11"><span class="co">#&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb455-12" data-line-number="12"><span class="co">#&gt; 1    0     1.00 0.0143</span></a>
<a class="sourceLine" id="cb455-13" data-line-number="13"><span class="co">#&gt; 2    2.00 16.0  0.229 </span></a>
<a class="sourceLine" id="cb455-14" data-line-number="14"><span class="co">#&gt; 3    4.00 36.0  0.514 </span></a>
<a class="sourceLine" id="cb455-15" data-line-number="15"><span class="co">#&gt; 4    6.00 16.0  0.229 </span></a>
<a class="sourceLine" id="cb455-16" data-line-number="16"><span class="co">#&gt; 5    8.00  1.00 0.0143</span></a></code></pre></div>
<div class="sourceCode" id="cb456"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb456-1" data-line-number="1">sims &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb456-2" data-line-number="2">guess &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">guess =</span> <span class="kw">c</span>(<span class="st">&quot;M&quot;</span>, <span class="st">&quot;T&quot;</span>, <span class="st">&quot;T&quot;</span>, <span class="st">&quot;M&quot;</span>, <span class="st">&quot;M&quot;</span>, <span class="st">&quot;T&quot;</span>, <span class="st">&quot;T&quot;</span>, <span class="st">&quot;M&quot;</span>))</a>
<a class="sourceLine" id="cb456-3" data-line-number="3">randomize_tea &lt;-<span class="st"> </span><span class="cf">function</span>(df) {</a>
<a class="sourceLine" id="cb456-4" data-line-number="4">  <span class="co"># randomize the order of teas</span></a>
<a class="sourceLine" id="cb456-5" data-line-number="5">  assignment &lt;-<span class="st"> </span><span class="kw">sample_frac</span>(df, <span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb456-6" data-line-number="6"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">actual =</span> guess)</a>
<a class="sourceLine" id="cb456-7" data-line-number="7">  <span class="kw">bind_cols</span>(df, assignment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb456-8" data-line-number="8"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">correct =</span> <span class="kw">sum</span>(guess <span class="op">==</span><span class="st"> </span>actual))</a>
<a class="sourceLine" id="cb456-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb456-10" data-line-number="10">approx &lt;-</a>
<a class="sourceLine" id="cb456-11" data-line-number="11"><span class="st">  </span><span class="kw">map_df</span>(<span class="kw">seq_len</span>(sims), <span class="op">~</span><span class="st"> </span><span class="kw">randomize_tea</span>(guess)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb456-12" data-line-number="12"><span class="st">  </span><span class="kw">count</span>(correct) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb456-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a>
<a class="sourceLine" id="cb456-14" data-line-number="14"><span class="kw">left_join</span>(<span class="kw">select</span>(approx, correct, <span class="dt">prob_sim =</span> prob),</a>
<a class="sourceLine" id="cb456-15" data-line-number="15">          <span class="kw">select</span>(true, correct, <span class="dt">prob_exact =</span> prob),</a>
<a class="sourceLine" id="cb456-16" data-line-number="16">          <span class="dt">by =</span> <span class="st">&quot;correct&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb456-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> prob_sim <span class="op">-</span><span class="st"> </span>prob_exact)</a>
<a class="sourceLine" id="cb456-18" data-line-number="18"><span class="co">#&gt; # A tibble: 5 x 4</span></a>
<a class="sourceLine" id="cb456-19" data-line-number="19"><span class="co">#&gt;   correct prob_sim prob_exact     diff</span></a>
<a class="sourceLine" id="cb456-20" data-line-number="20"><span class="co">#&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb456-21" data-line-number="21"><span class="co">#&gt; 1    0      0.0110     0.0143 -0.00329</span></a>
<a class="sourceLine" id="cb456-22" data-line-number="22"><span class="co">#&gt; 2    2.00   0.234      0.229   0.00543</span></a>
<a class="sourceLine" id="cb456-23" data-line-number="23"><span class="co">#&gt; 3    4.00   0.486      0.514  -0.0283 </span></a>
<a class="sourceLine" id="cb456-24" data-line-number="24"><span class="co">#&gt; 4    6.00   0.253      0.229   0.0244 </span></a>
<a class="sourceLine" id="cb456-25" data-line-number="25"><span class="co">#&gt; 5    8.00   0.0160     0.0143  0.00171</span></a></code></pre></div>
</section>
<section id="the-general-framework" class="level3">
<h3><span class="header-section-number">7.2.2</span> The General Framework</h3>
<p>The test functions like <a href="https://www.rdocumentation.org/packages/stat/topics/fisher.test">fisher.test</a> do not work particularly well with data frames, and expect vectors or matrices as input, so tidyverse functions are less directly applicable</p>
<div class="sourceCode" id="cb457"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb457-1" data-line-number="1"><span class="co"># all guesses correct</span></a>
<a class="sourceLine" id="cb457-2" data-line-number="2">x &lt;-<span class="st"> </span><span class="kw">tribble</span>(<span class="op">~</span>Guess, <span class="op">~</span>Truth, <span class="op">~</span>Number,</a>
<a class="sourceLine" id="cb457-3" data-line-number="3">             <span class="st">&quot;Milk&quot;</span>, <span class="st">&quot;Milk&quot;</span>, 4L,</a>
<a class="sourceLine" id="cb457-4" data-line-number="4">             <span class="st">&quot;Milk&quot;</span>, <span class="st">&quot;Tea&quot;</span>, 0L,</a>
<a class="sourceLine" id="cb457-5" data-line-number="5">             <span class="st">&quot;Tea&quot;</span>, <span class="st">&quot;Milk&quot;</span>, 0L,</a>
<a class="sourceLine" id="cb457-6" data-line-number="6">             <span class="st">&quot;Tea&quot;</span>, <span class="st">&quot;Tea&quot;</span>, 4L)</a>
<a class="sourceLine" id="cb457-7" data-line-number="7">x</a>
<a class="sourceLine" id="cb457-8" data-line-number="8"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb457-9" data-line-number="9"><span class="co">#&gt;   Guess Truth Number</span></a>
<a class="sourceLine" id="cb457-10" data-line-number="10"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb457-11" data-line-number="11"><span class="co">#&gt; 1 Milk  Milk       4</span></a>
<a class="sourceLine" id="cb457-12" data-line-number="12"><span class="co">#&gt; 2 Milk  Tea        0</span></a>
<a class="sourceLine" id="cb457-13" data-line-number="13"><span class="co">#&gt; 3 Tea   Milk       0</span></a>
<a class="sourceLine" id="cb457-14" data-line-number="14"><span class="co">#&gt; 4 Tea   Tea        4</span></a>
<a class="sourceLine" id="cb457-15" data-line-number="15"><span class="co"># 6 correct guesses</span></a>
<a class="sourceLine" id="cb457-16" data-line-number="16">y &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb457-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Number =</span> <span class="kw">c</span>(3L, 1L, 1L, 3L))</a>
<a class="sourceLine" id="cb457-18" data-line-number="18">y</a>
<a class="sourceLine" id="cb457-19" data-line-number="19"><span class="co">#&gt; # A tibble: 4 x 3</span></a>
<a class="sourceLine" id="cb457-20" data-line-number="20"><span class="co">#&gt;   Guess Truth Number</span></a>
<a class="sourceLine" id="cb457-21" data-line-number="21"><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;</span></a>
<a class="sourceLine" id="cb457-22" data-line-number="22"><span class="co">#&gt; 1 Milk  Milk       3</span></a>
<a class="sourceLine" id="cb457-23" data-line-number="23"><span class="co">#&gt; 2 Milk  Tea        1</span></a>
<a class="sourceLine" id="cb457-24" data-line-number="24"><span class="co">#&gt; 3 Tea   Milk       1</span></a>
<a class="sourceLine" id="cb457-25" data-line-number="25"><span class="co">#&gt; 4 Tea   Tea        3</span></a>
<a class="sourceLine" id="cb457-26" data-line-number="26"><span class="co"># Turn into a 2x2 table for fisher.test</span></a>
<a class="sourceLine" id="cb457-27" data-line-number="27"><span class="kw">select</span>(<span class="kw">spread</span>(x, Truth, Number), <span class="op">-</span>Guess)</a>
<a class="sourceLine" id="cb457-28" data-line-number="28"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb457-29" data-line-number="29"><span class="co">#&gt;    Milk   Tea</span></a>
<a class="sourceLine" id="cb457-30" data-line-number="30"><span class="co">#&gt; * &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb457-31" data-line-number="31"><span class="co">#&gt; 1     4     0</span></a>
<a class="sourceLine" id="cb457-32" data-line-number="32"><span class="co">#&gt; 2     0     4</span></a>
<a class="sourceLine" id="cb457-33" data-line-number="33"><span class="co"># Use spread to make it a 2 x 2 table</span></a>
<a class="sourceLine" id="cb457-34" data-line-number="34"><span class="kw">fisher.test</span>(<span class="kw">select</span>(<span class="kw">spread</span>(x, Truth, Number), <span class="op">-</span>Guess),</a>
<a class="sourceLine" id="cb457-35" data-line-number="35">            <span class="dt">alternative =</span> <span class="st">&quot;greater&quot;</span>)</a>
<a class="sourceLine" id="cb457-36" data-line-number="36"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb457-37" data-line-number="37"><span class="co">#&gt;  Fisher&#39;s Exact Test for Count Data</span></a>
<a class="sourceLine" id="cb457-38" data-line-number="38"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb457-39" data-line-number="39"><span class="co">#&gt; data:  select(spread(x, Truth, Number), -Guess)</span></a>
<a class="sourceLine" id="cb457-40" data-line-number="40"><span class="co">#&gt; p-value = 0.01</span></a>
<a class="sourceLine" id="cb457-41" data-line-number="41"><span class="co">#&gt; alternative hypothesis: true odds ratio is greater than 1</span></a>
<a class="sourceLine" id="cb457-42" data-line-number="42"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb457-43" data-line-number="43"><span class="co">#&gt;    2 Inf</span></a>
<a class="sourceLine" id="cb457-44" data-line-number="44"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb457-45" data-line-number="45"><span class="co">#&gt; odds ratio </span></a>
<a class="sourceLine" id="cb457-46" data-line-number="46"><span class="co">#&gt;        Inf</span></a>
<a class="sourceLine" id="cb457-47" data-line-number="47"><span class="kw">fisher.test</span>(<span class="kw">select</span>(<span class="kw">spread</span>(y, Truth, Number), <span class="op">-</span>Guess))</a>
<a class="sourceLine" id="cb457-48" data-line-number="48"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb457-49" data-line-number="49"><span class="co">#&gt;  Fisher&#39;s Exact Test for Count Data</span></a>
<a class="sourceLine" id="cb457-50" data-line-number="50"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb457-51" data-line-number="51"><span class="co">#&gt; data:  select(spread(y, Truth, Number), -Guess)</span></a>
<a class="sourceLine" id="cb457-52" data-line-number="52"><span class="co">#&gt; p-value = 0.5</span></a>
<a class="sourceLine" id="cb457-53" data-line-number="53"><span class="co">#&gt; alternative hypothesis: true odds ratio is not equal to 1</span></a>
<a class="sourceLine" id="cb457-54" data-line-number="54"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb457-55" data-line-number="55"><span class="co">#&gt;    0.212 621.934</span></a>
<a class="sourceLine" id="cb457-56" data-line-number="56"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb457-57" data-line-number="57"><span class="co">#&gt; odds ratio </span></a>
<a class="sourceLine" id="cb457-58" data-line-number="58"><span class="co">#&gt;       6.41</span></a></code></pre></div>
</section>
<section id="one-sample-tests" class="level3">
<h3><span class="header-section-number">7.2.3</span> One-Sample Tests</h3>
<div class="sourceCode" id="cb458"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb458-1" data-line-number="1">n &lt;-<span class="st"> </span><span class="dv">1018</span></a>
<a class="sourceLine" id="cb458-2" data-line-number="2">x.bar &lt;-<span class="st"> </span><span class="dv">550</span> <span class="op">/</span><span class="st"> </span>n</a>
<a class="sourceLine" id="cb458-3" data-line-number="3">se &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.5</span> <span class="op">/</span><span class="st"> </span>n) <span class="co"># standard deviation of sampling distribution</span></a>
<a class="sourceLine" id="cb458-4" data-line-number="4"><span class="co"># upper red area in the figure</span></a>
<a class="sourceLine" id="cb458-5" data-line-number="5">upper &lt;-<span class="st"> </span><span class="kw">pnorm</span>(x.bar, <span class="dt">mean =</span> <span class="fl">0.5</span>, <span class="dt">sd =</span> se, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb458-6" data-line-number="6"><span class="co"># lower red area in the figure; identical to the upper area</span></a>
<a class="sourceLine" id="cb458-7" data-line-number="7">lower &lt;-<span class="st"> </span><span class="kw">pnorm</span>(<span class="fl">0.5</span> <span class="op">-</span><span class="st"> </span>(x.bar <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>), <span class="dt">mean =</span> <span class="fl">0.5</span>, <span class="dt">sd =</span> se)</a>
<a class="sourceLine" id="cb458-8" data-line-number="8"><span class="co"># two side p value</span></a>
<a class="sourceLine" id="cb458-9" data-line-number="9">upper <span class="op">+</span><span class="st"> </span>lower</a>
<a class="sourceLine" id="cb458-10" data-line-number="10"><span class="co">#&gt; [1] 0.0102</span></a>
<a class="sourceLine" id="cb458-11" data-line-number="11"><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>upper</a>
<a class="sourceLine" id="cb458-12" data-line-number="12"><span class="co">#&gt; [1] 0.0102</span></a>
<a class="sourceLine" id="cb458-13" data-line-number="13"><span class="co"># one sided p value</span></a>
<a class="sourceLine" id="cb458-14" data-line-number="14">upper</a>
<a class="sourceLine" id="cb458-15" data-line-number="15"><span class="co">#&gt; [1] 0.00508</span></a>
<a class="sourceLine" id="cb458-16" data-line-number="16">z.score &lt;-<span class="st"> </span>(x.bar <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">/</span><span class="st"> </span>se</a>
<a class="sourceLine" id="cb458-17" data-line-number="17">z.score</a>
<a class="sourceLine" id="cb458-18" data-line-number="18"><span class="co">#&gt; [1] 2.57</span></a>
<a class="sourceLine" id="cb458-19" data-line-number="19"><span class="kw">pnorm</span>(z.score, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>) <span class="co"># one-sided p-value</span></a>
<a class="sourceLine" id="cb458-20" data-line-number="20"><span class="co">#&gt; [1] 0.00508</span></a>
<a class="sourceLine" id="cb458-21" data-line-number="21"><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(z.score, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>) <span class="co"># two-sided p-value</span></a>
<a class="sourceLine" id="cb458-22" data-line-number="22"><span class="co">#&gt; [1] 0.0102</span></a>
<a class="sourceLine" id="cb458-23" data-line-number="23"><span class="co"># 99% confidence interval contains 0.5</span></a>
<a class="sourceLine" id="cb458-24" data-line-number="24"><span class="kw">c</span>(x.bar <span class="op">-</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.995</span>) <span class="op">*</span><span class="st"> </span>se, x.bar <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.995</span>) <span class="op">*</span><span class="st"> </span>se)</a>
<a class="sourceLine" id="cb458-25" data-line-number="25"><span class="co">#&gt; [1] 0.500 0.581</span></a>
<a class="sourceLine" id="cb458-26" data-line-number="26"><span class="co"># 95% confidence interval does not contain 0.5</span></a>
<a class="sourceLine" id="cb458-27" data-line-number="27"><span class="kw">c</span>(x.bar <span class="op">-</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>) <span class="op">*</span><span class="st"> </span>se, x.bar <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>) <span class="op">*</span><span class="st"> </span>se)</a>
<a class="sourceLine" id="cb458-28" data-line-number="28"><span class="co">#&gt; [1] 0.510 0.571</span></a>
<a class="sourceLine" id="cb458-29" data-line-number="29"><span class="co"># no continuity correction to get the same p-value as above</span></a>
<a class="sourceLine" id="cb458-30" data-line-number="30"><span class="kw">prop.test</span>(<span class="dv">550</span>, <span class="dt">n =</span> n, <span class="dt">p =</span> <span class="fl">0.5</span>, <span class="dt">correct =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb458-31" data-line-number="31"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb458-32" data-line-number="32"><span class="co">#&gt;  1-sample proportions test without continuity correction</span></a>
<a class="sourceLine" id="cb458-33" data-line-number="33"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb458-34" data-line-number="34"><span class="co">#&gt; data:  550 out of n, null probability 0.5</span></a>
<a class="sourceLine" id="cb458-35" data-line-number="35"><span class="co">#&gt; X-squared = 7, df = 1, p-value = 0.01</span></a>
<a class="sourceLine" id="cb458-36" data-line-number="36"><span class="co">#&gt; alternative hypothesis: true p is not equal to 0.5</span></a>
<a class="sourceLine" id="cb458-37" data-line-number="37"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb458-38" data-line-number="38"><span class="co">#&gt;  0.510 0.571</span></a>
<a class="sourceLine" id="cb458-39" data-line-number="39"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb458-40" data-line-number="40"><span class="co">#&gt;    p </span></a>
<a class="sourceLine" id="cb458-41" data-line-number="41"><span class="co">#&gt; 0.54</span></a>
<a class="sourceLine" id="cb458-42" data-line-number="42"><span class="co"># with continuity correction</span></a>
<a class="sourceLine" id="cb458-43" data-line-number="43"><span class="kw">prop.test</span>(<span class="dv">550</span>, <span class="dt">n =</span> n, <span class="dt">p =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb458-44" data-line-number="44"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb458-45" data-line-number="45"><span class="co">#&gt;  1-sample proportions test with continuity correction</span></a>
<a class="sourceLine" id="cb458-46" data-line-number="46"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb458-47" data-line-number="47"><span class="co">#&gt; data:  550 out of n, null probability 0.5</span></a>
<a class="sourceLine" id="cb458-48" data-line-number="48"><span class="co">#&gt; X-squared = 6, df = 1, p-value = 0.01</span></a>
<a class="sourceLine" id="cb458-49" data-line-number="49"><span class="co">#&gt; alternative hypothesis: true p is not equal to 0.5</span></a>
<a class="sourceLine" id="cb458-50" data-line-number="50"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb458-51" data-line-number="51"><span class="co">#&gt;  0.509 0.571</span></a>
<a class="sourceLine" id="cb458-52" data-line-number="52"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb458-53" data-line-number="53"><span class="co">#&gt;    p </span></a>
<a class="sourceLine" id="cb458-54" data-line-number="54"><span class="co">#&gt; 0.54</span></a>
<a class="sourceLine" id="cb458-55" data-line-number="55"><span class="kw">prop.test</span>(<span class="dv">550</span>, <span class="dt">n =</span> n, <span class="dt">p =</span> <span class="fl">0.5</span>, <span class="dt">conf.level =</span> <span class="fl">0.99</span>)</a>
<a class="sourceLine" id="cb458-56" data-line-number="56"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb458-57" data-line-number="57"><span class="co">#&gt;  1-sample proportions test with continuity correction</span></a>
<a class="sourceLine" id="cb458-58" data-line-number="58"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb458-59" data-line-number="59"><span class="co">#&gt; data:  550 out of n, null probability 0.5</span></a>
<a class="sourceLine" id="cb458-60" data-line-number="60"><span class="co">#&gt; X-squared = 6, df = 1, p-value = 0.01</span></a>
<a class="sourceLine" id="cb458-61" data-line-number="61"><span class="co">#&gt; alternative hypothesis: true p is not equal to 0.5</span></a>
<a class="sourceLine" id="cb458-62" data-line-number="62"><span class="co">#&gt; 99 percent confidence interval:</span></a>
<a class="sourceLine" id="cb458-63" data-line-number="63"><span class="co">#&gt;  0.499 0.581</span></a>
<a class="sourceLine" id="cb458-64" data-line-number="64"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb458-65" data-line-number="65"><span class="co">#&gt;    p </span></a>
<a class="sourceLine" id="cb458-66" data-line-number="66"><span class="co">#&gt; 0.54</span></a></code></pre></div>
<div class="sourceCode" id="cb459"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb459-1" data-line-number="1"><span class="co"># two-sided one-sample t-test</span></a>
<a class="sourceLine" id="cb459-2" data-line-number="2"><span class="kw">t.test</span>(STAR<span class="op">$</span>g4reading, <span class="dt">mu =</span> <span class="dv">710</span>)</a>
<a class="sourceLine" id="cb459-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb459-4" data-line-number="4"><span class="co">#&gt;  One Sample t-test</span></a>
<a class="sourceLine" id="cb459-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb459-6" data-line-number="6"><span class="co">#&gt; data:  STAR$g4reading</span></a>
<a class="sourceLine" id="cb459-7" data-line-number="7"><span class="co">#&gt; t = 10, df = 2000, p-value &lt;2e-16</span></a>
<a class="sourceLine" id="cb459-8" data-line-number="8"><span class="co">#&gt; alternative hypothesis: true mean is not equal to 710</span></a>
<a class="sourceLine" id="cb459-9" data-line-number="9"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb459-10" data-line-number="10"><span class="co">#&gt;  719 723</span></a>
<a class="sourceLine" id="cb459-11" data-line-number="11"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb459-12" data-line-number="12"><span class="co">#&gt; mean of x </span></a>
<a class="sourceLine" id="cb459-13" data-line-number="13"><span class="co">#&gt;       721</span></a></code></pre></div>
</section>
<section id="two-sample-tests" class="level3">
<h3><span class="header-section-number">7.2.4</span> Two-sample tests</h3>
<p>The ATE estimates are stored in a data frame, <code>star_ate</code>. Note that the <a href="https://cran.r-project.org/package=dplyr">dplyr</a> function <a href="https://www.rdocumentation.org/packages/dplyr/topics/transmute">transmute</a> is like <code>mutate</code>, but only returns the variables specified in the function.</p>
<div class="sourceCode" id="cb460"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb460-1" data-line-number="1">star_ate <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb460-2" data-line-number="2"><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">p_value_1sided =</span> <span class="kw">pnorm</span>(<span class="op">-</span><span class="kw">abs</span>(ate_est),</a>
<a class="sourceLine" id="cb460-3" data-line-number="3">                                   <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> ate_se),</a>
<a class="sourceLine" id="cb460-4" data-line-number="4">            <span class="dt">p_value_2sided =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="op">-</span><span class="kw">abs</span>(ate_est), <span class="dt">mean =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb460-5" data-line-number="5">                                   <span class="dt">sd =</span> ate_se))</a>
<a class="sourceLine" id="cb460-6" data-line-number="6"><span class="co">#&gt; # A tibble: 1 x 2</span></a>
<a class="sourceLine" id="cb460-7" data-line-number="7"><span class="co">#&gt;   p_value_1sided p_value_2sided</span></a>
<a class="sourceLine" id="cb460-8" data-line-number="8"><span class="co">#&gt;            &lt;dbl&gt;          &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb460-9" data-line-number="9"><span class="co">#&gt; 1         0.0935          0.187</span></a></code></pre></div>
<div class="sourceCode" id="cb461"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb461-1" data-line-number="1"><span class="kw">t.test</span>(g4reading <span class="op">~</span><span class="st"> </span>classtype,</a>
<a class="sourceLine" id="cb461-2" data-line-number="2">  <span class="dt">data =</span> <span class="kw">filter</span>(STAR, classtype <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;small class&quot;</span>, <span class="st">&quot;regular class&quot;</span>)))</a>
<a class="sourceLine" id="cb461-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb461-4" data-line-number="4"><span class="co">#&gt;  Welch Two Sample t-test</span></a>
<a class="sourceLine" id="cb461-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb461-6" data-line-number="6"><span class="co">#&gt; data:  g4reading by classtype</span></a>
<a class="sourceLine" id="cb461-7" data-line-number="7"><span class="co">#&gt; t = 1, df = 2000, p-value = 0.2</span></a>
<a class="sourceLine" id="cb461-8" data-line-number="8"><span class="co">#&gt; alternative hypothesis: true difference in means is not equal to 0</span></a>
<a class="sourceLine" id="cb461-9" data-line-number="9"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb461-10" data-line-number="10"><span class="co">#&gt;  -1.70  8.71</span></a>
<a class="sourceLine" id="cb461-11" data-line-number="11"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb461-12" data-line-number="12"><span class="co">#&gt;   mean in group small class mean in group regular class </span></a>
<a class="sourceLine" id="cb461-13" data-line-number="13"><span class="co">#&gt;                         723                         720</span></a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb462"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb462-1" data-line-number="1"><span class="kw">t.test</span>(<span class="kw">filter</span>(STAR, classtype <span class="op">==</span><span class="st"> &quot;small class&quot;</span>)<span class="op">$</span>g4reading,</a>
<a class="sourceLine" id="cb462-2" data-line-number="2">       <span class="kw">filter</span>(STAR, classtype <span class="op">==</span><span class="st"> &quot;regular class&quot;</span>)<span class="op">$</span>g4reading)</a>
<a class="sourceLine" id="cb462-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb462-4" data-line-number="4"><span class="co">#&gt;  Welch Two Sample t-test</span></a>
<a class="sourceLine" id="cb462-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb462-6" data-line-number="6"><span class="co">#&gt; data:  filter(STAR, classtype == &quot;small class&quot;)$g4reading and filter(STAR, classtype == &quot;regular class&quot;)$g4reading</span></a>
<a class="sourceLine" id="cb462-7" data-line-number="7"><span class="co">#&gt; t = 1, df = 2000, p-value = 0.2</span></a>
<a class="sourceLine" id="cb462-8" data-line-number="8"><span class="co">#&gt; alternative hypothesis: true difference in means is not equal to 0</span></a>
<a class="sourceLine" id="cb462-9" data-line-number="9"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb462-10" data-line-number="10"><span class="co">#&gt;  -1.70  8.71</span></a>
<a class="sourceLine" id="cb462-11" data-line-number="11"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb462-12" data-line-number="12"><span class="co">#&gt; mean of x mean of y </span></a>
<a class="sourceLine" id="cb462-13" data-line-number="13"><span class="co">#&gt;       723       720</span></a></code></pre></div>
<div class="sourceCode" id="cb463"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb463-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;resume&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb463-2" data-line-number="2">x &lt;-<span class="st"> </span>resume <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb463-3" data-line-number="3"><span class="st">  </span><span class="kw">count</span>(race, call) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb463-4" data-line-number="4"><span class="st">  </span><span class="kw">spread</span>(call, n) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb463-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb463-6" data-line-number="6">x</a>
<a class="sourceLine" id="cb463-7" data-line-number="7"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb463-8" data-line-number="8"><span class="co">#&gt;   race    `0`   `1`</span></a>
<a class="sourceLine" id="cb463-9" data-line-number="9"><span class="co">#&gt; * &lt;chr&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb463-10" data-line-number="10"><span class="co">#&gt; 1 black  2278   157</span></a>
<a class="sourceLine" id="cb463-11" data-line-number="11"><span class="co">#&gt; 2 white  2200   235</span></a>
<a class="sourceLine" id="cb463-12" data-line-number="12"><span class="kw">prop.test</span>(<span class="kw">as.matrix</span>(<span class="kw">select</span>(x, <span class="op">-</span>race)), <span class="dt">alternative =</span> <span class="st">&quot;greater&quot;</span>)</a>
<a class="sourceLine" id="cb463-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb463-14" data-line-number="14"><span class="co">#&gt;  2-sample test for equality of proportions with continuity</span></a>
<a class="sourceLine" id="cb463-15" data-line-number="15"><span class="co">#&gt;  correction</span></a>
<a class="sourceLine" id="cb463-16" data-line-number="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb463-17" data-line-number="17"><span class="co">#&gt; data:  as.matrix(select(x, -race))</span></a>
<a class="sourceLine" id="cb463-18" data-line-number="18"><span class="co">#&gt; X-squared = 20, df = 1, p-value = 2e-05</span></a>
<a class="sourceLine" id="cb463-19" data-line-number="19"><span class="co">#&gt; alternative hypothesis: greater</span></a>
<a class="sourceLine" id="cb463-20" data-line-number="20"><span class="co">#&gt; 95 percent confidence interval:</span></a>
<a class="sourceLine" id="cb463-21" data-line-number="21"><span class="co">#&gt;  0.0188 1.0000</span></a>
<a class="sourceLine" id="cb463-22" data-line-number="22"><span class="co">#&gt; sample estimates:</span></a>
<a class="sourceLine" id="cb463-23" data-line-number="23"><span class="co">#&gt; prop 1 prop 2 </span></a>
<a class="sourceLine" id="cb463-24" data-line-number="24"><span class="co">#&gt;  0.936  0.903</span></a></code></pre></div>
<div class="sourceCode" id="cb464"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb464-1" data-line-number="1"><span class="co"># sample size</span></a>
<a class="sourceLine" id="cb464-2" data-line-number="2">n0 &lt;-<span class="st"> </span><span class="kw">sum</span>(resume<span class="op">$</span>race <span class="op">==</span><span class="st"> &quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb464-3" data-line-number="3">n1 &lt;-<span class="st"> </span><span class="kw">sum</span>(resume<span class="op">$</span>race <span class="op">==</span><span class="st"> &quot;white&quot;</span>)</a>
<a class="sourceLine" id="cb464-4" data-line-number="4"><span class="co"># sample proportions</span></a>
<a class="sourceLine" id="cb464-5" data-line-number="5">p &lt;-<span class="st"> </span><span class="kw">mean</span>(resume<span class="op">$</span>call) <span class="co"># overall</span></a>
<a class="sourceLine" id="cb464-6" data-line-number="6">p0 &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">filter</span>(resume, race <span class="op">==</span><span class="st"> &quot;black&quot;</span>)<span class="op">$</span>call)</a>
<a class="sourceLine" id="cb464-7" data-line-number="7">p1 &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">filter</span>(resume, race <span class="op">==</span><span class="st"> &quot;white&quot;</span>)<span class="op">$</span>call)</a>
<a class="sourceLine" id="cb464-8" data-line-number="8"><span class="co"># point estimate</span></a>
<a class="sourceLine" id="cb464-9" data-line-number="9">est &lt;-<span class="st"> </span>p1 <span class="op">-</span><span class="st"> </span>p0</a>
<a class="sourceLine" id="cb464-10" data-line-number="10">est</a>
<a class="sourceLine" id="cb464-11" data-line-number="11"><span class="co">#&gt; [1] 0.032</span></a>
<a class="sourceLine" id="cb464-12" data-line-number="12"><span class="co"># standard error</span></a>
<a class="sourceLine" id="cb464-13" data-line-number="13">se &lt;-<span class="st"> </span><span class="kw">sqrt</span>(p <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p) <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>n0 <span class="op">+</span><span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>n1))</a>
<a class="sourceLine" id="cb464-14" data-line-number="14">se</a>
<a class="sourceLine" id="cb464-15" data-line-number="15"><span class="co">#&gt; [1] 0.0078</span></a>
<a class="sourceLine" id="cb464-16" data-line-number="16"><span class="co"># z statistic</span></a>
<a class="sourceLine" id="cb464-17" data-line-number="17">zstat &lt;-<span class="st"> </span>est <span class="op">/</span><span class="st"> </span>se</a>
<a class="sourceLine" id="cb464-18" data-line-number="18">zstat</a>
<a class="sourceLine" id="cb464-19" data-line-number="19"><span class="co">#&gt; [1] 4.11</span></a>
<a class="sourceLine" id="cb464-20" data-line-number="20"><span class="co"># one sided p value</span></a>
<a class="sourceLine" id="cb464-21" data-line-number="21"><span class="kw">pnorm</span>(<span class="op">-</span><span class="kw">abs</span>(zstat))</a>
<a class="sourceLine" id="cb464-22" data-line-number="22"><span class="co">#&gt; [1] 1.99e-05</span></a></code></pre></div>
<p>The only thing that changed is using <a href="https://www.rdocumentation.org/packages/dplyr/topics/filter">filter</a> for selecting the groups.</p>
</section>
<section id="power-analysis" class="level3">
<h3><span class="header-section-number">7.2.5</span> Power Analysis</h3>
<div class="sourceCode" id="cb465"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb465-1" data-line-number="1"><span class="co"># set the parameters</span></a>
<a class="sourceLine" id="cb465-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="dv">250</span></a>
<a class="sourceLine" id="cb465-3" data-line-number="3">p.star &lt;-<span class="st"> </span><span class="fl">0.48</span> <span class="co"># data generating process</span></a>
<a class="sourceLine" id="cb465-4" data-line-number="4">p &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="co"># null value</span></a>
<a class="sourceLine" id="cb465-5" data-line-number="5">alpha &lt;-<span class="st"> </span><span class="fl">0.05</span></a>
<a class="sourceLine" id="cb465-6" data-line-number="6"><span class="co"># critical value</span></a>
<a class="sourceLine" id="cb465-7" data-line-number="7">cr.value &lt;-<span class="st"> </span><span class="kw">qnorm</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb465-8" data-line-number="8"><span class="co"># standard errors under the hypothetical data generating process</span></a>
<a class="sourceLine" id="cb465-9" data-line-number="9">se.star &lt;-<span class="st"> </span><span class="kw">sqrt</span>(p.star <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p.star) <span class="op">/</span><span class="st"> </span>n)</a>
<a class="sourceLine" id="cb465-10" data-line-number="10"><span class="co"># standard error under the null</span></a>
<a class="sourceLine" id="cb465-11" data-line-number="11">se &lt;-<span class="st"> </span><span class="kw">sqrt</span>(p <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p) <span class="op">/</span><span class="st"> </span>n)</a>
<a class="sourceLine" id="cb465-12" data-line-number="12"><span class="co"># power</span></a>
<a class="sourceLine" id="cb465-13" data-line-number="13"><span class="kw">pnorm</span>(p <span class="op">-</span><span class="st"> </span>cr.value <span class="op">*</span><span class="st"> </span>se, <span class="dt">mean =</span> p.star, <span class="dt">sd =</span> se.star) <span class="op">+</span></a>
<a class="sourceLine" id="cb465-14" data-line-number="14"><span class="st">    </span><span class="kw">pnorm</span>(p <span class="op">+</span><span class="st"> </span>cr.value <span class="op">*</span><span class="st"> </span>se, <span class="dt">mean =</span> p.star, <span class="dt">sd =</span> se.star, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb465-15" data-line-number="15"><span class="co"># parameters</span></a>
<a class="sourceLine" id="cb465-16" data-line-number="16">n1 &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb465-17" data-line-number="17">n0 &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb465-18" data-line-number="18">p1.star &lt;-<span class="st"> </span><span class="fl">0.05</span></a>
<a class="sourceLine" id="cb465-19" data-line-number="19">p0.star &lt;-<span class="st"> </span><span class="fl">0.1</span></a>
<a class="sourceLine" id="cb465-20" data-line-number="20"><span class="co"># overall call back rate as a weighted average</span></a>
<a class="sourceLine" id="cb465-21" data-line-number="21">p &lt;-<span class="st"> </span>(n1 <span class="op">*</span><span class="st"> </span>p1.star <span class="op">+</span><span class="st"> </span>n0 <span class="op">*</span><span class="st"> </span>p0.star) <span class="op">/</span><span class="st"> </span>(n1 <span class="op">+</span><span class="st"> </span>n0)</a>
<a class="sourceLine" id="cb465-22" data-line-number="22"><span class="co"># standard error under the null</span></a>
<a class="sourceLine" id="cb465-23" data-line-number="23">se &lt;-<span class="st"> </span><span class="kw">sqrt</span>(p <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p) <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>n1 <span class="op">+</span><span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>n0))</a>
<a class="sourceLine" id="cb465-24" data-line-number="24"><span class="co"># standard error under the hypothetical data generating process</span></a>
<a class="sourceLine" id="cb465-25" data-line-number="25">se.star &lt;-<span class="st"> </span><span class="kw">sqrt</span>(p1.star <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p1.star) <span class="op">/</span><span class="st"> </span>n1 <span class="op">+</span><span class="st"> </span>p0.star <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p0.star) <span class="op">/</span><span class="st"> </span>n0)</a>
<a class="sourceLine" id="cb465-26" data-line-number="26"><span class="kw">pnorm</span>(<span class="op">-</span>cr.value <span class="op">*</span><span class="st"> </span>se, <span class="dt">mean =</span> p1.star <span class="op">-</span><span class="st"> </span>p0.star, <span class="dt">sd =</span> se.star) <span class="op">+</span></a>
<a class="sourceLine" id="cb465-27" data-line-number="27"><span class="st">    </span><span class="kw">pnorm</span>(cr.value <span class="op">*</span><span class="st"> </span>se, <span class="dt">mean =</span> p1.star <span class="op">-</span><span class="st"> </span>p0.star, <span class="dt">sd =</span> se.star,</a>
<a class="sourceLine" id="cb465-28" data-line-number="28">          <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb465-29" data-line-number="29"><span class="kw">power.prop.test</span>(<span class="dt">n =</span> <span class="dv">500</span>, <span class="dt">p1 =</span> <span class="fl">0.05</span>, <span class="dt">p2 =</span> <span class="fl">0.1</span>, <span class="dt">sig.level =</span> <span class="fl">0.05</span>)</a>
<a class="sourceLine" id="cb465-30" data-line-number="30"><span class="kw">power.prop.test</span>(<span class="dt">p1 =</span> <span class="fl">0.05</span>, <span class="dt">p2 =</span> <span class="fl">0.1</span>, <span class="dt">sig.level =</span> <span class="fl">0.05</span>, <span class="dt">power =</span> <span class="fl">0.9</span>)</a>
<a class="sourceLine" id="cb465-31" data-line-number="31"><span class="kw">power.t.test</span>(<span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">delta =</span> <span class="fl">0.25</span>, <span class="dt">sd =</span> <span class="dv">1</span>, <span class="dt">type =</span> <span class="st">&quot;one.sample&quot;</span>)</a>
<a class="sourceLine" id="cb465-32" data-line-number="32"><span class="kw">power.t.test</span>(<span class="dt">power =</span> <span class="fl">0.9</span>, <span class="dt">delta =</span> <span class="fl">0.25</span>, <span class="dt">sd =</span> <span class="dv">1</span>, <span class="dt">type =</span> <span class="st">&quot;one.sample&quot;</span>)</a>
<a class="sourceLine" id="cb465-33" data-line-number="33"><span class="kw">power.t.test</span>(<span class="dt">delta =</span> <span class="fl">0.25</span>, <span class="dt">sd =</span> <span class="dv">1</span>, <span class="dt">type =</span> <span class="st">&quot;two.sample&quot;</span>,</a>
<a class="sourceLine" id="cb465-34" data-line-number="34">             <span class="dt">alternative =</span> <span class="st">&quot;one.sided&quot;</span>, <span class="dt">power =</span> <span class="fl">0.9</span>)</a></code></pre></div>
</section>
</section>
<section id="linear-regression-model-with-uncertainty" class="level2">
<h2><span class="header-section-number">7.3</span> Linear Regression Model with Uncertainty</h2>
<section id="linear-regression-as-a-generative-model" class="level3">
<h3><span class="header-section-number">7.3.1</span> Linear Regression as a Generative Model</h3>
<p>Load the minimum wage date included with the <strong>qss</strong> package:</p>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb466-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;minwage&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb467"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb467-1" data-line-number="1">minwage &lt;-<span class="st"> </span><span class="kw">mutate</span>(minwage,</a>
<a class="sourceLine" id="cb467-2" data-line-number="2">                  <span class="dt">fullPropBefore =</span> fullBefore <span class="op">/</span><span class="st"> </span>(fullBefore <span class="op">+</span><span class="st"> </span>partBefore),</a>
<a class="sourceLine" id="cb467-3" data-line-number="3">                  <span class="dt">fullPropAfter =</span> fullAfter <span class="op">/</span><span class="st"> </span>(fullAfter <span class="op">+</span><span class="st"> </span>partAfter),</a>
<a class="sourceLine" id="cb467-4" data-line-number="4">                  <span class="dt">NJ =</span> <span class="kw">as.integer</span>(location <span class="op">==</span><span class="st"> &quot;PA&quot;</span>))</a></code></pre></div>
<div class="sourceCode" id="cb468"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb468-1" data-line-number="1">fit_minwage &lt;-<span class="st"> </span><span class="kw">lm</span>(fullPropAfter <span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span>NJ <span class="op">+</span><span class="st"> </span>fullPropBefore <span class="op">+</span></a>
<a class="sourceLine" id="cb468-2" data-line-number="2"><span class="st">                    </span>wageBefore <span class="op">+</span><span class="st"> </span>chain, <span class="dt">data =</span> minwage)</a>
<a class="sourceLine" id="cb468-3" data-line-number="3">fit_minwage</a>
<a class="sourceLine" id="cb468-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb468-5" data-line-number="5"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb468-6" data-line-number="6"><span class="co">#&gt; lm(formula = fullPropAfter ~ -1 + NJ + fullPropBefore + wageBefore + </span></a>
<a class="sourceLine" id="cb468-7" data-line-number="7"><span class="co">#&gt;     chain, data = minwage)</span></a>
<a class="sourceLine" id="cb468-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb468-9" data-line-number="9"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb468-10" data-line-number="10"><span class="co">#&gt;              NJ   fullPropBefore       wageBefore  chainburgerking  </span></a>
<a class="sourceLine" id="cb468-11" data-line-number="11"><span class="co">#&gt;         -0.0542           0.1688           0.0813          -0.0614  </span></a>
<a class="sourceLine" id="cb468-12" data-line-number="12"><span class="co">#&gt;        chainkfc        chainroys      chainwendys  </span></a>
<a class="sourceLine" id="cb468-13" data-line-number="13"><span class="co">#&gt;         -0.0966          -0.1522          -0.1659</span></a>
<a class="sourceLine" id="cb468-14" data-line-number="14">fit_minwage1 &lt;-<span class="st"> </span><span class="kw">lm</span>(fullPropAfter <span class="op">~</span><span class="st"> </span>NJ <span class="op">+</span><span class="st"> </span>fullPropBefore <span class="op">+</span></a>
<a class="sourceLine" id="cb468-15" data-line-number="15"><span class="st">                     </span>wageBefore <span class="op">+</span><span class="st"> </span>chain, <span class="dt">data =</span> minwage)</a>
<a class="sourceLine" id="cb468-16" data-line-number="16">fit_minwage1</a>
<a class="sourceLine" id="cb468-17" data-line-number="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb468-18" data-line-number="18"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb468-19" data-line-number="19"><span class="co">#&gt; lm(formula = fullPropAfter ~ NJ + fullPropBefore + wageBefore + </span></a>
<a class="sourceLine" id="cb468-20" data-line-number="20"><span class="co">#&gt;     chain, data = minwage)</span></a>
<a class="sourceLine" id="cb468-21" data-line-number="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb468-22" data-line-number="22"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb468-23" data-line-number="23"><span class="co">#&gt;    (Intercept)              NJ  fullPropBefore      wageBefore  </span></a>
<a class="sourceLine" id="cb468-24" data-line-number="24"><span class="co">#&gt;        -0.0614         -0.0542          0.1688          0.0813  </span></a>
<a class="sourceLine" id="cb468-25" data-line-number="25"><span class="co">#&gt;       chainkfc       chainroys     chainwendys  </span></a>
<a class="sourceLine" id="cb468-26" data-line-number="26"><span class="co">#&gt;        -0.0352         -0.0908         -0.1045</span></a>
<a class="sourceLine" id="cb468-27" data-line-number="27"><span class="kw">gather_predictions</span>(<span class="kw">slice</span>(minwage, <span class="dv">1</span>), fit_minwage, fit_minwage1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb468-28" data-line-number="28"><span class="st">  </span><span class="kw">select</span>(model, pred)</a>
<a class="sourceLine" id="cb468-29" data-line-number="29"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb468-30" data-line-number="30"><span class="co">#&gt;   model         pred</span></a>
<a class="sourceLine" id="cb468-31" data-line-number="31"><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb468-32" data-line-number="32"><span class="co">#&gt; 1 fit_minwage  0.271</span></a>
<a class="sourceLine" id="cb468-33" data-line-number="33"><span class="co">#&gt; 2 fit_minwage1 0.271</span></a></code></pre></div>
</section>
<section id="inference-about-coefficients" class="level3">
<h3><span class="header-section-number">7.3.2</span> Inference about coefficients</h3>
<p>Use the <a href="https://www.rdocumentation.org/packages/broom/topics/tidy">tidy</a> function to return the coefficients, including confidence intervals, as a data frame:</p>
<div class="sourceCode" id="cb469"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb469-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;women&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb469-2" data-line-number="2">fit_women &lt;-<span class="st"> </span><span class="kw">lm</span>(water <span class="op">~</span><span class="st"> </span>reserved, <span class="dt">data =</span> women)</a>
<a class="sourceLine" id="cb469-3" data-line-number="3"><span class="kw">summary</span>(fit_women)</a>
<a class="sourceLine" id="cb469-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb469-5" data-line-number="5"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb469-6" data-line-number="6"><span class="co">#&gt; lm(formula = water ~ reserved, data = women)</span></a>
<a class="sourceLine" id="cb469-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb469-8" data-line-number="8"><span class="co">#&gt; Residuals:</span></a>
<a class="sourceLine" id="cb469-9" data-line-number="9"><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></a>
<a class="sourceLine" id="cb469-10" data-line-number="10"><span class="co">#&gt; -23.99 -14.74  -7.86   2.26 316.01 </span></a>
<a class="sourceLine" id="cb469-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb469-12" data-line-number="12"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb469-13" data-line-number="13"><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></a>
<a class="sourceLine" id="cb469-14" data-line-number="14"><span class="co">#&gt; (Intercept)    14.74       2.29    6.45  4.2e-10 ***</span></a>
<a class="sourceLine" id="cb469-15" data-line-number="15"><span class="co">#&gt; reserved        9.25       3.95    2.34     0.02 *  </span></a>
<a class="sourceLine" id="cb469-16" data-line-number="16"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb469-17" data-line-number="17"><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></a>
<a class="sourceLine" id="cb469-18" data-line-number="18"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb469-19" data-line-number="19"><span class="co">#&gt; Residual standard error: 33.4 on 320 degrees of freedom</span></a>
<a class="sourceLine" id="cb469-20" data-line-number="20"><span class="co">#&gt; Multiple R-squared:  0.0169, Adjusted R-squared:  0.0138 </span></a>
<a class="sourceLine" id="cb469-21" data-line-number="21"><span class="co">#&gt; F-statistic: 5.49 on 1 and 320 DF,  p-value: 0.0197</span></a>
<a class="sourceLine" id="cb469-22" data-line-number="22"><span class="kw">tidy</span>(fit_women)</a>
<a class="sourceLine" id="cb469-23" data-line-number="23"><span class="co">#&gt;          term estimate std.error statistic  p.value</span></a>
<a class="sourceLine" id="cb469-24" data-line-number="24"><span class="co">#&gt; 1 (Intercept)    14.74      2.29      6.45 4.22e-10</span></a>
<a class="sourceLine" id="cb469-25" data-line-number="25"><span class="co">#&gt; 2    reserved     9.25      3.95      2.34 1.97e-02</span></a></code></pre></div>
<p>You need to set <code>conf.int = TRUE</code> for <a href="https://www.rdocumentation.org/packages/broom/topics/tidy.lm">tidy</a> to include the confidence interval:</p>
<div class="sourceCode" id="cb470"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb470-1" data-line-number="1"><span class="kw">summary</span>(fit_minwage)</a>
<a class="sourceLine" id="cb470-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb470-3" data-line-number="3"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb470-4" data-line-number="4"><span class="co">#&gt; lm(formula = fullPropAfter ~ -1 + NJ + fullPropBefore + wageBefore + </span></a>
<a class="sourceLine" id="cb470-5" data-line-number="5"><span class="co">#&gt;     chain, data = minwage)</span></a>
<a class="sourceLine" id="cb470-6" data-line-number="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb470-7" data-line-number="7"><span class="co">#&gt; Residuals:</span></a>
<a class="sourceLine" id="cb470-8" data-line-number="8"><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></a>
<a class="sourceLine" id="cb470-9" data-line-number="9"><span class="co">#&gt; -0.4862 -0.1813 -0.0281  0.1513  0.7509 </span></a>
<a class="sourceLine" id="cb470-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb470-11" data-line-number="11"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb470-12" data-line-number="12"><span class="co">#&gt;                 Estimate Std. Error t value Pr(&gt;|t|)   </span></a>
<a class="sourceLine" id="cb470-13" data-line-number="13"><span class="co">#&gt; NJ               -0.0542     0.0332   -1.63   0.1034   </span></a>
<a class="sourceLine" id="cb470-14" data-line-number="14"><span class="co">#&gt; fullPropBefore    0.1688     0.0566    2.98   0.0031 **</span></a>
<a class="sourceLine" id="cb470-15" data-line-number="15"><span class="co">#&gt; wageBefore        0.0813     0.0389    2.09   0.0374 * </span></a>
<a class="sourceLine" id="cb470-16" data-line-number="16"><span class="co">#&gt; chainburgerking  -0.0614     0.1755   -0.35   0.7266   </span></a>
<a class="sourceLine" id="cb470-17" data-line-number="17"><span class="co">#&gt; chainkfc         -0.0966     0.1793   -0.54   0.5904   </span></a>
<a class="sourceLine" id="cb470-18" data-line-number="18"><span class="co">#&gt; chainroys        -0.1522     0.1832   -0.83   0.4066   </span></a>
<a class="sourceLine" id="cb470-19" data-line-number="19"><span class="co">#&gt; chainwendys      -0.1659     0.1853   -0.90   0.3711   </span></a>
<a class="sourceLine" id="cb470-20" data-line-number="20"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb470-21" data-line-number="21"><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></a>
<a class="sourceLine" id="cb470-22" data-line-number="22"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb470-23" data-line-number="23"><span class="co">#&gt; Residual standard error: 0.244 on 351 degrees of freedom</span></a>
<a class="sourceLine" id="cb470-24" data-line-number="24"><span class="co">#&gt; Multiple R-squared:  0.635,  Adjusted R-squared:  0.628 </span></a>
<a class="sourceLine" id="cb470-25" data-line-number="25"><span class="co">#&gt; F-statistic: 87.2 on 7 and 351 DF,  p-value: &lt;2e-16</span></a>
<a class="sourceLine" id="cb470-26" data-line-number="26"><span class="kw">tidy</span>(fit_minwage, <span class="dt">conf.int =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb470-27" data-line-number="27"><span class="co">#&gt;              term estimate std.error statistic p.value conf.low conf.high</span></a>
<a class="sourceLine" id="cb470-28" data-line-number="28"><span class="co">#&gt; 1              NJ  -0.0542    0.0332    -1.633 0.10343 -0.11953    0.0111</span></a>
<a class="sourceLine" id="cb470-29" data-line-number="29"><span class="co">#&gt; 2  fullPropBefore   0.1688    0.0566     2.981 0.00307  0.05744    0.2801</span></a>
<a class="sourceLine" id="cb470-30" data-line-number="30"><span class="co">#&gt; 3      wageBefore   0.0813    0.0389     2.090 0.03737  0.00478    0.1579</span></a>
<a class="sourceLine" id="cb470-31" data-line-number="31"><span class="co">#&gt; 4 chainburgerking  -0.0614    0.1755    -0.350 0.72657 -0.40648    0.2837</span></a>
<a class="sourceLine" id="cb470-32" data-line-number="32"><span class="co">#&gt; 5        chainkfc  -0.0966    0.1793    -0.539 0.59044 -0.44919    0.2560</span></a>
<a class="sourceLine" id="cb470-33" data-line-number="33"><span class="co">#&gt; 6       chainroys  -0.1522    0.1832    -0.831 0.40664 -0.51238    0.2080</span></a>
<a class="sourceLine" id="cb470-34" data-line-number="34"><span class="co">#&gt; 7     chainwendys  -0.1659    0.1853    -0.895 0.37115 -0.53031    0.1985</span></a></code></pre></div>
</section>
<section id="inference-about-predictions" class="level3">
<h3><span class="header-section-number">7.3.3</span> Inference about predictions</h3>
<div class="sourceCode" id="cb471"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb471-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;MPs&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;qss&quot;</span>)</a>
<a class="sourceLine" id="cb471-2" data-line-number="2">MPs_labour &lt;-<span class="st"> </span><span class="kw">filter</span>(MPs, party <span class="op">==</span><span class="st"> &quot;labour&quot;</span>)</a>
<a class="sourceLine" id="cb471-3" data-line-number="3">MPs_tory &lt;-<span class="st"> </span><span class="kw">filter</span>(MPs, party <span class="op">==</span><span class="st"> &quot;tory&quot;</span>)</a>
<a class="sourceLine" id="cb471-4" data-line-number="4">labour_fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_labour, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb471-5" data-line-number="5">labour_fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_labour, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb471-6" data-line-number="6">tory_fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb471-7" data-line-number="7">tory_fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(ln.net <span class="op">~</span><span class="st"> </span>margin, <span class="dt">data =</span> <span class="kw">filter</span>(MPs_tory, margin <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</a></code></pre></div>
<p>Predictions at the threshold. The <a href="https://cran.r-project.org/package=broom">broom</a> function <a href="https://www.rdocumentation.org/packages/broom/topics/augment">augment</a> will return prediction fitted values and standard errors for each value, but not the confidence intervals themselves (we’d have to multiply the correct t-distribution with degrees of freedom.) So instead, we’ll directly use the <a href="https://www.rdocumentation.org/packages/stats/topics/predict.lm">predict</a> function:</p>
<div class="sourceCode" id="cb472"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb472-1" data-line-number="1">tory_y0 &lt;-</a>
<a class="sourceLine" id="cb472-2" data-line-number="2"><span class="st">  </span><span class="kw">predict</span>(tory_fit1, <span class="dt">interval =</span> <span class="st">&quot;confidence&quot;</span>,</a>
<a class="sourceLine" id="cb472-3" data-line-number="3">          <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">margin =</span> <span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>()</a>
<a class="sourceLine" id="cb472-4" data-line-number="4">tory_y0</a>
<a class="sourceLine" id="cb472-5" data-line-number="5"><span class="co">#&gt; # A tibble: 1 x 3</span></a>
<a class="sourceLine" id="cb472-6" data-line-number="6"><span class="co">#&gt;     fit   lwr   upr</span></a>
<a class="sourceLine" id="cb472-7" data-line-number="7"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb472-8" data-line-number="8"><span class="co">#&gt; 1  12.5  12.1  13.0</span></a>
<a class="sourceLine" id="cb472-9" data-line-number="9">tory_y1 &lt;-</a>
<a class="sourceLine" id="cb472-10" data-line-number="10"><span class="st">  </span><span class="kw">predict</span>(tory_fit2, <span class="dt">interval =</span> <span class="st">&quot;confidence&quot;</span>,</a>
<a class="sourceLine" id="cb472-11" data-line-number="11">          <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">margin =</span> <span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>()</a>
<a class="sourceLine" id="cb472-12" data-line-number="12">tory_y1</a>
<a class="sourceLine" id="cb472-13" data-line-number="13"><span class="co">#&gt; # A tibble: 1 x 3</span></a>
<a class="sourceLine" id="cb472-14" data-line-number="14"><span class="co">#&gt;     fit   lwr   upr</span></a>
<a class="sourceLine" id="cb472-15" data-line-number="15"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb472-16" data-line-number="16"><span class="co">#&gt; 1  13.2  12.8  13.6</span></a></code></pre></div>
<p>Alternatively, using <code>augment</code> (and assuming a normal distribution since the number of observations is so large its not worth worrying about the t-distribution):</p>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb473-1" data-line-number="1">tory_y0 &lt;-</a>
<a class="sourceLine" id="cb473-2" data-line-number="2"><span class="st">  </span><span class="kw">augment</span>(tory_fit1, <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">margin =</span> <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb473-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lwr =</span> .fitted <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.025</span>) <span class="op">*</span><span class="st"> </span>.se.fit,</a>
<a class="sourceLine" id="cb473-4" data-line-number="4">         <span class="dt">upr =</span> .fitted <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>) <span class="op">*</span><span class="st"> </span>.se.fit)</a>
<a class="sourceLine" id="cb473-5" data-line-number="5">tory_y0</a>
<a class="sourceLine" id="cb473-6" data-line-number="6"><span class="co">#&gt;   margin .fitted .se.fit  lwr upr</span></a>
<a class="sourceLine" id="cb473-7" data-line-number="7"><span class="co">#&gt; 1      0    12.5   0.214 12.1  13</span></a>
<a class="sourceLine" id="cb473-8" data-line-number="8">tory_y1 &lt;-</a>
<a class="sourceLine" id="cb473-9" data-line-number="9"><span class="st">  </span><span class="kw">augment</span>(tory_fit2, <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">margin =</span> <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb473-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lwr =</span> .fitted <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.025</span>) <span class="op">*</span><span class="st"> </span>.se.fit,</a>
<a class="sourceLine" id="cb473-11" data-line-number="11">         <span class="dt">upr =</span> .fitted <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>) <span class="op">*</span><span class="st"> </span>.se.fit)</a>
<a class="sourceLine" id="cb473-12" data-line-number="12">tory_y1</a>
<a class="sourceLine" id="cb473-13" data-line-number="13"><span class="co">#&gt;   margin .fitted .se.fit  lwr  upr</span></a>
<a class="sourceLine" id="cb473-14" data-line-number="14"><span class="co">#&gt; 1      0    13.2   0.192 12.8 13.6</span></a></code></pre></div>
<div class="sourceCode" id="cb474"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb474-1" data-line-number="1">y1_range &lt;-<span class="st"> </span><span class="kw">data_grid</span>(<span class="kw">filter</span>(MPs_tory, margin <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>), margin)</a>
<a class="sourceLine" id="cb474-2" data-line-number="2">tory_y0 &lt;-<span class="st"> </span><span class="kw">augment</span>(tory_fit1, <span class="dt">newdata =</span> y1_range)</a>
<a class="sourceLine" id="cb474-3" data-line-number="3">y2_range &lt;-<span class="st"> </span><span class="kw">data_grid</span>(<span class="kw">filter</span>(MPs_tory, margin <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>), margin)</a>
<a class="sourceLine" id="cb474-4" data-line-number="4">tory_y1 &lt;-<span class="st"> </span><span class="kw">augment</span>(tory_fit2, <span class="dt">newdata =</span> y2_range)</a></code></pre></div>
<div class="sourceCode" id="cb475"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb475-1" data-line-number="1"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb475-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_ref_line</span>(<span class="dt">v =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb475-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> ln.net, <span class="dt">x =</span> margin), <span class="dt">data =</span> MPs_tory) <span class="op">+</span></a>
<a class="sourceLine" id="cb475-4" data-line-number="4"><span class="st">  </span><span class="co"># plot losers</span></a>
<a class="sourceLine" id="cb475-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> margin,</a>
<a class="sourceLine" id="cb475-6" data-line-number="6">                  <span class="dt">ymin =</span> .fitted <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.025</span>) <span class="op">*</span><span class="st"> </span>.se.fit,</a>
<a class="sourceLine" id="cb475-7" data-line-number="7">                  <span class="dt">ymax =</span> .fitted <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>) <span class="op">*</span><span class="st"> </span>.se.fit),</a>
<a class="sourceLine" id="cb475-8" data-line-number="8">              <span class="dt">data =</span> tory_y0, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb475-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> .fitted), <span class="dt">data =</span> tory_y0) <span class="op">+</span></a>
<a class="sourceLine" id="cb475-10" data-line-number="10"><span class="st">  </span><span class="co"># plot winners</span></a>
<a class="sourceLine" id="cb475-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> margin,</a>
<a class="sourceLine" id="cb475-12" data-line-number="12">                  <span class="dt">ymin =</span> .fitted <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.025</span>) <span class="op">*</span><span class="st"> </span>.se.fit,</a>
<a class="sourceLine" id="cb475-13" data-line-number="13">                  <span class="dt">ymax =</span> .fitted <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>) <span class="op">*</span><span class="st"> </span>.se.fit),</a>
<a class="sourceLine" id="cb475-14" data-line-number="14">              <span class="dt">data =</span> tory_y1, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb475-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> margin, <span class="dt">y =</span> .fitted), <span class="dt">data =</span> tory_y1) <span class="op">+</span></a>
<a class="sourceLine" id="cb475-16" data-line-number="16"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Margin of vitory&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;log net wealth&quot;</span>)</a></code></pre></div>
<p><img src="uncertainty_files/figure-html/unnamed-chunk-68-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb476-1" data-line-number="1">tory_y1 &lt;-<span class="st"> </span><span class="kw">augment</span>(tory_fit1, <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">margin =</span> <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb476-2" data-line-number="2">tory_y1</a>
<a class="sourceLine" id="cb476-3" data-line-number="3"><span class="co">#&gt;   margin .fitted .se.fit</span></a>
<a class="sourceLine" id="cb476-4" data-line-number="4"><span class="co">#&gt; 1      0    12.5   0.214</span></a>
<a class="sourceLine" id="cb476-5" data-line-number="5">tory_y0 &lt;-<span class="st"> </span><span class="kw">augment</span>(tory_fit2, <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">margin =</span> <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb476-6" data-line-number="6">tory_y0</a>
<a class="sourceLine" id="cb476-7" data-line-number="7"><span class="co">#&gt;   margin .fitted .se.fit</span></a>
<a class="sourceLine" id="cb476-8" data-line-number="8"><span class="co">#&gt; 1      0    13.2   0.192</span></a>
<a class="sourceLine" id="cb476-9" data-line-number="9"><span class="kw">summary</span>(tory_fit1)</a>
<a class="sourceLine" id="cb476-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb476-11" data-line-number="11"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb476-12" data-line-number="12"><span class="co">#&gt; lm(formula = ln.net ~ margin, data = filter(MPs_tory, margin &lt; </span></a>
<a class="sourceLine" id="cb476-13" data-line-number="13"><span class="co">#&gt;     0))</span></a>
<a class="sourceLine" id="cb476-14" data-line-number="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb476-15" data-line-number="15"><span class="co">#&gt; Residuals:</span></a>
<a class="sourceLine" id="cb476-16" data-line-number="16"><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></a>
<a class="sourceLine" id="cb476-17" data-line-number="17"><span class="co">#&gt; -5.320 -0.472 -0.035  0.663  3.580 </span></a>
<a class="sourceLine" id="cb476-18" data-line-number="18"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb476-19" data-line-number="19"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb476-20" data-line-number="20"><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></a>
<a class="sourceLine" id="cb476-21" data-line-number="21"><span class="co">#&gt; (Intercept)   12.538      0.214   58.54   &lt;2e-16 ***</span></a>
<a class="sourceLine" id="cb476-22" data-line-number="22"><span class="co">#&gt; margin         1.491      1.291    1.15     0.25    </span></a>
<a class="sourceLine" id="cb476-23" data-line-number="23"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb476-24" data-line-number="24"><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></a>
<a class="sourceLine" id="cb476-25" data-line-number="25"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb476-26" data-line-number="26"><span class="co">#&gt; Residual standard error: 1.43 on 119 degrees of freedom</span></a>
<a class="sourceLine" id="cb476-27" data-line-number="27"><span class="co">#&gt; Multiple R-squared:  0.0111, Adjusted R-squared:  0.00277 </span></a>
<a class="sourceLine" id="cb476-28" data-line-number="28"><span class="co">#&gt; F-statistic: 1.33 on 1 and 119 DF,  p-value: 0.251</span></a>
<a class="sourceLine" id="cb476-29" data-line-number="29"><span class="kw">summary</span>(tory_fit2)</a>
<a class="sourceLine" id="cb476-30" data-line-number="30"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb476-31" data-line-number="31"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb476-32" data-line-number="32"><span class="co">#&gt; lm(formula = ln.net ~ margin, data = filter(MPs_tory, margin &gt; </span></a>
<a class="sourceLine" id="cb476-33" data-line-number="33"><span class="co">#&gt;     0))</span></a>
<a class="sourceLine" id="cb476-34" data-line-number="34"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb476-35" data-line-number="35"><span class="co">#&gt; Residuals:</span></a>
<a class="sourceLine" id="cb476-36" data-line-number="36"><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></a>
<a class="sourceLine" id="cb476-37" data-line-number="37"><span class="co">#&gt; -3.858 -0.877  0.001  0.830  3.126 </span></a>
<a class="sourceLine" id="cb476-38" data-line-number="38"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb476-39" data-line-number="39"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb476-40" data-line-number="40"><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></a>
<a class="sourceLine" id="cb476-41" data-line-number="41"><span class="co">#&gt; (Intercept)   13.188      0.192   68.69   &lt;2e-16 ***</span></a>
<a class="sourceLine" id="cb476-42" data-line-number="42"><span class="co">#&gt; margin        -0.728      1.982   -0.37     0.71    </span></a>
<a class="sourceLine" id="cb476-43" data-line-number="43"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb476-44" data-line-number="44"><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></a>
<a class="sourceLine" id="cb476-45" data-line-number="45"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb476-46" data-line-number="46"><span class="co">#&gt; Residual standard error: 1.29 on 100 degrees of freedom</span></a>
<a class="sourceLine" id="cb476-47" data-line-number="47"><span class="co">#&gt; Multiple R-squared:  0.00135,    Adjusted R-squared:  -0.00864 </span></a>
<a class="sourceLine" id="cb476-48" data-line-number="48"><span class="co">#&gt; F-statistic: 0.135 on 1 and 100 DF,  p-value: 0.714</span></a></code></pre></div>
<p>Since we aren’t doing anything more with these values, there isn’t much benefit in keeping them in data frames.</p>
<div class="sourceCode" id="cb477"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb477-1" data-line-number="1"><span class="co"># standard error</span></a>
<a class="sourceLine" id="cb477-2" data-line-number="2">se_diff &lt;-<span class="st"> </span><span class="kw">sqrt</span>(tory_y0<span class="op">$</span>.se.fit <span class="op">^</span><span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>tory_y1<span class="op">$</span>.se.fit <span class="op">^</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb477-3" data-line-number="3">se_diff</a>
<a class="sourceLine" id="cb477-4" data-line-number="4"><span class="co">#&gt; [1] 0.288</span></a>
<a class="sourceLine" id="cb477-5" data-line-number="5"><span class="co"># point estimate</span></a>
<a class="sourceLine" id="cb477-6" data-line-number="6">diff_est &lt;-<span class="st"> </span>tory_y1<span class="op">$</span>.fitted <span class="op">-</span><span class="st"> </span>tory_y0<span class="op">$</span>.fitted</a>
<a class="sourceLine" id="cb477-7" data-line-number="7">diff_est</a>
<a class="sourceLine" id="cb477-8" data-line-number="8"><span class="co">#&gt; [1] -0.65</span></a>
<a class="sourceLine" id="cb477-9" data-line-number="9"><span class="co"># confidence interval</span></a>
<a class="sourceLine" id="cb477-10" data-line-number="10">CI &lt;-<span class="st"> </span><span class="kw">c</span>(diff_est <span class="op">-</span><span class="st"> </span>se_diff <span class="op">*</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>),</a>
<a class="sourceLine" id="cb477-11" data-line-number="11">        diff_est <span class="op">+</span><span class="st"> </span>se_diff <span class="op">*</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>))</a>
<a class="sourceLine" id="cb477-12" data-line-number="12">CI</a>
<a class="sourceLine" id="cb477-13" data-line-number="13"><span class="co">#&gt; [1] -1.2134 -0.0859</span></a>
<a class="sourceLine" id="cb477-14" data-line-number="14"><span class="co"># hypothesis test</span></a>
<a class="sourceLine" id="cb477-15" data-line-number="15">z.score &lt;-<span class="st"> </span>diff_est <span class="op">/</span><span class="st"> </span>se_diff</a>
<a class="sourceLine" id="cb477-16" data-line-number="16"><span class="co"># two sided p value</span></a>
<a class="sourceLine" id="cb477-17" data-line-number="17">p.value &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="kw">abs</span>(z.score), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb477-18" data-line-number="18">p.value</a>
<a class="sourceLine" id="cb477-19" data-line-number="19"><span class="co">#&gt; [1] 0.0239</span></a></code></pre></div>

</section>
</section>
</section>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>For more on using projects read <a href="https://www.tidyverse.org/articles/2017/12/workflow-vs-script/">Project-oriented workflow</a>.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>See the discussion in <a href="http://r4ds.had.co.nz/tibbles.html#tibbles-vs.data.frame">R for Data Science</a> on how <code>tibble</code> objects differ from base <code>data.frame</code> objects in how <code>[</code> is handled.<a href="#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</section>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jrnold/qss-tidy/edit/master/%s",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "true";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
