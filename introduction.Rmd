---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Introduction

## Prerequisites {-}

In the prerequsites section of each chapter, we'll load any packages
needed for the chaper, and possibly define some funcitons or load data.

```{r}
library("tidyverse")
```
We also load the **readr** package to load `csv` files,
```{r}
library("readr")
```
the **haven** package to load Stata `dta` files,
```{r}
library("haven")
```
and the **rio** package to load multiple types of files.
```{r}
library("rio")
```



## Overview of the Book

<!-- define all sections so that numbering matches that of the book -->


## How to use the Book


## Introduction to R

These notes don't aim to completely teach R and the tidyverse. 
However, there are many other resources for that.

[R for Data Science](http://r4ds.had.co.nz/) is an comprehensive introduction to the 
using the Tidyverse.

[Data Camp](https://www.datacamp.com/home) has interactive courses. In particular,
I recommende starting with the following two courses.

- [Introduction to R](https://www.datacamp.com/courses/free-introduction-to-r)
- [Introduction to the Tidyverse](https://www.datacamp.com/courses/introduction-to-the-tidyverse)


### Arithmetic Operations

See *QSS* text


### Objects

See *QSS* text. Also see [R4DS: Workflow basics](http://r4ds.had.co.nz/workflow-basics.html).


### Vectors

See *QSS* text. Also see [R4DS: Vectors](http://r4ds.had.co.nz/vectors.html). In 
*R for Data Science* vectors are introduced much later, after data frames.


### Functions

See *QSS* text. Also see [R4DS: Functions](http://r4ds.had.co.nz/functions.html).


### Data Files


Rather than using `setwd()` in scripts, data analysis should be organized in
projects. Read the introduction on RStudio projects in  [R4DS](http://r4ds.had.co.nz/workflow-projects.html).[^setwd]


[^setwd]: For more on using projects read [Project-oriented worfklow](https://www.tidyverse.org/articles/2017/12/workflow-vs-script/).


Datasets used in R are accessed in two ways.

- Datasets can also be distributed with R packages. These are often smaller datasets used in examples and tutorials in packages. These are loaded with the `data()` function.
- Loaded from an external files including both stored R objects (`.RData`, `.rda`) and other formats (`.csv`, `.dta`, `.sav`).


The function `data` with called without any arguments will list all the datasets distributed with installed packages.
```{r eval=FALSE}
data()
```
The **qss** library distributes the data sets used in the *QSS* textbook.
```{r data_UNpop}
data("UNpop", package = "qss")
```

To read a [csv](https://en.wikipedia.org/wiki/Comma-separated_values) file into R use the 
```{r read_csv}
UNpop_URL <- "https://raw.githubusercontent.com/kosukeimai/qss/master/INTRO/UNpop.csv"
UNpop <- read_csv(UNpop_URL)
class(UNpop)
UNpop
```
When reading from csv files use `readr::read_csv` instead of the base R function `read.csv` used in the *QSS* text.
It is slightly faster, and returns a `tibble` instead of a data frame.
See `r R4DS` [Ch 11: Data Import](http://r4ds.had.co.nz/tibbles.html#introduction-4)
for more discussion.

Note that in the previous code we loaded the file directly from a URL, but it would also work with local files on your computer, e.g.
```{r eval=FALSE}
read_csv("INTRO/UNpop.csv")
```

See `r R4DS` [Ch 10: Tibbles](http://r4ds.had.co.nz/tibbles.html) for a deeper discussion of data frames.

The single bracket, `[`, is useful to select rows and columns in simple cases,
but the **dplyr** functions `r RDoc("dplyr::slice")` to select rows by number, `r RDoc("dplyr::filter")` to select rows by certain criteria, or `r RDoc("dplyr::select")` to select columns.

Select rows 1--3:
```{r UNpop_row}
UNpop[c(1, 2, 3), ]
slice(UNpop, 1:3)
```

Select the `world.pop` column from the `UNpop` data frame:
```{r UNpop_col}
UNpop[, "world.pop"]
UNpop$world.pop
UNpop[["world.pop"]]
select(UNpop, world.pop)
```
However, note that, by default, `[` will return a vector rather than a data frame if only one column is selected. 
This may seem convenient, but it can result in many hard to find and surprising bugs in practice.
The `[[` and `$` operators can only select a single column and return a vector.
The function `select()` **always** returns a tibble (data frame), and never a vector, even if only one column is selected.
Also, note that since `world.pop` is a tibble, using `[` also returns tibbles
rather than a vector if it is only one column.


Select rows 1--3 and the `year` column:
```{r UNpop1}
UNpop[1:3, "year"]
```
or,
```{r UNpop2}
select(slice(UNpop, 1:3), year)
```
or,
```{r UNpop3}
UNpop %>%
  slice(1:3) %>%
  select(year)
```
For this example using these functions and `%>%` to chain them together may seem verbose, but later we can produce more complicated transformations of the data by chaining together simple functions.

Select every other row from `UNpop`:
```{r}
UNpop$world.pop[seq(from = 1, to = nrow(UNpop), by = 2)]
```
or
```{r}
UNpop %>%
  slice(seq(1, n(), by = 2)) %>%
  select(world.pop)
```
or
```{r}
UNpop %>%
  filter(row_number() %% 2 == 1)
```

The function `r RDoc("dplyr::n")` when used in a **dplyr** function returns the number of rows
in the data frame (or the number of rows in the group if used with `r RDoc("dplyr::group_by")`).
The function `r RDoc("dplyr::row_number")` returns the row number of an observation. 
The `%%` operator returns the modulus, e.g. division remainder.


### Saving Objects

It is not recommended that you save the entire R workspace using using `save.image` due to the negative and unexpected impacts it can have on reproducibility.

See the `r R4DS` chapter [Workflow Projects](http://r4ds.had.co.nz/workflow-projects.html).
You should uncheck the options in RStudio to avoid saving and restoring from `.RData` files.
This will help ensure that your R code runs the way you think it does, instead of depending on some long forgotten code that is only saved in the workspace image.
Everything important should be in a script. Anything saved or loaded from file
should be done explicitly.

Your motto should be that the **source is real**, not the objects created by it.

> The source code is real. The objects are realizations of the source code. Source for EVERY user modified object is placed in a particular directory or directories, for later editing and retrieval. â€“ from the [ESS manual](https://ess.r-project.org/Manual/ess.html#Philosophies-for-using-ESS_0028S_0029)

This means that while you should not save the entire workplace it is peferctly find practice to run a script and save or load R objects to files, using `r RDoc("base::save")` or `r RDoc("base::saveRDS")`.

As with reading CSV files, use the [readr](http://readr.tidyverse.org/) package functions.
In this case, `r RDoc("readr::write_csv")` writes a csv file
```{r eval=FALSE}
write_csv(UNpop, "UNpop.csv")
```


### Programming and Learning Tips

Use the [haven](http://haven.tidyverse.org/) package to read and write Stata (`.dta`) and SPSS (`.sav`) files.
Stata and SPSS are two other statistical programs commonly used in social science.
Even if you don't ever use them, you'll almost certainly encounter data stored in their native formats.
```{r}
UNpop_dta_url <- "https://github.com/kosukeimai/qss/raw/master/INTRO/UNpop.dta"
UNpop <- read_dta(UNpop_dta_url)
UNpop
```

There is also the equivalent `write_dta` function to create Stata datasets.
```{r, UNpop_dta,eval=FALSE}
write_dta(UNpop, "UNpop.dta")
```

One thing to note is that Stata and SPSS have different concept

Also see the [rio](https://cran.r-project.org/package=rio) package which makes loading data even easier with smart defaults.

You can use the `import` function to load many types of files:
```{r rio}
import("https://github.com/kosukeimai/qss/raw/master/INTRO/UNpop.csv")
import("https://github.com/kosukeimai/qss/raw/master/INTRO/UNpop.RData")
import("https://github.com/kosukeimai/qss/raw/master/INTRO/UNpop.dta")
```

R also includes the **foreign** package, which contains functions for reading and writing  **haven**.
One reason to do so is that it is better maintained.
For  R function `read.dta` does not read files created by the most recent versions of Stata (13+).


### Style Guide

Following a consistent coding style is important for your code to be readable by yourself and other.
The preferred style is the [tidyverse style guide](http://style.tidyverse.org/), which
differs slightly from [Google's R style guide](http://style.tidyverse.org/).

- The `r pkg("lintr")` package will check files for style errors
- The `r pkg("styler")` package provides functions for automatically formatting
    R code according to style guides.
- In RStudio, go to the `Tools > Global Options > Code > Diagnostics` pane and check the
    box to activate style warnings. On this pane, there are other options that can be 
    set in order to provide more or less warnings while writing R code in Rstudio.

